<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Portal CAE A - Subida de documentaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* Estilos para el combobox custom */
    .combobox-container {
      position: relative;
    }
    .combobox-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      background: white;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .combobox-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .combobox-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 10;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .combobox-dropdown.open {
      display: block;
    }
    .combobox-option {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .combobox-option:hover {
      background: #f3f4f6;
    }
    .combobox-option.selected {
      background: #dbeafe;
      color: #1e40af;
    }
    
    /* Estilos para el dropzone */
    .dropzone {
      border: 2px dashed #d1d5db;
      border-radius: 0.375rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #f9fafb;
    }
    .dropzone:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .dropzone.dragover {
      border-color: #3b82f6;
      background: #dbeafe;
    }
    .dropzone-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .dropzone-text {
      color: #6b7280;
      font-size: 0.875rem;
    }
    .dropzone-file-name {
      margin-top: 0.5rem;
      color: #1f2937;
      font-weight: 500;
    }
    
    /* Estilos para datepicker */
    .date-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    .date-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Ocultar input file nativo */
    #file_input_hidden {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    
    /* Formulario oculto inicialmente */
    #upload-form {
      display: none;
    }
    #upload-form.visible {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen flex flex-col items-center py-10">
    <div class="w-full max-w-xl bg-white shadow-md rounded-lg p-6">
      <h1 class="text-2xl font-semibold text-gray-800 mb-2">Subida de documentaci√≥n</h1>
      <p class="text-sm text-gray-500 mb-4">
        P√°gina simulada para entrenar al agente CAE con formularios de subida de documentaci√≥n.
      </p>

      <div id="worker_info" class="mb-4 text-sm text-gray-600"></div>

      <form id="upload-form">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="doc_type_combobox">
            Tipo de documento
          </label>
          <div class="combobox-container" role="combobox" aria-expanded="false" aria-haspopup="listbox">
            <input
              type="text"
              id="doc_type_combobox"
              class="combobox-input"
              readonly
              placeholder="Seleccione un tipo de documento"
              aria-label="Tipo de documento"
            />
            <div class="combobox-dropdown" role="listbox" id="doc_type_dropdown">
              <!-- Opciones se renderizar√°n din√°micamente -->
            </div>
          </div>
          <!-- Input oculto para mantener compatibilidad con el agente -->
          <select id="doc_type" style="display: none;">
            <option value="Reconocimiento m√©dico">Reconocimiento m√©dico</option>
            <option value="Formaci√≥n PRL">Formaci√≥n PRL</option>
            <option value="APT m√©dico">APT m√©dico</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Archivo
          </label>
          <div class="dropzone" id="dropzone">
            <div class="dropzone-icon">üìÑ</div>
            <div class="dropzone-text">Haga clic para seleccionar un archivo o arr√°strelo aqu√≠</div>
            <div class="dropzone-file-name" id="dropzone-file-name" style="display: none;"></div>
          </div>
          <input
            type="file"
            id="file_input"
            name="file"
            style="position: absolute; opacity: 0; pointer-events: none;"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="issue_date">
            Fecha de emisi√≥n
          </label>
          <input
            type="text"
            id="issue_date"
            class="date-input"
            placeholder="DD/MM/YYYY"
            autocomplete="off"
          />
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="expiry_date">
            Fecha de caducidad
          </label>
          <input
            type="text"
            id="expiry_date"
            class="date-input"
            placeholder="DD/MM/YYYY"
            autocomplete="off"
          />
        </div>

        <div class="flex justify-between">
          <a
            href="/simulation/portal_a_v2/dashboard.html"
            class="text-sm text-gray-500 hover:text-gray-700 underline"
          >
            ‚Üê Volver al dashboard
          </a>
          <button
            type="button"
            id="btn_submit"
            class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-md shadow hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
            disabled
          >
            Simular subida
          </button>
        </div>
        
        <div id="form_error" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md" style="display: none;"></div>
        <div id="upload_status" data-status="" class="mt-4 p-3 rounded-md font-semibold" style="display: none;"></div>
      </form>
      
      <div id="loading-message" class="text-center text-gray-500 text-sm mt-4">
        Cargando formulario...
      </div>
    </div>
  </div>

  <script>
    // Delay antes de renderizar el formulario (300-600ms)
    const delay = 300 + Math.random() * 300; // Entre 300 y 600ms
    
    setTimeout(() => {
      document.getElementById('upload-form').classList.add('visible');
      document.getElementById('loading-message').style.display = 'none';
      
      // Inicializar componentes despu√©s de mostrar el formulario
      initCombobox();
      initDropzone();
      initDatepicker();
      initSubmit();
      
      // Verificar validez inicial
      setTimeout(() => checkFormValidity(), 100);
    }, delay);

    function getQueryParams() {
      const params = {};
      const qs = window.location.search.substring(1);
      const pairs = qs.split("&").filter(Boolean);
      for (const p of pairs) {
        const [key, value] = p.split("=");
        params[decodeURIComponent(key)] = decodeURIComponent(value || "");
      }
      return params;
    }

    const params = getQueryParams();
    const workerInfoEl = document.getElementById("worker_info");
    if (workerInfoEl) {
      const workerId = params.worker_id || "W-???";
      const workerName = params.worker_name || "Trabajador/a desconocido/a";
      workerInfoEl.textContent = `Trabajador: ${workerName} (${workerId})`;
    }

    // Inicializar combobox custom
    function initCombobox() {
      const comboboxInput = document.getElementById('doc_type_combobox');
      const dropdown = document.getElementById('doc_type_dropdown');
      const hiddenSelect = document.getElementById('doc_type');
      const container = comboboxInput.closest('.combobox-container');
      
      const options = [
        'Reconocimiento m√©dico',
        'Formaci√≥n PRL',
        'APT m√©dico',
        'Otro'
      ];
      
      // Renderizar opciones din√°micamente
      options.forEach((option, index) => {
        const optionEl = document.createElement('div');
        optionEl.className = 'combobox-option';
        optionEl.textContent = option;
        optionEl.setAttribute('role', 'option');
        optionEl.setAttribute('data-value', option);
        if (index === 0) {
          optionEl.classList.add('selected');
          comboboxInput.value = option;
          hiddenSelect.value = option;
        }
          optionEl.addEventListener('click', () => {
          options.forEach(opt => {
            const optEl = dropdown.querySelector(`[data-value="${opt}"]`);
            if (optEl) optEl.classList.remove('selected');
          });
          optionEl.classList.add('selected');
          comboboxInput.value = option;
          hiddenSelect.value = option;
          container.setAttribute('aria-expanded', 'false');
          dropdown.classList.remove('open');
          checkFormValidity();
        });
        dropdown.appendChild(optionEl);
      });
      
      // Abrir/cerrar dropdown
      comboboxInput.addEventListener('click', () => {
        const isOpen = dropdown.classList.contains('open');
        if (isOpen) {
          dropdown.classList.remove('open');
          container.setAttribute('aria-expanded', 'false');
        } else {
          dropdown.classList.add('open');
          container.setAttribute('aria-expanded', 'true');
        }
      });
      
      // Cerrar al hacer clic fuera
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.classList.remove('open');
          container.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Inicializar dropzone
    function initDropzone() {
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('file_input');
      const fileNameEl = document.getElementById('dropzone-file-name');
      
      // Click en dropzone abre el file input
      dropzone.addEventListener('click', () => {
        fileInput.click();
      });
      
      // Drag and drop
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });
      
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          updateFileName(files[0].name);
        }
      });
      
      // Cambio de archivo desde input
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          updateFileName(e.target.files[0].name);
        }
      });
      
      function updateFileName(name) {
        fileNameEl.textContent = `Archivo seleccionado: ${name}`;
        fileNameEl.style.display = 'block';
        checkFormValidity();
      }
    }

    // Inicializar datepicker simple (formato DD/MM/YYYY)
    function initDatepicker() {
      const issueDate = document.getElementById('issue_date');
      const expiryDate = document.getElementById('expiry_date');
      
      // M√°scara de fecha DD/MM/YYYY
      function applyDateMask(input) {
        input.addEventListener('input', (e) => {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
          }
          if (value.length >= 5) {
            value = value.substring(0, 5) + '/' + value.substring(5, 9);
          }
          e.target.value = value;
        });
        
        // Validar formato al perder foco
        input.addEventListener('blur', (e) => {
          const value = e.target.value;
          const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
          if (value && !dateRegex.test(value)) {
            // Si no es v√°lido, intentar convertir a formato est√°ndar
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
              const day = String(date.getDate()).padStart(2, '0');
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const year = date.getFullYear();
              e.target.value = `${day}/${month}/${year}`;
            }
          }
          checkFormValidity();
        });
        
        input.addEventListener('input', () => {
          checkFormValidity();
        });
      }
      
      applyDateMask(issueDate);
      applyDateMask(expiryDate);
    }
    
    // Funci√≥n para validar formato de fecha DD/MM/YYYY
    function isValidDate(dateStr) {
      const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      if (!dateRegex.test(dateStr)) return false;
      const [, day, month, year] = dateStr.match(dateRegex);
      const date = new Date(year, month - 1, day);
      return date.getFullYear() == year && date.getMonth() == month - 1 && date.getDate() == day;
    }
    
    // Funci√≥n para verificar validez del formulario y habilitar/deshabilitar bot√≥n
    function checkFormValidity() {
      const docType = document.getElementById('doc_type');
      const fileInput = document.getElementById('file_input');
      const issueDate = document.getElementById('issue_date');
      const expiryDate = document.getElementById('expiry_date');
      const submitBtn = document.getElementById('btn_submit');
      
      const hasDocType = docType && docType.value && docType.value.trim() !== '';
      const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
      const hasIssueDate = issueDate && issueDate.value && isValidDate(issueDate.value);
      const hasExpiryDate = expiryDate && expiryDate.value && isValidDate(expiryDate.value);
      
      const isValid = hasDocType && hasFile && hasIssueDate && hasExpiryDate;
      
      if (submitBtn) {
        submitBtn.disabled = !isValid;
      }
      
      return isValid;
    }

    // Inicializar submit button
    function initSubmit() {
      const submitBtn = document.getElementById('btn_submit');
      const form = document.getElementById('upload-form');
      const formError = document.getElementById('form_error');
      const uploadStatus = document.getElementById('upload_status');
      
      submitBtn.addEventListener('click', () => {
        // Ocultar mensajes anteriores
        if (formError) formError.style.display = 'none';
        if (uploadStatus) uploadStatus.style.display = 'none';
        
        // Validar campos
        const docType = document.getElementById('doc_type');
        const fileInput = document.getElementById('file_input');
        const issueDate = document.getElementById('issue_date');
        const expiryDate = document.getElementById('expiry_date');
        
        const errors = [];
        
        if (!docType || !docType.value || docType.value.trim() === '') {
          errors.push('Debe seleccionar un tipo de documento');
        }
        
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          errors.push('Debe seleccionar un archivo');
        }
        
        if (!issueDate || !issueDate.value || !isValidDate(issueDate.value)) {
          errors.push('La fecha de emisi√≥n debe estar en formato DD/MM/YYYY');
        }
        
        if (!expiryDate || !expiryDate.value || !isValidDate(expiryDate.value)) {
          errors.push('La fecha de caducidad debe estar en formato DD/MM/YYYY');
        }
        
        if (errors.length > 0) {
          // Mostrar error
          if (formError) {
            formError.textContent = 'ERROR: ' + errors.join('; ');
            formError.style.display = 'block';
          }
          if (uploadStatus) {
            uploadStatus.setAttribute('data-status', 'error');
            uploadStatus.textContent = 'ERROR: ' + errors.join('; ');
            uploadStatus.className = 'mt-4 p-3 rounded-md font-semibold bg-red-100 border border-red-400 text-red-700';
            uploadStatus.style.display = 'block';
          }
          return;
        }
        
        // Todo v√°lido: mostrar SUCCESS
        if (uploadStatus) {
          uploadStatus.setAttribute('data-status', 'success');
          uploadStatus.textContent = 'SUCCESS';
          uploadStatus.className = 'mt-4 p-3 rounded-md font-semibold bg-green-100 border border-green-400 text-green-700';
          uploadStatus.style.display = 'block';
        }
        
        // No redirigir autom√°ticamente, dejar que el agente detecte SUCCESS
      });
    }
  </script>
</body>
</html>
