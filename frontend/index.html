<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CometLocal Chat</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 360px;
      max-width: 100%;
      border-right: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      background: #020617;
    }
    .header {
      padding: 12px 16px;
      border-bottom: 1px solid #1f2937;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status {
      display: flex;
      align-items: center;
      font-size: 12px;
      color: #9ca3af;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 6px;
      background: #22c55e;
    }
    .status-dot.error {
      background: #ef4444;
    }
    .messages {
      flex: 1;
      padding: 12px 16px;
      overflow-y: auto;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg {
      padding: 10px 12px;
      border-radius: 8px;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.5;
    }
    .msg.user {
      background: #1d4ed8;
      align-self: flex-end;
      margin-left: auto;
    }
    .msg.agent {
      background: #111827;
      border: 1px solid #1f2937;
      align-self: flex-start;
    }
    .msg.agent.error {
      background: #7f1d1d;
      border-color: #991b1b;
    }
    .msg.agent.thinking {
      opacity: 0.7;
      font-style: italic;
    }
    .msg-content {
      white-space: pre-wrap;
    }
    .msg-extra {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 11px;
    }
    .steps-link {
      color: #60a5fa;
      cursor: pointer;
      text-decoration: underline;
    }
    .steps-link:hover {
      color: #93c5fd;
    }
    .steps-details {
      margin-top: 8px;
      padding: 8px;
      background: #0f172a;
      border-radius: 4px;
      font-size: 11px;
      max-height: 300px;
      overflow-y: auto;
    }
    .steps-summary {
      margin-bottom: 8px;
      color: #9ca3af;
    }
    .steps-json {
      background: #020617;
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 10px;
      color: #a3a3a3;
    }
    .footer {
      padding: 10px;
      border-top: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .footer textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      font-family: inherit;
    }
    .footer textarea:focus {
      border-color: #60a5fa;
    }
    .footer-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .footer button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #22c55e;
      color: #02120a;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .footer button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .footer button:hover:not(:disabled) {
      background: #16a34a;
    }
    .main-hint {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-size: 14px;
    }
    /* v1.8.0: Estilos para respuesta estructurada */
    .structured-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .structured-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .subgoal-section {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      border-left: 3px solid #60a5fa;
    }
    .subgoal-section-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
    }
    .subgoal-section-content {
      font-size: 12px;
      color: #d1d5db;
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .subgoal-section-sources {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
    }
    .subgoal-section-sources a {
      color: #60a5fa;
      text-decoration: underline;
      margin-right: 8px;
    }
    .upload-summary {
      margin-top: 8px;
      padding: 8px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 4px;
      border-left: 3px solid #3b82f6;
      font-size: 12px;
      color: #d1d5db;
    }
    .file-upload-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .file-upload-item {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }
    .file-upload-description {
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .file-upload-path {
      font-size: 11px;
      color: #9ca3af;
      font-family: monospace;
      word-break: break-all;
    }
    .structured-sources-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .structured-sources-list li {
      margin-bottom: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
      font-size: 11px;
    }
    .structured-sources-list a {
      color: #60a5fa;
      text-decoration: underline;
      font-weight: 500;
    }
    .structured-sources-list .source-meta {
      color: #9ca3af;
      font-size: 10px;
      margin-top: 4px;
    }
    .metrics-toggle {
      cursor: pointer;
      user-select: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .metrics-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .metrics-toggle::before {
      content: "‚ñ∂";
      font-size: 8px;
      transition: transform 0.2s;
    }
    .metrics-toggle.expanded::before {
      transform: rotate(90deg);
    }
    .metrics-content {
      display: none;
    }
    /* v3.8.0: Estilos para Reasoning Spotlight */
    .spotlight-panel {
      margin-bottom: 20px;
      padding: 16px;
      background: #1e293b;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .spotlight-header {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #334155;
    }
    .spotlight-section {
      margin-bottom: 16px;
    }
    .spotlight-section:last-child {
      margin-bottom: 0;
    }
    .spotlight-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .spotlight-item {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      border-left: 3px solid #475569;
    }
    .spotlight-item:last-child {
      margin-bottom: 0;
    }
    .spotlight-interpretation-header {
      font-size: 11px;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 4px;
    }
    .spotlight-interpretation-text {
      font-size: 12px;
      color: #d1d5db;
      line-height: 1.5;
    }
    .spotlight-ambiguity-header {
      font-size: 11px;
      font-weight: 600;
      color: #fbbf24;
      margin-bottom: 4px;
    }
    .spotlight-ambiguity-text {
      font-size: 12px;
      color: #d1d5db;
      line-height: 1.5;
    }
    .spotlight-question-header {
      font-size: 11px;
      font-weight: 600;
      color: #a78bfa;
      margin-bottom: 4px;
    }
    .spotlight-question-text {
      font-size: 12px;
      color: #d1d5db;
      line-height: 1.5;
      margin-bottom: 4px;
    }
    .spotlight-question-rationale {
      font-size: 11px;
      color: #9ca3af;
      font-style: italic;
    }
    .spotlight-risks {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .spotlight-risk-badge {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 4px;
      font-size: 11px;
      color: #fca5a5;
    }
    .spotlight-notes-toggle {
      cursor: pointer;
      user-select: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .spotlight-notes-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .spotlight-notes-toggle::before {
      content: "‚ñ∂";
      font-size: 8px;
      transition: transform 0.2s;
    }
    .spotlight-notes-toggle.expanded::before {
      transform: rotate(90deg);
    }
    .spotlight-notes-content {
      display: none;
      margin-top: 8px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }
    .spotlight-notes-content.expanded {
      display: block;
    }
    .spotlight-notes-text {
      font-size: 12px;
      color: #d1d5db;
      line-height: 1.6;
      font-style: italic;
    }
    /* v4.0.0: Estilos para Planner Hints */
    .planner-panel {
      margin-top: 16px;
      padding: 16px;
      background: #1e293b;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .planner-header {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .planner-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      margin-top: 12px;
      margin-bottom: 6px;
    }
    .planner-item {
      font-size: 12px;
      color: #d1d5db;
      margin-bottom: 4px;
      line-height: 1.5;
    }
    .planner-subgoal {
      margin-bottom: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }
    .planner-subgoal-title {
      font-size: 12px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
    }
    .planner-badge-priority,
    .planner-badge-risk,
    .planner-badge-enabled {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .planner-badge-priority.low { background: #22c55e; color: #0f172a; }
    .planner-badge-priority.medium { background: #facc15; color: #0f172a; }
    .planner-badge-priority.high { background: #ef4444; color: white; }
    .planner-badge-risk.low { background: #22c55e; color: #0f172a; }
    .planner-badge-risk.medium { background: #facc15; color: #0f172a; }
    .planner-badge-risk.high { background: #ef4444; color: white; }
    .planner-badge-enabled.enabled { background: #22c55e; color: #0f172a; }
    .planner-badge-enabled.disabled { background: #ef4444; color: white; }
    .planner-rationale {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
      line-height: 1.5;
    }
    .planner-notes-toggle {
      cursor: pointer;
      user-select: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .planner-notes-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .planner-notes-toggle::before {
      content: "‚ñ∂";
      font-size: 8px;
      transition: transform 0.2s;
    }
    .planner-notes-toggle.expanded::before {
      transform: rotate(90deg);
    }
    .planner-notes-content {
      display: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
      margin-top: 4px;
      font-size: 11px;
      color: #d1d5db;
      white-space: pre-wrap;
    }
    .planner-notes-content.expanded {
      display: block;
    }
    /* v4.1.0: Estilos para Outcome Judge */
    .outcome-panel {
      margin-top: 16px;
      padding: 16px;
      background: #1e293b;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .outcome-header {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .outcome-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      margin-top: 12px;
      margin-bottom: 6px;
    }
    .outcome-item {
      font-size: 12px;
      color: #d1d5db;
      margin-bottom: 4px;
      line-height: 1.5;
    }
    .outcome-score-bar {
      position: relative;
      width: 100%;
      height: 24px;
      background: #0f172a;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .outcome-score-fill {
      height: 100%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .outcome-score-fill.high { background: #22c55e; }
    .outcome-score-fill.medium { background: #facc15; }
    .outcome-score-fill.low { background: #ef4444; }
    .outcome-score-text {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: 600;
      color: #0f172a;
      z-index: 1;
    }
    .outcome-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .outcome-badge-score {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .outcome-badge-score.high { background: #22c55e; color: #0f172a; }
    .outcome-badge-score.medium { background: #facc15; color: #0f172a; }
    .outcome-badge-score.low { background: #ef4444; color: white; }
    .badge-success { background: #22c55e; color: #0f172a; }
    .badge-failure { background: #ef4444; color: white; }
    .outcome-subgoal-card {
      margin-top: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .outcome-subgoal-title {
      font-size: 12px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
    }
    .outcome-subgoal-section {
      font-size: 11px;
      font-weight: 600;
      color: #9ca3af;
      margin-top: 8px;
      margin-bottom: 4px;
    }
    .outcome-notes-toggle {
      cursor: pointer;
      user-select: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .outcome-notes-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .outcome-notes-toggle::before {
      content: "‚ñ∂";
      font-size: 8px;
      transition: transform 0.2s;
    }
    .outcome-notes-toggle.expanded::before {
      transform: rotate(90deg);
    }
    .outcome-notes-content {
      display: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
      margin-top: 4px;
      font-size: 11px;
      color: #d1d5db;
      white-space: pre-wrap;
    }
    .outcome-notes-content.expanded {
      display: block;
    }
    .metrics-content {
      display: none;
      margin-top: 8px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      font-size: 11px;
    }
    .metrics-content.expanded {
      display: block;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    .metrics-item {
      padding: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }
    .metrics-item-label {
      color: #9ca3af;
      font-size: 10px;
      margin-bottom: 2px;
    }
    .metrics-item-value {
      color: #e5e7eb;
      font-weight: 600;
      font-size: 12px;
    }
    .metrics-table {
      width: 100%;
      margin-top: 12px;
      font-size: 10px;
      border-collapse: collapse;
    }
    .metrics-table th,
    .metrics-table td {
      padding: 6px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .metrics-table th {
      color: #9ca3af;
      font-weight: 600;
    }
    .metrics-table td {
      color: #d1d5db;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="header">
      <div>CometLocal</div>
      <div class="status" id="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">backend: 127.0.0.1:8000</span>
      </div>
    </div>
    <div id="messages" class="messages"></div>
    <div class="footer">
      <textarea id="input" placeholder="Escribe un objetivo... (ej: busca informaci√≥n sobre Ada Lovelace en Wikipedia)" rows="2"></textarea>
      
      <!-- v2.7.0: Controles de configuraci√≥n -->
      <div class="config-section">
        <div class="config-title">Modo de ejecuci√≥n</div>
        <div class="config-options">
          <label><input type="radio" name="execProfile" value="fast"> R√°pido</label>
          <label><input type="radio" name="execProfile" value="balanced" checked> Equilibrado</label>
          <label><input type="radio" name="execProfile" value="thorough"> Exhaustivo</label>
        </div>
      </div>
      
      <div class="config-section">
        <div class="config-title">Estrategias de contexto</div>
        <div class="config-options">
          <label><input type="checkbox" class="context-strategy" value="wikipedia" checked> Wikipedia</label>
          <label><input type="checkbox" class="context-strategy" value="images" checked> Im√°genes</label>
          <label><input type="checkbox" class="context-strategy" value="cae"> CAE</label>
        </div>
      </div>
      
      <!-- v4.3.0: Control de modo simulaci√≥n -->
      <div class="config-section">
        <div class="config-title">Modo seguro</div>
        <div class="config-options">
          <label class="config-checkbox">
            <input type="checkbox" id="execution-mode-dry-run" />
            <span>Simulaci√≥n (no hacer clicks reales ni subidas)</span>
          </label>
        </div>
      </div>
      
      <div class="footer-actions">
        <button id="sendBtn">Enviar</button>
      </div>
    </div>
  </div>
  <div class="main-hint">
    üí° Mant√©n a la vista esta ventana y la de Chromium.
  </div>

  <script>
    // Configuration
    const BACKEND_URL = "http://127.0.0.1:8000";
    const API_AGENT_ANSWER = `${BACKEND_URL}/agent/answer`;
    const API_HEALTH = `${BACKEND_URL}/health`;

    // State
    let isWaiting = false;

    // DOM elements
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");

    // Initialize
    checkBackendHealth();
    setupEventListeners();

    function setupEventListeners() {
      // Send button
      sendBtn.addEventListener("click", sendMessage);

      // Enter to send (Shift+Enter for new line)
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
      });
    }

    async function checkBackendHealth() {
      try {
        const res = await fetch(API_HEALTH);
        if (res.ok) {
          statusDot.classList.remove("error");
          statusText.textContent = "backend: 127.0.0.1:8000";
        } else {
          throw new Error("Health check failed");
        }
      } catch (err) {
        statusDot.classList.add("error");
        statusText.textContent = "backend no disponible";
      }
    }

    function addMessage(role, text, extraHtml = "") {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      
      const contentDiv = document.createElement("div");
      contentDiv.className = "msg-content";
      contentDiv.textContent = text;
      div.appendChild(contentDiv);

      if (extraHtml) {
        const extraDiv = document.createElement("div");
        extraDiv.className = "msg-extra";
        extraDiv.innerHTML = extraHtml;
        div.appendChild(extraDiv);
      }

      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return div;
    }

    function updateMessage(msgEl, text, extraHtml = "") {
      const contentDiv = msgEl.querySelector(".msg-content");
      if (contentDiv) {
        contentDiv.textContent = text;
      }
      
      if (extraHtml) {
        let extraDiv = msgEl.querySelector(".msg-extra");
        if (!extraDiv) {
          extraDiv = document.createElement("div");
          extraDiv.className = "msg-extra";
          msgEl.appendChild(extraDiv);
        }
        extraDiv.innerHTML = extraHtml;
      }
    }

    function createStepsView(steps) {
      const stepCount = steps.length;
      const lastStep = steps[stepCount - 1];
      const lastUrl = lastStep?.observation?.url || "N/A";
      
      const summary = `Pasos ejecutados: ${stepCount} | √öltima URL: ${lastUrl}`;
      const jsonStr = JSON.stringify(steps, null, 2);
      
      return `
        <div class="steps-summary">${summary}</div>
        <details>
          <summary class="steps-link">Ver JSON completo</summary>
          <pre class="steps-json">${jsonStr}</pre>
        </details>
      `;
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || isWaiting) return;

      // Add user message
      addMessage("user", text);
      
      // Clear input
      inputEl.value = "";
      inputEl.style.height = "auto";
      inputEl.focus();

      // Disable input
      isWaiting = true;
      sendBtn.disabled = true;
      inputEl.disabled = true;

      // Add thinking message
      const thinkingMsg = addMessage("agent", "Pensando...", "");
      thinkingMsg.classList.add("thinking");

      try {
        await sendAgentMessage(text, thinkingMsg);
      } catch (err) {
        const errorText = `Error al consultar el agente: ${err.message}`;
        updateMessage(thinkingMsg, errorText, "");
        thinkingMsg.classList.remove("thinking");
        thinkingMsg.classList.add("error");
      } finally {
        isWaiting = false;
        sendBtn.disabled = false;
        inputEl.disabled = false;
      }
    }

    // v1.8.0: Helper para renderizar secciones por sub-objetivo
    // v2.4.0: A√±adido soporte para upload_summary
    function renderSections(sections) {
      if (!sections || sections.length === 0) return "";
      
      let html = '<div class="structured-section">';
      html += '<div class="structured-section-title">Desglose por objetivos</div>';
      
      sections.forEach(section => {
        const index = section.index || 0;
        const subGoal = section.sub_goal || "";
        const answer = section.answer || "";
        const sources = section.sources || [];
        const uploadSummary = section.upload_summary || null;
        
        html += '<div class="subgoal-section">';
        html += `<div class="subgoal-section-title">${index}. ${subGoal}</div>`;
        
        if (answer) {
          html += `<div class="subgoal-section-content">${escapeHtml(answer)}</div>`;
        }
        
        // v2.4.0: Mostrar informaci√≥n de upload si existe
        if (uploadSummary) {
          const status = uploadSummary.status || "";
          const fileName = uploadSummary.file_name || "";
          let uploadText = "";
          
          if (status === "success") {
            uploadText = fileName 
              ? `üìÅ Upload: se ha adjuntado el archivo ${escapeHtml(fileName)}.`
              : "üìÅ Upload: se ha adjuntado un archivo desde el repositorio local.";
          } else if (status === "file_not_found") {
            uploadText = "üìÅ Upload: no se encontr√≥ el archivo en el repositorio local.";
          } else if (status === "no_input_found") {
            uploadText = "üìÅ Upload: no hay campo de subida en la p√°gina.";
          } else if (status === "error") {
            uploadText = "üìÅ Upload: se produjo un error al adjuntar el archivo.";
          } else {
            uploadText = "üìÅ Upload: se intent√≥ adjuntar un archivo.";
          }
          
          html += `<div class="upload-summary">${uploadText}</div>`;
        }
        
        // v2.5.0: Mostrar informaci√≥n de verificaci√≥n visual si existe
        const uploadVerification = section.upload_verification || null;
        if (uploadVerification && uploadVerification.status !== "not_applicable") {
          const verificationStatus = uploadVerification.status || "";
          const verificationFileName = uploadVerification.file_name || "";
          const verificationEvidence = uploadVerification.evidence || "";
          
          let verificationBadge = "";
          let verificationClass = "";
          
          if (verificationStatus === "confirmed") {
            verificationBadge = "‚úÖ Subida confirmada visualmente";
            verificationClass = "upload-verification-status-confirmed";
          } else if (verificationStatus === "not_confirmed") {
            verificationBadge = "‚ö†Ô∏è Sin confirmaci√≥n visual clara";
            verificationClass = "upload-verification-status-warning";
          } else if (verificationStatus === "error_detected") {
            verificationBadge = "‚ùå Error detectado tras la subida";
            verificationClass = "upload-verification-status-error";
          }
          
          if (verificationBadge) {
            html += '<div class="upload-verification">';
            html += '<div class="upload-verification-title">Estado de la subida</div>';
            html += `<div class="upload-verification-badge ${verificationClass}">${verificationBadge}</div>`;
            
            if (verificationFileName) {
              html += `<div class="upload-verification-file">Archivo: ${escapeHtml(verificationFileName)}</div>`;
            }
            
            if (verificationEvidence) {
              const evidenceShort = verificationEvidence.length > 120 
                ? verificationEvidence.slice(0, 120) + "..." 
                : verificationEvidence;
              html += `<div class="upload-verification-evidence">${escapeHtml(evidenceShort)}</div>`;
            }
            
            html += '</div>';
          }
        }
        
        if (sources.length > 0) {
          html += '<div class="subgoal-section-sources">Fuentes: ';
          const sourceLinks = sources.slice(0, 3).map(source => {
            const displayText = (source.title && source.title.trim()) ? escapeHtml(source.title) : escapeHtml(source.url);
            return `<a href="${escapeHtml(source.url)}" target="_blank">${displayText}</a>`;
          }).join(", ");
          html += sourceLinks;
          html += '</div>';
        }
        
        html += '</div>';
      });
      
      html += '</div>';
      return html;
    }
    
    // v1.8.0: Helper para renderizar fuentes estructuradas globales
    function renderStructuredSources(structuredSources) {
      if (!structuredSources || structuredSources.length === 0) return "";
      
      let html = '<div class="structured-section">';
      html += '<div class="structured-section-title">Fuentes</div>';
      html += '<ul class="structured-sources-list">';
      
      structuredSources.forEach(source => {
        const url = source.url || "";
        const title = source.title || "";
        const subGoals = source.sub_goals || [];
        const displayText = (title && title.trim()) ? escapeHtml(title) : escapeHtml(url);
        
        html += '<li>';
        html += `<a href="${escapeHtml(url)}" target="_blank">${displayText}</a>`;
        
        if (subGoals.length > 0) {
          const subGoalsText = subGoals.sort((a, b) => a - b).join(", ");
          html += `<div class="source-meta">Usado en objetivos: ${subGoalsText}</div>`;
        }
        
        html += '</li>';
      });
      
      html += '</ul>';
      html += '</div>';
      return html;
    }
    
    // v2.2.0: Helper para renderizar documentos locales sugeridos
    function renderFileUploadInstructions(fileUploadInstructions) {
      if (!fileUploadInstructions || fileUploadInstructions.length === 0) return "";
      
      let html = '<div class="structured-section">';
      html += '<div class="structured-section-title">DOCUMENTOS LOCALES SUGERIDOS</div>';
      html += '<ul class="file-upload-list">';
      
      fileUploadInstructions.forEach(instruction => {
        const description = instruction.description || "documento";
        const path = instruction.path || "";
        
        html += '<li class="file-upload-item">';
        html += `<div class="file-upload-description">${escapeHtml(description)}</div>`;
        if (path) {
          html += `<div class="file-upload-path">${escapeHtml(path)}</div>`;
        }
        html += '</li>';
      });
      
      html += '</ul>';
      html += '</div>';
      return html;
    }
    
    // v2.4.0: Helper para renderizar secci√≥n global de subidas de documentos
    function renderUploadsSection(sections) {
      if (!sections || sections.length === 0) return "";
      
      // Recopilar todos los upload_summary de las secciones
      const uploads = [];
      sections.forEach((section, idx) => {
        const uploadSummary = section.upload_summary;
        if (uploadSummary) {
          uploads.push({
            subGoalIndex: section.index || (idx + 1),
            subGoal: section.sub_goal || "",
            status: uploadSummary.status || "",
            fileName: uploadSummary.file_name || null,
            filePath: uploadSummary.file_path || null,
            attempts: uploadSummary.attempts || 1,
          });
        }
      });
      
      if (uploads.length === 0) return "";
      
      let html = '<div class="structured-section">';
      html += '<div class="structured-section-title">ACCIONES DE SUBIDA DE DOCUMENTOS</div>';
      html += '<ul class="file-upload-list">';
      
      uploads.forEach(upload => {
        const statusText = upload.status === "success" 
          ? "√âxito" 
          : upload.status === "file_not_found"
          ? "Archivo no encontrado"
          : upload.status === "no_input_found"
          ? "Sin campo de subida"
          : upload.status === "error"
          ? "Error"
          : "Desconocido";
        
        html += '<li class="file-upload-item">';
        html += `<div class="file-upload-description">`;
        html += `Objetivo ${upload.subGoalIndex}: ${escapeHtml(upload.subGoal || "")}`;
        html += `</div>`;
        if (upload.fileName) {
          html += `<div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Archivo: ${escapeHtml(upload.fileName)}</div>`;
        }
        html += `<div style="font-size: 11px; color: ${upload.status === "success" ? "#22c55e" : "#ef4444"}; margin-top: 4px;">Estado: ${escapeHtml(statusText)}</div>`;
        html += '</li>';
      });
      
      html += '</ul>';
      html += '</div>';
      return html;
    }
    
    // v1.8.0: Helper para renderizar m√©tricas
    function renderMetrics(metricsSummary) {
      if (!metricsSummary) return "";
      
      const summary = metricsSummary.summary || {};
      const subGoals = metricsSummary.sub_goals || [];
      
      let html = '<div class="structured-section">';
      html += '<div class="metrics-toggle" onclick="toggleMetrics(this)">';
      html += 'Detalles t√©cnicos de la ejecuci√≥n (m√©tricas)';
      html += '</div>';
      html += '<div class="metrics-content">';
      
      // Grid de m√©tricas principales
      html += '<div class="metrics-grid">';
      html += `<div class="metrics-item">
        <div class="metrics-item-label">Total sub-objetivos</div>
        <div class="metrics-item-value">${summary.total_sub_goals || 0}</div>
      </div>`;
      html += `<div class="metrics-item">
        <div class="metrics-item-label">Total pasos</div>
        <div class="metrics-item-value">${summary.total_steps || 0}</div>
      </div>`;
      html += `<div class="metrics-item">
        <div class="metrics-item-label">√âxitos</div>
        <div class="metrics-item-value">${summary.success_count || 0}</div>
      </div>`;
      html += `<div class="metrics-item">
        <div class="metrics-item-label">Tiempo total</div>
        <div class="metrics-item-value">${(summary.total_time_seconds || 0).toFixed(2)}s</div>
      </div>`;
      if (summary.avg_steps_per_subgoal !== undefined) {
        html += `<div class="metrics-item">
          <div class="metrics-item-label">Promedio pasos/sub-objetivo</div>
          <div class="metrics-item-value">${summary.avg_steps_per_subgoal.toFixed(1)}</div>
        </div>`;
      }
      if (summary.avg_elapsed_seconds !== undefined) {
        html += `<div class="metrics-item">
          <div class="metrics-item-label">Promedio tiempo/sub-objetivo</div>
          <div class="metrics-item-value">${summary.avg_elapsed_seconds.toFixed(2)}s</div>
        </div>`;
      }
      html += '</div>';
      
      // v2.5.0: A√±adir informaci√≥n de verificaci√≥n de uploads si existe
      if (summary.upload_verification_info) {
        const verifInfo = summary.upload_verification_info;
        html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">';
        html += '<div style="font-size: 11px; font-weight: 600; color: #9ca3af; margin-bottom: 8px;">Verificaci√≥n de subidas:</div>';
        html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">‚úÖ Confirmadas: ${verifInfo.upload_confirmed_count || 0}</div>`;
        html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">‚ö†Ô∏è Sin confirmaci√≥n: ${verifInfo.upload_unconfirmed_count || 0}</div>`;
        html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">‚ùå Con error detectado: ${verifInfo.upload_error_detected_count || 0}</div>`;
        if (verifInfo.upload_verification_confirmed_ratio !== undefined) {
          html += `<div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Ratio de confirmaci√≥n: ${(verifInfo.upload_verification_confirmed_ratio * 100).toFixed(1)}%</div>`;
        }
        html += '</div>';
      }
      
      // Tabla de early-stop counts
      if (summary.early_stop_counts && Object.keys(summary.early_stop_counts).length > 0) {
        html += '<table class="metrics-table">';
        html += '<thead><tr><th>Raz√≥n de early-stop</th><th>Cantidad</th></tr></thead>';
        html += '<tbody>';
        for (const [reason, count] of Object.entries(summary.early_stop_counts)) {
          html += `<tr><td>${escapeHtml(reason)}</td><td>${count}</td></tr>`;
        }
        html += '</tbody></table>';
      }
      
      // Tabla de goal_type counts
      if (summary.goal_type_counts && Object.keys(summary.goal_type_counts).length > 0) {
        html += '<table class="metrics-table" style="margin-top: 12px;">';
        html += '<thead><tr><th>Tipo de objetivo</th><th>Cantidad</th></tr></thead>';
        html += '<tbody>';
        for (const [goalType, count] of Object.entries(summary.goal_type_counts)) {
          html += `<tr><td>${escapeHtml(goalType)}</td><td>${count}</td></tr>`;
        }
        html += '</tbody></table>';
      }
      
      // v2.7.0: Mostrar configuraci√≥n efectiva usada
      html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">';
      html += '<div style="font-size: 11px; font-weight: 600; color: #9ca3af; margin-bottom: 8px;">Configuraci√≥n efectiva:</div>';
      
      // Execution profile
      if (summary.execution_profile) {
        const profileMode = summary.execution_profile.mode || "balanced";
        const profileNames = {
          "fast": "R√°pido",
          "balanced": "Equilibrado",
          "thorough": "Exhaustivo"
        };
        html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">Modo de ejecuci√≥n: <strong>${escapeHtml(profileNames[profileMode] || profileMode)}</strong></div>`;
      }
      
      // Context strategies
      if (summary.context_strategies && summary.context_strategies.length > 0) {
        const strategyNames = {
          "wikipedia": "Wikipedia",
          "images": "Im√°genes",
          "cae": "CAE"
        };
        const strategiesText = summary.context_strategies.map(s => strategyNames[s] || s).join(", ");
        html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">Estrategias de contexto: <strong>${escapeHtml(strategiesText)}</strong></div>`;
      }
      
      // v4.3.0: Mostrar modo de ejecuci√≥n y informaci√≥n de dry_run
      const execMode = summary.execution_mode || response.execution_mode || "live";
      const dryRunInfo = summary.dry_run_info || {};
      html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">Modo de ejecuci√≥n: <strong>${execMode === "dry_run" ? "Simulaci√≥n (dry_run)" : "En vivo (live)"}</strong></div>`;
      
      if (execMode === "dry_run") {
        html += `<div style="font-size: 11px; color: #fbbf24; margin-bottom: 4px;">Pasos simulados: <strong>${dryRunInfo.dry_run_steps ?? 0}</strong></div>`;
        html += `<div style="font-size: 11px; color: #fbbf24; margin-bottom: 4px;">Acciones simuladas: <strong>${dryRunInfo.dry_run_actions ?? 0}</strong></div>`;
      }
      
      // v2.9.0: Mostrar sub-objetivos saltados si hay
      if (summary.skipped_info && summary.skipped_info.skipped_sub_goals_count > 0) {
        const skippedCount = summary.skipped_info.skipped_sub_goals_count;
        const skippedIndices = summary.skipped_info.skipped_sub_goal_indices || [];
        const indicesText = skippedIndices.join(", ");
        html += `<div style="font-size: 11px; color: #fbbf24; margin-bottom: 4px;">Sub-objetivos no ejecutados: <strong>${skippedCount}</strong> (√≠ndices: ${escapeHtml(indicesText)})</div>`;
      }
      
      html += '</div>';
      
      html += '</div>';
      html += '</div>';
      return html;
    }
    
    // v1.8.0: Helper para escapar HTML
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }
    
    // v1.8.0: Toggle para panel de m√©tricas
    function toggleMetrics(element) {
      element.classList.toggle("expanded");
      const content = element.nextElementSibling;
      if (content) {
        content.classList.toggle("expanded");
      }
    }
    
    // Exponer toggleMetrics globalmente para onclick
    window.toggleMetrics = toggleMetrics;
    
    // v3.8.0: Renderizar Reasoning Spotlight
    function renderReasoningSpotlight(spotlight) {
      if (!spotlight) return "";
      
      let html = '<div class="spotlight-panel">';
      html += '<div class="spotlight-header">üîç RAZONAMIENTO DEL AGENTE</div>';
      
      // Interpretaciones
      if (spotlight.interpretations && spotlight.interpretations.length > 0) {
        html += '<div class="spotlight-section">';
        html += '<div class="spotlight-section-title">Interpretaciones</div>';
        spotlight.interpretations.forEach((interp, idx) => {
          const confidencePercent = Math.round(interp.confidence * 100);
          html += `<div class="spotlight-item">`;
          html += `<div class="spotlight-interpretation-header">Interpretaci√≥n ${idx + 1} (${confidencePercent}%)</div>`;
          html += `<div class="spotlight-interpretation-text">${escapeHtml(interp.interpretation)}</div>`;
          html += `</div>`;
        });
        html += '</div>';
      }
      
      // Ambig√ºedades
      if (spotlight.ambiguities && spotlight.ambiguities.length > 0) {
        html += '<div class="spotlight-section">';
        html += '<div class="spotlight-section-title">Ambig√ºedades detectadas</div>';
        spotlight.ambiguities.forEach(amb => {
          const severityIcon = amb.severity === "high" ? "üî¥" : amb.severity === "medium" ? "üü°" : "üü¢";
          html += `<div class="spotlight-item">`;
          html += `<div class="spotlight-ambiguity-header">${severityIcon} ${escapeHtml(amb.severity.toUpperCase())}</div>`;
          html += `<div class="spotlight-ambiguity-text">${escapeHtml(amb.description)}</div>`;
          html += `</div>`;
        });
        html += '</div>';
      }
      
      // Preguntas de clarificaci√≥n (solo si existen y es modo interactivo)
      if (spotlight.recommended_questions && spotlight.recommended_questions.length > 0) {
        html += '<div class="spotlight-section">';
        html += '<div class="spotlight-section-title">Preguntas de clarificaci√≥n</div>';
        spotlight.recommended_questions.forEach((q, idx) => {
          html += `<div class="spotlight-item">`;
          html += `<div class="spotlight-question-header">‚ùì Pregunta ${idx + 1}</div>`;
          html += `<div class="spotlight-question-text">${escapeHtml(q.question)}</div>`;
          if (q.rationale) {
            html += `<div class="spotlight-question-rationale">üí° ${escapeHtml(q.rationale)}</div>`;
          }
          html += `</div>`;
        });
        html += '</div>';
      }
      
      // Riesgos percibidos
      if (spotlight.perceived_risks && spotlight.perceived_risks.length > 0) {
        html += '<div class="spotlight-section">';
        html += '<div class="spotlight-section-title">Riesgos detectados</div>';
        html += '<div class="spotlight-risks">';
        spotlight.perceived_risks.forEach(risk => {
          html += `<span class="spotlight-risk-badge">‚ö†Ô∏è ${escapeHtml(risk)}</span>`;
        });
        html += '</div>';
        html += '</div>';
      }
      
      // LLM Notes (plegable)
      if (spotlight.llm_notes) {
        html += '<div class="spotlight-section">';
        html += '<div class="spotlight-notes-toggle" onclick="toggleSpotlightNotes(this)">';
        html += 'üìù Notas del LLM';
        html += '</div>';
        html += '<div class="spotlight-notes-content">';
        html += `<div class="spotlight-notes-text">${escapeHtml(spotlight.llm_notes)}</div>`;
        html += '</div>';
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }
    
    // v3.8.0: Toggle para notas del spotlight
    function toggleSpotlightNotes(toggle) {
      const content = toggle.nextElementSibling;
      if (content) {
        content.classList.toggle("expanded");
      }
    }
    
    // Exponer toggleSpotlightNotes globalmente
    window.toggleSpotlightNotes = toggleSpotlightNotes;
    
    // v2.8.0: Renderizar plan de ejecuci√≥n
    function renderPlannerHints(hints) {
      if (!hints) return "";

      let html = '<div class="planner-panel">';
      html += '<div class="planner-header">üß≠ SUGERENCIAS DEL PLANIFICADOR (LLM)</div>';

      // Global insights
      if (hints.global_insights) {
        const gi = hints.global_insights;
        if (gi.summary) {
          html += '<div class="planner-section-title">Resumen:</div>';
          html += `<div class="planner-item">${escapeHtml(gi.summary)}</div>`;
        }
        if (gi.risks && gi.risks.length > 0) {
          html += '<div class="planner-section-title">‚ö†Ô∏è Riesgos:</div>';
          gi.risks.forEach(risk => {
            html += `<div class="planner-item">‚ö†Ô∏è ${escapeHtml(risk)}</div>`;
          });
        }
        if (gi.opportunities && gi.opportunities.length > 0) {
          html += '<div class="planner-section-title">üí° Oportunidades:</div>';
          gi.opportunities.forEach(opp => {
            html += `<div class="planner-item">üí° ${escapeHtml(opp)}</div>`;
          });
        }
      }

      // Sugerencias por sub-objetivo
      if (hints.sub_goals && hints.sub_goals.length > 0) {
        html += '<div class="planner-section-title">Sugerencias por sub-objetivo:</div>';
        hints.sub_goals.forEach(sg => {
          html += '<div class="planner-subgoal">';
          html += `<div class="planner-subgoal-title">Sub-objetivo ${sg.sub_goal_index}: "${escapeHtml(sg.sub_goal_text)}"</div>`;
          
          if (sg.priority) {
            const priorityClass = sg.priority === "high" ? "high" : sg.priority === "medium" ? "medium" : "low";
            html += `<span class="planner-badge-priority ${priorityClass}">Prioridad: ${sg.priority.toUpperCase()}</span>`;
          }
          
          if (sg.risk_level) {
            const riskClass = sg.risk_level === "high" ? "high" : sg.risk_level === "medium" ? "medium" : "low";
            html += `<span class="planner-badge-risk ${riskClass}">Riesgo: ${sg.risk_level.toUpperCase()}</span>`;
          }
          
          if (sg.suggested_enabled !== null && sg.suggested_enabled !== undefined) {
            const enabledClass = sg.suggested_enabled ? "enabled" : "disabled";
            const enabledText = sg.suggested_enabled ? "‚úÖ Recomienda ejecutar" : "‚õî Recomienda NO ejecutar";
            html += `<span class="planner-badge-enabled ${enabledClass}">${enabledText}</span>`;
          }
          
          if (sg.rationale) {
            html += `<div class="planner-rationale">${escapeHtml(sg.rationale)}</div>`;
          }
          
          html += '</div>';
        });
      }

      // Sugerencia de perfil
      if (hints.profile_suggestion && hints.profile_suggestion.suggested_profile) {
        html += '<div class="planner-section-title">Sugerencia de perfil:</div>';
        const profileNames = {
          "fast": "R√°pido",
          "balanced": "Equilibrado",
          "thorough": "Exhaustivo"
        };
        const profileName = profileNames[hints.profile_suggestion.suggested_profile] || hints.profile_suggestion.suggested_profile;
        html += `<div class="planner-item">El LLM sugiere modo: <strong>${escapeHtml(profileName)}</strong></div>`;
        if (hints.profile_suggestion.rationale) {
          html += `<div class="planner-rationale">${escapeHtml(hints.profile_suggestion.rationale)}</div>`;
        }
      }

      // Notas brutas del LLM (plegable)
      if (hints.llm_raw_notes) {
        html += '<div class="planner-notes-toggle" onclick="togglePlannerNotes(this)">Detalles internos del razonamiento del planificador (solo para diagn√≥stico)</div>';
        html += `<pre class="planner-notes-content">${escapeHtml(hints.llm_raw_notes)}</pre>`;
      }

      html += '</div>';
      return html;
    }

    function togglePlannerNotes(toggle) {
      const content = toggle.nextElementSibling;
      if (content) {
        content.classList.toggle("expanded");
        toggle.classList.toggle("expanded");
      }
    }
    window.togglePlannerNotes = togglePlannerNotes;

    // v4.1.0: Renderizar Outcome Judge Report
    function renderOutcomeJudge(report) {
      if (!report) return "";

      let html = '<div class="outcome-panel">';
      html += '<div class="outcome-header">üéØ AUTOEVALUACI√ìN DEL AGENTE (OUTCOME JUDGE)</div>';

      // Bloque global
      if (report.global_review) {
        const gr = report.global_review;
        
        // Puntuaci√≥n global
        if (gr.global_score !== null && gr.global_score !== undefined) {
          const scorePercent = Math.round(gr.global_score * 100);
          const scoreClass = gr.global_score >= 0.7 ? "high" : gr.global_score >= 0.4 ? "medium" : "low";
          html += '<div class="outcome-section-title">Puntuaci√≥n global:</div>';
          html += `<div class="outcome-score-bar"><div class="outcome-score-fill ${scoreClass}" style="width: ${scorePercent}%"></div><span class="outcome-score-text">${scorePercent}%</span></div>`;
        }
        
        // Overall success
        if (gr.overall_success !== null && gr.overall_success !== undefined) {
          const successClass = gr.overall_success ? "badge-success" : "badge-failure";
          const successText = gr.overall_success ? "‚úÖ Evaluaci√≥n global: Exitosa" : "‚ùå Evaluaci√≥n global: Problem√°tica";
          html += `<div class="outcome-item"><span class="outcome-badge ${successClass}">${successText}</span></div>`;
        }
        
        // Main strengths
        if (gr.main_strengths && gr.main_strengths.length > 0) {
          html += '<div class="outcome-section-title">‚úÖ Fortalezas principales:</div>';
          gr.main_strengths.forEach(strength => {
            html += `<div class="outcome-item">‚úÖ ${escapeHtml(strength)}</div>`;
          });
        }
        
        // Main issues
        if (gr.main_issues && gr.main_issues.length > 0) {
          html += '<div class="outcome-section-title">‚ö†Ô∏è Problemas principales:</div>';
          gr.main_issues.forEach(issue => {
            html += `<div class="outcome-item">‚ö†Ô∏è ${escapeHtml(issue)}</div>`;
          });
        }
        
        // Recommendations
        if (gr.recommendations && gr.recommendations.length > 0) {
          html += '<div class="outcome-section-title">üí° Recomendaciones:</div>';
          gr.recommendations.forEach(rec => {
            html += `<div class="outcome-item">üí° ${escapeHtml(rec)}</div>`;
          });
        }
      }

      // Bloque por sub-objetivo
      if (report.sub_goals && report.sub_goals.length > 0) {
        html += '<div class="outcome-section-title">Revisi√≥n por sub-objetivo:</div>';
        report.sub_goals.forEach(sg => {
          html += '<div class="outcome-subgoal-card">';
          html += `<div class="outcome-subgoal-title">Sub-objetivo ${sg.sub_goal_index}: "${escapeHtml(sg.sub_goal_text)}"</div>`;
          
          // Score
          if (sg.score !== null && sg.score !== undefined) {
            const scorePercent = Math.round(sg.score * 100);
            const scoreClass = sg.score >= 0.7 ? "high" : sg.score >= 0.4 ? "medium" : "low";
            html += `<div class="outcome-item"><span class="outcome-badge-score ${scoreClass}">Nota: ${scorePercent}%</span></div>`;
          }
          
          // Success
          if (sg.success !== null && sg.success !== undefined) {
            const successIcon = sg.success ? "‚úÖ" : "‚ùå";
            html += `<div class="outcome-item"><span class="outcome-badge">${successIcon}</span></div>`;
          }
          
          // Suggested profile
          if (sg.suggested_profile) {
            const profileNames = {
              "fast": "R√°pido",
              "balanced": "Equilibrado",
              "thorough": "Exhaustivo"
            };
            const profileName = profileNames[sg.suggested_profile] || sg.suggested_profile;
            html += `<div class="outcome-item"><span class="outcome-badge">Perfil sugerido: ${escapeHtml(profileName)}</span></div>`;
          }
          
          // Suggested retries
          if (sg.suggested_retries !== null && sg.suggested_retries !== undefined) {
            const retryText = sg.suggested_retries 
              ? "El agente recomienda reintentar este sub-objetivo en el futuro"
              : "No recomienda reintentar este sub-objetivo";
            html += `<div class="outcome-item">${escapeHtml(retryText)}</div>`;
          }
          
          // Strengths
          if (sg.strengths && sg.strengths.length > 0) {
            html += '<div class="outcome-subgoal-section">‚úÖ Fortalezas:</div>';
            sg.strengths.forEach(strength => {
              html += `<div class="outcome-item">‚úÖ ${escapeHtml(strength)}</div>`;
            });
          }
          
          // Issues
          if (sg.issues && sg.issues.length > 0) {
            html += '<div class="outcome-subgoal-section">‚ö†Ô∏è Problemas:</div>';
            sg.issues.forEach(issue => {
              html += `<div class="outcome-item">‚ö†Ô∏è ${escapeHtml(issue)}</div>`;
            });
          }
          
          // Warnings
          if (sg.warnings && sg.warnings.length > 0) {
            html += '<div class="outcome-subgoal-section">üü° Advertencias:</div>';
            sg.warnings.forEach(warning => {
              html += `<div class="outcome-item">üü° ${escapeHtml(warning)}</div>`;
            });
          }
          
          // Suggested changes
          if (sg.suggested_changes) {
            html += '<div class="outcome-subgoal-section">üí° Sugerencias de mejora:</div>';
            html += `<div class="outcome-item">${escapeHtml(sg.suggested_changes)}</div>`;
          }
          
          html += '</div>';
        });
      }

      // Next run suggestions
      if (report.next_run_profile_suggestion) {
        const profileNames = {
          "fast": "R√°pido",
          "balanced": "Equilibrado",
          "thorough": "Exhaustivo"
        };
        const profileName = profileNames[report.next_run_profile_suggestion] || report.next_run_profile_suggestion;
        html += '<div class="outcome-section-title">Sugerencia para pr√≥xima ejecuci√≥n:</div>';
        html += `<div class="outcome-item">El LLM sugiere usar perfil: <strong>${escapeHtml(profileName)}</strong></div>`;
      }
      
      if (report.next_run_notes) {
        html += '<div class="outcome-section-title">Notas para pr√≥xima ejecuci√≥n:</div>';
        html += `<div class="outcome-item">${escapeHtml(report.next_run_notes)}</div>`;
      }

      // LLM Raw Notes (collapsible)
      if (report.llm_raw_notes) {
        html += '<div class="outcome-notes-toggle" onclick="toggleOutcomeNotes(this)">Mostrar notas internas del juez (solo para diagn√≥stico)</div>';
        html += `<pre class="outcome-notes-content">${escapeHtml(report.llm_raw_notes)}</pre>`;
      }

      html += '</div>';
      return html;
    }

    function toggleOutcomeNotes(toggle) {
      const content = toggle.nextElementSibling;
      if (content) {
        content.classList.toggle("expanded");
        toggle.classList.toggle("expanded");
      }
    }
    window.toggleOutcomeNotes = toggleOutcomeNotes;

    function renderExecutionPlan(plan, thinkingMsg) {
      if (!plan) return "";
      
      const subGoals = plan.sub_goals || [];
      const strategyNames = {
        "wikipedia": "Wikipedia",
        "images": "Im√°genes",
        "cae": "CAE",
        "other": "Otro"
      };
      const actionNames = {
        "navigate": "Navegar",
        "upload_file": "Subir archivo",
        "verify_upload": "Verificar subida"
      };
      
      let html = '<div class="execution-plan">';
      html += '<div style="margin-bottom: 16px; padding: 12px; background: #1e293b; border-radius: 6px; border: 1px solid #334155;">';
      html += '<div style="font-size: 12px; font-weight: 600; color: #9ca3af; margin-bottom: 8px;">Configuraci√≥n del plan:</div>';
      html += `<div style="font-size: 11px; color: #d1d5db; margin-bottom: 4px;">Modo: <strong>${escapeHtml(plan.execution_profile?.mode || "balanced")}</strong></div>`;
      html += `<div style="font-size: 11px; color: #d1d5db;">Estrategias: <strong>${(plan.context_strategies || []).map(s => strategyNames[s] || s).join(", ")}</strong></div>`;
      html += '</div>';
      
      html += '<div style="margin-bottom: 16px;">';
      subGoals.forEach(sg => {
        html += '<div style="margin-bottom: 12px; padding: 12px; background: #1e293b; border-radius: 6px; border: 1px solid #334155;">';
        html += `<div style="font-size: 12px; font-weight: 600; color: #e5e7eb; margin-bottom: 8px;">üìå ${sg.index}. ${escapeHtml(sg.sub_goal)}</div>`;
        html += `<div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">üß† Estrategia: <strong>${escapeHtml(strategyNames[sg.strategy] || sg.strategy)}</strong></div>`;
        
        if (sg.documents_needed && sg.documents_needed.length > 0) {
          html += `<div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">üìé Documentos: <strong>${sg.documents_needed.map(d => escapeHtml(d)).join(", ")}</strong></div>`;
        }
        
        html += `<div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">üîÅ Reintentos: <strong>${sg.may_retry ? "S√≠" : "No"}</strong></div>`;
        
        if (sg.expected_actions && sg.expected_actions.length > 0) {
          html += `<div style="font-size: 11px; color: #9ca3af;">‚öôÔ∏è Acciones: <strong>${sg.expected_actions.map(a => actionNames[a] || a).join(", ")}</strong></div>`;
        }
        
        // v2.9.0: Checkbox para incluir/excluir este sub-objetivo
        html += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.1);">';
        html += `<label class="plan-subgoal-toggle" style="display: flex; align-items: center; font-size: 11px; color: #d1d5db; cursor: pointer;">`;
        html += `<input type="checkbox" class="plan-subgoal-enabled" data-subgoal-index="${sg.index}" checked style="margin-right: 6px; cursor: pointer;">`;
        html += 'Incluir este sub-objetivo en la ejecuci√≥n';
        html += '</label>';
        html += '</div>';
        
        html += '</div>';
      });
      html += '</div>';
      
      // Botones de acci√≥n
      html += '<div style="display: flex; gap: 8px; margin-top: 16px;">';
      html += '<button onclick="confirmExecution(this)" style="flex: 1; padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ñ∂Ô∏è Ejecutar plan</button>';
      html += '<button onclick="cancelExecution(this)" style="flex: 1; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ùå Cancelar</button>';
      html += '</div>';
      
      html += '</div>';
      return html;
    }
    
    // v2.8.0: Confirmar ejecuci√≥n
    // v2.9.0: Leer checkboxes de sub-goals y enviar disabled_sub_goal_indices
    window.confirmExecution = function(button) {
      const msgElement = button.closest('.msg');
      if (!msgElement) return;
      
      // v2.9.0: Recoger √≠ndices de sub-goals deshabilitados
      const enabledInputs = document.querySelectorAll('.plan-subgoal-enabled');
      const disabledIndices = [];
      
      enabledInputs.forEach(input => {
        const index = parseInt(input.getAttribute('data-subgoal-index'), 10);
        if (!input.checked) {
          disabledIndices.push(index);
        }
      });
      
      // Deshabilitar botones
      button.disabled = true;
      const cancelBtn = button.parentElement.querySelector('button[onclick*="cancelExecution"]');
      if (cancelBtn) cancelBtn.disabled = true;
      
      // Cambiar mensaje a "Ejecutando..."
      const contentDiv = msgElement.querySelector('.msg-content');
      if (contentDiv) {
        contentDiv.textContent = "Ejecutando plan...";
      }
      
      // Crear nuevo mensaje de thinking
      const thinkingMsg = addMessage("agent", "Ejecutando...", "");
      thinkingMsg.classList.add("thinking");
      
      // v2.9.0: Guardar disabled_sub_goal_indices para usar en sendAgentMessage
      window.currentDisabledSubGoalIndices = disabledIndices.length > 0 ? disabledIndices : null;
      
      // Ejecutar con confirmaci√≥n
      sendAgentMessage("", thinkingMsg, true).catch(err => {
        const errorText = `Error al ejecutar el plan: ${err.message}`;
        updateMessage(thinkingMsg, errorText, "");
        thinkingMsg.classList.remove("thinking");
        thinkingMsg.classList.add("error");
      });
    };
    
    // v2.8.0: Cancelar ejecuci√≥n
    window.cancelExecution = function(button) {
      const msgElement = button.closest('.msg');
      if (!msgElement) return;
      
      // Deshabilitar botones
      button.disabled = true;
      const confirmBtn = button.parentElement.querySelector('button[onclick*="confirmExecution"]');
      if (confirmBtn) confirmBtn.disabled = true;
      
      // Mostrar mensaje de cancelaci√≥n
      const contentDiv = msgElement.querySelector('.msg-content');
      if (contentDiv) {
        contentDiv.textContent = "La ejecuci√≥n fue cancelada por el usuario antes de iniciarse.";
      }
      
      // Limpiar plan
      currentPlan = null;
      currentGoal = null;
      currentExecutionProfile = null;
      currentContextStrategies = null;
    };

    // v2.8.0: Estado para el plan
    let currentPlan = null;
    let currentGoal = null;
    let currentExecutionProfile = null;
    let currentContextStrategies = null;
    
    async function sendAgentMessage(text, thinkingMsg, confirmed = false) {
      // v2.7.0: Leer configuraci√≥n de execution profile y context strategies
      const execProfileInput = document.querySelector('input[name="execProfile"]:checked');
      const executionProfileName = execProfileInput ? execProfileInput.value : null;
      
      const contextStrategyInputs = document.querySelectorAll('input.context-strategy:checked');
      const contextStrategies = Array.from(contextStrategyInputs).map(el => el.value);
      
      // v2.8.0: Guardar configuraci√≥n para reutilizar en confirmaci√≥n
      if (!confirmed) {
        currentGoal = text;
        currentExecutionProfile = executionProfileName;
        currentContextStrategies = contextStrategies;
      }
      
      const payload = {
        goal: confirmed ? currentGoal : text,
        max_steps: 8
      };
      
      // v2.7.0: A√±adir execution_profile_name si est√° seleccionado
      const profileToUse = confirmed ? currentExecutionProfile : executionProfileName;
      if (profileToUse) {
        payload.execution_profile_name = profileToUse;
      }
      
      // v2.7.0: A√±adir context_strategies si hay alguna seleccionada
      const strategiesToUse = confirmed ? currentContextStrategies : contextStrategies;
      if (strategiesToUse && strategiesToUse.length > 0) {
        payload.context_strategies = strategiesToUse;
      }
      
      // v4.3.0: A√±adir execution_mode (dry_run si est√° marcado el checkbox)
      const dryRunCheckbox = document.getElementById("execution-mode-dry-run");
      if (dryRunCheckbox && dryRunCheckbox.checked) {
        payload.execution_mode = "dry_run";
      } else {
        payload.execution_mode = "live";
      }
      
      // v2.8.0: Primera request: solo plan
      if (!confirmed) {
        payload.plan_only = true;
      } else {
        // Segunda request: ejecutar con confirmaci√≥n
        payload.execution_confirmed = true;
      }
      
      const res = await fetch(API_AGENT_ANSWER, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }

      const data = await res.json();
      
      // v2.8.0: Manejar cancelaci√≥n
      if (data.execution_cancelled) {
        thinkingMsg.classList.remove("thinking");
        updateMessage(thinkingMsg, data.final_answer || "La ejecuci√≥n fue cancelada por el usuario antes de iniciarse.", "");
        return;
      }
      
      // v2.8.0: Manejar plan de ejecuci√≥n
      if (data.execution_plan && !confirmed) {
        currentPlan = data.execution_plan;
        thinkingMsg.classList.remove("thinking");
        
        // v3.8.0: Renderizar spotlight antes del plan si est√° disponible
        // v4.0.0: Renderizar planner hints despu√©s del spotlight y antes del plan
        let contentHtml = "";
        if (data.reasoning_spotlight) {
          contentHtml += renderReasoningSpotlight(data.reasoning_spotlight);
        }
        if (data.planner_hints) {
          contentHtml += renderPlannerHints(data.planner_hints);
        }
        contentHtml += renderExecutionPlan(data.execution_plan, thinkingMsg);
        
        updateMessage(thinkingMsg, "PLAN DE EJECUCI√ìN PROPUESTO", contentHtml);
        return;
      }
      
      // v3.8.0: Si hay spotlight pero no plan, mostrarlo tambi√©n
      const reasoningSpotlight = data.reasoning_spotlight || null;
      
      const finalAnswer = data.final_answer || "(sin respuesta)";
      const steps = data.steps || [];
      const sourceUrl = data.source_url || null;
      const sourceTitle = data.source_title || null;
      const sources = data.sources || [];
      
      // v1.8.0: Leer campos estructurados
      const sections = data.sections || null;
      const structuredSources = data.structured_sources || null;
      const metricsSummary = data.metrics_summary || null;
      // v2.2.0: Leer instrucciones de file upload
      const fileUploadInstructions = data.file_upload_instructions || null;
      // v3.8.0: Leer Reasoning Spotlight
      const reasoningSpotlight = data.reasoning_spotlight || null;

      // Update thinking message with final answer
      thinkingMsg.classList.remove("thinking");
      
      // Build extra HTML with source and steps
      let extraHtml = "";
      
      // v3.8.0: Renderizar spotlight si est√° disponible (antes de otras secciones)
      if (reasoningSpotlight) {
        extraHtml += renderReasoningSpotlight(reasoningSpotlight);
      }
      
      // v1.8.0: Si hay datos estructurados, usarlos; si no, comportamiento legacy
      if (sections || structuredSources || metricsSummary || fileUploadInstructions) {
        // Renderizar secciones por sub-objetivo
        if (sections) {
          extraHtml += renderSections(sections);
        }
        
        // Renderizar fuentes estructuradas globales
        if (structuredSources) {
          extraHtml += renderStructuredSources(structuredSources);
        }
        
        // v2.4.0: Renderizar secci√≥n global de subidas
        if (sections) {
          extraHtml += renderUploadsSection(sections);
        }
        
        // Renderizar m√©tricas
        if (metricsSummary) {
          extraHtml += renderMetrics(metricsSummary);
        }
        
        // v4.1.0: Renderizar Outcome Judge despu√©s de m√©tricas
        if (data.outcome_judge) {
          extraHtml += renderOutcomeJudge(data.outcome_judge);
        }
      } else {
        // Comportamiento legacy (v1.7.0 y anteriores)
        // Add source link if available
        if (sourceUrl) {
          const displayText = (sourceTitle && sourceTitle.trim()) ? sourceTitle : sourceUrl;
          extraHtml += `<div style="margin-bottom: 8px; font-size: 11px; color: #9ca3af;">Fuente principal: <a href="${escapeHtml(sourceUrl)}" target="_blank" style="color: #60a5fa; text-decoration: underline;">${escapeHtml(displayText)}</a></div>`;
        }
        
        // Add additional sources if available
        if (sources.length > 1) {
          const extra = sources.slice(1);
          const sourceLinks = extra.map(source => {
            const displayText = (source.title && source.title.trim()) ? source.title : source.url;
            return `<a href="${escapeHtml(source.url)}" target="_blank" style="color: #60a5fa; text-decoration: underline;">${escapeHtml(displayText)}</a>`;
          }).join(" ¬∑ ");
          extraHtml += `<div style="margin-bottom: 8px; font-size: 11px; color: #9ca3af;">Otras fuentes: ${sourceLinks}</div>`;
        }
      }
      
      // Add steps view if available (siempre disponible para debug)
      if (steps.length > 0) {
        extraHtml += createStepsView(steps);
      }
      
      // v1.8.0: Debug logging en desarrollo
      if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
        console.log("[CometLocal] Respuesta completa:", {
          sections,
          structuredSources,
          metricsSummary,
          fullData: data
        });
      }
      
      updateMessage(thinkingMsg, finalAnswer, extraHtml);
    }
  </script>
</body>
</html>
