<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Documental - CometLocal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #111827;
            color: #e5e7eb;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .header p {
            color: #9ca3af;
        }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #374151;
        }
        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .nav-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .nav-tab:hover {
            color: #e5e7eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: #1f2937;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }
        th {
            background: #111827;
            font-weight: 600;
            color: #9ca3af;
        }
        tr:hover {
            background: #374151;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .badge-active {
            background: #10b981;
            color: white;
        }
        .badge-inactive {
            background: #6b7280;
            color: white;
        }
        .badge-company {
            background: #3b82f6;
            color: white;
        }
        .badge-worker {
            background: #8b5cf6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #1f2937;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            font-size: 1.5rem;
        }
        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .close-btn:hover {
            color: #e5e7eb;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #d1d5db;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 0.95rem;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #10b981;
            color: white;
        }
        .alert-error {
            background: #ef4444;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        .actions-cell {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Repositorio Documental</h1>
            <p>Gesti√≥n de tipos de documento y documentos</p>
            <div style="margin-top: 10px;">
                <a href="/home" style="color: #3b82f6; text-decoration: none;">‚Üê Volver a Home</a>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="types">Tipos de Documento</button>
            <button class="nav-tab" data-tab="docs">Documentos</button>
            <button class="nav-tab" data-tab="rules">Reglas de Env√≠o</button>
            <button class="nav-tab" data-tab="history">Historial</button>
        </div>

        <!-- Tab: Tipos -->
        <div id="tab-types" class="tab-content active">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Tipos de Documento</h2>
                    <button class="btn btn-primary" onclick="openCreateTypeModal()">+ Crear Tipo</button>
                </div>
                <div id="types-alert"></div>
                <div id="types-table-container">
                    <div class="empty-state">Cargando tipos...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Documentos -->
        <div id="tab-docs" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Documentos</h2>
                    <button class="btn btn-primary" onclick="openUploadModal()">+ Subir Documento</button>
                </div>
                <div id="docs-alert"></div>
                <div id="docs-table-container">
                    <div class="empty-state">Cargando documentos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Reglas de Env√≠o -->
    <div id="tab-rules" class="tab-content">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Reglas de Env√≠o</h2>
                <button class="btn btn-primary" onclick="openCreateRuleModal()">Crear Regla</button>
            </div>
            <div id="rules-alert"></div>
            <div id="rules-table-container"></div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Regla -->
    <div id="rule-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="rule-modal-title">Crear Regla de Env√≠o</h3>
                <button class="close-btn" onclick="closeRuleModal()">&times;</button>
            </div>
            <form id="rule-form">
                <input type="hidden" id="rule-edit-id">
                <div class="form-group">
                    <label for="rule-id">ID de la Regla *</label>
                    <input type="text" id="rule-id" required pattern="[A-Z0-9_]+" placeholder="RULE_EGESTIONA_KERN_T104">
                    <small style="color: #9ca3af;">Solo may√∫sculas, n√∫meros y guiones bajos</small>
                </div>
                <div class="form-group">
                    <label for="rule-platform-key">Plataforma *</label>
                    <select id="rule-platform-key" required>
                        <option value="">Seleccionar...</option>
                        <option value="egestiona">eGestiona</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="rule-coord-label">Coordinaci√≥n (opcional)</label>
                    <input type="text" id="rule-coord-label" placeholder="Kern">
                    <small style="color: #9ca3af;">Etiqueta de coordinaci√≥n/tenant (opcional)</small>
                </div>
                <div class="form-group">
                    <label for="rule-document-type-id">Tipo de Documento *</label>
                    <select id="rule-document-type-id" required></select>
                </div>
                <div class="form-group">
                    <label for="rule-pending-text-contains">Tokens de Texto Pendiente *</label>
                    <textarea id="rule-pending-text-contains" rows="3" required placeholder="T104.0&#10;recibo bancario&#10;cuota aut√≥nomos"></textarea>
                    <small style="color: #9ca3af;">Una l√≠nea por token. Todos deben aparecer en el texto del pendiente.</small>
                </div>
                <div class="form-group">
                    <label for="rule-empresa-contains">Tokens de Empresa (opcional)</label>
                    <textarea id="rule-empresa-contains" rows="2" placeholder="TEDELAB"></textarea>
                    <small style="color: #9ca3af;">Una l√≠nea por token. Opcional, para filtrar por empresa.</small>
                </div>
                <div class="form-group">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">Selectores de Formulario</label>
                    <div style="padding: 15px; background: #1f2937; border-radius: 6px; border: 1px solid #374151;">
                        <div class="form-group">
                            <label for="rule-upload-selector">Selector de Upload</label>
                            <input type="text" id="rule-upload-selector" value="input[type='file']" placeholder="input[type='file']">
                        </div>
                        <div class="form-group">
                            <label for="rule-date-inicio-selector">Selector Fecha Inicio</label>
                            <input type="text" id="rule-date-inicio-selector" placeholder="#Fecha_Inicio_Vigencia">
                        </div>
                        <div class="form-group">
                            <label for="rule-date-inicio-format">Formato Fecha Inicio</label>
                            <input type="text" id="rule-date-inicio-format" value="DD/MM/YYYY" placeholder="DD/MM/YYYY">
                        </div>
                        <div class="form-group">
                            <label for="rule-date-fin-selector">Selector Fecha Fin (opcional)</label>
                            <input type="text" id="rule-date-fin-selector" placeholder="#Fecha_Fin_Vigencia">
                        </div>
                        <div class="form-group">
                            <label for="rule-date-fin-format">Formato Fecha Fin</label>
                            <input type="text" id="rule-date-fin-format" value="DD/MM/YYYY" placeholder="DD/MM/YYYY">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="rule-date-fin-optional"> Fecha Fin es opcional
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="rule-submit-selector">Selector Bot√≥n Submit (opcional)</label>
                            <input type="text" id="rule-submit-selector" placeholder="#btnSubmit">
                        </div>
                        <div class="form-group">
                            <label for="rule-submit-by-text">Bot√≥n Submit por Texto (opcional)</label>
                            <input type="text" id="rule-submit-by-text" placeholder="Enviar">
                        </div>
                        <div class="form-group">
                            <label for="rule-confirmation-text">Texto de Confirmaci√≥n (opcional)</label>
                            <textarea id="rule-confirmation-text" rows="2" placeholder="Documento enviado&#10;√âxito"></textarea>
                            <small style="color: #9ca3af;">Una l√≠nea por texto. Todos deben aparecer en la confirmaci√≥n.</small>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rule-enabled" checked> Habilitada
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRuleModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Crear/Editar Tipo -->
    <div id="type-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="type-modal-title">Crear Tipo de Documento</h3>
                <button class="close-btn" onclick="closeTypeModal()">&times;</button>
            </div>
            <form id="type-form">
                <input type="hidden" id="type-edit-id">
                <div class="form-group">
                    <label for="type-id">ID del Tipo *</label>
                    <input type="text" id="type-id" required pattern="[A-Z0-9_]+" placeholder="T104_AUTONOMOS_RECEIPT">
                    <small style="color: #9ca3af;">Solo may√∫sculas, n√∫meros y guiones bajos</small>
                </div>
                <div class="form-group">
                    <label for="type-name">Nombre *</label>
                    <input type="text" id="type-name" required placeholder="Recibo aut√≥nomos">
                </div>
                <div class="form-group">
                    <label for="type-description">Descripci√≥n</label>
                    <textarea id="type-description" placeholder="Descripci√≥n del tipo de documento"></textarea>
                </div>
                <div class="form-group">
                    <label for="type-platform-aliases">Aliases de Plataforma</label>
                    <textarea id="type-platform-aliases" placeholder="Una l√≠nea por alias (ej: T104.0, recibo bancario, cuota aut√≥nomos)" rows="3"></textarea>
                    <small style="color: #9ca3af;">Aliases para matching con plataformas externas (eGestiona, etc.)</small>
                </div>
                <div class="form-group">
                    <label for="type-scope">Alcance *</label>
                    <select id="type-scope" required>
                        <option value="company">Empresa</option>
                        <option value="worker">Trabajador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="type-validity-mode">Modo de Validez *</label>
                    <select id="type-validity-mode" required onchange="updateValidityFields()">
                        <option value="monthly">Mensual</option>
                        <option value="annual">Anual</option>
                        <option value="fixed_end_date">Fecha Fija</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="type-validity-basis">Base de C√°lculo *</label>
                    <select id="type-validity-basis" required>
                        <option value="issue_date">Fecha de Emisi√≥n</option>
                        <option value="name_date">Fecha desde Nombre</option>
                        <option value="manual">Manual</option>
                    </select>
                </div>
                <div id="validity-extra-fields"></div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="type-allow-late-submission"> Permitir env√≠o tard√≠o
                    </label>
                    <small style="color: #9ca3af;">Permite subir documentos despu√©s de la fecha de fin de validez</small>
                </div>
                <div class="form-group" id="late-submission-days-group" style="display: none;">
                    <label for="type-late-submission-max-days">M√°ximo d√≠as tarde</label>
                    <input type="number" id="type-late-submission-max-days" min="0" placeholder="Si vac√≠o, usa grace_days">
                    <small style="color: #9ca3af;">D√≠as m√°ximos despu√©s de valid_to para permitir env√≠o (si vac√≠o, usa grace_days del modo mensual)</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="type-active" checked> Activo
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTypeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Subir Documento -->
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Subir Documento</h3>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="upload-file">Archivo PDF *</label>
                    <input type="file" id="upload-file" accept=".pdf" required>
                </div>
                <div class="form-group">
                    <label for="upload-type-id">Tipo de Documento *</label>
                    <select id="upload-type-id" required onchange="updateUploadSubjectFieldsFromType()"></select>
                </div>
                <div id="upload-subject-fields"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Subir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmar Borrado -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Borrado</h3>
                <button class="close-btn" onclick="closeDeleteConfirmModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 20px;">¬øEst√°s seguro de que quieres borrar el documento <strong id="delete-doc-name"></strong>?</p>
                <p style="color: #ef4444; margin-bottom: 20px;">Esta acci√≥n no se puede deshacer.</p>
                <input type="hidden" id="delete-doc-id">
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteDocument()">Borrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver/Editar Documento -->
    <div id="doc-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalle del Documento</h3>
                <button class="close-btn" onclick="closeDocDetailModal()">&times;</button>
            </div>
            <form id="doc-detail-form">
                <input type="hidden" id="doc-detail-id">
                <div class="form-group">
                    <label>Archivo</label>
                    <div id="doc-detail-filename" style="padding: 10px; background: #111827; border-radius: 6px;"></div>
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <div id="doc-detail-type" style="padding: 10px; background: #111827; border-radius: 6px;"></div>
                </div>
                <div class="form-group">
                    <label>Alcance</label>
                    <div id="doc-detail-scope" style="padding: 10px; background: #111827; border-radius: 6px;"></div>
                </div>
                <div id="doc-detail-subject-fields"></div>
                <div class="form-group">
                    <label for="doc-detail-status">Estado *</label>
                    <select id="doc-detail-status" required>
                        <option value="draft">Draft</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="ready_to_submit">Ready to Submit</option>
                        <option value="submitted">Submitted</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Validez</label>
                    <div id="doc-detail-validity" style="padding: 10px; background: #111827; border-radius: 6px;"></div>
                </div>
                <div class="form-group">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">Override de Validez (opcional)</label>
                    <div style="padding: 15px; background: #1f2937; border-radius: 6px; border: 1px solid #374151;">
                        <div class="form-group">
                            <label for="doc-override-valid-from">Fecha Inicio Override (YYYY-MM-DD)</label>
                            <input type="date" id="doc-override-valid-from" style="width: 100%; padding: 8px; background: #111827; border: 1px solid #374151; border-radius: 4px; color: #e5e7eb;">
                            <small style="color: #9ca3af;">Si se especifica, reemplaza la fecha de inicio calculada</small>
                        </div>
                        <div class="form-group">
                            <label for="doc-override-valid-to">Fecha Fin Override (YYYY-MM-DD)</label>
                            <input type="date" id="doc-override-valid-to" style="width: 100%; padding: 8px; background: #111827; border: 1px solid #374151; border-radius: 4px; color: #e5e7eb;">
                            <small style="color: #9ca3af;">Si se especifica, reemplaza la fecha de fin calculada</small>
                        </div>
                        <div class="form-group">
                            <label for="doc-override-reason">Raz√≥n del Override</label>
                            <textarea id="doc-override-reason" rows="2" style="width: 100%; padding: 8px; background: #111827; border: 1px solid #374151; border-radius: 4px; color: #e5e7eb;" placeholder="Raz√≥n del override (opcional)"></textarea>
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="clearValidityOverride()" style="margin-top: 10px;">Limpiar Override</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDocDetailModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tab: Historial -->
    <div id="tab-history" class="tab-content">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Historial de Env√≠os</h2>
                <div style="display: flex; gap: 10px;">
                    <select id="history-filter-platform" style="padding: 8px; background: #111827; border: 1px solid #374151; border-radius: 6px; color: #e5e7eb;">
                        <option value="">Todas las plataformas</option>
                        <option value="egestiona">eGestiona</option>
                    </select>
                    <select id="history-filter-action" style="padding: 8px; background: #111827; border: 1px solid #374151; border-radius: 6px; color: #e5e7eb;">
                        <option value="">Todas las acciones</option>
                        <option value="planned">Planificado</option>
                        <option value="submitted">Enviado</option>
                        <option value="skipped">Omitido</option>
                        <option value="failed">Fallido</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadHistory()">Actualizar</button>
                </div>
            </div>
            <div id="history-alert"></div>
            <div id="history-table-container">
                <div class="empty-state">Cargando historial...</div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Registro -->
    <div id="history-record-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 800px; margin: 50px auto; background: #1f2937; border-radius: 8px; padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Detalle del Registro</h2>
                <button class="btn btn-secondary" onclick="closeHistoryRecordModal()">Cerrar</button>
            </div>
            <pre id="history-record-json" style="background: #111827; padding: 16px; border-radius: 6px; overflow-x: auto; color: #e5e7eb; font-size: 0.9rem;"></pre>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://127.0.0.1:8000';

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                if (tabName === 'types') {
                    loadTypes();
                } else if (tabName === 'docs') {
                    loadDocuments();
                } else if (tabName === 'rules') {
                    loadRules();
                } else if (tabName === 'history') {
                    loadHistory();
                }
            });
        });

        // Load types
        async function loadTypes() {
            const container = document.getElementById('types-table-container');
            container.innerHTML = '<div class="empty-state">Cargando tipos...</div>';
            
            try {
                // Timeout de 15 segundos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const res = await fetch(`${BACKEND_URL}/api/repository/types`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!res.ok) {
                    let errorDetail = `HTTP ${res.status}: `;
                    try {
                        const errorJson = await res.json();
                        errorDetail += errorJson.detail || errorJson.message || JSON.stringify(errorJson);
                    } catch (jsonError) {
                        try {
                            errorDetail += await res.text() || 'No se pudo leer el error';
                        } catch (textError) {
                            errorDetail += 'Error desconocido';
                        }
                    }
                    throw new Error(errorDetail);
                }
                
                const types = await res.json();
                
                // Verificar que es un array
                if (!Array.isArray(types)) {
                    console.error('Expected array but got:', typeof types, types);
                    throw new Error('El servidor devolvi√≥ un formato inesperado (se esperaba un array)');
                }
                
                renderTypesTable(types);
            } catch (error) {
                console.error('Error loading types:', error);
                const errorMsg = error.name === 'AbortError' 
                    ? 'Timeout: El servidor no respondi√≥ en 15 segundos. Verifica que el backend est√© ejecut√°ndose.'
                    : `Error al cargar tipos: ${error.message}`;
                showAlert('types-alert', errorMsg, 'error');
                container.innerHTML = '<div class="empty-state">Error al cargar tipos. Revisa la consola para m√°s detalles.</div>';
            }
        }

        function renderTypesTable(types) {
            const container = document.getElementById('types-table-container');
            if (types.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay tipos de documento. Crea el primero.</div>';
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Nombre</th><th>Alcance</th><th>Modo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            types.forEach(type => {
                html += `
                    <tr>
                        <td><code>${type.type_id}</code></td>
                        <td>${type.name}</td>
                        <td><span class="badge badge-${type.scope}">${type.scope}</span></td>
                        <td>${type.validity_policy.mode}</td>
                        <td><span class="badge ${type.active ? 'badge-active' : 'badge-inactive'}">${type.active ? 'Activo' : 'Inactivo'}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-small" onclick="editType('${type.type_id}')">Editar</button>
                            <button class="btn btn-secondary btn-small" onclick="duplicateType('${type.type_id}')">Duplicar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteType('${type.type_id}')">Borrar</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Type modal
        function openCreateTypeModal() {
            document.getElementById('type-modal-title').textContent = 'Crear Tipo de Documento';
            document.getElementById('type-form').reset();
            document.getElementById('type-edit-id').value = '';
            document.getElementById('type-id').disabled = false;
            updateValidityFields();
            document.getElementById('type-modal').classList.add('active');
        }

        function closeTypeModal() {
            document.getElementById('type-modal').classList.remove('active');
        }

        async function editType(typeId) {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`);
                const type = await res.json();
                
                document.getElementById('type-modal-title').textContent = 'Editar Tipo de Documento';
                document.getElementById('type-edit-id').value = typeId;
                document.getElementById('type-id').value = type.type_id;
                document.getElementById('type-id').disabled = true;
                document.getElementById('type-name').value = type.name;
                document.getElementById('type-description').value = type.description || '';
                document.getElementById('type-platform-aliases').value = (type.platform_aliases || []).join('\n');
                document.getElementById('type-scope').value = type.scope;
                document.getElementById('type-validity-mode').value = type.validity_policy.mode;
                document.getElementById('type-validity-basis').value = type.validity_policy.basis;
                document.getElementById('type-active').checked = type.active;
                
                updateValidityFields();
                
                // Cargar grace_days despu√©s de crear los campos
                if (type.validity_policy.monthly) {
                    const graceEl = document.getElementById('monthly-grace');
                    if (graceEl) {
                        graceEl.value = type.validity_policy.monthly.grace_days || 0;
                    }
                }
                
                // Cargar allow_late_submission y late_submission_max_days
                document.getElementById('type-allow-late-submission').checked = type.allow_late_submission || false;
                if (type.late_submission_max_days !== null && type.late_submission_max_days !== undefined) {
                    document.getElementById('type-late-submission-max-days').value = type.late_submission_max_days;
                } else {
                    document.getElementById('type-late-submission-max-days').value = '';
                }
                
                // Mostrar/ocultar campo de d√≠as tarde
                const daysGroup = document.getElementById('late-submission-days-group');
                daysGroup.style.display = type.allow_late_submission ? 'block' : 'none';
                document.getElementById('type-modal').classList.add('active');
            } catch (error) {
                showAlert('types-alert', 'Error al cargar tipo: ' + error.message, 'error');
            }
        }

        function updateValidityFields() {
            const mode = document.getElementById('type-validity-mode').value;
            const container = document.getElementById('validity-extra-fields');
            container.innerHTML = '';
            
            if (mode === 'monthly') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="monthly-source">Origen del Mes *</label>
                        <select id="monthly-source" required>
                            <option value="issue_date">Fecha de Emisi√≥n</option>
                            <option value="name_date">Fecha desde Nombre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monthly-grace">D√≠as de Gracia</label>
                        <input type="number" id="monthly-grace" value="0" min="0">
                        <small style="color: #9ca3af;">D√≠as de gracia despu√©s del fin del per√≠odo</small>
                    </div>
                `;
            } else if (mode === 'annual') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="annual-months">Meses de Validez *</label>
                        <input type="number" id="annual-months" value="12" min="1" required>
                    </div>
                `;
            }
        }
        
        // Mostrar/ocultar campo de d√≠as tarde seg√∫n checkbox
        document.getElementById('type-allow-late-submission').addEventListener('change', function() {
            const daysGroup = document.getElementById('late-submission-days-group');
            daysGroup.style.display = this.checked ? 'block' : 'none';
        });

        document.getElementById('type-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEdit = document.getElementById('type-edit-id').value !== '';
            const typeId = document.getElementById('type-id').value;
            
            const validityPolicy = {
                mode: document.getElementById('type-validity-mode').value,
                basis: document.getElementById('type-validity-basis').value
            };
            
            if (validityPolicy.mode === 'monthly') {
                validityPolicy.monthly = {
                    month_source: document.getElementById('monthly-source').value,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: parseInt(document.getElementById('monthly-grace').value) || 0
                };
            } else if (validityPolicy.mode === 'annual') {
                validityPolicy.annual = {
                    months: parseInt(document.getElementById('annual-months').value) || 12,
                    valid_from: 'issue_date',
                    valid_to: 'issue_date_plus_months'
                };
            } else if (validityPolicy.mode === 'fixed_end_date') {
                validityPolicy.fixed_end_date = {
                    valid_from: 'issue_date',
                    valid_to: 'manual_end_date'
                };
            }
            
            // Parsear aliases (una l√≠nea por alias)
            const aliasesText = document.getElementById('type-platform-aliases').value;
            const platform_aliases = aliasesText
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            const allowLateSubmission = document.getElementById('type-allow-late-submission').checked;
            const lateSubmissionMaxDaysInput = document.getElementById('type-late-submission-max-days').value;
            const lateSubmissionMaxDays = lateSubmissionMaxDaysInput === '' ? null : parseInt(lateSubmissionMaxDaysInput);
            
            const typeData = {
                type_id: typeId,
                name: document.getElementById('type-name').value,
                description: document.getElementById('type-description').value,
                platform_aliases: platform_aliases,
                scope: document.getElementById('type-scope').value,
                validity_policy: validityPolicy,
                required_fields: [],
                allow_late_submission: allowLateSubmission,
                late_submission_max_days: lateSubmissionMaxDays,
                active: document.getElementById('type-active').checked
            };
            
            try {
                const url = isEdit 
                    ? `${BACKEND_URL}/api/repository/types/${typeId}`
                    : `${BACKEND_URL}/api/repository/types`;
                const method = isEdit ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(typeData)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al guardar');
                }
                
                showAlert('types-alert', `Tipo ${isEdit ? 'actualizado' : 'creado'} correctamente`, 'success');
                closeTypeModal();
                loadTypes();
            } catch (error) {
                showAlert('types-alert', 'Error: ' + error.message, 'error');
            }
        });

        async function duplicateType(typeId) {
            const newId = prompt('Nuevo ID del tipo:');
            if (!newId) return;
            
            const newName = prompt('Nuevo nombre (opcional):') || null;
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_type_id: newId, new_name: newName })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al duplicar');
                }
                
                showAlert('types-alert', 'Tipo duplicado correctamente', 'success');
                loadTypes();
            } catch (error) {
                showAlert('types-alert', 'Error: ' + error.message, 'error');
            }
        }

        async function deleteType(typeId) {
            if (!confirm(`¬øEst√°s seguro de borrar el tipo ${typeId}?`)) return;
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al borrar');
                }
                
                showAlert('types-alert', 'Tipo borrado correctamente', 'success');
                loadTypes();
            } catch (error) {
                showAlert('types-alert', 'Error: ' + error.message, 'error');
            }
        }

        // Documents
        async function loadDocuments() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/docs`);
                const docs = await res.json();
                renderDocumentsTable(docs);
            } catch (error) {
                showAlert('docs-alert', 'Error al cargar documentos: ' + error.message, 'error');
            }
        }

        function renderDocumentsTable(docs) {
            const container = document.getElementById('docs-table-container');
            if (docs.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay documentos. Sube el primero.</div>';
                return;
            }

            let html = '<table><thead><tr><th>Archivo</th><th>Tipo</th><th>Alcance</th><th>Empresa</th><th>Trabajador</th><th>Validez</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            docs.forEach(doc => {
                const validFrom = doc.computed_validity.valid_from || '-';
                const validTo = doc.computed_validity.valid_to || '-';
                html += `
                    <tr>
                        <td>${doc.file_name_original}</td>
                        <td><code>${doc.type_id}</code></td>
                        <td><span class="badge badge-${doc.scope}">${doc.scope}</span></td>
                        <td>${doc.company_key || '-'}</td>
                        <td>${doc.person_key || '-'}</td>
                        <td>${validFrom} ‚Üí ${validTo}</td>
                        <td><span class="badge badge-active">${doc.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-small" onclick="viewDocument('${doc.doc_id}')">Editar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDocument('${doc.doc_id}', '${doc.file_name_original}', '${doc.status}')" ${doc.status === 'submitted' ? 'disabled title="No se puede borrar un documento enviado"' : ''}>Borrar</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function openUploadModal() {
            // Load types for dropdown
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types`);
                const types = await res.json();
                const select = document.getElementById('upload-type-id');
                select.innerHTML = '<option value="">Seleccionar...</option>';
                types.filter(t => t.active).forEach(type => {
                    select.innerHTML += `<option value="${type.type_id}">${type.name}</option>`;
                });
            } catch (error) {
                showAlert('docs-alert', 'Error al cargar tipos: ' + error.message, 'error');
                return;
            }
            
            document.getElementById('upload-form').reset();
            document.getElementById('upload-subject-fields').innerHTML = '';
            document.getElementById('upload-modal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.remove('active');
        }

        // Cache de org y people
        let orgData = null;
        let peopleData = null;

        async function loadOrgAndPeople() {
            if (!orgData) {
                try {
                    const res = await fetch(`${BACKEND_URL}/api/config/org`);
                    orgData = await res.json();
                } catch (error) {
                    console.error('Error loading org:', error);
                }
            }
            if (!peopleData) {
                try {
                    const res = await fetch(`${BACKEND_URL}/api/config/people`);
                    peopleData = await res.json();
                } catch (error) {
                    console.error('Error loading people:', error);
                }
            }
        }

        async function updateUploadSubjectFieldsFromType() {
            const typeId = document.getElementById('upload-type-id').value;
            if (!typeId) {
                document.getElementById('upload-subject-fields').innerHTML = '';
                return;
            }

            // Cargar org y people si no est√°n cargados
            await loadOrgAndPeople();

            // Obtener tipo para saber el scope
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`);
                const type = await res.json();
                const container = document.getElementById('upload-subject-fields');
                container.innerHTML = '';

                if (type.scope === 'company') {
                    // Solo empresa
                    let companyOptions = '<option value="">Seleccionar...</option>';
                    if (orgData) {
                        companyOptions += `<option value="${orgData.tax_id}">${orgData.legal_name} (${orgData.tax_id})</option>`;
                    }
                    container.innerHTML = `
                        <div class="form-group">
                            <label for="upload-company-key">Empresa *</label>
                            <select id="upload-company-key" required>${companyOptions}</select>
                        </div>
                    `;
                } else if (type.scope === 'worker') {
                    // Empresa + Trabajador
                    let companyOptions = '<option value="">Seleccionar...</option>';
                    if (orgData) {
                        companyOptions += `<option value="${orgData.tax_id}">${orgData.legal_name} (${orgData.tax_id})</option>`;
                    }
                    let personOptions = '<option value="">Seleccionar...</option>';
                    if (peopleData && peopleData.people) {
                        peopleData.people.forEach(person => {
                            personOptions += `<option value="${person.worker_id}">${person.full_name} (${person.worker_id})</option>`;
                        });
                    }
                    container.innerHTML = `
                        <div class="form-group">
                            <label for="upload-company-key">Empresa *</label>
                            <select id="upload-company-key" required>${companyOptions}</select>
                        </div>
                        <div class="form-group">
                            <label for="upload-person-key">Trabajador *</label>
                            <select id="upload-person-key" required>${personOptions}</select>
                        </div>
                    `;
                }
            } catch (error) {
                showAlert('docs-alert', 'Error al cargar tipo: ' + error.message, 'error');
            }
        }

        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const typeId = document.getElementById('upload-type-id').value;
            if (!typeId) {
                showAlert('docs-alert', 'Debes seleccionar un tipo de documento', 'error');
                return;
            }

            // Obtener scope del tipo
            let scope = null;
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`);
                const type = await res.json();
                scope = type.scope;
            } catch (error) {
                showAlert('docs-alert', 'Error al obtener tipo: ' + error.message, 'error');
                return;
            }
            
            const formData = new FormData();
            const fileInput = document.getElementById('upload-file');
            formData.append('file', fileInput.files[0]);
            formData.append('type_id', typeId);
            formData.append('scope', scope);
            
            if (scope === 'company') {
                const companyKey = document.getElementById('upload-company-key').value;
                if (!companyKey) {
                    showAlert('docs-alert', 'Debes seleccionar una empresa', 'error');
                    return;
                }
                formData.append('company_key', companyKey);
            } else if (scope === 'worker') {
                const companyKey = document.getElementById('upload-company-key').value;
                const personKey = document.getElementById('upload-person-key').value;
                if (!companyKey) {
                    showAlert('docs-alert', 'Debes seleccionar una empresa', 'error');
                    return;
                }
                if (!personKey) {
                    showAlert('docs-alert', 'Debes seleccionar un trabajador', 'error');
                    return;
                }
                formData.append('company_key', companyKey);
                formData.append('person_key', personKey);
            }
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/docs/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al subir');
                }
                
                showAlert('docs-alert', 'Documento subido correctamente', 'success');
                closeUploadModal();
                loadDocuments();
            } catch (error) {
                showAlert('docs-alert', 'Error: ' + error.message, 'error');
            }
        });

        async function viewDocument(docId) {
            try {
                // Cargar org y people si no est√°n cargados
                await loadOrgAndPeople();

                const res = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`);
                const doc = await res.json();
                
                document.getElementById('doc-detail-id').value = docId;
                document.getElementById('doc-detail-filename').textContent = doc.file_name_original;
                document.getElementById('doc-detail-type').textContent = doc.type_id;
                document.getElementById('doc-detail-scope').innerHTML = `<span class="badge badge-${doc.scope}">${doc.scope}</span>`;
                document.getElementById('doc-detail-status').value = doc.status;
                
                const validFrom = doc.computed_validity.valid_from || '-';
                const validTo = doc.computed_validity.valid_to || '-';
                const hasOverride = doc.validity_override !== null && doc.validity_override !== undefined;
                let validityText = `${validFrom} ‚Üí ${validTo}`;
                if (hasOverride) {
                    const overrideFrom = doc.validity_override.override_valid_from || validFrom;
                    const overrideTo = doc.validity_override.override_valid_to || validTo;
                    validityText += ` (Override: ${overrideFrom} ‚Üí ${overrideTo})`;
                }
                document.getElementById('doc-detail-validity').textContent = validityText;
                
                // Cargar override si existe
                if (hasOverride) {
                    if (doc.validity_override.override_valid_from) {
                        document.getElementById('doc-override-valid-from').value = doc.validity_override.override_valid_from;
                    }
                    if (doc.validity_override.override_valid_to) {
                        document.getElementById('doc-override-valid-to').value = doc.validity_override.override_valid_to;
                    }
                    if (doc.validity_override.reason) {
                        document.getElementById('doc-override-reason').value = doc.validity_override.reason;
                    }
                } else {
                    document.getElementById('doc-override-valid-from').value = '';
                    document.getElementById('doc-override-valid-to').value = '';
                    document.getElementById('doc-override-reason').value = '';
                }
                
                // Renderizar campos de sujeto seg√∫n scope
                const container = document.getElementById('doc-detail-subject-fields');
                if (doc.scope === 'company') {
                    let companyOptions = '<option value="">Seleccionar...</option>';
                    if (orgData) {
                        const selected = doc.company_key === orgData.tax_id ? 'selected' : '';
                        companyOptions += `<option value="${orgData.tax_id}" ${selected}>${orgData.legal_name} (${orgData.tax_id})</option>`;
                    }
                    container.innerHTML = `
                        <div class="form-group">
                            <label for="doc-detail-company-key">Empresa *</label>
                            <select id="doc-detail-company-key" required>${companyOptions}</select>
                        </div>
                    `;
                } else if (doc.scope === 'worker') {
                    let companyOptions = '<option value="">Seleccionar...</option>';
                    if (orgData) {
                        const selected = doc.company_key === orgData.tax_id ? 'selected' : '';
                        companyOptions += `<option value="${orgData.tax_id}" ${selected}>${orgData.legal_name} (${orgData.tax_id})</option>`;
                    }
                    let personOptions = '<option value="">Seleccionar...</option>';
                    if (peopleData && peopleData.people) {
                        peopleData.people.forEach(person => {
                            const selected = doc.person_key === person.worker_id ? 'selected' : '';
                            personOptions += `<option value="${person.worker_id}" ${selected}>${person.full_name} (${person.worker_id})</option>`;
                        });
                    }
                    container.innerHTML = `
                        <div class="form-group">
                            <label for="doc-detail-company-key">Empresa *</label>
                            <select id="doc-detail-company-key" required>${companyOptions}</select>
                        </div>
                        <div class="form-group">
                            <label for="doc-detail-person-key">Trabajador *</label>
                            <select id="doc-detail-person-key" required>${personOptions}</select>
                        </div>
                    `;
                }
                
                document.getElementById('doc-detail-modal').classList.add('active');
            } catch (error) {
                showAlert('docs-alert', 'Error al cargar documento: ' + error.message, 'error');
            }
        }

        function closeDocDetailModal() {
            document.getElementById('doc-detail-modal').classList.remove('active');
        }
        
        function clearValidityOverride() {
            document.getElementById('doc-override-valid-from').value = '';
            document.getElementById('doc-override-valid-to').value = '';
            document.getElementById('doc-override-reason').value = '';
        }

        document.getElementById('doc-detail-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('doc-detail-id').value;
            const updateData = {
                status: document.getElementById('doc-detail-status').value
            };
            
            const companyKeyEl = document.getElementById('doc-detail-company-key');
            if (companyKeyEl) {
                updateData.company_key = companyKeyEl.value;
            }
            
            const personKeyEl = document.getElementById('doc-detail-person-key');
            if (personKeyEl) {
                updateData.person_key = personKeyEl.value;
            }
            
            // Procesar validity_override
            const overrideFrom = document.getElementById('doc-override-valid-from').value;
            const overrideTo = document.getElementById('doc-override-valid-to').value;
            const overrideReason = document.getElementById('doc-override-reason').value.trim();
            
            if (overrideFrom || overrideTo || overrideReason) {
                updateData.validity_override = {
                    override_valid_from: overrideFrom || null,
                    override_valid_to: overrideTo || null,
                    reason: overrideReason || null
                };
            } else {
                // Si todos los campos est√°n vac√≠os, eliminar override
                updateData.validity_override = {};
            }
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al guardar');
                }
                
                showAlert('docs-alert', 'Documento actualizado correctamente', 'success');
                closeDocDetailModal();
                loadDocuments();
            } catch (error) {
                showAlert('docs-alert', 'Error: ' + error.message, 'error');
            }
        });

        // Delete document
        function deleteDocument(docId, fileName, status) {
            if (status === 'submitted') {
                showAlert('docs-alert', 'No se puede borrar un documento con status=submitted', 'error');
                return;
            }
            
            document.getElementById('delete-doc-id').value = docId;
            document.getElementById('delete-doc-name').textContent = fileName;
            document.getElementById('delete-confirm-modal').classList.add('active');
        }

        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').classList.remove('active');
        }

        async function confirmDeleteDocument() {
            const docId = document.getElementById('delete-doc-id').value;
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al borrar');
                }
                
                showAlert('docs-alert', 'Documento borrado correctamente', 'success');
                closeDeleteConfirmModal();
                loadDocuments();
            } catch (error) {
                showAlert('docs-alert', 'Error: ' + error.message, 'error');
            }
        }

        // ========== REGLAS DE ENV√çO ==========
        let allTypesForRules = [];

        async function loadRules() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules`);
                const rules = await res.json();
                renderRulesTable(rules);
            } catch (error) {
                showAlert('rules-alert', 'Error al cargar reglas: ' + error.message, 'error');
            }
        }

        async function loadTypesForRules() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/types`);
                allTypesForRules = await res.json();
                const select = document.getElementById('rule-document-type-id');
                select.innerHTML = '<option value="">Seleccionar...</option>';
                allTypesForRules.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.type_id;
                    option.textContent = `${type.type_id} - ${type.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading types for rules:', error);
            }
        }

        function renderRulesTable(rules) {
            const container = document.getElementById('rules-table-container');
            if (rules.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay reglas de env√≠o. Crea la primera.</div>';
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Plataforma</th><th>Coord</th><th>Tipo</th><th>Tokens</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            rules.forEach(rule => {
                const tokens = rule.match.pending_text_contains.join(', ');
                html += `
                    <tr>
                        <td><code>${rule.rule_id}</code></td>
                        <td>${rule.platform_key}</td>
                        <td>${rule.coord_label || '-'}</td>
                        <td><code>${rule.document_type_id}</code></td>
                        <td><small>${tokens || '-'}</small></td>
                        <td><span class="badge ${rule.enabled ? 'badge-active' : 'badge-inactive'}">${rule.enabled ? 'Habilitada' : 'Deshabilitada'}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-small" onclick="editRule('${rule.rule_id}')">Editar</button>
                            <button class="btn btn-secondary btn-small" onclick="duplicateRule('${rule.rule_id}')">Duplicar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteRule('${rule.rule_id}')">Borrar</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function openCreateRuleModal() {
            loadTypesForRules();
            document.getElementById('rule-modal-title').textContent = 'Crear Regla de Env√≠o';
            document.getElementById('rule-form').reset();
            document.getElementById('rule-edit-id').value = '';
            document.getElementById('rule-id').disabled = false;
            document.getElementById('rule-enabled').checked = true;
            document.getElementById('rule-upload-selector').value = "input[type='file']";
            document.getElementById('rule-date-inicio-format').value = "DD/MM/YYYY";
            document.getElementById('rule-date-fin-format').value = "DD/MM/YYYY";
            document.getElementById('rule-date-fin-optional').checked = false;
            document.getElementById('rule-modal').classList.add('active');
        }

        function closeRuleModal() {
            document.getElementById('rule-modal').classList.remove('active');
        }

        async function editRule(ruleId) {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules/${ruleId}`);
                const rule = await res.json();
                
                await loadTypesForRules();
                
                document.getElementById('rule-modal-title').textContent = 'Editar Regla de Env√≠o';
                document.getElementById('rule-edit-id').value = ruleId;
                document.getElementById('rule-id').value = rule.rule_id;
                document.getElementById('rule-id').disabled = true;
                document.getElementById('rule-platform-key').value = rule.platform_key;
                document.getElementById('rule-coord-label').value = rule.coord_label || '';
                document.getElementById('rule-document-type-id').value = rule.document_type_id;
                document.getElementById('rule-pending-text-contains').value = (rule.match.pending_text_contains || []).join('\n');
                document.getElementById('rule-empresa-contains').value = (rule.match.empresa_contains || []).join('\n');
                document.getElementById('rule-enabled').checked = rule.enabled;
                
                // Form selectors
                document.getElementById('rule-upload-selector').value = rule.form.upload_field_selector || "input[type='file']";
                
                if (rule.form.date_fields && rule.form.date_fields.inicio) {
                    document.getElementById('rule-date-inicio-selector').value = rule.form.date_fields.inicio.selector || '';
                    document.getElementById('rule-date-inicio-format').value = rule.form.date_fields.inicio.format || 'DD/MM/YYYY';
                }
                if (rule.form.date_fields && rule.form.date_fields.fin) {
                    document.getElementById('rule-date-fin-selector').value = rule.form.date_fields.fin.selector || '';
                    document.getElementById('rule-date-fin-format').value = rule.form.date_fields.fin.format || 'DD/MM/YYYY';
                    document.getElementById('rule-date-fin-optional').checked = rule.form.date_fields.fin.optional || false;
                }
                
                if (rule.form.submit_button) {
                    document.getElementById('rule-submit-selector').value = rule.form.submit_button.selector || '';
                    document.getElementById('rule-submit-by-text').value = rule.form.submit_button.by_text || '';
                }
                
                if (rule.form.confirmation && rule.form.confirmation.text_contains) {
                    document.getElementById('rule-confirmation-text').value = rule.form.confirmation.text_contains.join('\n');
                }
                
                document.getElementById('rule-modal').classList.add('active');
            } catch (error) {
                showAlert('rules-alert', 'Error al cargar regla: ' + error.message, 'error');
            }
        }

        document.getElementById('rule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEdit = document.getElementById('rule-edit-id').value !== '';
            const ruleId = document.getElementById('rule-id').value;
            
            // Parsear tokens
            const pendingTextTokens = document.getElementById('rule-pending-text-contains').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            const empresaTokens = document.getElementById('rule-empresa-contains').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Construir date_fields
            const dateFields = {};
            const inicioSelector = document.getElementById('rule-date-inicio-selector').value.trim();
            if (inicioSelector) {
                dateFields.inicio = {
                    selector: inicioSelector,
                    format: document.getElementById('rule-date-inicio-format').value || 'DD/MM/YYYY'
                };
            }
            const finSelector = document.getElementById('rule-date-fin-selector').value.trim();
            if (finSelector) {
                dateFields.fin = {
                    selector: finSelector,
                    format: document.getElementById('rule-date-fin-format').value || 'DD/MM/YYYY',
                    optional: document.getElementById('rule-date-fin-optional').checked
                };
            }
            
            // Construir submit_button
            const submitSelector = document.getElementById('rule-submit-selector').value.trim();
            const submitByText = document.getElementById('rule-submit-by-text').value.trim();
            const submitButton = {};
            if (submitSelector) submitButton.selector = submitSelector;
            if (submitByText) submitButton.by_text = submitByText;
            
            // Construir confirmation
            const confirmationText = document.getElementById('rule-confirmation-text').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            const ruleData = {
                rule_id: ruleId,
                platform_key: document.getElementById('rule-platform-key').value,
                coord_label: document.getElementById('rule-coord-label').value || null,
                enabled: document.getElementById('rule-enabled').checked,
                match: {
                    pending_text_contains: pendingTextTokens,
                    empresa_contains: empresaTokens
                },
                document_type_id: document.getElementById('rule-document-type-id').value,
                form: {
                    upload_field_selector: document.getElementById('rule-upload-selector').value || "input[type='file']",
                    date_fields: dateFields,
                    submit_button: submitButton,
                    confirmation: {
                        text_contains: confirmationText
                    }
                }
            };
            
            try {
                const url = isEdit 
                    ? `${BACKEND_URL}/api/repository/rules/${ruleId}`
                    : `${BACKEND_URL}/api/repository/rules`;
                const method = isEdit ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ruleData)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al guardar');
                }
                
                showAlert('rules-alert', `Regla ${isEdit ? 'actualizada' : 'creada'} correctamente`, 'success');
                closeRuleModal();
                loadRules();
            } catch (error) {
                showAlert('rules-alert', 'Error: ' + error.message, 'error');
            }
        });

        async function duplicateRule(ruleId) {
            const newId = prompt('Nuevo ID de la regla:');
            if (!newId) return;
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules/${ruleId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_rule_id: newId })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al duplicar');
                }
                
                showAlert('rules-alert', 'Regla duplicada correctamente', 'success');
                loadRules();
            } catch (error) {
                showAlert('rules-alert', 'Error: ' + error.message, 'error');
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm(`¬øEst√°s seguro de que quieres borrar la regla "${ruleId}"?`)) {
                return;
            }
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules/${ruleId}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al borrar');
                }
                
                showAlert('rules-alert', 'Regla borrada correctamente', 'success');
                loadRules();
            } catch (error) {
                showAlert('rules-alert', 'Error: ' + error.message, 'error');
            }
        }

        // ========== REGLAS DE ENV√çO ==========
        // NOTA: loadRules(), loadTypesForRules() y renderRulesTable() ya est√°n definidas arriba (l√≠nea ~1347)
        // Esta secci√≥n duplicada ha sido eliminada para evitar conflictos de sintaxis

        function openCreateRuleModal() {
            loadTypesForRules();
            document.getElementById('rule-modal-title').textContent = 'Crear Regla de Env√≠o';
            document.getElementById('rule-form').reset();
            document.getElementById('rule-edit-id').value = '';
            document.getElementById('rule-id').disabled = false;
            document.getElementById('rule-enabled').checked = true;
            document.getElementById('rule-upload-selector').value = "input[type='file']";
            document.getElementById('rule-date-inicio-format').value = "DD/MM/YYYY";
            document.getElementById('rule-date-fin-format').value = "DD/MM/YYYY";
            document.getElementById('rule-date-fin-optional').checked = false;
            document.getElementById('rule-modal').classList.add('active');
        }

        function closeRuleModal() {
            document.getElementById('rule-modal').classList.remove('active');
        }

        async function editRule(ruleId) {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules/${ruleId}`);
                const rule = await res.json();
                
                await loadTypesForRules();
                
                document.getElementById('rule-modal-title').textContent = 'Editar Regla de Env√≠o';
                document.getElementById('rule-edit-id').value = ruleId;
                document.getElementById('rule-id').value = rule.rule_id;
                document.getElementById('rule-id').disabled = true;
                document.getElementById('rule-platform-key').value = rule.platform_key;
                document.getElementById('rule-coord-label').value = rule.coord_label || '';
                document.getElementById('rule-document-type-id').value = rule.document_type_id;
                document.getElementById('rule-pending-text-contains').value = (rule.match.pending_text_contains || []).join('\n');
                document.getElementById('rule-empresa-contains').value = (rule.match.empresa_contains || []).join('\n');
                document.getElementById('rule-enabled').checked = rule.enabled;
                
                // Form selectors
                document.getElementById('rule-upload-selector').value = rule.form.upload_field_selector || "input[type='file']";
                
                if (rule.form.date_fields && rule.form.date_fields.inicio) {
                    document.getElementById('rule-date-inicio-selector').value = rule.form.date_fields.inicio.selector || '';
                    document.getElementById('rule-date-inicio-format').value = rule.form.date_fields.inicio.format || 'DD/MM/YYYY';
                }
                if (rule.form.date_fields && rule.form.date_fields.fin) {
                    document.getElementById('rule-date-fin-selector').value = rule.form.date_fields.fin.selector || '';
                    document.getElementById('rule-date-fin-format').value = rule.form.date_fields.fin.format || 'DD/MM/YYYY';
                    document.getElementById('rule-date-fin-optional').checked = rule.form.date_fields.fin.optional || false;
                }
                
                if (rule.form.submit_button) {
                    document.getElementById('rule-submit-selector').value = rule.form.submit_button.selector || '';
                    document.getElementById('rule-submit-by-text').value = rule.form.submit_button.by_text || '';
                }
                
                if (rule.form.confirmation && rule.form.confirmation.text_contains) {
                    document.getElementById('rule-confirmation-text').value = rule.form.confirmation.text_contains.join('\n');
                }
                
                document.getElementById('rule-modal').classList.add('active');
            } catch (error) {
                showAlert('rules-alert', 'Error al cargar regla: ' + error.message, 'error');
            }
        }

        document.getElementById('rule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEdit = document.getElementById('rule-edit-id').value !== '';
            const ruleId = document.getElementById('rule-id').value;
            
            // Parsear tokens
            const pendingTextTokens = document.getElementById('rule-pending-text-contains').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            const empresaTokens = document.getElementById('rule-empresa-contains').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Construir date_fields
            const dateFields = {};
            const inicioSelector = document.getElementById('rule-date-inicio-selector').value.trim();
            if (inicioSelector) {
                dateFields.inicio = {
                    selector: inicioSelector,
                    format: document.getElementById('rule-date-inicio-format').value || 'DD/MM/YYYY'
                };
            }
            const finSelector = document.getElementById('rule-date-fin-selector').value.trim();
            if (finSelector) {
                dateFields.fin = {
                    selector: finSelector,
                    format: document.getElementById('rule-date-fin-format').value || 'DD/MM/YYYY',
                    optional: document.getElementById('rule-date-fin-optional').checked
                };
            }
            
            // Construir submit_button
            const submitSelector = document.getElementById('rule-submit-selector').value.trim();
            const submitByText = document.getElementById('rule-submit-by-text').value.trim();
            const submitButton = {};
            if (submitSelector) submitButton.selector = submitSelector;
            if (submitByText) submitButton.by_text = submitByText;
            
            // Construir confirmation
            const confirmationText = document.getElementById('rule-confirmation-text').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            const ruleData = {
                rule_id: ruleId,
                platform_key: document.getElementById('rule-platform-key').value,
                coord_label: document.getElementById('rule-coord-label').value || null,
                enabled: document.getElementById('rule-enabled').checked,
                match: {
                    pending_text_contains: pendingTextTokens,
                    empresa_contains: empresaTokens
                },
                document_type_id: document.getElementById('rule-document-type-id').value,
                form: {
                    upload_field_selector: document.getElementById('rule-upload-selector').value || "input[type='file']",
                    date_fields: dateFields,
                    submit_button: submitButton,
                    confirmation: {
                        text_contains: confirmationText
                    }
                }
            };
            
            try {
                const url = isEdit 
                    ? `${BACKEND_URL}/api/repository/rules/${ruleId}`
                    : `${BACKEND_URL}/api/repository/rules`;
                const method = isEdit ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ruleData)
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al guardar');
                }
                
                showAlert('rules-alert', `Regla ${isEdit ? 'actualizada' : 'creada'} correctamente`, 'success');
                closeRuleModal();
                loadRules();
            } catch (error) {
                showAlert('rules-alert', 'Error: ' + error.message, 'error');
            }
        });

        async function duplicateRule(ruleId) {
            const newId = prompt('Nuevo ID de la regla:');
            if (!newId) return;
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules/${ruleId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_rule_id: newId })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al duplicar');
                }
                
                showAlert('rules-alert', 'Regla duplicada correctamente', 'success');
                loadRules();
            } catch (error) {
                showAlert('rules-alert', 'Error: ' + error.message, 'error');
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm(`¬øEst√°s seguro de que quieres borrar la regla "${ruleId}"?`)) {
                return;
            }
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/rules/${ruleId}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Error al borrar');
                }
                
                showAlert('rules-alert', 'Regla borrada correctamente', 'success');
                loadRules();
            } catch (error) {
                showAlert('rules-alert', 'Error: ' + error.message, 'error');
            }
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Load history
        async function loadHistory() {
            const container = document.getElementById('history-table-container');
            if (container) {
                container.innerHTML = '<div class="empty-state">Cargando historial...</div>';
            }
            
            try {
                const platform = document.getElementById('history-filter-platform').value;
                const action = document.getElementById('history-filter-action').value;
                
                let url = `${BACKEND_URL}/api/repository/history?limit=100`;
                if (platform) url += `&platform_key=${platform}`;
                if (action) url += `&action=${action}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const res = await fetch(url, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!res.ok) {
                    let errorDetail = `HTTP ${res.status}: `;
                    try {
                        const errorJson = await res.json();
                        errorDetail += errorJson.detail || errorJson.message || JSON.stringify(errorJson);
                    } catch (jsonError) {
                        try {
                            errorDetail += await res.text() || 'No se pudo leer el error';
                        } catch (textError) {
                            errorDetail += 'Error desconocido';
                        }
                    }
                    throw new Error(errorDetail);
                }
                
                const records = await res.json();
                
                if (!Array.isArray(records)) {
                    console.error('Expected array but got:', typeof records, records);
                    throw new Error('El servidor devolvi√≥ un formato inesperado (se esperaba un array)');
                }
                
                renderHistoryTable(records);
            } catch (error) {
                console.error('Error loading history:', error);
                const errorMsg = error.name === 'AbortError' 
                    ? 'Timeout: El servidor no respondi√≥ en 15 segundos.'
                    : `Error al cargar historial: ${error.message}`;
                showAlert('history-alert', errorMsg, 'error');
                if (container) {
                    container.innerHTML = '<div class="empty-state">Error al cargar historial. Revisa la consola para m√°s detalles.</div>';
                }
            }
        }

        function renderHistoryTable(records) {
            const container = document.getElementById('history-table-container');
            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay registros en el historial.</div>';
                return;
            }

            let html = '<table><thead><tr><th>Fecha</th><th>Plataforma/Coord</th><th>Empresa/Persona</th><th>Doc ID</th><th>Acci√≥n</th><th>Decisi√≥n</th><th>Run ID</th><th>Acciones</th></tr></thead><tbody>';
            records.forEach(record => {
                const fecha = new Date(record.created_at).toLocaleString('es-ES');
                const platformCoord = `${record.platform_key}${record.coord_label ? '/' + record.coord_label : ''}`;
                const empresaPersona = `${record.company_key || '-'}${record.person_key ? '/' + record.person_key : ''}`;
                const actionBadge = {
                    'planned': 'badge-info',
                    'submitted': 'badge-success',
                    'skipped': 'badge-warning',
                    'failed': 'badge-error'
                }[record.action] || 'badge-secondary';
                
                html += `
                    <tr>
                        <td>${fecha}</td>
                        <td>${platformCoord}</td>
                        <td>${empresaPersona}</td>
                        <td><code>${record.doc_id.substring(0, 8)}...</code></td>
                        <td><span class="badge ${actionBadge}">${record.action}</span></td>
                        <td><code>${record.decision}</code></td>
                        <td><a href="/runs/${record.run_id}" target="_blank" style="color: #3b82f6;">${record.run_id.substring(0, 8)}...</a></td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary" onclick="viewHistoryRecord('${record.record_id}')">Ver</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function viewHistoryRecord(recordId) {
            try {
                const res = await fetch(`${BACKEND_URL}/api/repository/history/${recordId}`);
                const record = await res.json();
                document.getElementById('history-record-json').textContent = JSON.stringify(record, null, 2);
                document.getElementById('history-record-modal').style.display = 'block';
            } catch (error) {
                showAlert('history-alert', 'Error al cargar registro: ' + error.message, 'error');
            }
        }

        function closeHistoryRecordModal() {
            document.getElementById('history-record-modal').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTypes();
            
            // Filtros de historial
            document.getElementById('history-filter-platform').addEventListener('change', loadHistory);
            document.getElementById('history-filter-action').addEventListener('change', loadHistory);
        });
    </script>
</body>
</html>



