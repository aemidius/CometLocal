<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Documental - CometLocal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
        }
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3b82f6;
        }
        .sidebar-header p {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #334155;
            color: #fff;
        }
        .nav-item.active {
            background: #1e3a8a;
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
        }
        .nav-item-icon {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
            background: #1e293b;
        }
        .content-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .content-header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        /* Cards */
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }
        .kpi-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .kpi-card-title {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .kpi-card-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        .kpi-card-subtitle {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #475569;
            color: white;
        }
        .btn-secondary:hover {
            background: #334155;
        }
        .btn-lg {
            padding: 14px 28px;
            font-size: 1.1rem;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        th {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        td {
            color: #e2e8f0;
        }
        tr:hover {
            background: #1e293b;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-ok {
            background: #10b981;
            color: white;
        }
        .badge-falta {
            background: #f59e0b;
            color: white;
        }
        .badge-tarde {
            background: #ef4444;
            color: white;
        }
        .badge-info {
            background: #3b82f6;
            color: white;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.95rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-help {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        .form-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }
        .alert-warning {
            background: #78350f;
            border: 1px solid #f59e0b;
            color: #fcd34d;
        }
        .alert-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .calendar-month {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-month:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .calendar-month.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        .calendar-month-header {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .calendar-month-status {
            margin-bottom: 8px;
        }
        .calendar-month-action {
            margin-top: 8px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }
        .modal-header {
            margin-bottom: 16px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        /* Platform Status */
        .platform-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .platform-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 12px;
        }
        .platform-status-ok {
            background: #10b981;
            color: white;
        }
        .platform-status-partial {
            background: #f59e0b;
            color: white;
        }
        .platform-status-none {
            background: #ef4444;
            color: white;
        }
        
        /* Upload Wizard */
        .upload-zone {
            border: 2px dashed #334155;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #1e293b;
            transition: all 0.2s;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        .file-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .file-card h4 {
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        .wizard-question {
            margin-bottom: 20px;
        }
        
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background: #334155;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Repositorio</h1>
            <p>Documental</p>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" data-page="inicio">
                <span class="nav-item-icon">üè†</span>
                Inicio
            </a>
            <a class="nav-item" data-page="calendario">
                <span class="nav-item-icon">üìÖ</span>
                Calendario de documentos
            </a>
            <a class="nav-item" data-page="subir">
                <span class="nav-item-icon">üì§</span>
                Subir documentos
            </a>
            <a class="nav-item" data-page="buscar">
                <span class="nav-item-icon">üîç</span>
                Buscar documentos
            </a>
            <a class="nav-item" data-page="plataformas">
                <span class="nav-item-icon">üåê</span>
                Plataformas
            </a>
            <a class="nav-item" data-page="catalogo">
                <span class="nav-item-icon">üìö</span>
                Cat√°logo de documentos
            </a>
            <a class="nav-item" data-page="actividad">
                <span class="nav-item-icon">üìú</span>
                Actividad
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <h2 id="page-title">Inicio</h2>
            <p id="page-description">Vista general del repositorio</p>
        </div>
        <div class="content-body" id="page-content">
            <div class="loading">Cargando...</div>
        </div>
    </div>
    
    <script>
        const BACKEND_URL = 'http://127.0.0.1:8000';
        let currentPage = 'inicio';
        
        // Spanish month names
        const MONTHS_ES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // Human-friendly status labels
        const STATUS_LABELS = {
            'AVAILABLE': 'OK',
            'MISSING': 'Falta',
            'LATE': 'Tarde'
        };
        
        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                navigateTo(page);
            });
        });
        
        function navigateTo(page) {
            currentPage = page;
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
            
            // Load page content
            loadPage(page);
        }
        
        async function loadPage(page) {
            const content = document.getElementById('page-content');
            content.innerHTML = '<div class="loading">Cargando...</div>';
            
            const titles = {
                inicio: 'Inicio',
                calendario: 'Calendario de documentos',
                subir: 'Subir documentos',
                buscar: 'Buscar documentos',
                plataformas: 'Plataformas',
                catalogo: 'Cat√°logo de documentos',
                actividad: 'Actividad'
            };
            
            const descriptions = {
                inicio: 'Vista general del repositorio',
                calendario: 'Visualiza qu√© documentos faltan por mes',
                subir: 'Sube documentos al repositorio',
                buscar: 'Busca documentos en el repositorio',
                plataformas: 'Estado de configuraci√≥n de plataformas',
                catalogo: 'Gestiona tipos de documento',
                actividad: 'Historial de actividad'
            };
            
            document.getElementById('page-title').textContent = titles[page] || page;
            document.getElementById('page-description').textContent = descriptions[page] || '';
            
            switch(page) {
                case 'inicio':
                    await loadInicio();
                    break;
                case 'calendario':
                    await loadCalendario();
                    break;
                case 'subir':
                    await loadSubir();
                    break;
                case 'buscar':
                    await loadBuscar();
                    break;
                case 'plataformas':
                    await loadPlataformas();
                    break;
                case 'catalogo':
                    await loadCatalogo();
                    break;
                case 'actividad':
                    await loadActividad();
                    break;
            }
        }
        
        // Utility functions
        function formatMonth(periodKey) {
            if (!periodKey) return '';
            const match = periodKey.match(/(\d{4})-(\d{2})/);
            if (match) {
                const year = match[1];
                const month = parseInt(match[2]) - 1;
                return `${MONTHS_ES[month]} ${year}`;
            }
            return periodKey;
        }
        
        function formatStatus(status) {
            return STATUS_LABELS[status] || status;
        }
        
        function getStatusBadgeClass(status) {
            if (status === 'AVAILABLE') return 'badge-ok';
            if (status === 'MISSING') return 'badge-falta';
            if (status === 'LATE') return 'badge-tarde';
            return 'badge-info';
        }
        
        // Inicio
        async function loadInicio() {
            const content = document.getElementById('page-content');
            
            try {
                const [types, docs, rules, platforms] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/repository/docs`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json()).catch(() => ({platforms: []}))
                ]);
                
                // Calculate KPIs
                const periodicTypes = types.filter(t => {
                    const mode = t.validity_policy?.mode;
                    return mode === 'monthly' || mode === 'annual' || mode === 'quarter';
                });
                
                // Count missing this month (simplified)
                const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                const missingThisMonth = 0; // TODO: Calculate from expected periods
                
                // Count expiring soon (next 30 days)
                const expiringSoon = docs.filter(d => {
                    if (!d.computed_validity?.valid_to) return false;
                    const validTo = new Date(d.computed_validity.valid_to);
                    const now = new Date();
                    const daysDiff = (validTo - now) / (1000 * 60 * 60 * 24);
                    return daysDiff > 0 && daysDiff <= 30;
                }).length;
                
                // Count platforms without rules
                const egestiona = platforms.platforms?.find(p => p.key === 'egestiona');
                const coords = egestiona?.coordinations || [];
                const coordsWithoutRules = coords.filter(coord => {
                    const hasRule = rules.some(r => 
                        (r.scope === 'COORD' && r.coord_label === coord.label) ||
                        (r.scope === 'GLOBAL' && r.platform_key === 'egestiona')
                    );
                    return !hasRule;
                }).length;
                
                // Recent uploads (last 5)
                const recentDocs = docs
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);
                
                // Quick actions (missing documents)
                const quickActions = []; // TODO: Generate from expected periods
                
                content.innerHTML = `
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-card-title">Faltan este mes</div>
                            <div class="kpi-card-value">${missingThisMonth}</div>
                            <div class="kpi-card-subtitle">Documentos pendientes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">A punto de caducar</div>
                            <div class="kpi-card-value">${expiringSoon}</div>
                            <div class="kpi-card-subtitle">Pr√≥ximos 30 d√≠as</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Plataformas sin configurar</div>
                            <div class="kpi-card-value">${coordsWithoutRules}</div>
                            <div class="kpi-card-subtitle">Clientes sin reglas</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Documentos</div>
                            <div class="kpi-card-value">${docs.length}</div>
                            <div class="kpi-card-subtitle">En el repositorio</div>
                        </div>
                    </div>
                    
                    ${quickActions.length > 0 ? `
                        <div class="card">
                            <h3>Acciones r√°pidas</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>De qui√©n</th>
                                            <th>Mes</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${quickActions.map(action => `
                                            <tr>
                                                <td>${action.typeName}</td>
                                                <td>${action.subjectName}</td>
                                                <td>${formatMonth(action.periodKey)}</td>
                                                <td>
                                                    <button class="btn btn-primary" onclick="uploadQuickAction('${action.typeId}', '${action.subjectKey}', '${action.scope}', '${action.periodKey}')">
                                                        Subir
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <h3>Subidas recientes</h3>
                        ${recentDocs.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>De qui√©n</th>
                                            <th>Mes</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${recentDocs.map(doc => {
                                            const type = types.find(t => t.type_id === doc.type_id);
                                            const period = doc.period_key ? formatMonth(doc.period_key) : '-';
                                            return `
                                                <tr>
                                                    <td>${type ? type.name : doc.type_id}</td>
                                                    <td>${doc.person_key || doc.company_key || '-'}</td>
                                                    <td>${period}</td>
                                                    <td>${new Date(doc.created_at).toLocaleDateString('es-ES')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #94a3b8;">No hay documentos recientes</p>'}
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar inicio: ${error.message}</div>`;
            }
        }
        
        function uploadQuickAction(typeId, subjectKey, scope, periodKey) {
            navigateTo('subir');
            window.uploadPrefill = {
                type_id: typeId,
                [scope === 'worker' ? 'person_key' : 'company_key']: subjectKey,
                period_key: periodKey
            };
        }
        
        // Calendario
        let calendarTypes = [];
        let calendarPeople = [];
        let selectedType = null;
        let selectedSubject = null;
        let selectedMonths = 24;
        let calendarPeriods = [];
        let selectedPeriod = null;
        
        async function loadCalendario() {
            const content = document.getElementById('page-content');
            
            try {
                [calendarTypes, calendarPeople] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}))
                ]);
                
                const periodicTypes = calendarTypes.filter(t => {
                    const mode = t.validity_policy?.mode;
                    return mode === 'monthly' || mode === 'annual' || mode === 'quarter';
                });
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Calendario de documentos</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">¬øQu√© documento?</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-input" 
                                           id="calendar-type-input"
                                           placeholder="Buscar documento..."
                                           oninput="searchCalendarType(this.value)"
                                           onfocus="searchCalendarType(this.value)">
                                    <div class="autocomplete-dropdown hidden" id="calendar-type-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group" id="calendar-subject-group" style="display: none;">
                                <label class="form-label" id="calendar-subject-label">¬øDe qui√©n / qu√© empresa?</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-input" 
                                           id="calendar-subject-input"
                                           placeholder="Buscar..."
                                           oninput="searchCalendarSubject(this.value)"
                                           onfocus="searchCalendarSubject(this.value)">
                                    <div class="autocomplete-dropdown hidden" id="calendar-subject-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rango</label>
                                <select class="form-input" id="calendar-months" onchange="updateCalendarMonths()">
                                    <option value="12">√öltimos 12 meses</option>
                                    <option value="24" selected>√öltimos 24 meses</option>
                                    <option value="36">√öltimos 36 meses</option>
                                </select>
                            </div>
                        </div>
                        <div id="calendar-grid-container"></div>
                    </div>
                    
                    <!-- Side panel for selected month -->
                    <div id="calendar-side-panel" class="card hidden" style="position: fixed; right: 24px; top: 120px; width: 350px; max-height: 80vh; overflow-y: auto; z-index: 100;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 id="side-panel-title">Detalle del mes</h3>
                            <button class="btn btn-secondary" onclick="closeCalendarSidePanel()" style="padding: 4px 12px;">‚úï</button>
                        </div>
                        <div id="side-panel-content"></div>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar calendario: ${error.message}</div>`;
            }
        }
        
        function searchCalendarType(query) {
            const dropdown = document.getElementById('calendar-type-dropdown');
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = calendarTypes.filter(t => 
                t.name.toLowerCase().includes(query.toLowerCase()) ||
                t.type_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(t => `
                <div class="autocomplete-item" onclick="selectCalendarType('${t.type_id}')">
                    ${t.name} <span style="color: #94a3b8; font-size: 0.875rem;">(${t.type_id})</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectCalendarType(typeId) {
            selectedType = calendarTypes.find(t => t.type_id === typeId);
            document.getElementById('calendar-type-input').value = selectedType.name;
            document.getElementById('calendar-type-dropdown').classList.add('hidden');
            
            // Show subject selector
            const subjectGroup = document.getElementById('calendar-subject-group');
            const subjectLabel = document.getElementById('calendar-subject-label');
            
            if (selectedType.scope === 'worker') {
                subjectGroup.style.display = 'block';
                subjectLabel.textContent = '¬øDe qui√©n?';
            } else if (selectedType.scope === 'company') {
                subjectGroup.style.display = 'block';
                subjectLabel.textContent = '¬øDe qu√© empresa?';
            } else {
                subjectGroup.style.display = 'none';
            }
            
            updateCalendar();
        }
        
        function searchCalendarSubject(query) {
            const dropdown = document.getElementById('calendar-subject-dropdown');
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            if (selectedType?.scope === 'worker') {
                const matches = (calendarPeople.people || []).filter(p => 
                    p.full_name.toLowerCase().includes(query.toLowerCase()) ||
                    p.worker_id.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10);
                
                dropdown.innerHTML = matches.map(p => `
                    <div class="autocomplete-item" onclick="selectCalendarSubject('${p.worker_id}', '${p.full_name}')">
                        ${p.full_name}
                    </div>
                `).join('');
            }
            
            dropdown.classList.remove('hidden');
        }
        
        function selectCalendarSubject(subjectKey, subjectName) {
            selectedSubject = { key: subjectKey, name: subjectName };
            document.getElementById('calendar-subject-input').value = subjectName;
            document.getElementById('calendar-subject-dropdown').classList.add('hidden');
            updateCalendar();
        }
        
        function updateCalendarMonths() {
            selectedMonths = parseInt(document.getElementById('calendar-months').value);
            updateCalendar();
        }
        
        async function updateCalendar() {
            if (!selectedType || !selectedSubject) {
                document.getElementById('calendar-grid-container').innerHTML = 
                    '<div class="alert alert-info">Selecciona un documento y un sujeto para ver el calendario</div>';
                return;
            }
            
            try {
                const params = new URLSearchParams({ months: selectedMonths });
                if (selectedType.scope === 'worker') {
                    params.append('person_key', selectedSubject.key);
                } else if (selectedType.scope === 'company') {
                    params.append('company_key', selectedSubject.key);
                }
                
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${selectedType.type_id}/expected?${params}`);
                calendarPeriods = await response.json();
                
                const container = document.getElementById('calendar-grid-container');
                container.innerHTML = `
                    <div class="calendar-grid">
                        ${calendarPeriods.map(p => {
                            const monthName = formatMonth(p.period_key);
                            const status = formatStatus(p.status);
                            const badgeClass = getStatusBadgeClass(p.status);
                            return `
                                <div class="calendar-month ${selectedPeriod === p.period_key ? 'selected' : ''}" 
                                     onclick="selectCalendarPeriod('${p.period_key}')">
                                    <div class="calendar-month-header">${monthName}</div>
                                    <div class="calendar-month-status">
                                        <span class="badge ${badgeClass}">${status}</span>
                                    </div>
                                    ${p.status !== 'AVAILABLE' ? `
                                        <div class="calendar-month-action">
                                            <button class="btn btn-primary" onclick="event.stopPropagation(); uploadForCalendarPeriod('${p.period_key}')">
                                                Subir
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('calendar-grid-container').innerHTML = 
                    `<div class="alert alert-error">Error al cargar calendario: ${error.message}</div>`;
            }
        }
        
        function selectCalendarPeriod(periodKey) {
            selectedPeriod = periodKey;
            const period = calendarPeriods.find(p => p.period_key === periodKey);
            if (!period) return;
            
            const sidePanel = document.getElementById('calendar-side-panel');
            const title = document.getElementById('side-panel-title');
            const content = document.getElementById('side-panel-content');
            
            title.textContent = formatMonth(periodKey);
            sidePanel.classList.remove('hidden');
            
            if (period.status === 'AVAILABLE') {
                content.innerHTML = `
                    <div>
                        <p><strong>Estado:</strong> <span class="badge badge-ok">OK</span></p>
                        <p style="margin-top: 12px;"><strong>Documento:</strong> ${period.doc_file_name || period.doc_id?.substring(0, 8) || 'N/A'}</p>
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="viewDocument('${period.doc_id}')">Ver</button>
                            <button class="btn btn-secondary" onclick="replaceDocument('${period.period_key}')">Reemplazar (conservar hist√≥rico)</button>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div>
                        <p><strong>Estado:</strong> <span class="badge ${getStatusBadgeClass(period.status)}">${formatStatus(period.status)}</span></p>
                        ${period.status === 'LATE' ? `<p style="margin-top: 8px; color: #fca5a5;">Tard√≠o: ${period.days_late} d√≠as</p>` : ''}
                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary btn-lg" onclick="uploadForCalendarPeriod('${period.period_key}')">
                                Subir este documento para ${formatMonth(periodKey)}
                            </button>
                        </div>
                    </div>
                `;
            }
            
            updateCalendar(); // Re-render to show selected state
        }
        
        function closeCalendarSidePanel() {
            document.getElementById('calendar-side-panel').classList.add('hidden');
            selectedPeriod = null;
            updateCalendar();
        }
        
        function uploadForCalendarPeriod(periodKey) {
            navigateTo('subir');
            window.uploadPrefill = {
                type_id: selectedType.type_id,
                [selectedType.scope === 'worker' ? 'person_key' : 'company_key']: selectedSubject.key,
                period_key: periodKey
            };
        }
        
        function viewDocument(docId) {
            // TODO: Navigate to document detail
            alert(`Ver documento ${docId}`);
        }
        
        function replaceDocument(periodKey) {
            uploadForCalendarPeriod(periodKey);
        }
        
        // Subir documentos - Wizard guiado
        let uploadFiles = [];
        let uploadTypes = [];
        let uploadPeople = [];
        
        async function loadSubir() {
            const content = document.getElementById('page-content');
            
            try {
                [uploadTypes, uploadPeople] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}))
                ]);
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Subir documentos</h3>
                        <p style="color: #94a3b8; margin-bottom: 24px;">Arrastra archivos PDF aqu√≠ o haz clic para seleccionar</p>
                        <div class="upload-zone" id="upload-zone">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üì§</div>
                            <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu√≠</p>
                            <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
                            <input type="file" id="file-input" multiple accept=".pdf" style="display: none;">
                        </div>
                        <div id="upload-files-list"></div>
                        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="clearAllUploadFiles()">Limpiar todo</button>
                            <button class="btn btn-primary btn-lg" onclick="saveAllUploadFiles()">Guardar todo</button>
                        </div>
                    </div>
                    
                    <!-- Duplicate modal -->
                    <div id="upload-duplicate-modal" class="modal-overlay hidden">
                        <div class="modal">
                            <div class="modal-header">
                                <h3>Documento duplicado</h3>
                            </div>
                            <p id="duplicate-modal-message"></p>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeDuplicateModal()">Cancelar</button>
                                <button class="btn btn-secondary" onclick="saveAsVersion()">Guardar como versi√≥n adicional</button>
                                <button class="btn btn-primary" onclick="confirmReplace()">Reemplazar (conservar hist√≥rico)</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Setup drag & drop
                const uploadZone = document.getElementById('upload-zone');
                const fileInput = document.getElementById('file-input');
                
                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    handleUploadFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => {
                    handleUploadFiles(e.target.files);
                });
                
                // Apply prefill if available
                if (window.uploadPrefill) {
                    // Will be applied when files are added
                }
                
                renderUploadFiles();
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar subir: ${error.message}</div>`;
            }
        }
        
        function handleUploadFiles(files) {
            for (let file of files) {
                if (file.type !== 'application/pdf') {
                    alert(`El archivo ${file.name} no es un PDF`);
                    continue;
                }
                
                const fileData = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    type_id: '',
                    subject_key: '',
                    subject_name: '',
                    scope: '',
                    company_key: 'F63161988',
                    person_key: '',
                    period_key: '',
                    issue_date: '',
                    detected: {},
                    errors: {}
                };
                
                // Auto-detect from filename
                detectUploadMetadata(fileData);
                
                // Apply prefill if available
                if (window.uploadPrefill) {
                    const prefill = window.uploadPrefill;
                    if (prefill.type_id) {
                        fileData.type_id = prefill.type_id;
                        const type = uploadTypes.find(t => t.type_id === prefill.type_id);
                        if (type) fileData.scope = type.scope;
                    }
                    if (prefill.person_key) {
                        fileData.person_key = prefill.person_key;
                        const person = (uploadPeople.people || []).find(p => p.worker_id === prefill.person_key);
                        if (person) fileData.subject_name = person.full_name;
                    }
                    if (prefill.company_key) {
                        fileData.company_key = prefill.company_key;
                    }
                    if (prefill.period_key) {
                        fileData.period_key = prefill.period_key;
                    }
                    delete window.uploadPrefill;
                }
                
                uploadFiles.push(fileData);
            }
            renderUploadFiles();
        }
        
        function detectUploadMetadata(fileData) {
            const filename = fileData.name.toLowerCase();
            
            // Detect type
            for (const type of uploadTypes) {
                for (const alias of type.platform_aliases || []) {
                    if (filename.includes(alias.toLowerCase())) {
                        fileData.detected.type_id = type.type_id;
                        fileData.detected.scope = type.scope;
                        break;
                    }
                }
                if (fileData.detected.type_id) break;
            }
            
            // Detect person
            for (const person of uploadPeople.people || []) {
                const nameParts = person.full_name.toLowerCase().split(' ');
                if (nameParts.some(part => filename.includes(part))) {
                    fileData.detected.person_key = person.worker_id;
                    break;
                }
            }
            
            // Detect period (YYYY-MM)
            const periodMatch = filename.match(/(\d{4})-(\d{2})/);
            if (periodMatch) {
                fileData.detected.period_key = `${periodMatch[1]}-${periodMatch[2]}`;
            }
            
            // Apply detected
            if (fileData.detected.type_id && !fileData.type_id) {
                fileData.type_id = fileData.detected.type_id;
                const type = uploadTypes.find(t => t.type_id === fileData.type_id);
                if (type) fileData.scope = type.scope;
            }
            if (fileData.detected.person_key && !fileData.person_key) {
                fileData.person_key = fileData.detected.person_key;
                const person = (uploadPeople.people || []).find(p => p.worker_id === fileData.person_key);
                if (person) fileData.subject_name = person.full_name;
            }
            if (fileData.detected.period_key && !fileData.period_key) {
                fileData.period_key = fileData.detected.period_key;
            }
        }
        
        function renderUploadFiles() {
            const list = document.getElementById('upload-files-list');
            if (!list) return;
            
            if (uploadFiles.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = uploadFiles.map(file => {
                const type = uploadTypes.find(t => t.type_id === file.type_id);
                const periodKind = type?.validity_policy?.mode || 'none';
                const needsPeriod = periodKind === 'monthly' || periodKind === 'annual' || periodKind === 'quarter';
                
                // Validation
                const errors = [];
                if (!file.type_id) errors.push('El documento es obligatorio');
                if (file.scope === 'worker' && !file.person_key) errors.push('El trabajador es obligatorio');
                if (file.scope === 'company' && !file.company_key) errors.push('La empresa es obligatoria');
                if (needsPeriod && !file.period_key) {
                    errors.push(`El ${periodKind === 'monthly' ? 'mes' : 'a√±o'} es obligatorio`);
                }
                
                file.errors = errors;
                
                return `
                    <div class="file-card">
                        <h4>${file.name}</h4>
                        <div class="wizard-question">
                            <label class="form-label">1. ¬øQu√© documento es? ${file.detected.type_id ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                            <div class="autocomplete-container">
                                <input type="text" class="form-input" 
                                       value="${type ? type.name : file.type_id}" 
                                       placeholder="Buscar documento..."
                                       oninput="searchUploadType('${file.id}', this.value)"
                                       onfocus="searchUploadType('${file.id}', this.value)">
                                <div class="autocomplete-dropdown hidden" id="upload-type-dropdown-${file.id}"></div>
                            </div>
                            ${errors.includes('El documento es obligatorio') ? '<div class="form-error">El documento es obligatorio</div>' : ''}
                            ${type ? `<div class="form-help">ID: ${type.type_id}</div>` : ''}
                        </div>
                        ${file.scope ? `
                            <div class="wizard-question">
                                <label class="form-label">2. ¬øDe qui√©n / empresa? ${file.detected.person_key ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                                ${file.scope === 'worker' ? `
                                    <div class="autocomplete-container">
                                        <input type="text" class="form-input" 
                                               value="${file.subject_name || ''}" 
                                               placeholder="Buscar trabajador..."
                                               oninput="searchUploadPerson('${file.id}', this.value)"
                                               onfocus="searchUploadPerson('${file.id}', this.value)">
                                        <div class="autocomplete-dropdown hidden" id="upload-person-dropdown-${file.id}"></div>
                                    </div>
                                    ${errors.includes('El trabajador es obligatorio') ? '<div class="form-error">El trabajador es obligatorio</div>' : ''}
                                ` : `
                                    <input type="text" class="form-input" 
                                           value="${file.company_key}" 
                                           placeholder="Empresa..."
                                           onchange="updateUploadCompany('${file.id}', this.value)">
                                    ${errors.includes('La empresa es obligatoria') ? '<div class="form-error">La empresa es obligatoria</div>' : ''}
                                `}
                            </div>
                        ` : ''}
                        ${needsPeriod ? `
                            <div class="wizard-question">
                                <label class="form-label">3. ¬øDe qu√© ${periodKind === 'monthly' ? 'mes/a√±o' : 'a√±o'}? ${file.detected.period_key ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                                ${periodKind === 'monthly' ? `
                                    <input type="month" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : periodKind === 'annual' ? `
                                    <input type="number" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           placeholder="YYYY"
                                           min="2000" max="2100"
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : ''}
                                ${errors.some(e => e.includes('obligatorio')) ? `<div class="form-error">El ${periodKind === 'monthly' ? 'mes' : 'a√±o'} es obligatorio</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="wizard-question">
                            <label class="form-label">4. (Opcional) Fecha de emisi√≥n</label>
                            <input type="date" class="form-input" 
                                   value="${file.issue_date || ''}" 
                                   onchange="updateUploadIssueDate('${file.id}', this.value)">
                        </div>
                        ${errors.length > 0 ? `<div class="alert alert-error">${errors.join(', ')}</div>` : ''}
                        <div style="margin-top: 16px;">
                            <button class="btn btn-secondary" onclick="removeUploadFile('${file.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function searchUploadType(fileId, query) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            const dropdown = document.getElementById(`upload-type-dropdown-${fileId}`);
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = uploadTypes.filter(t => 
                t.name.toLowerCase().includes(query.toLowerCase()) ||
                t.type_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(t => `
                <div class="autocomplete-item" onclick="selectUploadType('${fileId}', '${t.type_id}')">
                    ${t.name} <span style="color: #94a3b8;">(${t.type_id})</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectUploadType(fileId, typeId) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.type_id = typeId;
            const type = uploadTypes.find(t => t.type_id === typeId);
            if (type) {
                file.scope = type.scope;
            }
            
            document.getElementById(`upload-type-dropdown-${fileId}`).classList.add('hidden');
            renderUploadFiles();
        }
        
        function searchUploadPerson(fileId, query) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            const dropdown = document.getElementById(`upload-person-dropdown-${fileId}`);
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = (uploadPeople.people || []).filter(p => 
                p.full_name.toLowerCase().includes(query.toLowerCase()) ||
                p.worker_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(p => `
                <div class="autocomplete-item" onclick="selectUploadPerson('${fileId}', '${p.worker_id}', '${p.full_name}')">
                    ${p.full_name}
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectUploadPerson(fileId, personKey, personName) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.person_key = personKey;
            file.subject_key = personKey;
            file.subject_name = personName;
            document.getElementById(`upload-person-dropdown-${fileId}`).classList.add('hidden');
            renderUploadFiles();
        }
        
        function updateUploadCompany(fileId, companyKey) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.company_key = companyKey;
            file.subject_key = companyKey;
            renderUploadFiles();
        }
        
        function updateUploadPeriod(fileId, periodKey) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.period_key = periodKey;
            renderUploadFiles();
        }
        
        function updateUploadIssueDate(fileId, issueDate) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.issue_date = issueDate;
        }
        
        function removeUploadFile(fileId) {
            uploadFiles = uploadFiles.filter(f => f.id !== fileId);
            renderUploadFiles();
        }
        
        function clearAllUploadFiles() {
            if (confirm('¬øEliminar todos los archivos de la cola?')) {
                uploadFiles = [];
                renderUploadFiles();
            }
        }
        
        let duplicateModalData = null;
        
        async function saveAllUploadFiles() {
            // Validate
            const invalidFiles = uploadFiles.filter(f => f.errors && f.errors.length > 0);
            if (invalidFiles.length > 0) {
                alert(`Hay ${invalidFiles.length} archivo(s) con errores. Por favor, corr√≠gelos antes de guardar.`);
                return;
            }
            
            if (uploadFiles.length === 0) {
                alert('No hay archivos para guardar');
                return;
            }
            
            const savedDocs = [];
            const errors = [];
            
            for (const file of uploadFiles) {
                try {
                    // Check duplicate
                    const existing = await checkUploadDuplicate(file);
                    if (existing) {
                        duplicateModalData = { file, existing, action: null };
                        showDuplicateModal(file, existing);
                        await new Promise(resolve => {
                            const checkInterval = setInterval(() => {
                                if (duplicateModalData.action) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        });
                        
                        if (duplicateModalData.action === 'cancel') continue;
                        // If replace or version, continue
                    }
                    
                    // Upload
                    const formData = new FormData();
                    formData.append('file', file.file);
                    formData.append('type_id', file.type_id);
                    formData.append('scope', file.scope);
                    if (file.company_key) formData.append('company_key', file.company_key);
                    if (file.person_key) formData.append('person_key', file.person_key);
                    if (file.period_key) formData.append('period_key', file.period_key);
                    
                    const response = await fetch(`${BACKEND_URL}/api/repository/docs/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    
                    const doc = await response.json();
                    savedDocs.push(doc);
                    
                } catch (error) {
                    errors.push({ file: file.name, error: error.message });
                }
            }
            
            if (errors.length > 0) {
                alert(`Guardados: ${savedDocs.length}\nErrores: ${errors.length}\n\n${errors.map(e => `${e.file}: ${e.error}`).join('\n')}`);
            } else {
                alert(`¬°Guardados ${savedDocs.length} documento(s) exitosamente!`);
                uploadFiles = [];
                renderUploadFiles();
                navigateTo('calendario');
            }
        }
        
        async function checkUploadDuplicate(file) {
            const params = new URLSearchParams({ type_id: file.type_id });
            if (file.company_key) params.append('company_key', file.company_key);
            if (file.person_key) params.append('person_key', file.person_key);
            
            const response = await fetch(`${BACKEND_URL}/api/repository/docs?${params}`);
            const docs = await response.json();
            
            if (file.period_key) {
                const matching = docs.filter(d => d.period_key === file.period_key);
                return matching.length > 0 ? matching[0] : null;
            }
            
            return docs.length > 0 ? docs[0] : null;
        }
        
        function showDuplicateModal(file, existing) {
            const modal = document.getElementById('upload-duplicate-modal');
            const message = document.getElementById('duplicate-modal-message');
            const period = file.period_key ? formatMonth(file.period_key) : '';
            message.textContent = `Ya existe un documento para este tipo${period ? ` (${period})` : ''}. ¬øQu√© deseas hacer?`;
            modal.classList.remove('hidden');
        }
        
        function closeDuplicateModal() {
            if (duplicateModalData) {
                duplicateModalData.action = 'cancel';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        function saveAsVersion() {
            if (duplicateModalData) {
                duplicateModalData.action = 'version';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        function confirmReplace() {
            if (duplicateModalData) {
                duplicateModalData.action = 'replace';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        async function loadBuscar() {
            document.getElementById('page-content').innerHTML = '<div class="card"><h3>Buscar</h3><p>En desarrollo...</p></div>';
        }
        
        // Plataformas
        async function loadPlataformas() {
            const content = document.getElementById('page-content');
            
            try {
                const [rules, platforms, types] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json()).catch(() => ({platforms: []})),
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json())
                ]);
                
                const egestiona = platforms.platforms?.find(p => p.key === 'egestiona');
                const coords = egestiona?.coordinations || [];
                
                // Calculate status for each coord
                const coordStatuses = coords.map(coord => {
                    const hasCoordRule = rules.some(r => 
                        r.scope === 'COORD' && r.coord_label === coord.label && r.platform_key === 'egestiona'
                    );
                    const hasGlobalRule = rules.some(r => 
                        r.scope === 'GLOBAL' && r.platform_key === 'egestiona'
                    );
                    
                    let status = 'none';
                    let ruleType = 'ninguna';
                    if (hasCoordRule) {
                        status = 'ok';
                        ruleType = 'espec√≠fica';
                    } else if (hasGlobalRule) {
                        status = 'partial';
                        ruleType = 'general';
                    }
                    
                    return { coord, status, ruleType };
                });
                
                const covered = coordStatuses.filter(s => s.status !== 'none').length;
                const total = coords.length;
                
                // Overall platform status
                let platformStatus = 'none';
                if (covered === total && total > 0) {
                    platformStatus = 'ok';
                } else if (covered > 0) {
                    platformStatus = 'partial';
                }
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Plataformas</h3>
                        <div class="platform-card">
                            <h4 style="display: inline;">eGestiona</h4>
                            <span class="platform-status platform-status-${platformStatus}">
                                ${platformStatus === 'ok' ? 'Configurado' : platformStatus === 'partial' ? 'Parcial' : 'Sin configurar'}
                            </span>
                            <p style="margin-top: 8px; color: #94a3b8;">
                                Clientes cubiertos: ${covered}/${total}
                            </p>
                            ${platformStatus !== 'ok' ? `
                                <button class="btn btn-primary" onclick="createGlobalRules()" style="margin-top: 12px;">
                                    Crear configuraci√≥n general
                                </button>
                            ` : ''}
                        </div>
                        
                        <h3 style="margin-top: 24px;">Clientes</h3>
                        ${coordStatuses.map(({coord, status, ruleType}) => `
                            <div class="platform-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${coord.label}</strong>
                                        <span style="color: #94a3b8; margin-left: 12px;">Regla usada: ${ruleType}</span>
                                    </div>
                                    ${status === 'none' ? `
                                        <div>
                                            <span class="badge badge-falta" style="margin-right: 8px;">Sin regla</span>
                                            <button class="btn btn-secondary" onclick="fixCoordRule('${coord.label}')">Arreglar</button>
                                        </div>
                                    ` : status === 'partial' ? `
                                        <span class="badge badge-info">Usa regla general</span>
                                    ` : `
                                        <span class="badge badge-ok">Regla espec√≠fica</span>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar plataformas: ${error.message}</div>`;
            }
        }
        
        async function createGlobalRules() {
            if (!confirm('¬øCrear configuraci√≥n general para eGestiona? Esto crear√° reglas base para todos los tipos de documento.')) {
                return;
            }
            
            try {
                const [types, platforms] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json())
                ]);
                
                const existingRules = await fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []);
                const existingGlobalTypes = new Set(
                    existingRules.filter(r => r.scope === 'GLOBAL' && r.platform_key === 'egestiona')
                        .map(r => r.document_type_id)
                );
                
                let created = 0;
                for (const type of types) {
                    if (existingGlobalTypes.has(type.type_id)) continue;
                    
                    const rule = {
                        rule_id: `egestiona_global_${type.type_id.toLowerCase()}`,
                        scope: 'GLOBAL',
                        platform_key: 'egestiona',
                        coord_label: null,
                        enabled: true,
                        match: {
                            pending_text_contains: (type.platform_aliases || []).slice(0, 5),
                            empresa_contains: []
                        },
                        document_type_id: type.type_id,
                        form: {
                            upload_field_selector: "input[type='file']",
                            date_fields: {},
                            submit_button: { selector: null, by_text: null },
                            confirmation: { text_contains: [] }
                        }
                    };
                    
                    try {
                        await fetch(`${BACKEND_URL}/api/repository/rules`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(rule)
                        });
                        created++;
                    } catch (error) {
                        console.error(`Error creating rule for ${type.type_id}:`, error);
                    }
                }
                
                alert(`Creadas ${created} reglas generales`);
                loadPlataformas();
            } catch (error) {
                alert(`Error al crear configuraci√≥n general: ${error.message}`);
            }
        }
        
        function fixCoordRule(coordLabel) {
            // TODO: Implement coord-specific rule creation
            alert(`Crear regla espec√≠fica para ${coordLabel} - En desarrollo`);
        }
        
        async function loadCatalogo() {
            document.getElementById('page-content').innerHTML = '<div class="card"><h3>Cat√°logo</h3><p>En desarrollo...</p></div>';
        }
        
        async function loadActividad() {
            document.getElementById('page-content').innerHTML = '<div class="card"><h3>Actividad</h3><p>En desarrollo...</p></div>';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInicio();
        });
    </script>
</body>
</html>

