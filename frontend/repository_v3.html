<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Documental - CometLocal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Version stamp */
        .version-stamp {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            font-family: monospace;
            color: #60a5fa;
            z-index: 10000;
            pointer-events: none;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
        }
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3b82f6;
        }
        .sidebar-header p {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #334155;
            color: #fff;
        }
        .nav-item.active {
            background: #1e3a8a;
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
        }
        .nav-item-icon {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
            background: #1e293b;
        }
        .content-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .content-header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        /* Cards */
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }
        .kpi-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .kpi-card-title {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .kpi-card-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        .kpi-card-subtitle {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #475569;
            color: white;
        }
        .btn-secondary:hover {
            background: #334155;
        }
        .btn-lg {
            padding: 14px 28px;
            font-size: 1.1rem;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            max-height: calc(100vh - 400px); /* Aprovechar mejor el espacio vertical */
            overflow-y: auto;
            position: relative;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        th {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        td {
            color: #e2e8f0;
        }
        tr:hover {
            background: #1e293b;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-ok {
            background: #10b981;
            color: white;
        }
        .badge-falta {
            background: #f59e0b;
            color: white;
        }
        .badge-tarde {
            background: #ef4444;
            color: white;
        }
        .badge-info {
            background: #3b82f6;
            color: white;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.95rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-help {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        .form-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }
        .alert-warning {
            background: #78350f;
            border: 1px solid #f59e0b;
            color: #fcd34d;
        }
        .alert-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .calendar-month {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-month:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .calendar-month.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        .calendar-month-header {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .calendar-month-status {
            margin-bottom: 8px;
        }
        .calendar-month-action {
            margin-top: 8px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }
        .modal-header {
            margin-bottom: 16px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        /* Platform Status */
        .platform-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .platform-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 12px;
        }
        .platform-status-ok {
            background: #10b981;
            color: white;
        }
        .platform-status-partial {
            background: #f59e0b;
            color: white;
        }
        .platform-status-none {
            background: #ef4444;
            color: white;
        }
        
        /* Upload Wizard */
        .upload-zone {
            border: 2px dashed #334155;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #1e293b;
            transition: all 0.2s;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        .file-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: visible; /* Allow dropdown to overflow */
        }
        .file-card h4 {
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        .wizard-question {
            margin-bottom: 20px;
            position: relative;
            overflow: visible; /* Allow dropdown to overflow */
        }
        
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000; /* Very high z-index to ensure visibility */
            margin-top: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .autocomplete-dropdown.hidden {
            display: none !important;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background: #334155;
        }
        .form-required {
            color: #ef4444;
            margin-left: 4px;
        }
        
        /* Catalog v4 specific styles */
        .catalog-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .filter-chip {
            display: inline-block;
            padding: 6px 12px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 16px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .filter-chip.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .filter-chip:hover {
            background: #475569;
        }
        .catalog-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .catalog-results-info {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .catalog-table {
            width: 100%;
        }
        .catalog-table th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #1e293b;
            padding: 12px;
        }
        .catalog-table td {
            padding: 10px 12px; /* Reducir padding para mostrar m√°s filas */
        }
        .action-menu {
            position: relative;
        }
        .action-menu-button {
            background: none;
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1.2rem;
        }
        .action-menu-dropdown {
            position: fixed; /* Cambiar a fixed para que no se corte */
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            min-width: 200px;
            z-index: 1000; /* Aumentar z-index para que est√© por encima */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }
        .action-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #334155;
        }
        .action-menu-item:last-child {
            border-bottom: none;
        }
        .action-menu-item:hover {
            background: #334155;
        }
        .action-menu-item.danger {
            color: #ef4444;
        }
        .drawer {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 600px;
            max-width: 90vw;
            background: #1e293b;
            border-left: 1px solid #334155;
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-body {
            padding: 24px;
        }
        .drawer-footer {
            padding: 24px;
            border-top: 1px solid #334155;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .chip-editor {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            min-height: 60px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: #334155;
            border-radius: 16px;
            font-size: 0.875rem;
        }
        .chip-remove {
            margin-left: 8px;
            cursor: pointer;
            color: #94a3b8;
        }
        .chip-remove:hover {
            color: #ef4444;
        }
        .checkbox-cell {
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Version stamp -->
    <div class="version-stamp">UI build: upload-autocomplete-v1 <span id="build-timestamp"></span></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Repositorio</h1>
            <p>Documental</p>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" data-page="inicio">
                <span class="nav-item-icon">üè†</span>
                Inicio
            </a>
            <a class="nav-item" data-page="calendario">
                <span class="nav-item-icon">üìÖ</span>
                Calendario de documentos
            </a>
            <a class="nav-item" data-page="subir">
                <span class="nav-item-icon">üì§</span>
                Subir documentos
            </a>
            <a class="nav-item" data-page="buscar">
                <span class="nav-item-icon">üîç</span>
                Buscar documentos
            </a>
            <a class="nav-item" data-page="plataformas">
                <span class="nav-item-icon">üåê</span>
                Plataformas
            </a>
            <a class="nav-item" data-page="catalogo">
                <span class="nav-item-icon">üìö</span>
                Cat√°logo de documentos
            </a>
            <a class="nav-item" data-page="configuracion">
                <span class="nav-item-icon">‚öôÔ∏è</span>
                Configuraci√≥n
            </a>
            <a class="nav-item" data-page="actividad">
                <span class="nav-item-icon">üìú</span>
                Actividad
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <h2 id="page-title">Inicio</h2>
            <p id="page-description">Vista general del repositorio</p>
        </div>
        <div class="content-body" id="page-content">
            <div class="loading">Cargando...</div>
        </div>
    </div>
    
    <script>
        const BACKEND_URL = 'http://127.0.0.1:8000';
        let currentPage = 'inicio';
        
        // Spanish month names
        const MONTHS_ES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // Human-friendly status labels
        const STATUS_LABELS = {
            'AVAILABLE': 'OK',
            'MISSING': 'Falta',
            'LATE': 'Tarde'
        };
        
        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                navigateTo(page);
            });
        });
        
        function navigateTo(page, params = {}) {
            dbg('navigateTo:', { page, params });
            currentPage = page;
            
            // Update hash with params (only if different to avoid unnecessary hashchange)
            const hash = buildHashRoute(page, params);
            const currentHash = window.location.hash;
            if (hash && currentHash !== hash) {
                dbg('Updating hash from', currentHash, 'to', hash);
                window.location.hash = hash;
                // If hash changed, hashchange event will trigger, so don't call loadPage here
                // But if hash didn't change (same route/params), we need to load manually
                if (currentHash === hash) {
                    dbg('Hash unchanged, loading page directly');
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
                    loadPage(page, params);
                } else {
                    dbg('Hash changed, hashchange will handle it');
                    // Hash will change, hashchange will handle it
                    // Update active nav immediately for better UX
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.page === page);
                    });
                }
            } else {
                dbg('No hash change needed');
                // No hash change needed, just update nav and load
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.page === page);
                });
                loadPage(page, params);
            }
        }
        
        // Debug instrumentation
        function isDebugMode() {
            const { params } = parseHashRoute();
            return params.debug === '1' || window.__REPO_DEBUG__ === true;
        }
        
        function dbg(...args) {
            if (isDebugMode()) {
                console.log('[repo-prefill]', ...args);
            }
        }
        
        let debugOverlay = null;
        function updateDebugOverlay(route, applied, reason) {
            if (!isDebugMode()) return;
            
            if (!debugOverlay) {
                debugOverlay = document.createElement('div');
                debugOverlay.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 8px 12px; border-radius: 4px; font-family: monospace; font-size: 11px; z-index: 10000; border: 1px solid #0f0;';
                document.body.appendChild(debugOverlay);
            }
            
            debugOverlay.innerHTML = `
                <div><strong>Route:</strong> ${route || 'none'}</div>
                <div><strong>Applied:</strong> ${applied ? '‚úÖ' : '‚ùå'}</div>
                <div><strong>Reason:</strong> ${reason || '-'}</div>
            `;
        }
        
        // Deterministic barriers
        async function ensureRepoDataLoaded(neededData = {}) {
            const needsTypes = neededData.types !== false;
            const needsPeople = neededData.people !== false;
            
            dbg('ensureRepoDataLoaded: start', { needsTypes, needsPeople });
            
            const promises = [];
            
            if (needsTypes && calendarTypes.length === 0 && uploadTypes.length === 0 && catalogTypes.length === 0) {
                dbg('Loading types...');
                promises.push(
                    fetch(`${BACKEND_URL}/api/repository/types`)
                        .then(r => r.json())
                        .then(types => {
                            calendarTypes = types;
                            uploadTypes = types;
                            catalogTypes = types;
                            dbg('Types loaded:', types.length);
                        })
                );
            }
            
            if (needsPeople && (calendarPeople.length === 0 || (typeof calendarPeople === 'object' && !Array.isArray(calendarPeople)))) {
                dbg('Loading people...');
                promises.push(
                    fetch(`${BACKEND_URL}/api/config/people`)
                        .then(r => r.json())
                        .catch(() => ({people: []}))
                        .then(data => {
                            const peopleList = data.people || [];
                            calendarPeople = peopleList;
                            uploadPeople = peopleList;
                            dbg('People loaded:', calendarPeople.length);
                        })
                );
            }
            
            if (promises.length > 0) {
                await Promise.all(promises);
            }
            
            dbg('ensureRepoDataLoaded: done', {
                typesCount: calendarTypes.length || uploadTypes.length || catalogTypes.length,
                peopleCount: calendarPeople.length || uploadPeople.length
            });
        }
        
        async function waitForElement(selector, timeoutMs = 2000) {
            dbg('waitForElement: start', selector, 'timeout:', timeoutMs);
            const startTime = Date.now();
            
            while (Date.now() - startTime < timeoutMs) {
                const element = document.querySelector(selector);
                if (element) {
                    dbg('waitForElement: found', selector);
                    return element;
                }
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            dbg('waitForElement: timeout', selector);
            return null;
        }
        
        // Hash routing helpers
        function parseHashRoute() {
            const hash = window.location.hash.replace('#', '');
            if (!hash) return { route: null, params: {} };
            
            const [route, queryString] = hash.split('?');
            const params = {};
            
            if (queryString) {
                const pairs = queryString.split('&');
                for (const pair of pairs) {
                    const [key, value] = pair.split('=');
                    if (key && value) {
                        params[decodeURIComponent(key)] = decodeURIComponent(value);
                    }
                }
            }
            
            return { route, params };
        }
        
        function buildHashRoute(route, params = {}) {
            if (!route) return '';
            const paramPairs = Object.entries(params)
                .filter(([key, value]) => key && value)
                .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
            
            if (paramPairs.length === 0) {
                return `#${route}`;
            }
            return `#${route}?${paramPairs.join('&')}`;
        }
        
        // Handle hash routing
        window.addEventListener('hashchange', async () => {
            const { route, params } = parseHashRoute();
            dbg('hashchange event', { route, params });
            
                if (route && ['inicio', 'calendario', 'subir', 'buscar', 'plataformas', 'catalogo', 'configuracion', 'actividad'].includes(route)) {
                    // Update current page and nav without changing hash (to avoid loop)
                    currentPage = route;
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.page === route);
                });
                await loadPage(route, params);
            }
        });
        
        // Check initial hash - wait for DOM to be ready
        async function initHashRouting() {
            const { route, params } = parseHashRoute();
            dbg('initHashRouting: start', { route, params });
            
            if (route && ['inicio', 'calendario', 'subir', 'buscar', 'plataformas', 'catalogo', 'actividad'].includes(route)) {
                // Don't update hash if it's already correct to avoid triggering hashchange
                const expectedHash = buildHashRoute(route, params);
                if (window.location.hash !== expectedHash) {
                    dbg('Updating hash from', window.location.hash, 'to', expectedHash);
                    window.location.hash = expectedHash;
                } else {
                    dbg('Hash already correct, skipping update');
                }
                
                // Wait for DOM to be ready using deterministic barrier
                const navItems = await waitForElement('.nav-item', 2000);
                if (navItems) {
                    dbg('DOM ready, loading page');
                    currentPage = route;
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.page === route);
                    });
                    await loadPage(route, params);
                } else {
                    dbg('DOM not ready after timeout, retrying...');
                    setTimeout(initHashRouting, 50);
                }
            } else {
                dbg('No valid route in hash');
            }
        }
        
        // Initialize hash routing when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHashRouting);
        } else {
            // DOM already loaded
            setTimeout(initHashRouting, 0);
        }
        
        // Helper para escapar HTML (si no existe)
        if (typeof escapeHtml === 'undefined') {
            window.escapeHtml = function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
        }
        
        // Helper para mostrar error visible
        function showErrorBanner(message, error = null) {
            const content = document.getElementById('page-content');
            if (!content) return;
            const escape = window.escapeHtml || ((t) => String(t).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'));
            const errorHtml = `
                <div class="alert alert-error" style="padding: 16px; margin: 16px 0; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b;">
                    <strong>Error cargando repositorio</strong>
                    <p style="margin: 8px 0 0 0;">${escape(message)}</p>
                    ${error ? `<pre style="margin-top: 8px; font-size: 0.85rem; overflow-x: auto;">${escape(error.stack || error.toString())}</pre>` : ''}
                    <p style="margin-top: 8px; font-size: 0.9rem;">Ver consola del navegador para m√°s detalles.</p>
                </div>
            `;
            content.innerHTML = errorHtml;
        }
        
        async function loadPage(page, params = {}) {
            dbg('loadPage: start', { page, params });
            const content = document.getElementById('page-content');
            if (!content) {
                dbg('loadPage: page-content not found!');
                return;
            }
            content.innerHTML = '<div class="loading">Cargando...</div>';
            
            const titles = {
                inicio: 'Inicio',
                calendario: 'Calendario de documentos',
                subir: 'Subir documentos',
                buscar: 'Buscar documentos',
                plataformas: 'Plataformas',
                catalogo: 'Cat√°logo de documentos',
                actividad: 'Actividad'
            };
            
            const descriptions = {
                inicio: 'Vista general del repositorio',
                calendario: 'Visualiza qu√© documentos faltan por mes',
                subir: 'Sube documentos al repositorio',
                buscar: 'Busca documentos en el repositorio',
                plataformas: 'Estado de configuraci√≥n de plataformas',
                catalogo: 'Gestiona tipos de documento',
                actividad: 'Historial de actividad'
            };
            
            document.getElementById('page-title').textContent = titles[page] || page;
            document.getElementById('page-description').textContent = descriptions[page] || '';
            
            // Timeout de seguridad (10 segundos)
            const timeoutId = setTimeout(() => {
                showErrorBanner(`La carga de la p√°gina "${page}" est√° tardando demasiado. Puede haber un problema de conexi√≥n o un error en el c√≥digo.`);
            }, 10000);
            
            try {
            switch(page) {
                case 'inicio':
                        await loadInicio(params);
                    break;
                case 'calendario':
                    await loadCalendario(params);
                    break;
                case 'subir':
                    await loadSubir(params);
                    break;
                case 'buscar':
                    await loadBuscar(params);
                    break;
                case 'plataformas':
                    await loadPlataformas(params);
                    break;
                case 'catalogo':
                    await loadCatalogo(params);
                    break;
                case 'configuracion':
                    loadConfiguracion();
                    break;
                case 'actividad':
                    await loadActividad(params);
                    break;
                }
                clearTimeout(timeoutId);
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('[repo] Error loading page:', error);
                showErrorBanner(`Error al cargar la p√°gina "${page}": ${error.message}`, error);
            }
        }
        
        // Utility functions
        function formatMonth(periodKey) {
            if (!periodKey) return '';
            const match = periodKey.match(/(\d{4})-(\d{2})/);
            if (match) {
                const year = match[1];
                const month = parseInt(match[2]) - 1;
                return `${MONTHS_ES[month]} ${year}`;
            }
            return periodKey;
        }
        
        function formatStatus(status) {
            return STATUS_LABELS[status] || status;
        }
        
        function getStatusBadgeClass(status) {
            if (status === 'AVAILABLE') return 'badge-ok';
            if (status === 'MISSING') return 'badge-falta';
            if (status === 'LATE') return 'badge-tarde';
            return 'badge-info';
        }
        
        // Inicio
        async function loadInicio(params = {}) {
            const content = document.getElementById('page-content');
            if (!content) {
                console.error('[repo] loadInicio: page-content not found');
                return;
            }
            
            try {
                const [types, docs, rules, platforms] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        return r.json();
                    }),
                    fetch(`${BACKEND_URL}/api/repository/docs`).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        return r.json();
                    }),
                    fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json()).catch(() => ({platforms: []}))
                ]);
                
                // Calculate KPIs
                const periodicTypes = types.filter(t => {
                    const mode = t.validity_policy?.mode;
                    return mode === 'monthly' || mode === 'annual' || mode === 'quarter';
                });
                
                // Count missing this month (simplified)
                const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                const missingThisMonth = 0; // TODO: Calculate from expected periods
                
                // Count expiring soon (next 30 days)
                const expiringSoon = docs.filter(d => {
                    if (!d.computed_validity?.valid_to) return false;
                    const validTo = new Date(d.computed_validity.valid_to);
                    const now = new Date();
                    const daysDiff = (validTo - now) / (1000 * 60 * 60 * 24);
                    return daysDiff > 0 && daysDiff <= 30;
                }).length;
                
                // Count platforms without rules
                const egestiona = platforms.platforms?.find(p => p.key === 'egestiona');
                const coords = egestiona?.coordinations || [];
                const coordsWithoutRules = coords.filter(coord => {
                    const hasRule = rules.some(r => 
                        (r.scope === 'COORD' && r.coord_label === coord.label) ||
                        (r.scope === 'GLOBAL' && r.platform_key === 'egestiona')
                    );
                    return !hasRule;
                }).length;
                
                // Recent uploads (last 5)
                const recentDocs = docs
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);
                
                // Quick actions (missing documents)
                const quickActions = []; // TODO: Generate from expected periods
                
                content.innerHTML = `
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-card-title">Faltan este mes</div>
                            <div class="kpi-card-value">${missingThisMonth}</div>
                            <div class="kpi-card-subtitle">Documentos pendientes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">A punto de caducar</div>
                            <div class="kpi-card-value">${expiringSoon}</div>
                            <div class="kpi-card-subtitle">Pr√≥ximos 30 d√≠as</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Plataformas sin configurar</div>
                            <div class="kpi-card-value">${coordsWithoutRules}</div>
                            <div class="kpi-card-subtitle">Clientes sin reglas</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Documentos</div>
                            <div class="kpi-card-value">${docs.length}</div>
                            <div class="kpi-card-subtitle">En el repositorio</div>
                        </div>
                    </div>
                    
                    ${quickActions.length > 0 ? `
                        <div class="card">
                            <h3>Acciones r√°pidas</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>De qui√©n</th>
                                            <th>Mes</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${quickActions.map(action => `
                                            <tr>
                                                <td>${action.typeName}</td>
                                                <td>${action.subjectName}</td>
                                                <td>${formatMonth(action.periodKey)}</td>
                                                <td>
                                                    <button class="btn btn-primary" onclick="uploadQuickAction('${action.typeId}', '${action.subjectKey}', '${action.scope}', '${action.periodKey}')">
                                                        Subir
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <h3>Subidas recientes</h3>
                        ${recentDocs.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>De qui√©n</th>
                                            <th>Mes</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${recentDocs.map(doc => {
                                            const type = types.find(t => t.type_id === doc.type_id);
                                            const period = doc.period_key ? formatMonth(doc.period_key) : '-';
                                            return `
                                                <tr>
                                                    <td>${type ? type.name : doc.type_id}</td>
                                                    <td>${doc.person_key || doc.company_key || '-'}</td>
                                                    <td>${period}</td>
                                                    <td>${new Date(doc.created_at).toLocaleDateString('es-ES')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #94a3b8;">No hay documentos recientes</p>'}
                    </div>
                `;
            } catch (error) {
                console.error('[repo] Error in loadInicio:', error);
                showErrorBanner(`Error al cargar inicio: ${error.message}`, error);
            }
        }
        
        function uploadQuickAction(typeId, subjectKey, scope, periodKey) {
            navigateTo('subir');
            window.uploadPrefill = {
                type_id: typeId,
                [scope === 'worker' ? 'person_key' : 'company_key']: subjectKey,
                period_key: periodKey
            };
        }
        
        // Calendario
        let calendarTypes = [];
        let calendarPeople = [];
        let selectedType = null;
        let selectedSubject = null;
        let selectedMonths = 24;
        let calendarPeriods = [];
        let selectedPeriod = null;
        
        async function loadCalendario(params = {}) {
            dbg('loadCalendario: start', params);
            const content = document.getElementById('page-content');
            
            // Ensure data is loaded
            await ensureRepoDataLoaded({ types: true, people: true });
            
            try {
                // Load data if not already loaded
                if (calendarTypes.length === 0) {
                    calendarTypes = await fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json());
                }
                if (calendarPeople.length === 0) {
                    const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
                    calendarPeople = peopleData.people || [];
                }
                
                const periodicTypes = calendarTypes.filter(t => {
                    const mode = t.validity_policy?.mode;
                    return mode === 'monthly' || mode === 'annual' || mode === 'quarter';
                });
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Calendario de documentos</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">¬øQu√© documento?</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-input" 
                                           id="calendar-type-input"
                                           placeholder="Buscar documento..."
                                           oninput="searchCalendarType(this.value)"
                                           onfocus="searchCalendarType(this.value)">
                                    <div class="autocomplete-dropdown hidden" id="calendar-type-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group" id="calendar-subject-group" style="display: none;">
                                <label class="form-label" id="calendar-subject-label">¬øDe qui√©n / qu√© empresa?</label>
                                <div class="autocomplete-container">
                                    <input type="text" class="form-input" 
                                           id="calendar-subject-input"
                                           placeholder="Buscar..."
                                           oninput="searchCalendarSubject(this.value)"
                                           onfocus="searchCalendarSubject(this.value)">
                                    <div class="autocomplete-dropdown hidden" id="calendar-subject-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rango</label>
                                <select class="form-input" id="calendar-months" onchange="updateCalendarMonths()">
                                    <option value="12">√öltimos 12 meses</option>
                                    <option value="24" selected>√öltimos 24 meses</option>
                                    <option value="36">√öltimos 36 meses</option>
                                </select>
                            </div>
                        </div>
                        <div id="calendar-grid-container"></div>
                    </div>
                    
                    <!-- Side panel for selected month -->
                    <div id="calendar-side-panel" class="card hidden" style="position: fixed; right: 24px; top: 120px; width: 350px; max-height: 80vh; overflow-y: auto; z-index: 100;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 id="side-panel-title">Detalle del mes</h3>
                            <button class="btn btn-secondary" onclick="closeCalendarSidePanel()" style="padding: 4px 12px;">‚úï</button>
                        </div>
                        <div id="side-panel-content"></div>
                    </div>
                `;
                
                // Apply prefill from params using deterministic barriers
                if (params.type_id) {
                    dbg('Applying prefill for type_id:', params.type_id);
                    
                    // Wait for DOM element
                    const typeInput = await waitForElement('#calendar-type-input');
                    if (!typeInput) {
                        const reason = 'calendar-type-input element not found';
                        dbg('Prefill failed:', reason);
                        updateDebugOverlay('calendario', false, reason);
                        return;
                    }
                    
                    // Find type
                    const type = calendarTypes.find(t => t.type_id === params.type_id);
                    if (!type) {
                        const reason = `Type ${params.type_id} not found`;
                        dbg('Prefill failed:', reason);
                        updateDebugOverlay('calendario', false, reason);
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning';
                        alertDiv.innerHTML = `Tipo de documento "${params.type_id}" no encontrado. El calendario se ha cargado sin prefill.`;
                        const contentEl = document.getElementById('page-content');
                        if (contentEl) {
                            contentEl.insertBefore(alertDiv, contentEl.firstChild);
                        }
                        return;
                    }
                    
                    // Apply type selection
                    dbg('Selecting type:', type.type_id, type.name);
                    selectCalendarType(params.type_id);
                    
                    // If subject is provided, wait for subject input and select it
                    if (params.person_key || params.company_key) {
                        const subjectInput = await waitForElement('#calendar-subject-input');
                        if (subjectInput) {
                            const subjectKey = params.person_key || params.company_key;
                            let subjectName = subjectKey;
                            
                            if (params.person_key && type.scope === 'worker') {
                                const person = calendarPeople.find(p => p.worker_id === params.person_key);
                                if (person) {
                                    subjectName = person.full_name;
                                }
                            }
                            
                            dbg('Selecting subject:', subjectKey, subjectName);
                            selectCalendarSubject(subjectKey, subjectName);
                        } else {
                            dbg('Subject input not found, skipping subject prefill');
                        }
                    }
                    
                    dbg('Prefill applied successfully');
                    updateDebugOverlay('calendario', true, 'OK');
                } else {
                    updateDebugOverlay('calendario', false, 'No type_id in params');
                }
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar calendario: ${error.message}</div>`;
            }
        }
        
        function searchCalendarType(query) {
            const dropdown = document.getElementById('calendar-type-dropdown');
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = calendarTypes.filter(t => 
                t.name.toLowerCase().includes(query.toLowerCase()) ||
                t.type_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(t => `
                <div class="autocomplete-item" onclick="selectCalendarType('${t.type_id}')">
                    ${t.name} <span style="color: #94a3b8; font-size: 0.875rem;">(${t.type_id})</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectCalendarType(typeId) {
            selectedType = calendarTypes.find(t => t.type_id === typeId);
            document.getElementById('calendar-type-input').value = selectedType.name;
            document.getElementById('calendar-type-dropdown').classList.add('hidden');
            
            // Show subject selector
            const subjectGroup = document.getElementById('calendar-subject-group');
            const subjectLabel = document.getElementById('calendar-subject-label');
            
            if (selectedType.scope === 'worker') {
                subjectGroup.style.display = 'block';
                subjectLabel.textContent = '¬øDe qui√©n?';
            } else if (selectedType.scope === 'company') {
                subjectGroup.style.display = 'block';
                subjectLabel.textContent = '¬øDe qu√© empresa?';
            } else {
                subjectGroup.style.display = 'none';
            }
            
            updateCalendar();
        }
        
        function searchCalendarSubject(query) {
            const dropdown = document.getElementById('calendar-subject-dropdown');
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            if (selectedType?.scope === 'worker') {
                const matches = (calendarPeople.people || []).filter(p => 
                    p.full_name.toLowerCase().includes(query.toLowerCase()) ||
                    p.worker_id.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10);
                
                dropdown.innerHTML = matches.map(p => `
                    <div class="autocomplete-item" onclick="selectCalendarSubject('${p.worker_id}', '${p.full_name}')">
                        ${p.full_name}
                    </div>
                `).join('');
            }
            
            dropdown.classList.remove('hidden');
        }
        
        function selectCalendarSubject(subjectKey, subjectNameOrScope) {
            // If subjectNameOrScope is a scope, find the subject by key
            let subjectName = subjectNameOrScope;
            if (subjectNameOrScope === 'worker' || subjectNameOrScope === 'company') {
                const scope = subjectNameOrScope;
                if (scope === 'worker') {
                    const person = (calendarPeople.people || []).find(p => p.worker_id === subjectKey);
                    subjectName = person ? person.full_name : subjectKey;
                } else {
                    // For company, we might need to fetch companies or use the key as name
                    subjectName = subjectKey;
                }
            }
            
            selectedSubject = { key: subjectKey, name: subjectName };
            const input = document.getElementById('calendar-subject-input');
            if (input) {
                input.value = subjectName;
            }
            const dropdown = document.getElementById('calendar-subject-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            updateCalendar();
        }
        
        function updateCalendarMonths() {
            selectedMonths = parseInt(document.getElementById('calendar-months').value);
            updateCalendar();
        }
        
        async function updateCalendar() {
            if (!selectedType || !selectedSubject) {
                document.getElementById('calendar-grid-container').innerHTML = 
                    '<div class="alert alert-info">Selecciona un documento y un sujeto para ver el calendario</div>';
                return;
            }
            
            try {
                const params = new URLSearchParams({ months: selectedMonths });
                if (selectedType.scope === 'worker') {
                    params.append('person_key', selectedSubject.key);
                } else if (selectedType.scope === 'company') {
                    params.append('company_key', selectedSubject.key);
                }
                
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${selectedType.type_id}/expected?${params}`);
                calendarPeriods = await response.json();
                
                const container = document.getElementById('calendar-grid-container');
                container.innerHTML = `
                    <div class="calendar-grid">
                        ${calendarPeriods.map(p => {
                            const monthName = formatMonth(p.period_key);
                            const status = formatStatus(p.status);
                            const badgeClass = getStatusBadgeClass(p.status);
                            return `
                                <div class="calendar-month ${selectedPeriod === p.period_key ? 'selected' : ''}" 
                                     onclick="selectCalendarPeriod('${p.period_key}')">
                                    <div class="calendar-month-header">${monthName}</div>
                                    <div class="calendar-month-status">
                                        <span class="badge ${badgeClass}">${status}</span>
                                    </div>
                                    ${p.status !== 'AVAILABLE' ? `
                                        <div class="calendar-month-action">
                                            <button class="btn btn-primary" onclick="event.stopPropagation(); uploadForCalendarPeriod('${p.period_key}')">
                                                Subir
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('calendar-grid-container').innerHTML = 
                    `<div class="alert alert-error">Error al cargar calendario: ${error.message}</div>`;
            }
        }
        
        function selectCalendarPeriod(periodKey) {
            selectedPeriod = periodKey;
            const period = calendarPeriods.find(p => p.period_key === periodKey);
            if (!period) return;
            
            const sidePanel = document.getElementById('calendar-side-panel');
            const title = document.getElementById('side-panel-title');
            const content = document.getElementById('side-panel-content');
            
            title.textContent = formatMonth(periodKey);
            sidePanel.classList.remove('hidden');
            
            if (period.status === 'AVAILABLE') {
                content.innerHTML = `
                    <div>
                        <p><strong>Estado:</strong> <span class="badge badge-ok">OK</span></p>
                        <p style="margin-top: 12px;"><strong>Documento:</strong> ${period.doc_file_name || period.doc_id?.substring(0, 8) || 'N/A'}</p>
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="viewDocument('${period.doc_id}')">Ver</button>
                            <button class="btn btn-secondary" onclick="replaceDocument('${period.period_key}')">Reemplazar (conservar hist√≥rico)</button>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div>
                        <p><strong>Estado:</strong> <span class="badge ${getStatusBadgeClass(period.status)}">${formatStatus(period.status)}</span></p>
                        ${period.status === 'LATE' ? `<p style="margin-top: 8px; color: #fca5a5;">Tard√≠o: ${period.days_late} d√≠as</p>` : ''}
                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary btn-lg" onclick="uploadForCalendarPeriod('${period.period_key}')">
                                Subir este documento para ${formatMonth(periodKey)}
                            </button>
                        </div>
                    </div>
                `;
            }
            
            updateCalendar(); // Re-render to show selected state
        }
        
        function closeCalendarSidePanel() {
            document.getElementById('calendar-side-panel').classList.add('hidden');
            selectedPeriod = null;
            updateCalendar();
        }
        
        function uploadForCalendarPeriod(periodKey) {
            if (!selectedType || !selectedSubject) {
                alert('Debes seleccionar un documento y un sujeto primero');
                return;
            }
            
            const params = {
                type_id: selectedType.type_id,
                period_key: periodKey
            };
            
            if (selectedType.scope === 'worker') {
                params.person_key = selectedSubject.key;
            } else if (selectedType.scope === 'company') {
                params.company_key = selectedSubject.key;
            }
            
            navigateTo('subir', params);
        }
        
        function viewDocument(docId) {
            // Abrir PDF en nueva pesta√±a
            const url = `${BACKEND_URL}/api/repository/docs/${docId}/pdf`;
            window.open(url, '_blank');
        }
        
        function viewDocumentFromSearch(docId) {
            viewDocument(docId);
        }
        
        function resubmitDocumentFromSearch(docId, typeId, scope) {
            // Navegar a subir documentos con prefill para reemplazar
            const params = {
                type_id: typeId,
                scope: scope,
                replace_doc_id: docId
            };
            navigateTo('subir', params);
        }
        
        function replaceDocument(periodKey) {
            uploadForCalendarPeriod(periodKey);
        }
        
        // Subir documentos - Wizard guiado
        let uploadFiles = [];
        let uploadTypes = [];
        let uploadPeople = [];
        let uploadSubjects = {
            companies: [],
            workers_by_company: {}
        };
        
        // Helper para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadSubir(params = {}) {
            dbg('loadSubir: start', params);
            const content = document.getElementById('page-content');
            
            // Ensure data is loaded
            await ensureRepoDataLoaded({ types: true, people: true });
            
            try {
                // Load data if not already loaded - handle pagination if needed
                if (uploadTypes.length === 0) {
                    console.log('[repo-upload] Loading types...');
                    // Try to get all types (with large page_size or without pagination)
                    const response = await fetch(`${BACKEND_URL}/api/repository/types`);
                    const data = await response.json();
                    // Handle both array and paginated response
                    if (Array.isArray(data)) {
                        uploadTypes = data;
                    } else if (data.items && Array.isArray(data.items)) {
                        uploadTypes = data.items;
                        // If paginated and there are more pages, fetch them
                        if (data.total > data.items.length) {
                            console.log('[repo-upload] Fetching additional pages...');
                            const totalPages = Math.ceil(data.total / (data.page_size || 20));
                            for (let page = 2; page <= totalPages; page++) {
                                const pageResponse = await fetch(`${BACKEND_URL}/api/repository/types?page=${page}&page_size=${data.page_size || 20}`);
                                const pageData = await pageResponse.json();
                                if (pageData.items && Array.isArray(pageData.items)) {
                                    uploadTypes.push(...pageData.items);
                                }
                            }
                        }
                    } else {
                        uploadTypes = [];
                    }
                    console.log('[repo-upload] types loaded count:', uploadTypes.length);
                }
                const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
                uploadPeople = peopleData.people || [];
                
                // Validate type_id if provided
                if (params.type_id) {
                    const type = uploadTypes.find(t => t.type_id === params.type_id);
                    if (!type) {
                        const reason = `Type ${params.type_id} not found`;
                        dbg('Prefill failed:', reason);
                        updateDebugOverlay('subir', false, reason);
                        content.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>Advertencia:</strong> El tipo de documento "${params.type_id}" no existe.
                                Puedes continuar subiendo documentos normalmente.
                            </div>
                            <div class="card" style="margin-top: 16px;">
                                <h3>Subir documentos</h3>
                                <p style="color: #94a3b8; margin-bottom: 24px;">Arrastra archivos PDF aqu√≠ o haz clic para seleccionar</p>
                                <div class="upload-zone" id="upload-zone" data-testid="upload-dropzone">
                                    <div style="font-size: 3rem; margin-bottom: 16px;">üì§</div>
                                    <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu√≠</p>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
                                    <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-file-input">
                                </div>
                                <div id="upload-files-list"></div>
                                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                                    <button class="btn btn-secondary" onclick="clearAllUploadFiles()" data-testid="upload-clear-all">Limpiar todo</button>
                                    <button class="btn btn-primary btn-lg" onclick="saveAllUploadFiles()" data-testid="save-all">Guardar todo</button>
                                </div>
                            </div>
                            
                            <!-- Duplicate modal -->
                            <div id="upload-duplicate-modal" class="modal-overlay hidden">
                                <div class="modal">
                                    <div class="modal-header">
                                        <h3>Documento duplicado</h3>
                                    </div>
                                    <p id="duplicate-modal-message"></p>
                                    <div class="modal-actions">
                                        <button class="btn btn-secondary" onclick="closeDuplicateModal()">Cancelar</button>
                                        <button class="btn btn-secondary" onclick="saveAsVersion()">Guardar como versi√≥n adicional</button>
                                        <button class="btn btn-primary" onclick="confirmReplace()">Reemplazar (conservar hist√≥rico)</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preview modal -->
                            <div id="upload-preview-modal" class="modal-overlay hidden" data-testid="preview-modal" onclick="closePreviewModal()">
                                <div class="modal" onclick="event.stopPropagation()" style="max-width: 90vw; max-height: 90vh; width: 1000px; display: flex; flex-direction: column;">
                                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <h3 id="preview-modal-title">Previsualizar documento</h3>
                                        <button class="btn btn-secondary" onclick="closePreviewModal()" style="padding: 4px 12px;">‚úï</button>
                                    </div>
                                    <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                        <object id="preview-object" data-testid="preview-object" data="" type="application/pdf" style="width: 100%; height: 100%; min-height: 500px; border: 1px solid #334155; border-radius: 4px;">
                                            <div class="preview-fallback" style="text-align: center; padding: 24px;">
                                                <p style="margin-bottom: 16px; color: #94a3b8;">No se puede previsualizar embebido en este navegador.</p>
                                                <div style="display: flex; gap: 12px; justify-content: center;">
                                                    <a id="preview-fallback-link" href="#" target="_blank" rel="noopener" class="btn btn-primary">Abrir en nueva pesta√±a</a>
                                                    <button id="preview-download-btn" class="btn btn-secondary">Descargar</button>
                                                </div>
                                            </div>
                                        </object>
                                    </div>
                                    <div class="modal-actions" style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                                        <button class="btn btn-secondary" onclick="openPreviewInNewTab()" data-testid="preview-open-tab">Abrir en pesta√±a</button>
                                        <button class="btn btn-secondary" onclick="downloadPreview()" data-testid="preview-download">Descargar</button>
                                        <button class="btn btn-primary" onclick="closePreviewModal()" data-testid="preview-close">Cerrar</button>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        setupUploadZone();
                        return;
                    }
                }
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Subir documentos</h3>
                        <p style="color: #94a3b8; margin-bottom: 24px;">Arrastra archivos PDF aqu√≠ o haz clic para seleccionar</p>
                        <div class="upload-zone" id="upload-zone" data-testid="upload-dropzone">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üì§</div>
                            <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu√≠</p>
                            <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
                            <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-file-input">
                        </div>
                        <!-- Valores por defecto (opcional) -->
                        <div id="upload-defaults-container" style="margin-top: 24px; display: none;">
                            <div class="file-card" id="upload-defaults-card" style="background: #1e293b; border: 1px dashed #334155;">
                                <h4 style="color: #94a3b8; font-size: 0.9rem;">üìã Valores por defecto (opcional)</h4>
                                <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 16px;">Establece valores que se aplicar√°n a todos los archivos nuevos</p>
                                <div class="wizard-question">
                                    <label class="form-label">Tipo de documento</label>
                                    <select class="form-input" id="upload-default-type-select" onchange="updateUploadDefaultsType(this.value)">
                                        <option value="">Sin valor por defecto</option>
                                    </select>
                                </div>
                                <div id="upload-default-subject-group" class="wizard-question hidden">
                                    <label class="form-label">Sujeto (empresa/persona)</label>
                                    <div id="upload-default-subject-input-container"></div>
                                </div>
                                <div id="upload-default-period-group" class="wizard-question hidden">
                                    <label class="form-label">Periodo</label>
                                    <div id="upload-default-period-input-container"></div>
                                </div>
                                <div class="wizard-question">
                                    <label class="form-label">Fecha de emisi√≥n</label>
                                    <input type="date" class="form-input" id="upload-default-issue-date" onchange="updateUploadDefaultsIssueDate(this.value)">
                                </div>
                                <div style="margin-top: 16px;">
                                    <button class="btn btn-secondary btn-sm" onclick="applyDefaultsToAllFiles()">Aplicar a todos los archivos</button>
                                    <button class="btn btn-secondary btn-sm" onclick="clearUploadDefaults()" style="margin-left: 8px;">Limpiar</button>
                                </div>
                            </div>
                        </div>
                        <div id="upload-files-list"></div>
                        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="clearAllUploadFiles()" data-testid="upload-clear-all">Limpiar todo</button>
                            <button class="btn btn-primary btn-lg" onclick="saveAllUploadFiles()" data-testid="save-all">Guardar todo</button>
                        </div>
                    </div>
                    
                    <!-- Duplicate modal -->
                    <div id="upload-duplicate-modal" class="modal-overlay hidden">
                        <div class="modal">
                            <div class="modal-header">
                                <h3>Documento duplicado</h3>
                            </div>
                            <p id="duplicate-modal-message"></p>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeDuplicateModal()">Cancelar</button>
                                <button class="btn btn-secondary" onclick="saveAsVersion()">Guardar como versi√≥n adicional</button>
                                <button class="btn btn-primary" onclick="confirmReplace()">Reemplazar (conservar hist√≥rico)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview modal -->
                    <div id="upload-preview-modal" class="modal-overlay hidden" data-testid="preview-modal" onclick="closePreviewModal()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 90vw; max-height: 90vh; width: 1000px; display: flex; flex-direction: column;">
                            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 id="preview-modal-title">Previsualizar documento</h3>
                                <button class="btn btn-secondary" onclick="closePreviewModal()" style="padding: 4px 12px;">‚úï</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                <object id="preview-object" data-testid="preview-object" data="" type="application/pdf" style="width: 100%; height: 100%; min-height: 500px; border: 1px solid #334155; border-radius: 4px;">
                                    <div class="preview-fallback" style="text-align: center; padding: 24px;">
                                        <p style="margin-bottom: 16px; color: #94a3b8;">No se puede previsualizar embebido en este navegador.</p>
                                        <div style="display: flex; gap: 12px; justify-content: center;">
                                            <a id="preview-fallback-link" href="#" target="_blank" rel="noopener" class="btn btn-primary">Abrir en nueva pesta√±a</a>
                                            <button id="preview-download-btn" class="btn btn-secondary">Descargar</button>
                                        </div>
                                    </div>
                                </object>
                            </div>
                            <div class="modal-actions" style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="openPreviewInNewTab()" data-testid="preview-open-tab">Abrir en pesta√±a</button>
                                <button class="btn btn-secondary" onclick="downloadPreview()" data-testid="preview-download">Descargar</button>
                                <button class="btn btn-primary" onclick="closePreviewModal()" data-testid="preview-close">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Resetear bandera de listeners instalados (el DOM se recre√≥)
                const uploadRoot = document.getElementById('upload-root');
                if (uploadRoot) {
                    uploadRoot.dataset.uploadListenersInstalled = 'false';
                }
                
                setupUploadZone();
                
                // Load subjects (companies + workers)
                try {
                    const subjectsResponse = await fetch(`${BACKEND_URL}/api/repository/subjects`);
                    if (subjectsResponse.ok) {
                        uploadSubjects = await subjectsResponse.json();
                        console.log('[repo-upload] Subjects loaded:', uploadSubjects);
                        
                        // BUG 1: Auto-seleccionar empresa √∫nica si solo hay 1
                        if (uploadSubjects.companies.length === 1) {
                            const singleCompany = uploadSubjects.companies[0];
                            // Aplicar a todos los archivos existentes
                            uploadFiles.forEach(file => {
                                if (file.scope === 'company' || file.scope === 'worker') {
                                    if (!file.company_key) {
                                        file.company_key = singleCompany.id;
                                        file.subject_key = singleCompany.id;
                                        // Limpiar error de empresa obligatoria
                                        if (file.errors) {
                                            file.errors = file.errors.filter(e => 
                                                e !== 'La empresa es obligatoria'
                                            );
                                        }
                                    }
                                }
                            });
                            // Aplicar a valores por defecto
                            if (!uploadFormData.company_key) {
                                uploadFormData.company_key = singleCompany.id;
                            }
                            // Re-render para actualizar UI
                            renderUploadFiles();
                        }
                    } else {
                        console.warn('[repo-upload] Failed to load subjects');
                    }
                } catch (error) {
                    console.error('[repo-upload] Error loading subjects:', error);
                }
                
                // Populate default type select
                populateUploadDefaultsTypeSelect();
                
                // Apply prefill from params (aplicar a valores por defecto)
                if (params.type_id || params.person_key || params.company_key || params.period_key || params.replace_doc_id) {
                    dbg('Setting uploadPrefill:', params);
                    if (params.type_id) {
                        const typeSelect = document.getElementById('upload-default-type-select');
                        if (typeSelect) {
                            typeSelect.value = params.type_id;
                            updateUploadDefaultsType(params.type_id);
                        }
                    }
                    if (params.person_key) {
                        uploadFormData.person_key = params.person_key;
                        updateUploadDefaultsSubject('worker', params.person_key);
                    }
                    if (params.company_key) {
                        uploadFormData.company_key = params.company_key;
                        updateUploadDefaultsSubject('company', params.company_key);
                    }
                    if (params.period_key) {
                        uploadFormData.period_key = params.period_key;
                        const type = uploadTypes.find(t => t.type_id === params.type_id);
                        if (type) {
                            const periodKind = type.validity_policy?.mode || 'none';
                            updateUploadDefaultsPeriod(params.period_key, periodKind);
                        }
                    }
                    // Guardar replace_doc_id para usar al guardar
                    if (params.replace_doc_id) {
                        window.replaceDocId = params.replace_doc_id;
                        // Mostrar mensaje informativo
                        const infoMsg = document.createElement('div');
                        infoMsg.className = 'alert alert-info';
                        infoMsg.style.marginBottom = '16px';
                        infoMsg.innerHTML = `‚ö†Ô∏è <strong>Reemplazando documento:</strong> Se reemplazar√° el PDF del documento existente. Los metadatos se conservar√°n.`;
                        const content = document.getElementById('page-content');
                        if (content && content.firstChild) {
                            content.insertBefore(infoMsg, content.firstChild);
                        }
                    }
                    // Mostrar contenedor de valores por defecto si hay prefill
                    const defaultsContainer = document.getElementById('upload-defaults-container');
                    if (defaultsContainer) defaultsContainer.style.display = 'block';
                    updateDebugOverlay('subir', true, `Prefill set: ${params.type_id || 'none'}`);
                } else {
                    updateDebugOverlay('subir', false, 'No prefill params');
                }
                
                renderUploadFiles();
                console.log('[repo-upload] initUploadWizard end');
            } catch (error) {
                console.error('[repo-upload] Error:', error);
                content.innerHTML = `<div class="alert alert-error">Error al cargar subir: ${error.message}</div>`;
            }
        }
        
        // Instrumentaci√≥n (solo debug)
        if (typeof window.__uploadInitCount === 'undefined') {
            window.__uploadInitCount = 0;
        }
        
        // setupUploadZone idempotente: puede llamarse m√∫ltiples veces sin duplicar listeners
        function setupUploadZone() {
            window.__uploadInitCount++;
                const uploadZone = document.getElementById('upload-zone');
                const fileInput = document.getElementById('file-input');
            const uploadRoot = uploadZone?.closest('.card') || document.getElementById('page-content');
            
            if (!uploadZone || !fileInput) {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log(`[repo-upload] setupUploadZone #${window.__uploadInitCount}: missing elements`, {
                        uploadZone: !!uploadZone,
                        fileInput: !!fileInput
                    });
                }
                return;
            }
            
            // Verificar si ya est√°n instalados usando bandera en el DOM (m√°s robusto que variable global)
            if (uploadRoot && uploadRoot.dataset.uploadListenersInstalled === 'true') {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log(`[repo-upload] setupUploadZone #${window.__uploadInitCount}: already installed, skipping`);
                }
                return;
            }
            
            // Marcar como instalado ANTES de a√±adir listeners (evita race conditions)
            if (uploadRoot) {
                uploadRoot.dataset.uploadListenersInstalled = 'true';
            }
            
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log(`[repo-upload] setupUploadZone #${window.__uploadInitCount}: installing listeners`, {
                    uploadZone: !!uploadZone,
                    fileInput: !!fileInput,
                    uploadRoot: !!uploadRoot
                });
            }
            
            // Handlers (creados una sola vez)
            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });
            
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
            
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
            
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] onFilesSelected (drop):', {
                        files: e.dataTransfer.files.length,
                        uploadFilesBefore: uploadFiles.length
                    });
                }
                    handleUploadFiles(e.dataTransfer.files);
                });
            
                fileInput.addEventListener('change', (e) => {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] onFilesSelected (change):', {
                        files: e.target.files.length,
                        uploadFilesBefore: uploadFiles.length
                    });
                }
                    handleUploadFiles(e.target.files);
                // Resetear el input despu√©s de procesar (permite seleccionar el mismo archivo de nuevo)
                e.target.value = '';
            });
        }
        
        function handleUploadFiles(files) {
            const beforeCount = uploadFiles.length;
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] handleUploadFiles: start', {
                    filesCount: files.length,
                    uploadFilesBefore: beforeCount
                });
            }
            
            for (let file of files) {
                if (file.type !== 'application/pdf') {
                    alert(`El archivo ${file.name} no es un PDF`);
                    continue;
                }
                
                // Usar datos del formulario si est√°n disponibles
                // Inferir scopeFilter desde sujetos si ya existen
                let initialScopeFilter = 'all';
                if (uploadFormData.person_key) {
                    initialScopeFilter = 'worker';
                } else if (uploadFormData.company_key) {
                    initialScopeFilter = 'company';
                }
                
                const fileData = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    type_id: uploadFormData.type_id || '',
                    subject_key: '',
                    subject_name: '',
                    scope: uploadFormData.scope || '',
                    company_key: uploadFormData.company_key || '',
                    person_key: uploadFormData.person_key || '',
                    period_key: uploadFormData.period_key || '',
                    issue_date: uploadFormData.issue_date || '',
                    scopeFilter: initialScopeFilter, // NUEVO: prefiltro por scope
                    scopeFilterLocked: false, // NUEVO: bloqueado si hay tipo detectado
                    detected: {},
                    errors: {}
                };
                
                // BUG 1: Auto-seleccionar empresa √∫nica si solo hay 1 (al crear el file card)
                if (uploadSubjects.companies && uploadSubjects.companies.length === 1) {
                    const singleCompany = uploadSubjects.companies[0];
                    if (fileData.scope === 'company' || fileData.scope === 'worker') {
                        if (!fileData.company_key) {
                            fileData.company_key = singleCompany.id;
                            fileData.subject_key = singleCompany.id;
                        }
                    }
                }
                
                // Auto-detect from filename
                detectUploadMetadata(fileData);
                
                // Si el formulario tiene datos, usarlos (tienen prioridad sobre detecci√≥n)
                if (uploadFormData.type_id) {
                    fileData.type_id = uploadFormData.type_id;
                    const type = uploadTypes.find(t => t.type_id === uploadFormData.type_id);
                    if (type) fileData.scope = type.scope;
                }
                if (uploadFormData.person_key) {
                    fileData.person_key = uploadFormData.person_key;
                    const person = (uploadPeople.people || []).find(p => p.worker_id === uploadFormData.person_key);
                    if (person) fileData.subject_name = person.full_name;
                }
                if (uploadFormData.company_key) {
                    fileData.company_key = uploadFormData.company_key;
                }
                if (uploadFormData.period_key) {
                    fileData.period_key = uploadFormData.period_key;
                }
                
                // Apply prefill if available (legacy support)
                if (window.uploadPrefill) {
                    const prefill = window.uploadPrefill;
                    if (prefill.type_id && !fileData.type_id) {
                        fileData.type_id = prefill.type_id;
                        const type = uploadTypes.find(t => t.type_id === prefill.type_id);
                        if (type) fileData.scope = type.scope;
                    }
                    if (prefill.person_key && !fileData.person_key) {
                        fileData.person_key = prefill.person_key;
                        const person = (uploadPeople.people || []).find(p => p.worker_id === prefill.person_key);
                        if (person) fileData.subject_name = person.full_name;
                    }
                    if (prefill.company_key && !fileData.company_key) {
                        fileData.company_key = prefill.company_key;
                    }
                    if (prefill.period_key && !fileData.period_key) {
                        fileData.period_key = prefill.period_key;
                    }
                    delete window.uploadPrefill;
                }
                
                uploadFiles.push(fileData);
            }
            
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] handleUploadFiles: end', {
                    uploadFilesAfter: uploadFiles.length,
                    added: uploadFiles.length - beforeCount
                });
            }
            
            renderUploadFiles();
        }
        
        function detectUploadMetadata(fileData) {
            const filename = fileData.name.toLowerCase();
            
            // Detect type (fail-safe: verificar que uploadTypes existe y es array)
            if (!uploadTypes || !Array.isArray(uploadTypes)) {
                console.warn('[repo-upload] detectUploadMetadata: uploadTypes no est√° disponible');
                return;
            }
            
            for (const type of uploadTypes) {
                for (const alias of type.platform_aliases || []) {
                    if (filename.includes(alias.toLowerCase())) {
                        fileData.detected.type_id = type.type_id;
                        fileData.detected.scope = type.scope;
                        break;
                    }
                }
                if (fileData.detected.type_id) break;
            }
            
            // Detect person
            for (const person of uploadPeople.people || []) {
                const nameParts = person.full_name.toLowerCase().split(' ');
                if (nameParts.some(part => filename.includes(part))) {
                    fileData.detected.person_key = person.worker_id;
                    break;
                }
            }
            
            // Detect period (YYYY-MM)
            const periodMatch = filename.match(/(\d{4})-(\d{2})/);
            if (periodMatch) {
                fileData.detected.period_key = `${periodMatch[1]}-${periodMatch[2]}`;
            }
            
            // Detect date from filename (name_date)
            const parsedDate = parseDateFromFilename(fileData.name, null);
            if (parsedDate) {
                fileData.detected.name_date = parsedDate;
                // Si issue_date est√° vac√≠o, prefill con name_date
                if (!fileData.issue_date) {
                    fileData.issue_date = parsedDate;
                }
            }
            
            // Apply detected
            if (fileData.detected.type_id && !fileData.type_id) {
                fileData.type_id = fileData.detected.type_id;
                // Resolver el tipo desde uploadTypes (fail-safe: si no existe, no bloquear)
                const type = uploadTypes && Array.isArray(uploadTypes) 
                    ? uploadTypes.find(t => t.type_id === fileData.type_id) 
                    : null;
                if (type && type.scope) {
                    fileData.scope = type.scope;
                    // Aplicar scopeFilter y lock cuando se detecta un tipo autom√°ticamente
                    if (type.scope === 'company' || type.scope === 'worker') {
                        fileData.scopeFilter = type.scope;
                        fileData.scopeFilterLocked = true;
                    }
                }
            }
            if (fileData.detected.person_key && !fileData.person_key) {
                fileData.person_key = fileData.detected.person_key;
                const person = (uploadPeople.people || []).find(p => p.worker_id === fileData.person_key);
                if (person) fileData.subject_name = person.full_name;
            }
            if (fileData.detected.period_key && !fileData.period_key) {
                fileData.period_key = fileData.detected.period_key;
            }
        }
        
        // Estado del formulario de metadatos (sin archivo)
        let uploadFormData = {
            type_id: null,
            scope: null,
            person_key: null,
            company_key: null,
            period_key: null,
            issue_date: null
        };
        
        function renderUploadFiles() {
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] renderUploadFiles: start', {
                    uploadFilesLength: uploadFiles.length
                });
            }
            
            const list = document.getElementById('upload-files-list');
            if (!list) return;
            
            // El formulario principal ya est√° visible desde el inicio
            // Solo renderizamos los archivos si hay alguno
            if (uploadFiles.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = uploadFiles.map(file => {
                const type = uploadTypes.find(t => t.type_id === file.type_id);
                const periodMode = type?.validity_policy?.mode || 'none';
                
                // Derivar period_kind desde periodMode (igual que backend)
                // MONTH, QUARTER, YEAR requieren periodo manual; NONE y n_months no
                let periodKind = 'none';
                if (periodMode === 'monthly') {
                    periodKind = 'month';
                } else if (periodMode === 'annual') {
                    periodKind = 'year';
                } else if (periodMode === 'quarter') {
                    periodKind = 'quarter';
                } else {
                    // n_months, none, o cualquier otro => NONE (no requiere periodo manual)
                    periodKind = 'none';
                }
                
                // BUG 3: No pedir a√±o si es N meses desde expedici√≥n (issue_date)
                // Si tiene n_months configurado y se calcula desde issue_date, no necesita period_key
                const hasNMonths = type?.validity_policy?.n_months?.n;
                const calculatesFromIssueDate = type?.validity_policy?.basis === 'issue_date' || 
                                               (hasNMonths && type?.validity_policy?.monthly?.month_source === 'issue_date');
                const shouldHidePeriodForNMonths = hasNMonths && calculatesFromIssueDate && file.issue_date;
                
                // Mostrar campo Mes/A√±o SOLO si period_kind es MONTH, QUARTER o YEAR (no NONE)
                const needsPeriod = (periodKind === 'month' || periodKind === 'year' || periodKind === 'quarter') && !shouldHidePeriodForNMonths;
                
                // Ocultar campo mes/a√±o si se calcula desde nombre y hay issue_date
                const calculatesFromName = type?.validity_policy?.basis === 'name_date' || 
                                         (type?.validity_policy?.monthly?.month_source === 'name_date');
                const shouldHidePeriod = (calculatesFromName && file.issue_date) || shouldHidePeriodForNMonths;
                
                // Si se oculta, derivar period_ym desde issue_date
                if (shouldHidePeriod && file.issue_date && !file.period_key) {
                    const date = new Date(file.issue_date);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    file.period_key = `${year}-${month}`;
                }
                
                // BUG 1: Auto-seleccionar empresa √∫nica si solo hay 1 (en render)
                if (uploadSubjects.companies && uploadSubjects.companies.length === 1) {
                    const singleCompany = uploadSubjects.companies[0];
                    if ((file.scope === 'company' || file.scope === 'worker') && !file.company_key) {
                        file.company_key = singleCompany.id;
                        file.subject_key = singleCompany.id;
                        // Limpiar error de empresa obligatoria
                        if (file.errors) {
                            file.errors = file.errors.filter(e => e !== 'La empresa es obligatoria');
                        }
                    }
                }
                
                // Validation - usar file.type_id (no input visible)
                const errors = [];
                if (!file.type_id || (typeof file.type_id === 'string' && file.type_id.trim() === '')) {
                    errors.push('Selecciona un tipo de documento');
                    // Debug: log si hay problema (siempre, no solo en debug mode)
                    console.warn('[repo-upload] Validation failed for file:', file.name, 'type_id:', file.type_id, 'type:', typeof file.type_id);
                }
                if (file.scope === 'worker' && !file.person_key) errors.push('El trabajador es obligatorio');
                // BUG 1: No mostrar error de empresa si est√° auto-seleccionada (solo hay 1)
                if (file.scope === 'company' && !file.company_key) {
                    // Solo error si realmente no hay empresa disponible o no est√° auto-seleccionada
                    if (!(uploadSubjects.companies && uploadSubjects.companies.length === 1)) {
                        errors.push('La empresa es obligatoria');
                    }
                }
                if (file.scope === 'worker' && !file.company_key) {
                    // Solo error si realmente no hay empresa disponible o no est√° auto-seleccionada
                    if (!(uploadSubjects.companies && uploadSubjects.companies.length === 1)) {
                        errors.push('La empresa es obligatoria');
                    }
                }
                // Solo validar periodo si realmente se requiere (period_kind != NONE)
                if (needsPeriod && !file.period_key) {
                    errors.push(`El ${periodKind === 'month' ? 'mes' : periodKind === 'quarter' ? 'trimestre' : 'a√±o'} es obligatorio`);
                }
                // Validar fecha si es requerida
                if (file.requires_issue_date && !file.issue_date) {
                    if (!errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.')) {
                        errors.push('La fecha de emisi√≥n es obligatoria');
                    }
                }
                
                file.errors = errors;
                
                // NUEVO: Filtrar tipos seg√∫n scopeFilter
                const scopeFilter = file.scopeFilter || 'all';
                const filteredTypes = uploadTypes.filter(t => {
                    if (t.active === false) return false;
                    if (scopeFilter === 'all') return true;
                    return t.scope === scopeFilter;
                });
                
                // NUEVO: Si el tipo seleccionado no est√° en los filtrados, limpiar y mostrar error
                if (file.type_id && scopeFilter !== 'all') {
                    const selectedType = uploadTypes.find(t => {
                        const tId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                        return tId === file.type_id;
                    });
                    if (selectedType && selectedType.scope !== scopeFilter) {
                        file.type_id = null;
                        file.type_name = null;
                        file.scope = null;
                        // Limpiar tambi√©n el tipo detectado si era incompatible
                        if (file.detected.type_id === selectedType.type_id) {
                            file.detected.type_id = null;
                            file.detected.scope = null;
                            file.scopeFilterLocked = false;
                        }
                        if (!file.errors) file.errors = [];
                        if (!file.errors.includes('Selecciona un documento de la lista')) {
                            file.errors.push('Selecciona un documento de la lista');
                        }
                    }
                }
                
                return `
                    <div class="file-card" data-testid="upload-card-${file.id}">
                        <h4>${file.name}</h4>
                        <div class="wizard-question">
                            <label class="form-label">0. Aplica a <span class="form-required">*</span></label>
                            <div data-testid="scope-filter-pills" style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                                <label data-testid="scope-pill-all" style="display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: ${scopeFilter === 'all' ? '#3b82f6' : '#f8fafc'}; color: ${scopeFilter === 'all' ? '#fff' : '#1e293b'}; ${file.scopeFilterLocked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <input type="radio" name="scope-filter-${file.id}" value="all" 
                                           ${scopeFilter === 'all' ? 'checked' : ''}
                                           ${file.scopeFilterLocked ? 'disabled' : ''}
                                           onchange="updateUploadScopeFilter('${file.id}', 'all')"
                                           style="margin-right: 6px;">
                                    Todos
                                </label>
                                <label data-testid="scope-pill-company" style="display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: ${scopeFilter === 'company' ? '#3b82f6' : '#f8fafc'}; color: ${scopeFilter === 'company' ? '#fff' : '#1e293b'}; ${file.scopeFilterLocked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <input type="radio" name="scope-filter-${file.id}" value="company" 
                                           ${scopeFilter === 'company' ? 'checked' : ''}
                                           ${file.scopeFilterLocked ? 'disabled' : ''}
                                           onchange="updateUploadScopeFilter('${file.id}', 'company')"
                                           style="margin-right: 6px;">
                                    Empresa
                                </label>
                                <label data-testid="scope-pill-worker" style="display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: ${scopeFilter === 'worker' ? '#3b82f6' : '#f8fafc'}; color: ${scopeFilter === 'worker' ? '#fff' : '#1e293b'}; ${file.scopeFilterLocked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <input type="radio" name="scope-filter-${file.id}" value="worker" 
                                           ${scopeFilter === 'worker' ? 'checked' : ''}
                                           ${file.scopeFilterLocked ? 'disabled' : ''}
                                           onchange="updateUploadScopeFilter('${file.id}', 'worker')"
                                           style="margin-right: 6px;">
                                    Trabajador
                                </label>
                            </div>
                            ${file.scopeFilterLocked ? '<div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">El filtro est√° bloqueado porque se detect√≥ un tipo autom√°ticamente. Cambia el tipo manualmente para desbloquearlo.</div>' : ''}
                        </div>
                        <div class="wizard-question">
                            <label class="form-label">1. ¬øQu√© documento es? <span class="form-required">*</span> ${file.detected.type_id ? '<span class="badge badge-ok" data-testid="detected-badge" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                            <select class="form-input repo-upload-type-select" 
                                    id="upload-file-type-select-${file.id}"
                                    data-upload-file-id="${file.id}"
                                    data-testid="type-autocomplete"
                                    required>
                                <option value="">Selecciona un tipo...</option>
                                ${(() => {
                                    // Usar filteredTypes en lugar de uploadTypes
                                    console.log('[repo-upload] filtered types sample', filteredTypes.slice(0,5).map(t => ({
                                        name: t.name,
                                        type_id: t.type_id,
                                        scope: t.scope
                                    })));
                                    
                                    return filteredTypes.sort((a, b) => a.name.localeCompare(b.name)).map(t => {
                                        // Normalizar ID: puede venir como type_id, id, o code
                                        const typeId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                                        if (!typeId) {
                                            console.warn('[repo-upload] DocumentType without id:', t);
                                            return `<option value="" disabled>[SIN ID] ${escapeHtml(t.name)}</option>`;
                                        }
                                        const escapedId = escapeHtml(String(typeId));
                                        const escapedName = escapeHtml(t.name);
                                        const selected = file.type_id === typeId ? 'selected' : '';
                                        return `<option value="${escapedId}" ${selected} data-testid="type-option-${escapedId}">${escapedName}</option>`;
                                    }).join('');
                                })()}
                            </select>
                            ${errors.includes('El documento es obligatorio') || errors.includes('Selecciona un tipo de documento') ? '<div class="form-error" data-testid="type-error">Selecciona un tipo de documento</div>' : ''}
                            ${errors.includes('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.') ? '<div class="form-error" style="color: #ef4444; font-weight: bold;" data-testid="type-error">Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.</div>' : ''}
                            ${errors.includes('El tipo seleccionado no coincide con el filtro de alcance') ? '<div class="form-error" data-testid="type-error">El tipo seleccionado no coincide con el filtro de alcance</div>' : ''}
                            ${errors.includes('Selecciona un documento de la lista') ? '<div class="form-error" data-testid="type-error">Selecciona un documento de la lista</div>' : ''}
                            <!-- Debug overlay visible -->
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px; font-family: monospace; background: #0f172a; padding: 4px 8px; border-radius: 4px;">
                                debug: type_id=${file.type_id || 'NULL'} | dom_value=${file._last_dom_value || 'NULL'} | issue_date=${file.issue_date || 'NULL'} | requires_issue_date=${file.requires_issue_date || false} | scopeFilter=${scopeFilter} | errors=[${errors.join(', ')}]
                                <br>
                                listener_installed=${window.__REPO_UPLOAD_LISTENER_INSTALLED || false} | last_change=${window.__REPO_UPLOAD_LAST_CHANGE ? new Date(window.__REPO_UPLOAD_LAST_CHANGE.time).toLocaleTimeString() : 'NULL'} | last_select_value=${window.__REPO_UPLOAD_LAST_SELECT_DEBUG?.value || 'NULL'}
                            </div>
                        </div>
                        ${file.scope ? `
                            <div class="wizard-question">
                                <label class="form-label">2. ¬øDe qui√©n / empresa? ${file.detected.person_key ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                                ${file.scope === 'worker' ? `
                                    ${uploadSubjects.companies.length > 1 ? `
                                        <label class="form-label" style="margin-top: 8px; font-size: 0.9rem;">Empresa <span class="form-required">*</span></label>
                                        <select class="form-input repo-upload-company-select" 
                                                id="upload-company-select-${file.id}"
                                                data-upload-file-id="${file.id}"
                                                onchange="updateUploadCompanyFromSelect('${file.id}', this.value)"
                                                required>
                                            <option value="">Selecciona una empresa...</option>
                                            ${uploadSubjects.companies.map(c => `
                                                <option value="${escapeHtml(c.id)}" ${file.company_key === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>
                                            `).join('')}
                                        </select>
                                    ` : uploadSubjects.companies.length === 1 ? `
                                        <input type="hidden" id="upload-company-select-${file.id}" value="${uploadSubjects.companies[0].id}">
                                    ` : ''}
                                    <label class="form-label" style="margin-top: 8px; font-size: 0.9rem;">Trabajador <span class="form-required">*</span></label>
                                    <select class="form-input repo-upload-worker-select" 
                                            id="upload-worker-select-${file.id}"
                                            data-upload-file-id="${file.id}"
                                            data-company-id="${file.company_key || (uploadSubjects.companies.length === 1 ? uploadSubjects.companies[0].id : '')}"
                                            onchange="updateUploadWorker('${file.id}', this.value)"
                                            ${!file.company_key && uploadSubjects.companies.length > 1 ? 'disabled' : ''}
                                            required>
                                        <option value="">Selecciona un trabajador...</option>
                                        ${(() => {
                                            const companyId = file.company_key || (uploadSubjects.companies.length === 1 ? uploadSubjects.companies[0].id : '');
                                            const workers = uploadSubjects.workers_by_company[companyId] || [];
                                            return workers.map(w => `
                                                <option value="${escapeHtml(w.id)}" ${file.person_key === w.id ? 'selected' : ''}>${escapeHtml(w.name)}</option>
                                            `).join('');
                                        })()}
                                    </select>
                                    ${errors.includes('El trabajador es obligatorio') ? '<div class="form-error">El trabajador es obligatorio</div>' : ''}
                                    ${errors.includes('La empresa es obligatoria') ? '<div class="form-error">La empresa es obligatoria</div>' : ''}
                                ` : `
                                    <select class="form-input repo-upload-company-select" 
                                            id="upload-company-select-${file.id}"
                                            data-upload-file-id="${file.id}"
                                            onchange="updateUploadCompany('${file.id}', this.value)"
                                            required>
                                        <option value="">Selecciona una empresa...</option>
                                        ${uploadSubjects.companies.map(c => `
                                            <option value="${escapeHtml(c.id)}" ${file.company_key === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>
                                        `).join('')}
                                    </select>
                                    ${errors.includes('La empresa es obligatoria') ? '<div class="form-error">La empresa es obligatoria</div>' : ''}
                                `}
                            </div>
                        ` : ''}
                        ${needsPeriod && !shouldHidePeriod ? `
                            <div class="wizard-question" data-testid="period-monthyear">
                                <label class="form-label">3. ¬øDe qu√© ${periodKind === 'month' ? 'mes/a√±o' : periodKind === 'quarter' ? 'trimestre/a√±o' : 'a√±o'}? ${file.detected.period_key ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                                ${periodKind === 'month' ? `
                                    <input type="month" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : periodKind === 'year' ? `
                                    <input type="number" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           placeholder="YYYY"
                                           min="2000" max="2100"
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : periodKind === 'quarter' ? `
                                    <input type="text" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           placeholder="YYYY-Qn (ej: 2025-Q1)"
                                           pattern="\d{4}-Q[1-4]"
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : ''}
                                ${errors.some(e => e.includes('obligatorio')) ? `<div class="form-error">El ${periodKind === 'month' ? 'mes' : periodKind === 'quarter' ? 'trimestre' : 'a√±o'} es obligatorio</div>` : ''}
                            </div>
                        ` : shouldHidePeriod || periodKind === 'none' ? `
                            <div class="wizard-question" style="display: none;" data-testid="period-monthyear">
                                <input type="hidden" id="upload-period-${file.id}" value="${file.period_key || ''}">
                            </div>
                        ` : ''}
                        <div class="wizard-question">
                            <label class="form-label">4. Fecha de emisi√≥n${file.requires_issue_date ? ' <span class="form-required">*</span>' : ' (Opcional)'}</label>
                            <input type="date" class="form-input" 
                                   id="upload-issue-date-${file.id}"
                                   value="${file.issue_date || ''}" 
                                   onchange="updateUploadIssueDate('${file.id}', this.value)"
                                   ${file.requires_issue_date ? 'required' : ''}>
                            ${file.issue_date ? `<div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">Fecha detectada desde nombre</div>` : ''}
                            ${errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.') ? '<div class="form-error">No se pudo extraer fecha del nombre. Selecciona una fecha.</div>' : ''}
                            ${file.requires_issue_date && !file.issue_date && !errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.') ? '<div class="form-error">La fecha de emisi√≥n es obligatoria</div>' : ''}
                        </div>
                        ${(() => {
                            const validityStartMode = type?.validity_start_mode || 'issue_date';
                            if (validityStartMode === 'manual') {
                                return `
                                    <div class="wizard-question">
                                        <label class="form-label">5. Fecha de inicio de vigencia <span class="form-required">*</span></label>
                                        <input type="date" class="form-input" 
                                               id="upload-validity-start-date-${file.id}"
                                               data-testid="validity-start-input"
                                               data-upload-file-id="${file.id}"
                                               value="${file.validity_start_date || ''}" 
                                               onchange="updateUploadValidityStartDate('${file.id}', this.value)"
                                               oninput="updateUploadValidityStartDate('${file.id}', this.value)"
                                               onblur="updateUploadValidityStartDate('${file.id}', this.value)"
                                               required>
                                        <div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">Fecha desde la cual el documento es v√°lido (puede ser distinta de la fecha de emisi√≥n)</div>
                                        ${errors.includes('La fecha de inicio de vigencia es obligatoria') ? '<div class="form-error">La fecha de inicio de vigencia es obligatoria</div>' : ''}
                                        ${!file.validity_start_date ? '<div class="form-error">La fecha de inicio de vigencia es obligatoria</div>' : ''}
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                        ${errors.length > 0 ? `<div class="alert alert-error">${errors.join(', ')}</div>` : ''}
                        <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="previewUploadFile('${file.id}')" data-testid="preview-btn-${file.id}">Previsualizar</button>
                            <button class="btn btn-secondary" onclick="removeUploadFile('${file.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
            
        }
        
        // Funci√≥n para actualizar tipo de documento en un archivo (usando select)
        function updateUploadFileType(fileId, typeId) {
            // Convertir ambos a string para comparaci√≥n (fileId viene como string del DOM)
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) {
                console.warn('[repo-upload] File not found:', {
                    fileId,
                    fileIdType: typeof fileId,
                    uploadFilesIds: uploadFiles.map(f => ({ id: f.id, idType: typeof f.id, idString: String(f.id) }))
                });
                return;
            }
            
            // Obtener el select y la opci√≥n seleccionada
            const select = document.getElementById(`upload-file-type-select-${fileId}`);
            const selectedIndex = select ? select.selectedIndex : -1;
            const selectedOption = select && selectedIndex >= 0 ? select.options[selectedIndex] : null;
            const selectedText = selectedOption ? selectedOption.textContent : '';
            
            // Guardar type_id directamente del value (sin normalizar, ya viene correcto del option)
            const raw = typeId && typeId.trim() ? typeId.trim() : null;
            const beforeTypeId = file.type_id;
            file.type_id = raw;
            file.type_name = selectedText;
            // _last_dom_value ya se setea en el event listener antes de llamar a esta funci√≥n
            
            console.log('[repo-upload] updateUploadFileType:', {
                filename: file.name,
                fileId: fileId,
                rawValue: typeId,
                normalizedTypeId: raw,
                before: beforeTypeId,
                after: file.type_id,
                typeName: file.type_name,
                domValue: file._last_dom_value
            });
            
            // Fail-fast: si value est√° vac√≠o despu√©s de procesar, error
            if (!raw) {
                // Si el usuario limpia el tipo, desbloquear el scopeFilter
                file.scopeFilterLocked = false;
                if (!file.errors) file.errors = [];
                if (!file.errors.includes('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.')) {
                    file.errors.push('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.');
                }
                renderUploadFiles();
                return;
            }
            
            // Buscar el tipo en uploadTypes
            const type = raw ? uploadTypes.find(t => {
                const tId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                return tId === raw;
            }) : null;
            
            if (type) {
                file.scope = type.scope;
                
                // NUEVO: Si el usuario cambia el tipo manualmente (no es el detectado), desbloquear y alinear scopeFilter
                const isDetectedType = file.detected.type_id === raw;
                if (!isDetectedType) {
                    // Desbloquear el prefiltro (acci√≥n manual)
                    file.scopeFilterLocked = false;
                    // Alinear scopeFilter con el tipo seleccionado manualmente (el prefiltro sigue al tipo)
                    if (type.scope === 'company' || type.scope === 'worker') {
                        file.scopeFilter = type.scope;
                    }
                } else {
                    // Si es el tipo detectado, mantener bloqueado y alineado
                    if (type.scope === 'company' || type.scope === 'worker') {
                        file.scopeFilter = type.scope;
                        file.scopeFilterLocked = true;
                    }
                }
                
                // Determinar si requiere fecha de emisi√≥n
                // 1. Si tiene el flag issue_date_required, usarlo
                // 2. Si no, retrocompat: si basis === 'name_date' y month_source === 'name_date'
                // 3. Por defecto: false
                let issueDateRequired = false;
                if (type.issue_date_required !== undefined) {
                    issueDateRequired = type.issue_date_required;
                } else if (type.validity_policy?.basis === 'name_date' && 
                          type.validity_policy?.monthly?.month_source === 'name_date') {
                    issueDateRequired = true;
                }
                file.requires_issue_date = issueDateRequired;
                
                // Resolver validity_start_date seg√∫n el modo
                const validityStartMode = type.validity_start_mode || 'issue_date';
                if (validityStartMode === 'issue_date') {
                    // Inicio de vigencia = issue_date (se actualizar√° cuando cambie issue_date)
                    file.validity_start_date = file.issue_date || null;
                } else if (validityStartMode === 'manual') {
                    // Mantener validity_start_date independiente (no cambiar autom√°ticamente)
                    if (!file.validity_start_date) {
                        file.validity_start_date = null;
                    }
                }
                
                // Auto-fecha desde nombre - SIEMPRE intentar si est√° vac√≠a (best effort)
                const beforeIssueDate = file.issue_date;
                if (!file.issue_date) {
                    const parsedDate = parseDateFromFilename(file.name, type);
                    if (parsedDate) {
                        file.issue_date = parsedDate;
                        console.log('[repo-upload] auto-date candidate:', {
                            filename: file.name,
                            parsed: parsedDate,
                            before: beforeIssueDate,
                            after: file.issue_date,
                            issueDateRequired: issueDateRequired
                        });
                    } else {
                        console.log('[repo-upload] auto-date failed:', {
                            filename: file.name,
                            issueDateRequired: issueDateRequired
                        });
                    }
                }
                
                // Si requiere fecha y a√∫n est√° vac√≠a despu√©s de intentar parsear, mostrar error
                if (issueDateRequired && !file.issue_date) {
                    if (!file.errors) file.errors = [];
                    if (!file.errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.')) {
                        file.errors.push('No se pudo extraer fecha del nombre. Selecciona una fecha.');
                    }
                    // Enfocar datepicker
                    setTimeout(() => {
                        const dateInput = document.getElementById(`upload-issue-date-${fileId}`);
                        if (dateInput) {
                            dateInput.focus();
                            dateInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            } else {
                file.scope = null;
                file.requires_issue_date = false;
                if (raw) {
                    console.warn('[repo-upload] Type not found for ID:', raw, 'Available types:', uploadTypes.map(t => t.type_id ?? t.id ?? t.code ?? t.internal_id));
                }
            }
            
            // Limpiar errores relacionados con tipo
            if (file.errors) {
                const beforeErrors = [...file.errors];
                file.errors = file.errors.filter(e => 
                    e !== 'Selecciona un tipo de documento' && 
                    e !== 'El documento es obligatorio' &&
                    e !== 'Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.' &&
                    e !== 'Selecciona un documento de la lista'
                );
                if (beforeErrors.length !== file.errors.length) {
                    console.log('[repo-upload] Errores limpiados:', beforeErrors, '->', file.errors);
                }
            }
            
            renderUploadFiles();
        }
        
        // NUEVO: Funci√≥n para actualizar el prefiltro de scope
        function updateUploadScopeFilter(fileId, scopeFilter) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            // No permitir cambiar si est√° bloqueado (invariante: bloqueo real - guard clause)
            if (file.scopeFilterLocked) {
                console.log('[repo-upload] Scope filter is locked for file:', file.name);
                return; // Guard clause: evita que un bug de CSS o evento burbuja cambie el estado
            }
            
            file.scopeFilter = scopeFilter;
            
            // Si el tipo seleccionado no coincide con el nuevo filtro, limpiar y mostrar error
            if (file.type_id && scopeFilter !== 'all') {
                const selectedType = uploadTypes.find(t => {
                    const tId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                    return tId === file.type_id;
                });
                if (selectedType && selectedType.scope !== scopeFilter) {
                    file.type_id = null;
                    file.type_name = null;
                    file.scope = null;
                    // Limpiar tambi√©n el tipo detectado si era incompatible
                    if (file.detected.type_id === selectedType.type_id) {
                        file.detected.type_id = null;
                        file.detected.scope = null;
                        file.scopeFilterLocked = false;
                    }
                    if (!file.errors) file.errors = [];
                    if (!file.errors.includes('Selecciona un documento de la lista')) {
                        file.errors.push('Selecciona un documento de la lista');
                    }
                }
            }
            
            // Limpiar errores de tipo si el filtro cambi√≥ a 'all' o si el tipo coincide
            if (file.errors) {
                file.errors = file.errors.filter(e => 
                    e !== 'El tipo seleccionado no coincide con el filtro de alcance' &&
                    e !== 'Selecciona un documento de la lista'
                );
            }
            
            renderUploadFiles();
        }
        
        // Parsear fecha desde nombre de archivo (best effort - aplica siempre si fecha vac√≠a)
        function parseDateFromFilename(filename, docType) {
            // Aplicar como "best effort" - no requiere configuraci√≥n espec√≠fica
            // Si el tipo tiene config de "name_date", mejor, pero no es obligatorio
            
            // Normalizar: reemplazar _ por -, colapsar espacios m√∫ltiples, lower
            const normalized = filename.replace(/_/g, '-').replace(/\s+/g, '-').toLowerCase();
            const filenameLower = normalized;
            
            // Mapeo de meses en espa√±ol y catal√°n
            const spanishMonths = {
                'ene': 1, 'enero': 1,
                'feb': 2, 'febrero': 2,
                'mar': 3, 'marzo': 3,
                'abr': 4, 'abril': 4,
                'may': 5, 'mayo': 5,
                'jun': 6, 'junio': 6,
                'jul': 7, 'julio': 7,
                'ago': 8, 'agosto': 8, 'agost': 8, // catal√°n
                'sep': 9, 'septiembre': 9, 'set': 9, 'setembre': 9, // catal√°n
                'oct': 10, 'octubre': 10,
                'nov': 11, 'noviembre': 11,
                'dic': 12, 'diciembre': 12
            };
            
            // Patr√≥n 0: YYYY_DD-MMM-YY o YYYY-DD-MMM-YY (ej: "2025_1-ago-25", "2025-1-ago-25")
            // Soporta a√±o al inicio seguido de d√≠a-mes-a√±o
            const pattern0 = /(\d{4})[-_](\d{1,2})[-/](ene|feb|mar|abr|may|jun|jul|ago|sep|set|oct|nov|dic|enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)[-/](\d{2,4})/i;
            const match0 = normalized.match(pattern0);
            if (match0) {
                const year1 = parseInt(match0[1]); // A√±o del inicio (preferido)
                const day = parseInt(match0[2]);
                const monthStr = match0[3].toLowerCase();
                const year2Str = match0[4];
                const month = spanishMonths[monthStr];
                if (month) {
                    let year = year1; // Preferir a√±o del inicio
                    // Si el a√±o del final es diferente y tiene 4 d√≠gitos, podr√≠a ser m√°s espec√≠fico, pero preferimos el del inicio
                    if (year2Str.length === 4) {
                        const year2 = parseInt(year2Str);
                        // Si ambos a√±os est√°n presentes y son diferentes, usar el del inicio (m√°s confiable)
                        year = year1;
                    } else if (year2Str.length === 2) {
                        // Si solo hay a√±o de 2 d√≠gitos al final, ya usamos el del inicio
                        year = year1;
                    }
                    try {
                        const date = new Date(Date.UTC(year, month - 1, day));
                        if (date.getUTCDate() === day && date.getUTCMonth() === month - 1 && date.getUTCFullYear() === year) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                                console.log('[repo-upload] Fecha parseada (pattern0):', filename, '->', dateStr);
                            }
                            return dateStr;
                        }
                    } catch (e) {
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.warn('[repo-upload] Error parsing date (pattern0):', e);
                        }
                    }
                }
            }
            
            // Patr√≥n 1: DD-MMM-YY o DD-MMM-YYYY (ej: "28-nov-25", "28-nov-2025", "28-NOV-25", "AEAT-16-oct-2025")
            // Tolerar espacios y may√∫sculas/min√∫sculas
            // IMPORTANTE: Buscar en el filename normalizado con flag /i para case-insensitive
            const pattern1 = /(\d{1,2})[-/](ene|feb|mar|abr|may|jun|jul|ago|sep|set|oct|nov|dic|enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)[-/](\d{2,4})/i;
            const match1 = normalized.match(pattern1);
            console.log('[repo-upload] parseDateFromFilename pattern1 match:', { filename, match1 });
            if (match1) {
                const day = parseInt(match1[1]);
                const monthStr = match1[2].toLowerCase();
                const yearStr = match1[3];
                const month = spanishMonths[monthStr];
                if (month) {
                    let year = parseInt(yearStr);
                    if (yearStr.length === 2) {
                        // A√±o 2 d√≠gitos: 00-69 => 2000-2069, 70-99 => 1970-1999
                        year = year < 70 ? 2000 + year : 1900 + year;
                    }
                    try {
                        // Usar UTC para evitar problemas de zona horaria
                        const date = new Date(Date.UTC(year, month - 1, day));
                        if (date.getUTCDate() === day && date.getUTCMonth() === month - 1 && date.getUTCFullYear() === year) {
                            // Formatear manualmente para evitar problemas de zona horaria
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                                console.log('[repo-upload] Fecha parseada desde nombre:', filename, '->', dateStr);
                            }
                            return dateStr; // Formato YYYY-MM-DD
                        }
                    } catch (e) {
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.warn('[repo-upload] Error parsing date:', e);
                        }
                    }
                }
            }
            
            // Patr√≥n 2: DD/MM/YYYY o DD-MM-YYYY (ej: "28/11/2025", "28-11-2025")
            const pattern2 = /(\d{1,2})[-/](\d{1,2})[-/](\d{4})/;
            const match2 = filenameLower.match(pattern2);
            if (match2) {
                const day = parseInt(match2[1]);
                const month = parseInt(match2[2]);
                const year = parseInt(match2[3]);
                try {
                    const date = new Date(year, month - 1, day);
                    if (date.getDate() === day && date.getMonth() === month - 1) {
                        return date.toISOString().split('T')[0];
                    }
                } catch (e) {}
            }
            
            // Patr√≥n 3: DD/MM/YY o DD-MM-YY (ej: "28/11/25", "28-11-25")
            const pattern3 = /(\d{1,2})[-/](\d{1,2})[-/](\d{2})/;
            const match3 = filenameLower.match(pattern3);
            if (match3) {
                const day = parseInt(match3[1]);
                const month = parseInt(match3[2]);
                let year = parseInt(match3[3]);
                // A√±o 2 d√≠gitos: 00-69 => 2000-2069, 70-99 => 1970-1999
                year = year < 70 ? 2000 + year : 1900 + year;
                try {
                    const date = new Date(year, month - 1, day);
                    if (date.getDate() === day && date.getMonth() === month - 1) {
                        return date.toISOString().split('T')[0];
                    }
                } catch (e) {}
            }
            
            return null;
        }
        
        function searchUploadPerson(fileId, query) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            const dropdown = document.getElementById(`upload-person-dropdown-${fileId}`);
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = (uploadPeople.people || []).filter(p => 
                p.full_name.toLowerCase().includes(query.toLowerCase()) ||
                p.worker_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(p => `
                <div class="autocomplete-item" onclick="selectUploadPerson('${fileId}', '${p.worker_id}', '${p.full_name}')">
                    ${p.full_name}
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectUploadPerson(fileId, personKey, personName) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.person_key = personKey;
            file.subject_key = personKey;
            file.subject_name = personName;
            document.getElementById(`upload-person-dropdown-${fileId}`).classList.add('hidden');
            renderUploadFiles();
        }
        
        function updateUploadCompany(fileId, companyKey) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            file.company_key = companyKey;
            file.subject_key = companyKey;
            // Si es scope worker, resetear trabajador al cambiar empresa
            if (file.scope === 'worker') {
                file.person_key = null;
                file.subject_name = '';
            }
            renderUploadFiles();
        }
        
        function updateUploadCompanyFromSelect(fileId, companyKey) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            file.company_key = companyKey;
            // Resetear trabajador y actualizar select de trabajadores
            file.person_key = null;
            file.subject_name = '';
            
            // Habilitar select de trabajadores
            const workerSelect = document.getElementById(`upload-worker-select-${fileId}`);
            if (workerSelect) {
                workerSelect.disabled = false;
                workerSelect.setAttribute('data-company-id', companyKey);
                // Repoblar trabajadores
                const workers = uploadSubjects.workers_by_company[companyKey] || [];
                workerSelect.innerHTML = '<option value="">Selecciona un trabajador...</option>' +
                    workers.map(w => `<option value="${escapeHtml(w.id)}">${escapeHtml(w.name)}</option>`).join('');
            }
            
            renderUploadFiles();
        }
        
        function updateUploadWorker(fileId, workerId) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            file.person_key = workerId;
            // Buscar nombre del trabajador
            const companyId = file.company_key || (uploadSubjects.companies.length === 1 ? uploadSubjects.companies[0].id : '');
            const workers = uploadSubjects.workers_by_company[companyId] || [];
            const worker = workers.find(w => w.id === workerId);
            if (worker) {
                file.subject_name = worker.name;
            }
            renderUploadFiles();
        }
        
        function updateUploadPeriod(fileId, periodKey) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.period_key = periodKey;
            renderUploadFiles();
        }
        
        function updateUploadIssueDate(fileId, issueDate) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.issue_date = issueDate || null;
            
            // Si validity_start_mode es "issue_date", actualizar validity_start_date tambi√©n
            const type = uploadTypes.find(t => t.type_id === file.type_id);
            if (type) {
                const validityStartMode = type.validity_start_mode || 'issue_date';
                if (validityStartMode === 'issue_date') {
                    file.validity_start_date = issueDate || null;
                }
            }
            
            // Limpiar errores de fecha si se selecciona una
            if (file.errors) {
                file.errors = file.errors.filter(e => 
                    e !== 'No se pudo extraer fecha del nombre. Selecciona una fecha.' &&
                    e !== 'La fecha de emisi√≥n es obligatoria'
                );
            }
            
            renderUploadFiles(); // Re-render para actualizar el mensaje de ayuda
        }
        
        function updateUploadValidityStartDate(fileId, validityStartDate) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.warn('[repo-upload] updateUploadValidityStartDate: file not found', fileId);
                }
                return;
            }
            
            // Log para diagn√≥stico
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] validity_start_date input changed =>', validityStartDate, '(fileId=' + fileId + ')');
            }
            
            // IMPORTANTE: Guardar el valor RAW (lo que el usuario ve/selecciona)
            // El input type="date" devuelve formato ISO (YYYY-MM-DD), guardar tal cual
            // NO convertir a null si est√° vac√≠o, mantener el valor tal cual
            if (validityStartDate && validityStartDate.trim() !== '') {
                file.validity_start_date = validityStartDate.trim();
            } else {
                // Solo asignar null si realmente est√° vac√≠o (no string vac√≠o)
                file.validity_start_date = null;
            }
            
            // Limpiar errores de fecha de inicio de vigencia
            if (file.errors) {
                file.errors = file.errors.filter(e => 
                    e !== 'La fecha de inicio de vigencia es obligatoria'
                );
            }
            
            // Ocultar mensaje de error si existe
            const errorDiv = document.getElementById(`validity-start-error-${fileId}`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // NO re-renderizar aqu√≠ - solo actualizar el estado
            // El re-render se har√° cuando sea necesario (ej: despu√©s de validar)
        }
        
        // Funciones para valores por defecto
        function populateUploadDefaultsTypeSelect() {
            const select = document.getElementById('upload-default-type-select');
            if (!select) return;
            
            // Filtrar solo tipos activos
            const activeTypes = uploadTypes.filter(t => t.active !== false);
            activeTypes.sort((a, b) => a.name.localeCompare(b.name));
            
            // Limpiar opciones existentes (excepto la primera)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // A√±adir opciones
            activeTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.type_id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        }
        
        function updateUploadDefaultsType(typeId) {
            const type = uploadTypes.find(t => t.type_id === typeId);
            if (!type) {
                uploadFormData.type_id = null;
                uploadFormData.scope = null;
                const subjectGroup = document.getElementById('upload-default-subject-group');
                const periodGroup = document.getElementById('upload-default-period-group');
                if (subjectGroup) subjectGroup.classList.add('hidden');
                if (periodGroup) periodGroup.classList.add('hidden');
                return;
            }
            
            uploadFormData.type_id = typeId;
            uploadFormData.scope = type.scope;
            
            // Mostrar/ocultar campos seg√∫n el tipo
            const subjectGroup = document.getElementById('upload-default-subject-group');
            const periodGroup = document.getElementById('upload-default-period-group');
            
            if (type.scope === 'worker' || type.scope === 'company') {
                if (subjectGroup) {
                    subjectGroup.classList.remove('hidden');
                    updateUploadDefaultsSubject(type.scope, uploadFormData.person_key || uploadFormData.company_key);
                }
            } else {
                if (subjectGroup) subjectGroup.classList.add('hidden');
            }
            
            // Verificar si necesita periodo (derivar period_kind igual que en renderUploadFiles)
            const periodMode = type.validity_policy?.mode || 'none';
            let periodKind = 'none';
            if (periodMode === 'monthly') {
                periodKind = 'month';
            } else if (periodMode === 'annual') {
                periodKind = 'year';
            } else if (periodMode === 'quarter') {
                periodKind = 'quarter';
            } else {
                periodKind = 'none';
            }
            const needsPeriod = periodKind === 'month' || periodKind === 'year' || periodKind === 'quarter';
            
            if (needsPeriod) {
                if (periodGroup) {
                    periodGroup.classList.remove('hidden');
                    updateUploadDefaultsPeriod(uploadFormData.period_key, periodKind);
                }
            } else {
                if (periodGroup) periodGroup.classList.add('hidden');
            }
        }
        
        function updateUploadDefaultsSubject(scope, key) {
            const container = document.getElementById('upload-default-subject-input-container');
            if (!container) return;
            
            if (scope === 'worker') {
                uploadFormData.person_key = key;
                uploadFormData.company_key = null;
                container.innerHTML = `
                    <input type="text" class="form-input" 
                           id="upload-default-person-input"
                           placeholder="Buscar trabajador..."
                           value="${key || ''}"
                           onchange="uploadFormData.person_key = this.value">
                `;
            } else if (scope === 'company') {
                uploadFormData.company_key = key;
                uploadFormData.person_key = null;
                container.innerHTML = `
                    <input type="text" class="form-input" 
                           id="upload-default-company-input"
                           placeholder="Empresa..."
                           value="${key || ''}"
                           onchange="uploadFormData.company_key = this.value">
                `;
            }
        }
        
        function updateUploadDefaultsPeriod(periodKey, periodKind) {
            const container = document.getElementById('upload-default-period-input-container');
            if (!container) return;
            
            uploadFormData.period_key = periodKey;
            
            if (periodKind === 'month') {
                container.innerHTML = `
                    <input type="month" class="form-input" 
                           id="upload-default-period-input"
                           value="${periodKey || ''}"
                           onchange="uploadFormData.period_key = this.value">
                `;
            } else if (periodKind === 'annual') {
                container.innerHTML = `
                    <input type="number" class="form-input" 
                           id="upload-default-period-input"
                           placeholder="YYYY"
                           min="2000" max="2100"
                           value="${periodKey || ''}"
                           onchange="uploadFormData.period_key = this.value">
                `;
            }
        }
        
        function updateUploadDefaultsIssueDate(date) {
            uploadFormData.issue_date = date;
        }
        
        function applyDefaultsToAllFiles() {
            uploadFiles.forEach(file => {
                if (!file.type_id && uploadFormData.type_id) {
                    file.type_id = uploadFormData.type_id;
                    const type = uploadTypes.find(t => t.type_id === uploadFormData.type_id);
                    if (type) {
                        file.scope = type.scope;
                        // Auto-fecha si est√° vac√≠a
                        if (!file.issue_date) {
                            const parsedDate = parseDateFromFilename(file.name, type);
                            if (parsedDate) file.issue_date = parsedDate;
                        }
                    }
                }
                if (!file.person_key && uploadFormData.person_key) {
                    file.person_key = uploadFormData.person_key;
                }
                if (!file.company_key && uploadFormData.company_key) {
                    file.company_key = uploadFormData.company_key;
                }
                if (!file.period_key && uploadFormData.period_key) {
                    file.period_key = uploadFormData.period_key;
                }
                if (!file.issue_date && uploadFormData.issue_date) {
                    file.issue_date = uploadFormData.issue_date;
                }
            });
            renderUploadFiles();
        }
        
        function clearUploadDefaults() {
            uploadFormData = {
                type_id: null,
                scope: null,
                person_key: null,
                company_key: null,
                period_key: null,
                issue_date: null
            };
            const select = document.getElementById('upload-default-type-select');
            if (select) select.value = '';
            const subjectGroup = document.getElementById('upload-default-subject-group');
            const periodGroup = document.getElementById('upload-default-period-group');
            if (subjectGroup) subjectGroup.classList.add('hidden');
            if (periodGroup) periodGroup.classList.add('hidden');
            const issueDateInput = document.getElementById('upload-default-issue-date');
            if (issueDateInput) issueDateInput.value = '';
        }
        
        // Estado global del preview
        let previewState = {
            open: false,
            url: null,
            title: null,
            isBlob: false, // Flag para saber si es blob URL (necesita revoke)
            escListener: null
        };
        
        function previewUploadFile(fileId) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) {
                console.warn('[repo-upload] File not found for preview:', fileId);
                return;
            }
            
            // Verificar que es PDF
            if (file.file && file.file.type !== 'application/pdf') {
                alert('La previsualizaci√≥n solo est√° disponible para archivos PDF.');
                return;
            }
            
            // Revocar URL anterior si existe (evitar doble revoke)
            if (previewState.url && previewState.isBlob) {
                URL.revokeObjectURL(previewState.url);
            }
            
            // Si tiene doc_id (ya guardado), usar endpoint
            let previewUrl = null;
            let isBlob = false;
            if (file.doc_id) {
                previewUrl = `${BACKEND_URL}/api/repository/docs/${file.doc_id}/pdf`;
                isBlob = false;
            } else if (file.file) {
                // Archivo local: crear Object URL
                previewUrl = URL.createObjectURL(file.file);
                isBlob = true;
            } else {
                alert('No se puede previsualizar: el archivo no est√° disponible.');
                return;
            }
            
            // Abrir modal
            const modal = document.getElementById('upload-preview-modal');
            const object = document.getElementById('preview-object');
            const fallbackLink = document.getElementById('preview-fallback-link');
            const downloadBtn = document.getElementById('preview-download-btn');
            const titleEl = document.getElementById('preview-modal-title');
            
            if (!modal || !object) {
                console.error('[repo-upload] Preview modal elements not found');
                return;
            }
            
            // Actualizar estado
            previewState.open = true;
            previewState.url = previewUrl;
            previewState.title = file.name || 'Documento';
            previewState.isBlob = isBlob;
            
            // Configurar modal
            titleEl.textContent = previewState.title;
            object.data = previewUrl; // Usar object.data en lugar de iframe.src
            fallbackLink.href = previewUrl;
            fallbackLink.download = file.name || 'documento.pdf';
            
            // Configurar bot√≥n de descarga
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = previewUrl;
                    a.download = file.name || 'documento.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            
            // Bloquear scroll del fondo
            document.body.style.overflow = 'hidden';
            
            // Listener para Esc (a√±adir solo una vez)
            if (!previewState.escListener) {
                previewState.escListener = (e) => {
                    if (e.key === 'Escape' && previewState.open) {
                        closePreviewModal();
                    }
                };
                document.addEventListener('keydown', previewState.escListener);
            }
        }
        
        function openPreviewInNewTab() {
            if (previewState.url) {
                window.open(previewState.url, '_blank', 'noopener');
            }
        }
        
        function downloadPreview() {
            if (previewState.url && previewState.title) {
                const a = document.createElement('a');
                a.href = previewState.url;
                a.download = previewState.title;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
        
        function closePreviewModal() {
            const modal = document.getElementById('upload-preview-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Limpiar object (evita que siga cargando)
            const object = document.getElementById('preview-object');
            if (object) {
                object.data = 'about:blank';
            }
            
            // Revocar Object URL si es blob (evita memory leak)
            if (previewState.url && previewState.isBlob) {
                URL.revokeObjectURL(previewState.url);
            }
            
            // Resetear estado
            previewState.open = false;
            previewState.url = null;
            previewState.title = null;
            previewState.isBlob = false;
            
            // Restaurar scroll del fondo
            document.body.style.overflow = '';
        }
        
        function removeUploadFile(fileId) {
            uploadFiles = uploadFiles.filter(f => f.id !== fileId);
            renderUploadFiles();
        }
        
        function clearAllUploadFiles() {
            if (confirm('¬øEliminar todos los archivos de la cola?')) {
                // Reset SOLO del estado (NO tocar listeners)
                uploadFiles = [];
                
                // Reset del file input (importante: si no se resetea, puede quedar "muerto")
                const fileInput = document.getElementById('file-input');
                if (fileInput) {
                    fileInput.value = ''; // Limpiar valor del input
                }
                
                // Re-render para limpiar el DOM (solo actualiza cards, no toca dropzone/input)
                renderUploadFiles();
                
                // NO llamar a setupUploadZone() - los listeners ya est√°n instalados y son estables
                // Si el DOM se recre√≥ completamente, loadSubir() los reinstalar√° autom√°ticamente
                
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] clearAllUploadFiles: reset estado', {
                        uploadFilesLength: uploadFiles.length,
                        fileInputExists: !!fileInput,
                        fileInputValue: fileInput?.value || 'N/A'
                    });
                }
            }
        }
        
        let duplicateModalData = null;
        
        // Funci√≥n auxiliar para convertir fecha a ISO (YYYY-MM-DD)
        function toISODate(value) {
            if (!value) return null;
            
            // Si ya es ISO (YYYY-MM-DD), retornar tal cual
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return value;
            }
            
            // Si es formato DD/MM/YYYY, convertir
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                const [day, month, year] = value.split('/');
                return `${year}-${month}-${day}`;
            }
            
            // Intentar parsear como Date y convertir a ISO
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.warn('[repo-upload] Error parsing date:', value, e);
            }
            
            return null;
        }
        
        async function saveAllUploadFiles() {
            if (uploadFiles.length === 0) {
                alert('No hay archivos para guardar. Por favor, arrastra o selecciona al menos un archivo PDF.');
                return;
            }
            
            // IMPORTANTE: Leer valores desde los inputs del DOM ANTES de validar
            // Esto asegura que capturamos cualquier valor que el usuario haya escrito
            // pero que no se haya guardado en el estado (por ejemplo, si escribi√≥ pero no hizo blur)
            for (const file of uploadFiles) {
                const validityInput = document.getElementById(`upload-validity-start-date-${file.id}`);
                if (validityInput && validityInput.value) {
                    // Si el input tiene un valor que no est√° en el estado, actualizarlo
                    if (validityInput.value !== file.validity_start_date) {
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.log('[repo-upload] Syncing validity_start_date from DOM:', validityInput.value, 'to state for fileId=' + file.id);
                        }
                        file.validity_start_date = validityInput.value;
                    }
                }
            }
            
            // Validar antes de enviar (incluyendo validity_start_date)
            for (const file of uploadFiles) {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] beforeValidate fileId=' + file.id, 'validity_start_date=' + file.validity_start_date);
                }
                
                const type = uploadTypes.find(t => t.type_id === file.type_id);
                if (type) {
                    const validityStartMode = type.validity_start_mode || 'issue_date';
                    
                    // Si validity_start_mode es 'manual', validity_start_date es obligatorio
                    if (validityStartMode === 'manual') {
                        // IMPORTANTE: NO mutar file.validity_start_date aqu√≠
                        // Solo validar si est√° vac√≠o o no es v√°lido
                        const validityStartDateISO = toISODate(file.validity_start_date);
                        if (!validityStartDateISO) {
                            // Marcar error en el card (NO mutar el valor)
                            if (!file.errors) file.errors = [];
                            if (!file.errors.includes('La fecha de inicio de vigencia es obligatoria')) {
                                file.errors.push('La fecha de inicio de vigencia es obligatoria');
                            }
                        }
                    }
                }
            }
            
            // Validate
            const invalidFiles = uploadFiles.filter(f => f.errors && f.errors.length > 0);
            if (invalidFiles.length > 0) {
                // Log despu√©s de validar
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] Validation failed, invalidFiles:', invalidFiles.map(f => ({
                        id: f.id,
                        name: f.name,
                        validity_start_date: f.validity_start_date,
                        errors: f.errors
                    })));
                }
                
                // Re-render para mostrar errores, pero CONSERVANDO los valores del estado
                renderUploadFiles();
                
                // Mostrar mensaje con m√°s contexto
                const errorMessages = invalidFiles.map(f => {
                    const errors = f.errors || [];
                    return `${f.name}: ${errors.join(', ')}`;
                }).join('\n');
                
                alert(`Hay ${invalidFiles.length} archivo(s) con errores:\n\n${errorMessages}\n\nPor favor, corr√≠gelos antes de guardar.`);
                
                // Log despu√©s del alert (para verificar que el estado persiste)
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    for (const file of invalidFiles) {
                        console.log('[repo-upload] afterFail fileId=' + file.id, 'validity_start_date=' + file.validity_start_date);
                    }
                }
                
                return;
            }
            
            const savedDocs = [];
            const errors = [];
            
            for (const file of uploadFiles) {
                try {
                    // Si hay replace_doc_id, reemplazar PDF directamente
                    if (window.replaceDocId) {
                        const formData = new FormData();
                        formData.append('file', file.file);
                        
                        const response = await fetch(`${BACKEND_URL}/api/repository/docs/${window.replaceDocId}/pdf`, {
                            method: 'PUT',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error(await response.text());
                        }
                        
                        const doc = await response.json();
                        savedDocs.push(doc);
                        
                        // Limpiar replace_doc_id despu√©s del primer archivo
                        delete window.replaceDocId;
                        continue;
                    }
                    
                    // Check duplicate
                    const existing = await checkUploadDuplicate(file);
                    if (existing) {
                        duplicateModalData = { file, existing, action: null };
                        showDuplicateModal(file, existing);
                        await new Promise(resolve => {
                            const checkInterval = setInterval(() => {
                                if (duplicateModalData.action) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        });
                        
                        if (duplicateModalData.action === 'cancel') continue;
                        // If replace or version, continue
                    }
                    
                    // Upload
                    // Debug: log payload antes de enviar (sin el binario)
                    if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                        console.log('[repo-upload] Payload for file:', file.name, {
                            type_id: file.type_id,
                            scope: file.scope,
                            company_key: file.company_key,
                            person_key: file.person_key,
                            period_key: file.period_key,
                            issue_date: file.issue_date,
                            validity_start_date: file.validity_start_date
                        });
                    }
                    
                    // IMPORTANTE: Leer valor desde el input del DOM una vez m√°s antes de enviar
                    // (por si el usuario cambi√≥ algo despu√©s de la validaci√≥n)
                    const validityInput = document.getElementById(`upload-validity-start-date-${file.id}`);
                    if (validityInput && validityInput.value && validityInput.value !== file.validity_start_date) {
                        file.validity_start_date = validityInput.value;
                    }
                    
                    // Obtener tipo para determinar validity_start_mode
                    const type = uploadTypes.find(t => t.type_id === file.type_id);
                    const validityStartMode = type?.validity_start_mode || 'issue_date';
                    
                    // Convertir validity_start_date a ISO si existe
                    let validityStartDateISO = null;
                    if (file.validity_start_date) {
                        validityStartDateISO = toISODate(file.validity_start_date);
                        
                        // Log para diagn√≥stico
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.log('[repo-upload] payload validity_start_date for fileId=' + file.id, {
                                raw: file.validity_start_date,
                                iso: validityStartDateISO
                            });
                        }
                    } else if (validityStartMode === 'issue_date' && file.issue_date) {
                        // Si es issue_date mode, usar issue_date como validity_start_date
                        validityStartDateISO = toISODate(file.issue_date);
                    }
                    
                    const formData = new FormData();
                    formData.append('file', file.file);
                    formData.append('type_id', file.type_id); // Asegurar que se env√≠a type_id (no name)
                    formData.append('scope', file.scope);
                    formData.append('validity_start_mode', validityStartMode); // SIEMPRE enviar validity_start_mode
                    if (file.company_key) formData.append('company_key', file.company_key);
                    if (file.person_key) formData.append('person_key', file.person_key);
                    if (file.period_key) formData.append('period_key', file.period_key);
                    if (file.issue_date) {
                        const issueDateISO = toISODate(file.issue_date);
                        if (issueDateISO) formData.append('issue_date', issueDateISO);
                    }
                    // SIEMPRE enviar validity_start_date si existe o si es obligatorio
                    if (validityStartDateISO) {
                        formData.append('validity_start_date', validityStartDateISO);
                    } else if (validityStartMode === 'manual') {
                        // Si es manual y no hay fecha, enviar vac√≠o (el backend validar√°)
                        formData.append('validity_start_date', '');
                    }
                    
                    const response = await fetch(`${BACKEND_URL}/api/repository/docs/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    
                    const doc = await response.json();
                    savedDocs.push(doc);
                    
                } catch (error) {
                    errors.push({ file: file.name, error: error.message });
                }
            }
            
            if (errors.length > 0) {
                alert(`Guardados: ${savedDocs.length}\nErrores: ${errors.length}\n\n${errors.map(e => `${e.file}: ${e.error}`).join('\n')}`);
            } else {
                alert(`¬°Guardados ${savedDocs.length} documento(s) exitosamente!`);
                uploadFiles = [];
                renderUploadFiles();
                navigateTo('calendario');
            }
        }
        
        async function checkUploadDuplicate(file) {
            const params = new URLSearchParams({ type_id: file.type_id });
            if (file.company_key) params.append('company_key', file.company_key);
            if (file.person_key) params.append('person_key', file.person_key);
            
            const response = await fetch(`${BACKEND_URL}/api/repository/docs?${params}`);
            const docs = await response.json();
            
            if (file.period_key) {
                const matching = docs.filter(d => d.period_key === file.period_key);
                return matching.length > 0 ? matching[0] : null;
            }
            
            return docs.length > 0 ? docs[0] : null;
        }
        
        function showDuplicateModal(file, existing) {
            const modal = document.getElementById('upload-duplicate-modal');
            const message = document.getElementById('duplicate-modal-message');
            const period = file.period_key ? formatMonth(file.period_key) : '';
            message.textContent = `Ya existe un documento para este tipo${period ? ` (${period})` : ''}. ¬øQu√© deseas hacer?`;
            modal.classList.remove('hidden');
        }
        
        function closeDuplicateModal() {
            if (duplicateModalData) {
                duplicateModalData.action = 'cancel';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        function saveAsVersion() {
            if (duplicateModalData) {
                duplicateModalData.action = 'version';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        function confirmReplace() {
            if (duplicateModalData) {
                duplicateModalData.action = 'replace';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        // Buscar documentos - Variables globales (sistema similar al cat√°logo)
        let searchDocs = [];
        let searchTypes = [];
        let searchPeople = [];
        let searchSubjects = { companies: [], workers_by_company: {} };
        let searchFilters = {
            query: '',
            type_id: null,
            subject_key: null,
            scope: null,
            status: null,
            sort: 'date_desc',
            page: 1,
            page_size: 20
        };
        
        async function loadBuscar(params = {}) {
            dbg('loadBuscar: start', params);
            const content = document.getElementById('page-content');
            
            // Ensure data is loaded
            await ensureRepoDataLoaded({ types: true, people: true });
            
            try {
                // Load data if not already loaded
                if (searchTypes.length === 0) {
                    searchTypes = await fetch(`${BACKEND_URL}/api/repository/types?active=true`).then(r => r.json());
                }
                const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
                searchPeople = peopleData.people || [];
                
                // Load subjects (companies + workers)
                try {
                    const subjectsResponse = await fetch(`${BACKEND_URL}/api/repository/subjects`);
                    if (subjectsResponse.ok) {
                        searchSubjects = await subjectsResponse.json();
                    }
                } catch (error) {
                    console.warn('[repo-search] Failed to load subjects:', error);
                }
                
                // Reset filters if not in params
                if (!params.type_id && !params.subject_key) {
                    searchFilters = {
                        query: '',
                        type_id: null,
                        subject_key: null,
                        scope: null,
                        status: null,
                        sort: 'date_desc',
                        page: 1,
                        page_size: 20
                    };
                } else {
                    // Apply params
                    if (params.type_id) searchFilters.type_id = params.type_id;
                    if (params.subject_key) searchFilters.subject_key = params.subject_key;
                    if (params.scope) searchFilters.scope = params.scope;
                }
                
                content.innerHTML = `
                    <div class="catalog-toolbar">
                        <div>
                            <h2 style="display: inline; margin-right: 16px;">Buscar documentos</h2>
                            <span class="catalog-results-info" id="search-results-info">
                                Mostrando 0 documentos
                            </span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="catalog-filters">
                            <div class="form-group">
                                <label class="form-label">Buscar</label>
                                <input type="text" class="form-input" 
                                       id="search-docs-query"
                                       placeholder="Buscar por nombre de archivo, tipo, o palabras..."
                                       value="${searchFilters.query}"
                                       oninput="debounceSearchDocs(this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo de documento</label>
                                <select class="form-input" id="search-docs-type-select" onchange="setSearchDocsFilter('type_id', this.value || null)">
                                    <option value="">Todos los tipos</option>
                                    ${searchTypes.sort((a, b) => a.name.localeCompare(b.name)).map(type => `
                                        <option value="${type.type_id}" ${searchFilters.type_id === type.type_id ? 'selected' : ''}>${type.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aplica a</label>
                                <div>
                                    <span class="filter-chip ${searchFilters.scope === null ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('scope', null)">Todos</span>
                                    <span class="filter-chip ${searchFilters.scope === 'worker' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('scope', 'worker')">Trabajador</span>
                                    <span class="filter-chip ${searchFilters.scope === 'company' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('scope', 'company')">Empresa</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sujeto</label>
                                <select class="form-input" id="search-docs-subject-select" onchange="setSearchDocsFilter('subject_key', this.value || null)">
                                    <option value="">Todos</option>
                                    ${(() => {
                                        let options = [];
                                        // Empresas
                                        searchSubjects.companies?.forEach(company => {
                                            options.push(`<option value="${company.id}" ${searchFilters.subject_key === company.id ? 'selected' : ''}>${company.name}</option>`);
                                        });
                                        // Trabajadores
                                        Object.keys(searchSubjects.workers_by_company || {}).forEach(companyId => {
                                            const workers = searchSubjects.workers_by_company[companyId];
                                            workers.forEach(worker => {
                                                options.push(`<option value="${worker.id}" ${searchFilters.subject_key === worker.id ? 'selected' : ''}>${worker.name}</option>`);
                                            });
                                        });
                                        return options.join('');
                                    })()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <div>
                                    <span class="filter-chip ${searchFilters.status === null ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', null)">Todos</span>
                                    <span class="filter-chip ${searchFilters.status === 'VALID' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', 'VALID')">V√°lido</span>
                                    <span class="filter-chip ${searchFilters.status === 'EXPIRED' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', 'EXPIRED')">Expirado</span>
                                    <span class="filter-chip ${searchFilters.status === 'EXPIRING_SOON' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', 'EXPIRING_SOON')">Expira pronto</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ordenar por</label>
                                <select class="form-input" id="search-docs-sort" onchange="setSearchDocsFilter('sort', this.value)">
                                    <option value="date_desc" ${searchFilters.sort === 'date_desc' ? 'selected' : ''}>Fecha (m√°s reciente)</option>
                                    <option value="date_asc" ${searchFilters.sort === 'date_asc' ? 'selected' : ''}>Fecha (m√°s antiguo)</option>
                                    <option value="type" ${searchFilters.sort === 'type' ? 'selected' : ''}>Tipo A‚ÜíZ</option>
                                    <option value="subject" ${searchFilters.sort === 'subject' ? 'selected' : ''}>Sujeto A‚ÜíZ</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-secondary" onclick="clearSearchDocsFilters()">Limpiar filtros</button>
                        </div>
                        
                        <div id="search-results-container">
                            <p style="color: #94a3b8;">Usa los filtros para buscar documentos</p>
                        </div>
                    </div>
                `;
                
                // Load initial results
                await performSearch();
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar b√∫squeda: ${error.message}</div>`;
            }
        }
        
        // Funciones de filtrado (similar al cat√°logo)
        let searchDocsTimeout;
        function debounceSearchDocs(query) {
            clearTimeout(searchDocsTimeout);
            searchDocsTimeout = setTimeout(() => {
                searchFilters.query = query;
                searchFilters.page = 1;
                performSearch();
            }, 300);
        }
        
        function setSearchDocsFilter(key, value) {
            searchFilters[key] = value;
            searchFilters.page = 1;
            performSearch();
        }
        
        function clearSearchDocsFilters() {
            searchFilters = {
                query: '',
                type_id: null,
                subject_key: null,
                scope: null,
                status: null,
                sort: 'date_desc',
                page: 1,
                page_size: 20
            };
            const queryInput = document.getElementById('search-docs-query');
            const typeSelect = document.getElementById('search-docs-type-select');
            const subjectSelect = document.getElementById('search-docs-subject-select');
            const sortSelect = document.getElementById('search-docs-sort');
            
            if (queryInput) queryInput.value = '';
            if (typeSelect) typeSelect.value = '';
            if (subjectSelect) subjectSelect.value = '';
            if (sortSelect) sortSelect.value = 'date_desc';
            
            performSearch();
        }
        
        function updateSearchResultsInfo() {
            const info = document.getElementById('search-results-info');
            if (info) {
                info.textContent = `Mostrando ${searchDocs.length} documento${searchDocs.length !== 1 ? 's' : ''}`;
            }
        }
        
        // Funciones legacy (mantener para compatibilidad, pero no usadas)
        function searchDocsType(query) {
            const dropdown = document.getElementById('search-docs-type-dropdown');
            if (!dropdown) return;
            
            if (!query || query.trim() === '') {
                dropdown.classList.add('hidden');
                searchDocsTypeSelectedIndex = -1;
                searchDocsTypeMatches = [];
                return;
            }
            
            const queryNormalized = normalizeString(query);
            searchDocsTypeMatches = searchTypes.filter(t => {
                const nameNorm = normalizeString(t.name);
                const idNorm = normalizeString(t.type_id);
                return nameNorm.includes(queryNormalized) || idNorm.includes(queryNormalized);
            }).slice(0, 10);
            
            searchDocsTypeSelectedIndex = -1;
            
            if (searchDocsTypeMatches.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color: #94a3b8; padding: 8px;">No se encontraron tipos</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            dropdown.innerHTML = searchDocsTypeMatches.map((t, idx) => `
                <div class="autocomplete-item ${idx === 0 ? 'selected' : ''}" 
                     data-index="${idx}"
                     data-type-id="${t.type_id}"
                     onclick="selectSearchDocsType('${t.type_id}')"
                     onmouseenter="highlightSearchDocsTypeItem(${idx})">
                    ${t.name} <span style="color: #94a3b8;">(${t.type_id})</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function highlightSearchDocsTypeItem(index) {
            const dropdown = document.getElementById('search-docs-type-dropdown');
            if (!dropdown) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, idx) => {
                if (idx === index) {
                    item.classList.add('selected');
                    searchDocsTypeSelectedIndex = index;
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function handleSearchDocsTypeKeydown(event) {
            const dropdown = document.getElementById('search-docs-type-dropdown');
            if (!dropdown || dropdown.classList.contains('hidden')) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item[data-type-id]');
            if (items.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                searchDocsTypeSelectedIndex = Math.min(searchDocsTypeSelectedIndex + 1, items.length - 1);
                items.forEach((item, idx) => {
                    if (idx === searchDocsTypeSelectedIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                searchDocsTypeSelectedIndex = Math.max(searchDocsTypeSelectedIndex - 1, -1);
                items.forEach((item, idx) => {
                    if (idx === searchDocsTypeSelectedIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (searchDocsTypeSelectedIndex >= 0 && searchDocsTypeSelectedIndex < items.length) {
                    const typeId = items[searchDocsTypeSelectedIndex].getAttribute('data-type-id');
                    selectSearchDocsType(typeId);
                }
            } else if (event.key === 'Escape') {
                dropdown.classList.add('hidden');
                searchDocsTypeSelectedIndex = -1;
            }
        }
        
        function handleSearchDocsTypeBlur(value) {
            setTimeout(() => {
                if (!value || value.trim() === '') {
                    searchFilters.type_id = null;
                    return;
                }
                
                const exactMatch = searchTypes.find(t => {
                    const nameNorm = normalizeString(t.name);
                    const idNorm = normalizeString(t.type_id);
                    const valueNorm = normalizeString(value);
                    return nameNorm === valueNorm || idNorm === valueNorm;
                });
                
                if (exactMatch) {
                    selectSearchDocsType(exactMatch.type_id);
                } else {
                    searchFilters.type_id = null;
                    const input = document.getElementById('search-docs-type-input');
                    if (input) input.value = '';
                }
            }, 200);
        }
        
        function selectSearchDocsType(typeId) {
            const type = searchTypes.find(t => t.type_id === typeId);
            if (type) {
                searchFilters.type_id = typeId;
                searchFilters.scope = type.scope;
                const input = document.getElementById('search-docs-type-input');
                if (input) input.value = type.name;
            }
            
            document.getElementById('search-docs-type-dropdown').classList.add('hidden');
            searchDocsTypeSelectedIndex = -1;
        }
        
        function updateSearchQuery(value) {
            searchFilters.query = value || '';
        }
        
        function updateSearchSubject(value) {
            searchFilters.subject_key = value || null;
        }
        
        // Funci√≥n legacy (mantener para compatibilidad)
        function clearSearchFilters() {
            clearSearchDocsFilters();
        }
        
        async function performSearch() {
            const container = document.getElementById('search-results-container');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Buscando...</div>';
            
            try {
                // Build query params
                const params = new URLSearchParams();
                if (searchFilters.type_id) {
                    params.append('type_id', searchFilters.type_id);
                }
                if (searchFilters.scope) {
                    params.append('scope', searchFilters.scope);
                }
                
                // Fetch all documents (backend doesn't support query filter yet, so we filter client-side)
                const response = await fetch(`${BACKEND_URL}/api/repository/docs?${params}`);
                let docs = await response.json();
                if (!Array.isArray(docs)) docs = [];
                
                // Client-side filtering
                if (searchFilters.query) {
                    const queryNorm = normalizeString(searchFilters.query);
                    docs = docs.filter(doc => {
                        // FIX: Usar file_name_original del modelo DocumentInstanceV1
                        const fileName = normalizeString(doc.file_name_original || doc.doc_file_name || '');
                        const type = searchTypes.find(t => t.type_id === doc.type_id);
                        const typeName = type ? normalizeString(type.name) : '';
                        const typeId = type ? normalizeString(type.type_id) : '';
                        return fileName.includes(queryNorm) || 
                               typeName.includes(queryNorm) || 
                               typeId.includes(queryNorm);
                    });
                }
                
                if (searchFilters.subject_key) {
                    docs = docs.filter(doc => {
                        return doc.person_key === searchFilters.subject_key || 
                               doc.company_key === searchFilters.subject_key;
                    });
                }
                
                if (searchFilters.status) {
                    docs = docs.filter(doc => {
                        const status = doc.computed_validity?.status || 'UNKNOWN';
                        return status === searchFilters.status;
                    });
                }
                
                // Sorting
                docs.sort((a, b) => {
                    switch (searchFilters.sort) {
                        case 'date_desc':
                            const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return dateB - dateA;
                        case 'date_asc':
                            const dateA2 = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB2 = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return dateA2 - dateB2;
                        case 'type':
                            const typeA = searchTypes.find(t => t.type_id === a.type_id);
                            const typeB = searchTypes.find(t => t.type_id === b.type_id);
                            const nameA = typeA ? typeA.name : a.type_id || '';
                            const nameB = typeB ? typeB.name : b.type_id || '';
                            return nameA.localeCompare(nameB);
                        case 'subject':
                            const subjectA = a.person_key || a.company_key || '';
                            const subjectB = b.person_key || b.company_key || '';
                            return subjectA.localeCompare(subjectB);
                        default:
                            return 0;
                    }
                });
                
                searchDocs = docs;
                renderSearchResults();
                updateSearchResultsInfo();
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Error al buscar: ${error.message}</div>`;
            }
        }
        
        function renderSearchResults() {
            const container = document.getElementById('search-results-container');
            if (!container) return;
            
            if (searchDocs.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8;">No se encontraron documentos con los filtros seleccionados</p>';
                updateSearchResultsInfo();
                return;
            }
            
            container.innerHTML = `
                <div class="table-container" style="max-height: calc(100vh - 500px); overflow-y: auto;">
                    <table class="catalog-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Sujeto</th>
                                <th>Archivo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${searchDocs.map(doc => {
                                // FIX: Manejar documentos antiguos que pueden tener 'id' en lugar de 'doc_id'
                                const docId = doc.doc_id || doc.id || '';
                                if (!docId) {
                                    console.warn('[repo-search] Documento sin ID:', doc);
                                    return `<tr><td colspan="6" style="color: #fca5a5;">Documento sin ID (formato antiguo)</td></tr>`;
                                }
                                
                                const type = searchTypes.find(t => t.type_id === doc.type_id);
                                const typeName = type ? type.name : doc.type_id;
                                
                                let subjectName = doc.person_key || doc.company_key || '-';
                                if (doc.person_key) {
                                    // Buscar en workers_by_company
                                    let found = false;
                                    Object.keys(searchSubjects.workers_by_company || {}).forEach(companyId => {
                                        const workers = searchSubjects.workers_by_company[companyId];
                                        const worker = workers.find(w => w.id === doc.person_key);
                                        if (worker) {
                                            subjectName = worker.name;
                                            found = true;
                                        }
                                    });
                                    if (!found) {
                                        const person = searchPeople.find(p => p.worker_id === doc.person_key);
                                        if (person) subjectName = person.full_name;
                                    }
                                } else if (doc.company_key) {
                                    const company = searchSubjects.companies?.find(c => c.id === doc.company_key);
                                    if (company) subjectName = company.name;
                                }
                                
                                const status = doc.computed_validity?.status || 'UNKNOWN';
                                const statusBadge = status === 'VALID' ? 'badge-ok' : 
                                                   status === 'EXPIRED' ? 'badge-error' : 
                                                   status === 'EXPIRING_SOON' ? 'badge-warning' : 'badge-info';
                                const statusText = status === 'VALID' ? 'V√°lido' : 
                                                  status === 'EXPIRED' ? 'Expirado' : 
                                                  status === 'EXPIRING_SOON' ? 'Expira pronto' : 'Desconocido';
                                
                                const createdDate = doc.created_at ? new Date(doc.created_at).toLocaleDateString('es-ES') : '-';
                                // FIX: Usar file_name_original del modelo DocumentInstanceV1
                                const fileName = doc.file_name_original || doc.doc_file_name || docId.substring(0, 8) || '-';
                                const escapedDocId = docId.replace(/'/g, "\\'");
                                const escapedFileName = fileName.replace(/'/g, "\\'");
                                
                                return `
                                    <tr>
                                        <td>${createdDate}</td>
                                        <td>
                                            <strong>${typeName}</strong>
                                            ${type ? `<div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${doc.type_id}</div>` : ''}
                                        </td>
                                        <td>${subjectName}</td>
                                        <td>${fileName}</td>
                                        <td><span class="badge ${statusBadge}">${statusText}</span></td>
                                        <td>
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="btn btn-secondary btn-sm" 
                                                        onclick="viewDocumentFromSearch('${escapedDocId}')"
                                                        title="Ver/Descargar PDF">
                                                    Ver PDF
                                                </button>
                                                ${type ? `
                                                    <button class="btn btn-secondary btn-sm" 
                                                            onclick="navigateToCalendarFromSearch('${doc.type_id}', '${doc.scope}', '${doc.person_key || ''}', '${doc.company_key || ''}')">
                                                        Ver calendario
                                                    </button>
                                                ` : ''}
                                                <button class="btn btn-secondary btn-sm" 
                                                        onclick="resubmitDocumentFromSearch('${escapedDocId}', '${doc.type_id || ''}', '${doc.scope || ''}')"
                                                        title="Reemplazar el PDF de este documento">
                                                    Resubir
                                                </button>
                                                <button class="btn btn-secondary btn-sm" 
                                                        onclick="editDocumentFromSearch('${escapedDocId}')">
                                                    Editar
                                                </button>
                                                <button class="btn btn-secondary btn-sm" 
                                                        style="color: #ef4444;"
                                                        onclick="deleteDocumentFromSearch('${escapedDocId}', '${escapedFileName}')"
                                                        ${doc.status === 'submitted' ? 'disabled title="No se puede eliminar un documento con estado submitted"' : ''}>
                                                    Eliminar
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            updateSearchResultsInfo();
        }
        
        function navigateToCalendarFromSearch(typeId, scope, personKey, companyKey) {
            const params = { type_id: typeId };
            if (personKey) params.person_key = personKey;
            if (companyKey) params.company_key = companyKey;
            navigateTo('calendario', params);
        }
        
        // Variables para edici√≥n de documentos
        let editingDocument = null;
        
        async function editDocumentFromSearch(docId) {
            try {
                console.log('[editDocumentFromSearch] docId:', docId);
                // FIX: Buscar el documento en searchDocs (puede tener doc_id o id)
                let doc = searchDocs.find(d => (d.doc_id || d.id) === docId);
                console.log('[editDocumentFromSearch] doc from searchDocs:', doc);
                if (!doc) {
                    // Si no est√° en la lista, cargarlo desde el backend usando el endpoint espec√≠fico
                    console.log('[editDocumentFromSearch] Loading from backend...');
                    const response = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Intentar cargar todos los documentos y buscar
                            const allDocsResponse = await fetch(`${BACKEND_URL}/api/repository/docs`);
                            if (allDocsResponse.ok) {
                                const allDocs = await allDocsResponse.json();
                                doc = allDocs.find(d => (d.doc_id || d.id) === docId);
                            }
                        }
                        if (!doc) {
                            throw new Error('Documento no encontrado');
                        }
                    } else {
                        doc = await response.json();
                    }
                    console.log('[editDocumentFromSearch] doc from backend:', doc);
                }
                
                if (!doc) {
                    alert('Error: Documento no encontrado');
                    return;
                }
                
                // Normalizar doc_id (puede venir como 'id' en documentos antiguos)
                if (!doc.doc_id && doc.id) {
                    doc.doc_id = doc.id;
                }
                
                if (!doc.doc_id) {
                    alert('Error: El documento no tiene ID v√°lido');
                    return;
                }
                
                editingDocument = doc;
                
                // Asegurar que los tipos est√°n cargados
                if (searchTypes.length === 0) {
                    console.log('[editDocumentFromSearch] Loading types...');
                    try {
                        const typesResponse = await fetch(`${BACKEND_URL}/api/repository/types?active=true`);
                        if (typesResponse.ok) {
                            const typesData = await typesResponse.json();
                            searchTypes = Array.isArray(typesData) ? typesData : (typesData.items || []);
                            console.log('[editDocumentFromSearch] Loaded types:', searchTypes.length);
                        }
                    } catch (e) {
                        console.error('[editDocumentFromSearch] Error loading types:', e);
                    }
                }
                
                // Obtener el tipo del documento
                const type = searchTypes.find(t => t.type_id === doc.type_id);
                console.log('[editDocumentFromSearch] type:', type, 'type_id:', doc.type_id, 'available types:', searchTypes.map(t => t.type_id));
                if (!type) {
                    alert(`Tipo de documento no encontrado: ${doc.type_id}. Tipos disponibles: ${searchTypes.map(t => t.type_id).join(', ')}`);
                    return;
                }
                
                // Crear y mostrar modal de edici√≥n
                console.log('[editDocumentFromSearch] Showing modal...');
                showEditDocumentModal(editingDocument, type);
            } catch (error) {
                console.error('[editDocumentFromSearch] Error:', error);
                alert(`Error al cargar documento: ${error.message}`);
            }
        }
        
        function showEditDocumentModal(doc, type) {
            // Escapar valores para HTML
            const typeName = escapeHtml(type.name || '');
            const typeId = escapeHtml(doc.type_id || '');
            // FIX: Usar file_name_original del modelo DocumentInstanceV1
            const fileName = escapeHtml(doc.file_name_original || doc.doc_file_name || doc.doc_id || '');
            
            // Crear modal HTML
            const modalHTML = `
                <div class="modal-overlay" id="edit-doc-modal-overlay" onclick="closeEditDocumentModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Editar documento</h3>
                            <button class="btn btn-secondary" onclick="closeEditDocumentModal()" style="padding: 4px 12px; position: absolute; top: 24px; right: 24px;">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Tipo de documento</label>
                                <input type="text" class="form-input" value="${typeName}" disabled>
                                <div class="form-help" style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${typeId}</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Archivo</label>
                                <input type="text" class="form-input" value="${fileName}" disabled>
                            </div>
                            ${type.scope === 'company' ? `
                                <div class="form-group">
                                    <label class="form-label">Empresa <span class="form-required">*</span></label>
                                    <select class="form-input" id="edit-doc-company">
                                        <option value="">Selecciona una empresa</option>
                                        ${searchSubjects.companies?.map(company => `
                                            <option value="${company.id}" ${doc.company_key === company.id ? 'selected' : ''}>${company.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            ${type.scope === 'worker' ? `
                                <div class="form-group">
                                    <label class="form-label">Empresa <span class="form-required">*</span></label>
                                    <select class="form-input" id="edit-doc-company" onchange="updateEditDocWorkers()">
                                        <option value="">Selecciona una empresa</option>
                                        ${searchSubjects.companies?.map(company => `
                                            <option value="${company.id}" ${doc.company_key === company.id ? 'selected' : ''}>${company.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Trabajador <span class="form-required">*</span></label>
                                    <select class="form-input" id="edit-doc-worker">
                                        <option value="">Selecciona un trabajador</option>
                                        ${(() => {
                                            let options = '';
                                            const selectedCompanyId = doc.company_key;
                                            if (selectedCompanyId && searchSubjects.workers_by_company[selectedCompanyId]) {
                                                searchSubjects.workers_by_company[selectedCompanyId].forEach(worker => {
                                                    options += `<option value="${worker.id}" ${doc.person_key === worker.id ? 'selected' : ''}>${worker.name}</option>`;
                                                });
                                            }
                                            return options;
                                        })()}
                                    </select>
                                </div>
                            ` : ''}
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select class="form-input" id="edit-doc-status">
                                    <option value="draft" ${doc.status === 'draft' ? 'selected' : ''}>Borrador</option>
                                    <option value="reviewed" ${doc.status === 'reviewed' ? 'selected' : ''}>Revisado</option>
                                    <option value="ready_to_submit" ${doc.status === 'ready_to_submit' ? 'selected' : ''}>Listo para enviar</option>
                                    <option value="submitted" ${doc.status === 'submitted' ? 'selected' : ''}>Enviado</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeEditDocumentModal()">Cancelar</button>
                            <button class="btn btn-primary" onclick="saveDocumentEdit()">Guardar</button>
                        </div>
                    </div>
                </div>
            `;
            
            // A√±adir modal al body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
            
            // Actualizar lista de trabajadores si es necesario
            if (type.scope === 'worker') {
                updateEditDocWorkers();
            }
        }
        
        function updateEditDocWorkers() {
            const companySelect = document.getElementById('edit-doc-company');
            const workerSelect = document.getElementById('edit-doc-worker');
            if (!companySelect || !workerSelect) return;
            
            const companyId = companySelect.value;
            workerSelect.innerHTML = '<option value="">Selecciona un trabajador</option>';
            
            if (companyId && searchSubjects.workers_by_company[companyId]) {
                searchSubjects.workers_by_company[companyId].forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = worker.name;
                    workerSelect.appendChild(option);
                });
            }
        }
        
        function closeEditDocumentModal() {
            const overlay = document.getElementById('edit-doc-modal-overlay');
            if (overlay) {
                overlay.remove();
            }
            editingDocument = null;
        }
        
        async function saveDocumentEdit() {
            if (!editingDocument) return;
            
            const type = searchTypes.find(t => t.type_id === editingDocument.type_id);
            if (!type) {
                alert('Tipo de documento no encontrado');
                return;
            }
            
            // Recopilar datos del formulario
            const updateData = {};
            
            if (type.scope === 'company') {
                const companySelect = document.getElementById('edit-doc-company');
                if (!companySelect || !companySelect.value) {
                    alert('La empresa es obligatoria');
                    return;
                }
                updateData.company_key = companySelect.value;
                updateData.person_key = null;
            } else if (type.scope === 'worker') {
                const companySelect = document.getElementById('edit-doc-company');
                const workerSelect = document.getElementById('edit-doc-worker');
                if (!companySelect || !companySelect.value) {
                    alert('La empresa es obligatoria');
                    return;
                }
                if (!workerSelect || !workerSelect.value) {
                    alert('El trabajador es obligatorio');
                    return;
                }
                updateData.company_key = companySelect.value;
                updateData.person_key = workerSelect.value;
            }
            
            const statusSelect = document.getElementById('edit-doc-status');
            if (statusSelect) {
                updateData.status = statusSelect.value;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/docs/${editingDocument.doc_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                // Recargar resultados
                await performSearch();
                closeEditDocumentModal();
            } catch (error) {
                alert(`Error al guardar: ${error.message}`);
            }
        }
        
        async function deleteDocumentFromSearch(docId, docName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el documento "${docName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    if (response.status === 409) {
                        alert('No se puede eliminar un documento con estado "submitted"');
                    } else {
                        throw new Error(error);
                    }
                    return;
                }
                
                // Recargar resultados
                await performSearch();
            } catch (error) {
                alert(`Error al eliminar: ${error.message}`);
            }
        }
        
        // Plataformas
        async function loadPlataformas(params = {}) {
            const content = document.getElementById('page-content');
            
            try {
                const [rules, platforms, types] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json()).catch(() => ({platforms: []})),
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json())
                ]);
                
                const egestiona = platforms.platforms?.find(p => p.key === 'egestiona');
                const coords = egestiona?.coordinations || [];
                
                // Calculate status for each coord
                const coordStatuses = coords.map(coord => {
                    const hasCoordRule = rules.some(r => 
                        r.scope === 'COORD' && r.coord_label === coord.label && r.platform_key === 'egestiona'
                    );
                    const hasGlobalRule = rules.some(r => 
                        r.scope === 'GLOBAL' && r.platform_key === 'egestiona'
                    );
                    
                    let status = 'none';
                    let ruleType = 'ninguna';
                    if (hasCoordRule) {
                        status = 'ok';
                        ruleType = 'espec√≠fica';
                    } else if (hasGlobalRule) {
                        status = 'partial';
                        ruleType = 'general';
                    }
                    
                    return { coord, status, ruleType };
                });
                
                const covered = coordStatuses.filter(s => s.status !== 'none').length;
                const total = coords.length;
                
                // Overall platform status
                let platformStatus = 'none';
                if (covered === total && total > 0) {
                    platformStatus = 'ok';
                } else if (covered > 0) {
                    platformStatus = 'partial';
                }
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Plataformas</h3>
                        <div class="platform-card">
                            <h4 style="display: inline;">eGestiona</h4>
                            <span class="platform-status platform-status-${platformStatus}">
                                ${platformStatus === 'ok' ? 'Configurado' : platformStatus === 'partial' ? 'Parcial' : 'Sin configurar'}
                            </span>
                            <p style="margin-top: 8px; color: #94a3b8;">
                                Clientes cubiertos: ${covered}/${total}
                            </p>
                            ${platformStatus !== 'ok' ? `
                                <button class="btn btn-primary" onclick="createGlobalRules()" style="margin-top: 12px;">
                                    Crear configuraci√≥n general
                                </button>
                            ` : ''}
                        </div>
                        
                        <h3 style="margin-top: 24px;">Clientes</h3>
                        ${coordStatuses.map(({coord, status, ruleType}) => `
                            <div class="platform-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${coord.label}</strong>
                                        <span style="color: #94a3b8; margin-left: 12px;">Regla usada: ${ruleType}</span>
                                    </div>
                                    ${status === 'none' ? `
                                        <div>
                                            <span class="badge badge-falta" style="margin-right: 8px;">Sin regla</span>
                                            <button class="btn btn-secondary" onclick="fixCoordRule('${coord.label}')">Arreglar</button>
                                        </div>
                                    ` : status === 'partial' ? `
                                        <span class="badge badge-info">Usa regla general</span>
                                    ` : `
                                        <span class="badge badge-ok">Regla espec√≠fica</span>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar plataformas: ${error.message}</div>`;
            }
        }
        
        async function createGlobalRules() {
            if (!confirm('¬øCrear configuraci√≥n general para eGestiona? Esto crear√° reglas base para todos los tipos de documento.')) {
                return;
            }
            
            try {
                const [types, platforms] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json())
                ]);
                
                const existingRules = await fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []);
                const existingGlobalTypes = new Set(
                    existingRules.filter(r => r.scope === 'GLOBAL' && r.platform_key === 'egestiona')
                        .map(r => r.document_type_id)
                );
                
                let created = 0;
                for (const type of types) {
                    if (existingGlobalTypes.has(type.type_id)) continue;
                    
                    const rule = {
                        rule_id: `egestiona_global_${type.type_id.toLowerCase()}`,
                        scope: 'GLOBAL',
                        platform_key: 'egestiona',
                        coord_label: null,
                        enabled: true,
                        match: {
                            pending_text_contains: (type.platform_aliases || []).slice(0, 5),
                            empresa_contains: []
                        },
                        document_type_id: type.type_id,
                        form: {
                            upload_field_selector: "input[type='file']",
                            date_fields: {},
                            submit_button: { selector: null, by_text: null },
                            confirmation: { text_contains: [] }
                        }
                    };
                    
                    try {
                        await fetch(`${BACKEND_URL}/api/repository/rules`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(rule)
                        });
                        created++;
                    } catch (error) {
                        console.error(`Error creating rule for ${type.type_id}:`, error);
                    }
                }
                
                alert(`Creadas ${created} reglas generales`);
                loadPlataformas();
            } catch (error) {
                alert(`Error al crear configuraci√≥n general: ${error.message}`);
            }
        }
        
        function fixCoordRule(coordLabel) {
            // TODO: Implement coord-specific rule creation
            alert(`Crear regla espec√≠fica para ${coordLabel} - En desarrollo`);
        }
        
        // Cat√°logo v4 - Gesti√≥n de tipos de documento
        let catalogTypes = [];
        let catalogFilters = {
            query: '',
            period: null,
            scope: null,
            active: null,
            sort: 'name',
            page: 1,
            page_size: 20
        };
        let selectedTypes = new Set();
        let editingType = null;
        
        async function loadCatalogo(params = {}) {
            const content = document.getElementById('page-content');
            
            try {
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar cat√°logo: ${error.message}</div>`;
            }
        }
        
        async function loadCatalogTypes() {
            const params = new URLSearchParams({
                include_inactive: 'true',
                page: catalogFilters.page,
                page_size: catalogFilters.page_size,
                sort: catalogFilters.sort
            });
            
            if (catalogFilters.query) params.append('query', catalogFilters.query);
            if (catalogFilters.period) params.append('period', catalogFilters.period);
            if (catalogFilters.scope) params.append('scope', catalogFilters.scope);
            if (catalogFilters.active !== null) params.append('active', catalogFilters.active.toString());
            
            const response = await fetch(`${BACKEND_URL}/api/repository/types?${params}`);
            const data = await response.json();
            
            // Handle both paginated and non-paginated responses
            if (data.items) {
                catalogTypes = data.items;
                window.catalogTotal = data.total;
            } else {
                catalogTypes = Array.isArray(data) ? data : [];
                window.catalogTotal = catalogTypes.length;
            }
        }
        
        function renderCatalog() {
            const content = document.getElementById('page-content');
            
            content.innerHTML = `
                <div class="catalog-toolbar">
                    <div>
                        <h2 style="display: inline; margin-right: 16px;">Cat√°logo de documentos</h2>
                        <span class="catalog-results-info" id="catalog-results-info">
                            Mostrando ${catalogTypes.length} de ${window.catalogTotal || catalogTypes.length}
                        </span>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportCatalogSelection()" ${selectedTypes.size === 0 ? 'disabled' : ''}>
                            Exportar selecci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="importCatalogTypes()">
                            Importar
                        </button>
                        <button class="btn btn-primary" onclick="openCreateTypeDrawer()">
                            + Crear documento
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="catalog-filters">
                        <div class="form-group">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-input" 
                                   id="catalog-search"
                                   placeholder="Buscar por nombre, c√≥digo, o palabras (ej: aut√≥nomos, T205, TC2‚Ä¶)"
                                   value="${catalogFilters.query}"
                                   oninput="debounceSearch(this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Periodicidad</label>
                            <div>
                                <span class="filter-chip ${catalogFilters.period === null ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', null)">Todos</span>
                                <span class="filter-chip ${catalogFilters.period === 'monthly' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'monthly')">Mensual</span>
                                <span class="filter-chip ${catalogFilters.period === 'annual' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'annual')">Anual</span>
                                <span class="filter-chip ${catalogFilters.period === 'quarter' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'quarter')">Trimestral</span>
                                <span class="filter-chip ${catalogFilters.period === 'none' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'none')">Una vez</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aplica a</label>
                            <div>
                                <span class="filter-chip ${catalogFilters.scope === null ? 'active' : ''}" 
                                      onclick="setCatalogFilter('scope', null)">Todos</span>
                                <span class="filter-chip ${catalogFilters.scope === 'worker' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('scope', 'worker')">Trabajador</span>
                                <span class="filter-chip ${catalogFilters.scope === 'company' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('scope', 'company')">Empresa</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <div>
                                <span class="filter-chip ${catalogFilters.active === null ? 'active' : ''}" 
                                      onclick="setCatalogFilter('active', null)">Todos</span>
                                <span class="filter-chip ${catalogFilters.active === true ? 'active' : ''}" 
                                      onclick="setCatalogFilter('active', true)">Activos</span>
                                <span class="filter-chip ${catalogFilters.active === false ? 'active' : ''}" 
                                      onclick="setCatalogFilter('active', false)">Inactivos</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ordenar por</label>
                            <select class="form-input" id="catalog-sort" onchange="setCatalogFilter('sort', this.value)">
                                <option value="name" ${catalogFilters.sort === 'name' ? 'selected' : ''}>Nombre A‚ÜíZ</option>
                                <option value="type_id" ${catalogFilters.sort === 'type_id' ? 'selected' : ''}>C√≥digo</option>
                                <option value="period" ${catalogFilters.sort === 'period' ? 'selected' : ''}>Periodicidad</option>
                                <option value="relevance" ${catalogFilters.sort === 'relevance' ? 'selected' : ''}>Relevancia</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-secondary" onclick="clearCatalogFilters()">Limpiar filtros</button>
                    </div>
                    
                    ${selectedTypes.size > 0 ? `
                        <div class="alert alert-info" style="margin-bottom: 16px;">
                            ${selectedTypes.size} tipo(s) seleccionado(s)
                            <button class="btn btn-secondary" onclick="bulkActivateTypes()" style="margin-left: 12px;">Activar</button>
                            <button class="btn btn-secondary" onclick="bulkDeactivateTypes()" style="margin-left: 8px;">Desactivar</button>
                            <button class="btn btn-secondary" onclick="bulkExportTypes()" style="margin-left: 8px;">Exportar</button>
                        </div>
                    ` : ''}
                    
                    <div class="table-container" style="max-height: calc(100vh - 450px); overflow-y: auto;">
                        <table class="catalog-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">
                                        <input type="checkbox" 
                                               onchange="toggleSelectAllTypes(this.checked)"
                                               ${selectedTypes.size === catalogTypes.length && catalogTypes.length > 0 ? 'checked' : ''}>
                                    </th>
                                    <th>Documento</th>
                                    <th>Cada cu√°nto</th>
                                    <th>Aplica a</th>
                                    <th>Activo</th>
                                    <th>C√≥mo suele llamarse</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${catalogTypes.map(type => {
                                    const periodMode = type.validity_policy?.mode || 'fixed_end_date';
                                    const periodLabel = periodMode === 'monthly' ? 'Mensual' : 
                                                       periodMode === 'annual' ? 'Anual' : 'Una vez';
                                    const scopeLabel = type.scope === 'worker' ? 'Trabajador' : 'Empresa';
                                    const aliases = type.platform_aliases || [];
                                    const aliasesDisplay = aliases.slice(0, 3);
                                    const moreAliases = aliases.length > 3 ? aliases.length - 3 : 0;
                                    
                                    return `
                                        <tr ${!type.active ? 'style="opacity: 0.6;"' : ''}>
                                            <td class="checkbox-cell">
                                                <input type="checkbox" 
                                                       onchange="toggleSelectType('${type.type_id}', this.checked)"
                                                       ${selectedTypes.has(type.type_id) ? 'checked' : ''}>
                                            </td>
                                            <td>
                                                <strong>${type.name}</strong>
                                                <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">
                                                    ${type.type_id}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">${periodLabel}</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">${scopeLabel}</span>
                                            </td>
                                            <td>
                                                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                                    <input type="checkbox" 
                                                           ${type.active ? 'checked' : ''}
                                                           onchange="toggleTypeActive('${type.type_id}', this.checked)"
                                                           style="margin-right: 8px;">
                                                    ${type.active ? 'Activo' : 'Inactivo'}
                                                </label>
                                            </td>
                                            <td>
                                                ${aliasesDisplay.map(a => `<span class="badge badge-secondary" style="margin-right: 4px;">${a}</span>`).join('')}
                                                ${moreAliases > 0 ? `<span class="badge badge-secondary">+${moreAliases}</span>` : ''}
                                                ${aliases.length === 0 ? '<span style="color: #94a3b8;">-</span>' : ''}
                                            </td>
                                            <td>
                                                <div class="action-menu">
                                                    <button class="action-menu-button" onclick="toggleActionMenu('${type.type_id}')">‚ãØ</button>
                                                    <div class="action-menu-dropdown hidden" id="action-menu-${type.type_id}">
                                                        <div class="action-menu-item" onclick="editType('${type.type_id}')">Editar</div>
                                                        <div class="action-menu-item" onclick="duplicateType('${type.type_id}')">Duplicar</div>
                                                        <div class="action-menu-item" onclick="viewTypeCalendar('${type.type_id}')">Ver calendario</div>
                                                        <div class="action-menu-item" onclick="uploadTypeDocument('${type.type_id}')">Subir documento</div>
                                                        <div class="action-menu-item" onclick="viewTypeRules('${type.type_id}')">Ver reglas</div>
                                                        <div class="action-menu-item" onclick="toggleTypeActive('${type.type_id}', ${!type.active})">
                                                            ${type.active ? 'Desactivar' : 'Activar'}
                                                        </div>
                                                        <div class="action-menu-item danger" onclick="deleteType('${type.type_id}')">Borrar</div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${window.catalogTotal > catalogFilters.page_size ? `
                        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 8px;">
                            <button class="btn btn-secondary" 
                                    onclick="setCatalogPage(${catalogFilters.page - 1})"
                                    ${catalogFilters.page <= 1 ? 'disabled' : ''}>
                                Anterior
                            </button>
                            <span style="padding: 10px 16px; color: #94a3b8;">
                                P√°gina ${catalogFilters.page} de ${Math.ceil((window.catalogTotal || catalogTypes.length) / catalogFilters.page_size)}
                            </span>
                            <button class="btn btn-secondary" 
                                    onclick="setCatalogPage(${catalogFilters.page + 1})"
                                    ${catalogFilters.page >= Math.ceil((window.catalogTotal || catalogTypes.length) / catalogFilters.page_size) ? 'disabled' : ''}>
                                Siguiente
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Drawer para crear/editar tipo -->
                <div class="drawer" id="type-drawer">
                    <div class="drawer-header">
                        <h3 id="drawer-title">Crear documento</h3>
                        <button class="btn btn-secondary" onclick="closeTypeDrawer()" style="padding: 4px 12px;">‚úï</button>
                    </div>
                    <div class="drawer-body" id="drawer-body">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <div class="drawer-footer">
                        <button class="btn btn-secondary" onclick="closeTypeDrawer()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveType()">Guardar</button>
                        <button class="btn btn-primary" onclick="saveTypeAndViewCalendar()">Guardar y ver calendario</button>
                    </div>
                </div>
            `;
            
            updateCatalogResultsInfo();
        }
        
        function updateCatalogResultsInfo() {
            const info = document.getElementById('catalog-results-info');
            if (info) {
                info.textContent = `Mostrando ${catalogTypes.length} de ${window.catalogTotal || catalogTypes.length}`;
            }
        }
        
        let searchTimeout;
        function debounceSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                catalogFilters.query = query;
                catalogFilters.page = 1;
                loadCatalogTypes().then(() => renderCatalog());
            }, 300);
        }
        
        function setCatalogFilter(key, value) {
            catalogFilters[key] = value;
            catalogFilters.page = 1;
            loadCatalogTypes().then(() => renderCatalog());
        }
        
        function setCatalogPage(page) {
            catalogFilters.page = page;
            loadCatalogTypes().then(() => renderCatalog());
        }
        
        function clearCatalogFilters() {
            catalogFilters = {
                query: '',
                period: null,
                scope: null,
                active: null,
                sort: 'name',
                page: 1,
                page_size: 20
            };
            document.getElementById('catalog-search').value = '';
            loadCatalogTypes().then(() => renderCatalog());
        }
        
        function toggleSelectAllTypes(checked) {
            if (checked) {
                catalogTypes.forEach(t => selectedTypes.add(t.type_id));
            } else {
                selectedTypes.clear();
            }
            renderCatalog();
        }
        
        function toggleSelectType(typeId, checked) {
            if (checked) {
                selectedTypes.add(typeId);
            } else {
                selectedTypes.delete(typeId);
            }
            renderCatalog();
        }
        
        function toggleActionMenu(typeId) {
            const menus = document.querySelectorAll('.action-menu-dropdown');
            menus.forEach(m => m.classList.add('hidden'));
            const menu = document.getElementById(`action-menu-${typeId}`);
            const button = document.querySelector(`button[onclick="toggleActionMenu('${typeId}')"]`);
            
            if (menu && button) {
                const isHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                
                if (!isHidden) {
                    // Calcular posici√≥n del men√∫ para que quepa en el viewport
                    const buttonRect = button.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;
                    
                    // Posici√≥n vertical: abajo por defecto, arriba si no cabe
                    let top = buttonRect.bottom + 4;
                    const estimatedMenuHeight = 300; // Altura estimada del men√∫
                    if (top + estimatedMenuHeight > viewportHeight - 10) {
                        top = buttonRect.top - estimatedMenuHeight - 4;
                        // Si tampoco cabe arriba, ajustar al viewport
                        if (top < 10) {
                            top = 10;
                            menu.style.maxHeight = `${viewportHeight - 20}px`;
                        }
                    }
                    
                    // Posici√≥n horizontal: alineado a la derecha del bot√≥n
                    let right = viewportWidth - buttonRect.right;
                    if (right + 200 > viewportWidth) {
                        right = viewportWidth - buttonRect.left;
                        menu.style.left = `${buttonRect.left}px`;
                        menu.style.right = 'auto';
                    } else {
                        menu.style.right = `${right}px`;
                        menu.style.left = 'auto';
                    }
                    
                    menu.style.top = `${top}px`;
                }
            }
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!e.target.closest('.action-menu')) {
                        menus.forEach(m => m.classList.add('hidden'));
                        document.removeEventListener('click', closeMenu);
                    }
                }, { once: true });
            }, 0);
        }
        
        function openCreateTypeDrawer() {
            editingType = null;
            document.getElementById('type-drawer').classList.add('open');
            renderTypeDrawer();
        }
        
        function closeTypeDrawer() {
            document.getElementById('type-drawer').classList.remove('open');
            editingType = null;
        }
        
        function editType(typeId) {
            editingType = catalogTypes.find(t => t.type_id === typeId);
            if (editingType) {
                document.getElementById('type-drawer').classList.add('open');
                renderTypeDrawer();
            }
        }
        
        function renderTypeDrawer() {
            const isEdit = editingType !== null;
            const type = editingType || {
                type_id: '',
                name: '',
                description: '',
                scope: 'worker',
                validity_policy: {
                    mode: 'monthly',
                    basis: 'name_date',
                    monthly: { month_source: 'name_date', grace_days: 0 }
                },
                platform_aliases: [],
                active: true,
                issue_date_required: true,
                validity_start_mode: 'issue_date',
                allow_late_submission: false,
                late_submission_max_days: null
            };
            
            // BUG 4: Detectar si es "Cada N meses" (tiene n_months pero mode=monthly)
            const hasNMonths = type.validity_policy?.n_months?.n;
            console.log('[repo-upload] renderTypeDrawer - type validity_policy:', {
                mode: type.validity_policy?.mode,
                n_months: type.validity_policy?.n_months,
                hasNMonths: hasNMonths
            });
            const periodMode = hasNMonths ? 'n_months' : (type.validity_policy?.mode || 'monthly');
            const periodBasis = type.validity_policy?.basis || 'name_date';
            const monthlyConfig = type.validity_policy?.monthly || { month_source: 'name_date', grace_days: 0 };
            
            document.getElementById('drawer-title').textContent = isEdit ? 'Editar documento' : 'Crear documento';
            
            document.getElementById('drawer-body').innerHTML = `
                <!-- ID del documento: oculto, se genera autom√°ticamente en el backend -->
                <input type="hidden" id="drawer-type-id" value="${type.type_id}">
                
                <div class="form-group">
                    <label class="form-label">Nombre <span style="color: #ef4444;">*</span></label>
                    <input type="text" class="form-input" 
                           id="drawer-name"
                           value="${type.name}"
                           placeholder="Ej: Recibo de aut√≥nomos"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-input" 
                              id="drawer-description"
                              rows="3"
                              placeholder="Descripci√≥n opcional">${type.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">¬øCada cu√°nto se pide? <span style="color: #ef4444;">*</span></label>
                    <select class="form-input" id="drawer-period-mode" onchange="updatePeriodConfig()">
                        <option value="monthly" ${periodMode === 'monthly' ? 'selected' : ''}>Mensual</option>
                        <option value="n_months" ${periodMode === 'n_months' ? 'selected' : ''}>Cada N meses</option>
                        <option value="annual" ${periodMode === 'annual' ? 'selected' : ''}>Anual</option>
                        <option value="fixed_end_date" ${periodMode === 'fixed_end_date' ? 'selected' : ''}>Una vez</option>
                    </select>
                </div>
                
                <div class="form-group" id="n-months-config-group" style="${periodMode !== 'n_months' ? 'display: none;' : ''}">
                    <label class="form-label">Cada cu√°ntos meses <span style="color: #ef4444;">*</span></label>
                    <input type="number" class="form-input" 
                           id="drawer-n-months"
                           value="${hasNMonths ? hasNMonths : (type.validity_policy?.n_months?.n || 1)}"
                           min="1" max="120"
                           placeholder="N√∫mero de meses"
                           required>
                    <div class="form-help">Cada cu√°ntos meses se debe presentar este documento (ej: 2 = cada 2 meses, 3 = cada 3 meses)</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">¬øA qui√©n aplica? <span style="color: #ef4444;">*</span></label>
                    <select class="form-input" id="drawer-scope">
                        <option value="worker" ${type.scope === 'worker' ? 'selected' : ''}>Trabajador</option>
                        <option value="company" ${type.scope === 'company' ? 'selected' : ''}>Empresa</option>
                    </select>
                </div>
                
                <div class="form-group" id="period-config-group">
                    <label class="form-label">C√≥mo se calcula el periodo</label>
                    <select class="form-input" id="drawer-period-basis">
                        <option value="name_date" ${periodBasis === 'name_date' ? 'selected' : ''}>Desde nombre</option>
                        <option value="issue_date" ${periodBasis === 'issue_date' ? 'selected' : ''}>Fecha de emisi√≥n</option>
                        <option value="manual" ${periodBasis === 'manual' ? 'selected' : ''}>Manual</option>
                    </select>
                </div>
                
                <div class="form-group" id="monthly-config-group" style="${periodMode !== 'monthly' ? 'display: none;' : ''}">
                    <label class="form-label">Qu√© mes cuenta</label>
                    <select class="form-input" id="drawer-month-source">
                        <option value="name_date" ${monthlyConfig.month_source === 'name_date' ? 'selected' : ''}>Fecha nombre</option>
                        <option value="issue_date" ${monthlyConfig.month_source === 'issue_date' ? 'selected' : ''}>Fecha emisi√≥n</option>
                    </select>
                    <label class="form-label" style="margin-top: 12px;">D√≠as de margen</label>
                    <input type="number" class="form-input" 
                           id="drawer-grace-days"
                           value="${monthlyConfig.grace_days || 0}"
                           min="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fecha de expedici√≥n obligatoria</label>
                    <label style="display: inline-flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               id="drawer-issue-date-required"
                               ${type.issue_date_required !== false ? 'checked' : ''}
                               style="margin-right: 8px;">
                        La fecha de emisi√≥n es obligatoria al subir documentos de este tipo
                    </label>
                    <div class="form-help">Si est√° activado, el usuario debe proporcionar la fecha de emisi√≥n al subir documentos de este tipo</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fecha de inicio de vigencia</label>
                    <select class="form-input" id="drawer-validity-start-mode">
                        <option value="issue_date" ${(type.validity_start_mode || 'issue_date') === 'issue_date' ? 'selected' : ''}>Igual a la fecha de emisi√≥n</option>
                        <option value="manual" ${type.validity_start_mode === 'manual' ? 'selected' : ''}>Se introduce al subir el documento</option>
                    </select>
                    <div class="form-help">C√≥mo se determina la fecha de inicio de vigencia. Si es "manual", el usuario debe introducirla al subir cada documento.</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Permitir env√≠o tard√≠o</label>
                    <label style="display: inline-flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               id="drawer-allow-late"
                               ${type.allow_late_submission ? 'checked' : ''}
                               style="margin-right: 8px;">
                        Permitir env√≠o despu√©s de la fecha l√≠mite
                    </label>
                </div>
                
                <div class="form-group" id="late-days-group" style="${!type.allow_late_submission ? 'display: none;' : ''}">
                    <label class="form-label">M√°ximo d√≠as tarde</label>
                    <input type="number" class="form-input" 
                           id="drawer-late-days"
                           value="${type.late_submission_max_days || ''}"
                           min="0"
                           placeholder="Si vac√≠o, usa d√≠as de margen">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Activo</label>
                    <label style="display: inline-flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               id="drawer-active"
                               ${type.active !== false ? 'checked' : ''}
                               style="margin-right: 8px;">
                        Tipo activo (visible y usable)
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">C√≥mo suele llamarse (para reconocerlo)</label>
                    <div class="chip-editor" id="aliases-editor">
                        ${(type.platform_aliases || []).map(alias => `
                            <span class="chip">
                                ${alias}
                                <span class="chip-remove" onclick="removeAlias('${alias}')">√ó</span>
                            </span>
                        `).join('')}
                    </div>
                    <div style="margin-top: 8px;">
                        <input type="text" 
                               class="form-input" 
                               id="alias-input"
                               placeholder="Escribe un alias y presiona Enter"
                               onkeypress="if(event.key==='Enter') { event.preventDefault(); addAlias(); }">
                        <button class="btn btn-secondary" onclick="addAlias()" style="margin-top: 8px;">+ A√±adir ejemplo</button>
                    </div>
                    <div class="form-help">Cada alias ayuda a reconocer este documento en plataformas externas</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ejemplo de nombre de archivo (opcional)</label>
                    <input type="text" class="form-input" 
                           id="drawer-filename-example"
                           placeholder="Ej: autonomos_2023-05.pdf">
                    <div class="form-help">Ayuda a la autodetecci√≥n al subir documentos</div>
                </div>
            `;
            
            // Setup alias management
            window.currentAliases = [...(type.platform_aliases || [])];
        }
        
        function updatePeriodConfig() {
            const mode = document.getElementById('drawer-period-mode').value;
            const monthlyGroup = document.getElementById('monthly-config-group');
            const nMonthsGroup = document.getElementById('n-months-config-group');
            if (monthlyGroup) {
                monthlyGroup.style.display = mode === 'monthly' ? 'block' : 'none';
            }
            if (nMonthsGroup) {
                nMonthsGroup.style.display = mode === 'n_months' ? 'block' : 'none';
            }
        }
        
        function addAlias() {
            const input = document.getElementById('alias-input');
            const alias = input.value.trim();
            if (alias && !window.currentAliases.includes(alias)) {
                window.currentAliases.push(alias);
                input.value = '';
                renderAliases();
            }
        }
        
        function removeAlias(alias) {
            window.currentAliases = window.currentAliases.filter(a => a !== alias);
            renderAliases();
        }
        
        function renderAliases() {
            const editor = document.getElementById('aliases-editor');
            if (editor) {
                editor.innerHTML = window.currentAliases.map(alias => `
                    <span class="chip">
                        ${alias}
                        <span class="chip-remove" onclick="removeAlias('${alias}')">√ó</span>
                    </span>
                `).join('');
            }
        }
        
        async function saveType() {
            const typeIdInput = document.getElementById('drawer-type-id');
            const typeId = typeIdInput ? typeIdInput.value.trim().toUpperCase() : '';
            const name = document.getElementById('drawer-name').value.trim();
            const description = document.getElementById('drawer-description').value.trim();
            const scope = document.getElementById('drawer-scope').value;
            const periodMode = document.getElementById('drawer-period-mode').value;
            const periodBasis = document.getElementById('drawer-period-basis').value;
            const monthSource = document.getElementById('drawer-month-source').value;
            const graceDays = parseInt(document.getElementById('drawer-grace-days').value) || 0;
            const nMonths = periodMode === 'n_months' ? (parseInt(document.getElementById('drawer-n-months').value) || 1) : null;
            const issueDateRequired = document.getElementById('drawer-issue-date-required').checked;
            const validityStartMode = document.getElementById('drawer-validity-start-mode').value || 'issue_date';
            const allowLate = document.getElementById('drawer-allow-late').checked;
            const lateDays = document.getElementById('drawer-late-days').value ? parseInt(document.getElementById('drawer-late-days').value) : null;
            const active = document.getElementById('drawer-active').checked;
            const aliases = window.currentAliases.filter(a => a.trim()).map(a => a.trim());
            
            // Validaci√≥n: solo nombre es obligatorio (type_id se genera autom√°ticamente al crear)
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }
            
            // Al editar, usar el type_id del objeto editingType
            const finalTypeId = editingType ? editingType.type_id : (typeId || '');
            
            // Al editar, validar que el type_id existe
            if (editingType && !finalTypeId) {
                alert('Error: no se puede editar un tipo sin ID');
                return;
            }
            
            const validityPolicy = {
                mode: periodMode,
                basis: periodBasis
            };
            
            if (periodMode === 'monthly') {
                validityPolicy.monthly = {
                    month_source: monthSource,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: graceDays
                };
            } else if (periodMode === 'n_months') {
                // BUG 4: Para "Cada N meses", usar mode='monthly' (compatible) y a√±adir n_months
                validityPolicy.mode = 'monthly'; // Compatible con backend enum
                validityPolicy.monthly = {
                    month_source: monthSource,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: graceDays
                };
                // A√±adir n_months como override
                validityPolicy.n_months = {
                    n: nMonths,
                    month_source: monthSource,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: graceDays
                };
            } else if (periodMode === 'annual') {
                validityPolicy.annual = {
                    months: 12,
                    valid_from: 'issue_date',
                    valid_to: 'issue_date_plus_months'
                };
            } else {
                validityPolicy.fixed_end_date = {
                    valid_from: 'issue_date',
                    valid_to: 'manual_end_date'
                };
            }
            
            // Al crear, enviar type_id vac√≠o para que el backend lo genere
            const typeData = {
                type_id: finalTypeId || '',  // Vac√≠o al crear, el backend lo generar√°
                name: name,
                description: description,
                scope: scope,
                validity_policy: validityPolicy,
                platform_aliases: aliases,
                active: active,
                issue_date_required: issueDateRequired,
                validity_start_mode: validityStartMode,
                allow_late_submission: allowLate,
                late_submission_max_days: lateDays,
                required_fields: []
            };
            
            try {
                const url = editingType 
                    ? `${BACKEND_URL}/api/repository/types/${finalTypeId}`
                    : `${BACKEND_URL}/api/repository/types`;
                const method = editingType ? 'PUT' : 'POST';
                
                console.log('[repo-upload] saveType - sending:', {
                    periodMode,
                    nMonths,
                    validityPolicy: JSON.stringify(validityPolicy, null, 2)
                });
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(typeData)
                });
                
                console.log('[repo-upload] saveType - response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                const savedType = await response.json();
                console.log('[repo-upload] saveType - saved type:', {
                    type_id: savedType.type_id,
                    validity_policy: savedType.validity_policy
                });
                
                closeTypeDrawer();
                await loadCatalogTypes();
                renderCatalog();
                
                // Si se cre√≥ un nuevo tipo, mostrar el ID generado
                if (!editingType && savedType.type_id) {
                    console.log(`Tipo creado con ID: ${savedType.type_id}`);
                }
            } catch (error) {
                alert(`Error al guardar: ${error.message}`);
            }
        }
        
        async function saveTypeAndViewCalendar() {
            await saveType();
            // Obtener el type_id del tipo guardado (puede ser el generado por el backend)
            if (editingType && editingType.type_id) {
                navigateTo('calendario');
                setTimeout(() => {
                    selectCalendarType(editingType.type_id);
                }, 500);
            } else {
                // Si se cre√≥ un nuevo tipo, recargar el cat√°logo y buscar el √∫ltimo tipo creado
                await loadCatalogTypes();
                const lastType = catalogTypes[catalogTypes.length - 1];
                if (lastType) {
                    navigateTo('calendario');
                    setTimeout(() => {
                        selectCalendarType(lastType.type_id);
                }, 500);
                }
            }
        }
        
        async function duplicateType(typeId) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) return;
            
            const newId = prompt('Nuevo ID para el tipo duplicado:', `${typeId}_COPY`);
            if (!newId || !/^[A-Z0-9_]+$/.test(newId.toUpperCase())) {
                alert('ID inv√°lido');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_type_id: newId.toUpperCase() })
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                alert(`Error al duplicar: ${error.message}`);
            }
        }
        
        async function toggleTypeActive(typeId, active) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) return;
            
            type.active = active;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(type)
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                alert(`Error al actualizar: ${error.message}`);
            }
        }
        
        async function deleteType(typeId) {
            // Check if type has documents
            try {
                const docsResponse = await fetch(`${BACKEND_URL}/api/repository/docs?type_id=${typeId}`);
                const docs = await docsResponse.json();
                
                if (docs.length > 0) {
                    if (!confirm(`Este tipo tiene ${docs.length} documento(s) asociado(s). No se puede borrar. ¬øDeseas desactivarlo en su lugar?`)) {
                        return;
                    }
                    await toggleTypeActive(typeId, false);
                    return;
                }
            } catch (error) {
                console.error('Error checking documents:', error);
            }
            
            if (!confirm(`¬øBorrar el tipo "${typeId}"? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                alert(`Error al borrar: ${error.message}`);
            }
        }
        
        function viewTypeCalendar(typeId) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) {
                alert(`Tipo ${typeId} no encontrado`);
                return;
            }
            navigateTo('calendario', { type_id: typeId, scope: type.scope });
        }
        
        function uploadTypeDocument(typeId) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) {
                alert(`Tipo ${typeId} no encontrado`);
                return;
            }
            navigateTo('subir', { type_id: typeId, scope: type.scope });
        }
        
        function viewTypeRules(typeId) {
            navigateTo('plataformas');
            // TODO: Filtrar por tipo si existe filtro en plataformas
        }
        
        function bulkActivateTypes() {
            selectedTypes.forEach(typeId => {
                toggleTypeActive(typeId, true);
            });
            selectedTypes.clear();
        }
        
        function bulkDeactivateTypes() {
            selectedTypes.forEach(typeId => {
                toggleTypeActive(typeId, false);
            });
            selectedTypes.clear();
        }
        
        function bulkExportTypes() {
            const selected = catalogTypes.filter(t => selectedTypes.has(t.type_id));
            const json = JSON.stringify(selected, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `catalog_types_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCatalogSelection() {
            bulkExportTypes();
        }
        
        function importCatalogTypes() {
            alert('Importar tipos - En desarrollo (v1 stub)');
        }
        
        // ========== CONFIGURACI√ìN ==========
        
        let repositorySettings = null;
        
        async function loadConfiguracion() {
            const content = document.getElementById('page-content');
            
            try {
                // Cargar configuraci√≥n actual
                const response = await fetch(`${BACKEND_URL}/api/repository/settings`);
                if (response.ok) {
                    repositorySettings = await response.json();
                } else {
                    repositorySettings = { repository_root_dir: '' };
                }
            } catch (error) {
                console.error('[config] Error loading settings:', error);
                repositorySettings = { repository_root_dir: '' };
            }
            
            content.innerHTML = `
                <div class="card">
                    <h3>Configuraci√≥n del Repositorio</h3>
                    <p style="color: #94a3b8; margin-bottom: 24px;">
                        Configura la ruta en el servidor donde se guardan los documentos subidos.
                        <strong>Nota:</strong> Esta ruta es del servidor donde corre CometLocal (tu PC).
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">Ruta del repositorio</label>
                        <input type="text" 
                               class="form-input" 
                               id="config-repository-root"
                               value="${repositorySettings?.repository_root_dir || ''}"
                               placeholder="D:\\Proyectos\\CometLocal\\data\\repository"
                               style="font-family: monospace; font-size: 0.9rem;">
                        <div class="form-help" style="margin-top: 8px; color: #94a3b8; font-size: 0.875rem;">
                            Ruta absoluta en el servidor donde se guardan los PDFs subidos.
                            <br>Ejemplo Windows: <code>D:\\Proyectos\\CometLocal\\data\\repository</code>
                            <br>Ejemplo Linux: <code>/home/usuario/data/repository</code>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="testRepositoryPath()">
                            Probar ruta
                        </button>
                        <button class="btn btn-primary" onclick="saveRepositorySettings()">
                            Guardar
                        </button>
                    </div>
                    
                    <div id="config-message" style="margin-top: 16px;"></div>
                </div>
            `;
        }
        
        async function testRepositoryPath() {
            const input = document.getElementById('config-repository-root');
            const messageDiv = document.getElementById('config-message');
            const path = input.value.trim();
            
            if (!path) {
                messageDiv.innerHTML = '<div class="alert alert-error">Por favor, introduce una ruta.</div>';
                return;
            }
            
            messageDiv.innerHTML = '<div class="alert alert-info">Probando ruta...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/settings?dry_run=true`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        repository_root_dir: path
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    messageDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úì Ruta v√°lida y escribible: ${result.repository_root_dir}
                            <br>El directorio se crear√° autom√°ticamente si no existe.
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    messageDiv.innerHTML = `
                        <div class="alert alert-error">
                            ‚úó Error: ${error.detail || 'Error desconocido'}
                        </div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚úó Error de conexi√≥n: ${error.message}
                    </div>
                `;
            }
        }
        
        async function saveRepositorySettings() {
            const input = document.getElementById('config-repository-root');
            const messageDiv = document.getElementById('config-message');
            const path = input.value.trim();
            
            if (!path) {
                messageDiv.innerHTML = '<div class="alert alert-error">Por favor, introduce una ruta.</div>';
                return;
            }
            
            messageDiv.innerHTML = '<div class="alert alert-info">Guardando configuraci√≥n...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        repository_root_dir: path
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    repositorySettings = result;
                    input.value = result.repository_root_dir; // Actualizar con ruta resuelta
                    messageDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úì Configuraci√≥n guardada correctamente.
                            <br>Ruta configurada: ${result.repository_root_dir}
                            <br><strong>Nota:</strong> Los nuevos documentos se guardar√°n en esta ruta.
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    messageDiv.innerHTML = `
                        <div class="alert alert-error">
                            ‚úó Error al guardar: ${error.detail || 'Error desconocido'}
                        </div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚úó Error de conexi√≥n: ${error.message}
                    </div>
                `;
            }
        }
        
        async function loadActividad(params = {}) {
            document.getElementById('page-content').innerHTML = '<div class="card"><h3>Actividad</h3><p>En desarrollo...</p></div>';
        }
        
        // Initialize
        // Initial page load - only if no hash is present
        // Initial page load - only if no hash is present (handled by initHashRouting)
        // This is a fallback for cases where initHashRouting doesn't run
        // Event delegation para selects de tipo en upload
        // UN SOLO listener global que maneja todos los selects
        (function() {
            console.log('[repo-upload] listener installed', { time: Date.now() });
            window.__REPO_UPLOAD_LISTENER_INSTALLED = true;
            window.__REPO_UPLOAD_LAST_CHANGE = null;
            window.__REPO_UPLOAD_LAST_SELECT_DEBUG = null;
            
            document.addEventListener('change', (ev) => {
                // Log SIEMPRE antes de cualquier return
                const debugInfo = {
                    targetTag: ev.target?.tagName,
                    hasClass: ev.target?.classList?.contains('repo-upload-type-select'),
                    fileIdAttr: ev.target?.getAttribute?.('data-upload-file-id'),
                    time: Date.now()
                };
                console.log('[repo-upload] change captured', debugInfo);
                window.__REPO_UPLOAD_LAST_CHANGE = debugInfo;
                
                const sel = ev.target;
                if (!(sel instanceof HTMLSelectElement)) return;
                if (!sel.classList.contains('repo-upload-type-select')) return;

                const fileId = sel.getAttribute('data-upload-file-id');
                if (!fileId) {
                    console.warn('[repo-upload] select without data-upload-file-id');
                    return;
                }

                // Buscar el archivo - convertir ambos a string para comparaci√≥n
                // IMPORTANTE: uploadFiles puede ser un array global, verificar que existe
                if (!uploadFiles || !Array.isArray(uploadFiles)) {
                    console.error('[repo-upload] uploadFiles is not an array', {
                        uploadFiles,
                        type: typeof uploadFiles,
                        fileId
                    });
                    return;
                }
                
                const file = uploadFiles.find(f => {
                    if (!f || f.id === undefined) return false;
                    const fId = String(f.id);
                    const searchId = String(fileId);
                    const match = fId === searchId;
                    if (match) {
                        console.log('[repo-upload] file found', {
                            fileId: f.id,
                            fileName: f.name,
                            searchId: fileId
                        });
                    }
                    return match;
                });
                if (!file) {
                    const allIds = uploadFiles.map(f => ({ 
                        id: f.id, 
                        idType: typeof f.id, 
                        idString: String(f.id),
                        name: f.name
                    }));
                    console.error('[repo-upload] file not found for select', {
                        fileId,
                        fileIdType: typeof fileId,
                        fileIdString: String(fileId),
                        uploadFilesType: typeof uploadFiles,
                        uploadFilesLength: uploadFiles.length,
                        uploadFilesIds: allIds,
                        comparison: allIds.map(f => ({
                            original: f.idString,
                            search: String(fileId),
                            match: f.idString === String(fileId),
                            exactMatch: f.id === fileId,
                            looseMatch: f.id == fileId
                        }))
                    });
                    return;
                }

                const opt = sel.options[sel.selectedIndex];
                const selectDebug = {
                    fileId,
                    value: sel.value,
                    selectedIndex: sel.selectedIndex,
                    optionValue: opt?.value,
                    optionText: opt?.text,
                    uploadFilesType: typeof uploadFiles,
                    uploadFilesLength: uploadFiles?.length,
                    uploadTypesType: typeof uploadTypes,
                    uploadTypesLength: uploadTypes?.length,
                    time: Date.now()
                };
                console.log('[repo-upload] select debug', selectDebug);
                window.__REPO_UPLOAD_LAST_SELECT_DEBUG = selectDebug;

                // Fail-fast: si value est√° vac√≠o, error inmediato
                if (!sel.value || sel.value.trim() === '') {
                    file.type_id = null;
                    file._last_dom_value = '';
                    if (!file.errors) file.errors = [];
                    if (!file.errors.includes('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.')) {
                        file.errors.push('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.');
                    }
                    renderUploadFiles();
                    return;
                }

                // Guardar dom_value para debug
                file._last_dom_value = sel.value || '';
                updateUploadFileType(fileId, sel.value);
            });
        })();

        // Initialize version stamp timestamp
        document.addEventListener('DOMContentLoaded', () => {
            const timestampEl = document.getElementById('build-timestamp');
            if (timestampEl) {
                const now = new Date();
                timestampEl.textContent = now.toISOString().slice(0, 19).replace('T', ' ');
            }
            
            const { route } = parseHashRoute();
            if (!route && (!window.location.hash || window.location.hash === '#')) {
                dbg('No hash found, loading inicio as fallback');
                loadInicio().catch(error => {
                    console.error('[repo] Error in initial loadInicio:', error);
                    showErrorBanner(`Error al cargar inicio inicial: ${error.message}`, error);
                });
            }
            // Hash routing initialization is handled by initHashRouting() above
        });
        
        // Error handlers globales para evitar "Cargando..." infinito
        window.addEventListener('error', (event) => {
            console.error('[repo] Global error:', event.error);
            const content = document.getElementById('page-content');
            if (content && content.innerHTML.includes('Cargando...')) {
                showErrorBanner(`Error de JavaScript: ${event.error?.message || event.message}`, event.error);
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('[repo] Unhandled promise rejection:', event.reason);
            const content = document.getElementById('page-content');
            if (content && content.innerHTML.includes('Cargando...')) {
                const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));
                showErrorBanner(`Promesa rechazada sin manejar: ${error.message}`, error);
            }
        });
    </script>
</body>
</html>

