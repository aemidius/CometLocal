<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Documental - CometLocal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Version stamp */
        .version-stamp {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            font-family: monospace;
            color: #60a5fa;
            z-index: 10000;
            pointer-events: none;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
        }
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3b82f6;
        }
        .sidebar-header p {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover {
            background: #334155;
            color: #fff;
        }
        .nav-item.active {
            background: #1e3a8a;
            color: #3b82f6;
            border-left: 3px solid #3b82f6;
        }
        .nav-item-icon {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
            background: #1e293b;
        }
        .content-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .content-header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        /* Cards */
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h3 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }
        .kpi-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .kpi-card-title {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .kpi-card-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        .kpi-card-subtitle {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #475569;
            color: white;
        }
        .btn-secondary:hover {
            background: #334155;
        }
        .btn-lg {
            padding: 14px 28px;
            font-size: 1.1rem;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            max-height: calc(100vh - 400px); /* Aprovechar mejor el espacio vertical */
            overflow-y: auto;
            position: relative;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        th {
            background: #1e293b;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        td {
            color: #e2e8f0;
        }
        tr:hover {
            background: #1e293b;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-ok {
            background: #10b981;
            color: white;
        }
        .badge-falta {
            background: #f59e0b;
            color: white;
        }
        .badge-tarde {
            background: #ef4444;
            color: white;
        }
        .badge-info {
            background: #3b82f6;
            color: white;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.95rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-help {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        .form-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }
        .alert-warning {
            background: #78350f;
            border: 1px solid #f59e0b;
            color: #fcd34d;
        }
        .alert-error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
            color: #fca5a5;
        }
        
        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .calendar-month {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-month:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        .calendar-month.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        .calendar-month-header {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .calendar-month-status {
            margin-bottom: 8px;
        }
        .calendar-month-action {
            margin-top: 8px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }
        .modal-header {
            margin-bottom: 16px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        /* Platform Status */
        .platform-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .platform-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 12px;
        }
        .platform-status-ok {
            background: #10b981;
            color: white;
        }
        .platform-status-partial {
            background: #f59e0b;
            color: white;
        }
        .platform-status-none {
            background: #ef4444;
            color: white;
        }
        
        /* Upload Wizard */
        .upload-zone {
            border: 2px dashed #334155;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #1e293b;
            transition: all 0.2s;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        .file-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: visible; /* Allow dropdown to overflow */
        }
        .file-card h4 {
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        .wizard-question {
            margin-bottom: 20px;
            position: relative;
            overflow: visible; /* Allow dropdown to overflow */
        }
        
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000; /* Very high z-index to ensure visibility */
            margin-top: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .autocomplete-dropdown.hidden {
            display: none !important;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background: #334155;
        }
        .form-required {
            color: #ef4444;
            margin-left: 4px;
        }
        
        /* Catalog v4 specific styles */
        .catalog-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .filter-chip {
            display: inline-block;
            padding: 6px 12px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 16px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .filter-chip.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .filter-chip:hover {
            background: #475569;
        }
        .catalog-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .catalog-results-info {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .catalog-table {
            width: 100%;
        }
        .catalog-table th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #1e293b;
            padding: 12px;
        }
        .catalog-table td {
            padding: 10px 12px; /* Reducir padding para mostrar m√°s filas */
        }
        .action-menu {
            position: relative;
        }
        .action-menu-button {
            background: none;
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1.2rem;
        }
        .action-menu-dropdown {
            position: fixed; /* Cambiar a fixed para que no se corte */
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            min-width: 200px;
            z-index: 1000; /* Aumentar z-index para que est√© por encima */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }
        .action-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #334155;
        }
        .action-menu-item:last-child {
            border-bottom: none;
        }
        .action-menu-item:hover {
            background: #334155;
        }
        .action-menu-item.danger {
            color: #ef4444;
        }
        .drawer {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 600px;
            max-width: 90vw;
            background: #1e293b;
            border-left: 1px solid #334155;
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            padding: 24px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-body {
            padding: 24px;
        }
        .drawer-footer {
            padding: 24px;
            border-top: 1px solid #334155;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .chip-editor {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            min-height: 60px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: #334155;
            border-radius: 16px;
            font-size: 0.875rem;
        }
        .chip-remove {
            margin-left: 8px;
            cursor: pointer;
            color: #94a3b8;
        }
        .chip-remove:hover {
            color: #ef4444;
        }
        .checkbox-cell {
            text-align: center;
        }
    </style>
</head>
<body data-testid="app-ready">
    <!-- Version stamp -->
    <div class="version-stamp">UI build: upload-autocomplete-v1 <span id="build-timestamp"></span></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Repositorio</h1>
            <p>Documental</p>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" data-page="inicio">
                <span class="nav-item-icon">üè†</span>
                Inicio
            </a>
            <a class="nav-item" data-page="calendario">
                <span class="nav-item-icon">üìÖ</span>
                Calendario de documentos
            </a>
            <a class="nav-item" data-page="subir">
                <span class="nav-item-icon">üì§</span>
                Subir documentos
            </a>
            <a class="nav-item" data-page="buscar">
                <span class="nav-item-icon">üîç</span>
                Buscar documentos
            </a>
            <a class="nav-item" data-page="plataformas">
                <span class="nav-item-icon">üåê</span>
                Plataformas
            </a>
            <a class="nav-item" data-page="catalogo">
                <span class="nav-item-icon">üìö</span>
                Cat√°logo de documentos
            </a>
            <a class="nav-item" data-page="configuracion">
                <span class="nav-item-icon">‚öôÔ∏è</span>
                Configuraci√≥n
            </a>
            <a class="nav-item" data-page="actividad">
                <span class="nav-item-icon">üìú</span>
                Actividad
            </a>
            <a class="nav-item" data-page="coordinacion">
                <span class="nav-item-icon">üîó</span>
                Coordinaci√≥n CAE
            </a>
            <a class="nav-item" data-page="plan_review">
                <span class="nav-item-icon">üìã</span>
                Revisi√≥n Plan (CAE)
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <h2 id="page-title">Inicio</h2>
            <p id="page-description">Vista general del repositorio</p>
        </div>
        <div class="content-body" id="page-content">
            <div class="loading">Cargando...</div>
        </div>
    </div>
    
    <!-- SPRINT C2.9.5: Contenedor global para markers de estado de vistas (invariante) -->
    <div id="view-state-root" style="display: none;" aria-hidden="true"></div>
    
    <script>
        // SPRINT C1.R0: Establecer app-ready INMEDIATAMENTE al inicio del script
        // Esto debe ejecutarse ANTES de cualquier otra cosa para que Playwright pueda encontrarlo
        (function() {
            try {
                if (document.body) {
                    document.body.setAttribute('data-testid', 'app-ready');
                } else if (document.documentElement) {
                    const readyDiv = document.createElement('div');
                    readyDiv.id = 'app-ready-marker';
                    readyDiv.setAttribute('data-testid', 'app-ready');
                    readyDiv.style.display = 'none';
                    document.documentElement.appendChild(readyDiv);
                } else {
                    window.__app_ready__ = true;
                }
            } catch (e) {
                try {
                    window.__app_ready__ = true;
                } catch (e2) {
                    // Ignorar si no se puede establecer
                }
            }
        })();
        
        // SPRINT C2.9.20: Barrera ULTRA TEMPRANA que confirma que el script HA EMPEZADO A EJECUTARSE
        window.__REPO_SCRIPT_LOADED__ = true;
        try { console.log('[BOOT] __REPO_SCRIPT_LOADED__ = true'); } catch (e) {}
        
        const BACKEND_URL = 'http://127.0.0.1:8000';
        let currentPage = 'inicio';
        
        // INSTRUMENTACI√ìN DIAGN√ìSTICA: Logs top-level al cargar script
        console.log('[BOOT] repository_v3 script loaded');
        console.log('[BOOT] typeof window.ensureCalendarioLoaded:', typeof window.ensureCalendarioLoaded);
        
        // INSTRUMENTACI√ìN DIAGN√ìSTICA: Listeners globales de eventos
        window.addEventListener('load', () => {
            console.log('[EVENT] window load');
        });
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[EVENT] DOMContentLoaded');
        });
        window.addEventListener('hashchange', () => {
            console.log('[EVENT] hashchange -> ' + location.hash);
        });
        window.addEventListener('beforeunload', () => {
            console.log('[EVENT] beforeunload');
        });
        
        // SPRINT C2.3.2: Cache para detectar modo E2E
        let e2eSeedEnabled = false;
        let healthChecked = false;
        
        // Spanish month names
        const MONTHS_ES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // Human-friendly status labels
        const STATUS_LABELS = {
            'AVAILABLE': 'OK',
            'MISSING': 'Falta',
            'LATE': 'Tarde'
        };
        
        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                navigateTo(page);
            });
        });
        
        function navigateTo(page, params = {}) {
            dbg('navigateTo:', { page, params });
            currentPage = page;
            
            // Update hash with params (only if different to avoid unnecessary hashchange)
            const hash = buildHashRoute(page, params);
            const currentHash = window.location.hash;
            if (hash && currentHash !== hash) {
                dbg('Updating hash from', currentHash, 'to', hash);
                window.location.hash = hash;
                // If hash changed, hashchange event will trigger, so don't call loadPage here
                // But if hash didn't change (same route/params), we need to load manually
                if (currentHash === hash) {
                    dbg('Hash unchanged, loading page directly');
                    // Update active nav
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.page === page);
                    });
                    loadPage(page, params);
                } else {
                    dbg('Hash changed, hashchange will handle it');
                    // Hash will change, hashchange will handle it
                    // Update active nav immediately for better UX
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.page === page);
                    });
                }
            } else {
                dbg('No hash change needed');
                // No hash change needed, just update nav and load
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.page === page);
                });
                loadPage(page, params);
            }
        }
        
        // Debug instrumentation
        function isDebugMode() {
            const { params } = parseHashRoute();
            return params.debug === '1' || window.__REPO_DEBUG__ === true;
        }
        
        function dbg(...args) {
            if (isDebugMode()) {
                console.log('[repo-prefill]', ...args);
            }
        }
        
        /**
         * SPRINT B3.2: Logger determinista para debug de vistas
         * Debe estar definido ANTES de initHashRouting() para evitar ReferenceError
         */
        function viewDbg(msg) {
            console.log("[VIEWDBG]", Date.now(), msg);
        }
        
        let debugOverlay = null;
        function updateDebugOverlay(route, applied, reason) {
            if (!isDebugMode()) return;
            
            if (!debugOverlay) {
                debugOverlay = document.createElement('div');
                debugOverlay.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 8px 12px; border-radius: 4px; font-family: monospace; font-size: 11px; z-index: 10000; border: 1px solid #0f0;';
                document.body.appendChild(debugOverlay);
            }
            
            debugOverlay.innerHTML = `
                <div><strong>Route:</strong> ${route || 'none'}</div>
                <div><strong>Applied:</strong> ${applied ? '‚úÖ' : '‚ùå'}</div>
                <div><strong>Reason:</strong> ${reason || '-'}</div>
            `;
        }
        
        // Deterministic barriers
        async function ensureRepoDataLoaded(neededData = {}) {
            const needsTypes = neededData.types !== false;
            const needsPeople = neededData.people !== false;
            
            dbg('ensureRepoDataLoaded: start', { needsTypes, needsPeople });
            
            const promises = [];
            
            // Si se solicita expl√≠citamente recargar tipos (neededData.forceTypes), forzar recarga
            const forceTypes = neededData.forceTypes === true;
            if (needsTypes && (forceTypes || (calendarTypes.length === 0 && uploadTypes.length === 0 && catalogTypes.length === 0))) {
                dbg('Loading types...', { forceTypes });
                promises.push(
                    fetch(`${BACKEND_URL}/api/repository/types`)
                        .then(r => r.json())
                        .then(types => {
                            calendarTypes = types;
                            uploadTypes = types;
                            catalogTypes = types;
                            dbg('Types loaded:', types.length);
                        })
                );
            }
            
            if (needsPeople && (calendarPeople.length === 0 || (typeof calendarPeople === 'object' && !Array.isArray(calendarPeople)))) {
                dbg('Loading people...');
                promises.push(
                    fetch(`${BACKEND_URL}/api/config/people`)
                        .then(r => r.json())
                        .catch(() => ({people: []}))
                        .then(data => {
                            const peopleList = data.people || [];
                            calendarPeople = peopleList;
                            uploadPeople = peopleList;
                            dbg('People loaded:', calendarPeople.length);
                        })
                );
            }
            
            if (promises.length > 0) {
                await Promise.all(promises);
            }
            
            dbg('ensureRepoDataLoaded: done', {
                typesCount: calendarTypes.length || uploadTypes.length || catalogTypes.length,
                peopleCount: calendarPeople.length || uploadPeople.length
            });
        }
        
        async function waitForElement(selector, timeoutMs = 2000) {
            dbg('waitForElement: start', selector, 'timeout:', timeoutMs);
            const startTime = Date.now();
            
            while (Date.now() - startTime < timeoutMs) {
                const element = document.querySelector(selector);
                if (element) {
                    dbg('waitForElement: found', selector);
                    return element;
                }
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            dbg('waitForElement: timeout', selector);
            return null;
        }
        
        // Hash routing helpers
        function parseHashRoute() {
            const hash = window.location.hash.replace('#', '');
            if (!hash) return { route: null, params: {} };
            
            const [route, queryString] = hash.split('?');
            const params = {};
            
            if (queryString) {
                const pairs = queryString.split('&');
                for (const pair of pairs) {
                    const [key, value] = pair.split('=');
                    if (key && value) {
                        params[decodeURIComponent(key)] = decodeURIComponent(value);
                    }
                }
            }
            
            return { route, params };
        }
        
        function buildHashRoute(route, params = {}) {
            if (!route) return '';
            const paramPairs = Object.entries(params)
                .filter(([key, value]) => key && value)
                .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
            
            if (paramPairs.length === 0) {
                return `#${route}`;
            }
            return `#${route}?${paramPairs.join('&')}`;
        }
        
        // Handle hash routing
        // SPRINT C1.R0: Funci√≥n opcional para actualizar navbar (no bloquea routing)
        function updateNavActive(route) {
            try {
                currentPage = route;
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.page === route);
                });
                viewDbg(`updateNavActive: updated nav for route=${route}`);
            } catch (e) {
                // SPRINT C1.R0.1: No bloquear si el navbar no est√° disponible
                // Esto es opcional y no debe causar errores fatales
                console.warn('[repo] Could not update nav active:', e);
                // No re-lanzar el error
            }
        }
        
        // SPRINT C1.R0: Funci√≥n determinista que procesa el hash actual y carga la p√°gina
        // Hacerla global para que pueda ser llamada desde Playwright
        // Definirla ANTES de bootstrap para que est√© disponible inmediatamente
        async function runRoutingNow() {
            const { route, params } = parseHashRoute();
            viewDbg(`runRoutingNow: hash=${window.location.hash}, route=${route}`);
            
            // Normalizar ruta: si no hay hash o ruta inv√°lida, usar 'inicio'
            const validRoutes = ['inicio', 'calendario', 'subir', 'buscar', 'plataformas', 'catalogo', 'configuracion', 'actividad', 'coordinacion', 'plan_review'];
            const normalizedRoute = (route && validRoutes.includes(route)) ? route : 'inicio';
            
            // Si la ruta cambi√≥, actualizar hash (sin disparar hashchange si ya es correcto)
            const expectedHash = buildHashRoute(normalizedRoute, params);
            if (window.location.hash !== expectedHash && normalizedRoute !== route) {
                // Solo actualizar si realmente cambi√≥
                viewDbg(`runRoutingNow: normalizing hash from ${window.location.hash} to ${expectedHash}`);
                window.location.hash = expectedHash;
                // El hashchange disparar√° runRoutingNow de nuevo, as√≠ que retornar
                return;
            }
            
            // Actualizar navbar (opcional, no bloquea)
            updateNavActive(normalizedRoute);
            
            // Cargar la p√°gina directamente (sin depender de .nav-item)
            viewDbg(`runRoutingNow: calling loadPage(${normalizedRoute})`);
            try {
                await loadPage(normalizedRoute, params);
                viewDbg(`runRoutingNow: loadPage(${normalizedRoute}) completed`);
            } catch (err) {
                console.error('[repo] Error in runRoutingNow:', err);
                viewDbg(`runRoutingNow: loadPage failed: ${err.message}`);
                throw err;
            }
        }
        
        // Hacer runRoutingNow global para acceso desde Playwright
        window.runRoutingNow = runRoutingNow;
        
        // SPRINT C1.R0: Registrar listener de hashchange (solo registro, no ejecuta routing inicial)
        function initHashRouting() {
            viewDbg('initHashRouting: registering hashchange listener');
            window.addEventListener('hashchange', async () => {
                viewDbg('hashchange event fired');
                try {
                    await runRoutingNow();
                } catch (err) {
                    console.error('[repo] Error in hashchange handler:', err);
                    viewDbg(`hashchange handler error: ${err.message}`);
                }
            });
        }
        
        // SPRINT C2.3.2: Funci√≥n para detectar modo E2E desde /api/health
        async function checkE2EMode() {
            if (healthChecked) {
                return e2eSeedEnabled;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                if (response.ok) {
                    const health = await response.json();
                    e2eSeedEnabled = health.e2e_seed_enabled === true;
                    healthChecked = true;
                    viewDbg(`bootstrap: E2E mode detected: ${e2eSeedEnabled}`);
                }
            } catch (e) {
                console.warn('[repo] Could not check E2E mode from /api/health:', e);
                // En caso de error, asumir modo producci√≥n (no E2E)
                e2eSeedEnabled = false;
                healthChecked = true;
            }
            
            return e2eSeedEnabled;
        }
        
        // SPRINT C1.R0: Bootstrap determinista
        async function bootstrap() {
            try {
                viewDbg('bootstrap: start');
                
                // Establecer app-ready INMEDIATAMENTE (antes de cualquier async)
                // Usar try/catch para asegurar que siempre se establece
                try {
                    document.body.setAttribute('data-testid', 'app-ready');
                    viewDbg('bootstrap: app-ready set');
                } catch (e) {
                    // Si body no existe a√∫n, crear un div
                    console.warn('[repo] Could not set app-ready on body:', e);
                    const readyDiv = document.createElement('div');
                    readyDiv.id = 'app-ready-marker';
                    readyDiv.setAttribute('data-testid', 'app-ready');
                    readyDiv.style.display = 'none';
                    document.documentElement.appendChild(readyDiv);
                    viewDbg('bootstrap: app-ready set on div');
                }
                
                // SPRINT C2.3.2: Detectar modo E2E al bootstrap (en paralelo, no bloquea)
                checkE2EMode().catch(() => {
                    // Si falla, continuar sin bloquear
                });
                
                // Registrar listener de hashchange
                initHashRouting();
                
                // SPRINT C2.2: Event delegation para botones Editar
                initEditDocumentDelegation();
                
                // Procesar hash inicial (puede venir ya con #subir)
                viewDbg('bootstrap: calling runRoutingNow for initial hash');
                await runRoutingNow();
                viewDbg('bootstrap: completed');
                
                // INSTRUMENTACI√ìN DIAGN√ìSTICA: Flag de bootstrap completado
                window.__REPO_BOOTSTRAP_DONE__ = true;
                console.log('[BOOT] __REPO_BOOTSTRAP_DONE__ set to true');
            } catch (err) {
                // SPRINT C1.R0.1: Capturar error fatal de bootstrap
                console.error('[BOOTSTRAP_FATAL]', err);
                console.error('[BOOTSTRAP_FATAL] Stack:', err.stack);
                viewDbg(`[BOOTSTRAP_FATAL] ${err.message || String(err)}`);
                
                // Asegurar que app-ready est√° establecido incluso si hay error
                try {
                    if (!document.body.hasAttribute('data-testid') || document.body.getAttribute('data-testid') !== 'app-ready') {
                        document.body.setAttribute('data-testid', 'app-ready');
                    }
                } catch (e) {
                    // Fallback: crear div
                    if (!document.getElementById('app-ready-marker')) {
                        const readyDiv = document.createElement('div');
                        readyDiv.id = 'app-ready-marker';
                        readyDiv.setAttribute('data-testid', 'app-ready');
                        readyDiv.style.display = 'none';
                        document.documentElement.appendChild(readyDiv);
                    }
                }
                
                // Establecer estado de error en la vista
                try {
                    setViewState('inicio', 'error', 'BOOTSTRAP_FATAL: ' + (err.message || String(err)));
                } catch (e) {
                    console.error('[BOOTSTRAP_FATAL] Could not set error state:', e);
                }
                
                // No re-lanzar el error para evitar que la p√°gina se cierre
                // El error ya est√° registrado en consola
            }
        }
        
        // SPRINT C1.R0: Funci√≥n para establecer app-ready de forma robusta
        function ensureAppReady() {
            try {
                if (document.body) {
                    document.body.setAttribute('data-testid', 'app-ready');
                    return true;
                } else {
                    const readyDiv = document.createElement('div');
                    readyDiv.id = 'app-ready-marker';
                    readyDiv.setAttribute('data-testid', 'app-ready');
                    readyDiv.style.display = 'none';
                    if (document.documentElement) {
                        document.documentElement.appendChild(readyDiv);
                        return true;
                    }
                }
            } catch (e) {
                console.error('[repo] Could not set app-ready:', e);
                try {
                    window.__app_ready__ = true;
                    return true;
                } catch (e2) {
                    console.error('[repo] Could not set app-ready even on window:', e2);
                    return false;
                }
            }
        }
        
        // SPRINT C1.R0: Inicializar bootstrap cuando DOM est√° listo
        // Asegurar que siempre se ejecuta, incluso si hay errores previos
        function startBootstrap() {
            // Establecer app-ready ANTES de llamar a bootstrap
            ensureAppReady();
            
            bootstrap().catch(err => {
                console.error('[repo] Fatal error in bootstrap:', err);
                // Asegurar app-ready incluso en caso de error fatal
                ensureAppReady();
            });
        }
        
        // Establecer app-ready inmediatamente si el DOM ya est√° listo
        if (document.readyState !== 'loading') {
            ensureAppReady();
            startBootstrap();
        } else {
            // Esperar a DOMContentLoaded
            document.addEventListener('DOMContentLoaded', () => {
                ensureAppReady();
                startBootstrap();
            }, { once: true });
        }
        
        // Helper para escapar HTML (si no existe)
        if (typeof escapeHtml === 'undefined') {
            window.escapeHtml = function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
        }
        
        // Helper para mostrar error visible
        function showErrorBanner(message, error = null) {
            const content = document.getElementById('page-content');
            if (!content) return;
            const escape = window.escapeHtml || ((t) => String(t).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'));
            const errorHtml = `
                <div class="alert alert-error" style="padding: 16px; margin: 16px 0; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b;">
                    <strong>Error cargando repositorio</strong>
                    <p style="margin: 8px 0 0 0;">${escape(message)}</p>
                    ${error ? `<pre style="margin-top: 8px; font-size: 0.85rem; overflow-x: auto;">${escape(error.stack || error.toString())}</pre>` : ''}
                    <p style="margin-top: 8px; font-size: 0.9rem;">Ver consola del navegador para m√°s detalles.</p>
                </div>
            `;
            content.innerHTML = errorHtml;
        }
        
        async function loadPage(page, params = {}) {
            viewDbg(`loadPage: start page=${page}`);
            const content = document.getElementById('page-content');
            if (!content) {
                viewDbg('loadPage: page-content not found!');
                return;
            }
            content.innerHTML = '<div class="loading">Cargando...</div>';
            viewDbg(`loadPage: content.innerHTML set to loading`);
            
            const titles = {
                inicio: 'Inicio',
                calendario: 'Calendario de documentos',
                subir: 'Subir documentos',
                buscar: 'Buscar documentos',
                plataformas: 'Plataformas',
                catalogo: 'Cat√°logo de documentos',
                actividad: 'Actividad',
                plan_review: 'Revisi√≥n Plan (CAE)'
            };
            
            const descriptions = {
                inicio: 'Vista general del repositorio',
                calendario: 'Visualiza qu√© documentos faltan por mes',
                subir: 'Sube documentos al repositorio',
                buscar: 'Busca documentos en el repositorio',
                plataformas: 'Estado de configuraci√≥n de plataformas',
                catalogo: 'Gestiona tipos de documento',
                actividad: 'Historial de actividad',
                plan_review: 'Revisa y decide sobre items del plan congelado'
            };
            
            document.getElementById('page-title').textContent = titles[page] || page;
            document.getElementById('page-description').textContent = descriptions[page] || '';
            
            // Timeout de seguridad (10 segundos)
            const timeoutId = setTimeout(() => {
                showErrorBanner(`La carga de la p√°gina "${page}" est√° tardando demasiado. Puede haber un problema de conexi√≥n o un error en el c√≥digo.`);
            }, 10000);
            
            try {
            switch(page) {
                case 'inicio':
                    setViewState('inicio', 'loaded');
                    try {
                        await loadInicio(params);
                        setViewState('inicio', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadInicio:', error);
                        setViewState('inicio', 'error', error.message || String(error));
                        throw error; // Re-throw para que el catch externo lo maneje
                    }
                    break;
                case 'calendario':
                    await ensureCalendarioLoaded();
                    break;
                case 'subir':
                    // Establecer 'loaded' INMEDIATAMENTE antes de cualquier async
                    setViewState('subir', 'loaded');
                    viewDbg('subir: setViewState loaded called');
                    try {
                        viewDbg('subir: calling loadSubir');
                        await loadSubir(params);
                        viewDbg('subir: loadSubir completed, setting ready');
                        setViewState('subir', 'ready');
                        viewDbg('subir: setViewState ready called');
                    } catch (error) {
                        viewDbg(`subir: error in loadSubir: ${error.message || String(error)}`);
                        console.error('[repo] Error in loadSubir:', error);
                        setViewState('subir', 'error', error.message || String(error));
                        throw error; // Re-throw para que el catch externo lo maneje
                    }
                    break;
                case 'buscar':
                    setViewState('buscar', 'loaded');
                    try {
                        await loadBuscar(params);
                        setViewState('buscar', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadBuscar:', error);
                        setViewState('buscar', 'error', error.message || String(error));
                        throw error; // Re-throw para que el catch externo lo maneje
                    }
                    break;
                case 'plataformas':
                    setViewState('plataformas', 'loaded');
                    try {
                        await loadPlataformas(params);
                        setViewState('plataformas', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadPlataformas:', error);
                        setViewState('plataformas', 'error', error.message || String(error));
                        throw error;
                    }
                    break;
                case 'catalogo':
                    setViewState('catalogo', 'loaded');
                    try {
                        await loadCatalogo(params);
                        setViewState('catalogo', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadCatalogo:', error);
                        setViewState('catalogo', 'error', error.message || String(error));
                        throw error;
                    }
                    break;
                case 'configuracion':
                case 'settings':
                    setViewState('settings', 'loaded');
                    try {
                        await loadConfiguracion();
                        setViewState('settings', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadConfiguracion:', error);
                        setViewState('settings', 'error', error.message || String(error));
                        throw error;
                    }
                    break;
                case 'actividad':
                    setViewState('actividad', 'loaded');
                    try {
                        await loadActividad(params);
                        setViewState('actividad', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadActividad:', error);
                        setViewState('actividad', 'error', error.message || String(error));
                        throw error;
                    }
                    break;
                case 'coordinacion':
                    setViewState('coordinacion', 'loaded');
                    try {
                        await loadCoordinacion(params);
                        setViewState('coordinacion', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadCoordinacion:', error);
                        setViewState('coordinacion', 'error', error.message || String(error));
                        throw error; // Re-throw para que el catch externo lo maneje
                    }
                    break;
                case 'plan_review':
                    setViewState('plan_review', 'loaded');
                    try {
                        await loadPlanReview(params);
                        setViewState('plan_review', 'ready');
                    } catch (error) {
                        console.error('[repo] Error in loadPlanReview:', error);
                        setViewState('plan_review', 'error', error.message || String(error));
                        throw error;
                    }
                    break;
                }
                clearTimeout(timeoutId);
                // Agregar se√±al DOM cuando la p√°gina est√° lista (legacy, mantener por compatibilidad)
                const pageContent = document.getElementById('page-content');
                if (pageContent) {
                    pageContent.setAttribute('data-testid', 'page-ready');
                    pageContent.setAttribute('data-page', page);
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('[repo] Error loading page:', error);
                showErrorBanner(`Error al cargar la p√°gina "${page}": ${error.message}`, error);
                // El estado de error ya se estableci√≥ en el switch, no hacer nada m√°s aqu√≠
            }
        }
        
        /**
         * SPRINT B3.2: Logger determinista para debug de vistas
         */
        function dbg(msg) {
            console.log("[VIEWDBG]", Date.now(), msg);
        }
        
        /**
         * SPRINT B3.1: Helper para establecer estado de vista de forma determinista.
         * Cada vista emite se√±ales: loaded (siempre), ready (√©xito), error (fallo).
         * 
         * @param {string} viewName - Nombre de la vista ('calendario', 'subir', 'buscar', etc.)
         * @param {string} state - Estado: 'loaded', 'ready', 'error'
         * @param {string} [errorMsg] - Mensaje de error si state === 'error'
         */
        // SPRINT C2.9.5: Obtener o crear contenedor global para markers de estado de vistas
        function getViewStateRoot() {
            let root = document.getElementById('view-state-root');
            if (!root) {
                // Si no existe, crearlo y a√±adirlo al body
                root = document.createElement('div');
                root.id = 'view-state-root';
                root.style.display = 'none';
                root.setAttribute('aria-hidden', 'true');
                document.body.appendChild(root);
                console.log('[repo] view-state-root created');
            }
            return root;
        }
        
        // SPRINT C2.9.13: Helper para crear/actualizar markers de debug
        function setDebugMarker(testId, attrs = {}) {
            const root = getViewStateRoot();
            if (!root) {
                console.warn(`[repo] Cannot set debug marker ${testId}: view-state-root not available`);
                return;
            }
            let el = root.querySelector(`[data-testid="${testId}"]`);
            if (!el) {
                el = document.createElement('div');
                el.setAttribute('data-testid', testId);
                el.style.display = 'none';
                root.appendChild(el);
            }
            Object.entries(attrs).forEach(([k, v]) => {
                if (v !== null && v !== undefined) {
                    el.setAttribute(k, String(v));
                }
            });
        }
        
        function setViewState(viewName, state, errorMsg = null) {
            // Log inmediato para debug
            console.log('[SETVIEWSTATE]', viewName, state, 'readyState=', document.readyState, 'body exists=', !!document.body);
            
            // SPRINT C2.9.5: Usar contenedor global invariante para markers
            const viewStateRoot = getViewStateRoot();
            
            if (!viewStateRoot) {
                console.warn(`[repo] setViewState: view-state-root not available for view ${viewName}, state ${state}`);
                viewDbg(`setViewState: view-state-root not available for ${viewName} ${state}`);
                return;
            }
            
            viewDbg(`setViewState: ${viewName} -> ${state} on view-state-root`);
            
            // SPRINT C2.9.5: Eliminar TODOS los markers previos de este viewName (loaded/ready/error)
            const existingMarkers = viewStateRoot.querySelectorAll(`[data-view="${viewName}"]`);
            existingMarkers.forEach(marker => {
                marker.remove();
            });
            
            // SPRINT C2.9.5: Crear EXACTAMENTE UN marker para el estado actual
            const marker = document.createElement('div');
            const testId = `view-${viewName}-${state}`;
            marker.setAttribute('data-testid', testId);
            marker.setAttribute('data-view', viewName);
            marker.style.display = 'none';
            marker.setAttribute('aria-hidden', 'true');
            
            if (state === 'error' && errorMsg) {
                marker.setAttribute('data-error', errorMsg.substring(0, 200));
            }
            
            viewStateRoot.appendChild(marker);
            viewDbg(`setViewState: ${viewName} -> ${state} applied, testId=${testId}`);
            
            // SPRINT C2.9.5: A√±adir alias para configuracion->settings (y viceversa)
            if (viewName === 'settings') {
                const aliasMarker = document.createElement('div');
                const aliasTestId = `view-configuracion-${state}`;
                aliasMarker.setAttribute('data-testid', aliasTestId);
                aliasMarker.setAttribute('data-view', 'configuracion');
                aliasMarker.style.display = 'none';
                aliasMarker.setAttribute('aria-hidden', 'true');
                if (state === 'error' && errorMsg) {
                    aliasMarker.setAttribute('data-error', errorMsg.substring(0, 200));
                }
                viewStateRoot.appendChild(aliasMarker);
                viewDbg(`setViewState: alias added: ${aliasTestId}`);
            } else if (viewName === 'configuracion') {
                const aliasMarker = document.createElement('div');
                const aliasTestId = `view-settings-${state}`;
                aliasMarker.setAttribute('data-testid', aliasTestId);
                aliasMarker.setAttribute('data-view', 'settings');
                aliasMarker.style.display = 'none';
                aliasMarker.setAttribute('aria-hidden', 'true');
                if (state === 'error' && errorMsg) {
                    aliasMarker.setAttribute('data-error', errorMsg.substring(0, 200));
                }
                viewStateRoot.appendChild(aliasMarker);
                viewDbg(`setViewState: alias added: ${aliasTestId}`);
            }
            
            // SPRINT C2.9.5: Mantener compatibilidad con error container visible (si es error)
            if (state === 'error' && errorMsg) {
                // Buscar o crear contenedor de error visible
                let errorDiv = document.getElementById('view-error-container');
                const content = document.getElementById('page-content');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = 'view-error-container';
                    errorDiv.setAttribute('data-testid', 'view-error-msg');
                    errorDiv.style.cssText = 'padding: 16px; margin: 16px 0; background: #7f1d1d; border: 1px solid #dc2626; border-radius: 8px; color: #fecaca;';
                    if (content) {
                        content.insertBefore(errorDiv, content.firstChild);
                    } else {
                        document.body.appendChild(errorDiv);
                    }
                }
                if (errorDiv) {
                    errorDiv.innerHTML = `<strong>Error al cargar ${viewName}:</strong> ${escapeHtml(errorMsg)}`;
                    errorDiv.style.display = 'block';
                }
            } else {
                // Ocultar mensaje de error si existe
                const errorDiv = document.getElementById('view-error-container');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }
        }
        
        // Utility functions
        function formatMonth(periodKey) {
            if (!periodKey) return '';
            const match = periodKey.match(/(\d{4})-(\d{2})/);
            if (match) {
                const year = match[1];
                const month = parseInt(match[2]) - 1;
                return `${MONTHS_ES[month]} ${year}`;
            }
            return periodKey;
        }
        
        function formatStatus(status) {
            return STATUS_LABELS[status] || status;
        }
        
        function getStatusBadgeClass(status) {
            if (status === 'AVAILABLE') return 'badge-ok';
            if (status === 'MISSING') return 'badge-falta';
            if (status === 'LATE') return 'badge-tarde';
            return 'badge-info';
        }
        
        // Inicio
        async function loadInicio(params = {}) {
            const content = document.getElementById('page-content');
            if (!content) {
                console.error('[repo] loadInicio: page-content not found');
                return;
            }
            
            try {
                // SPRINT C2.10.1: Limitar carga de documentos para evitar timeouts con miles de docs
                // Pedir solo 50 docs m√°s recientes para "subidas recientes" y KPIs
                const [types, docsResponse, rules, platforms] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        return r.json();
                    }),
                    fetch(`${BACKEND_URL}/api/repository/docs?limit=50&sort=date_desc`).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        return r.json();
                    }),
                    fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json()).catch(() => ({platforms: []}))
                ]);
                
                const docs = Array.isArray(docsResponse) ? docsResponse : [];
                
                // SPRINT C2.10.1: Obtener total de docs para KPI (sin cargar todos)
                let totalDocs = docs.length;
                let hasMoreDocs = false;
                try {
                    // Intentar obtener total desde un endpoint separado o estimar
                    // Por ahora, si tenemos 50 docs, asumimos que puede haber m√°s
                    if (docs.length >= 50) {
                        hasMoreDocs = true;
                        // Para el KPI, usar el n√∫mero cargado (ser√° aproximado)
                    }
                } catch (e) {
                    console.warn('[repo] Could not determine total docs count:', e);
                }
                
                // Calculate KPIs
                const periodicTypes = types.filter(t => {
                    const mode = t.validity_policy?.mode;
                    return mode === 'monthly' || mode === 'annual' || mode === 'quarter';
                });
                
                // Count missing this month (simplified)
                const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                const missingThisMonth = 0; // TODO: Calculate from expected periods
                
                // Count expiring soon (next 30 days) - solo en los docs cargados
                const expiringSoon = docs.filter(d => {
                    if (!d.computed_validity?.valid_to) return false;
                    const validTo = new Date(d.computed_validity.valid_to);
                    const now = new Date();
                    const daysDiff = (validTo - now) / (1000 * 60 * 60 * 24);
                    return daysDiff > 0 && daysDiff <= 30;
                }).length;
                
                // Count platforms without rules
                const egestiona = platforms.platforms?.find(p => p.key === 'egestiona');
                const coords = egestiona?.coordinations || [];
                const coordsWithoutRules = coords.filter(coord => {
                    const hasRule = rules.some(r => 
                        (r.scope === 'COORD' && r.coord_label === coord.label) ||
                        (r.scope === 'GLOBAL' && r.platform_key === 'egestiona')
                    );
                    return !hasRule;
                }).length;
                
                // Recent uploads (last 50, ya vienen ordenados por fecha desc)
                const recentDocs = docs.slice(0, 50);
                
                // Quick actions (missing documents)
                const quickActions = []; // TODO: Generate from expected periods
                
                content.innerHTML = `
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-card-title">Faltan este mes</div>
                            <div class="kpi-card-value">${missingThisMonth}</div>
                            <div class="kpi-card-subtitle">Documentos pendientes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">A punto de caducar</div>
                            <div class="kpi-card-value">${expiringSoon}</div>
                            <div class="kpi-card-subtitle">Pr√≥ximos 30 d√≠as</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Plataformas sin configurar</div>
                            <div class="kpi-card-value">${coordsWithoutRules}</div>
                            <div class="kpi-card-subtitle">Clientes sin reglas</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Documentos</div>
                            <div class="kpi-card-value">${hasMoreDocs ? '50+' : totalDocs}</div>
                            <div class="kpi-card-subtitle">En el repositorio${hasMoreDocs ? ' (mostrando primeros 50)' : ''}</div>
                        </div>
                    </div>
                    
                    ${quickActions.length > 0 ? `
                        <div class="card">
                            <h3>Acciones r√°pidas</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>De qui√©n</th>
                                            <th>Mes</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${quickActions.map(action => `
                                            <tr>
                                                <td>${action.typeName}</td>
                                                <td>${action.subjectName}</td>
                                                <td>${formatMonth(action.periodKey)}</td>
                                                <td>
                                                    <button class="btn btn-primary" onclick="uploadQuickAction('${action.typeId}', '${action.subjectKey}', '${action.scope}', '${action.periodKey}')">
                                                        Subir
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <h3>Subidas recientes</h3>
                        ${recentDocs.length > 0 ? `
                            ${hasMoreDocs ? '<p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 12px;">Mostrando √∫ltimas 50 subidas (hay m√°s resultados)</p>' : ''}
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Documento</th>
                                            <th>De qui√©n</th>
                                            <th>Mes</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${recentDocs.map(doc => {
                                            const type = types.find(t => t.type_id === doc.type_id);
                                            const period = doc.period_key ? formatMonth(doc.period_key) : '-';
                                            return `
                                                <tr>
                                                    <td>${type ? type.name : doc.type_id}</td>
                                                    <td>${doc.person_key || doc.company_key || '-'}</td>
                                                    <td>${period}</td>
                                                    <td>${new Date(doc.created_at).toLocaleDateString('es-ES')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #94a3b8;">No hay documentos recientes</p>'}
                    </div>
                `;
            } catch (error) {
                console.error('[repo] Error in loadInicio:', error);
                showErrorBanner(`Error al cargar inicio: ${error.message}`, error);
            }
        }
        
        function uploadQuickAction(typeId, subjectKey, scope, periodKey) {
            navigateTo('subir');
            window.uploadPrefill = {
                type_id: typeId,
                [scope === 'worker' ? 'person_key' : 'company_key']: subjectKey,
                period_key: periodKey
            };
        }
        
        // Calendario
        let calendarTypes = [];
        let calendarPeople = [];
        let selectedType = null;
        let selectedSubject = null;
        let selectedMonths = 24;
        let calendarPeriods = [];
        let selectedPeriod = null;
        let calendarFilters = {
            query: '',
            type_id: null,
            scope: 'all',  // 'all' | 'company' | 'worker'
            subject_key: null
        };
        let calendarSubjects = { companies: [], workers_by_company: {} };
        let calendarMaxMonthsBack = 24;  // M√°ximo de meses hacia atr√°s para per√≠odos faltantes
        // SPRINT C2.10.1: Estado de paginaci√≥n del calendario
        let calendarPagination = {
            subjectsPerPage: 50,  // M√°ximo de sujetos a mostrar por p√°gina
            maxTotalRows: 300,    // L√≠mite duro de filas totales
            currentPage: { expired: 1, expiring_soon: 1, missing: 1 }
        };
        
        // Funci√≥n auxiliar para formatear fechas
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch (e) {
                return dateStr;
            }
        }
        
        /**
         * SPRINT C2.6: Helper para fetch JSON con timeout usando AbortController
         * @param {string} url - URL a fetch
         * @param {object} opts - Opciones de fetch (default: {})
         * @param {number} ms - Timeout en milisegundos (default: 8000)
         * @returns {Promise<Response>} Response del fetch (sin parsear JSON, para mantener compatibilidad)
         */
        async function fetchJsonWithTimeout(url, opts = {}, ms = 8000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), ms);
            try {
                const response = await fetch(url, { ...opts, signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`Timeout after ${ms}ms: ${url}`);
                }
                throw error;
            }
        }
        
        // SPRINT C2.9.18: Declarar funciones antes de definirlas para poder asignarlas a window
        async function loadCalendario(params = {}) {
            // SPRINT C2.6: Logs clave al inicio
            console.log('[CAL] start');
            viewDbg('loadCalendario: start');
            
            // SPRINT C2.9.13: Marker de debug - inicio de loadCalendario (usando helper)
            setDebugMarker('dbg-calendario-load-start', { 'data-ts': Date.now() });
            
            const content = document.getElementById('page-content');
            
            // Ensure data is loaded
            await ensureRepoDataLoaded({ types: true, people: true });
            
            try {
                // SPRINT C2.6: Load data if not already loaded con timeout
                if (calendarTypes.length === 0) {
                    const typesUrl = `${BACKEND_URL}/api/repository/types`;
                    // SPRINT C2.9.16: Instrumentar fetch de types
                    const fetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    setDebugMarker(fetchEventId, { 'data-kind': 'start', 'data-url': typesUrl, 'data-ts': Date.now() });
                    try {
                        const typesResponse = await fetchJsonWithTimeout(typesUrl, {}, 10000);
                        const typesData = await typesResponse.json();
                        // SPRINT C2.9.16: Marker de √©xito
                        setDebugMarker(fetchEventId, { 'data-kind': 'success', 'data-url': typesUrl, 'data-ts': Date.now() });
                        // SPRINT C2.6: Normalizar a array si es inesperado
                        calendarTypes = Array.isArray(typesData) ? typesData : [];
                    } catch (error) {
                        // SPRINT C2.9.16: Marker de fallo
                        setDebugMarker(fetchEventId, { 'data-kind': 'fail', 'data-url': typesUrl, 'data-ts': Date.now(), 'data-error': error?.message || String(error) });
                        throw error;
                    }
                }
                if (calendarPeople.length === 0) {
                    const peopleUrl = `${BACKEND_URL}/api/config/people`;
                    // SPRINT C2.9.16: Instrumentar fetch de people
                    const fetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    setDebugMarker(fetchEventId, { 'data-kind': 'start', 'data-url': peopleUrl, 'data-ts': Date.now() });
                    try {
                        const peopleResponse = await fetchJsonWithTimeout(peopleUrl, {}, 10000);
                        const peopleData = await peopleResponse.json();
                        // SPRINT C2.9.16: Marker de √©xito
                        setDebugMarker(fetchEventId, { 'data-kind': 'success', 'data-url': peopleUrl, 'data-ts': Date.now() });
                        // SPRINT C2.6: Normalizar a array si es inesperado
                        calendarPeople = Array.isArray(peopleData?.people) ? peopleData.people : (Array.isArray(peopleData) ? peopleData : []);
                    } catch (error) {
                        // SPRINT C2.9.16: Marker de fallo
                        setDebugMarker(fetchEventId, { 'data-kind': 'fail', 'data-url': peopleUrl, 'data-ts': Date.now(), 'data-error': error?.message || String(error) });
                        console.warn('[CAL] Error loading people, using empty array:', error);
                        calendarPeople = [];
                    }
                }
                
                // Cargar documentos pendientes desde el nuevo endpoint
                // SPRINT C2.3.2: Limitar max_months_back a 12 solo en modo E2E
                // Asegurar que healthChecked est√© actualizado antes de usar
                if (!healthChecked) {
                    await checkE2EMode();
                }
                const effectiveMaxMonthsBack = e2eSeedEnabled ? Math.min(calendarMaxMonthsBack, 12) : calendarMaxMonthsBack;
                viewDbg(`loadCalendario: max_months_back=${effectiveMaxMonthsBack} (E2E=${e2eSeedEnabled}, original=${calendarMaxMonthsBack})`);
                viewDbg('loadCalendario: before fetch pendings');
                
                // SPRINT C2.9.13: Marker de debug - antes del fetch pending (usando helper)
                setDebugMarker('dbg-calendario-before-pending-fetch', { 'data-ts': Date.now() });
                
                // SPRINT C2.9.6: Usar fetchJsonWithTimeout con timeout de 10s para evitar cuelgues
                // (10s deja margen de 5s antes del timeout del helper de 15s)
                const pendingUrl = `${BACKEND_URL}/api/repository/docs/pending?months_ahead=3&max_months_back=${effectiveMaxMonthsBack}`;
                // SPRINT C2.9.16: Instrumentar fetch de pending
                const pendingFetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                setDebugMarker(pendingFetchEventId, { 'data-kind': 'start', 'data-url': pendingUrl, 'data-ts': Date.now() });
                let pendingResponse;
                let pendingData;
                // SPRINT C2.9.24: Inicializar variables fuera del try para que est√©n disponibles despu√©s
                let expiredRaw = [];
                let expiringSoonRaw = [];
                let missingRaw = [];
                try {
                    pendingResponse = await fetchJsonWithTimeout(pendingUrl, {}, 10000);
                    pendingData = await pendingResponse.json();
                    // SPRINT C2.9.16: Marker de √©xito
                    setDebugMarker(pendingFetchEventId, { 'data-kind': 'success', 'data-url': pendingUrl, 'data-ts': Date.now() });
                    viewDbg('loadCalendario: after fetch pendings');
                    
                    // SPRINT C2.6: Normalizar respuestas inesperadas
                    expiredRaw = Array.isArray(pendingData?.expired) ? pendingData.expired : (pendingData?.expired ? [pendingData.expired] : []);
                    expiringSoonRaw = Array.isArray(pendingData?.expiring_soon) ? pendingData.expiring_soon : (pendingData?.expiring_soon ? [pendingData.expiring_soon] : []);
                    missingRaw = Array.isArray(pendingData?.missing) ? pendingData.missing : (pendingData?.missing ? [pendingData.missing] : []);
                
                    // SPRINT C2.6: Log clave despu√©s de fetch pendings
                    console.log('[CAL] after fetch pending', { 
                        expired: expiredRaw.length, 
                        expiringSoon: expiringSoonRaw.length, 
                        missing: missingRaw.length 
                    });

                    if (isCalendarDebugEnabled()) {
                        const rawPeriods = (missingRaw || []).map(x => x?.period_key).filter(Boolean);
                        console.log('[CAL] raw pending periods count', rawPeriods.length);
                    }
                
                } catch (pendingError) {
                    // SPRINT C2.9.16: Marker de fallo para pending
                    setDebugMarker(pendingFetchEventId, { 'data-kind': 'fail', 'data-url': pendingUrl, 'data-ts': Date.now(), 'data-error': pendingError?.message || String(pendingError) });
                    // SPRINT C2.9.16: Si falla fetch esencial, renderizar error y retornar
                    const content = document.getElementById('page-content');
                    if (content) {
                        content.innerHTML = `
                            <div class="alert alert-error" data-testid="calendar-load-error">
                                Error cargando calendario: ${escapeHtml(pendingError?.message || String(pendingError))}
                            </div>
                        `;
                    }
                    setViewState('calendario', 'error', pendingError?.message || String(pendingError));
                    throw pendingError;
                }
                
                // Cargar subjects para obtener nombres de empresas y personas
                let subjectsCache = { companies: {}, people: {} };
                const subjectsUrl = `${BACKEND_URL}/api/repository/subjects`;
                // SPRINT C2.9.16: Instrumentar fetch de subjects
                const subjectsFetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                setDebugMarker(subjectsFetchEventId, { 'data-kind': 'start', 'data-url': subjectsUrl, 'data-ts': Date.now() });
                try {
                    // SPRINT C2.6: Usar fetchJsonWithTimeout para subjects
                    const subjectsResponse = await fetchJsonWithTimeout(subjectsUrl, {}, 10000);
                    const subjectsData = await subjectsResponse.json();
                    // SPRINT C2.9.16: Marker de √©xito
                    setDebugMarker(subjectsFetchEventId, { 'data-kind': 'success', 'data-url': subjectsUrl, 'data-ts': Date.now() });
                    // SPRINT C2.6: Normalizar respuestas inesperadas
                    calendarSubjects = {
                        companies: Array.isArray(subjectsData?.companies) ? subjectsData.companies : [],
                        workers_by_company: typeof subjectsData?.workers_by_company === 'object' && subjectsData.workers_by_company !== null ? subjectsData.workers_by_company : {}
                    };
                    if (calendarSubjects.companies) {
                        calendarSubjects.companies.forEach(c => {
                            if (c && c.id && c.name) {
                                subjectsCache.companies[c.id] = c.name;
                            }
                        });
                    }
                    if (calendarSubjects.workers_by_company) {
                        Object.keys(calendarSubjects.workers_by_company).forEach(companyId => {
                            const workers = calendarSubjects.workers_by_company[companyId];
                            if (Array.isArray(workers)) {
                                workers.forEach(w => {
                                    if (w && w.id && w.name) {
                                        subjectsCache.people[w.id] = w.name;
                                    }
                                });
                            }
                        });
                    }
                } catch (error) {
                    // SPRINT C2.9.16: Marker de fallo para subjects (non-fatal, pero registramos)
                    setDebugMarker(subjectsFetchEventId, { 'data-kind': 'fail', 'data-url': subjectsUrl, 'data-ts': Date.now(), 'data-error': error?.message || String(error) });
                    console.warn('[CAL] Error loading subjects (non-fatal):', error);
                    // Continuar sin subjects, usar valores por defecto
                }
                
                // Aplicar filtros iniciales (pueden estar vac√≠os)
                const filtered = applyCalendarFilters(
                    { expired: expiredRaw, expiring_soon: expiringSoonRaw, missing: missingRaw },
                    calendarFilters,
                    calendarMaxMonthsBack
                );
                
                content.innerHTML = `
                    <div class="card">
                        <h2>Documentos pendientes y pr√≥ximos vencimientos</h2>
                        <p style="color: #94a3b8; margin-bottom: 24px;">
                            Documentos expirados, pr√≥ximos a expirar y per√≠odos faltantes que requieren atenci√≥n.
                        </p>
                        
                        <!-- Bloque de filtros (paridad con #buscar) -->
                        <div class="catalog-filters" style="margin-bottom: 24px; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                            <div class="form-group">
                                <label class="form-label">Buscar</label>
                                <input type="text" class="form-input" 
                                       id="calendar-filter-text"
                                       data-testid="calendar-search-input"
                                       placeholder="Buscar por tipo, sujeto o archivo‚Ä¶"
                                       value="${escapeHtml(calendarFilters.query || '')}"
                                       oninput="debounceCalendarFilter('query', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo de documento</label>
                                <select class="form-input" 
                                        id="calendar-filter-type"
                                        data-testid="calendar-type-select"
                                        onchange="setCalendarFilter('type_id', this.value || null)">
                                    <option value="">Todos los tipos</option>
                                    ${calendarTypes.sort((a, b) => a.name.localeCompare(b.name)).map(type => `
                                        <option value="${type.type_id}" ${calendarFilters.type_id === type.type_id ? 'selected' : ''}>${escapeHtml(type.name)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aplica a</label>
                                <select class="form-input" 
                                        id="calendar-scope-select"
                                        data-testid="calendar-scope-select"
                                        onchange="setCalendarFilter('scope', this.value)">
                                    <option value="all" ${calendarFilters.scope === 'all' || calendarFilters.scope === null ? 'selected' : ''}>Todos</option>
                                    <option value="company" ${calendarFilters.scope === 'company' ? 'selected' : ''}>Empresa</option>
                                    <option value="worker" ${calendarFilters.scope === 'worker' ? 'selected' : ''}>Trabajador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sujeto</label>
                                <select class="form-input" 
                                        id="calendar-filter-subject"
                                        data-testid="calendar-subject-select"
                                        onchange="setCalendarFilter('subject_key', this.value || null)">
                                    <option value="">Todos</option>
                                    ${(() => {
                                        let options = [];
                                        // Si scope es 'all' o 'company', mostrar empresas
                                        if (calendarFilters.scope === 'all' || calendarFilters.scope === null || calendarFilters.scope === 'company') {
                                            calendarSubjects.companies?.forEach(company => {
                                                options.push(`<option value="${company.id}" ${calendarFilters.subject_key === company.id ? 'selected' : ''}>${escapeHtml(company.name)}</option>`);
                                            });
                                        }
                                        // Si scope es 'all' o 'worker', mostrar trabajadores
                                        if (calendarFilters.scope === 'all' || calendarFilters.scope === null || calendarFilters.scope === 'worker') {
                                            Object.keys(calendarSubjects.workers_by_company || {}).forEach(companyId => {
                                                const workers = calendarSubjects.workers_by_company[companyId];
                                                workers.forEach(worker => {
                                                    options.push(`<option value="${worker.id}" ${calendarFilters.subject_key === worker.id ? 'selected' : ''}>${escapeHtml(worker.name)}</option>`);
                                                });
                                            });
                                        }
                                        return options.join('');
                                    })()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">M√°x. meses atr√°s</label>
                                <input type="number" 
                                       class="form-input" 
                                       id="calendar-max-months-back"
                                       data-testid="calendar-max-months-back"
                                       min="1" 
                                       max="120" 
                                       value="${calendarMaxMonthsBack}"
                                       onchange="setCalendarMaxMonthsBack(parseInt(this.value) || 24)"
                                       oninput="setCalendarMaxMonthsBack(parseInt(this.value) || 24)"
                                       style="max-width: 120px;">
                                <small style="color: #94a3b8; display: block; margin-top: 4px;">L√≠mite de meses hacia atr√°s para per√≠odos faltantes</small>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-secondary" 
                                    onclick="clearCalendarFilters()"
                                    data-testid="calendar-filter-clear">Limpiar filtros</button>
                        </div>
                        
                        <!-- Tabs o secciones -->
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; gap: 8px; border-bottom: 1px solid #334155;">
                                <button class="btn btn-secondary" onclick="showPendingSection('expired')" id="pending-tab-expired" data-testid="calendar-tab-expired" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid #3b82f6;">
                                    Expirados <span class="badge badge-error" id="pending-count-expired">${filtered.expired.length}</span>
                                </button>
                                <button class="btn btn-secondary" onclick="showPendingSection('expiring_soon')" id="pending-tab-expiring_soon" data-testid="calendar-tab-expiring" style="border-radius: 4px 4px 0 0;">
                                    Expiran pronto <span class="badge badge-warning" id="pending-count-expiring_soon">${filtered.expiringSoon.length}</span>
                                </button>
                                <button class="btn btn-secondary" onclick="showPendingSection('missing')" id="pending-tab-missing" data-testid="calendar-tab-pending" style="border-radius: 4px 4px 0 0;">
                                    Pendientes de subir <span class="badge badge-info" id="pending-count-missing">${filtered.missing.length}</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contenedor de resultados -->
                        <div id="pending-documents-container" data-testid="calendar-pending-container">
                            ${renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, 'expired')}
                        </div>
                    </div>
                `;
                
                // Guardar datos globalmente para actualizaci√≥n (datos RAW, sin filtrar)
                window.pendingDocumentsDataRaw = { expired: expiredRaw, expiring_soon: expiringSoonRaw, missing: missingRaw };
                window.pendingDocumentsData = filtered; // Datos filtrados actuales
                window.subjectsCache = subjectsCache;
                
                // SPRINT B3.1: Las se√±ales DOM ahora se establecen en loadPage() usando setViewState()
                // Mantener calendar-ready para compatibilidad con otros tests
                viewDbg('loadCalendario: after render table');
                const pendingContainer = document.getElementById('pending-documents-container');
                if (pendingContainer) {
                    pendingContainer.setAttribute('data-testid', 'calendar-ready');
                    // SPRINT C2.8: Asegurar que calendar-pending-container est√° presente (puede haberse perdido en el innerHTML)
                    if (!pendingContainer.hasAttribute('data-testid') || pendingContainer.getAttribute('data-testid') !== 'calendar-pending-container') {
                        pendingContainer.setAttribute('data-testid', 'calendar-pending-container');
                    }
                }
                
                // SPRINT C2.3: Se√±al de filtros listos (siempre se renderizan, incluso sin datos)
                const filtersContainer = content.querySelector('.catalog-filters');
                if (filtersContainer) {
                    filtersContainer.setAttribute('data-testid', 'calendar-filters-ready');
                }
                // Tambi√©n verificar que el bot√≥n clear existe
                const clearButton = content.querySelector('[data-testid="calendar-filter-clear"]');
                if (!clearButton) {
                    console.warn('[CAL] calendar-filter-clear button not found after render');
                }
                
                // SPRINT C2.6: Log clave despu√©s de render
                console.log('[CAL] after render');
                viewDbg('loadCalendario: end');
                // SPRINT C2.6: Log clave al final
                console.log('[CAL] end');
                
                // SPRINT C2.9.13: Marker de debug - √©xito final (usando helper)
                setDebugMarker('dbg-calendario-load-success', { 'data-ts': Date.now() });
                
                // SPRINT C2.9.7: Duplicar se√±al expl√≠citamente aqu√≠
                setViewState('calendario', 'ready');
                
                // SPRINT B3.1: No establecer view-calendar-ready aqu√≠, se hace en loadPage()
            } catch (error) {
                // SPRINT C2.9.6: Log de error y renderizar bloque de error visible
                console.error('[CAL] Error in loadCalendario:', error);
                viewDbg('loadCalendario: caught error ' + (error.message || String(error)));
                
                // SPRINT C2.9.13: Marker de debug - catch de pending (usando helper)
                setDebugMarker('dbg-calendario-pending-catch', { 
                    'data-ts': Date.now(),
                    'data-error': error?.message || String(error)
                });
                
                // SPRINT C2.9.7: Duplicar se√±al expl√≠citamente aqu√≠
                setViewState('calendario', 'error', error?.message || String(error));
                
                // SPRINT C2.9.6: Renderizar bloque de error visible en la vista
                const content = document.getElementById('page-content');
                if (content) {
                    const errorMessage = error?.message || String(error) || 'Error desconocido';
                    const errorHtml = `
                        <div class="card">
                            <div class="card-header">
                                <h3>Calendario de Documentos</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-error" data-testid="calendar-pending-error" style="padding: 16px; margin: 16px 0; background: #7f1d1d; border: 1px solid #dc2626; border-radius: 8px; color: #fecaca;">
                                    <strong>Error cargando pendientes:</strong> ${escapeHtml(errorMessage)}
                                </div>
                            </div>
                        </div>
                    `;
                    content.innerHTML = errorHtml;
                }
                
                // SPRINT C2.9.6: Re-lanzar error para que loadPage() lo maneje con setViewState('calendario', 'error')
                throw error;
            }
        }
        
        async function ensureCalendarioLoaded() {
            setViewState('calendario', 'loaded');
            await loadCalendario();
        }
        
        // SPRINT C2.9.18: Asignar a window SIEMPRE al cargar el script (no dentro de funciones)
        window.loadCalendario = loadCalendario;
        window.ensureCalendarioLoaded = ensureCalendarioLoaded;
        
        // SPRINT C2.9.19: Barrera determinista de API del frontend
        window.__REPO_API_READY__ = true;
        console.log('[BOOT] __REPO_API_READY__ set to true');
        
        // INSTRUMENTACI√ìN DIAGN√ìSTICA: Logs despu√©s de definir ensureCalendarioLoaded
        console.log('[BOOT] ensureCalendarioLoaded defined');
        console.log('[BOOT] window.ensureCalendarioLoaded === undefined ?', window.ensureCalendarioLoaded === undefined ? 'UNDEFINED' : 'DEFINED');
        
        function renderPendingDocuments(expired, expiringSoon, missing, activeSection = 'expired') {
            const subjectsCache = window.subjectsCache || { companies: {}, people: {} };
            
            // SPRINT C2.10.1: Helper para paginar sujetos y aplicar l√≠mite de filas
            function paginateSubjects(grouped, sectionKey) {
                const page = calendarPagination.currentPage[sectionKey] || 1;
                const subjectsPerPage = calendarPagination.subjectsPerPage;
                const maxTotalRows = calendarPagination.maxTotalRows;
                
                const subjectKeys = Object.keys(grouped);
                const totalSubjects = subjectKeys.length;
                const startIdx = (page - 1) * subjectsPerPage;
                const endIdx = startIdx + subjectsPerPage;
                const paginatedKeys = subjectKeys.slice(startIdx, endIdx);
                
                // Calcular total de filas
                let totalRows = 0;
                const paginatedGroups = {};
                for (const key of paginatedKeys) {
                    const items = grouped[key];
                    totalRows += items.length;
                    // SPRINT C2.10.1: L√≠mite duro de 300 filas
                    if (totalRows > maxTotalRows) {
                        // Cortar items del √∫ltimo sujeto si excede el l√≠mite
                        const remainingRows = maxTotalRows - (totalRows - items.length);
                        paginatedGroups[key] = items.slice(0, remainingRows);
                        break;
                    }
                    paginatedGroups[key] = items;
                }
                
                const hasMore = endIdx < totalSubjects || totalRows >= maxTotalRows;
                
                return { groups: paginatedGroups, hasMore, totalSubjects, currentPage: page };
            }
            
            // Agrupar por sujeto
            function groupBySubject(items, getSubjectKey) {
                const groups = {};
                items.forEach(item => {
                    const key = getSubjectKey(item);
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(item);
                });
                return groups;
            }
            
            function getSubjectName(item) {
                if (item.person_key) {
                    // Buscar en cache de subjects primero
                    if (subjectsCache.people[item.person_key]) {
                        return subjectsCache.people[item.person_key];
                    }
                    // Fallback a calendarPeople
                    const person = (calendarPeople.people || calendarPeople || []).find(p => p.worker_id === item.person_key);
                    return person ? person.full_name : item.person_key || '(sin nombre)';
                } else if (item.company_key) {
                    // Buscar en cache de subjects primero
                    if (subjectsCache.companies[item.company_key]) {
                        return subjectsCache.companies[item.company_key];
                    }
                    return item.company_key || '(sin nombre)';
                }
                return '(sin nombre)';
            }
            
            function getSubjectScope(item) {
                return item.scope === 'worker' ? 'Trabajador' : item.scope === 'company' ? 'Empresa' : '-';
            }
            
            let html = '';
            
            // Secci√≥n: Expirados
            if (activeSection === 'expired') {
                if (expired.length === 0) {
                    // Verificar si hay filtros activos
                    const hasFilters = calendarFilters.query || calendarFilters.type_id || (calendarFilters.scope && calendarFilters.scope !== 'all') || calendarFilters.subject_key;
                    if (hasFilters) {
                        html += '<div class="alert alert-info">No hay documentos expirados con estos filtros.</div>';
                    } else {
                        html += '<div class="alert alert-info">No hay documentos expirados.</div>';
                    }
                } else {
                    const grouped = groupBySubject(expired, d => `${d.scope || 'unknown'}_${d.company_key || ''}_${d.person_key || ''}`);
                    // SPRINT C2.10.1: Paginar sujetos
                    const { groups: paginatedGroups, hasMore, totalSubjects, currentPage } = paginateSubjects(grouped, 'expired');
                    
                    Object.keys(paginatedGroups).forEach(subjectKey => {
                        const items = paginatedGroups[subjectKey];
                        const firstItem = items[0];
                        const subjectName = getSubjectName(firstItem);
                        const subjectScope = getSubjectScope(firstItem);
                        
                        html += `
                            <div class="card" style="margin-bottom: 16px;">
                                <h3 style="margin-bottom: 8px;">${escapeHtml(subjectName)}</h3>
                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 16px;">${subjectScope}</p>
                                <div class="table-container">
                                    <table class="catalog-table">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Archivo</th>
                                                <th>Estado</th>
                                                <th>Fecha de caducidad</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map(item => {
                                                const type = calendarTypes.find(t => t.type_id === item.type_id);
                                                const typeName = type ? type.name : item.type_id;
                                                const typeCode = item.type_id;
                                                const validityEndDate = item.validity_end_date;
                                                const daysUntilExpiry = item.days_until_expiry || 0;
                                                const docId = item.doc_id || '';
                                                
                                                return `
                                                    <tr>
                                                        <td>
                                                            <strong>${escapeHtml(typeName)}</strong>
                                                            <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${escapeHtml(typeCode)}</div>
                                                        </td>
                                                        <td>${escapeHtml(item.file_name_original || docId.substring(0, 8) || 'N/A')}</td>
                                                        <td><span class="badge badge-error">Expirado (hace ${Math.abs(daysUntilExpiry)} d√≠as)</span></td>
                                                        <td>${validityEndDate ? formatDate(validityEndDate) : '-'}</td>
                                                        <td>
                                                            <button class="btn btn-primary btn-sm" onclick="navigateToUploadForDocument('${docId}', '${item.type_id}', '${item.scope}', '${item.person_key || ''}', '${item.company_key || ''}')" data-testid="calendar-action-resubir">
                                                                Resubir
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                    
                    // SPRINT C2.10.1: Bot√≥n "Cargar m√°s" si hay m√°s sujetos
                    if (hasMore) {
                        html += `
                            <div style="margin-top: 16px; text-align: center;">
                                <button class="btn btn-secondary" onclick="loadMoreCalendarSubjects('expired')" data-testid="calendar-load-more-expired">
                                    Cargar m√°s (mostrando ${Object.keys(paginatedGroups).length} de ${totalSubjects} sujetos)
                                </button>
                            </div>
                        `;
                    }
                }
            }
            
            // Secci√≥n: Expiran pronto
            if (activeSection === 'expiring_soon') {
                if (expiringSoon.length === 0) {
                    const hasFilters = calendarFilters.query || calendarFilters.type_id || (calendarFilters.scope && calendarFilters.scope !== 'all') || calendarFilters.subject_key;
                    if (hasFilters) {
                        html += '<div class="alert alert-info">No hay documentos pr√≥ximos a expirar con estos filtros.</div>';
                    } else {
                        html += '<div class="alert alert-info">No hay documentos pr√≥ximos a expirar.</div>';
                    }
                } else {
                    const grouped = groupBySubject(expiringSoon, d => `${d.scope || 'unknown'}_${d.company_key || ''}_${d.person_key || ''}`);
                    // SPRINT C2.10.1: Paginar sujetos
                    const { groups: paginatedGroups, hasMore, totalSubjects, currentPage } = paginateSubjects(grouped, 'expiring_soon');
                    
                    Object.keys(paginatedGroups).forEach(subjectKey => {
                        const items = paginatedGroups[subjectKey];
                        const firstItem = items[0];
                        const subjectName = getSubjectName(firstItem);
                        const subjectScope = getSubjectScope(firstItem);
                        
                        html += `
                            <div class="card" style="margin-bottom: 16px;">
                                <h3 style="margin-bottom: 8px;">${escapeHtml(subjectName)}</h3>
                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 16px;">${subjectScope}</p>
                                <div class="table-container">
                                    <table class="catalog-table">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Archivo</th>
                                                <th>Estado</th>
                                                <th>Fecha de caducidad</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map(item => {
                                                const type = calendarTypes.find(t => t.type_id === item.type_id);
                                                const typeName = type ? type.name : item.type_id;
                                                const typeCode = item.type_id;
                                                const validityEndDate = item.validity_end_date;
                                                const daysUntilExpiry = item.days_until_expiry || 0;
                                                const docId = item.doc_id || '';
                                                
                                                return `
                                                    <tr>
                                                        <td>
                                                            <strong>${escapeHtml(typeName)}</strong>
                                                            <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${escapeHtml(typeCode)}</div>
                                                        </td>
                                                        <td>${escapeHtml(item.file_name_original || docId.substring(0, 8) || 'N/A')}</td>
                                                        <td><span class="badge badge-warning">Expira pronto (${daysUntilExpiry} d√≠as)</span></td>
                                                        <td>${validityEndDate ? formatDate(validityEndDate) : '-'}</td>
                                                        <td>
                                                            <button class="btn btn-primary btn-sm" onclick="navigateToUploadForDocument('${docId}', '${item.type_id}', '${item.scope}', '${item.person_key || ''}', '${item.company_key || ''}')" data-testid="calendar-action-resubir">
                                                                Resubir
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                    
                    // SPRINT C2.10.1: Bot√≥n "Cargar m√°s" si hay m√°s sujetos
                    if (hasMore) {
                        html += `
                            <div style="margin-top: 16px; text-align: center;">
                                <button class="btn btn-secondary" onclick="loadMoreCalendarSubjects('expiring_soon')" data-testid="calendar-load-more-expiring_soon">
                                    Cargar m√°s (mostrando ${Object.keys(paginatedGroups).length} de ${totalSubjects} sujetos)
                                </button>
                            </div>
                        `;
                    }
                }
            }
            
            // Secci√≥n: Pendientes de subir
            if (activeSection === 'missing') {
                // Botones para preparar env√≠o CAE
                html += `
                    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="openCAEPlanModal()" data-testid="cae-plan-button">
                            Preparar env√≠o CAE (filtrado)
                        </button>
                        <button class="btn btn-secondary" onclick="openCAESelectionModal()" data-testid="cae-selection-button">
                            Preparar env√≠o CAE (selecci√≥n)
                        </button>
                    </div>
                `;
                
                if (missing.length === 0) {
                    const hasFilters = calendarFilters.query || calendarFilters.type_id || (calendarFilters.scope && calendarFilters.scope !== 'all') || calendarFilters.subject_key;
                    if (hasFilters) {
                        html += '<div class="alert alert-info">No hay per√≠odos pendientes de subir con estos filtros.</div>';
                    } else {
                        html += '<div class="alert alert-info">No hay per√≠odos pendientes de subir.</div>';
                    }
                } else {
                    const grouped = groupBySubject(missing, d => `${d.scope || 'unknown'}_${d.company_key || ''}_${d.person_key || ''}`);
                    // SPRINT C2.10.1: Paginar sujetos
                    const { groups: paginatedGroups, hasMore, totalSubjects, currentPage } = paginateSubjects(grouped, 'missing');
                    
                    Object.keys(paginatedGroups).forEach(subjectKey => {
                        const items = paginatedGroups[subjectKey];
                        const firstItem = items[0];
                        const subjectName = getSubjectName(firstItem);
                        const subjectScope = getSubjectScope(firstItem);
                        
                        html += `
                            <div class="card" style="margin-bottom: 16px;">
                                <h3 style="margin-bottom: 8px;">${escapeHtml(subjectName)}</h3>
                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 16px;">${subjectScope}</p>
                                <div class="table-container">
                                    <table class="catalog-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 40px;"><input type="checkbox" id="select-all-pending" onchange="toggleAllPendingRows(this.checked)"></th>
                                                <th>Tipo de documento</th>
                                                <th>Per√≠odo</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map((item, idx) => {
                                                const typeName = item.type_name || item.type_id;
                                                const typeCode = item.type_id;
                                                const periodKey = item.period_key;
                                                const itemId = `pending-${subjectKey}-${idx}`;
                                                const itemData = JSON.stringify({
                                                    type_id: item.type_id,
                                                    scope: item.scope,
                                                    company_key: item.company_key,
                                                    person_key: item.person_key,
                                                    period_key: periodKey
                                                }).replace(/"/g, '&quot;');
                                                
                                                return `
                                                    <tr data-testid="calendar-pending-row" 
                                                        data-pending-item='${itemData}'
                                                        data-pending-type-id="${escapeHtml(item.type_id)}"
                                                        data-pending-period-key="${escapeHtml(periodKey)}"
                                                        data-pending-company-key="${escapeHtml(item.company_key || '')}"
                                                        data-pending-person-key="${escapeHtml(item.person_key || '')}">
                                                        <td>
                                                            <input type="checkbox" class="pending-row-checkbox" data-item-id="${itemId}" onchange="updateCAESelectionCount()">
                                                        </td>
                                                        <td>
                                                            <strong>${escapeHtml(typeName)}</strong>
                                                            <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${escapeHtml(typeCode)}</div>
                                                        </td>
                                                        <td>
                                                            <span data-testid="calendar-period">${escapeHtml(periodKey)}</span>
                                                        </td>
                                                        <td><span class="badge badge-info">Pendiente de subir</span></td>
                                                        <td>
                                                            <button class="btn btn-primary btn-sm" onclick="navigateToUploadForPeriod('${item.type_id}', '${item.scope}', '${item.person_key || ''}', '${item.company_key || ''}', '${periodKey}')" data-testid="calendar-action-subir">
                                                                Subir documento
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                    
                    // SPRINT C2.10.1: Bot√≥n "Cargar m√°s" si hay m√°s sujetos
                    if (hasMore) {
                        html += `
                            <div style="margin-top: 16px; text-align: center;">
                                <button class="btn btn-secondary" onclick="loadMoreCalendarSubjects('missing')" data-testid="calendar-load-more-missing">
                                    Cargar m√°s (mostrando ${Object.keys(paginatedGroups).length} de ${totalSubjects} sujetos)
                                </button>
                            </div>
                        `;
                    }
                }
            }
            
            return html;
        }
        
        // SPRINT C2.10.1: Funci√≥n para cargar m√°s sujetos en el calendario
        function loadMoreCalendarSubjects(section) {
            if (!calendarPagination.currentPage[section]) {
                calendarPagination.currentPage[section] = 1;
            }
            calendarPagination.currentPage[section]++;
            
            // Re-renderizar la secci√≥n activa
            const rawData = window.pendingDocumentsDataRaw || { expired: [], expiring_soon: [], missing: [] };
            const filtered = applyCalendarFilters(rawData, calendarFilters, calendarMaxMonthsBack);
            window.pendingDocumentsData = filtered;
            
            // Determinar secci√≥n activa
            const activeTab = document.querySelector('#pending-tab-expired[style*="border-bottom: 2px solid"]') ? 'expired' :
                              document.querySelector('#pending-tab-expiring_soon[style*="border-bottom: 2px solid"]') ? 'expiring_soon' :
                              document.querySelector('#pending-tab-missing[style*="border-bottom: 2px solid"]') ? 'missing' : section;
            
            const container = document.getElementById('pending-documents-container');
            if (container) {
                container.innerHTML = renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, activeTab);
            }
        }
        
        // Funci√≥n para normalizar strings (reutilizar de #buscar si existe, sino crear)
        function normalizeString(str) {
            if (!str) return '';
            return str.toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Quitar tildes
                .trim();
        }
        
        function isCalendarDebugEnabled() {
            try {
                // Opt-in expl√≠cito:
                //  - window.__DEBUG_CALENDAR__ = true
                //  - /repository?debug_calendar=1#calendario
                if (window.__DEBUG_CALENDAR__ === true) return true;
                const sp = new URLSearchParams(window.location.search || '');
                return sp.get('debug_calendar') === '1';
            } catch (_) {
                return false;
            }
        }

        function getMonthsDiffFromPeriod(period) {
            try {
                if (typeof period !== 'string' || period.length < 7) return NaN;
                if (period[4] !== '-') return NaN;
                const y = parseInt(period.slice(0, 4), 10);
                const m = parseInt(period.slice(5, 7), 10);
                if (!Number.isFinite(y) || !Number.isFinite(m) || m < 1 || m > 12) return NaN;
                // C√°lculo robusto (YYYY-MM)
                const today = new Date();
                const monthsDiff = (today.getFullYear() - y) * 12 + (today.getMonth() - (m - 1));
                return monthsDiff;
            } catch (_) {
                return NaN;
            }
        }
        
        // Funci√≥n √∫nica para aplicar filtros a datos de calendario
        function applyCalendarFilters(pendingData, filters, maxMonthsBack = 24) {
            const subjectsCache = window.subjectsCache || { companies: {}, people: {} };
            const debug = isCalendarDebugEnabled();

            if (debug) {
                const rawMissing = pendingData.missing || [];
                // 10 muestras con include/exclude seg√∫n maxMonthsBack
                rawMissing.slice(0, 10).forEach(item => {
                    const period = item?.period_key;
                    const monthsDiff = getMonthsDiffFromPeriod(period);
                    const include = Number.isFinite(monthsDiff) && monthsDiff >= 0 && monthsDiff <= maxMonthsBack;
                    console.log('[CAL] sample', period, monthsDiff, include);
                });
            }
            
            function filterItems(items, isMissing = false) {
                const beforeCount = items.length;
                const filtered = items.filter(item => {
                    // Filtro por query (texto)
                    if (filters.query) {
                        const queryNorm = normalizeString(filters.query);
                        const fileName = normalizeString(item.file_name_original || item.doc_file_name || '');
                        const typeName = normalizeString(item.type_name || '');
                        const typeId = normalizeString(item.type_id || '');
                        
                        // Obtener nombre del sujeto
                        let subjectName = '';
                        if (item.person_key) {
                            subjectName = subjectsCache.people[item.person_key] || item.person_key || '';
                        } else if (item.company_key) {
                            subjectName = subjectsCache.companies[item.company_key] || item.company_key || '';
                        }
                        const subjectNameNorm = normalizeString(subjectName);
                        
                        const matchesQuery = fileName.includes(queryNorm) ||
                                           typeName.includes(queryNorm) ||
                                           typeId.includes(queryNorm) ||
                                           subjectNameNorm.includes(queryNorm);
                        
                        if (!matchesQuery) return false;
                    }
                    
                    // Filtro por type_id
                    if (filters.type_id && item.type_id !== filters.type_id) {
                        return false;
                    }
                    
                    // Filtro por scope (all | company | worker)
                    if (filters.scope && filters.scope !== 'all') {
                        if (item.scope !== filters.scope) {
                            return false;
                        }
                    }
                    
                    // Filtro por subject_key
                    if (filters.subject_key) {
                        const matchesSubject = (item.person_key === filters.subject_key) ||
                                             (item.company_key === filters.subject_key);
                        if (!matchesSubject) return false;
                    }
                    
                    // Filtro por maxMonthsBack (solo para per√≠odos faltantes)
                    if (isMissing && item.period_key) {
                        const monthsDiff = getMonthsDiffFromPeriod(item.period_key);
                        if (!Number.isFinite(monthsDiff)) {
                            console.warn('[CAL] invalid period', item.period_key);
                            return false;
                        }
                        // Solo incluir si 0 <= monthsDiff <= maxMonthsBack
                        if (monthsDiff < 0 || monthsDiff > maxMonthsBack) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                if (debug && isMissing) {
                    console.log('[CAL] filtered pending periods count', filtered.length, 'max=', maxMonthsBack);
                }
                
                return filtered;
            }
            
            return {
                expired: filterItems(pendingData.expired || [], false),
                expiringSoon: filterItems(pendingData.expiring_soon || [], false),
                missing: filterItems(pendingData.missing || [], true)
            };
        }
        
        function setCalendarMaxMonthsBack(value) {
            const parsed = parseInt(value, 10);
            const next = Number.isFinite(parsed) && parsed > 0 ? parsed : 24;
            calendarMaxMonthsBack = next;
            const input = document.getElementById('calendar-max-months-back');
            if (input && input.value !== String(next)) input.value = String(next);
            applyCalendarFiltersAndUpdate();
        }

        // Funci√≥n para aplicar filtros y actualizar UI
        function applyCalendarFiltersAndUpdate() {
            const rawData = window.pendingDocumentsDataRaw || { expired: [], expiring_soon: [], missing: [] };
            
            const filtered = applyCalendarFilters(rawData, calendarFilters, calendarMaxMonthsBack);
            
            // Actualizar datos globales
            window.pendingDocumentsData = filtered;
            
            // Actualizar contadores de tabs
            const expiredCount = document.getElementById('pending-count-expired');
            const expiringSoonCount = document.getElementById('pending-count-expiring_soon');
            const missingCount = document.getElementById('pending-count-missing');
            
            if (expiredCount) expiredCount.textContent = filtered.expired.length;
            if (expiringSoonCount) expiringSoonCount.textContent = filtered.expiringSoon.length;
            if (missingCount) missingCount.textContent = filtered.missing.length;
            
            // Re-renderizar secci√≥n activa
            const activeTab = document.querySelector('#pending-tab-expired[style*="border-bottom: 2px solid"]') ? 'expired' :
                              document.querySelector('#pending-tab-expiring_soon[style*="border-bottom: 2px solid"]') ? 'expiring_soon' :
                              document.querySelector('#pending-tab-missing[style*="border-bottom: 2px solid"]') ? 'missing' : 'expired';
            
            const container = document.getElementById('pending-documents-container');
            if (container) {
                container.innerHTML = renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, activeTab);
            }
        }
        
        // Debounce para b√∫squeda de texto
        let calendarFilterTimeout;
        function debounceCalendarFilter(key, value) {
            clearTimeout(calendarFilterTimeout);
            calendarFilterTimeout = setTimeout(() => {
                calendarFilters[key] = value;
                applyCalendarFiltersAndUpdate();
            }, 300);
        }
        
        // Funci√≥n para establecer filtro
        function setCalendarFilter(key, value) {
            calendarFilters[key] = value;
            
            // Si cambia scope, reconstruir opciones del select de sujeto
            if (key === 'scope') {
                // Normalizar: null -> 'all'
                if (value === null) {
                    calendarFilters.scope = 'all';
                    value = 'all';
                }
                
                // Reconstruir opciones del select de sujeto seg√∫n scope
                const subjectSelect = document.getElementById('calendar-filter-subject');
                if (subjectSelect) {
                    // Reconstruir opciones seg√∫n scope
                    subjectSelect.innerHTML = '<option value="">Todos</option>';
                    if (value === 'all' || value === 'company') {
                        calendarSubjects.companies?.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.id;
                            option.textContent = company.name;
                            subjectSelect.appendChild(option);
                        });
                    }
                    if (value === 'all' || value === 'worker') {
                        Object.keys(calendarSubjects.workers_by_company || {}).forEach(companyId => {
                            const workers = calendarSubjects.workers_by_company[companyId];
                            workers.forEach(worker => {
                                const option = document.createElement('option');
                                option.value = worker.id;
                                option.textContent = worker.name;
                                subjectSelect.appendChild(option);
                            });
                        });
                    }
                    // Resetear selecci√≥n si el valor actual no es compatible
                    if (calendarFilters.subject_key) {
                        const currentValue = calendarFilters.subject_key;
                        const hasOption = Array.from(subjectSelect.options).some(opt => opt.value === currentValue);
                        if (!hasOption) {
                            calendarFilters.subject_key = null;
                            subjectSelect.value = '';
                        }
                    }
                }
            }
            
            applyCalendarFiltersAndUpdate();
        }
        
        // Funci√≥n para limpiar filtros
        function clearCalendarFilters() {
            calendarFilters = {
                query: '',
                type_id: null,
                scope: 'all',
                subject_key: null
            };
            calendarMaxMonthsBack = 24;  // Resetear a default
            
            // Resetear inputs
            const queryInput = document.getElementById('calendar-filter-text');
            const typeSelect = document.getElementById('calendar-filter-type');
            const subjectSelect = document.getElementById('calendar-filter-subject');
            const scopeSelect = document.getElementById('calendar-scope-select');
            const maxMonthsBackInput = document.getElementById('calendar-max-months-back');
            
            if (queryInput) queryInput.value = '';
            if (typeSelect) typeSelect.value = '';
            if (scopeSelect) scopeSelect.value = 'all';
            if (maxMonthsBackInput) maxMonthsBackInput.value = '24';
            if (subjectSelect) {
                // Reconstruir opciones completas
                subjectSelect.innerHTML = '<option value="">Todos</option>';
                calendarSubjects.companies?.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    subjectSelect.appendChild(option);
                });
                Object.keys(calendarSubjects.workers_by_company || {}).forEach(companyId => {
                    const workers = calendarSubjects.workers_by_company[companyId];
                    workers.forEach(worker => {
                        const option = document.createElement('option');
                        option.value = worker.id;
                        option.textContent = worker.name;
                        subjectSelect.appendChild(option);
                    });
                });
                subjectSelect.value = '';
            }
            
            // Aplicar filtros reseteados (no recargar, solo filtrar client-side)
            applyCalendarFiltersAndUpdate();
        }
        
        function showPendingSection(section) {
            // Actualizar tabs activos
            ['expired', 'expiring_soon', 'missing'].forEach(s => {
                const tab = document.getElementById(`pending-tab-${s}`);
                if (tab) {
                    if (s === section) {
                        tab.style.borderBottom = '2px solid #3b82f6';
                    } else {
                        tab.style.borderBottom = 'none';
                    }
                }
            });
            
            // IMPORTANTE: Re-aplicar filtros antes de renderizar para asegurar datos actualizados
            // Esto garantiza que si cambi√≥ maxMonthsBack, se refleje en el render
            const rawData = window.pendingDocumentsDataRaw || { expired: [], expiring_soon: [], missing: [] };
            const filtered = applyCalendarFilters(rawData, calendarFilters, calendarMaxMonthsBack);
            
            // Actualizar datos globales
            window.pendingDocumentsData = filtered;
            
            // Re-renderizar con secci√≥n activa (usar datos filtrados actualizados)
            const container = document.getElementById('pending-documents-container');
            if (container) {
                container.innerHTML = renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, section);
            }
        }
        
        // Funci√≥n eliminada: updatePendingDocuments() ya no es necesaria
        // El filtro "Rango de b√∫squeda" fue eliminado, ahora se usa "M√°x. meses atr√°s"
        
        function navigateToUploadForDocument(docId, typeId, scope, personKey, companyKey) {
            const params = {
                type_id: typeId,
                scope: scope
            };
            if (personKey) params.person_key = personKey;
            if (companyKey) params.company_key = companyKey;
            if (docId) params.replace_doc_id = docId;
            navigateTo('subir', params);
        }
        
        function navigateToUploadForPeriod(typeId, scope, personKey, companyKey, periodKey) {
            const params = {
                type_id: typeId,
                scope: scope
            };
            if (personKey) params.person_key = personKey;
            if (companyKey) params.company_key = companyKey;
            if (periodKey) params.period_key = periodKey;
            navigateTo('subir', params);
        }
        
        function searchCalendarType(query) {
            const dropdown = document.getElementById('calendar-type-dropdown');
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = calendarTypes.filter(t => 
                t.name.toLowerCase().includes(query.toLowerCase()) ||
                t.type_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(t => `
                <div class="autocomplete-item" onclick="selectCalendarType('${t.type_id}')">
                    ${t.name} <span style="color: #94a3b8; font-size: 0.875rem;">(${t.type_id})</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectCalendarType(typeId) {
            selectedType = calendarTypes.find(t => t.type_id === typeId);
            document.getElementById('calendar-type-input').value = selectedType.name;
            document.getElementById('calendar-type-dropdown').classList.add('hidden');
            
            // Show subject selector
            const subjectGroup = document.getElementById('calendar-subject-group');
            const subjectLabel = document.getElementById('calendar-subject-label');
            
            if (selectedType.scope === 'worker') {
                subjectGroup.style.display = 'block';
                subjectLabel.textContent = '¬øDe qui√©n?';
            } else if (selectedType.scope === 'company') {
                subjectGroup.style.display = 'block';
                subjectLabel.textContent = '¬øDe qu√© empresa?';
            } else {
                subjectGroup.style.display = 'none';
            }
            
            updateCalendar();
        }
        
        function searchCalendarSubject(query) {
            const dropdown = document.getElementById('calendar-subject-dropdown');
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            if (selectedType?.scope === 'worker') {
                const matches = (calendarPeople.people || []).filter(p => 
                    p.full_name.toLowerCase().includes(query.toLowerCase()) ||
                    p.worker_id.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10);
                
                dropdown.innerHTML = matches.map(p => `
                    <div class="autocomplete-item" onclick="selectCalendarSubject('${p.worker_id}', '${p.full_name}')">
                        ${p.full_name}
                    </div>
                `).join('');
            }
            
            dropdown.classList.remove('hidden');
        }
        
        function selectCalendarSubject(subjectKey, subjectNameOrScope) {
            // If subjectNameOrScope is a scope, find the subject by key
            let subjectName = subjectNameOrScope;
            if (subjectNameOrScope === 'worker' || subjectNameOrScope === 'company') {
                const scope = subjectNameOrScope;
                if (scope === 'worker') {
                    const person = (calendarPeople.people || []).find(p => p.worker_id === subjectKey);
                    subjectName = person ? person.full_name : subjectKey;
                } else {
                    // For company, we might need to fetch companies or use the key as name
                    subjectName = subjectKey;
                }
            }
            
            selectedSubject = { key: subjectKey, name: subjectName };
            const input = document.getElementById('calendar-subject-input');
            if (input) {
                input.value = subjectName;
            }
            const dropdown = document.getElementById('calendar-subject-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            updateCalendar();
        }
        
        function updateCalendarMonths() {
            selectedMonths = parseInt(document.getElementById('calendar-months').value);
            updateCalendar();
        }
        
        async function updateCalendar() {
            if (!selectedType || !selectedSubject) {
                document.getElementById('calendar-grid-container').innerHTML = 
                    '<div class="alert alert-info">Selecciona un documento y un sujeto para ver el calendario</div>';
                return;
            }
            
            try {
                const params = new URLSearchParams({ months: selectedMonths });
                if (selectedType.scope === 'worker') {
                    params.append('person_key', selectedSubject.key);
                } else if (selectedType.scope === 'company') {
                    params.append('company_key', selectedSubject.key);
                }
                
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${selectedType.type_id}/expected?${params}`);
                calendarPeriods = await response.json();
                
                const container = document.getElementById('calendar-grid-container');
                container.innerHTML = `
                    <div class="calendar-grid">
                        ${calendarPeriods.map(p => {
                            const monthName = formatMonth(p.period_key);
                            const status = formatStatus(p.status);
                            const badgeClass = getStatusBadgeClass(p.status);
                            return `
                                <div class="calendar-month ${selectedPeriod === p.period_key ? 'selected' : ''}" 
                                     onclick="selectCalendarPeriod('${p.period_key}')">
                                    <div class="calendar-month-header">${monthName}</div>
                                    <div class="calendar-month-status">
                                        <span class="badge ${badgeClass}">${status}</span>
                                    </div>
                                    ${p.status !== 'AVAILABLE' ? `
                                        <div class="calendar-month-action">
                                            <button class="btn btn-primary" onclick="event.stopPropagation(); uploadForCalendarPeriod('${p.period_key}')">
                                                Subir
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('calendar-grid-container').innerHTML = 
                    `<div class="alert alert-error">Error al cargar calendario: ${error.message}</div>`;
            }
        }
        
        function selectCalendarPeriod(periodKey) {
            selectedPeriod = periodKey;
            const period = calendarPeriods.find(p => p.period_key === periodKey);
            if (!period) return;
            
            const sidePanel = document.getElementById('calendar-side-panel');
            const title = document.getElementById('side-panel-title');
            const content = document.getElementById('side-panel-content');
            
            title.textContent = formatMonth(periodKey);
            sidePanel.classList.remove('hidden');
            
            if (period.status === 'AVAILABLE') {
                content.innerHTML = `
                    <div>
                        <p><strong>Estado:</strong> <span class="badge badge-ok">OK</span></p>
                        <p style="margin-top: 12px;"><strong>Documento:</strong> ${period.doc_file_name || period.doc_id?.substring(0, 8) || 'N/A'}</p>
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="viewDocument('${period.doc_id}')">Ver</button>
                            <button class="btn btn-secondary" onclick="replaceDocument('${period.period_key}')">Reemplazar (conservar hist√≥rico)</button>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div>
                        <p><strong>Estado:</strong> <span class="badge ${getStatusBadgeClass(period.status)}">${formatStatus(period.status)}</span></p>
                        ${period.status === 'LATE' ? `<p style="margin-top: 8px; color: #fca5a5;">Tard√≠o: ${period.days_late} d√≠as</p>` : ''}
                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary btn-lg" onclick="uploadForCalendarPeriod('${period.period_key}')">
                                Subir este documento para ${formatMonth(periodKey)}
                            </button>
                        </div>
                    </div>
                `;
            }
            
            updateCalendar(); // Re-render to show selected state
        }
        
        function closeCalendarSidePanel() {
            document.getElementById('calendar-side-panel').classList.add('hidden');
            selectedPeriod = null;
            updateCalendar();
        }
        
        function uploadForCalendarPeriod(periodKey) {
            if (!selectedType || !selectedSubject) {
                alert('Debes seleccionar un documento y un sujeto primero');
                return;
            }
            
            const params = {
                type_id: selectedType.type_id,
                period_key: periodKey
            };
            
            if (selectedType.scope === 'worker') {
                params.person_key = selectedSubject.key;
            } else if (selectedType.scope === 'company') {
                params.company_key = selectedSubject.key;
            }
            
            navigateTo('subir', params);
        }
        
        function viewDocument(docId) {
            // Abrir PDF en nueva pesta√±a
            const url = `${BACKEND_URL}/api/repository/docs/${docId}/pdf`;
            window.open(url, '_blank');
        }
        
        function viewDocumentFromSearch(docId) {
            viewDocument(docId);
        }
        
        function resubmitDocumentFromSearch(docId, typeId, scope) {
            // Navegar a subir documentos con prefill para reemplazar
            const params = {
                type_id: typeId,
                scope: scope,
                replace_doc_id: docId
            };
            navigateTo('subir', params);
        }
        
        function replaceDocument(periodKey) {
            uploadForCalendarPeriod(periodKey);
        }
        
        // Subir documentos - Wizard guiado
        let uploadFiles = [];
        let uploadTypes = [];
        let uploadPeople = [];
        let uploadSubjects = {
            companies: [],
            workers_by_company: {}
        };
        
        // Helper para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadSubir(params = {}) {
            dbg('loadSubir: start', params);
            const content = document.getElementById('page-content');
            
            // Ensure data is loaded
            await ensureRepoDataLoaded({ types: true, people: true });
            
            try {
                // Load data if not already loaded - handle pagination if needed
                if (uploadTypes.length === 0) {
                    console.log('[repo-upload] Loading types...');
                    // Try to get all types (with large page_size or without pagination)
                    const response = await fetch(`${BACKEND_URL}/api/repository/types`);
                    const data = await response.json();
                    // Handle both array and paginated response
                    if (Array.isArray(data)) {
                        uploadTypes = data;
                    } else if (data.items && Array.isArray(data.items)) {
                        uploadTypes = data.items;
                        // If paginated and there are more pages, fetch them
                        if (data.total > data.items.length) {
                            console.log('[repo-upload] Fetching additional pages...');
                            const totalPages = Math.ceil(data.total / (data.page_size || 20));
                            for (let page = 2; page <= totalPages; page++) {
                                const pageResponse = await fetch(`${BACKEND_URL}/api/repository/types?page=${page}&page_size=${data.page_size || 20}`);
                                const pageData = await pageResponse.json();
                                if (pageData.items && Array.isArray(pageData.items)) {
                                    uploadTypes.push(...pageData.items);
                                }
                            }
                        }
                    } else {
                        uploadTypes = [];
                    }
                    console.log('[repo-upload] types loaded count:', uploadTypes.length);
                }
                const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
                uploadPeople = peopleData.people || [];
                
                // Validate type_id if provided
                if (params.type_id) {
                    const type = uploadTypes.find(t => t.type_id === params.type_id);
                    if (!type) {
                        const reason = `Type ${params.type_id} not found`;
                        dbg('Prefill failed:', reason);
                        updateDebugOverlay('subir', false, reason);
                        content.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>Advertencia:</strong> El tipo de documento "${params.type_id}" no existe.
                                Puedes continuar subiendo documentos normalmente.
                            </div>
                            <div class="card" style="margin-top: 16px;">
                                <h3>Subir documentos</h3>
                                <p style="color: #94a3b8; margin-bottom: 24px;">Arrastra archivos PDF aqu√≠ o haz clic para seleccionar</p>
                                <div class="upload-zone" id="upload-zone" data-testid="upload-dropzone">
                                    <div style="font-size: 3rem; margin-bottom: 16px;">üì§</div>
                                    <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu√≠</p>
                                    <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
                                    <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-input">
                                </div>
                                <div id="upload-files-list"></div>
                                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                                    <button class="btn btn-secondary" onclick="clearAllUploadFiles()" data-testid="upload-clear-all">Limpiar todo</button>
                                    <button class="btn btn-primary btn-lg" onclick="saveAllUploadFiles()" data-testid="save-all">Guardar todo</button>
                                </div>
                            </div>
                            
                            <!-- Duplicate modal -->
                            <div id="upload-duplicate-modal" class="modal-overlay hidden">
                                <div class="modal">
                                    <div class="modal-header">
                                        <h3>Documento duplicado</h3>
                                    </div>
                                    <p id="duplicate-modal-message"></p>
                                    <div class="modal-actions">
                                        <button class="btn btn-secondary" onclick="closeDuplicateModal()">Cancelar</button>
                                        <button class="btn btn-secondary" onclick="saveAsVersion()">Guardar como versi√≥n adicional</button>
                                        <button class="btn btn-primary" onclick="confirmReplace()">Reemplazar (conservar hist√≥rico)</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preview modal -->
                            <div id="upload-preview-modal" class="modal-overlay hidden" data-testid="preview-modal" onclick="closePreviewModal()">
                                <div class="modal" onclick="event.stopPropagation()" style="max-width: 90vw; max-height: 90vh; width: 1000px; display: flex; flex-direction: column;">
                                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <h3 id="preview-modal-title">Previsualizar documento</h3>
                                        <button class="btn btn-secondary" onclick="closePreviewModal()" style="padding: 4px 12px;">‚úï</button>
                                    </div>
                                    <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                        <object id="preview-object" data-testid="preview-object" data="" type="application/pdf" style="width: 100%; height: 100%; min-height: 500px; border: 1px solid #334155; border-radius: 4px;">
                                            <div class="preview-fallback" style="text-align: center; padding: 24px;">
                                                <p style="margin-bottom: 16px; color: #94a3b8;">No se puede previsualizar embebido en este navegador.</p>
                                                <div style="display: flex; gap: 12px; justify-content: center;">
                                                    <a id="preview-fallback-link" href="#" target="_blank" rel="noopener" class="btn btn-primary">Abrir en nueva pesta√±a</a>
                                                    <button id="preview-download-btn" class="btn btn-secondary">Descargar</button>
                                                </div>
                                            </div>
                                        </object>
                                    </div>
                                    <div class="modal-actions" style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                                        <button class="btn btn-secondary" onclick="openPreviewInNewTab()" data-testid="preview-open-tab">Abrir en pesta√±a</button>
                                        <button class="btn btn-secondary" onclick="downloadPreview()" data-testid="preview-download">Descargar</button>
                                        <button class="btn btn-primary" onclick="closePreviewModal()" data-testid="preview-close">Cerrar</button>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        setupUploadZone();
                        // SPRINT B3.4.1: Asegurar que el dropzone tiene data-testid correcto
                        // El dropzone ya est√° en el HTML con data-testid="upload-dropzone"
                        const uploadZone = document.getElementById('upload-zone');
                        const fileInput = document.getElementById('file-input');
                        if (uploadZone && fileInput) {
                            // Garantizar que data-testid="upload-dropzone" est√° presente
                            if (!uploadZone.hasAttribute('data-testid')) {
                                uploadZone.setAttribute('data-testid', 'upload-dropzone');
                            }
                            // A√±adir se√±al de estado usando atributo separado
                            uploadZone.setAttribute('data-upload-ready', 'true');
                            // Asegurar que el input tiene el data-testid correcto
                            if (!fileInput.hasAttribute('data-testid')) {
                                fileInput.setAttribute('data-testid', 'upload-input');
                            }
                            // Se√±al espec√≠fica de vista
                            const content = document.getElementById('page-content');
                            if (content) {
                                content.setAttribute('data-testid', 'view-subir-ready');
                            }
                        }
                        return;
                    }
                }
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Subir documentos</h3>
                        <p style="color: #94a3b8; margin-bottom: 24px;">Arrastra archivos PDF aqu√≠ o haz clic para seleccionar</p>
                        <div class="upload-zone" id="upload-zone" data-testid="upload-dropzone">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üì§</div>
                            <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu√≠</p>
                            <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
                                    <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-input">
                        </div>
                        <!-- Valores por defecto (opcional) -->
                        <div id="upload-defaults-container" style="margin-top: 24px; display: none;">
                            <div class="file-card" id="upload-defaults-card" style="background: #1e293b; border: 1px dashed #334155;">
                                <h4 style="color: #94a3b8; font-size: 0.9rem;">üìã Valores por defecto (opcional)</h4>
                                <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 16px;">Establece valores que se aplicar√°n a todos los archivos nuevos</p>
                                <div class="wizard-question">
                                    <label class="form-label">Tipo de documento</label>
                                    <select class="form-input" id="upload-default-type-select" onchange="updateUploadDefaultsType(this.value)">
                                        <option value="">Sin valor por defecto</option>
                                    </select>
                                </div>
                                <div id="upload-default-subject-group" class="wizard-question hidden">
                                    <label class="form-label">Sujeto (empresa/persona)</label>
                                    <div id="upload-default-subject-input-container"></div>
                                </div>
                                <div id="upload-default-period-group" class="wizard-question hidden">
                                    <label class="form-label">Periodo</label>
                                    <div id="upload-default-period-input-container"></div>
                                </div>
                                <div class="wizard-question">
                                    <label class="form-label">Fecha de emisi√≥n</label>
                                    <input type="date" class="form-input" id="upload-default-issue-date" onchange="updateUploadDefaultsIssueDate(this.value)">
                                </div>
                                <div style="margin-top: 16px;">
                                    <button class="btn btn-secondary btn-sm" onclick="applyDefaultsToAllFiles()">Aplicar a todos los archivos</button>
                                    <button class="btn btn-secondary btn-sm" onclick="clearUploadDefaults()" style="margin-left: 8px;">Limpiar</button>
                                </div>
                            </div>
                        </div>
                        <div id="upload-files-list"></div>
                        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="clearAllUploadFiles()" data-testid="upload-clear-all">Limpiar todo</button>
                            <button class="btn btn-primary btn-lg" onclick="saveAllUploadFiles()" data-testid="save-all">Guardar todo</button>
                        </div>
                    </div>
                    
                    <!-- Duplicate modal -->
                    <div id="upload-duplicate-modal" class="modal-overlay hidden">
                        <div class="modal">
                            <div class="modal-header">
                                <h3>Documento duplicado</h3>
                            </div>
                            <p id="duplicate-modal-message"></p>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeDuplicateModal()">Cancelar</button>
                                <button class="btn btn-secondary" onclick="saveAsVersion()">Guardar como versi√≥n adicional</button>
                                <button class="btn btn-primary" onclick="confirmReplace()">Reemplazar (conservar hist√≥rico)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview modal -->
                    <div id="upload-preview-modal" class="modal-overlay hidden" data-testid="preview-modal" onclick="closePreviewModal()">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 90vw; max-height: 90vh; width: 1000px; display: flex; flex-direction: column;">
                            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 id="preview-modal-title">Previsualizar documento</h3>
                                <button class="btn btn-secondary" onclick="closePreviewModal()" style="padding: 4px 12px;">‚úï</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                <object id="preview-object" data-testid="preview-object" data="" type="application/pdf" style="width: 100%; height: 100%; min-height: 500px; border: 1px solid #334155; border-radius: 4px;">
                                    <div class="preview-fallback" style="text-align: center; padding: 24px;">
                                        <p style="margin-bottom: 16px; color: #94a3b8;">No se puede previsualizar embebido en este navegador.</p>
                                        <div style="display: flex; gap: 12px; justify-content: center;">
                                            <a id="preview-fallback-link" href="#" target="_blank" rel="noopener" class="btn btn-primary">Abrir en nueva pesta√±a</a>
                                            <button id="preview-download-btn" class="btn btn-secondary">Descargar</button>
                                        </div>
                                    </div>
                                </object>
                            </div>
                            <div class="modal-actions" style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="openPreviewInNewTab()" data-testid="preview-open-tab">Abrir en pesta√±a</button>
                                <button class="btn btn-secondary" onclick="downloadPreview()" data-testid="preview-download">Descargar</button>
                                <button class="btn btn-primary" onclick="closePreviewModal()" data-testid="preview-close">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Resetear bandera de listeners instalados (el DOM se recre√≥)
                const uploadRoot = document.getElementById('upload-root');
                if (uploadRoot) {
                    uploadRoot.dataset.uploadListenersInstalled = 'false';
                }
                
                setupUploadZone();
                
                // Load subjects (companies + workers)
                try {
                    const subjectsResponse = await fetch(`${BACKEND_URL}/api/repository/subjects`);
                    if (subjectsResponse.ok) {
                        uploadSubjects = await subjectsResponse.json();
                        console.log('[repo-upload] Subjects loaded:', uploadSubjects);
                        
                        // BUG 1: Auto-seleccionar empresa √∫nica si solo hay 1
                        if (uploadSubjects.companies.length === 1) {
                            const singleCompany = uploadSubjects.companies[0];
                            // Aplicar a todos los archivos existentes
                            uploadFiles.forEach(file => {
                                if (file.scope === 'company' || file.scope === 'worker') {
                                    if (!file.company_key) {
                                        file.company_key = singleCompany.id;
                                        file.subject_key = singleCompany.id;
                                        // Limpiar error de empresa obligatoria
                                        if (file.errors) {
                                            file.errors = file.errors.filter(e => 
                                                e !== 'La empresa es obligatoria'
                                            );
                                        }
                                    }
                                }
                            });
                            // Aplicar a valores por defecto
                            if (!uploadFormData.company_key) {
                                uploadFormData.company_key = singleCompany.id;
                            }
                            // Re-render para actualizar UI
                            renderUploadFiles();
                        }
                    } else {
                        console.warn('[repo-upload] Failed to load subjects');
                    }
                } catch (error) {
                    console.error('[repo-upload] Error loading subjects:', error);
                }
                
                // Populate default type select
                populateUploadDefaultsTypeSelect();
                
                // Apply prefill from params (aplicar a valores por defecto)
                if (params.type_id || params.person_key || params.company_key || params.period_key || params.replace_doc_id) {
                    dbg('Setting uploadPrefill:', params);
                    if (params.type_id) {
                        const typeSelect = document.getElementById('upload-default-type-select');
                        if (typeSelect) {
                            typeSelect.value = params.type_id;
                            updateUploadDefaultsType(params.type_id);
                        }
                    }
                    if (params.person_key) {
                        uploadFormData.person_key = params.person_key;
                        updateUploadDefaultsSubject('worker', params.person_key);
                    }
                    if (params.company_key) {
                        uploadFormData.company_key = params.company_key;
                        updateUploadDefaultsSubject('company', params.company_key);
                    }
                    if (params.period_key) {
                        uploadFormData.period_key = params.period_key;
                        const type = uploadTypes.find(t => t.type_id === params.type_id);
                        if (type) {
                            const periodKind = type.validity_policy?.mode || 'none';
                            updateUploadDefaultsPeriod(params.period_key, periodKind);
                        }
                    }
                    // Guardar replace_doc_id para usar al guardar
                    if (params.replace_doc_id) {
                        window.replaceDocId = params.replace_doc_id;
                        // Mostrar mensaje informativo
                        const infoMsg = document.createElement('div');
                        infoMsg.className = 'alert alert-info';
                        infoMsg.style.marginBottom = '16px';
                        infoMsg.innerHTML = `‚ö†Ô∏è <strong>Reemplazando documento:</strong> Se reemplazar√° el PDF del documento existente. Los metadatos se conservar√°n.`;
                        const content = document.getElementById('page-content');
                        if (content && content.firstChild) {
                            content.insertBefore(infoMsg, content.firstChild);
                        }
                    }
                    // Mostrar contenedor de valores por defecto si hay prefill
                    const defaultsContainer = document.getElementById('upload-defaults-container');
                    if (defaultsContainer) defaultsContainer.style.display = 'block';
                    updateDebugOverlay('subir', true, `Prefill set: ${params.type_id || 'none'}`);
                } else {
                    updateDebugOverlay('subir', false, 'No prefill params');
                }
                
                renderUploadFiles();
                console.log('[repo-upload] initUploadWizard end');
                
                // SPRINT B3.4.1: Asegurar que el dropzone siempre existe y tiene data-testid correcto
                // El dropzone ya est√° en el HTML est√°tico con data-testid="upload-dropzone"
                // Solo verificamos que existe y a√±adimos se√±al de estado sin modificar data-testid
                const uploadZone = document.getElementById('upload-zone');
                const fileInput = document.getElementById('file-input');
                if (uploadZone && fileInput) {
                    // Garantizar que data-testid="upload-dropzone" est√° presente (ya deber√≠a estar en HTML)
                    if (!uploadZone.hasAttribute('data-testid')) {
                        uploadZone.setAttribute('data-testid', 'upload-dropzone');
                    } else {
                        // Si ya existe, asegurar que contiene 'upload-dropzone' (no sobrescribir)
                        const currentTestId = uploadZone.getAttribute('data-testid');
                        if (!currentTestId.includes('upload-dropzone')) {
                            uploadZone.setAttribute('data-testid', 'upload-dropzone');
                        }
                    }
                    // A√±adir se√±al de estado usando atributo separado (no modificar data-testid)
                    uploadZone.setAttribute('data-upload-ready', 'true');
                    // Asegurar que el input tiene el data-testid correcto
                    if (!fileInput.hasAttribute('data-testid')) {
                        fileInput.setAttribute('data-testid', 'upload-input');
                    }
                    // Se√±al espec√≠fica de vista en page-content
                    const content = document.getElementById('page-content');
                    if (content) {
                        content.setAttribute('data-testid', 'view-subir-ready');
                    }
                } else {
                    console.error('[repo-upload] CRITICAL: upload-zone or file-input not found after loadSubir');
                }
            } catch (error) {
                console.error('[repo-upload] Error:', error);
                content.innerHTML = `<div class="alert alert-error">Error al cargar subir: ${error.message}</div>`;
            }
        }
        
        // Instrumentaci√≥n (solo debug)
        if (typeof window.__uploadInitCount === 'undefined') {
            window.__uploadInitCount = 0;
        }
        
        // setupUploadZone idempotente: puede llamarse m√∫ltiples veces sin duplicar listeners
        function setupUploadZone() {
            window.__uploadInitCount++;
                const uploadZone = document.getElementById('upload-zone');
                const fileInput = document.getElementById('file-input');
            const uploadRoot = uploadZone?.closest('.card') || document.getElementById('page-content');
            
            if (!uploadZone || !fileInput) {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log(`[repo-upload] setupUploadZone #${window.__uploadInitCount}: missing elements`, {
                        uploadZone: !!uploadZone,
                        fileInput: !!fileInput
                    });
                }
                return;
            }
            
            // Verificar si ya est√°n instalados usando bandera en el DOM (m√°s robusto que variable global)
            if (uploadRoot && uploadRoot.dataset.uploadListenersInstalled === 'true') {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log(`[repo-upload] setupUploadZone #${window.__uploadInitCount}: already installed, skipping`);
                }
                return;
            }
            
            // Marcar como instalado ANTES de a√±adir listeners (evita race conditions)
            if (uploadRoot) {
                uploadRoot.dataset.uploadListenersInstalled = 'true';
            }
            
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log(`[repo-upload] setupUploadZone #${window.__uploadInitCount}: installing listeners`, {
                    uploadZone: !!uploadZone,
                    fileInput: !!fileInput,
                    uploadRoot: !!uploadRoot
                });
            }
            
            // Handlers (creados una sola vez)
            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });
            
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
            
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
            
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] onFilesSelected (drop):', {
                        files: e.dataTransfer.files.length,
                        uploadFilesBefore: uploadFiles.length
                    });
                }
                    handleUploadFiles(e.dataTransfer.files);
                });
            
                fileInput.addEventListener('change', (e) => {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] onFilesSelected (change):', {
                        files: e.target.files.length,
                        uploadFilesBefore: uploadFiles.length
                    });
                }
                    handleUploadFiles(e.target.files);
                // Resetear el input despu√©s de procesar (permite seleccionar el mismo archivo de nuevo)
                e.target.value = '';
            });
        }
        
        function handleUploadFiles(files) {
            const beforeCount = uploadFiles.length;
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] handleUploadFiles: start', {
                    filesCount: files.length,
                    uploadFilesBefore: beforeCount
                });
            }
            
            for (let file of files) {
                if (file.type !== 'application/pdf') {
                    alert(`El archivo ${file.name} no es un PDF`);
                    continue;
                }
                
                // Usar datos del formulario si est√°n disponibles
                // Inferir scopeFilter desde sujetos si ya existen
                let initialScopeFilter = 'all';
                if (uploadFormData.person_key) {
                    initialScopeFilter = 'worker';
                } else if (uploadFormData.company_key) {
                    initialScopeFilter = 'company';
                }
                
                const fileData = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    type_id: uploadFormData.type_id || '',
                    subject_key: '',
                    subject_name: '',
                    scope: uploadFormData.scope || '',
                    company_key: uploadFormData.company_key || '',
                    person_key: uploadFormData.person_key || '',
                    period_key: uploadFormData.period_key || '',
                    issue_date: uploadFormData.issue_date || '',
                    scopeFilter: initialScopeFilter, // NUEVO: prefiltro por scope
                    scopeFilterLocked: false, // NUEVO: bloqueado si hay tipo detectado
                    detected: {},
                    errors: {}
                };
                
                // BUG 1: Auto-seleccionar empresa √∫nica si solo hay 1 (al crear el file card)
                if (uploadSubjects.companies && uploadSubjects.companies.length === 1) {
                    const singleCompany = uploadSubjects.companies[0];
                    if (fileData.scope === 'company' || fileData.scope === 'worker') {
                        if (!fileData.company_key) {
                            fileData.company_key = singleCompany.id;
                            fileData.subject_key = singleCompany.id;
                        }
                    }
                }
                
                // Auto-detect from filename
                detectUploadMetadata(fileData);
                
                // Si el formulario tiene datos, usarlos (tienen prioridad sobre detecci√≥n)
                if (uploadFormData.type_id) {
                    fileData.type_id = uploadFormData.type_id;
                    const type = uploadTypes.find(t => t.type_id === uploadFormData.type_id);
                    if (type) fileData.scope = type.scope;
                }
                if (uploadFormData.person_key) {
                    fileData.person_key = uploadFormData.person_key;
                    const person = (uploadPeople.people || []).find(p => p.worker_id === uploadFormData.person_key);
                    if (person) fileData.subject_name = person.full_name;
                }
                if (uploadFormData.company_key) {
                    fileData.company_key = uploadFormData.company_key;
                }
                if (uploadFormData.period_key) {
                    fileData.period_key = uploadFormData.period_key;
                }
                
                // Apply prefill if available (legacy support)
                if (window.uploadPrefill) {
                    const prefill = window.uploadPrefill;
                    if (prefill.type_id && !fileData.type_id) {
                        fileData.type_id = prefill.type_id;
                        const type = uploadTypes.find(t => t.type_id === prefill.type_id);
                        if (type) fileData.scope = type.scope;
                    }
                    if (prefill.person_key && !fileData.person_key) {
                        fileData.person_key = prefill.person_key;
                        const person = (uploadPeople.people || []).find(p => p.worker_id === prefill.person_key);
                        if (person) fileData.subject_name = person.full_name;
                    }
                    if (prefill.company_key && !fileData.company_key) {
                        fileData.company_key = prefill.company_key;
                    }
                    if (prefill.period_key && !fileData.period_key) {
                        fileData.period_key = prefill.period_key;
                    }
                    delete window.uploadPrefill;
                }
                
                uploadFiles.push(fileData);
            }
            
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] handleUploadFiles: end', {
                    uploadFilesAfter: uploadFiles.length,
                    added: uploadFiles.length - beforeCount
                });
            }
            
            renderUploadFiles();
        }
        
        function detectUploadMetadata(fileData) {
            const filename = fileData.name.toLowerCase();
            
            // Detect type (fail-safe: verificar que uploadTypes existe y es array)
            if (!uploadTypes || !Array.isArray(uploadTypes)) {
                console.warn('[repo-upload] detectUploadMetadata: uploadTypes no est√° disponible');
                return;
            }
            
            for (const type of uploadTypes) {
                for (const alias of type.platform_aliases || []) {
                    if (filename.includes(alias.toLowerCase())) {
                        fileData.detected.type_id = type.type_id;
                        fileData.detected.scope = type.scope;
                        break;
                    }
                }
                if (fileData.detected.type_id) break;
            }
            
            // Detect person
            for (const person of uploadPeople.people || []) {
                const nameParts = person.full_name.toLowerCase().split(' ');
                if (nameParts.some(part => filename.includes(part))) {
                    fileData.detected.person_key = person.worker_id;
                    break;
                }
            }
            
            // Detect period (YYYY-MM)
            const periodMatch = filename.match(/(\d{4})-(\d{2})/);
            if (periodMatch) {
                fileData.detected.period_key = `${periodMatch[1]}-${periodMatch[2]}`;
            }
            
            // Detect date from filename (name_date)
            const parsedDate = parseDateFromFilename(fileData.name, null);
            if (parsedDate) {
                fileData.detected.name_date = parsedDate;
                // Si issue_date est√° vac√≠o, prefill con name_date
                if (!fileData.issue_date) {
                    fileData.issue_date = parsedDate;
                }
            }
            
            // Apply detected
            if (fileData.detected.type_id && !fileData.type_id) {
                fileData.type_id = fileData.detected.type_id;
                // Resolver el tipo desde uploadTypes (fail-safe: si no existe, no bloquear)
                const type = uploadTypes && Array.isArray(uploadTypes) 
                    ? uploadTypes.find(t => t.type_id === fileData.type_id) 
                    : null;
                if (type && type.scope) {
                    fileData.scope = type.scope;
                    // Aplicar scopeFilter y lock cuando se detecta un tipo autom√°ticamente
                    if (type.scope === 'company' || type.scope === 'worker') {
                        fileData.scopeFilter = type.scope;
                        fileData.scopeFilterLocked = true;
                    }
                }
            }
            if (fileData.detected.person_key && !fileData.person_key) {
                fileData.person_key = fileData.detected.person_key;
                const person = (uploadPeople.people || []).find(p => p.worker_id === fileData.person_key);
                if (person) fileData.subject_name = person.full_name;
            }
            if (fileData.detected.period_key && !fileData.period_key) {
                fileData.period_key = fileData.detected.period_key;
            }
        }
        
        // Estado del formulario de metadatos (sin archivo)
        let uploadFormData = {
            type_id: null,
            scope: null,
            person_key: null,
            company_key: null,
            period_key: null,
            issue_date: null
        };
        
        function renderUploadFiles() {
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] renderUploadFiles: start', {
                    uploadFilesLength: uploadFiles.length
                });
            }
            
            const list = document.getElementById('upload-files-list');
            if (!list) return;
            
            // El formulario principal ya est√° visible desde el inicio
            // Solo renderizamos los archivos si hay alguno
            if (uploadFiles.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = uploadFiles.map(file => {
                const type = uploadTypes.find(t => t.type_id === file.type_id);
                const periodMode = type?.validity_policy?.mode || 'none';
                
                // Derivar period_kind desde periodMode (igual que backend)
                // MONTH, QUARTER, YEAR requieren periodo manual; NONE y n_months no
                let periodKind = 'none';
                // Si tiene n_months configurado, no requiere periodo manual (periodKind = 'none')
                const hasNMonths = type?.validity_policy?.n_months?.n;
                if (hasNMonths) {
                    periodKind = 'none';
                } else if (periodMode === 'monthly') {
                    periodKind = 'month';
                } else if (periodMode === 'annual') {
                    periodKind = 'year';
                } else if (periodMode === 'quarter') {
                    periodKind = 'quarter';
                } else {
                    // none, o cualquier otro => NONE (no requiere periodo manual)
                    periodKind = 'none';
                }
                
                // SPRINT B3.4: Se√±al expl√≠cita de preview cuando se renderiza
                // Se a√±adir√° despu√©s del map
                
                // BUG 3: No pedir a√±o si es N meses desde expedici√≥n (issue_date)
                // Si tiene n_months configurado y se calcula desde issue_date, no necesita period_key
                // Reutilizar hasNMonths ya declarado arriba
                const calculatesFromIssueDate = type?.validity_policy?.basis === 'issue_date' || 
                                               (hasNMonths && type?.validity_policy?.monthly?.month_source === 'issue_date');
                const shouldHidePeriodForNMonths = hasNMonths && calculatesFromIssueDate && file.issue_date;
                
                // Mostrar campo Mes/A√±o SOLO si period_kind es MONTH, QUARTER o YEAR (no NONE)
                const needsPeriod = (periodKind === 'month' || periodKind === 'year' || periodKind === 'quarter') && !shouldHidePeriodForNMonths;
                
                // Ocultar campo mes/a√±o si se calcula desde nombre y hay issue_date
                const calculatesFromName = type?.validity_policy?.basis === 'name_date' || 
                                         (type?.validity_policy?.monthly?.month_source === 'name_date');
                const shouldHidePeriod = (calculatesFromName && file.issue_date) || shouldHidePeriodForNMonths;
                
                // Si se oculta, derivar period_ym desde issue_date
                if (shouldHidePeriod && file.issue_date && !file.period_key) {
                    const date = new Date(file.issue_date);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    file.period_key = `${year}-${month}`;
                }
                
                // BUG 1: Auto-seleccionar empresa √∫nica si solo hay 1 (en render)
                if (uploadSubjects.companies && uploadSubjects.companies.length === 1) {
                    const singleCompany = uploadSubjects.companies[0];
                    if ((file.scope === 'company' || file.scope === 'worker') && !file.company_key) {
                        file.company_key = singleCompany.id;
                        file.subject_key = singleCompany.id;
                        // Limpiar error de empresa obligatoria
                        if (file.errors) {
                            file.errors = file.errors.filter(e => e !== 'La empresa es obligatoria');
                        }
                    }
                }
                
                // Validation - usar file.type_id (no input visible)
                const errors = [];
                if (!file.type_id || (typeof file.type_id === 'string' && file.type_id.trim() === '')) {
                    errors.push('Selecciona un tipo de documento');
                    // Debug: log si hay problema (siempre, no solo en debug mode)
                    console.warn('[repo-upload] Validation failed for file:', file.name, 'type_id:', file.type_id, 'type:', typeof file.type_id);
                }
                if (file.scope === 'worker' && !file.person_key) errors.push('El trabajador es obligatorio');
                // BUG 1: No mostrar error de empresa si est√° auto-seleccionada (solo hay 1)
                if (file.scope === 'company' && !file.company_key) {
                    // Solo error si realmente no hay empresa disponible o no est√° auto-seleccionada
                    if (!(uploadSubjects.companies && uploadSubjects.companies.length === 1)) {
                        errors.push('La empresa es obligatoria');
                    }
                }
                if (file.scope === 'worker' && !file.company_key) {
                    // Solo error si realmente no hay empresa disponible o no est√° auto-seleccionada
                    if (!(uploadSubjects.companies && uploadSubjects.companies.length === 1)) {
                        errors.push('La empresa es obligatoria');
                    }
                }
                // Solo validar periodo si realmente se requiere (period_kind != NONE)
                if (needsPeriod && !file.period_key) {
                    errors.push(`El ${periodKind === 'month' ? 'mes' : periodKind === 'quarter' ? 'trimestre' : 'a√±o'} es obligatorio`);
                }
                // Validar fecha si es requerida
                if (file.requires_issue_date && !file.issue_date) {
                    if (!errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.')) {
                        errors.push('La fecha de emisi√≥n es obligatoria');
                    }
                }
                
                file.errors = errors;
                
                // NUEVO: Filtrar tipos seg√∫n scopeFilter
                const scopeFilter = file.scopeFilter || 'all';
                const filteredTypes = uploadTypes.filter(t => {
                    if (t.active === false) return false;
                    if (scopeFilter === 'all') return true;
                    return t.scope === scopeFilter;
                });
                
                // NUEVO: Si el tipo seleccionado no est√° en los filtrados, limpiar y mostrar error
                if (file.type_id && scopeFilter !== 'all') {
                    const selectedType = uploadTypes.find(t => {
                        const tId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                        return tId === file.type_id;
                    });
                    if (selectedType && selectedType.scope !== scopeFilter) {
                        file.type_id = null;
                        file.type_name = null;
                        file.scope = null;
                        // Limpiar tambi√©n el tipo detectado si era incompatible
                        if (file.detected.type_id === selectedType.type_id) {
                            file.detected.type_id = null;
                            file.detected.scope = null;
                            file.scopeFilterLocked = false;
                        }
                        if (!file.errors) file.errors = [];
                        if (!file.errors.includes('Selecciona un documento de la lista')) {
                            file.errors.push('Selecciona un documento de la lista');
                        }
                    }
                }
                
                return `
                    <div class="file-card" data-testid="upload-card-${file.id}">
                        <h4>${file.name}</h4>
                        <div class="wizard-question">
                            <label class="form-label">0. Aplica a <span class="form-required">*</span></label>
                            <div data-testid="scope-filter-pills" style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                                <label data-testid="scope-pill-all" style="display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: ${scopeFilter === 'all' ? '#3b82f6' : '#f8fafc'}; color: ${scopeFilter === 'all' ? '#fff' : '#1e293b'}; ${file.scopeFilterLocked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <input type="radio" name="scope-filter-${file.id}" value="all" 
                                           ${scopeFilter === 'all' ? 'checked' : ''}
                                           ${file.scopeFilterLocked ? 'disabled' : ''}
                                           onchange="updateUploadScopeFilter('${file.id}', 'all')"
                                           style="margin-right: 6px;">
                                    Todos
                                </label>
                                <label data-testid="scope-pill-company" style="display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: ${scopeFilter === 'company' ? '#3b82f6' : '#f8fafc'}; color: ${scopeFilter === 'company' ? '#fff' : '#1e293b'}; ${file.scopeFilterLocked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <input type="radio" name="scope-filter-${file.id}" value="company" 
                                           ${scopeFilter === 'company' ? 'checked' : ''}
                                           ${file.scopeFilterLocked ? 'disabled' : ''}
                                           onchange="updateUploadScopeFilter('${file.id}', 'company')"
                                           style="margin-right: 6px;">
                                    Empresa
                                </label>
                                <label data-testid="scope-pill-worker" style="display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #cbd5e1; border-radius: 6px; background: ${scopeFilter === 'worker' ? '#3b82f6' : '#f8fafc'}; color: ${scopeFilter === 'worker' ? '#fff' : '#1e293b'}; ${file.scopeFilterLocked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <input type="radio" name="scope-filter-${file.id}" value="worker" 
                                           ${scopeFilter === 'worker' ? 'checked' : ''}
                                           ${file.scopeFilterLocked ? 'disabled' : ''}
                                           onchange="updateUploadScopeFilter('${file.id}', 'worker')"
                                           style="margin-right: 6px;">
                                    Trabajador
                                </label>
                            </div>
                            ${file.scopeFilterLocked ? '<div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">El filtro est√° bloqueado porque se detect√≥ un tipo autom√°ticamente. Cambia el tipo manualmente para desbloquearlo.</div>' : ''}
                        </div>
                        <div class="wizard-question">
                            <label class="form-label">1. ¬øQu√© documento es? <span class="form-required">*</span> ${file.detected.type_id ? '<span class="badge badge-ok" data-testid="detected-badge" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                            <select class="form-input repo-upload-type-select" 
                                    id="upload-file-type-select-${file.id}"
                                    data-upload-file-id="${file.id}"
                                    data-testid="type-autocomplete"
                                    required>
                                <option value="">Selecciona un tipo...</option>
                                ${(() => {
                                    // Usar filteredTypes en lugar de uploadTypes
                                    console.log('[repo-upload] filtered types sample', filteredTypes.slice(0,5).map(t => ({
                                        name: t.name,
                                        type_id: t.type_id,
                                        scope: t.scope
                                    })));
                                    
                                    return filteredTypes.sort((a, b) => a.name.localeCompare(b.name)).map(t => {
                                        // Normalizar ID: puede venir como type_id, id, o code
                                        const typeId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                                        if (!typeId) {
                                            console.warn('[repo-upload] DocumentType without id:', t);
                                            return `<option value="" disabled>[SIN ID] ${escapeHtml(t.name)}</option>`;
                                        }
                                        const escapedId = escapeHtml(String(typeId));
                                        const escapedName = escapeHtml(t.name);
                                        const selected = file.type_id === typeId ? 'selected' : '';
                                        return `<option value="${escapedId}" ${selected} data-testid="type-option-${escapedId}">${escapedName}</option>`;
                                    }).join('');
                                })()}
                            </select>
                            ${errors.includes('El documento es obligatorio') || errors.includes('Selecciona un tipo de documento') ? '<div class="form-error" data-testid="type-error">Selecciona un tipo de documento</div>' : ''}
                            ${errors.includes('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.') ? '<div class="form-error" style="color: #ef4444; font-weight: bold;" data-testid="type-error">Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.</div>' : ''}
                            ${errors.includes('El tipo seleccionado no coincide con el filtro de alcance') ? '<div class="form-error" data-testid="type-error">El tipo seleccionado no coincide con el filtro de alcance</div>' : ''}
                            ${errors.includes('Selecciona un documento de la lista') ? '<div class="form-error" data-testid="type-error">Selecciona un documento de la lista</div>' : ''}
                            <!-- Debug overlay visible -->
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px; font-family: monospace; background: #0f172a; padding: 4px 8px; border-radius: 4px;">
                                debug: type_id=${file.type_id || 'NULL'} | dom_value=${file._last_dom_value || 'NULL'} | issue_date=${file.issue_date || 'NULL'} | requires_issue_date=${file.requires_issue_date || false} | scopeFilter=${scopeFilter} | errors=[${errors.join(', ')}]
                                <br>
                                listener_installed=${window.__REPO_UPLOAD_LISTENER_INSTALLED || false} | last_change=${window.__REPO_UPLOAD_LAST_CHANGE ? new Date(window.__REPO_UPLOAD_LAST_CHANGE.time).toLocaleTimeString() : 'NULL'} | last_select_value=${window.__REPO_UPLOAD_LAST_SELECT_DEBUG?.value || 'NULL'}
                            </div>
                        </div>
                        ${file.scope ? `
                            <div class="wizard-question">
                                <label class="form-label">2. ¬øDe qui√©n / empresa? ${file.detected.person_key ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                                ${file.scope === 'worker' ? `
                                    ${uploadSubjects.companies.length > 1 ? `
                                        <label class="form-label" style="margin-top: 8px; font-size: 0.9rem;">Empresa <span class="form-required">*</span></label>
                                        <select class="form-input repo-upload-company-select" 
                                                id="upload-company-select-${file.id}"
                                                data-upload-file-id="${file.id}"
                                                onchange="updateUploadCompanyFromSelect('${file.id}', this.value)"
                                                required>
                                            <option value="">Selecciona una empresa...</option>
                                            ${uploadSubjects.companies.map(c => `
                                                <option value="${escapeHtml(c.id)}" ${file.company_key === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>
                                            `).join('')}
                                        </select>
                                    ` : uploadSubjects.companies.length === 1 ? `
                                        <input type="hidden" id="upload-company-select-${file.id}" value="${uploadSubjects.companies[0].id}">
                                    ` : ''}
                                    <label class="form-label" style="margin-top: 8px; font-size: 0.9rem;">Trabajador <span class="form-required">*</span></label>
                                    <select class="form-input repo-upload-worker-select" 
                                            id="upload-worker-select-${file.id}"
                                            data-upload-file-id="${file.id}"
                                            data-company-id="${file.company_key || (uploadSubjects.companies.length === 1 ? uploadSubjects.companies[0].id : '')}"
                                            onchange="updateUploadWorker('${file.id}', this.value)"
                                            ${!file.company_key && uploadSubjects.companies.length > 1 ? 'disabled' : ''}
                                            required>
                                        <option value="">Selecciona un trabajador...</option>
                                        ${(() => {
                                            const companyId = file.company_key || (uploadSubjects.companies.length === 1 ? uploadSubjects.companies[0].id : '');
                                            const workers = uploadSubjects.workers_by_company[companyId] || [];
                                            return workers.map(w => `
                                                <option value="${escapeHtml(w.id)}" ${file.person_key === w.id ? 'selected' : ''}>${escapeHtml(w.name)}</option>
                                            `).join('');
                                        })()}
                                    </select>
                                    ${errors.includes('El trabajador es obligatorio') ? '<div class="form-error">El trabajador es obligatorio</div>' : ''}
                                    ${errors.includes('La empresa es obligatoria') ? '<div class="form-error">La empresa es obligatoria</div>' : ''}
                                ` : `
                                    <select class="form-input repo-upload-company-select" 
                                            id="upload-company-select-${file.id}"
                                            data-upload-file-id="${file.id}"
                                            onchange="updateUploadCompany('${file.id}', this.value)"
                                            required>
                                        <option value="">Selecciona una empresa...</option>
                                        ${uploadSubjects.companies.map(c => `
                                            <option value="${escapeHtml(c.id)}" ${file.company_key === c.id ? 'selected' : ''}>${escapeHtml(c.name)}</option>
                                        `).join('')}
                                    </select>
                                    ${errors.includes('La empresa es obligatoria') ? '<div class="form-error">La empresa es obligatoria</div>' : ''}
                                `}
                            </div>
                        ` : ''}
                        ${needsPeriod && !shouldHidePeriod ? `
                            <div class="wizard-question" data-testid="period-monthyear">
                                <label class="form-label">3. ¬øDe qu√© ${periodKind === 'month' ? 'mes/a√±o' : periodKind === 'quarter' ? 'trimestre/a√±o' : 'a√±o'}? ${file.detected.period_key ? '<span class="badge badge-ok" style="margin-left: 8px;">Detectado</span>' : ''}</label>
                                ${periodKind === 'month' ? `
                                    <input type="month" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : periodKind === 'year' ? `
                                    <input type="number" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           placeholder="YYYY"
                                           min="2000" max="2100"
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : periodKind === 'quarter' ? `
                                    <input type="text" class="form-input" 
                                           value="${file.period_key || ''}" 
                                           placeholder="YYYY-Qn (ej: 2025-Q1)"
                                           pattern="\d{4}-Q[1-4]"
                                           onchange="updateUploadPeriod('${file.id}', this.value)"
                                           required>
                                ` : ''}
                                ${errors.some(e => e.includes('obligatorio')) ? `<div class="form-error">El ${periodKind === 'month' ? 'mes' : periodKind === 'quarter' ? 'trimestre' : 'a√±o'} es obligatorio</div>` : ''}
                            </div>
                        ` : shouldHidePeriod || periodKind === 'none' ? `
                            <div class="wizard-question" style="display: none;" data-testid="period-monthyear">
                                <input type="hidden" id="upload-period-${file.id}" value="${file.period_key || ''}">
                            </div>
                        ` : ''}
                        <div class="wizard-question">
                            <label class="form-label">4. Fecha de emisi√≥n${file.requires_issue_date ? ' <span class="form-required">*</span>' : ' (Opcional)'}</label>
                            <input type="date" class="form-input" 
                                   id="upload-issue-date-${file.id}"
                                   data-testid="issue-date-input"
                                   value="${file.issue_date || ''}"
                                   onchange="updateUploadIssueDate('${file.id}', this.value)"
                                   ${file.requires_issue_date ? 'required' : ''}>
                            ${file.issue_date ? `<div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">Fecha detectada desde nombre</div>` : ''}
                            ${errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.') ? '<div class="form-error">No se pudo extraer fecha del nombre. Selecciona una fecha.</div>' : ''}
                            ${file.requires_issue_date && !file.issue_date && !errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.') ? '<div class="form-error">La fecha de emisi√≥n es obligatoria</div>' : ''}
                        </div>
                        ${(() => {
                            const validityStartMode = type?.validity_start_mode || 'issue_date';
                            if (validityStartMode === 'manual') {
                                return `
                                    <div class="wizard-question">
                                        <label class="form-label">5. Fecha de inicio de vigencia <span class="form-required">*</span></label>
                                        <input type="date" class="form-input" 
                                               id="upload-validity-start-date-${file.id}"
                                               data-testid="validity-start-input"
                                               data-upload-file-id="${file.id}"
                                               value="${file.validity_start_date || ''}" 
                                               onchange="updateUploadValidityStartDate('${file.id}', this.value)"
                                               oninput="updateUploadValidityStartDate('${file.id}', this.value)"
                                               onblur="updateUploadValidityStartDate('${file.id}', this.value)"
                                               required>
                                        <div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">Fecha desde la cual el documento es v√°lido (puede ser distinta de la fecha de emisi√≥n)</div>
                                        ${errors.includes('La fecha de inicio de vigencia es obligatoria') ? '<div class="form-error">La fecha de inicio de vigencia es obligatoria</div>' : ''}
                                        ${!file.validity_start_date ? '<div class="form-error">La fecha de inicio de vigencia es obligatoria</div>' : ''}
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                        ${errors.length > 0 ? `<div class="alert alert-error">${errors.join(', ')}</div>` : ''}
                        <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="previewUploadFile('${file.id}')" data-testid="preview-btn-${file.id}">Previsualizar</button>
                            <button class="btn btn-secondary" onclick="removeUploadFile('${file.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
            
        }
        
        // Funci√≥n para actualizar tipo de documento en un archivo (usando select)
        function updateUploadFileType(fileId, typeId) {
            // Convertir ambos a string para comparaci√≥n (fileId viene como string del DOM)
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) {
                console.warn('[repo-upload] File not found:', {
                    fileId,
                    fileIdType: typeof fileId,
                    uploadFilesIds: uploadFiles.map(f => ({ id: f.id, idType: typeof f.id, idString: String(f.id) }))
                });
                return;
            }
            
            // Obtener el select y la opci√≥n seleccionada
            const select = document.getElementById(`upload-file-type-select-${fileId}`);
            const selectedIndex = select ? select.selectedIndex : -1;
            const selectedOption = select && selectedIndex >= 0 ? select.options[selectedIndex] : null;
            const selectedText = selectedOption ? selectedOption.textContent : '';
            
            // Guardar type_id directamente del value (sin normalizar, ya viene correcto del option)
            const raw = typeId && typeId.trim() ? typeId.trim() : null;
            const beforeTypeId = file.type_id;
            file.type_id = raw;
            file.type_name = selectedText;
            // _last_dom_value ya se setea en el event listener antes de llamar a esta funci√≥n
            
            console.log('[repo-upload] updateUploadFileType:', {
                filename: file.name,
                fileId: fileId,
                rawValue: typeId,
                normalizedTypeId: raw,
                before: beforeTypeId,
                after: file.type_id,
                typeName: file.type_name,
                domValue: file._last_dom_value
            });
            
            // Fail-fast: si value est√° vac√≠o despu√©s de procesar, error
            if (!raw) {
                // Si el usuario limpia el tipo, desbloquear el scopeFilter
                file.scopeFilterLocked = false;
                if (!file.errors) file.errors = [];
                if (!file.errors.includes('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.')) {
                    file.errors.push('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.');
                }
                renderUploadFiles();
                return;
            }
            
            // Buscar el tipo en uploadTypes
            const type = raw ? uploadTypes.find(t => {
                const tId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                return tId === raw;
            }) : null;
            
            if (type) {
                file.scope = type.scope;
                
                // NUEVO: Si el usuario cambia el tipo manualmente (no es el detectado), desbloquear y alinear scopeFilter
                const isDetectedType = file.detected.type_id === raw;
                if (!isDetectedType) {
                    // Desbloquear el prefiltro (acci√≥n manual)
                    file.scopeFilterLocked = false;
                    // Alinear scopeFilter con el tipo seleccionado manualmente (el prefiltro sigue al tipo)
                    if (type.scope === 'company' || type.scope === 'worker') {
                        file.scopeFilter = type.scope;
                    }
                } else {
                    // Si es el tipo detectado, mantener bloqueado y alineado
                    if (type.scope === 'company' || type.scope === 'worker') {
                        file.scopeFilter = type.scope;
                        file.scopeFilterLocked = true;
                    }
                }
                
                // Determinar si requiere fecha de emisi√≥n
                // 1. Si tiene el flag issue_date_required, usarlo
                // 2. Si no, retrocompat: si basis === 'name_date' y month_source === 'name_date'
                // 3. Por defecto: false
                let issueDateRequired = false;
                if (type.issue_date_required !== undefined) {
                    issueDateRequired = type.issue_date_required;
                } else if (type.validity_policy?.basis === 'name_date' && 
                          type.validity_policy?.monthly?.month_source === 'name_date') {
                    issueDateRequired = true;
                }
                file.requires_issue_date = issueDateRequired;
                
                // Resolver validity_start_date seg√∫n el modo
                const validityStartMode = type.validity_start_mode || 'issue_date';
                if (validityStartMode === 'issue_date') {
                    // Inicio de vigencia = issue_date (se actualizar√° cuando cambie issue_date)
                    file.validity_start_date = file.issue_date || null;
                } else if (validityStartMode === 'manual') {
                    // Mantener validity_start_date independiente (no cambiar autom√°ticamente)
                    if (!file.validity_start_date) {
                        file.validity_start_date = null;
                    }
                }
                
                // Auto-fecha desde nombre - SIEMPRE intentar si est√° vac√≠a (best effort)
                const beforeIssueDate = file.issue_date;
                if (!file.issue_date) {
                    const parsedDate = parseDateFromFilename(file.name, type);
                    if (parsedDate) {
                        file.issue_date = parsedDate;
                        console.log('[repo-upload] auto-date candidate:', {
                            filename: file.name,
                            parsed: parsedDate,
                            before: beforeIssueDate,
                            after: file.issue_date,
                            issueDateRequired: issueDateRequired
                        });
                    } else {
                        console.log('[repo-upload] auto-date failed:', {
                            filename: file.name,
                            issueDateRequired: issueDateRequired
                        });
                    }
                }
                
                // Si requiere fecha y a√∫n est√° vac√≠a despu√©s de intentar parsear, mostrar error
                if (issueDateRequired && !file.issue_date) {
                    if (!file.errors) file.errors = [];
                    if (!file.errors.includes('No se pudo extraer fecha del nombre. Selecciona una fecha.')) {
                        file.errors.push('No se pudo extraer fecha del nombre. Selecciona una fecha.');
                    }
                    // Enfocar datepicker
                    setTimeout(() => {
                        const dateInput = document.getElementById(`upload-issue-date-${fileId}`);
                        if (dateInput) {
                            dateInput.focus();
                            dateInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            } else {
                file.scope = null;
                file.requires_issue_date = false;
                if (raw) {
                    console.warn('[repo-upload] Type not found for ID:', raw, 'Available types:', uploadTypes.map(t => t.type_id ?? t.id ?? t.code ?? t.internal_id));
                }
            }
            
            // Limpiar errores relacionados con tipo
            if (file.errors) {
                const beforeErrors = [...file.errors];
                file.errors = file.errors.filter(e => 
                    e !== 'Selecciona un tipo de documento' && 
                    e !== 'El documento es obligatorio' &&
                    e !== 'Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.' &&
                    e !== 'Selecciona un documento de la lista'
                );
                if (beforeErrors.length !== file.errors.length) {
                    console.log('[repo-upload] Errores limpiados:', beforeErrors, '->', file.errors);
                }
            }
            
            renderUploadFiles();
        }
        
        // NUEVO: Funci√≥n para actualizar el prefiltro de scope
        function updateUploadScopeFilter(fileId, scopeFilter) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            // No permitir cambiar si est√° bloqueado (invariante: bloqueo real - guard clause)
            if (file.scopeFilterLocked) {
                console.log('[repo-upload] Scope filter is locked for file:', file.name);
                return; // Guard clause: evita que un bug de CSS o evento burbuja cambie el estado
            }
            
            file.scopeFilter = scopeFilter;
            
            // Si el tipo seleccionado no coincide con el nuevo filtro, limpiar y mostrar error
            if (file.type_id && scopeFilter !== 'all') {
                const selectedType = uploadTypes.find(t => {
                    const tId = t.type_id ?? t.id ?? t.code ?? t.internal_id;
                    return tId === file.type_id;
                });
                if (selectedType && selectedType.scope !== scopeFilter) {
                    file.type_id = null;
                    file.type_name = null;
                    file.scope = null;
                    // Limpiar tambi√©n el tipo detectado si era incompatible
                    if (file.detected.type_id === selectedType.type_id) {
                        file.detected.type_id = null;
                        file.detected.scope = null;
                        file.scopeFilterLocked = false;
                    }
                    if (!file.errors) file.errors = [];
                    if (!file.errors.includes('Selecciona un documento de la lista')) {
                        file.errors.push('Selecciona un documento de la lista');
                    }
                }
            }
            
            // Limpiar errores de tipo si el filtro cambi√≥ a 'all' o si el tipo coincide
            if (file.errors) {
                file.errors = file.errors.filter(e => 
                    e !== 'El tipo seleccionado no coincide con el filtro de alcance' &&
                    e !== 'Selecciona un documento de la lista'
                );
            }
            
            renderUploadFiles();
        }
        
        // Parsear fecha desde nombre de archivo (best effort - aplica siempre si fecha vac√≠a)
        function parseDateFromFilename(filename, docType) {
            // Aplicar como "best effort" - no requiere configuraci√≥n espec√≠fica
            // Si el tipo tiene config de "name_date", mejor, pero no es obligatorio
            
            // Normalizar: reemplazar _ por -, colapsar espacios m√∫ltiples, lower
            const normalized = filename.replace(/_/g, '-').replace(/\s+/g, '-').toLowerCase();
            const filenameLower = normalized;
            
            // Mapeo de meses en espa√±ol y catal√°n
            const spanishMonths = {
                'ene': 1, 'enero': 1,
                'feb': 2, 'febrero': 2,
                'mar': 3, 'marzo': 3,
                'abr': 4, 'abril': 4,
                'may': 5, 'mayo': 5,
                'jun': 6, 'junio': 6,
                'jul': 7, 'julio': 7,
                'ago': 8, 'agosto': 8, 'agost': 8, // catal√°n
                'sep': 9, 'septiembre': 9, 'set': 9, 'setembre': 9, // catal√°n
                'oct': 10, 'octubre': 10,
                'nov': 11, 'noviembre': 11,
                'dic': 12, 'diciembre': 12
            };
            
            // Patr√≥n 0: YYYY_DD-MMM-YY o YYYY-DD-MMM-YY (ej: "2025_1-ago-25", "2025-1-ago-25")
            // Soporta a√±o al inicio seguido de d√≠a-mes-a√±o
            const pattern0 = /(\d{4})[-_](\d{1,2})[-/](ene|feb|mar|abr|may|jun|jul|ago|sep|set|oct|nov|dic|enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)[-/](\d{2,4})/i;
            const match0 = normalized.match(pattern0);
            if (match0) {
                const year1 = parseInt(match0[1]); // A√±o del inicio (preferido)
                const day = parseInt(match0[2]);
                const monthStr = match0[3].toLowerCase();
                const year2Str = match0[4];
                const month = spanishMonths[monthStr];
                if (month) {
                    let year = year1; // Preferir a√±o del inicio
                    // Si el a√±o del final es diferente y tiene 4 d√≠gitos, podr√≠a ser m√°s espec√≠fico, pero preferimos el del inicio
                    if (year2Str.length === 4) {
                        const year2 = parseInt(year2Str);
                        // Si ambos a√±os est√°n presentes y son diferentes, usar el del inicio (m√°s confiable)
                        year = year1;
                    } else if (year2Str.length === 2) {
                        // Si solo hay a√±o de 2 d√≠gitos al final, ya usamos el del inicio
                        year = year1;
                    }
                    try {
                        const date = new Date(Date.UTC(year, month - 1, day));
                        if (date.getUTCDate() === day && date.getUTCMonth() === month - 1 && date.getUTCFullYear() === year) {
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                                console.log('[repo-upload] Fecha parseada (pattern0):', filename, '->', dateStr);
                            }
                            return dateStr;
                        }
                    } catch (e) {
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.warn('[repo-upload] Error parsing date (pattern0):', e);
                        }
                    }
                }
            }
            
            // Patr√≥n 1: DD-MMM-YY o DD-MMM-YYYY (ej: "28-nov-25", "28-nov-2025", "28-NOV-25", "AEAT-16-oct-2025")
            // Tolerar espacios y may√∫sculas/min√∫sculas
            // IMPORTANTE: Buscar en el filename normalizado con flag /i para case-insensitive
            const pattern1 = /(\d{1,2})[-/](ene|feb|mar|abr|may|jun|jul|ago|sep|set|oct|nov|dic|enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)[-/](\d{2,4})/i;
            const match1 = normalized.match(pattern1);
            console.log('[repo-upload] parseDateFromFilename pattern1 match:', { filename, match1 });
            if (match1) {
                const day = parseInt(match1[1]);
                const monthStr = match1[2].toLowerCase();
                const yearStr = match1[3];
                const month = spanishMonths[monthStr];
                if (month) {
                    let year = parseInt(yearStr);
                    if (yearStr.length === 2) {
                        // A√±o 2 d√≠gitos: 00-69 => 2000-2069, 70-99 => 1970-1999
                        year = year < 70 ? 2000 + year : 1900 + year;
                    }
                    try {
                        // Usar UTC para evitar problemas de zona horaria
                        const date = new Date(Date.UTC(year, month - 1, day));
                        if (date.getUTCDate() === day && date.getUTCMonth() === month - 1 && date.getUTCFullYear() === year) {
                            // Formatear manualmente para evitar problemas de zona horaria
                            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                                console.log('[repo-upload] Fecha parseada desde nombre:', filename, '->', dateStr);
                            }
                            return dateStr; // Formato YYYY-MM-DD
                        }
                    } catch (e) {
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.warn('[repo-upload] Error parsing date:', e);
                        }
                    }
                }
            }
            
            // Patr√≥n 2: DD/MM/YYYY o DD-MM-YYYY (ej: "28/11/2025", "28-11-2025")
            const pattern2 = /(\d{1,2})[-/](\d{1,2})[-/](\d{4})/;
            const match2 = filenameLower.match(pattern2);
            if (match2) {
                const day = parseInt(match2[1]);
                const month = parseInt(match2[2]);
                const year = parseInt(match2[3]);
                try {
                    const date = new Date(year, month - 1, day);
                    if (date.getDate() === day && date.getMonth() === month - 1) {
                        return date.toISOString().split('T')[0];
                    }
                } catch (e) {}
            }
            
            // Patr√≥n 3: DD/MM/YY o DD-MM-YY (ej: "28/11/25", "28-11-25")
            const pattern3 = /(\d{1,2})[-/](\d{1,2})[-/](\d{2})/;
            const match3 = filenameLower.match(pattern3);
            if (match3) {
                const day = parseInt(match3[1]);
                const month = parseInt(match3[2]);
                let year = parseInt(match3[3]);
                // A√±o 2 d√≠gitos: 00-69 => 2000-2069, 70-99 => 1970-1999
                year = year < 70 ? 2000 + year : 1900 + year;
                try {
                    const date = new Date(year, month - 1, day);
                    if (date.getDate() === day && date.getMonth() === month - 1) {
                        return date.toISOString().split('T')[0];
                    }
                } catch (e) {}
            }
            
            return null;
        }
        
        function searchUploadPerson(fileId, query) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            const dropdown = document.getElementById(`upload-person-dropdown-${fileId}`);
            if (!dropdown) return;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const matches = (uploadPeople.people || []).filter(p => 
                p.full_name.toLowerCase().includes(query.toLowerCase()) ||
                p.worker_id.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            dropdown.innerHTML = matches.map(p => `
                <div class="autocomplete-item" onclick="selectUploadPerson('${fileId}', '${p.worker_id}', '${p.full_name}')">
                    ${p.full_name}
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectUploadPerson(fileId, personKey, personName) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.person_key = personKey;
            file.subject_key = personKey;
            file.subject_name = personName;
            document.getElementById(`upload-person-dropdown-${fileId}`).classList.add('hidden');
            renderUploadFiles();
        }
        
        function updateUploadCompany(fileId, companyKey) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            file.company_key = companyKey;
            file.subject_key = companyKey;
            // Si es scope worker, resetear trabajador al cambiar empresa
            if (file.scope === 'worker') {
                file.person_key = null;
                file.subject_name = '';
            }
            renderUploadFiles();
        }
        
        function updateUploadCompanyFromSelect(fileId, companyKey) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            file.company_key = companyKey;
            // Resetear trabajador y actualizar select de trabajadores
            file.person_key = null;
            file.subject_name = '';
            
            // Habilitar select de trabajadores
            const workerSelect = document.getElementById(`upload-worker-select-${fileId}`);
            if (workerSelect) {
                workerSelect.disabled = false;
                workerSelect.setAttribute('data-company-id', companyKey);
                // Repoblar trabajadores
                const workers = uploadSubjects.workers_by_company[companyKey] || [];
                workerSelect.innerHTML = '<option value="">Selecciona un trabajador...</option>' +
                    workers.map(w => `<option value="${escapeHtml(w.id)}">${escapeHtml(w.name)}</option>`).join('');
            }
            
            renderUploadFiles();
        }
        
        function updateUploadWorker(fileId, workerId) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) return;
            
            file.person_key = workerId;
            // Buscar nombre del trabajador
            const companyId = file.company_key || (uploadSubjects.companies.length === 1 ? uploadSubjects.companies[0].id : '');
            const workers = uploadSubjects.workers_by_company[companyId] || [];
            const worker = workers.find(w => w.id === workerId);
            if (worker) {
                file.subject_name = worker.name;
            }
            renderUploadFiles();
        }
        
        function updateUploadPeriod(fileId, periodKey) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.period_key = periodKey;
            renderUploadFiles();
        }
        
        function updateUploadIssueDate(fileId, issueDate) {
            const file = uploadFiles.find(f => f.id === fileId);
            if (!file) return;
            
            file.issue_date = issueDate || null;
            
            // Si validity_start_mode es "issue_date", actualizar validity_start_date tambi√©n
            const type = uploadTypes.find(t => t.type_id === file.type_id);
            if (type) {
                const validityStartMode = type.validity_start_mode || 'issue_date';
                if (validityStartMode === 'issue_date') {
                    file.validity_start_date = issueDate || null;
                }
            }
            
            // Limpiar errores de fecha si se selecciona una
            if (file.errors) {
                file.errors = file.errors.filter(e => 
                    e !== 'No se pudo extraer fecha del nombre. Selecciona una fecha.' &&
                    e !== 'La fecha de emisi√≥n es obligatoria'
                );
            }
            
            renderUploadFiles(); // Re-render para actualizar el mensaje de ayuda
        }
        
        function updateUploadValidityStartDate(fileId, validityStartDate) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.warn('[repo-upload] updateUploadValidityStartDate: file not found', fileId);
                }
                return;
            }
            
            // Log para diagn√≥stico
            if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                console.log('[repo-upload] validity_start_date input changed =>', validityStartDate, '(fileId=' + fileId + ')');
            }
            
            // IMPORTANTE: Guardar el valor RAW (lo que el usuario ve/selecciona)
            // El input type="date" devuelve formato ISO (YYYY-MM-DD), guardar tal cual
            // NO convertir a null si est√° vac√≠o, mantener el valor tal cual
            if (validityStartDate && validityStartDate.trim() !== '') {
                file.validity_start_date = validityStartDate.trim();
            } else {
                // Solo asignar null si realmente est√° vac√≠o (no string vac√≠o)
                file.validity_start_date = null;
            }
            
            // Limpiar errores de fecha de inicio de vigencia
            if (file.errors) {
                file.errors = file.errors.filter(e => 
                    e !== 'La fecha de inicio de vigencia es obligatoria'
                );
            }
            
            // Ocultar mensaje de error si existe
            const errorDiv = document.getElementById(`validity-start-error-${fileId}`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // NO re-renderizar aqu√≠ - solo actualizar el estado
            // El re-render se har√° cuando sea necesario (ej: despu√©s de validar)
        }
        
        // Funciones para valores por defecto
        function populateUploadDefaultsTypeSelect() {
            const select = document.getElementById('upload-default-type-select');
            if (!select) return;
            
            // Filtrar solo tipos activos
            const activeTypes = uploadTypes.filter(t => t.active !== false);
            activeTypes.sort((a, b) => a.name.localeCompare(b.name));
            
            // Limpiar opciones existentes (excepto la primera)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // A√±adir opciones
            activeTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.type_id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        }
        
        function updateUploadDefaultsType(typeId) {
            const type = uploadTypes.find(t => t.type_id === typeId);
            if (!type) {
                uploadFormData.type_id = null;
                uploadFormData.scope = null;
                const subjectGroup = document.getElementById('upload-default-subject-group');
                const periodGroup = document.getElementById('upload-default-period-group');
                if (subjectGroup) subjectGroup.classList.add('hidden');
                if (periodGroup) periodGroup.classList.add('hidden');
                return;
            }
            
            uploadFormData.type_id = typeId;
            uploadFormData.scope = type.scope;
            
            // Mostrar/ocultar campos seg√∫n el tipo
            const subjectGroup = document.getElementById('upload-default-subject-group');
            const periodGroup = document.getElementById('upload-default-period-group');
            
            if (type.scope === 'worker' || type.scope === 'company') {
                if (subjectGroup) {
                    subjectGroup.classList.remove('hidden');
                    updateUploadDefaultsSubject(type.scope, uploadFormData.person_key || uploadFormData.company_key);
                }
            } else {
                if (subjectGroup) subjectGroup.classList.add('hidden');
            }
            
            // Verificar si necesita periodo (derivar period_kind igual que en renderUploadFiles)
            const periodMode = type.validity_policy?.mode || 'none';
            let periodKind = 'none';
            if (periodMode === 'monthly') {
                periodKind = 'month';
            } else if (periodMode === 'annual') {
                periodKind = 'year';
            } else if (periodMode === 'quarter') {
                periodKind = 'quarter';
            } else {
                periodKind = 'none';
            }
            const needsPeriod = periodKind === 'month' || periodKind === 'year' || periodKind === 'quarter';
            
            if (needsPeriod) {
                if (periodGroup) {
                    periodGroup.classList.remove('hidden');
                    updateUploadDefaultsPeriod(uploadFormData.period_key, periodKind);
                }
            } else {
                if (periodGroup) periodGroup.classList.add('hidden');
            }
        }
        
        function updateUploadDefaultsSubject(scope, key) {
            const container = document.getElementById('upload-default-subject-input-container');
            if (!container) return;
            
            if (scope === 'worker') {
                uploadFormData.person_key = key;
                uploadFormData.company_key = null;
                container.innerHTML = `
                    <input type="text" class="form-input" 
                           id="upload-default-person-input"
                           placeholder="Buscar trabajador..."
                           value="${key || ''}"
                           onchange="uploadFormData.person_key = this.value">
                `;
            } else if (scope === 'company') {
                uploadFormData.company_key = key;
                uploadFormData.person_key = null;
                container.innerHTML = `
                    <input type="text" class="form-input" 
                           id="upload-default-company-input"
                           placeholder="Empresa..."
                           value="${key || ''}"
                           onchange="uploadFormData.company_key = this.value">
                `;
            }
        }
        
        function updateUploadDefaultsPeriod(periodKey, periodKind) {
            const container = document.getElementById('upload-default-period-input-container');
            if (!container) return;
            
            uploadFormData.period_key = periodKey;
            
            if (periodKind === 'month') {
                container.innerHTML = `
                    <input type="month" class="form-input" 
                           id="upload-default-period-input"
                           value="${periodKey || ''}"
                           onchange="uploadFormData.period_key = this.value">
                `;
            } else if (periodKind === 'annual') {
                container.innerHTML = `
                    <input type="number" class="form-input" 
                           id="upload-default-period-input"
                           placeholder="YYYY"
                           min="2000" max="2100"
                           value="${periodKey || ''}"
                           onchange="uploadFormData.period_key = this.value">
                `;
            }
        }
        
        function updateUploadDefaultsIssueDate(date) {
            uploadFormData.issue_date = date;
        }
        
        function applyDefaultsToAllFiles() {
            uploadFiles.forEach(file => {
                if (!file.type_id && uploadFormData.type_id) {
                    file.type_id = uploadFormData.type_id;
                    const type = uploadTypes.find(t => t.type_id === uploadFormData.type_id);
                    if (type) {
                        file.scope = type.scope;
                        // Auto-fecha si est√° vac√≠a
                        if (!file.issue_date) {
                            const parsedDate = parseDateFromFilename(file.name, type);
                            if (parsedDate) file.issue_date = parsedDate;
                        }
                    }
                }
                if (!file.person_key && uploadFormData.person_key) {
                    file.person_key = uploadFormData.person_key;
                }
                if (!file.company_key && uploadFormData.company_key) {
                    file.company_key = uploadFormData.company_key;
                }
                if (!file.period_key && uploadFormData.period_key) {
                    file.period_key = uploadFormData.period_key;
                }
                if (!file.issue_date && uploadFormData.issue_date) {
                    file.issue_date = uploadFormData.issue_date;
                }
            });
            renderUploadFiles();
        }
        
        function clearUploadDefaults() {
            uploadFormData = {
                type_id: null,
                scope: null,
                person_key: null,
                company_key: null,
                period_key: null,
                issue_date: null
            };
            const select = document.getElementById('upload-default-type-select');
            if (select) select.value = '';
            const subjectGroup = document.getElementById('upload-default-subject-group');
            const periodGroup = document.getElementById('upload-default-period-group');
            if (subjectGroup) subjectGroup.classList.add('hidden');
            if (periodGroup) periodGroup.classList.add('hidden');
            const issueDateInput = document.getElementById('upload-default-issue-date');
            if (issueDateInput) issueDateInput.value = '';
        }
        
        // Estado global del preview
        let previewState = {
            open: false,
            url: null,
            title: null,
            isBlob: false, // Flag para saber si es blob URL (necesita revoke)
            escListener: null
        };
        
        function previewUploadFile(fileId) {
            const file = uploadFiles.find(f => String(f.id) === String(fileId));
            if (!file) {
                console.warn('[repo-upload] File not found for preview:', fileId);
                return;
            }
            
            // Verificar que es PDF
            if (file.file && file.file.type !== 'application/pdf') {
                alert('La previsualizaci√≥n solo est√° disponible para archivos PDF.');
                return;
            }
            
            // Revocar URL anterior si existe (evitar doble revoke)
            if (previewState.url && previewState.isBlob) {
                URL.revokeObjectURL(previewState.url);
            }
            
            // Si tiene doc_id (ya guardado), usar endpoint
            let previewUrl = null;
            let isBlob = false;
            if (file.doc_id) {
                previewUrl = `${BACKEND_URL}/api/repository/docs/${file.doc_id}/pdf`;
                isBlob = false;
            } else if (file.file) {
                // Archivo local: crear Object URL
                previewUrl = URL.createObjectURL(file.file);
                isBlob = true;
            } else {
                alert('No se puede previsualizar: el archivo no est√° disponible.');
                return;
            }
            
            // Abrir modal
            const modal = document.getElementById('upload-preview-modal');
            const object = document.getElementById('preview-object');
            const fallbackLink = document.getElementById('preview-fallback-link');
            const downloadBtn = document.getElementById('preview-download-btn');
            const titleEl = document.getElementById('preview-modal-title');
            
            if (!modal || !object) {
                console.error('[repo-upload] Preview modal elements not found');
                return;
            }
            
            // Actualizar estado
            previewState.open = true;
            previewState.url = previewUrl;
            previewState.title = file.name || 'Documento';
            previewState.isBlob = isBlob;
            
            // Configurar modal
            titleEl.textContent = previewState.title;
            object.data = previewUrl; // Usar object.data en lugar de iframe.src
            fallbackLink.href = previewUrl;
            fallbackLink.download = file.name || 'documento.pdf';
            
            // Configurar bot√≥n de descarga
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = previewUrl;
                    a.download = file.name || 'documento.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            
            // Bloquear scroll del fondo
            document.body.style.overflow = 'hidden';
            
            // Listener para Esc (a√±adir solo una vez)
            if (!previewState.escListener) {
                previewState.escListener = (e) => {
                    if (e.key === 'Escape' && previewState.open) {
                        closePreviewModal();
                    }
                };
                document.addEventListener('keydown', previewState.escListener);
            }
        }
        
        function openPreviewInNewTab() {
            if (previewState.url) {
                window.open(previewState.url, '_blank', 'noopener');
            }
        }
        
        function downloadPreview() {
            if (previewState.url && previewState.title) {
                const a = document.createElement('a');
                a.href = previewState.url;
                a.download = previewState.title;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
        
        function closePreviewModal() {
            const modal = document.getElementById('upload-preview-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Limpiar object (evita que siga cargando)
            const object = document.getElementById('preview-object');
            if (object) {
                object.data = 'about:blank';
            }
            
            // Revocar Object URL si es blob (evita memory leak)
            if (previewState.url && previewState.isBlob) {
                URL.revokeObjectURL(previewState.url);
            }
            
            // Resetear estado
            previewState.open = false;
            previewState.url = null;
            previewState.title = null;
            previewState.isBlob = false;
            
            // Restaurar scroll del fondo
            document.body.style.overflow = '';
        }
        
        function removeUploadFile(fileId) {
            uploadFiles = uploadFiles.filter(f => f.id !== fileId);
            renderUploadFiles();
        }
        
        function clearAllUploadFiles() {
            if (confirm('¬øEliminar todos los archivos de la cola?')) {
                // Reset SOLO del estado (NO tocar listeners)
                uploadFiles = [];
                
                // Reset del file input (importante: si no se resetea, puede quedar "muerto")
                const fileInput = document.getElementById('file-input');
                if (fileInput) {
                    fileInput.value = ''; // Limpiar valor del input
                }
                
                // Re-render para limpiar el DOM (solo actualiza cards, no toca dropzone/input)
                renderUploadFiles();
                
                // NO llamar a setupUploadZone() - los listeners ya est√°n instalados y son estables
                // Si el DOM se recre√≥ completamente, loadSubir() los reinstalar√° autom√°ticamente
                
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] clearAllUploadFiles: reset estado', {
                        uploadFilesLength: uploadFiles.length,
                        fileInputExists: !!fileInput,
                        fileInputValue: fileInput?.value || 'N/A'
                    });
                }
            }
        }
        
        let duplicateModalData = null;
        
        // Funci√≥n auxiliar para convertir fecha a ISO (YYYY-MM-DD)
        function toISODate(value) {
            if (!value) return null;
            
            // Si ya es ISO (YYYY-MM-DD), retornar tal cual
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return value;
            }
            
            // Si es formato DD/MM/YYYY, convertir
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                const [day, month, year] = value.split('/');
                return `${year}-${month}-${day}`;
            }
            
            // Intentar parsear como Date y convertir a ISO
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.warn('[repo-upload] Error parsing date:', value, e);
            }
            
            return null;
        }
        
        async function saveAllUploadFiles() {
            if (uploadFiles.length === 0) {
                alert('No hay archivos para guardar. Por favor, arrastra o selecciona al menos un archivo PDF.');
                return;
            }
            
            // IMPORTANTE: Leer valores desde los inputs del DOM ANTES de validar
            // Esto asegura que capturamos cualquier valor que el usuario haya escrito
            // pero que no se haya guardado en el estado (por ejemplo, si escribi√≥ pero no hizo blur)
            for (const file of uploadFiles) {
                const validityInput = document.getElementById(`upload-validity-start-date-${file.id}`);
                if (validityInput && validityInput.value) {
                    // Si el input tiene un valor que no est√° en el estado, actualizarlo
                    if (validityInput.value !== file.validity_start_date) {
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.log('[repo-upload] Syncing validity_start_date from DOM:', validityInput.value, 'to state for fileId=' + file.id);
                        }
                        file.validity_start_date = validityInput.value;
                    }
                }
            }
            
            // Validar antes de enviar (incluyendo validity_start_date)
            for (const file of uploadFiles) {
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] beforeValidate fileId=' + file.id, 'validity_start_date=' + file.validity_start_date);
                }
                
                const type = uploadTypes.find(t => t.type_id === file.type_id);
                if (type) {
                    const validityStartMode = type.validity_start_mode || 'issue_date';
                    
                    // Si validity_start_mode es 'manual', validity_start_date es obligatorio
                    if (validityStartMode === 'manual') {
                        // IMPORTANTE: NO mutar file.validity_start_date aqu√≠
                        // Solo validar si est√° vac√≠o o no es v√°lido
                        const validityStartDateISO = toISODate(file.validity_start_date);
                        if (!validityStartDateISO) {
                            // Marcar error en el card (NO mutar el valor)
                            if (!file.errors) file.errors = [];
                            if (!file.errors.includes('La fecha de inicio de vigencia es obligatoria')) {
                                file.errors.push('La fecha de inicio de vigencia es obligatoria');
                            }
                        }
                    }
                }
            }
            
            // Validate
            const invalidFiles = uploadFiles.filter(f => f.errors && f.errors.length > 0);
            if (invalidFiles.length > 0) {
                // Log despu√©s de validar
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    console.log('[repo-upload] Validation failed, invalidFiles:', invalidFiles.map(f => ({
                        id: f.id,
                        name: f.name,
                        validity_start_date: f.validity_start_date,
                        errors: f.errors
                    })));
                }
                
                // Re-render para mostrar errores, pero CONSERVANDO los valores del estado
                renderUploadFiles();
                
                // Mostrar mensaje con m√°s contexto
                const errorMessages = invalidFiles.map(f => {
                    const errors = f.errors || [];
                    return `${f.name}: ${errors.join(', ')}`;
                }).join('\n');
                
                alert(`Hay ${invalidFiles.length} archivo(s) con errores:\n\n${errorMessages}\n\nPor favor, corr√≠gelos antes de guardar.`);
                
                // Log despu√©s del alert (para verificar que el estado persiste)
                if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                    for (const file of invalidFiles) {
                        console.log('[repo-upload] afterFail fileId=' + file.id, 'validity_start_date=' + file.validity_start_date);
                    }
                }
                
                return;
            }
            
            const savedDocs = [];
            const errors = [];
            
            for (const file of uploadFiles) {
                try {
                    // Si hay replace_doc_id, reemplazar PDF directamente
                    if (window.replaceDocId) {
                        const formData = new FormData();
                        formData.append('file', file.file);
                        
                        const response = await fetch(`${BACKEND_URL}/api/repository/docs/${window.replaceDocId}/pdf`, {
                            method: 'PUT',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error(await response.text());
                        }
                        
                        const doc = await response.json();
                        savedDocs.push(doc);
                        
                        // Limpiar replace_doc_id despu√©s del primer archivo
                        delete window.replaceDocId;
                        continue;
                    }
                    
                    // Check duplicate
                    const existing = await checkUploadDuplicate(file);
                    if (existing) {
                        duplicateModalData = { file, existing, action: null };
                        showDuplicateModal(file, existing);
                        await new Promise(resolve => {
                            const checkInterval = setInterval(() => {
                                if (duplicateModalData.action) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        });
                        
                        if (duplicateModalData.action === 'cancel') continue;
                        // If replace or version, continue
                    }
                    
                    // Upload
                    // Debug: log payload antes de enviar (sin el binario)
                    if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                        console.log('[repo-upload] Payload for file:', file.name, {
                            type_id: file.type_id,
                            scope: file.scope,
                            company_key: file.company_key,
                            person_key: file.person_key,
                            period_key: file.period_key,
                            issue_date: file.issue_date,
                            validity_start_date: file.validity_start_date
                        });
                    }
                    
                    // IMPORTANTE: Leer valor desde el input del DOM una vez m√°s antes de enviar
                    // (por si el usuario cambi√≥ algo despu√©s de la validaci√≥n)
                    const validityInput = document.getElementById(`upload-validity-start-date-${file.id}`);
                    if (validityInput && validityInput.value && validityInput.value !== file.validity_start_date) {
                        file.validity_start_date = validityInput.value;
                    }
                    
                    // Obtener tipo para determinar validity_start_mode
                    const type = uploadTypes.find(t => t.type_id === file.type_id);
                    const validityStartMode = type?.validity_start_mode || 'issue_date';
                    
                    // Convertir validity_start_date a ISO si existe
                    let validityStartDateISO = null;
                    if (file.validity_start_date) {
                        validityStartDateISO = toISODate(file.validity_start_date);
                        
                        // Log para diagn√≥stico
                        if (window.__REPO_DEBUG__ || window.location.hash.includes('debug=1')) {
                            console.log('[repo-upload] payload validity_start_date for fileId=' + file.id, {
                                raw: file.validity_start_date,
                                iso: validityStartDateISO
                            });
                        }
                    } else if (validityStartMode === 'issue_date' && file.issue_date) {
                        // Si es issue_date mode, usar issue_date como validity_start_date
                        validityStartDateISO = toISODate(file.issue_date);
                    }
                    
                    const formData = new FormData();
                    formData.append('file', file.file);
                    formData.append('type_id', file.type_id); // Asegurar que se env√≠a type_id (no name)
                    formData.append('scope', file.scope);
                    formData.append('validity_start_mode', validityStartMode); // SIEMPRE enviar validity_start_mode
                    if (file.company_key) formData.append('company_key', file.company_key);
                    if (file.person_key) formData.append('person_key', file.person_key);
                    if (file.period_key) formData.append('period_key', file.period_key);
                    if (file.issue_date) {
                        const issueDateISO = toISODate(file.issue_date);
                        if (issueDateISO) formData.append('issue_date', issueDateISO);
                    }
                    // SIEMPRE enviar validity_start_date si existe o si es obligatorio
                    if (validityStartDateISO) {
                        formData.append('validity_start_date', validityStartDateISO);
                    } else if (validityStartMode === 'manual') {
                        // Si es manual y no hay fecha, enviar vac√≠o (el backend validar√°)
                        formData.append('validity_start_date', '');
                    }
                    
                    const response = await fetch(`${BACKEND_URL}/api/repository/docs/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    
                    const doc = await response.json();
                    savedDocs.push(doc);
                    
                } catch (error) {
                    errors.push({ file: file.name, error: error.message });
                }
            }
            
            if (errors.length > 0) {
                alert(`Guardados: ${savedDocs.length}\nErrores: ${errors.length}\n\n${errors.map(e => `${e.file}: ${e.error}`).join('\n')}`);
            } else {
                alert(`¬°Guardados ${savedDocs.length} documento(s) exitosamente!`);
                uploadFiles = [];
                renderUploadFiles();
                navigateTo('calendario');
            }
        }
        
        async function checkUploadDuplicate(file) {
            const params = new URLSearchParams({ type_id: file.type_id });
            if (file.company_key) params.append('company_key', file.company_key);
            if (file.person_key) params.append('person_key', file.person_key);
            
            const response = await fetch(`${BACKEND_URL}/api/repository/docs?${params}`);
            const docs = await response.json();
            
            if (file.period_key) {
                const matching = docs.filter(d => d.period_key === file.period_key);
                return matching.length > 0 ? matching[0] : null;
            }
            
            return docs.length > 0 ? docs[0] : null;
        }
        
        function showDuplicateModal(file, existing) {
            const modal = document.getElementById('upload-duplicate-modal');
            const message = document.getElementById('duplicate-modal-message');
            const period = file.period_key ? formatMonth(file.period_key) : '';
            message.textContent = `Ya existe un documento para este tipo${period ? ` (${period})` : ''}. ¬øQu√© deseas hacer?`;
            modal.classList.remove('hidden');
        }
        
        function closeDuplicateModal() {
            if (duplicateModalData) {
                duplicateModalData.action = 'cancel';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        function saveAsVersion() {
            if (duplicateModalData) {
                duplicateModalData.action = 'version';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        function confirmReplace() {
            if (duplicateModalData) {
                duplicateModalData.action = 'replace';
            }
            document.getElementById('upload-duplicate-modal').classList.add('hidden');
        }
        
        // Buscar documentos - Variables globales (sistema similar al cat√°logo)
        let searchDocs = [];
        let searchTypes = [];
        let searchPeople = [];
        let searchSubjects = { companies: [], workers_by_company: {} };
        let searchFilters = {
            query: '',
            type_id: null,
            subject_key: null,
            scope: null,
            status: null,
            validity_status: null,  // VALID, EXPIRING_SOON, EXPIRED
            sort: 'date_desc',
            page: 1,
            page_size: 20
        };
        
        async function loadBuscar(params = {}) {
            dbg('loadBuscar: start', params);
            const content = document.getElementById('page-content');
            
            if (!content) {
                throw new Error('page-content element not found');
            }
            
            // Ensure data is loaded
            await ensureRepoDataLoaded({ types: true, people: true });
            
            // Load data if not already loaded
            try {
                if (searchTypes.length === 0) {
                    const typesResponse = await fetch(`${BACKEND_URL}/api/repository/types?active=true`);
                    if (!typesResponse.ok) {
                        throw new Error(`Failed to load types: ${typesResponse.status}`);
                    }
                    searchTypes = await typesResponse.json();
                }
            } catch (error) {
                console.error('[repo-search] Failed to load types:', error);
                // Continuar con tipos vac√≠os en lugar de fallar completamente
                searchTypes = searchTypes || [];
            }
            
            try {
                const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
                searchPeople = peopleData.people || [];
            } catch (error) {
                console.warn('[repo-search] Failed to load people:', error);
                searchPeople = [];
            }
            
            // Load subjects (companies + workers)
            try {
                const subjectsResponse = await fetch(`${BACKEND_URL}/api/repository/subjects`);
                if (subjectsResponse.ok) {
                    searchSubjects = await subjectsResponse.json();
                } else {
                    console.warn('[repo-search] Failed to load subjects:', subjectsResponse.status);
                    searchSubjects = { companies: [], workers_by_company: {} };
                }
            } catch (error) {
                console.warn('[repo-search] Failed to load subjects:', error);
                searchSubjects = { companies: [], workers_by_company: {} };
            }
            
            try {
                
                // Reset filters if not in params
                if (!params.type_id && !params.subject_key) {
                    searchFilters = {
                        query: '',
                        type_id: null,
                        subject_key: null,
                        scope: null,
                        status: null,
                        sort: 'date_desc',
                        page: 1,
                        page_size: 20
                    };
                } else {
                    // Apply params
                    if (params.type_id) searchFilters.type_id = params.type_id;
                    if (params.subject_key) searchFilters.subject_key = params.subject_key;
                    if (params.scope) searchFilters.scope = params.scope;
                }
                
                content.innerHTML = `
                    <div class="catalog-toolbar">
                        <div>
                            <h2 style="display: inline; margin-right: 16px;">Buscar documentos</h2>
                            <span class="catalog-results-info" id="search-results-info">
                                Mostrando 0 documentos
                            </span>
                        </div>
                    </div>
                    
                    <div class="card" data-testid="buscar-view">
                        <div class="catalog-filters">
                            <div class="form-group">
                                <label class="form-label">Buscar</label>
                                <input type="text" class="form-input" 
                                       id="search-docs-query"
                                       data-testid="buscar-text"
                                       placeholder="Buscar por nombre de archivo, tipo, o palabras..."
                                       value="${searchFilters.query}"
                                       oninput="debounceSearchDocs(this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo de documento</label>
                                <select class="form-input" id="search-docs-type-select" data-testid="buscar-type" onchange="setSearchDocsFilter('type_id', this.value || null)">
                                    <option value="">Todos los tipos</option>
                                    ${searchTypes.sort((a, b) => a.name.localeCompare(b.name)).map(type => `
                                        <option value="${type.type_id}" ${searchFilters.type_id === type.type_id ? 'selected' : ''}>${type.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aplica a</label>
                                <div>
                                    <span class="filter-chip ${searchFilters.scope === null ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('scope', null)">Todos</span>
                                    <span class="filter-chip ${searchFilters.scope === 'worker' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('scope', 'worker')">Trabajador</span>
                                    <span class="filter-chip ${searchFilters.scope === 'company' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('scope', 'company')">Empresa</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sujeto</label>
                                <select class="form-input" id="search-docs-subject-select" data-testid="buscar-subject" onchange="setSearchDocsFilter('subject_key', this.value || null)">
                                    <option value="">Todos</option>
                                    ${(() => {
                                        let options = [];
                                        // Empresas
                                        searchSubjects.companies?.forEach(company => {
                                            options.push(`<option value="${company.id}" ${searchFilters.subject_key === company.id ? 'selected' : ''}>${company.name}</option>`);
                                        });
                                        // Trabajadores
                                        Object.keys(searchSubjects.workers_by_company || {}).forEach(companyId => {
                                            const workers = searchSubjects.workers_by_company[companyId];
                                            workers.forEach(worker => {
                                                options.push(`<option value="${worker.id}" ${searchFilters.subject_key === worker.id ? 'selected' : ''}>${worker.name}</option>`);
                                            });
                                        });
                                        return options.join('');
                                    })()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <div>
                                    <span class="filter-chip ${searchFilters.status === null ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', null)">Todos</span>
                                    <span class="filter-chip ${searchFilters.status === 'VALID' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', 'VALID')">V√°lido</span>
                                    <span class="filter-chip ${searchFilters.status === 'EXPIRED' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', 'EXPIRED')">Expirado</span>
                                    <span class="filter-chip ${searchFilters.status === 'EXPIRING_SOON' ? 'active' : ''}" 
                                          onclick="setSearchDocsFilter('status', 'EXPIRING_SOON')">Expira pronto</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ordenar por</label>
                                <select class="form-input" id="search-docs-sort" onchange="setSearchDocsFilter('sort', this.value)">
                                    <option value="date_desc" ${searchFilters.sort === 'date_desc' ? 'selected' : ''}>Fecha (m√°s reciente)</option>
                                    <option value="date_asc" ${searchFilters.sort === 'date_asc' ? 'selected' : ''}>Fecha (m√°s antiguo)</option>
                                    <option value="type" ${searchFilters.sort === 'type' ? 'selected' : ''}>Tipo A‚ÜíZ</option>
                                    <option value="subject" ${searchFilters.sort === 'subject' ? 'selected' : ''}>Sujeto A‚ÜíZ</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-secondary" data-testid="buscar-apply" onclick="clearSearchDocsFilters()">Limpiar filtros</button>
                        </div>
                        
                        <div id="search-results-container">
                            <p style="color: #94a3b8;">Usa los filtros para buscar documentos</p>
                        </div>
                    </div>
                `;
                
                // SPRINT C2.1: Agregar se√±ales DOM cuando buscar est√° completamente cargado
                if (content) {
                    content.setAttribute('data-testid', 'view-search-ready');
                }
                
                // SPRINT C2.8: Asegurar que buscar-view est√° presente despu√©s del render
                const buscarViewCard = content.querySelector('.card');
                if (buscarViewCard) {
                    buscarViewCard.setAttribute('data-testid', 'buscar-view');
                }
                
                // Load initial results (no bloquear si falla)
                try {
                    // SPRINT C2.9: Asegurar que el contenedor existe antes de llamar a performSearch
                    const searchContainer = document.getElementById('search-results-container');
                    if (!searchContainer) {
                        console.warn('[repo-search] search-results-container not found, cannot perform initial search');
                    } else {
                        await performSearch();
                        // SPRINT C2.1: Asegurar que search-ui-ready se establece despu√©s de que los resultados se rendericen
                        if (searchContainer) {
                            searchContainer.setAttribute('data-testid', 'search-ui-ready');
                        }
                    }
                } catch (error) {
                    console.warn('[repo-search] Error performing initial search:', error);
                    // SPRINT C2.9: En caso de error, establecer buscar-results-error
                    const searchContainer = document.getElementById('search-results-container');
                    if (searchContainer) {
                        searchContainer.setAttribute('data-testid', 'buscar-results-error');
                    }
                }
            } catch (error) {
                console.error('[repo-search] Error in loadBuscar:', error);
                // Mostrar mensaje de error pero no romper el render b√°sico
                if (content) {
                    content.innerHTML = `
                        <div class="card" data-testid="buscar-view">
                            <h2>Buscar documentos</h2>
                            <div class="alert alert-error" data-testid="buscar-error">
                                Error al cargar la b√∫squeda: ${error.message || String(error)}
                            </div>
                        </div>
                    `;
                }
                // Re-lanzar el error para que el catch externo lo maneje
                throw error;
            }
        }
        
        // Funciones de filtrado (similar al cat√°logo)
        let searchDocsTimeout;
        function debounceSearchDocs(query) {
            clearTimeout(searchDocsTimeout);
            searchDocsTimeout = setTimeout(() => {
                searchFilters.query = query;
                searchFilters.page = 1;
                performSearch();
            }, 300);
        }
        
        function setSearchDocsFilter(key, value) {
            searchFilters[key] = value;
            searchFilters.page = 1;
            performSearch();
        }
        
        function clearSearchDocsFilters() {
            searchFilters = {
                query: '',
                type_id: null,
                subject_key: null,
                scope: null,
                status: null,
                sort: 'date_desc',
                page: 1,
                page_size: 20
            };
            const queryInput = document.getElementById('search-docs-query');
            const typeSelect = document.getElementById('search-docs-type-select');
            const subjectSelect = document.getElementById('search-docs-subject-select');
            const sortSelect = document.getElementById('search-docs-sort');
            
            if (queryInput) queryInput.value = '';
            if (typeSelect) typeSelect.value = '';
            if (subjectSelect) subjectSelect.value = '';
            if (sortSelect) sortSelect.value = 'date_desc';
            
            performSearch();
        }
        
        function updateSearchResultsInfo() {
            const info = document.getElementById('search-results-info');
            if (info) {
                info.textContent = `Mostrando ${searchDocs.length} documento${searchDocs.length !== 1 ? 's' : ''}`;
            }
        }
        
        // Funciones legacy (mantener para compatibilidad, pero no usadas)
        function searchDocsType(query) {
            const dropdown = document.getElementById('search-docs-type-dropdown');
            if (!dropdown) return;
            
            if (!query || query.trim() === '') {
                dropdown.classList.add('hidden');
                searchDocsTypeSelectedIndex = -1;
                searchDocsTypeMatches = [];
                return;
            }
            
            const queryNormalized = normalizeString(query);
            searchDocsTypeMatches = searchTypes.filter(t => {
                const nameNorm = normalizeString(t.name);
                const idNorm = normalizeString(t.type_id);
                return nameNorm.includes(queryNormalized) || idNorm.includes(queryNormalized);
            }).slice(0, 10);
            
            searchDocsTypeSelectedIndex = -1;
            
            if (searchDocsTypeMatches.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color: #94a3b8; padding: 8px;">No se encontraron tipos</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            dropdown.innerHTML = searchDocsTypeMatches.map((t, idx) => `
                <div class="autocomplete-item ${idx === 0 ? 'selected' : ''}" 
                     data-index="${idx}"
                     data-type-id="${t.type_id}"
                     onclick="selectSearchDocsType('${t.type_id}')"
                     onmouseenter="highlightSearchDocsTypeItem(${idx})">
                    ${t.name} <span style="color: #94a3b8;">(${t.type_id})</span>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }
        
        function highlightSearchDocsTypeItem(index) {
            const dropdown = document.getElementById('search-docs-type-dropdown');
            if (!dropdown) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, idx) => {
                if (idx === index) {
                    item.classList.add('selected');
                    searchDocsTypeSelectedIndex = index;
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function handleSearchDocsTypeKeydown(event) {
            const dropdown = document.getElementById('search-docs-type-dropdown');
            if (!dropdown || dropdown.classList.contains('hidden')) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item[data-type-id]');
            if (items.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                searchDocsTypeSelectedIndex = Math.min(searchDocsTypeSelectedIndex + 1, items.length - 1);
                items.forEach((item, idx) => {
                    if (idx === searchDocsTypeSelectedIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                searchDocsTypeSelectedIndex = Math.max(searchDocsTypeSelectedIndex - 1, -1);
                items.forEach((item, idx) => {
                    if (idx === searchDocsTypeSelectedIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (searchDocsTypeSelectedIndex >= 0 && searchDocsTypeSelectedIndex < items.length) {
                    const typeId = items[searchDocsTypeSelectedIndex].getAttribute('data-type-id');
                    selectSearchDocsType(typeId);
                }
            } else if (event.key === 'Escape') {
                dropdown.classList.add('hidden');
                searchDocsTypeSelectedIndex = -1;
            }
        }
        
        function handleSearchDocsTypeBlur(value) {
            setTimeout(() => {
                if (!value || value.trim() === '') {
                    searchFilters.type_id = null;
                    return;
                }
                
                const exactMatch = searchTypes.find(t => {
                    const nameNorm = normalizeString(t.name);
                    const idNorm = normalizeString(t.type_id);
                    const valueNorm = normalizeString(value);
                    return nameNorm === valueNorm || idNorm === valueNorm;
                });
                
                if (exactMatch) {
                    selectSearchDocsType(exactMatch.type_id);
                } else {
                    searchFilters.type_id = null;
                    const input = document.getElementById('search-docs-type-input');
                    if (input) input.value = '';
                }
            }, 200);
        }
        
        function selectSearchDocsType(typeId) {
            const type = searchTypes.find(t => t.type_id === typeId);
            if (type) {
                searchFilters.type_id = typeId;
                searchFilters.scope = type.scope;
                const input = document.getElementById('search-docs-type-input');
                if (input) input.value = type.name;
            }
            
            document.getElementById('search-docs-type-dropdown').classList.add('hidden');
            searchDocsTypeSelectedIndex = -1;
        }
        
        function updateSearchQuery(value) {
            searchFilters.query = value || '';
        }
        
        function updateSearchSubject(value) {
            searchFilters.subject_key = value || null;
        }
        
        // Funci√≥n legacy (mantener para compatibilidad)
        function clearSearchFilters() {
            clearSearchDocsFilters();
        }
        
        // SPRINT C2.9.2: Funci√≥n finalizadora que establece marcador como invariante
        function finalizeSearchResults({ ok, count }) {
            // Buscar contenedor principal de la vista Buscar (m√°s estable que search-results-container)
            // Usar page-content como contenedor ra√≠z, ya que no se sobrescribe con innerHTML
            const pageContent = document.getElementById('page-content');
            
            if (!pageContent) {
                console.warn('[repo-search] page-content no encontrado, no se puede establecer marcador');
                return;
            }
            
            // Eliminar markers anteriores si existen (buscar en todo el page-content)
            const existingReady = pageContent.querySelector('[data-testid="buscar-results-ready"]');
            const existingError = pageContent.querySelector('[data-testid="buscar-results-error"]');
            if (existingReady) existingReady.remove();
            if (existingError) existingError.remove();
            
            // Crear marker nuevo SIEMPRE
            const marker = document.createElement('div');
            if (ok) {
                marker.setAttribute('data-testid', 'buscar-results-ready');
                marker.setAttribute('data-count', String(count || 0));
                marker.setAttribute('data-empty', count === 0 ? 'true' : 'false');
            } else {
                marker.setAttribute('data-testid', 'buscar-results-error');
            }
            marker.style.display = 'none';
            
            // Insertar como hijo directo del page-content (NO dentro de innerHTML que pueda sobrescribirse)
            pageContent.appendChild(marker);
        }
        
        async function performSearch() {
            const container = document.getElementById('search-results-container');
            if (!container) {
                // SPRINT C2.9.2: Si no hay contenedor, marcar error pero continuar
                finalizeSearchResults({ ok: false, count: 0 });
                return;
            }
            
            container.innerHTML = '<div class="loading">Buscando...</div>';
            
            let searchSucceeded = false;
            let searchFailed = false;
            let resultCount = 0;
            
            try {
                // Build query params
                const params = new URLSearchParams();
                if (searchFilters.type_id) {
                    params.append('type_id', searchFilters.type_id);
                }
                if (searchFilters.scope) {
                    params.append('scope', searchFilters.scope);
                }
                
                // Fetch all documents (backend now supports validity_status filter)
                const response = await fetch(`${BACKEND_URL}/api/repository/docs?${params}`);
                let docs = await response.json();
                if (!Array.isArray(docs)) docs = [];
                
                // Client-side filtering
                if (searchFilters.query) {
                    const queryNorm = normalizeString(searchFilters.query);
                    docs = docs.filter(doc => {
                        // FIX: Usar file_name_original del modelo DocumentInstanceV1
                        const fileName = normalizeString(doc.file_name_original || doc.doc_file_name || '');
                        const type = searchTypes.find(t => t.type_id === doc.type_id);
                        const typeName = type ? normalizeString(type.name) : '';
                        const typeId = type ? normalizeString(type.type_id) : '';
                        return fileName.includes(queryNorm) || 
                               typeName.includes(queryNorm) || 
                               typeId.includes(queryNorm);
                    });
                }
                
                if (searchFilters.subject_key) {
                    docs = docs.filter(doc => {
                        return doc.person_key === searchFilters.subject_key || 
                               doc.company_key === searchFilters.subject_key;
                    });
                }
                
                if (searchFilters.status) {
                    docs = docs.filter(doc => {
                        const status = doc.computed_validity?.status || 'UNKNOWN';
                        return status === searchFilters.status;
                    });
                }
                
                // Sorting
                docs.sort((a, b) => {
                    switch (searchFilters.sort) {
                        case 'date_desc':
                            const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return dateB - dateA;
                        case 'date_asc':
                            const dateA2 = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB2 = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return dateA2 - dateB2;
                        case 'type':
                            const typeA = searchTypes.find(t => t.type_id === a.type_id);
                            const typeB = searchTypes.find(t => t.type_id === b.type_id);
                            const nameA = typeA ? typeA.name : a.type_id || '';
                            const nameB = typeB ? typeB.name : b.type_id || '';
                            return nameA.localeCompare(nameB);
                        case 'subject':
                            const subjectA = a.person_key || a.company_key || '';
                            const subjectB = b.person_key || b.company_key || '';
                            return subjectA.localeCompare(subjectB);
                        default:
                            return 0;
                    }
                });
                
                searchDocs = docs;
                resultCount = docs.length;
                renderSearchResults();
                updateSearchResultsInfo();
                searchSucceeded = true;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error" data-testid="buscar-error">Error al buscar: ${error.message}</div>`;
                searchFailed = true;
                resultCount = 0;
            } finally {
                // SPRINT C2.9.2: SIEMPRE establecer marcador como invariante
                finalizeSearchResults({ 
                    ok: searchSucceeded, 
                    count: resultCount 
                });
            }
        }
        
        function renderSearchResults() {
            const container = document.getElementById('search-results-container');
            if (!container) return;
            
            if (searchDocs.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8;">No se encontraron documentos con los filtros seleccionados</p>';
                updateSearchResultsInfo();
                return;
            }
            
            container.innerHTML = `
                <div class="table-container" style="max-height: calc(100vh - 500px); overflow-y: auto;">
                    <table class="catalog-table" data-testid="buscar-results">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Sujeto</th>
                                <th>Archivo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${searchDocs.map(doc => {
                                // FIX: Manejar documentos antiguos que pueden tener 'id' en lugar de 'doc_id'
                                const docId = doc.doc_id || doc.id || '';
                                if (!docId) {
                                    console.warn('[repo-search] Documento sin ID:', doc);
                                    return `<tr><td colspan="6" style="color: #fca5a5;">Documento sin ID (formato antiguo)</td></tr>`;
                                }
                                
                                const type = searchTypes.find(t => t.type_id === doc.type_id);
                                const typeName = type ? type.name : doc.type_id;
                                
                                let subjectName = doc.person_key || doc.company_key || '-';
                                const subjectKey = doc.person_key || doc.company_key || '';
                                const subjectType = doc.person_key ? 'trabajador' : (doc.company_key ? 'empresa' : '');
                                
                                if (doc.person_key) {
                                    // Buscar en workers_by_company
                                    let found = false;
                                    Object.keys(searchSubjects.workers_by_company || {}).forEach(companyId => {
                                        const workers = searchSubjects.workers_by_company[companyId];
                                        const worker = workers.find(w => w.id === doc.person_key);
                                        if (worker) {
                                            subjectName = worker.name;
                                            found = true;
                                        }
                                    });
                                    if (!found) {
                                        const person = searchPeople.find(p => p.worker_id === doc.person_key);
                                        if (person) subjectName = person.full_name;
                                    }
                                } else if (doc.company_key) {
                                    const company = searchSubjects.companies?.find(c => c.id === doc.company_key);
                                    if (company) subjectName = company.name;
                                }
                                
                                // Estado de validez calculado desde backend
                                const validityStatus = doc.validity_status || 'UNKNOWN';
                                const validityEndDate = doc.validity_end_date || null;
                                const daysUntilExpiry = doc.days_until_expiry !== undefined ? doc.days_until_expiry : null;
                                
                                // Badge de estado
                                let statusBadge = 'badge-secondary';
                                let statusText = 'Desconocido';
                                
                                if (validityStatus === 'VALID') {
                                    statusBadge = 'badge-ok';
                                    statusText = 'V√°lido';
                                    if (daysUntilExpiry !== null) {
                                        statusText += ` (${daysUntilExpiry} d√≠as)`;
                                    }
                                } else if (validityStatus === 'EXPIRING_SOON') {
                                    statusBadge = 'badge-warning';
                                    statusText = 'Expira pronto';
                                    if (daysUntilExpiry !== null) {
                                        statusText += ` (${daysUntilExpiry} d√≠as)`;
                                    }
                                } else if (validityStatus === 'EXPIRED') {
                                    statusBadge = 'badge-error';
                                    statusText = 'Expirado';
                                    if (daysUntilExpiry !== null) {
                                        statusText += ` (hace ${Math.abs(daysUntilExpiry)} d√≠as)`;
                                    }
                                } else if (validityStatus === 'UNKNOWN') {
                                    statusBadge = 'badge-secondary';
                                    statusText = 'Desconocido';
                                }
                                
                                const status = validityStatus;
                                
                                const createdDate = doc.created_at ? new Date(doc.created_at).toLocaleDateString('es-ES') : '-';
                                // FIX: Usar file_name_original del modelo DocumentInstanceV1
                                const fileName = doc.file_name_original || doc.doc_file_name || docId.substring(0, 8) || '-';
                                const escapedDocId = docId.replace(/'/g, "\\'");
                                const escapedFileName = fileName.replace(/'/g, "\\'");
                                
                                return `
                                    <tr data-testid="buscar-row" 
                                        data-doc-id="${escapedDocId}" 
                                        data-type-id="${doc.type_id || ''}" 
                                        data-subject="${subjectType}">
                                        <td>${createdDate}</td>
                                        <td>
                                            <strong>${typeName}</strong>
                                            ${type ? `<div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${doc.type_id}</div>` : ''}
                                        </td>
                                        <td>${subjectName}</td>
                                        <td>${fileName}</td>
                                        <td>
                                            <span class="badge ${statusBadge}">${statusText}</span>
                                            ${validityEndDate ? `<div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">Caduca: ${formatDate(validityEndDate)}</div>` : ''}
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="btn btn-secondary btn-sm" 
                                                        data-testid="buscar-action-file"
                                                        onclick="viewDocumentFromSearch('${escapedDocId}')"
                                                        title="Ver/Descargar PDF">
                                                    Ver PDF
                                                </button>
                                                ${type ? `
                                                    <button class="btn btn-secondary btn-sm" 
                                                            onclick="navigateToCalendarFromSearch('${doc.type_id}', '${doc.scope}', '${doc.person_key || ''}', '${doc.company_key || ''}')">
                                                        Ver calendario
                                                    </button>
                                                ` : ''}
                                                <button class="btn btn-secondary btn-sm" 
                                                        onclick="resubmitDocumentFromSearch('${escapedDocId}', '${doc.type_id || ''}', '${doc.scope || ''}')"
                                                        title="Reemplazar el PDF de este documento">
                                                    Resubir
                                                </button>
                                                <button class="btn btn-secondary btn-sm" 
                                                        data-testid="buscar-action-edit"
                                                        data-edit-doc-button="true"
                                                        data-doc-id="${escapedDocId}"
                                                        onclick="openEditDocModal('${escapedDocId}'); return false;">
                                                    Editar
                                                </button>
                                                <button class="btn btn-secondary btn-sm" 
                                                        style="color: #ef4444;"
                                                        onclick="deleteDocumentFromSearch('${escapedDocId}', '${escapedFileName}')"
                                                        ${doc.status === 'submitted' ? 'disabled title="No se puede eliminar un documento con estado submitted"' : ''}>
                                                    Eliminar
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            updateSearchResultsInfo();
        }
        
        function navigateToCalendarFromSearch(typeId, scope, personKey, companyKey) {
            const params = { type_id: typeId };
            if (personKey) params.person_key = personKey;
            if (companyKey) params.company_key = companyKey;
            navigateTo('calendario', params);
        }
        
        // Variables para edici√≥n de documentos
        let editingDocument = null;
        
        // SPRINT C2.2: Event delegation para botones Editar
        function initEditDocumentDelegation() {
            // Usar capture phase para asegurar que se ejecute antes de otros listeners
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-testid="buscar-action-edit"], [data-edit-doc-button="true"]');
                if (!btn) return;
                
                // SPRINT C2.2.1: Log diagn√≥stico
                console.log('[EDITMODAL] click captured', { target: e.target.tagName, docId: btn.getAttribute('data-doc-id') });
                
                const docId = btn.getAttribute('data-doc-id');
                if (!docId) {
                    console.warn('[edit-doc] Button clicked but no data-doc-id found');
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                openEditDocModal(docId);
            }, true); // Use capture phase
        }
        
        // SPRINT C2.2.1: Funci√≥n wrapper para diagn√≥stico
        async function openEditDocModal(docId) {
            console.log('[EDITMODAL] openEditDocModal start', { docId });
            try {
                await editDocumentFromSearch(docId);
            } catch (err) {
                console.error('[EDITMODAL] open failed', err);
                throw err;
            }
        }
        
        async function editDocumentFromSearch(docId) {
            try {
                console.log('[editDocumentFromSearch] docId:', docId);
                // FIX: Buscar el documento en searchDocs (puede tener doc_id o id)
                let doc = searchDocs.find(d => (d.doc_id || d.id) === docId);
                console.log('[editDocumentFromSearch] doc from searchDocs:', doc);
                if (!doc) {
                    // Si no est√° en la lista, cargarlo desde el backend usando el endpoint espec√≠fico
                    console.log('[editDocumentFromSearch] Loading from backend...');
                    const response = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Intentar cargar todos los documentos y buscar
                            const allDocsResponse = await fetch(`${BACKEND_URL}/api/repository/docs`);
                            if (allDocsResponse.ok) {
                                const allDocs = await allDocsResponse.json();
                                doc = allDocs.find(d => (d.doc_id || d.id) === docId);
                            }
                        }
                        if (!doc) {
                            throw new Error('Documento no encontrado');
                        }
                    } else {
                        doc = await response.json();
                    }
                    console.log('[editDocumentFromSearch] doc from backend:', doc);
                }
                
                if (!doc) {
                    alert('Error: Documento no encontrado');
                    return;
                }
                
                // Normalizar doc_id (puede venir como 'id' en documentos antiguos)
                if (!doc.doc_id && doc.id) {
                    doc.doc_id = doc.id;
                }
                
                if (!doc.doc_id) {
                    alert('Error: El documento no tiene ID v√°lido');
                    return;
                }
                
                editingDocument = doc;
                
                // Asegurar que los tipos est√°n cargados
                if (searchTypes.length === 0) {
                    console.log('[editDocumentFromSearch] Loading types...');
                    try {
                        const typesResponse = await fetch(`${BACKEND_URL}/api/repository/types?active=true`);
                        if (typesResponse.ok) {
                            const typesData = await typesResponse.json();
                            searchTypes = Array.isArray(typesData) ? typesData : (typesData.items || []);
                            console.log('[editDocumentFromSearch] Loaded types:', searchTypes.length);
                        }
                    } catch (e) {
                        console.error('[editDocumentFromSearch] Error loading types:', e);
                    }
                }
                
                // Obtener el tipo del documento
                const type = searchTypes.find(t => t.type_id === doc.type_id);
                console.log('[editDocumentFromSearch] type:', type, 'type_id:', doc.type_id, 'available types:', searchTypes.map(t => t.type_id));
                if (!type) {
                    alert(`Tipo de documento no encontrado: ${doc.type_id}. Tipos disponibles: ${searchTypes.map(t => t.type_id).join(', ')}`);
                    return;
                }
                
                // Crear y mostrar modal de edici√≥n
                console.log('[editDocumentFromSearch] Showing modal for doc:', editingDocument.doc_id, 'type:', type.type_id);
                showEditDocumentModal(editingDocument, type);
                console.log('[editDocumentFromSearch] Modal should be visible now');
                // Verificar que el modal se insert√≥ correctamente
                const checkModal = document.querySelector('[data-testid="edit-doc-modal-open"]');
                console.log('[editDocumentFromSearch] Modal check after showEditDocumentModal:', !!checkModal);
            } catch (error) {
                console.error('[editDocumentFromSearch] Error:', error);
                alert(`Error al cargar documento: ${error.message}`);
            }
        }
        
        function showEditDocumentModal(doc, type) {
            // SPRINT C2.2: Cerrar cualquier modal existente antes de abrir uno nuevo
            const existingOverlay = document.getElementById('edit-doc-modal-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            // Escapar valores para HTML
            const typeName = escapeHtml(type.name || '');
            const typeId = escapeHtml(doc.type_id || '');
            const fileName = escapeHtml(doc.file_name_original || doc.doc_file_name || doc.doc_id || '');
            
            // Obtener valores de fechas
            const issueDate = doc.issued_at || doc.extracted?.issue_date || '';
            const validityStartDate = doc.extracted?.validity_start_date || '';
            const periodKey = doc.period_key || '';
            
            // Estado de validez (readonly)
            const validityStatus = doc.validity_status || 'UNKNOWN';
            const validityEndDate = doc.validity_end_date || '';
            const daysUntilExpiry = doc.days_until_expiry !== undefined ? doc.days_until_expiry : null;
            
            // Determinar qu√© campos mostrar seg√∫n el tipo
            const showIssueDate = type.issue_date_required || issueDate;
            const showValidityStartDate = type.validity_start_mode === 'manual' || validityStartDate;
            const showPeriodKey = doc.period_kind && doc.period_kind !== 'NONE' && doc.period_kind !== 'none';
            
            // Helper para formatear fecha
            function formatDateForInput(dateStr) {
                if (!dateStr) return '';
                if (typeof dateStr === 'string' && dateStr.includes('T')) {
                    return dateStr.split('T')[0];
                }
                return dateStr;
            }
            
            // Helper para badge de estado de validez
            function getValidityStatusBadge(status) {
                const statusText = {
                    'VALID': 'V√°lido',
                    'EXPIRING_SOON': 'Expira pronto',
                    'EXPIRED': 'Expirado',
                    'UNKNOWN': 'Desconocido'
                };
                const badgeClass = {
                    'VALID': 'badge-ok',
                    'EXPIRING_SOON': 'badge-warning',
                    'EXPIRED': 'badge-error',
                    'UNKNOWN': 'badge-secondary'
                };
                return `<span class="badge ${badgeClass[status] || 'badge-secondary'}">${statusText[status] || status}</span>`;
            }
            
            // Crear modal HTML
            // SPRINT C2.2: A√±adir se√±ales DOM para tests deterministas
            const modalHTML = `
                <div class="modal-overlay" 
                     id="edit-doc-modal-overlay" 
                     data-testid="edit-doc-modal-overlay"
                     data-modal-state="open"
                     onclick="closeEditDocumentModal()">
                    <div class="modal" 
                         data-testid="edit-doc-modal-open"
                         onclick="event.stopPropagation()" 
                         style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>Editar documento</h3>
                            <button class="btn btn-secondary" onclick="closeEditDocumentModal()" style="padding: 4px 12px; position: absolute; top: 24px; right: 24px;">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Tipo de documento</label>
                                <input type="text" class="form-input" value="${typeName}" disabled>
                                <div class="form-help" style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${typeId}</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Archivo</label>
                                <input type="text" class="form-input" value="${fileName}" disabled>
                            </div>
                            
                            <!-- Estado de validez (readonly) -->
                            <div class="form-group" style="background: #1e293b; padding: 12px; border-radius: 6px; border: 1px solid #334155;">
                                <label class="form-label" style="color: #cbd5e1;">Estado de validez (calculado)</label>
                                <div style="margin-top: 8px;">
                                    ${getValidityStatusBadge(validityStatus)}
                                    ${validityEndDate ? `<div style="margin-top: 8px; font-size: 0.875rem; color: #94a3b8;">Caduca: ${formatDate(validityEndDate)}</div>` : ''}
                                    ${daysUntilExpiry !== null ? `<div style="margin-top: 4px; font-size: 0.875rem; color: #94a3b8;">${daysUntilExpiry >= 0 ? `${daysUntilExpiry} d√≠as restantes` : `Expirado hace ${Math.abs(daysUntilExpiry)} d√≠as`}</div>` : ''}
                                </div>
                                <div class="form-help" style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">Este estado se calcula autom√°ticamente seg√∫n las fechas del documento. No es editable.</div>
                            </div>
                            
                            ${type.scope === 'company' ? `
                                <div class="form-group">
                                    <label class="form-label">Empresa <span class="form-required">*</span></label>
                                    <select class="form-input" id="edit-doc-company">
                                        <option value="">Selecciona una empresa</option>
                                        ${searchSubjects.companies?.map(company => `
                                            <option value="${company.id}" ${doc.company_key === company.id ? 'selected' : ''}>${company.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            ${type.scope === 'worker' ? `
                                <div class="form-group">
                                    <label class="form-label">Empresa <span class="form-required">*</span></label>
                                    <select class="form-input" id="edit-doc-company" onchange="updateEditDocWorkers()">
                                        <option value="">Selecciona una empresa</option>
                                        ${searchSubjects.companies?.map(company => `
                                            <option value="${company.id}" ${doc.company_key === company.id ? 'selected' : ''}>${company.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Trabajador <span class="form-required">*</span></label>
                                    <select class="form-input" id="edit-doc-worker">
                                        <option value="">Selecciona un trabajador</option>
                                        ${(() => {
                                            let options = '';
                                            const selectedCompanyId = doc.company_key;
                                            if (selectedCompanyId && searchSubjects.workers_by_company[selectedCompanyId]) {
                                                searchSubjects.workers_by_company[selectedCompanyId].forEach(worker => {
                                                    options += `<option value="${worker.id}" ${doc.person_key === worker.id ? 'selected' : ''}>${worker.name}</option>`;
                                                });
                                            }
                                            return options;
                                        })()}
                                    </select>
                                </div>
                            ` : ''}
                            
                            ${showPeriodKey ? `
                                <div class="form-group">
                                    <label class="form-label">Mes/A√±o ${type.validity_policy?.mode === 'monthly' ? '<span class="form-required">*</span>' : ''}</label>
                                    <input type="text" class="form-input" id="edit-doc-period-key" 
                                           value="${periodKey}" 
                                           placeholder="YYYY-MM (ej: 2025-01)"
                                           pattern="[0-9]{4}-[0-9]{2}">
                                    <div class="form-help" style="font-size: 0.75rem; color: #94a3b8;">Formato: YYYY-MM (ej: 2025-01)</div>
                                </div>
                            ` : ''}
                            
                            ${showIssueDate ? `
                                <div class="form-group">
                                    <label class="form-label">Fecha de emisi√≥n ${type.issue_date_required ? '<span class="form-required">*</span>' : ''}</label>
                                    <input type="date" class="form-input" id="edit-doc-issue-date" 
                                           value="${formatDateForInput(issueDate)}">
                                    <div class="form-help" style="font-size: 0.75rem; color: #94a3b8;">Fecha en que se emiti√≥ el documento</div>
                                </div>
                            ` : ''}
                            
                            ${showValidityStartDate ? `
                                <div class="form-group">
                                    <label class="form-label">Fecha inicio de vigencia ${type.validity_start_mode === 'manual' ? '<span class="form-required">*</span>' : ''}</label>
                                    <input type="date" class="form-input" id="edit-doc-validity-start-date" 
                                           data-testid="edit-doc-validity-start-date"
                                           value="${formatDateForInput(validityStartDate)}">
                                    <div class="form-help" style="font-size: 0.75rem; color: #94a3b8;">Fecha desde la cual el documento es v√°lido</div>
                                </div>
                            ` : ''}
                            
                            <div class="form-group">
                                <label class="form-label">Estado de tramitaci√≥n</label>
                                <select class="form-input" id="edit-doc-status" data-testid="edit-doc-status">
                                    <option value="draft" ${doc.status === 'draft' ? 'selected' : ''}>Borrador</option>
                                    <option value="reviewed" ${doc.status === 'reviewed' ? 'selected' : ''}>Revisado</option>
                                    <option value="ready_to_submit" ${doc.status === 'ready_to_submit' ? 'selected' : ''}>Listo para enviar</option>
                                    <option value="submitted" ${doc.status === 'submitted' ? 'selected' : ''}>Enviado</option>
                                </select>
                                <div class="form-help" style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px;">
                                    <strong>Borrador:</strong> Datos en preparaci√≥n<br>
                                    <strong>Revisado:</strong> Verificado internamente<br>
                                    <strong>Listo para enviar:</strong> Preparado para plataforma CAE<br>
                                    <strong>Enviado:</strong> Ya subido/enviado a plataforma<br>
                                    <em style="color: #64748b;">Nota: Este estado no afecta a la caducidad. La caducidad depende de las fechas.</em>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeEditDocumentModal()">Cancelar</button>
                            <button class="btn btn-primary" onclick="saveDocumentEdit()" data-testid="edit-doc-save">Guardar</button>
                        </div>
                    </div>
                </div>
            `;
            
            // SPRINT C2.2.1: Log antes de insertar overlay
            console.log('[EDITMODAL] inserting overlay');
            
            // SPRINT C2.2: Insertar el HTML del modal directamente en el body usando insertAdjacentHTML
            // Esto asegura que el modal est√© directamente en el body y los testids sean accesibles
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // SPRINT C2.2.1: Log despu√©s de insertar
            const overlay = document.getElementById('edit-doc-modal-overlay');
            const modalOpen = document.querySelector('[data-testid="edit-doc-modal-open"]');
            console.log('[EDITMODAL] overlay inserted', !!overlay);
            console.log('[EDITMODAL] overlay inserted check', !!document.querySelector('[data-testid="edit-doc-modal-overlay"]'));
            
            if (!overlay || !modalOpen) {
                console.error('[showEditDocumentModal] ERROR: Modal elements not found after insertion!');
            }
            
            // Actualizar lista de trabajadores si es necesario
            if (type.scope === 'worker') {
                updateEditDocWorkers();
            }
        }
        
        function updateEditDocWorkers() {
            const companySelect = document.getElementById('edit-doc-company');
            const workerSelect = document.getElementById('edit-doc-worker');
            if (!companySelect || !workerSelect) return;
            
            const companyId = companySelect.value;
            workerSelect.innerHTML = '<option value="">Selecciona un trabajador</option>';
            
            if (companyId && searchSubjects.workers_by_company[companyId]) {
                searchSubjects.workers_by_company[companyId].forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = worker.name;
                    workerSelect.appendChild(option);
                });
            }
        }
        
        function closeEditDocumentModal() {
            const overlay = document.getElementById('edit-doc-modal-overlay');
            if (overlay) {
                // SPRINT C2.2: Establecer se√±al de cierre antes de eliminar
                overlay.setAttribute('data-modal-state', 'closed');
                overlay.setAttribute('data-testid', 'edit-doc-modal-closed');
                overlay.remove();
            }
            editingDocument = null;
        }
        
        async function saveDocumentEdit() {
            console.log('[EDITMODAL] saveDocumentEdit called');
            if (!editingDocument) {
                console.warn('[EDITMODAL] saveDocumentEdit: no editingDocument');
                return;
            }
            
            const type = searchTypes.find(t => t.type_id === editingDocument.type_id);
            if (!type) {
                console.error('[EDITMODAL] saveDocumentEdit: tipo no encontrado', editingDocument.type_id);
                alert('Tipo de documento no encontrado');
                return;
            }
            
            console.log('[EDITMODAL] saveDocumentEdit: type scope', type.scope);
            
            // Recopilar datos del formulario
            const updateData = {};
            
            if (type.scope === 'company') {
                const companySelect = document.getElementById('edit-doc-company');
                console.log('[EDITMODAL] saveDocumentEdit: companySelect', companySelect, 'value', companySelect?.value);
                // SPRINT C2.2.3: Si no hay empresa seleccionada pero el documento ya tiene company_key, usarla
                if (!companySelect || !companySelect.value) {
                    if (editingDocument.company_key) {
                        console.log('[EDITMODAL] saveDocumentEdit: usando company_key existente', editingDocument.company_key);
                        updateData.company_key = editingDocument.company_key;
                        updateData.person_key = null;
                    } else {
                        console.warn('[EDITMODAL] saveDocumentEdit: empresa obligatoria no encontrada');
                        alert('La empresa es obligatoria');
                        return;
                    }
                } else {
                    updateData.company_key = companySelect.value;
                    updateData.person_key = null;
                }
            } else if (type.scope === 'worker') {
                const companySelect = document.getElementById('edit-doc-company');
                const workerSelect = document.getElementById('edit-doc-worker');
                if (!companySelect || !companySelect.value) {
                    console.warn('[EDITMODAL] saveDocumentEdit: empresa obligatoria no encontrada');
                    alert('La empresa es obligatoria');
                    return;
                }
                if (!workerSelect || !workerSelect.value) {
                    console.warn('[EDITMODAL] saveDocumentEdit: trabajador obligatorio no encontrado');
                    alert('El trabajador es obligatorio');
                    return;
                }
                updateData.company_key = companySelect.value;
                updateData.person_key = workerSelect.value;
            }
            
            const statusSelect = document.getElementById('edit-doc-status');
            if (statusSelect) {
                updateData.status = statusSelect.value;
            }
            
            // Recopilar campos de fechas y per√≠odo
            const periodKeyInput = document.getElementById('edit-doc-period-key');
            if (periodKeyInput && periodKeyInput.value) {
                updateData.period_key = periodKeyInput.value.trim();
            }
            
            const issueDateInput = document.getElementById('edit-doc-issue-date');
            if (issueDateInput && issueDateInput.value) {
                updateData.issue_date = issueDateInput.value;
            }
            
            const validityStartDateInput = document.getElementById('edit-doc-validity-start-date');
            if (validityStartDateInput && validityStartDateInput.value) {
                updateData.validity_start_date = validityStartDateInput.value;
            }
            
            // SPRINT C2.2: Mostrar mensaje de error en el modal si falla
            const errorDiv = document.getElementById('edit-doc-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            console.log('[EDITMODAL] saveDocumentEdit: sending PUT', editingDocument.doc_id, updateData);
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/docs/${editingDocument.doc_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                // SPRINT C2.2.3: Cerrar modal inmediatamente despu√©s de PUT exitoso
                console.log('[EDITMODAL] save ok -> closing modal');
                closeEditDocumentModal();
                
                // SPRINT C2.2.3: Refrescar resultados en segundo plano (no bloquea el cierre)
                try {
                    await performSearch();
                } catch (e) {
                    console.warn('[EDITMODAL] performSearch failed after save', e);
                }
            } catch (error) {
                // SPRINT C2.2: Mostrar error en el modal en lugar de alert
                const modalBody = document.querySelector('#edit-doc-modal-overlay .modal-body');
                if (modalBody) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'edit-doc-error';
                    errorDiv.setAttribute('data-testid', 'edit-doc-error');
                    errorDiv.className = 'alert alert-error';
                    errorDiv.style.marginTop = '16px';
                    errorDiv.textContent = `Error al guardar: ${error.message}`;
                    modalBody.appendChild(errorDiv);
                } else {
                    alert(`Error al guardar: ${error.message}`);
                }
            }
        }
        
        async function deleteDocumentFromSearch(docId, docName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el documento "${docName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/docs/${docId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    if (response.status === 409) {
                        alert('No se puede eliminar un documento con estado "submitted"');
                    } else {
                        throw new Error(error);
                    }
                    return;
                }
                
                // Recargar resultados
                await performSearch();
            } catch (error) {
                alert(`Error al eliminar: ${error.message}`);
            }
        }
        
        // Plataformas
        async function loadPlataformas(params = {}) {
            const content = document.getElementById('page-content');
            
            try {
                const [rules, platforms, types] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json()).catch(() => ({platforms: []})),
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json())
                ]);
                
                const egestiona = platforms.platforms?.find(p => p.key === 'egestiona');
                const coords = egestiona?.coordinations || [];
                
                // Calculate status for each coord
                const coordStatuses = coords.map(coord => {
                    const hasCoordRule = rules.some(r => 
                        r.scope === 'COORD' && r.coord_label === coord.label && r.platform_key === 'egestiona'
                    );
                    const hasGlobalRule = rules.some(r => 
                        r.scope === 'GLOBAL' && r.platform_key === 'egestiona'
                    );
                    
                    let status = 'none';
                    let ruleType = 'ninguna';
                    if (hasCoordRule) {
                        status = 'ok';
                        ruleType = 'espec√≠fica';
                    } else if (hasGlobalRule) {
                        status = 'partial';
                        ruleType = 'general';
                    }
                    
                    return { coord, status, ruleType };
                });
                
                const covered = coordStatuses.filter(s => s.status !== 'none').length;
                const total = coords.length;
                
                // Overall platform status
                let platformStatus = 'none';
                if (covered === total && total > 0) {
                    platformStatus = 'ok';
                } else if (covered > 0) {
                    platformStatus = 'partial';
                }
                
                content.innerHTML = `
                    <div class="card">
                        <h3>Plataformas</h3>
                        <div class="platform-card">
                            <h4 style="display: inline;">eGestiona</h4>
                            <span class="platform-status platform-status-${platformStatus}">
                                ${platformStatus === 'ok' ? 'Configurado' : platformStatus === 'partial' ? 'Parcial' : 'Sin configurar'}
                            </span>
                            <p style="margin-top: 8px; color: #94a3b8;">
                                Clientes cubiertos: ${covered}/${total}
                            </p>
                            ${platformStatus !== 'ok' ? `
                                <button class="btn btn-primary" onclick="createGlobalRules()" style="margin-top: 12px;">
                                    Crear configuraci√≥n general
                                </button>
                            ` : ''}
                        </div>
                        
                        <h3 style="margin-top: 24px;">Clientes</h3>
                        ${coordStatuses.map(({coord, status, ruleType}) => `
                            <div class="platform-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${coord.label}</strong>
                                        <span style="color: #94a3b8; margin-left: 12px;">Regla usada: ${ruleType}</span>
                                    </div>
                                    ${status === 'none' ? `
                                        <div>
                                            <span class="badge badge-falta" style="margin-right: 8px;">Sin regla</span>
                                            <button class="btn btn-secondary" onclick="fixCoordRule('${coord.label}')">Arreglar</button>
                                        </div>
                                    ` : status === 'partial' ? `
                                        <span class="badge badge-info">Usa regla general</span>
                                    ` : `
                                        <span class="badge badge-ok">Regla espec√≠fica</span>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar plataformas: ${error.message}</div>`;
            }
        }
        
        async function createGlobalRules() {
            if (!confirm('¬øCrear configuraci√≥n general para eGestiona? Esto crear√° reglas base para todos los tipos de documento.')) {
                return;
            }
            
            try {
                const [types, platforms] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json()),
                    fetch(`${BACKEND_URL}/api/config/platforms`).then(r => r.json())
                ]);
                
                const existingRules = await fetch(`${BACKEND_URL}/api/repository/rules`).then(r => r.json()).catch(() => []);
                const existingGlobalTypes = new Set(
                    existingRules.filter(r => r.scope === 'GLOBAL' && r.platform_key === 'egestiona')
                        .map(r => r.document_type_id)
                );
                
                let created = 0;
                for (const type of types) {
                    if (existingGlobalTypes.has(type.type_id)) continue;
                    
                    const rule = {
                        rule_id: `egestiona_global_${type.type_id.toLowerCase()}`,
                        scope: 'GLOBAL',
                        platform_key: 'egestiona',
                        coord_label: null,
                        enabled: true,
                        match: {
                            pending_text_contains: (type.platform_aliases || []).slice(0, 5),
                            empresa_contains: []
                        },
                        document_type_id: type.type_id,
                        form: {
                            upload_field_selector: "input[type='file']",
                            date_fields: {},
                            submit_button: { selector: null, by_text: null },
                            confirmation: { text_contains: [] }
                        }
                    };
                    
                    try {
                        await fetch(`${BACKEND_URL}/api/repository/rules`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(rule)
                        });
                        created++;
                    } catch (error) {
                        console.error(`Error creating rule for ${type.type_id}:`, error);
                    }
                }
                
                alert(`Creadas ${created} reglas generales`);
                loadPlataformas();
            } catch (error) {
                alert(`Error al crear configuraci√≥n general: ${error.message}`);
            }
        }
        
        function fixCoordRule(coordLabel) {
            // TODO: Implement coord-specific rule creation
            alert(`Crear regla espec√≠fica para ${coordLabel} - En desarrollo`);
        }
        
        // Cat√°logo v4 - Gesti√≥n de tipos de documento
        let catalogTypes = [];
        let catalogFilters = {
            query: '',
            period: null,
            scope: null,
            active: null,
            sort: 'name',
            page: 1,
            page_size: 20
        };
        let selectedTypes = new Set();
        let editingType = null;
        
        async function loadCatalogo(params = {}) {
            const content = document.getElementById('page-content');
            
            try {
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error al cargar cat√°logo: ${error.message}</div>`;
            }
        }
        
        async function loadCatalogTypes() {
            const params = new URLSearchParams({
                include_inactive: 'true',
                page: catalogFilters.page,
                page_size: catalogFilters.page_size,
                sort: catalogFilters.sort
            });
            
            if (catalogFilters.query) params.append('query', catalogFilters.query);
            if (catalogFilters.period) params.append('period', catalogFilters.period);
            if (catalogFilters.scope) params.append('scope', catalogFilters.scope);
            if (catalogFilters.active !== null) params.append('active', catalogFilters.active.toString());
            
            const response = await fetch(`${BACKEND_URL}/api/repository/types?${params}`);
            const data = await response.json();
            
            // Handle both paginated and non-paginated responses
            if (data.items) {
                catalogTypes = data.items;
                window.catalogTotal = data.total;
            } else {
                catalogTypes = Array.isArray(data) ? data : [];
                window.catalogTotal = catalogTypes.length;
            }
        }
        
        function renderCatalog() {
            const content = document.getElementById('page-content');
            
            content.innerHTML = `
                <div class="catalog-toolbar">
                    <div>
                        <h2 style="display: inline; margin-right: 16px;">Cat√°logo de documentos</h2>
                        <span class="catalog-results-info" id="catalog-results-info">
                            Mostrando ${catalogTypes.length} de ${window.catalogTotal || catalogTypes.length}
                        </span>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportCatalogSelection()" ${selectedTypes.size === 0 ? 'disabled' : ''}>
                            Exportar selecci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="importCatalogTypes()">
                            Importar
                        </button>
                        <button class="btn btn-primary" onclick="openCreateTypeDrawer()">
                            + Crear documento
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="catalog-filters">
                        <div class="form-group">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-input" 
                                   id="catalog-search"
                                   placeholder="Buscar por nombre, c√≥digo, o palabras (ej: aut√≥nomos, T205, TC2‚Ä¶)"
                                   value="${catalogFilters.query}"
                                   oninput="debounceSearch(this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Periodicidad</label>
                            <div>
                                <span class="filter-chip ${catalogFilters.period === null ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', null)">Todos</span>
                                <span class="filter-chip ${catalogFilters.period === 'monthly' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'monthly')">Mensual</span>
                                <span class="filter-chip ${catalogFilters.period === 'annual' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'annual')">Anual</span>
                                <span class="filter-chip ${catalogFilters.period === 'quarter' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'quarter')">Trimestral</span>
                                <span class="filter-chip ${catalogFilters.period === 'none' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('period', 'none')">Una vez</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aplica a</label>
                            <div>
                                <span class="filter-chip ${catalogFilters.scope === null ? 'active' : ''}" 
                                      onclick="setCatalogFilter('scope', null)">Todos</span>
                                <span class="filter-chip ${catalogFilters.scope === 'worker' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('scope', 'worker')">Trabajador</span>
                                <span class="filter-chip ${catalogFilters.scope === 'company' ? 'active' : ''}" 
                                      onclick="setCatalogFilter('scope', 'company')">Empresa</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <div>
                                <span class="filter-chip ${catalogFilters.active === null ? 'active' : ''}" 
                                      onclick="setCatalogFilter('active', null)">Todos</span>
                                <span class="filter-chip ${catalogFilters.active === true ? 'active' : ''}" 
                                      onclick="setCatalogFilter('active', true)">Activos</span>
                                <span class="filter-chip ${catalogFilters.active === false ? 'active' : ''}" 
                                      onclick="setCatalogFilter('active', false)">Inactivos</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ordenar por</label>
                            <select class="form-input" id="catalog-sort" onchange="setCatalogFilter('sort', this.value)">
                                <option value="name" ${catalogFilters.sort === 'name' ? 'selected' : ''}>Nombre A‚ÜíZ</option>
                                <option value="type_id" ${catalogFilters.sort === 'type_id' ? 'selected' : ''}>C√≥digo</option>
                                <option value="period" ${catalogFilters.sort === 'period' ? 'selected' : ''}>Periodicidad</option>
                                <option value="relevance" ${catalogFilters.sort === 'relevance' ? 'selected' : ''}>Relevancia</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-secondary" onclick="clearCatalogFilters()">Limpiar filtros</button>
                    </div>
                    
                    ${selectedTypes.size > 0 ? `
                        <div class="alert alert-info" style="margin-bottom: 16px;">
                            ${selectedTypes.size} tipo(s) seleccionado(s)
                            <button class="btn btn-secondary" onclick="bulkActivateTypes()" style="margin-left: 12px;">Activar</button>
                            <button class="btn btn-secondary" onclick="bulkDeactivateTypes()" style="margin-left: 8px;">Desactivar</button>
                            <button class="btn btn-secondary" onclick="bulkExportTypes()" style="margin-left: 8px;">Exportar</button>
                        </div>
                    ` : ''}
                    
                    <div class="table-container" style="max-height: calc(100vh - 450px); overflow-y: auto;">
                        <table class="catalog-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">
                                        <input type="checkbox" 
                                               onchange="toggleSelectAllTypes(this.checked)"
                                               ${selectedTypes.size === catalogTypes.length && catalogTypes.length > 0 ? 'checked' : ''}>
                                    </th>
                                    <th>Documento</th>
                                    <th>Cada cu√°nto</th>
                                    <th>Aplica a</th>
                                    <th>Activo</th>
                                    <th>C√≥mo suele llamarse</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${catalogTypes.map(type => {
                                    const periodMode = type.validity_policy?.mode || 'fixed_end_date';
                                    const periodLabel = periodMode === 'monthly' ? 'Mensual' : 
                                                       periodMode === 'annual' ? 'Anual' : 'Una vez';
                                    const scopeLabel = type.scope === 'worker' ? 'Trabajador' : 'Empresa';
                                    const aliases = type.platform_aliases || [];
                                    const aliasesDisplay = aliases.slice(0, 3);
                                    const moreAliases = aliases.length > 3 ? aliases.length - 3 : 0;
                                    
                                    return `
                                        <tr ${!type.active ? 'style="opacity: 0.6;"' : ''}>
                                            <td class="checkbox-cell">
                                                <input type="checkbox" 
                                                       onchange="toggleSelectType('${type.type_id}', this.checked)"
                                                       ${selectedTypes.has(type.type_id) ? 'checked' : ''}>
                                            </td>
                                            <td>
                                                <strong>${type.name}</strong>
                                                <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">
                                                    ${type.type_id}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">${periodLabel}</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">${scopeLabel}</span>
                                            </td>
                                            <td>
                                                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                                    <input type="checkbox" 
                                                           ${type.active ? 'checked' : ''}
                                                           onchange="toggleTypeActive('${type.type_id}', this.checked)"
                                                           style="margin-right: 8px;">
                                                    ${type.active ? 'Activo' : 'Inactivo'}
                                                </label>
                                            </td>
                                            <td>
                                                ${aliasesDisplay.map(a => `<span class="badge badge-secondary" style="margin-right: 4px;">${a}</span>`).join('')}
                                                ${moreAliases > 0 ? `<span class="badge badge-secondary">+${moreAliases}</span>` : ''}
                                                ${aliases.length === 0 ? '<span style="color: #94a3b8;">-</span>' : ''}
                                            </td>
                                            <td>
                                                <div class="action-menu">
                                                    <button class="action-menu-button" onclick="toggleActionMenu('${type.type_id}')">‚ãØ</button>
                                                    <div class="action-menu-dropdown hidden" id="action-menu-${type.type_id}">
                                                        <div class="action-menu-item" onclick="editType('${type.type_id}')">Editar</div>
                                                        <div class="action-menu-item" onclick="duplicateType('${type.type_id}')">Duplicar</div>
                                                        <div class="action-menu-item" onclick="viewTypeCalendar('${type.type_id}')">Ver calendario</div>
                                                        <div class="action-menu-item" onclick="uploadTypeDocument('${type.type_id}')">Subir documento</div>
                                                        <div class="action-menu-item" onclick="viewTypeRules('${type.type_id}')">Ver reglas</div>
                                                        <div class="action-menu-item" onclick="toggleTypeActive('${type.type_id}', ${!type.active})">
                                                            ${type.active ? 'Desactivar' : 'Activar'}
                                                        </div>
                                                        <div class="action-menu-item danger" onclick="deleteType('${type.type_id}')">Borrar</div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${window.catalogTotal > catalogFilters.page_size ? `
                        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 8px;">
                            <button class="btn btn-secondary" 
                                    onclick="setCatalogPage(${catalogFilters.page - 1})"
                                    ${catalogFilters.page <= 1 ? 'disabled' : ''}>
                                Anterior
                            </button>
                            <span style="padding: 10px 16px; color: #94a3b8;">
                                P√°gina ${catalogFilters.page} de ${Math.ceil((window.catalogTotal || catalogTypes.length) / catalogFilters.page_size)}
                            </span>
                            <button class="btn btn-secondary" 
                                    onclick="setCatalogPage(${catalogFilters.page + 1})"
                                    ${catalogFilters.page >= Math.ceil((window.catalogTotal || catalogTypes.length) / catalogFilters.page_size) ? 'disabled' : ''}>
                                Siguiente
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Drawer para crear/editar tipo -->
                <div class="drawer" id="type-drawer">
                    <div class="drawer-header">
                        <h3 id="drawer-title">Crear documento</h3>
                        <button class="btn btn-secondary" onclick="closeTypeDrawer()" style="padding: 4px 12px;">‚úï</button>
                    </div>
                    <div class="drawer-body" id="drawer-body">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <div class="drawer-footer">
                        <button class="btn btn-secondary" onclick="closeTypeDrawer()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveType()">Guardar</button>
                        <button class="btn btn-primary" onclick="saveTypeAndViewCalendar()">Guardar y ver calendario</button>
                    </div>
                </div>
            `;
            
            updateCatalogResultsInfo();
        }
        
        function updateCatalogResultsInfo() {
            const info = document.getElementById('catalog-results-info');
            if (info) {
                info.textContent = `Mostrando ${catalogTypes.length} de ${window.catalogTotal || catalogTypes.length}`;
            }
        }
        
        let searchTimeout;
        function debounceSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                catalogFilters.query = query;
                catalogFilters.page = 1;
                loadCatalogTypes().then(() => renderCatalog());
            }, 300);
        }
        
        function setCatalogFilter(key, value) {
            catalogFilters[key] = value;
            catalogFilters.page = 1;
            loadCatalogTypes().then(() => renderCatalog());
        }
        
        function setCatalogPage(page) {
            catalogFilters.page = page;
            loadCatalogTypes().then(() => renderCatalog());
        }
        
        function clearCatalogFilters() {
            catalogFilters = {
                query: '',
                period: null,
                scope: null,
                active: null,
                sort: 'name',
                page: 1,
                page_size: 20
            };
            document.getElementById('catalog-search').value = '';
            loadCatalogTypes().then(() => renderCatalog());
        }
        
        function toggleSelectAllTypes(checked) {
            if (checked) {
                catalogTypes.forEach(t => selectedTypes.add(t.type_id));
            } else {
                selectedTypes.clear();
            }
            renderCatalog();
        }
        
        function toggleSelectType(typeId, checked) {
            if (checked) {
                selectedTypes.add(typeId);
            } else {
                selectedTypes.delete(typeId);
            }
            renderCatalog();
        }
        
        function toggleActionMenu(typeId) {
            const menus = document.querySelectorAll('.action-menu-dropdown');
            menus.forEach(m => m.classList.add('hidden'));
            const menu = document.getElementById(`action-menu-${typeId}`);
            const button = document.querySelector(`button[onclick="toggleActionMenu('${typeId}')"]`);
            
            if (menu && button) {
                const isHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                
                if (!isHidden) {
                    // Calcular posici√≥n del men√∫ para que quepa en el viewport
                    const buttonRect = button.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;
                    
                    // Posici√≥n vertical: abajo por defecto, arriba si no cabe
                    let top = buttonRect.bottom + 4;
                    const estimatedMenuHeight = 300; // Altura estimada del men√∫
                    if (top + estimatedMenuHeight > viewportHeight - 10) {
                        top = buttonRect.top - estimatedMenuHeight - 4;
                        // Si tampoco cabe arriba, ajustar al viewport
                        if (top < 10) {
                            top = 10;
                            menu.style.maxHeight = `${viewportHeight - 20}px`;
                        }
                    }
                    
                    // Posici√≥n horizontal: alineado a la derecha del bot√≥n
                    let right = viewportWidth - buttonRect.right;
                    if (right + 200 > viewportWidth) {
                        right = viewportWidth - buttonRect.left;
                        menu.style.left = `${buttonRect.left}px`;
                        menu.style.right = 'auto';
                    } else {
                        menu.style.right = `${right}px`;
                        menu.style.left = 'auto';
                    }
                    
                    menu.style.top = `${top}px`;
                }
            }
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!e.target.closest('.action-menu')) {
                        menus.forEach(m => m.classList.add('hidden'));
                        document.removeEventListener('click', closeMenu);
                    }
                }, { once: true });
            }, 0);
        }
        
        function openCreateTypeDrawer() {
            editingType = null;
            document.getElementById('type-drawer').classList.add('open');
            renderTypeDrawer();
        }
        
        function closeTypeDrawer() {
            document.getElementById('type-drawer').classList.remove('open');
            editingType = null;
        }
        
        function editType(typeId) {
            editingType = catalogTypes.find(t => t.type_id === typeId);
            if (editingType) {
                document.getElementById('type-drawer').classList.add('open');
                renderTypeDrawer();
            }
        }
        
        function renderTypeDrawer() {
            const isEdit = editingType !== null;
            const type = editingType || {
                type_id: '',
                name: '',
                description: '',
                scope: 'worker',
                validity_policy: {
                    mode: 'monthly',
                    basis: 'name_date',
                    monthly: { month_source: 'name_date', grace_days: 0 }
                },
                platform_aliases: [],
                active: true,
                issue_date_required: true,
                validity_start_mode: 'issue_date',
                allow_late_submission: false,
                late_submission_max_days: null
            };
            
            // BUG 4: Detectar si es "Cada N meses" (tiene n_months pero mode=monthly)
            const hasNMonths = type.validity_policy?.n_months?.n;
            console.log('[repo-upload] renderTypeDrawer - type validity_policy:', {
                mode: type.validity_policy?.mode,
                n_months: type.validity_policy?.n_months,
                hasNMonths: hasNMonths
            });
            const periodMode = hasNMonths ? 'n_months' : (type.validity_policy?.mode || 'monthly');
            const periodBasis = type.validity_policy?.basis || 'name_date';
            const monthlyConfig = type.validity_policy?.monthly || { month_source: 'name_date', grace_days: 0 };
            
            document.getElementById('drawer-title').textContent = isEdit ? 'Editar documento' : 'Crear documento';
            
            document.getElementById('drawer-body').innerHTML = `
                <!-- ID del documento: oculto, se genera autom√°ticamente en el backend -->
                <input type="hidden" id="drawer-type-id" value="${type.type_id}">
                
                <div class="form-group">
                    <label class="form-label">Nombre <span style="color: #ef4444;">*</span></label>
                    <input type="text" class="form-input" 
                           id="drawer-name"
                           value="${type.name}"
                           placeholder="Ej: Recibo de aut√≥nomos"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-input" 
                              id="drawer-description"
                              rows="3"
                              placeholder="Descripci√≥n opcional">${type.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">¬øCada cu√°nto se pide? <span style="color: #ef4444;">*</span></label>
                    <select class="form-input" id="drawer-period-mode" onchange="updatePeriodConfig()">
                        <option value="monthly" ${periodMode === 'monthly' ? 'selected' : ''}>Mensual</option>
                        <option value="n_months" ${periodMode === 'n_months' ? 'selected' : ''}>Cada N meses</option>
                        <option value="annual" ${periodMode === 'annual' ? 'selected' : ''}>Anual</option>
                        <option value="fixed_end_date" ${periodMode === 'fixed_end_date' ? 'selected' : ''}>Una vez</option>
                    </select>
                </div>
                
                <div class="form-group" id="n-months-config-group" style="${periodMode !== 'n_months' ? 'display: none;' : ''}">
                    <label class="form-label">Cada cu√°ntos meses <span style="color: #ef4444;">*</span></label>
                    <input type="number" class="form-input" 
                           id="drawer-n-months"
                           value="${hasNMonths ? hasNMonths : (type.validity_policy?.n_months?.n || 1)}"
                           min="1" max="120"
                           placeholder="N√∫mero de meses"
                           required>
                    <div class="form-help">Cada cu√°ntos meses se debe presentar este documento (ej: 2 = cada 2 meses, 3 = cada 3 meses)</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">¬øA qui√©n aplica? <span style="color: #ef4444;">*</span></label>
                    <select class="form-input" id="drawer-scope">
                        <option value="worker" ${type.scope === 'worker' ? 'selected' : ''}>Trabajador</option>
                        <option value="company" ${type.scope === 'company' ? 'selected' : ''}>Empresa</option>
                    </select>
                </div>
                
                <div class="form-group" id="period-config-group">
                    <label class="form-label">C√≥mo se calcula el periodo</label>
                    <select class="form-input" id="drawer-period-basis">
                        <option value="name_date" ${periodBasis === 'name_date' ? 'selected' : ''}>Desde nombre</option>
                        <option value="issue_date" ${periodBasis === 'issue_date' ? 'selected' : ''}>Fecha de emisi√≥n</option>
                        <option value="manual" ${periodBasis === 'manual' ? 'selected' : ''}>Manual</option>
                    </select>
                </div>
                
                <div class="form-group" id="monthly-config-group" style="${periodMode !== 'monthly' ? 'display: none;' : ''}">
                    <label class="form-label">Qu√© mes cuenta</label>
                    <select class="form-input" id="drawer-month-source">
                        <option value="name_date" ${monthlyConfig.month_source === 'name_date' ? 'selected' : ''}>Fecha nombre</option>
                        <option value="issue_date" ${monthlyConfig.month_source === 'issue_date' ? 'selected' : ''}>Fecha emisi√≥n</option>
                    </select>
                    <label class="form-label" style="margin-top: 12px;">D√≠as de margen</label>
                    <input type="number" class="form-input" 
                           id="drawer-grace-days"
                           value="${monthlyConfig.grace_days || 0}"
                           min="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fecha de expedici√≥n obligatoria</label>
                    <label style="display: inline-flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               id="drawer-issue-date-required"
                               ${type.issue_date_required !== false ? 'checked' : ''}
                               style="margin-right: 8px;">
                        La fecha de emisi√≥n es obligatoria al subir documentos de este tipo
                    </label>
                    <div class="form-help">Si est√° activado, el usuario debe proporcionar la fecha de emisi√≥n al subir documentos de este tipo</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fecha de inicio de vigencia</label>
                    <select class="form-input" id="drawer-validity-start-mode">
                        <option value="issue_date" ${(type.validity_start_mode || 'issue_date') === 'issue_date' ? 'selected' : ''}>Igual a la fecha de emisi√≥n</option>
                        <option value="manual" ${type.validity_start_mode === 'manual' ? 'selected' : ''}>Se introduce al subir el documento</option>
                    </select>
                    <div class="form-help">C√≥mo se determina la fecha de inicio de vigencia. Si es "manual", el usuario debe introducirla al subir cada documento.</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Permitir env√≠o tard√≠o</label>
                    <label style="display: inline-flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               id="drawer-allow-late"
                               ${type.allow_late_submission ? 'checked' : ''}
                               style="margin-right: 8px;">
                        Permitir env√≠o despu√©s de la fecha l√≠mite
                    </label>
                </div>
                
                <div class="form-group" id="late-days-group" style="${!type.allow_late_submission ? 'display: none;' : ''}">
                    <label class="form-label">M√°ximo d√≠as tarde</label>
                    <input type="number" class="form-input" 
                           id="drawer-late-days"
                           value="${type.late_submission_max_days || ''}"
                           min="0"
                           placeholder="Si vac√≠o, usa d√≠as de margen">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Activo</label>
                    <label style="display: inline-flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               id="drawer-active"
                               ${type.active !== false ? 'checked' : ''}
                               style="margin-right: 8px;">
                        Tipo activo (visible y usable)
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">C√≥mo suele llamarse (para reconocerlo)</label>
                    <div class="chip-editor" id="aliases-editor">
                        ${(type.platform_aliases || []).map(alias => `
                            <span class="chip">
                                ${alias}
                                <span class="chip-remove" onclick="removeAlias('${alias}')">√ó</span>
                            </span>
                        `).join('')}
                    </div>
                    <div style="margin-top: 8px;">
                        <input type="text" 
                               class="form-input" 
                               id="alias-input"
                               placeholder="Escribe un alias y presiona Enter"
                               onkeypress="if(event.key==='Enter') { event.preventDefault(); addAlias(); }">
                        <button class="btn btn-secondary" onclick="addAlias()" style="margin-top: 8px;">+ A√±adir ejemplo</button>
                    </div>
                    <div class="form-help">Cada alias ayuda a reconocer este documento en plataformas externas</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ejemplo de nombre de archivo (opcional)</label>
                    <input type="text" class="form-input" 
                           id="drawer-filename-example"
                           placeholder="Ej: autonomos_2023-05.pdf">
                    <div class="form-help">Ayuda a la autodetecci√≥n al subir documentos</div>
                </div>
            `;
            
            // Setup alias management
            window.currentAliases = [...(type.platform_aliases || [])];
        }
        
        function updatePeriodConfig() {
            const mode = document.getElementById('drawer-period-mode').value;
            const monthlyGroup = document.getElementById('monthly-config-group');
            const nMonthsGroup = document.getElementById('n-months-config-group');
            if (monthlyGroup) {
                monthlyGroup.style.display = mode === 'monthly' ? 'block' : 'none';
            }
            if (nMonthsGroup) {
                nMonthsGroup.style.display = mode === 'n_months' ? 'block' : 'none';
            }
        }
        
        function addAlias() {
            const input = document.getElementById('alias-input');
            const alias = input.value.trim();
            if (alias && !window.currentAliases.includes(alias)) {
                window.currentAliases.push(alias);
                input.value = '';
                renderAliases();
            }
        }
        
        function removeAlias(alias) {
            window.currentAliases = window.currentAliases.filter(a => a !== alias);
            renderAliases();
        }
        
        function renderAliases() {
            const editor = document.getElementById('aliases-editor');
            if (editor) {
                editor.innerHTML = window.currentAliases.map(alias => `
                    <span class="chip">
                        ${alias}
                        <span class="chip-remove" onclick="removeAlias('${alias}')">√ó</span>
                    </span>
                `).join('');
            }
        }
        
        async function saveType() {
            const typeIdInput = document.getElementById('drawer-type-id');
            const typeId = typeIdInput ? typeIdInput.value.trim().toUpperCase() : '';
            const name = document.getElementById('drawer-name').value.trim();
            const description = document.getElementById('drawer-description').value.trim();
            const scope = document.getElementById('drawer-scope').value;
            const periodMode = document.getElementById('drawer-period-mode').value;
            const periodBasis = document.getElementById('drawer-period-basis').value;
            const monthSource = document.getElementById('drawer-month-source').value;
            const graceDays = parseInt(document.getElementById('drawer-grace-days').value) || 0;
            const nMonths = periodMode === 'n_months' ? (parseInt(document.getElementById('drawer-n-months').value) || 1) : null;
            const issueDateRequired = document.getElementById('drawer-issue-date-required').checked;
            const validityStartMode = document.getElementById('drawer-validity-start-mode').value || 'issue_date';
            const allowLate = document.getElementById('drawer-allow-late').checked;
            const lateDays = document.getElementById('drawer-late-days').value ? parseInt(document.getElementById('drawer-late-days').value) : null;
            const active = document.getElementById('drawer-active').checked;
            const aliases = window.currentAliases.filter(a => a.trim()).map(a => a.trim());
            
            // Validaci√≥n: solo nombre es obligatorio (type_id se genera autom√°ticamente al crear)
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }
            
            // Al editar, usar el type_id del objeto editingType
            const finalTypeId = editingType ? editingType.type_id : (typeId || '');
            
            // Al editar, validar que el type_id existe
            if (editingType && !finalTypeId) {
                alert('Error: no se puede editar un tipo sin ID');
                return;
            }
            
            const validityPolicy = {
                mode: periodMode,
                basis: periodBasis
            };
            
            if (periodMode === 'monthly') {
                validityPolicy.monthly = {
                    month_source: monthSource,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: graceDays
                };
            } else if (periodMode === 'n_months') {
                // BUG 4: Para "Cada N meses", usar mode='monthly' (compatible) y a√±adir n_months
                validityPolicy.mode = 'monthly'; // Compatible con backend enum
                validityPolicy.monthly = {
                    month_source: monthSource,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: graceDays
                };
                // A√±adir n_months como override
                validityPolicy.n_months = {
                    n: nMonths,
                    month_source: monthSource,
                    valid_from: 'period_start',
                    valid_to: 'period_end',
                    grace_days: graceDays
                };
            } else if (periodMode === 'annual') {
                validityPolicy.annual = {
                    months: 12,
                    valid_from: 'issue_date',
                    valid_to: 'issue_date_plus_months'
                };
            } else {
                validityPolicy.fixed_end_date = {
                    valid_from: 'issue_date',
                    valid_to: 'manual_end_date'
                };
            }
            
            // Al crear, enviar type_id vac√≠o para que el backend lo genere
            const typeData = {
                type_id: finalTypeId || '',  // Vac√≠o al crear, el backend lo generar√°
                name: name,
                description: description,
                scope: scope,
                validity_policy: validityPolicy,
                platform_aliases: aliases,
                active: active,
                issue_date_required: issueDateRequired,
                validity_start_mode: validityStartMode,
                allow_late_submission: allowLate,
                late_submission_max_days: lateDays,
                required_fields: []
            };
            
            try {
                const url = editingType 
                    ? `${BACKEND_URL}/api/repository/types/${finalTypeId}`
                    : `${BACKEND_URL}/api/repository/types`;
                const method = editingType ? 'PUT' : 'POST';
                
                console.log('[repo-upload] saveType - sending:', {
                    periodMode,
                    nMonths,
                    validityPolicy: JSON.stringify(validityPolicy, null, 2)
                });
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(typeData)
                });
                
                console.log('[repo-upload] saveType - response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                const savedType = await response.json();
                console.log('[repo-upload] saveType - saved type:', {
                    type_id: savedType.type_id,
                    validity_policy: savedType.validity_policy
                });
                
                closeTypeDrawer();
                await loadCatalogTypes();
                renderCatalog();
                
                // Si se cre√≥ un nuevo tipo, mostrar el ID generado
                if (!editingType && savedType.type_id) {
                    console.log(`Tipo creado con ID: ${savedType.type_id}`);
                }
            } catch (error) {
                alert(`Error al guardar: ${error.message}`);
            }
        }
        
        async function saveTypeAndViewCalendar() {
            await saveType();
            // Obtener el type_id del tipo guardado (puede ser el generado por el backend)
            if (editingType && editingType.type_id) {
                navigateTo('calendario');
                setTimeout(() => {
                    selectCalendarType(editingType.type_id);
                }, 500);
            } else {
                // Si se cre√≥ un nuevo tipo, recargar el cat√°logo y buscar el √∫ltimo tipo creado
                await loadCatalogTypes();
                const lastType = catalogTypes[catalogTypes.length - 1];
                if (lastType) {
                    navigateTo('calendario');
                    setTimeout(() => {
                        selectCalendarType(lastType.type_id);
                }, 500);
                }
            }
        }
        
        async function duplicateType(typeId) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) return;
            
            const newId = prompt('Nuevo ID para el tipo duplicado:', `${typeId}_COPY`);
            if (!newId || !/^[A-Z0-9_]+$/.test(newId.toUpperCase())) {
                alert('ID inv√°lido');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}/duplicate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_type_id: newId.toUpperCase() })
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                alert(`Error al duplicar: ${error.message}`);
            }
        }
        
        async function toggleTypeActive(typeId, active) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) return;
            
            type.active = active;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(type)
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                alert(`Error al actualizar: ${error.message}`);
            }
        }
        
        async function deleteType(typeId) {
            // Check if type has documents
            try {
                const docsResponse = await fetch(`${BACKEND_URL}/api/repository/docs?type_id=${typeId}`);
                const docs = await docsResponse.json();
                
                if (docs.length > 0) {
                    if (!confirm(`Este tipo tiene ${docs.length} documento(s) asociado(s). No se puede borrar. ¬øDeseas desactivarlo en su lugar?`)) {
                        return;
                    }
                    await toggleTypeActive(typeId, false);
                    return;
                }
            } catch (error) {
                console.error('Error checking documents:', error);
            }
            
            if (!confirm(`¬øBorrar el tipo "${typeId}"? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/types/${typeId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await loadCatalogTypes();
                renderCatalog();
            } catch (error) {
                alert(`Error al borrar: ${error.message}`);
            }
        }
        
        function viewTypeCalendar(typeId) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) {
                alert(`Tipo ${typeId} no encontrado`);
                return;
            }
            navigateTo('calendario', { type_id: typeId, scope: type.scope });
        }
        
        function uploadTypeDocument(typeId) {
            const type = catalogTypes.find(t => t.type_id === typeId);
            if (!type) {
                alert(`Tipo ${typeId} no encontrado`);
                return;
            }
            navigateTo('subir', { type_id: typeId, scope: type.scope });
        }
        
        function viewTypeRules(typeId) {
            navigateTo('plataformas');
            // TODO: Filtrar por tipo si existe filtro en plataformas
        }
        
        function bulkActivateTypes() {
            selectedTypes.forEach(typeId => {
                toggleTypeActive(typeId, true);
            });
            selectedTypes.clear();
        }
        
        function bulkDeactivateTypes() {
            selectedTypes.forEach(typeId => {
                toggleTypeActive(typeId, false);
            });
            selectedTypes.clear();
        }
        
        function bulkExportTypes() {
            const selected = catalogTypes.filter(t => selectedTypes.has(t.type_id));
            const json = JSON.stringify(selected, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `catalog_types_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCatalogSelection() {
            bulkExportTypes();
        }
        
        function importCatalogTypes() {
            alert('Importar tipos - En desarrollo (v1 stub)');
        }
        
        // ========== CONFIGURACI√ìN ==========
        
        let repositorySettings = null;
        
        async function loadConfiguracion() {
            const content = document.getElementById('page-content');
            
            if (!content) {
                throw new Error('page-content element not found');
            }
            
            // SPRINT C2.1: Cargar configuraci√≥n con manejo de errores robusto
            // No bloquear el render si falla el fetch, pero mostrar mensaje
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/settings`);
                if (response.ok) {
                    repositorySettings = await response.json();
                } else {
                    // Si es 404, usar valores por defecto (no es cr√≠tico)
                    if (response.status === 404) {
                        console.warn('[config] Settings endpoint not found (404), using defaults');
                        repositorySettings = { repository_root_dir: '' };
                    } else {
                        // Otros errores pueden ser cr√≠ticos, pero a√∫n as√≠ continuar
                        console.warn('[config] Failed to load settings:', response.status);
                        repositorySettings = { repository_root_dir: '' };
                    }
                }
            } catch (error) {
                // Error de red o fetch fallido - no cr√≠tico, continuar con valores por defecto
                console.error('[config] Error loading settings:', error);
                repositorySettings = { repository_root_dir: '' };
                // No re-lanzar el error - permitir que el formulario se renderice con valores por defecto
                // Pero mostrar mensaje de advertencia si es un error cr√≠tico
                if (error.message && !error.message.includes('404')) {
                    // Solo mostrar error si no es 404 (que es esperado si el endpoint no existe a√∫n)
                    console.warn('[config] Non-404 error loading settings, will render with defaults');
                }
            }
            
            // Renderizar siempre, incluso si fall√≥ el fetch
            content.innerHTML = `
                <div class="card" data-testid="configuracion-view">
                    <h3>Configuraci√≥n del Repositorio</h3>
                    <p style="color: #94a3b8; margin-bottom: 24px;">
                        Configura la ruta en el servidor donde se guardan los documentos subidos.
                        <strong>Nota:</strong> Esta ruta es del servidor donde corre CometLocal (tu PC).
                    </p>
                    
                    <div class="form-group" data-testid="configuracion-settings">
                        <label class="form-label">Ruta del repositorio</label>
                        <input type="text" 
                               class="form-input" 
                               id="config-repository-root"
                               value="${repositorySettings?.repository_root_dir || ''}"
                               placeholder="D:\\Proyectos\\CometLocal\\data\\repository"
                               style="font-family: monospace; font-size: 0.9rem;">
                        <div class="form-help" style="margin-top: 8px; color: #94a3b8; font-size: 0.875rem;">
                            Ruta absoluta en el servidor donde se guardan los PDFs subidos.
                            <br>Ejemplo Windows: <code>D:\\Proyectos\\CometLocal\\data\\repository</code>
                            <br>Ejemplo Linux: <code>/home/usuario/data/repository</code>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="testRepositoryPath()">
                            Probar ruta
                        </button>
                        <button class="btn btn-primary" data-testid="configuracion-save" onclick="saveRepositorySettings()">
                            Guardar
                        </button>
                    </div>
                    
                    <div id="config-message" style="margin-top: 16px;"></div>
                </div>
            `;
            
            // SPRINT C2.1: A√±adir se√±al cuando el formulario est√° renderizado
            const formInput = document.getElementById('config-repository-root');
            if (formInput) {
                formInput.setAttribute('data-testid', 'settings-ui-ready');
                // Tambi√©n en el contenedor principal para compatibilidad
                const card = content.querySelector('.card');
                if (card) {
                    // SPRINT C2.8: Asegurar que configuracion-view est√° presente (el innerHTML ya lo incluye, pero lo verificamos)
                    card.setAttribute('data-testid', 'configuracion-view');
                    // Mantener tambi√©n settings-ui-ready para compatibilidad
                    card.setAttribute('data-settings-ui-ready', 'true');
                }
            }
        }
        
        async function testRepositoryPath() {
            const input = document.getElementById('config-repository-root');
            const messageDiv = document.getElementById('config-message');
            const path = input.value.trim();
            
            if (!path) {
                messageDiv.innerHTML = '<div class="alert alert-error">Por favor, introduce una ruta.</div>';
                return;
            }
            
            messageDiv.innerHTML = '<div class="alert alert-info">Probando ruta...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/settings?dry_run=true`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        repository_root_dir: path
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    messageDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úì Ruta v√°lida y escribible: ${result.repository_root_dir}
                            <br>El directorio se crear√° autom√°ticamente si no existe.
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    messageDiv.innerHTML = `
                        <div class="alert alert-error">
                            ‚úó Error: ${error.detail || 'Error desconocido'}
                        </div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="alert alert-error">
                        ‚úó Error de conexi√≥n: ${error.message}
                    </div>
                `;
            }
        }
        
        async function saveRepositorySettings() {
            const input = document.getElementById('config-repository-root');
            const messageDiv = document.getElementById('config-message');
            const path = input.value.trim();
            
            if (!path) {
                messageDiv.innerHTML = '<div class="alert alert-error" data-testid="configuracion-error">Por favor, introduce una ruta.</div>';
                return;
            }
            
            messageDiv.innerHTML = '<div class="alert alert-info">Guardando configuraci√≥n...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/repository/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        repository_root_dir: path
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    repositorySettings = result;
                    input.value = result.repository_root_dir; // Actualizar con ruta resuelta
                    messageDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úì Configuraci√≥n guardada correctamente.
                            <br>Ruta configurada: ${result.repository_root_dir}
                            <br><strong>Nota:</strong> Los nuevos documentos se guardar√°n en esta ruta.
                        </div>
                    `;
                    // Asegurar que la vista vuelve a ready despu√©s de guardar exitosamente
                    setViewState('settings', 'ready');
                } else {
                    const error = await response.json();
                    messageDiv.innerHTML = `
                        <div class="alert alert-error" data-testid="configuracion-error">
                            ‚úó Error al guardar: ${error.detail || 'Error desconocido'}
                        </div>
                    `;
                    setViewState('settings', 'error', error.detail || 'Error desconocido');
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="alert alert-error" data-testid="configuracion-error">
                        ‚úó Error de conexi√≥n: ${error.message}
                    </div>
                `;
                setViewState('settings', 'error', error.message);
            }
        }
        
        async function loadActividad(params = {}) {
            document.getElementById('page-content').innerHTML = '<div class="card"><h3>Actividad</h3><p>En desarrollo...</p></div>';
        }
        
        // Initialize
        // Initial page load - only if no hash is present
        // Initial page load - only if no hash is present (handled by initHashRouting)
        // This is a fallback for cases where initHashRouting doesn't run
        // Event delegation para selects de tipo en upload
        // UN SOLO listener global que maneja todos los selects
        (function() {
            console.log('[repo-upload] listener installed', { time: Date.now() });
            window.__REPO_UPLOAD_LISTENER_INSTALLED = true;
            window.__REPO_UPLOAD_LAST_CHANGE = null;
            window.__REPO_UPLOAD_LAST_SELECT_DEBUG = null;
            
            document.addEventListener('change', (ev) => {
                // Log SIEMPRE antes de cualquier return
                const debugInfo = {
                    targetTag: ev.target?.tagName,
                    hasClass: ev.target?.classList?.contains('repo-upload-type-select'),
                    fileIdAttr: ev.target?.getAttribute?.('data-upload-file-id'),
                    time: Date.now()
                };
                console.log('[repo-upload] change captured', debugInfo);
                window.__REPO_UPLOAD_LAST_CHANGE = debugInfo;
                
                const sel = ev.target;
                if (!(sel instanceof HTMLSelectElement)) return;
                if (!sel.classList.contains('repo-upload-type-select')) return;

                const fileId = sel.getAttribute('data-upload-file-id');
                if (!fileId) {
                    console.warn('[repo-upload] select without data-upload-file-id');
                    return;
                }

                // Buscar el archivo - convertir ambos a string para comparaci√≥n
                // IMPORTANTE: uploadFiles puede ser un array global, verificar que existe
                if (!uploadFiles || !Array.isArray(uploadFiles)) {
                    console.error('[repo-upload] uploadFiles is not an array', {
                        uploadFiles,
                        type: typeof uploadFiles,
                        fileId
                    });
                    return;
                }
                
                const file = uploadFiles.find(f => {
                    if (!f || f.id === undefined) return false;
                    const fId = String(f.id);
                    const searchId = String(fileId);
                    const match = fId === searchId;
                    if (match) {
                        console.log('[repo-upload] file found', {
                            fileId: f.id,
                            fileName: f.name,
                            searchId: fileId
                        });
                    }
                    return match;
                });
                if (!file) {
                    const allIds = uploadFiles.map(f => ({ 
                        id: f.id, 
                        idType: typeof f.id, 
                        idString: String(f.id),
                        name: f.name
                    }));
                    console.error('[repo-upload] file not found for select', {
                        fileId,
                        fileIdType: typeof fileId,
                        fileIdString: String(fileId),
                        uploadFilesType: typeof uploadFiles,
                        uploadFilesLength: uploadFiles.length,
                        uploadFilesIds: allIds,
                        comparison: allIds.map(f => ({
                            original: f.idString,
                            search: String(fileId),
                            match: f.idString === String(fileId),
                            exactMatch: f.id === fileId,
                            looseMatch: f.id == fileId
                        }))
                    });
                    return;
                }

                const opt = sel.options[sel.selectedIndex];
                const selectDebug = {
                    fileId,
                    value: sel.value,
                    selectedIndex: sel.selectedIndex,
                    optionValue: opt?.value,
                    optionText: opt?.text,
                    uploadFilesType: typeof uploadFiles,
                    uploadFilesLength: uploadFiles?.length,
                    uploadTypesType: typeof uploadTypes,
                    uploadTypesLength: uploadTypes?.length,
                    time: Date.now()
                };
                console.log('[repo-upload] select debug', selectDebug);
                window.__REPO_UPLOAD_LAST_SELECT_DEBUG = selectDebug;

                // Fail-fast: si value est√° vac√≠o, error inmediato
                if (!sel.value || sel.value.trim() === '') {
                    file.type_id = null;
                    file._last_dom_value = '';
                    if (!file.errors) file.errors = [];
                    if (!file.errors.includes('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.')) {
                        file.errors.push('Tipo inv√°lido (value vac√≠o). Revisa IDs de tipos.');
                    }
                    renderUploadFiles();
                    return;
                }

                // Guardar dom_value para debug
                file._last_dom_value = sel.value || '';
                updateUploadFileType(fileId, sel.value);
            });
        })();

        // Initialize version stamp timestamp
        document.addEventListener('DOMContentLoaded', () => {
            const timestampEl = document.getElementById('build-timestamp');
            if (timestampEl) {
                const now = new Date();
                timestampEl.textContent = now.toISOString().slice(0, 19).replace('T', ' ');
            }
            
            const { route } = parseHashRoute();
            if (!route && (!window.location.hash || window.location.hash === '#')) {
                dbg('No hash found, loading inicio as fallback');
                loadInicio().catch(error => {
                    console.error('[repo] Error in initial loadInicio:', error);
                    showErrorBanner(`Error al cargar inicio inicial: ${error.message}`, error);
                });
            }
            // Hash routing initialization is handled by initHashRouting() above
        });
        
        // Error handlers globales para evitar "Cargando..." infinito
        window.addEventListener('error', (event) => {
            console.error('[repo] Global error:', event.error);
            const content = document.getElementById('page-content');
            if (content && content.innerHTML.includes('Cargando...')) {
                showErrorBanner(`Error de JavaScript: ${event.error?.message || event.message}`, event.error);
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('[repo] Unhandled promise rejection:', event.reason);
            const content = document.getElementById('page-content');
            if (content && content.innerHTML.includes('Cargando...')) {
                const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));
                showErrorBanner(`Promesa rechazada sin manejar: ${error.message}`, error);
            }
        });
        
        // ========== CAE Plan Modal ==========
        
        let caePlanModalOpen = false;
        let caePlanPlatforms = [];
        
        async function openCAEPlanModal() {
            caePlanModalOpen = true;
            
            // Cargar plataformas
            try {
                const platformsRes = await fetch(`${BACKEND_URL}/api/config/platforms`).catch(() => null);
                if (platformsRes && platformsRes.ok) {
                    const platformsData = await platformsRes.json();
                    caePlanPlatforms = platformsData.platforms || [];
                } else {
                    // Fallback: hardcode m√≠nimo con egestiona
                    caePlanPlatforms = [{ key: 'egestiona', label: 'eGestiona' }];
                }
            } catch (e) {
                caePlanPlatforms = [{ key: 'egestiona', label: 'eGestiona' }];
            }
            
            // Obtener tipos visibles en el calendario
            const visibleTypes = calendarTypes || [];
            
            // Obtener per√≠odos visibles
            const pendingData = window.pendingDocumentsData || { missing: [] };
            const visiblePeriods = [...new Set(pendingData.missing.map(p => p.period_key).filter(Boolean))].sort().reverse();
            
            // Crear modal
            const modal = document.createElement('div');
            modal.id = 'cae-plan-modal';
            modal.setAttribute('data-testid', 'cae-plan-modal');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: #1e293b; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #334155;">
                    <h2 style="margin-bottom: 24px;">Preparar env√≠o CAE (filtrado)</h2>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Plataforma</label>
                        <select id="cae-plan-platform" class="form-input" data-testid="cae-plan-platform">
                            ${caePlanPlatforms.map(p => `
                                <option value="${escapeHtml(p.key)}">${escapeHtml(p.label || p.key)}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Tipo</label>
                        <select id="cae-plan-type-mode" class="form-input" onchange="updateCAEPlanTypeOptions()" data-testid="cae-plan-type-mode">
                            <option value="all">Todos los tipos visibles</option>
                            <option value="filtered">Solo tipo seleccionado en filtro</option>
                            <option value="multi">Multi-select de tipos visibles</option>
                        </select>
                    </div>
                    
                    <div id="cae-plan-type-multi-container" style="display: none; margin-bottom: 16px;">
                        <label class="form-label">Seleccionar tipos</label>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #334155; padding: 8px; border-radius: 4px;">
                            ${visibleTypes.map(type => `
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" class="cae-plan-type-checkbox" value="${escapeHtml(type.type_id)}" data-testid="cae-plan-type-${escapeHtml(type.type_id)}">
                                    ${escapeHtml(type.name)} (${escapeHtml(type.type_id)})
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Sujeto</label>
                        <select id="cae-plan-subject-mode" class="form-input" onchange="updateCAEPlanSubjectOptions()" data-testid="cae-plan-subject-mode">
                            <option value="all">Todos los sujetos visibles</option>
                            <option value="filtered">Solo sujeto seleccionado en filtro</option>
                            <option value="specific">Especificar empresa/trabajador</option>
                        </select>
                    </div>
                    
                    <div id="cae-plan-subject-specific-container" style="display: none; margin-bottom: 16px;">
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">Empresa</label>
                            <input type="text" id="cae-plan-company-key" class="form-input" placeholder="Clave de empresa" data-testid="cae-plan-company-key">
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label class="form-label">Trabajador</label>
                            <input type="text" id="cae-plan-person-key" class="form-input" placeholder="Clave de trabajador (opcional)" data-testid="cae-plan-person-key">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Per√≠odo</label>
                        <select id="cae-plan-period-mode" class="form-input" onchange="updateCAEPlanPeriodOptions()" data-testid="cae-plan-period-mode">
                            <option value="all">Todos los per√≠odos visibles</option>
                            <option value="specific">Especificar per√≠odos</option>
                        </select>
                    </div>
                    
                    <div id="cae-plan-period-specific-container" style="display: none; margin-bottom: 16px;">
                        <label class="form-label">Per√≠odos (separados por comas, ej: 2025-12, 2026-01)</label>
                        <input type="text" id="cae-plan-period-keys" class="form-input" placeholder="2025-12, 2026-01" data-testid="cae-plan-period-keys">
                        <small style="color: #94a3b8; display: block; margin-top: 4px;">Per√≠odos visibles: ${visiblePeriods.slice(0, 10).join(', ')}${visiblePeriods.length > 10 ? '...' : ''}</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Modo</label>
                        <select id="cae-plan-mode" class="form-input" data-testid="cae-plan-mode">
                            <option value="READ_ONLY">READ_ONLY</option>
                            <option value="PREPARE_WRITE">PREPARE_WRITE</option>
                        </select>
                    </div>
                    
                    <div id="cae-plan-result" data-testid="cae-plan-result" style="display: none; margin-bottom: 16px; padding: 16px; background: #0f172a; border-radius: 4px; border: 1px solid #334155;"></div>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeCAEPlanModal()" data-testid="cae-plan-cancel">Cancelar</button>
                        <button class="btn btn-primary" onclick="generateCAEPlan()" data-testid="cae-plan-generate">Generar plan</button>
                    </div>
                    
                    <!-- SPRINT C2.11.1: Pack Export Section (hidden until plan is generated) -->
                    <div id="cae-pack-section" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid #334155;">
                        <h3 style="margin-bottom: 16px;">Exportar Pack CAE (ZIP)</h3>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">Plataforma para pack</label>
                            <select id="cae-pack-platform" class="form-input" data-testid="cae-pack-platform">
                                <option value="generic">Gen√©rica</option>
                                <option value="cetaima">Cetaima</option>
                                <option value="ecoordina">Ecoordina</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateCAEPack()" data-testid="cae-pack-generate-button" style="width: 100%;" disabled>
                            Generar pack (ZIP)
                        </button>
                        <div id="cae-pack-status" style="margin-top: 8px; display: none;"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCAEPlanModal();
                }
            });
        }
        
        function closeCAEPlanModal() {
            const modal = document.getElementById('cae-plan-modal');
            if (modal) {
                modal.remove();
            }
            caePlanModalOpen = false;
        }
        
        function updateCAEPlanTypeOptions() {
            const mode = document.getElementById('cae-plan-type-mode').value;
            const multiContainer = document.getElementById('cae-plan-type-multi-container');
            if (mode === 'multi') {
                multiContainer.style.display = 'block';
            } else {
                multiContainer.style.display = 'none';
            }
        }
        
        function updateCAEPlanSubjectOptions() {
            const mode = document.getElementById('cae-plan-subject-mode').value;
            const specificContainer = document.getElementById('cae-plan-subject-specific-container');
            if (mode === 'specific') {
                specificContainer.style.display = 'block';
            } else {
                specificContainer.style.display = 'none';
            }
        }
        
        function updateCAEPlanPeriodOptions() {
            const mode = document.getElementById('cae-plan-period-mode').value;
            const specificContainer = document.getElementById('cae-plan-period-specific-container');
            if (mode === 'specific') {
                specificContainer.style.display = 'block';
            } else {
                specificContainer.style.display = 'none';
            }
        }
        
        async function generateCAEPlan() {
            const resultDiv = document.getElementById('cae-plan-result');
            const modal = document.getElementById('cae-plan-modal');
            
            // SPRINT C2.9.11: Marker invariante de estado de generaci√≥n
            // Crear/actualizar marker en el modal (estable, no se pisa con innerHTML)
            let stateMarker = modal ? modal.querySelector('[data-testid="cae-plan-generation-state"]') : null;
            if (!stateMarker && modal) {
                stateMarker = document.createElement('div');
                stateMarker.setAttribute('data-testid', 'cae-plan-generation-state');
                stateMarker.style.display = 'none';
                modal.appendChild(stateMarker);
            }
            if (stateMarker) {
                stateMarker.setAttribute('data-state', 'running');
                stateMarker.removeAttribute('data-outcome');
                stateMarker.removeAttribute('data-decision');
                stateMarker.removeAttribute('data-error');
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color: #94a3b8;">Generando plan...</div>';
            
            try {
                // Recopilar scope
                const platformKey = document.getElementById('cae-plan-platform').value;
                const typeMode = document.getElementById('cae-plan-type-mode').value;
                const subjectMode = document.getElementById('cae-plan-subject-mode').value;
                const periodMode = document.getElementById('cae-plan-period-mode').value;
                const mode = document.getElementById('cae-plan-mode').value;
                
                // Resolver type_ids
                let typeIds = [];
                if (typeMode === 'all') {
                    // Todos los tipos visibles
                    typeIds = (calendarTypes || []).map(t => t.type_id);
                } else if (typeMode === 'filtered') {
                    // Solo tipo del filtro
                    if (calendarFilters.type_id) {
                        typeIds = [calendarFilters.type_id];
                    }
                } else if (typeMode === 'multi') {
                    // Multi-select
                    const checkboxes = document.querySelectorAll('.cae-plan-type-checkbox:checked');
                    typeIds = Array.from(checkboxes).map(cb => cb.value);
                }
                
                // Resolver company_key y person_key
                let companyKey = null;
                let personKey = null;
                if (subjectMode === 'filtered') {
                    // Usar filtros actuales
                    if (calendarFilters.subject_key) {
                        // Determinar si es empresa o trabajador
                        const subjectsCache = window.subjectsCache || { companies: {}, people: {} };
                        if (subjectsCache.companies[calendarFilters.subject_key]) {
                            companyKey = calendarFilters.subject_key;
                        } else if (subjectsCache.people[calendarFilters.subject_key]) {
                            personKey = calendarFilters.subject_key;
                            // Necesitamos company_key tambi√©n para trabajadores
                            const pendingData = window.pendingDocumentsData || { missing: [] };
                            const item = pendingData.missing.find(m => m.person_key === calendarFilters.subject_key);
                            if (item) {
                                companyKey = item.company_key;
                            }
                        }
                    }
                } else if (subjectMode === 'specific') {
                    companyKey = document.getElementById('cae-plan-company-key').value.trim() || null;
                    personKey = document.getElementById('cae-plan-person-key').value.trim() || null;
                }
                
                // Resolver period_keys
                let periodKeys = null;
                if (periodMode === 'specific') {
                    const periodKeysInput = document.getElementById('cae-plan-period-keys').value.trim();
                    if (periodKeysInput) {
                        periodKeys = periodKeysInput.split(',').map(p => p.trim()).filter(Boolean);
                    }
                }
                
                // Construir scope
                const scope = {
                    platform_key: platformKey,
                    type_ids: typeIds,
                    company_key: companyKey,
                    person_key: personKey,
                    period_keys: periodKeys,
                    mode: mode,
                };
                
                // Llamar al endpoint
                const response = await fetch(`${BACKEND_URL}/api/cae/plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ scope }),
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${await response.text()}`);
                }
                
                const plan = await response.json();
                
                // Mostrar resultado
                const decisionBadge = plan.decision === 'READY' ? 'badge-success' : 
                                     plan.decision === 'NEEDS_CONFIRMATION' ? 'badge-warning' : 
                                     'badge-error';
                
                // SPRINT C2.7: A√±adir testid y data-decision para determinismo
                resultDiv.innerHTML = `
                    <h3 style="margin-bottom: 8px;">Plan generado: ${escapeHtml(plan.plan_id)}</h3>
                    <div style="margin-bottom: 8px;" data-testid="cae-plan-decision" data-decision="${escapeHtml(plan.decision)}">
                        <span class="badge ${decisionBadge}">${escapeHtml(plan.decision)}</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Resumen:</strong>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>Items pendientes: ${plan.summary.pending_items || 0}</li>
                            <li>Candidatos de documentos: ${plan.summary.docs_candidates || 0}</li>
                            <li>Total items: ${plan.summary.total_items || 0}</li>
                        </ul>
                    </div>
                    ${plan.reasons && plan.reasons.length > 0 ? `
                        <div style="margin-bottom: 8px;">
                            <strong>Razones:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                ${plan.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${plan.decision === 'READY' ? `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
                            <button class="btn btn-primary" onclick="startCAEExecution('${escapeHtml(plan.plan_id)}')" data-testid="cae-execute-button">
                                Ejecutar en eGestiona
                            </button>
                        </div>
                    ` : ''}
                `;
                
                // Guardar plan_id en el modal para uso posterior
                resultDiv.setAttribute('data-plan-id', plan.plan_id);
                
                // SPRINT C2.11.1: Guardar plan completo para pack export
                resultDiv.setAttribute('data-plan-json', JSON.stringify(plan));
                
                // SPRINT C2.11.1: Mostrar secci√≥n de pack siempre que haya un plan generado
                const packSection = document.getElementById('cae-pack-section');
                if (packSection) {
                    packSection.style.display = 'block';
                    
                    // Habilitar/deshabilitar bot√≥n seg√∫n si hay doc_ids disponibles
                    const packButton = document.getElementById('cae-pack-generate-button');
                    const docIds = plan.items
                        .filter(item => item.suggested_doc_id)
                        .map(item => item.suggested_doc_id);
                    
                    if (packButton) {
                        if (docIds.length > 0) {
                            packButton.disabled = false;
                            packButton.textContent = 'Generar pack (ZIP)';
                        } else {
                            packButton.disabled = true;
                            packButton.textContent = 'Generar pack (ZIP) - No hay documentos seleccionados';
                        }
                    }
                }
                
                // SPRINT C2.9.11: Actualizar marker a success
                if (stateMarker) {
                    stateMarker.setAttribute('data-state', 'done');
                    stateMarker.setAttribute('data-outcome', 'success');
                    stateMarker.setAttribute('data-decision', plan.decision || '');
                }
            } catch (error) {
                // SPRINT C2.7: A√±adir testid para errores
                resultDiv.innerHTML = `
                    <div class="alert alert-error" data-testid="cae-plan-error">
                        Error al generar plan: ${escapeHtml(error.message)}
                    </div>
                `;
                
                // SPRINT C2.9.11: Actualizar marker a error
                if (stateMarker) {
                    stateMarker.setAttribute('data-state', 'done');
                    stateMarker.setAttribute('data-outcome', 'error');
                    stateMarker.setAttribute('data-error', error.message || 'Unknown error');
                }
            } finally {
                // SPRINT C2.9.11: Garantizar que el marker nunca se quede en "running"
                if (stateMarker && stateMarker.getAttribute('data-state') === 'running') {
                    stateMarker.setAttribute('data-state', 'done');
                    if (!stateMarker.hasAttribute('data-outcome')) {
                        stateMarker.setAttribute('data-outcome', 'error');
                        stateMarker.setAttribute('data-error', 'Generation was interrupted');
                    }
                }
            }
        }
        
        // SPRINT C2.11.1: Generar pack CAE (ZIP)
        async function generateCAEPack() {
            const resultDiv = document.getElementById('cae-plan-result');
            const packButton = document.getElementById('cae-pack-generate-button');
            const packStatus = document.getElementById('cae-pack-status');
            
            if (!resultDiv) {
                console.error('[repo] No se encontr√≥ el div de resultado del plan');
                return;
            }
            
            // Obtener plan guardado
            const planJson = resultDiv.getAttribute('data-plan-json');
            if (!planJson) {
                packStatus.innerHTML = '<div class="alert alert-error">No hay plan disponible. Genera un plan primero.</div>';
                packStatus.style.display = 'block';
                return;
            }
            
            let plan;
            try {
                plan = JSON.parse(planJson);
            } catch (e) {
                packStatus.innerHTML = '<div class="alert alert-error">Error al parsear el plan guardado.</div>';
                packStatus.style.display = 'block';
                return;
            }
            
            // Obtener plataforma seleccionada
            const platformSelect = document.getElementById('cae-pack-platform');
            const platform = platformSelect ? platformSelect.value : 'generic';
            
            // Extraer doc_ids de los items del plan que tienen suggested_doc_id
            const docIds = plan.items
                .filter(item => item.suggested_doc_id)
                .map(item => item.suggested_doc_id);
            
            if (docIds.length === 0) {
                packStatus.innerHTML = '<div class="alert alert-warning">El plan no contiene documentos seleccionados.</div>';
                packStatus.style.display = 'block';
                return;
            }
            
            // Extraer missing items (items sin suggested_doc_id)
            const missing = plan.items
                .filter(item => !item.suggested_doc_id && item.kind === 'MISSING_PERIOD')
                .map(item => ({
                    type_id: item.type_id,
                    company_key: item.company_key,
                    person_key: item.person_key,
                    period_key: item.period_key
                }));
            
            // Deshabilitar bot√≥n y mostrar estado
            if (packButton) {
                packButton.disabled = true;
                packButton.textContent = 'Generando...';
            }
            packStatus.innerHTML = '<div style="color: #94a3b8;">Generando pack...</div>';
            packStatus.style.display = 'block';
            
            try {
                // Llamar al endpoint
                const response = await fetch(`${BACKEND_URL}/api/repository/cae/pack`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        platform: platform,
                        doc_ids: docIds,
                        missing: missing.length > 0 ? missing : null,
                        meta: {
                            plan_id: plan.plan_id,
                            decision: plan.decision,
                            created_at: plan.created_at
                        }
                    }),
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                // Obtener blob del ZIP
                const blob = await response.blob();
                
                // Crear URL temporal y forzar descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Obtener nombre del archivo del header Content-Disposition
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `CAE_PACK_${platform}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.zip`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Mostrar √©xito
                packStatus.innerHTML = '<div class="alert alert-success">Pack descargado correctamente.</div>';
                
            } catch (error) {
                console.error('[repo] Error al generar pack:', error);
                packStatus.innerHTML = `<div class="alert alert-error">Error al generar pack: ${escapeHtml(error.message)}</div>`;
            } finally {
                if (packButton) {
                    packButton.disabled = false;
                    packButton.textContent = 'Generar pack (ZIP)';
                }
            }
        }
        
        async function startCAEExecution(planId) {
            // Buscar en ambos modales (plan filtrado y selecci√≥n)
            let resultDiv = document.getElementById('cae-plan-result');
            let executeButton = resultDiv ? resultDiv.querySelector('[data-testid="cae-execute-button"]') : null;
            
            if (!resultDiv || !executeButton) {
                // Intentar en el modal de selecci√≥n
                resultDiv = document.getElementById('cae-selection-result');
                executeButton = resultDiv ? resultDiv.querySelector('[data-testid="cae-execute-button"]') : null;
            }
            
            if (!resultDiv) {
                console.error('[repo] No se encontr√≥ el div de resultado para ejecutar el plan');
                return;
            }
            
            if (executeButton) {
                executeButton.disabled = true;
                executeButton.textContent = 'Obteniendo challenge...';
            }
            
            try {
                // 1. Obtener challenge
                const challengeResponse = await fetch(`${BACKEND_URL}/api/cae/execute/${planId}/challenge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                });
                
                if (!challengeResponse.ok) {
                    throw new Error(`Error ${challengeResponse.status}: ${await challengeResponse.text()}`);
                }
                
                const challenge = await challengeResponse.json();
                
                // 2. Mostrar challenge y pedir confirmaci√≥n
                const challengeDiv = document.createElement('div');
                challengeDiv.style.marginTop = '16px';
                challengeDiv.style.padding = '16px';
                challengeDiv.style.background = '#1e293b';
                challengeDiv.style.borderRadius = '4px';
                challengeDiv.style.border = '1px solid #334155';
                challengeDiv.innerHTML = `
                    <h4 style="margin-bottom: 8px;">Confirmar ejecuci√≥n</h4>
                    <p style="margin-bottom: 8px; color: #94a3b8;">${escapeHtml(challenge.prompt)}</p>
                    <div style="margin-bottom: 8px;">
                        <label for="cae-challenge-response" style="display: block; margin-bottom: 4px;">Escribe la respuesta exacta:</label>
                        <input type="text" id="cae-challenge-response" class="form-input" placeholder="${escapeHtml(challenge.prompt)}" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="cae-dry-run" checked>
                            <span>Dry run (simulaci√≥n, no ejecuta realmente)</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="confirmCAEExecution('${escapeHtml(planId)}', '${escapeHtml(challenge.challenge_token)}')" data-testid="cae-confirm-execute-button">
                            Confirmar y Ejecutar
                        </button>
                        <button class="btn btn-secondary" onclick="cancelCAEExecution()">
                            Cancelar
                        </button>
                    </div>
                `;
                
                resultDiv.appendChild(challengeDiv);
                
            } catch (error) {
                if (executeButton) {
                    executeButton.disabled = false;
                    executeButton.textContent = 'Ejecutar en eGestiona';
                }
                alert(`Error al obtener challenge: ${error.message}`);
            }
        }
        
        // v1.8: Usar enqueue en lugar de execute directo
        async function confirmCAEExecution(planId, challengeToken) {
            // Buscar en ambos modales (plan filtrado y selecci√≥n)
            let resultDiv = document.getElementById('cae-plan-result');
            if (!resultDiv) {
                resultDiv = document.getElementById('cae-selection-result');
            }
            
            // Si a√∫n no se encuentra, buscar en el modal de selecci√≥n
            if (!resultDiv) {
                const selectionModal = document.getElementById('cae-selection-modal');
                if (selectionModal) {
                    resultDiv = selectionModal.querySelector('#cae-selection-result');
                }
            }
            
            const challengeResponseInput = document.getElementById('cae-challenge-response');
            const dryRunCheckbox = document.getElementById('cae-dry-run');
            const confirmButton = resultDiv ? resultDiv.querySelector('[data-testid="cae-confirm-execute-button"]') : null;
            
            console.log('[repo] confirmCAEExecution called, resultDiv:', resultDiv ? resultDiv.id : 'NOT FOUND');
            
            if (!challengeResponseInput || !challengeResponseInput.value.trim()) {
                alert('Por favor, escribe la respuesta del challenge');
                return;
            }
            
            if (confirmButton) {
                confirmButton.disabled = true;
                confirmButton.textContent = 'Encolando...';
            }
            
            // Verificar que resultDiv existe antes de continuar
            if (!resultDiv) {
                throw new Error('resultDiv no encontrado. No se puede mostrar el progreso.');
            }
            
            try {
                // v1.8: Encolar job en lugar de ejecutar directamente
                const enqueueResponse = await fetch(`${BACKEND_URL}/api/cae/execute/${planId}/enqueue`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        challenge_token: challengeToken,
                        challenge_response: challengeResponseInput.value.trim(),
                        dry_run: dryRunCheckbox ? dryRunCheckbox.checked : false,
                    }),
                });
                
                if (!enqueueResponse.ok) {
                    const errorText = await enqueueResponse.text();
                    throw new Error(`Error ${enqueueResponse.status}: ${errorText}`);
                }
                
                const job = await enqueueResponse.json();
                console.log('[repo] Job enqueued:', job.job_id);
                
                // Remover el div de challenge
                const challengeDiv = resultDiv.querySelector('div[style*="background: #1e293b"]');
                if (challengeDiv) {
                    challengeDiv.remove();
                }
                
                // Mostrar progreso y empezar polling
                const progressDiv = document.createElement('div');
                progressDiv.id = 'cae-job-progress';
                progressDiv.style.marginTop = '16px';
                progressDiv.style.padding = '16px';
                progressDiv.style.background = '#1e293b';
                progressDiv.style.borderRadius = '4px';
                progressDiv.style.border = '1px solid #334155';
                
                // v1.8.2: Establecer atributos iniciales inmediatamente para E2E determinista
                progressDiv.setAttribute('data-job-status', 'QUEUED');
                progressDiv.setAttribute('data-job-progress', '0');
                progressDiv.setAttribute('data-job-id', job.job_id);
                
                console.log('[repo] Appending progress div to resultDiv:', resultDiv.id);
                resultDiv.appendChild(progressDiv);
                console.log('[repo] Progress div appended, starting polling');
                
                // Iniciar polling
                pollJobStatus(job.job_id, progressDiv);
                
            } catch (error) {
                console.error('[repo] Error en confirmCAEExecution:', error);
                if (confirmButton) {
                    confirmButton.disabled = false;
                    confirmButton.textContent = 'Confirmar y Ejecutar';
                }
                // Mostrar error en el div de resultado en lugar de alert
                if (!resultDiv) {
                    // Si no hay resultDiv, intentar encontrarlo de nuevo
                    resultDiv = document.getElementById('cae-plan-result') || document.getElementById('cae-selection-result');
                }
                if (resultDiv) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'cae-job-progress';
                    errorDiv.style.background = '#7f1d1d';
                    errorDiv.style.color = '#fca5a5';
                    errorDiv.style.padding = '16px';
                    errorDiv.style.borderRadius = '8px';
                    errorDiv.style.marginTop = '16px';
                    errorDiv.setAttribute('data-job-status', 'FAILED');
                    errorDiv.setAttribute('data-job-progress', '0');
                    const errorMsg = error.message || error.toString() || 'Error desconocido';
                    console.error('[repo] Error message:', errorMsg);
                    errorDiv.innerHTML = `<strong>Error:</strong> ${escapeHtml(errorMsg)}`;
                    resultDiv.appendChild(errorDiv);
                } else {
                    alert(`Error al encolar ejecuci√≥n: ${error.message}`);
                }
            }
        }
        
        // v1.8: Polling del estado del job
        async function pollJobStatus(jobId, progressDiv) {
            const pollInterval = 800; // 800ms entre polls
            const maxPolls = 300; // M√°ximo 4 minutos (300 * 800ms)
            let pollCount = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/cae/jobs/${jobId}`);
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${await response.text()}`);
                    }
                    
                    const job = await response.json();
                    
                    // Actualizar UI con progreso
                    const statusBadge = job.status === 'SUCCESS' ? 'badge-success' :
                                       job.status === 'PARTIAL_SUCCESS' ? 'badge-warning' :
                                       job.status === 'BLOCKED' ? 'badge-warning' :
                                       job.status === 'FAILED' ? 'badge-error' :
                                       job.status === 'CANCELED' ? 'badge' :
                                       job.status === 'RUNNING' ? 'badge-info' :
                                       'badge';
                    
                    const progress = job.progress || {};
                    const percent = progress.percent || 0;
                    const message = progress.message || 'Procesando...';
                    
                    // v1.8.2: A√±adir atributos data-testid expl√≠citos para E2E determinista
                    progressDiv.setAttribute('data-job-status', job.status);
                    progressDiv.setAttribute('data-job-progress', percent.toString());
                    progressDiv.setAttribute('data-job-id', jobId);
                    
                    // v1.9: A√±adir botones de control seg√∫n estado
                    let controlButtons = '';
                    
                    // Bot√≥n Cancelar (solo si est√° QUEUED o RUNNING)
                    if (job.status === 'QUEUED' || job.status === 'RUNNING') {
                        controlButtons += `
                            <button class="btn btn-secondary btn-sm" onclick="cancelCAEJob('${jobId}')" 
                                    data-testid="job-cancel-button" style="margin-right: 8px;">
                                Cancelar
                            </button>
                        `;
                    }
                    
                    // Bot√≥n Reintentar (solo si est√° FAILED o PARTIAL_SUCCESS)
                    if (job.status === 'FAILED' || job.status === 'PARTIAL_SUCCESS') {
                        controlButtons += `
                            <button class="btn btn-warning btn-sm" onclick="retryCAEJob('${jobId}')" 
                                    data-testid="job-retry-button" style="margin-right: 8px;">
                                Reintentar
                            </button>
                        `;
                    }
                    
                    // Bot√≥n Descargar informe (si est√° terminal)
                    if (job.status === 'SUCCESS' || job.status === 'PARTIAL_SUCCESS' || 
                        job.status === 'FAILED' || job.status === 'BLOCKED' || job.status === 'CANCELED') {
                        controlButtons += `
                            <button class="btn btn-primary btn-sm" onclick="downloadCAEJobReport('${jobId}')" 
                                    data-testid="job-report-button">
                                Descargar informe
                            </button>
                        `;
                    }
                    
                    progressDiv.innerHTML = `
                        <h4 style="margin-bottom: 8px;">Ejecuci√≥n en progreso</h4>
                        <div style="margin-bottom: 8px;">
                            <span class="badge ${statusBadge}" data-testid="job-status-badge">${escapeHtml(job.status)}</span>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span data-testid="job-message">${escapeHtml(message)}</span>
                                <span data-testid="job-percent">${percent}%</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percent}%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; font-size: 0.875rem;">
                            <div>
                                <strong>Total:</strong> ${progress.total_items || 0}
                            </div>
                            <div style="color: #10b981;">
                                <strong>√âxito:</strong> ${progress.items_success || 0}
                            </div>
                            <div style="color: #ef4444;">
                                <strong>Fallos:</strong> ${progress.items_failed || 0}
                            </div>
                        </div>
                        ${job.error ? `
                            <div style="margin-bottom: 8px; color: #ef4444;">
                                <strong>Error:</strong> ${escapeHtml(job.error)}
                            </div>
                        ` : ''}
                        ${controlButtons ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #334155;">
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${controlButtons}
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    // Si termin√≥, mostrar resultado final
                    if (job.status === 'SUCCESS' || job.status === 'PARTIAL_SUCCESS' || 
                        job.status === 'FAILED' || job.status === 'BLOCKED' || job.status === 'CANCELED') {
                        progressDiv.innerHTML += `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;" data-testid="job-completed-message">
                                <div style="margin-bottom: 8px;" data-testid="job-run-id">
                                    <strong>Run ID:</strong> ${escapeHtml(job.run_id || 'N/A')}
                                </div>
                                ${job.evidence_path ? `
                                    <div style="margin-bottom: 8px;" data-testid="job-evidence-path">
                                        <strong>Evidencia:</strong> ${escapeHtml(job.evidence_path)}
                                    </div>
                                ` : ''}
                                <div style="margin-top: 8px; color: ${job.status === 'SUCCESS' ? '#10b981' : job.status === 'FAILED' ? '#ef4444' : job.status === 'CANCELED' ? '#6b7280' : '#f59e0b'}; font-weight: 500;">
                                    ${job.status === 'SUCCESS' ? '‚úì Completado exitosamente' : 
                                      job.status === 'PARTIAL_SUCCESS' ? '‚ö† Completado parcialmente' :
                                      job.status === 'FAILED' ? '‚úó Fall√≥' :
                                      job.status === 'CANCELED' ? '‚äò Cancelado' :
                                      '‚ö† Bloqueado'}
                                </div>
                            </div>
                        `;
                        // v1.8.2: Asegurar que el atributo data-job-status est√° actualizado
                        progressDiv.setAttribute('data-job-status', job.status);
                        progressDiv.setAttribute('data-job-progress', '100');
                        return; // Detener polling
                    }
                    
                    // Continuar polling si no termin√≥
                    pollCount++;
                    if (pollCount < maxPolls) {
                        setTimeout(poll, pollInterval);
                    } else {
                        progressDiv.innerHTML += `
                            <div style="margin-top: 16px; color: #f59e0b;">
                                <strong>Timeout:</strong> La ejecuci√≥n est√° tardando m√°s de lo esperado. Verifica el estado manualmente.
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    progressDiv.innerHTML += `
                        <div style="margin-top: 16px; color: #ef4444;">
                            <strong>Error al consultar estado:</strong> ${escapeHtml(error.message)}
                        </div>
                    `;
                }
            };
            
            // Iniciar polling
            poll();
        }
        
        // v1.9: Funciones de control de jobs
        async function cancelCAEJob(jobId) {
            if (!confirm('¬øEst√°s seguro de que quieres cancelar este job?')) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/cae/jobs/${jobId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                // Refrescar estado del job
                const job = await response.json();
                const progressDiv = document.querySelector(`[data-job-id="${jobId}"]`);
                if (progressDiv) {
                    // Forzar actualizaci√≥n del polling
                    await pollJobStatus(jobId, progressDiv);
                }
            } catch (error) {
                console.error('[repo] Error al cancelar job:', error);
                alert(`Error al cancelar job: ${error.message}`);
            }
        }
        
        async function retryCAEJob(jobId) {
            // Buscar el div de progreso del job original
            const progressDiv = document.querySelector(`[data-job-id="${jobId}"]`);
            if (!progressDiv) {
                alert('No se encontr√≥ el job para reintentar');
                return;
            }
            
            // Confirmar con el usuario
            if (!confirm('¬øCrear un nuevo job como reintento de este?')) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/cae/jobs/${jobId}/retry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                const newJob = await response.json();
                console.log('[repo] New retry job created:', newJob.job_id);
                
                // v1.9.1: Crear nuevo div de progreso para el nuevo job
                // Buscar el contenedor padre (resultDiv)
                let resultDiv = progressDiv.closest('#cae-plan-result') || progressDiv.closest('#cae-selection-result');
                if (!resultDiv) {
                    // Si no hay resultDiv, usar el padre del progressDiv
                    resultDiv = progressDiv.parentElement;
                }
                
                if (resultDiv) {
                    // Crear nuevo div de progreso para el nuevo job
                    const newProgressDiv = document.createElement('div');
                    newProgressDiv.id = 'cae-job-progress';
                    newProgressDiv.style.marginTop = '16px';
                    newProgressDiv.style.padding = '16px';
                    newProgressDiv.style.background = '#1e293b';
                    newProgressDiv.style.borderRadius = '4px';
                    newProgressDiv.style.border = '1px solid #334155';
                    newProgressDiv.setAttribute('data-job-status', 'QUEUED');
                    newProgressDiv.setAttribute('data-job-progress', '0');
                    newProgressDiv.setAttribute('data-job-id', newJob.job_id);
                    
                    // A√±adir mensaje indicando que es un retry
                    newProgressDiv.innerHTML = `
                        <h4 style="margin-bottom: 8px;">Reintento de job ${escapeHtml(jobId)}</h4>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 8px;">
                            Nuevo job ID: <strong>${escapeHtml(newJob.job_id)}</strong>
                        </p>
                    `;
                    
                    // v1.9.1: Insertar despu√©s del div de progreso original
                    // Asegurar que se inserta correctamente en el DOM
                    const parentNode = progressDiv.parentNode;
                    if (parentNode) {
                        parentNode.insertBefore(newProgressDiv, progressDiv.nextSibling);
                        console.log('[repo] New progress div inserted for retry job:', newJob.job_id);
                    } else {
                        // Fallback: a√±adir al resultDiv
                        resultDiv.appendChild(newProgressDiv);
                        console.log('[repo] New progress div appended to resultDiv for retry job:', newJob.job_id);
                    }
                    
                    // Iniciar polling del nuevo job
                    pollJobStatus(newJob.job_id, newProgressDiv);
                } else {
                    alert(`Nuevo job creado: ${newJob.job_id}`);
                }
            } catch (error) {
                console.error('[repo] Error al reintentar job:', error);
                alert(`Error al reintentar job: ${error.message}`);
            }
        }
        
        function downloadCAEJobReport(jobId) {
            // Abrir informe en nueva pesta√±a
            window.open(`${BACKEND_URL}/api/cae/jobs/${jobId}/report`, '_blank');
        }
        
        function cancelCAEExecution() {
            // Buscar en ambos modales (plan filtrado y selecci√≥n)
            let resultDiv = document.getElementById('cae-plan-result');
            if (!resultDiv) {
                resultDiv = document.getElementById('cae-selection-result');
            }
            if (!resultDiv) return;
            
            const challengeDiv = resultDiv.querySelector('div[style*="background: #1e293b"]');
            if (challengeDiv) {
                challengeDiv.remove();
            }
            const executeButton = resultDiv.querySelector('[data-testid="cae-execute-button"]');
            if (executeButton) {
                executeButton.disabled = false;
                executeButton.textContent = 'Ejecutar en eGestiona';
            }
        }
        
        // ========== v1.5: CAE Selection Modal ==========
        
        let selectedPendingItems = [];
        let docCandidatesCache = {};
        
        function toggleAllPendingRows(checked) {
            const checkboxes = document.querySelectorAll('.pending-row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });
            updateCAESelectionCount();
        }
        
        function updateCAESelectionCount() {
            const checkboxes = document.querySelectorAll('.pending-row-checkbox:checked');
            const count = checkboxes.length;
            const button = document.querySelector('[data-testid="cae-selection-button"]');
            if (button) {
                if (count > 0) {
                    button.textContent = `Preparar env√≠o CAE (selecci√≥n) (${count})`;
                } else {
                    button.textContent = 'Preparar env√≠o CAE (selecci√≥n)';
                }
            }
        }
        
        async function openCAESelectionModal() {
            // Obtener items seleccionados
            selectedPendingItems = [];
            const checkboxes = document.querySelectorAll('.pending-row-checkbox:checked');
            checkboxes.forEach(cb => {
                const row = cb.closest('tr[data-pending-item]');
                if (row) {
                    const itemData = JSON.parse(row.getAttribute('data-pending-item'));
                    selectedPendingItems.push({
                        ...itemData,
                        itemId: cb.getAttribute('data-item-id')
                    });
                }
            });
            
            if (selectedPendingItems.length === 0) {
                alert('Por favor, selecciona al menos un pendiente de subir.');
                return;
            }
            
            // Crear modal
            const modal = document.createElement('div');
            modal.id = 'cae-selection-modal';
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            let modalContent = `
                <div class="modal-content" style="background: #1e293b; border-radius: 8px; padding: 24px; max-width: 900px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2>Preparar env√≠o CAE (selecci√≥n)</h2>
                        <button class="close-button" onclick="closeCAESelectionModal()" style="background: none; border: none; color: #e2e8f0; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <p>Seleccionados: <strong>${selectedPendingItems.length}</strong> items</p>
                    </div>
                    
                    <div id="cae-selection-items" style="margin-bottom: 24px;">
                        ${selectedPendingItems.map((item, idx) => `
                            <div class="card" style="margin-bottom: 16px; padding: 16px; background: #0f172a; border: 1px solid #334155; border-radius: 8px;" data-item-idx="${idx}">
                                <h3 style="margin-bottom: 8px;">${escapeHtml(item.type_id)}</h3>
                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 12px;">
                                    ${item.scope === 'worker' ? `Trabajador: ${item.person_key}` : `Empresa: ${item.company_key}`} | Per√≠odo: ${item.period_key || 'N/A'}
                                </p>
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Documento del repositorio:</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="doc-select-${idx}" class="form-input" style="flex: 1;" onchange="updateViewPDFButton(${idx})">
                                            <option value="">-- Cargando candidatos...</option>
                                        </select>
                                        <input type="text" id="doc-filter-${idx}" class="form-input" placeholder="Filtrar..." style="width: 200px;" oninput="filterDocCandidates(${idx})">
                                        <button class="btn btn-secondary btn-sm" onclick="viewDocPDF(${idx})" id="view-pdf-btn-${idx}" disabled>Ver PDF</button>
                                    </div>
                                    <div id="doc-candidates-${idx}" style="margin-top: 8px; font-size: 0.875rem; color: #94a3b8;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div id="cae-selection-result"></div>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="closeCAESelectionModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="generateCAEPlanFromSelection()" data-testid="cae-selection-generate">Generar plan</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Cerrar al hacer click fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCAESelectionModal();
                }
            });
            
            // Cargar candidatos para cada item (en paralelo para ser m√°s r√°pido)
            Promise.all(
                selectedPendingItems.map((_, idx) => 
                    loadDocCandidates(idx).catch(err => {
                        console.error(`[repo] Error loading candidates for item ${idx}:`, err);
                    })
                )
            ).catch(err => {
                console.error('[repo] Error loading candidates:', err);
            });
        }
        
        async function loadDocCandidates(itemIdx) {
            const item = selectedPendingItems[itemIdx];
            const select = document.getElementById(`doc-select-${itemIdx}`);
            const candidatesDiv = document.getElementById(`doc-candidates-${itemIdx}`);
            
            if (!select || !item) return;
            
            // Obtener el contenedor del item (card) para a√±adir la se√±al despu√©s
            const itemCard = select.closest('[data-item-idx]') || select.closest('.card');
            
            try {
                select.innerHTML = '<option value="">-- Cargando...</option>';
                select.disabled = true;
                
                const params = new URLSearchParams({
                    type_id: item.type_id,
                    scope: item.scope,
                    company_key: item.company_key || '',
                    include_best: 'true',  // v1.7: Solicitar mejor candidato
                });
                if (item.person_key) params.append('person_key', item.person_key);
                if (item.period_key) {
                    params.append('period_key', item.period_key);
                    // Para periodos missing, permitir fallback a documentos de otros periodos
                    params.append('allow_period_fallback', 'true');
                }
                
                const response = await fetch(`${BACKEND_URL}/api/cae/doc_candidates?${params}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[repo] Error loading doc_candidates for item ${itemIdx}:`, {
                        status: response.status,
                        statusText: response.statusText,
                        errorText: errorText,
                        url: `${BACKEND_URL}/api/cae/doc_candidates?${params}`,
                        params: Object.fromEntries(params)
                    });
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                const candidates = data.candidates || [];
                const fallback_applied = data.fallback_applied || false;
                const best_doc_id = data.best_doc_id || null;
                const best_reason = data.best_reason || null;
                
                // Guardar en cache
                docCandidatesCache[itemIdx] = candidates;
                
                // Llenar select
                select.innerHTML = '<option value="">-- Seleccionar documento --</option>';
                candidates.forEach(cand => {
                    const option = document.createElement('option');
                    option.value = cand.doc_id;
                    option.textContent = `${cand.file_name_original || cand.doc_id} (${cand.validity_status || 'N/A'})`;
                    option.setAttribute('data-candidate', JSON.stringify(cand));
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
                // v1.7: Preseleccionar best_doc_id si existe
                if (best_doc_id) {
                    select.value = best_doc_id;
                    // Disparar evento change para actualizar bot√≥n "Ver PDF"
                    select.dispatchEvent(new Event('change'));
                }
                
                // Mostrar mensaje con badge si se aplic√≥ fallback y sugerencia autom√°tica
                if (candidates.length === 0) {
                    candidatesDiv.innerHTML = '<span style="color: #fca5a5;">No hay documentos candidatos disponibles</span>';
                } else {
                    let message = `<span style="color: #94a3b8;">${candidates.length} documento(s) encontrado(s)</span>`;
                    if (fallback_applied) {
                        message += ' <span class="badge badge-warning" style="margin-left: 8px; font-size: 0.75rem;">candidatos de otros periodos</span>';
                    }
                    // v1.7: Mostrar sugerencia autom√°tica
                    if (best_doc_id && best_reason) {
                        message += `<div style="margin-top: 8px; font-size: 0.875rem; color: #60a5fa;" data-testid="auto-suggestion-${itemIdx}" data-item-idx="${itemIdx}">`;
                        message += `<span style="font-weight: 500;">üí° Sugerido autom√°ticamente:</span> ${escapeHtml(best_reason)}`;
                        message += `</div>`;
                    }
                    candidatesDiv.innerHTML = message;
                }
                
                // v1.7: Se√±al de que la auto-sugerencia est√° lista (para E2E)
                // Buscar el contenedor del item (card) que tiene data-item-idx
                const cardWithIdx = document.querySelector(`[data-item-idx="${itemIdx}"]`);
                if (cardWithIdx) {
                    cardWithIdx.setAttribute('data-autosuggestion-ready', 'true');
                } else {
                    // Fallback: buscar el card m√°s cercano al select
                    const fallbackCard = select.closest('.card');
                    if (fallbackCard) {
                        fallbackCard.setAttribute('data-autosuggestion-ready', 'true');
                        fallbackCard.setAttribute('data-item-idx', itemIdx.toString());
                    } else {
                        // √öltimo fallback: poner en el select mismo
                        select.setAttribute('data-autosuggestion-ready', 'true');
                        select.setAttribute('data-item-idx', itemIdx.toString());
                    }
                }
            } catch (error) {
                console.error(`Error al cargar candidatos para item ${itemIdx}:`, error);
                select.innerHTML = '<option value="">-- Error al cargar --</option>';
                const errorMsg = error.message || String(error);
                candidatesDiv.innerHTML = `<span style="color: #fca5a5;" data-testid="doc-candidates-error-${itemIdx}">Error: ${errorMsg}</span>`;
                console.error(`[repo] Full error for item ${itemIdx}:`, {
                    error: error,
                    message: errorMsg,
                    stack: error.stack
                });
                
                // A√±adir se√±al incluso en caso de error (para que el test no se quede esperando)
                const cardWithIdx = document.querySelector(`[data-item-idx="${itemIdx}"]`);
                if (cardWithIdx) {
                    cardWithIdx.setAttribute('data-autosuggestion-ready', 'true');
                } else {
                    const fallbackCard = select.closest('.card');
                    if (fallbackCard) {
                        fallbackCard.setAttribute('data-autosuggestion-ready', 'true');
                        fallbackCard.setAttribute('data-item-idx', itemIdx.toString());
                    } else {
                        select.setAttribute('data-autosuggestion-ready', 'true');
                        select.setAttribute('data-item-idx', itemIdx.toString());
                    }
                }
            }
        }
        
        function filterDocCandidates(itemIdx) {
            const filterInput = document.getElementById(`doc-filter-${itemIdx}`);
            const select = document.getElementById(`doc-select-${itemIdx}`);
            if (!filterInput || !select) return;
            
            const filter = filterInput.value.toLowerCase();
            const candidates = docCandidatesCache[itemIdx] || [];
            
            select.innerHTML = '<option value="">-- Seleccionar documento --</option>';
            candidates.forEach(cand => {
                const fileName = (cand.file_name_original || cand.doc_id || '').toLowerCase();
                const docId = (cand.doc_id || '').toLowerCase();
                if (filter === '' || fileName.includes(filter) || docId.includes(filter)) {
                    const option = document.createElement('option');
                    option.value = cand.doc_id;
                    option.textContent = `${cand.file_name_original || cand.doc_id} (${cand.validity_status || 'N/A'})`;
                    option.setAttribute('data-candidate', JSON.stringify(cand));
                    select.appendChild(option);
                }
            });
        }
        
        function updateViewPDFButton(itemIdx) {
            const select = document.getElementById(`doc-select-${itemIdx}`);
            const viewBtn = document.getElementById(`view-pdf-btn-${itemIdx}`);
            if (viewBtn && select) {
                viewBtn.disabled = !select.value;
            }
        }
        
        function viewDocPDF(itemIdx) {
            const select = document.getElementById(`doc-select-${itemIdx}`);
            if (!select || !select.value) return;
            
            const docId = select.value;
            window.open(`${BACKEND_URL}/api/repository/docs/${docId}/pdf`, '_blank');
        }
        
        async function generateCAEPlanFromSelection() {
            const resultDiv = document.getElementById('cae-selection-result');
            if (!resultDiv) return;
            
            try {
                resultDiv.innerHTML = '<div style="padding: 16px; text-align: center;">Generando plan...</div>';
                
                // Recopilar selected_items con suggested_doc_id
                const selectedItems = [];
                for (let idx = 0; idx < selectedPendingItems.length; idx++) {
                    const select = document.getElementById(`doc-select-${idx}`);
                    const item = selectedPendingItems[idx];
                    
                    selectedItems.push({
                        type_id: item.type_id,
                        scope: item.scope,
                        company_key: item.company_key,
                        person_key: item.person_key,
                        period_key: item.period_key,
                        suggested_doc_id: select ? select.value : null,
                    });
                }
                
                // Determinar scope base (usar el primer item como referencia)
                const firstItem = selectedPendingItems[0];
                const scope = {
                    platform_key: 'egestiona',
                    type_ids: [],
                    company_key: firstItem.company_key,
                    person_key: firstItem.person_key,
                    mode: 'PREPARE_WRITE',
                };
                
                const response = await fetch(`${BACKEND_URL}/api/cae/plan_from_selection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scope: scope,
                        selected_items: selectedItems,
                    }),
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                const plan = await response.json();
                
                // Renderizar resultado (similar a generateCAEPlan)
                // SPRINT C2.7: A√±adir testid y data-decision para determinismo
                let resultHtml = `
                    <div style="background: #1e293b; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h3 style="margin-bottom: 12px;">Resultado del Plan</h3>
                        <div style="margin-bottom: 8px;" data-testid="cae-plan-decision" data-decision="${escapeHtml(plan.decision)}">
                            <strong>Decisi√≥n:</strong> 
                            <span class="badge ${plan.decision === 'READY' ? 'badge-ok' : plan.decision === 'NEEDS_CONFIRMATION' ? 'badge-warning' : 'badge-error'}">
                                ${plan.decision}
                            </span>
                        </div>
                        ${plan.reasons && plan.reasons.length > 0 ? `
                            <div style="margin-bottom: 8px;">
                                <strong>Razones:</strong>
                                <ul style="margin-left: 20px; margin-top: 4px;">
                                    ${plan.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div style="margin-bottom: 8px;">
                            <strong>Items:</strong> ${plan.items.length}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Resumen:</strong> <pre style="background: #0f172a; padding: 8px; border-radius: 4px; font-size: 0.875rem; overflow-x: auto;">${JSON.stringify(plan.summary, null, 2)}</pre>
                        </div>
                    </div>
                `;
                
                if (plan.decision === 'READY') {
                    resultHtml += `
                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary" onclick="startCAEExecution('${plan.plan_id}')" data-testid="cae-execute-button">
                                Ejecutar en eGestiona
                            </button>
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = resultHtml;
            } catch (error) {
                console.error('Error al generar plan desde selecci√≥n:', error);
                // SPRINT C2.7: A√±adir testid para errores
                resultDiv.innerHTML = `<div style="background: #7f1d1d; color: #fca5a5; padding: 16px; border-radius: 8px; margin-top: 16px;" data-testid="cae-plan-error">
                    <strong>Error:</strong> ${escapeHtml(error.message || 'Error desconocido')}
                </div>`;
            }
        }
        
        function closeCAESelectionModal() {
            const modal = document.getElementById('cae-selection-modal');
            if (modal) {
                modal.remove();
            }
            selectedPendingItems = [];
            docCandidatesCache = {};
        }
        
        // ========== v1.6: Coordinaci√≥n CAE ==========
        
        let currentSnapshot = null;
        let selectedSnapshotItems = [];
        
        async function loadCoordinacion(params = {}) {
            const content = document.getElementById('page-content');
            if (!content) {
                console.error('[repo] loadCoordinacion: page-content not found');
                return;
            }
            
            try {
                // Cargar plataformas para obtener coordinaciones
                let coordinations = [];
                try {
                    const platformsResponse = await fetch(`${BACKEND_URL}/api/config/platforms`);
                    if (platformsResponse.ok) {
                        const platformsData = await platformsResponse.json();
                        const egestiona = platformsData.platforms?.find(p => p.key === 'egestiona');
                        coordinations = egestiona?.coordinations || [];
                    }
                } catch (error) {
                    console.warn('[repo] Error loading platforms, continuing with empty coordinations:', error);
                    // No mostrar error aqu√≠, solo continuar con lista vac√≠a
                }
                
                content.innerHTML = `
                    <div class="page-header" data-testid="coordination-root">
                        <h1>Coordinaci√≥n CAE</h1>
                        <p>Consulta pendientes de plataforma y genera planes de env√≠o</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 24px;">
                        <h2 data-testid="coordination-config-title">Configuraci√≥n de consulta</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Plataforma:</label>
                                <select id="coord-platform" class="form-input">
                                    <option value="egestiona">eGestiona</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Coordinaci√≥n:</label>
                                <select id="coord-coordination" class="form-input">
                                    <option value="">-- Seleccionar --</option>
                                    ${coordinations.map(c => `<option value="${escapeHtml(c.label)}">${escapeHtml(c.label)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Empresa:</label>
                                <input type="text" id="coord-company" class="form-input" placeholder="Opcional">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Trabajador:</label>
                                <input type="text" id="coord-person" class="form-input" placeholder="Opcional">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="createCoordinationSnapshot()" id="coord-query-btn">
                            Consultar pendientes (READ)
                        </button>
                    </div>
                    
                    <div id="coord-snapshot-result" style="display: none;"></div>
                    <div id="coord-snapshot-items" style="display: none;"></div>
                `;
                
                // SPRINT B: Agregar se√±al DOM cuando coordinacion est√° completamente cargado
                const coordRoot = document.querySelector('[data-testid="coordination-root"]');
                if (coordRoot) {
                    content.setAttribute('data-testid', 'view-coordinacion-ready');
                }
            } catch (error) {
                console.error('[repo] Error loading coordinacion:', error);
                const errorMsg = error.message || 'Error desconocido al cargar coordinaci√≥n';
                content.innerHTML = `
                    <div class="error-banner" data-testid="coordination-error">
                        <strong>Error:</strong> ${escapeHtml(errorMsg)}
                        <br><small>Revisa la consola del navegador para m√°s detalles.</small>
                    </div>
                `;
            }
        }
        
        async function createCoordinationSnapshot() {
            const platformSelect = document.getElementById('coord-platform');
            const coordinationSelect = document.getElementById('coord-coordination');
            const companyInput = document.getElementById('coord-company');
            const personInput = document.getElementById('coord-person');
            const queryBtn = document.getElementById('coord-query-btn');
            const resultDiv = document.getElementById('coord-snapshot-result');
            const itemsDiv = document.getElementById('coord-snapshot-items');
            
            if (!platformSelect || !coordinationSelect || !queryBtn || !resultDiv || !itemsDiv) return;
            
            const coordinationLabel = coordinationSelect.value;
            // En modo FAKE, permitir crear snapshot sin coordinaci√≥n seleccionada
            // (el backend usar√° un valor por defecto)
            
            queryBtn.disabled = true;
            queryBtn.textContent = 'Consultando...';
            resultDiv.style.display = 'none';
            itemsDiv.style.display = 'none';
            
            try {
                const scope = {
                    platform_key: platformSelect.value,
                    coordination_label: coordinationLabel || null, // Permitir null en modo FAKE
                    company_key: companyInput.value.trim() || null,
                    person_key: personInput.value.trim() || null,
                    type_ids: null,
                    period_keys: null,
                };
                
                const response = await fetch(`${BACKEND_URL}/api/cae/coordination/snapshot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scope),
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${await response.text()}`);
                }
                
                const snapshot = await response.json();
                currentSnapshot = snapshot;
                selectedSnapshotItems = [];
                
                // Mostrar resultado
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="card">
                        <h2>Snapshot creado</h2>
                        <p><strong>ID:</strong> ${escapeHtml(snapshot.snapshot_id)}</p>
                        <p><strong>Fecha:</strong> ${new Date(snapshot.created_at).toLocaleString()}</p>
                        <p><strong>Pendientes encontrados:</strong> ${snapshot.pending_items.length}</p>
                    </div>
                `;
                
                // Mostrar items con checkboxes
                if (snapshot.pending_items.length > 0) {
                    itemsDiv.style.display = 'block';
                    itemsDiv.innerHTML = `
                        <div class="card">
                            <h2>Pendientes encontrados</h2>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="coord-select-all" onchange="toggleAllSnapshotItems(this.checked)"></th>
                                        <th>Tipo</th>
                                        <th>Sujeto</th>
                                        <th>Per√≠odo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${snapshot.pending_items.map((item, idx) => `
                                        <tr>
                                            <td><input type="checkbox" class="snapshot-item-checkbox" data-index="${idx}" onchange="toggleSnapshotItem(${idx})"></td>
                                            <td>${escapeHtml(item.platform_type_label || item.type_id || 'N/A')}</td>
                                            <td>${item.person_key ? `Trabajador: ${escapeHtml(item.person_key)}` : `Empresa: ${escapeHtml(item.company_key || 'N/A')}`}</td>
                                            <td>${escapeHtml(item.period_key || 'N/A')}</td>
                                            <td><span class="badge badge-info">${escapeHtml(item.status)}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-primary" onclick="openSnapshotSelectionModal()" id="coord-assign-btn" disabled>
                                    Asignar documentos y preparar plan
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    itemsDiv.style.display = 'block';
                    itemsDiv.innerHTML = `
                        <div class="card">
                            <p>No se encontraron pendientes para el √°mbito seleccionado.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error al crear snapshot:', error);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="card" style="background: #7f1d1d; color: #fca5a5;">
                        <strong>Error:</strong> ${escapeHtml(error.message || 'Error desconocido')}
                    </div>
                `;
            } finally {
                queryBtn.disabled = false;
                queryBtn.textContent = 'Consultar pendientes (READ)';
            }
        }
        
        function toggleAllSnapshotItems(checked) {
            const checkboxes = document.querySelectorAll('.snapshot-item-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                const idx = parseInt(cb.getAttribute('data-index'));
                if (checked && !selectedSnapshotItems.includes(idx)) {
                    selectedSnapshotItems.push(idx);
                } else if (!checked) {
                    selectedSnapshotItems = selectedSnapshotItems.filter(i => i !== idx);
                }
            });
            updateSnapshotAssignButton();
        }
        
        function toggleSnapshotItem(index) {
            const checkbox = document.querySelector(`.snapshot-item-checkbox[data-index="${index}"]`);
            if (!checkbox) return;
            
            if (checkbox.checked) {
                if (!selectedSnapshotItems.includes(index)) {
                    selectedSnapshotItems.push(index);
                }
            } else {
                selectedSnapshotItems = selectedSnapshotItems.filter(i => i !== index);
            }
            updateSnapshotAssignButton();
        }
        
        function updateSnapshotAssignButton() {
            const btn = document.getElementById('coord-assign-btn');
            if (btn) {
                btn.disabled = selectedSnapshotItems.length === 0;
                if (selectedSnapshotItems.length > 0) {
                    btn.textContent = `Asignar documentos y preparar plan (${selectedSnapshotItems.length})`;
                } else {
                    btn.textContent = 'Asignar documentos y preparar plan';
                }
            }
        }
        
        async function openSnapshotSelectionModal() {
            if (!currentSnapshot || selectedSnapshotItems.length === 0) {
                alert('Por favor, selecciona al menos un pendiente');
                return;
            }
            
            // Reutilizar modal de selecci√≥n v1.5 pero alimentado por snapshot
            const modal = document.createElement('div');
            modal.id = 'cae-snapshot-selection-modal';
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            // Construir items desde snapshot
            const snapshotItems = selectedSnapshotItems.map(idx => {
                const item = currentSnapshot.pending_items[idx];
                return {
                    type_id: item.type_id || (item.type_alias_candidates && item.type_alias_candidates[0]) || 'UNKNOWN',
                    scope: item.person_key ? 'worker' : 'company',
                    company_key: item.company_key,
                    person_key: item.person_key,
                    period_key: item.period_key,
                    snapshot_index: idx,
                    platform_type_label: item.platform_type_label,
                };
            });
            
            let modalContent = `
                <div class="modal-content" style="background: #1e293b; border-radius: 8px; padding: 24px; max-width: 900px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2>Asignar documentos desde snapshot</h2>
                        <button class="close-button" onclick="closeSnapshotSelectionModal()" style="background: none; border: none; color: #e2e8f0; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <p>Snapshot: <strong>${escapeHtml(currentSnapshot.snapshot_id)}</strong></p>
                        <p>Seleccionados: <strong>${snapshotItems.length}</strong> items</p>
                    </div>
                    
                    <div id="snapshot-selection-items" style="margin-bottom: 24px;">
                        ${snapshotItems.map((item, idx) => `
                            <div class="card" style="margin-bottom: 16px; padding: 16px; background: #0f172a; border: 1px solid #334155; border-radius: 8px;" data-item-idx="${idx}">
                                <h3 style="margin-bottom: 8px;">${escapeHtml(item.platform_type_label || item.type_id)}</h3>
                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 12px;">
                                    ${item.scope === 'worker' ? `Trabajador: ${escapeHtml(item.person_key || 'N/A')}` : `Empresa: ${escapeHtml(item.company_key || 'N/A')}`} | Per√≠odo: ${escapeHtml(item.period_key || 'N/A')}
                                </p>
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Documento del repositorio:</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="snapshot-doc-select-${idx}" class="form-input" style="flex: 1;" onchange="updateSnapshotViewPDFButton(${idx})">
                                            <option value="">-- Cargando candidatos...</option>
                                        </select>
                                        <input type="text" id="snapshot-doc-filter-${idx}" class="form-input" placeholder="Filtrar..." style="width: 200px;" oninput="filterSnapshotDocCandidates(${idx})">
                                        <button class="btn btn-secondary btn-sm" onclick="viewSnapshotDocPDF(${idx})" id="snapshot-view-pdf-btn-${idx}" disabled>Ver PDF</button>
                                    </div>
                                    <div id="snapshot-doc-candidates-${idx}" style="margin-top: 8px; font-size: 0.875rem; color: #94a3b8;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div id="snapshot-selection-result"></div>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="closeSnapshotSelectionModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="generateCAEPlanFromSnapshot()" data-testid="snapshot-generate-plan">Generar plan</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Cerrar al hacer click fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSnapshotSelectionModal();
                }
            });
            
            // Cargar candidatos para cada item (sin await para no bloquear)
            // Cargar en paralelo para ser m√°s r√°pido
            Promise.all(
                snapshotItems.map((_, idx) => 
                    loadSnapshotDocCandidates(currentSnapshot.snapshot_id, idx).catch(err => {
                        console.error(`[repo] Error loading candidates for item ${idx}:`, err);
                    })
                )
            ).catch(err => {
                console.error('[repo] Error loading candidates:', err);
            });
        }
        
        async function loadSnapshotDocCandidates(snapshotId, itemIdx) {
            if (!currentSnapshot || !selectedSnapshotItems || itemIdx >= selectedSnapshotItems.length) {
                console.error(`[repo] loadSnapshotDocCandidates: invalid params`, { snapshotId, itemIdx, hasSnapshot: !!currentSnapshot, selectedCount: selectedSnapshotItems?.length });
                return;
            }
            
            const pendingIndex = selectedSnapshotItems[itemIdx];
            if (pendingIndex === undefined || pendingIndex >= currentSnapshot.pending_items.length) {
                console.error(`[repo] loadSnapshotDocCandidates: invalid pendingIndex`, { pendingIndex, itemsCount: currentSnapshot.pending_items.length });
                return;
            }
            
            const item = currentSnapshot.pending_items[pendingIndex];
            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
            const candidatesDiv = document.getElementById(`snapshot-doc-candidates-${itemIdx}`);
            
            if (!select) {
                console.error(`[repo] loadSnapshotDocCandidates: select not found for itemIdx ${itemIdx}`);
                return;
            }
            
            if (!item) {
                console.error(`[repo] loadSnapshotDocCandidates: item not found for pendingIndex ${pendingIndex}`);
                return;
            }
            
            try {
                select.innerHTML = '<option value="">-- Cargando...</option>';
                select.disabled = true;
                
                const params = new URLSearchParams({
                    pending_index: pendingIndex.toString(),
                    allow_period_fallback: 'true',
                    include_best: 'true',  // v1.7: Solicitar mejor candidato
                });
                
                const response = await fetch(`${BACKEND_URL}/api/cae/coordination/snapshot/${snapshotId}/doc_candidates?${params}`);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${await response.text()}`);
                }
                
                const data = await response.json();
                const candidates = data.candidates || [];
                const fallback_applied = data.fallback_applied || false;
                const best_doc_id = data.best_doc_id || null;
                const best_reason = data.best_reason || null;
                
                // Llenar select
                select.innerHTML = '<option value="">-- Seleccionar documento --</option>';
                candidates.forEach(cand => {
                    const option = document.createElement('option');
                    option.value = cand.doc_id;
                    option.textContent = `${cand.file_name_original || cand.doc_id} (${cand.validity_status || 'N/A'})`;
                    option.setAttribute('data-candidate', JSON.stringify(cand));
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
                // v1.7: Preseleccionar best_doc_id si existe
                if (best_doc_id) {
                    select.value = best_doc_id;
                    // Disparar evento change para actualizar bot√≥n "Ver PDF"
                    select.dispatchEvent(new Event('change'));
                }
                
                // Mostrar mensaje con badge si se aplic√≥ fallback y sugerencia autom√°tica
                if (candidates.length === 0) {
                    candidatesDiv.innerHTML = '<span style="color: #fca5a5;">No hay documentos candidatos disponibles</span>';
                } else {
                    let message = `<span style="color: #94a3b8;">${candidates.length} documento(s) encontrado(s)</span>`;
                    if (fallback_applied) {
                        message += ' <span class="badge badge-warning" style="margin-left: 8px; font-size: 0.75rem;">candidatos de otros periodos</span>';
                    }
                    // v1.7: Mostrar sugerencia autom√°tica
                    if (best_doc_id && best_reason) {
                        message += `<div style="margin-top: 8px; font-size: 0.875rem; color: #60a5fa;" data-testid="snapshot-auto-suggestion-${itemIdx}">`;
                        message += `<span style="font-weight: 500;">üí° Sugerido autom√°ticamente:</span> ${escapeHtml(best_reason)}`;
                        message += `</div>`;
                    }
                    candidatesDiv.innerHTML = message;
                }
            } catch (error) {
                console.error(`Error al cargar candidatos para snapshot item ${itemIdx}:`, error);
                select.innerHTML = '<option value="">-- Error al cargar --</option>';
                if (candidatesDiv) {
                    candidatesDiv.innerHTML = `<span style="color: #fca5a5;">Error: ${error.message}</span>`;
                }
            }
        }
        
        async function generateCAEPlanFromSnapshot() {
            if (!currentSnapshot) return;
            
            const resultDiv = document.getElementById('snapshot-selection-result');
            const generateBtn = document.querySelector('[data-testid="snapshot-generate-plan"]');
            
            if (!resultDiv) return;
            
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generando...';
            }
            
            try {
                // Recopilar selecciones
                const selected = [];
                for (let idx = 0; idx < selectedSnapshotItems.length; idx++) {
                    const select = document.getElementById(`snapshot-doc-select-${idx}`);
                    if (select && select.value) {
                        selected.push({
                            pending_index: selectedSnapshotItems[idx],
                            suggested_doc_id: select.value,
                        });
                    }
                }
                
                if (selected.length === 0) {
                    throw new Error('Por favor, asigna al menos un documento');
                }
                
                // Construir scope
                const scope = {
                    platform_key: 'egestiona',
                    type_ids: [],
                    company_key: currentSnapshot.scope.company_key,
                    person_key: currentSnapshot.scope.person_key,
                    period_keys: null,
                    mode: 'PREPARE_WRITE',
                };
                
                const response = await fetch(`${BACKEND_URL}/api/cae/coordination/plan_from_snapshot_selection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        snapshot_id: currentSnapshot.snapshot_id,
                        selected: selected,
                        scope: scope,
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${await response.text()}`);
                }
                
                const plan = await response.json();
                
                // Mostrar resultado (similar a v1.5)
                // SPRINT C2.7: A√±adir testid y data-decision para determinismo
                const decisionBadge = plan.decision === 'READY' ? 'badge-success' : 
                                     plan.decision === 'NEEDS_CONFIRMATION' ? 'badge-warning' : 
                                     'badge-error';
                
                let resultHtml = `
                    <div style="margin-top: 16px; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                        <h4 style="margin-bottom: 8px;">Resultado del plan</h4>
                        <div style="margin-bottom: 8px;" data-testid="cae-plan-decision" data-decision="${escapeHtml(plan.decision)}">
                            <span class="badge ${decisionBadge}">${escapeHtml(plan.decision)}</span>
                        </div>
                        ${plan.reasons && plan.reasons.length > 0 ? `
                            <div style="margin-bottom: 8px;">
                                <strong>Razones:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    ${plan.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div style="margin-bottom: 8px;">
                            <strong>Items:</strong> ${plan.items.length}
                        </div>
                    </div>
                `;
                
                if (plan.decision === 'READY') {
                    resultHtml += `
                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary" onclick="startCAEExecution('${plan.plan_id}')" data-testid="snapshot-execute-button">
                                Ejecutar en eGestiona
                            </button>
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = resultHtml;
            } catch (error) {
                console.error('Error al generar plan desde snapshot:', error);
                // SPRINT C2.7: A√±adir testid para errores
                resultDiv.innerHTML = `<div style="background: #7f1d1d; color: #fca5a5; padding: 16px; border-radius: 8px; margin-top: 16px;" data-testid="cae-plan-error">
                    <strong>Error:</strong> ${escapeHtml(error.message || 'Error desconocido')}
                </div>`;
            } finally {
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generar plan';
                }
            }
        }
        
        function closeSnapshotSelectionModal() {
            const modal = document.getElementById('cae-snapshot-selection-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function updateSnapshotViewPDFButton(itemIdx) {
            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
            const viewBtn = document.getElementById(`snapshot-view-pdf-btn-${itemIdx}`);
            if (viewBtn && select) {
                viewBtn.disabled = !select.value;
            }
        }
        
        function viewSnapshotDocPDF(itemIdx) {
            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
            if (select && select.value) {
                window.open(`${BACKEND_URL}/api/repository/docs/${select.value}/pdf`, '_blank');
            }
        }
        
        function filterSnapshotDocCandidates(itemIdx) {
            const filterInput = document.getElementById(`snapshot-doc-filter-${itemIdx}`);
            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
            if (!filterInput || !select) return;
            
            const filter = filterInput.value.toLowerCase();
            const options = Array.from(select.options);
            
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = '';
                    return;
                }
                const text = option.textContent.toLowerCase();
                option.style.display = (filter === '' || text.includes(filter)) ? '' : 'none';
            });
        }
        
        // SPRINT C2.18B.1: Plan Review UI
        let planReviewState = {
            planId: null,
            planData: null,
            draftDecisions: {}, // item_id -> decision
            savedPackId: null,
            debugCache: {}, // item_id -> debug data (para mostrar hints en tabla)
            selectedItems: new Set(), // item_id -> selected (SPRINT C2.20A)
            presetsCache: null, // Cache de presets (SPRINT C2.20A)
        };
        
        async function loadPlanReview(params = {}) {
            const content = document.getElementById('page-content');
            if (!content) {
                console.error('[repo] loadPlanReview: page-content not found');
                return;
            }
            
            // Cargar estado desde localStorage
            const savedPlanId = localStorage.getItem('plan_review_last_plan_id');
            const savedDraft = localStorage.getItem(`plan_review_draft_${savedPlanId}`);
            if (savedDraft) {
                try {
                    planReviewState.draftDecisions = JSON.parse(savedDraft);
                } catch (e) {
                    console.warn('[repo] Error loading draft decisions:', e);
                }
            }
            
            // Si hay plan_id en params, cargarlo autom√°ticamente
            if (params.plan_id) {
                planReviewState.planId = params.plan_id;
                await loadPlanData(params.plan_id);
            }
            
            renderPlanReview();
        }
        
        function renderPlanReview() {
            const content = document.getElementById('page-content');
            const hasPlan = planReviewState.planData !== null;
            const decisionsCount = Object.keys(planReviewState.draftDecisions).length;
            
            content.innerHTML = `
                <div class="card" data-testid="plan-review-load">
                    <h3>Cargar Plan</h3>
                    <div class="form-group">
                        <label class="form-label">Plan ID</label>
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="text" 
                                id="plan-id-input" 
                                class="form-input" 
                                placeholder="plan_abc123..."
                                value="${planReviewState.planId || ''}"
                            >
                            <button class="btn btn-primary" onclick="handleLoadPlan()" data-testid="plan-review-load-btn">
                                Cargar
                            </button>
                        </div>
                        <p class="form-help">Pega el plan_id de un plan congelado (C2.17).</p>
                    </div>
                </div>
                
                ${hasPlan ? `
                    <div class="card" data-testid="plan-review-table">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3>Items del Plan</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="openExportModal()" data-testid="export-open">
                                    üì¶ Exportar CAE
                                </button>
                                <button class="btn btn-secondary" onclick="openMetricsPanel()" data-testid="metrics-open">
                                    üìä M√©tricas
                                </button>
                                <button class="btn btn-secondary" onclick="openPresetsPanel()" data-testid="presets-open">
                                    üìã Presets
                                </button>
                                <button class="btn btn-secondary" onclick="openLearningPanel()" data-testid="learning-open">
                                    üß† Learning (Hints)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Panel de M√©tricas (SPRINT C2.20B) -->
                        <div id="metrics-panel" class="card" style="margin-bottom: 16px; display: none;" data-testid="metrics-panel">
                            <h4>üìä M√©tricas del Plan</h4>
                            <div id="metrics-content">
                                <div class="loading">Cargando m√©tricas...</div>
                            </div>
                        </div>
                        
                        <!-- Barra de acciones batch (sticky) -->
                        <div id="batch-actions-bar" style="display: none; position: sticky; top: 0; background: #1e293b; padding: 12px; border-radius: 4px; margin-bottom: 16px; z-index: 100; border: 1px solid #334155;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong data-testid="batch-selected-count">0</strong> item(s) seleccionado(s)
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="handleBatchAction('SKIP')" data-testid="batch-action-skip">
                                        Apply SKIP
                                    </button>
                                    <button class="btn btn-secondary" onclick="handleBatchAction('FORCE_UPLOAD')" data-testid="batch-action-force">
                                        Apply FORCE_UPLOAD
                                    </button>
                                    <button class="btn btn-secondary" onclick="handleBatchAction('MARK_AS_MATCH')" data-testid="batch-action-mark">
                                        Apply MARK_AS_MATCH
                                    </button>
                                    <button class="btn btn-secondary" onclick="handleBatchApplyPreset()" data-testid="batch-action-preset">
                                        Apply Preset‚Ä¶
                                    </button>
                                    <button class="btn btn-secondary" onclick="clearBatchSelection()">
                                        Clear selection
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input 
                                                type="checkbox" 
                                                id="batch-select-all" 
                                                data-testid="batch-select-all"
                                                onchange="toggleSelectAll()"
                                            >
                                        </th>
                                        <th>Item ID</th>
                                        <th>Tipo</th>
                                        <th>Sujeto</th>
                                        <th>Periodo</th>
                                        <th>Estado</th>
                                        <th>Reason</th>
                                        <th>Hints</th>
                                        <th>Preset</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="plan-items-tbody">
                                    ${renderPlanItemsTable()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card" data-testid="decision-pack-section">
                        <h3>Decision Pack</h3>
                        <p style="color: #94a3b8; margin-bottom: 16px;">
                            Items decididos: <strong>${decisionsCount}</strong>
                        </p>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button 
                                class="btn btn-primary" 
                                onclick="handleSaveDecisionPack()" 
                                data-testid="decision-pack-save"
                                ${decisionsCount === 0 ? 'disabled' : ''}
                            >
                                Guardar Pack
                            </button>
                            ${planReviewState.savedPackId ? `
                                <button 
                                    class="btn btn-primary" 
                                    onclick="handleExecutePlan()" 
                                    data-testid="decision-pack-execute"
                                >
                                    Ejecutar con Pack
                                </button>
                            ` : ''}
                        </div>
                        ${planReviewState.savedPackId ? `
                            <div class="alert alert-info">
                                <strong>Pack guardado:</strong> 
                                <code data-testid="decision-pack-id">${planReviewState.savedPackId}</code>
                                <br>
                                <a href="${BACKEND_URL}/api/plans/${planReviewState.planId}/decision_packs/${planReviewState.savedPackId}" target="_blank" style="color: #93c5fd;">
                                    Ver pack completo
                                </a>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Modal para ver debug -->
                <div id="debug-modal" class="modal-overlay" style="display: none;" onclick="closeDebugModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Matching Debug</h3>
                            <button onclick="closeDebugModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" id="debug-modal-body">
                            <div class="loading">Cargando...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para decidir -->
                <div id="decide-modal" class="modal-overlay" style="display: none;" onclick="closeDecideModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Decidir sobre Item</h3>
                            <button onclick="closeDecideModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" id="decide-modal-body">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Modal para Learning (Hints) -->
                <div id="learning-modal" class="modal-overlay" style="display: none;" onclick="closeLearningModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>üß† Learning (Hints)</h3>
                            <button onclick="closeLearningModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" id="learning-modal-body">
                            <div class="loading">Cargando...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para Batch Actions (SPRINT C2.20A) -->
                <div id="batch-action-modal" class="modal-overlay" style="display: none;" onclick="closeBatchActionModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 id="batch-action-modal-title">Aplicar Acci√≥n en Lote</h3>
                            <button onclick="closeBatchActionModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" id="batch-action-modal-body">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Modal para Presets Manager (SPRINT C2.20A) -->
                <div id="presets-modal" class="modal-overlay" style="display: none;" onclick="closePresetsModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>üìã Presets Manager</h3>
                            <button onclick="closePresetsModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" id="presets-modal-body">
                            <div class="loading">Cargando...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para Export CAE (SPRINT C2.21) -->
                <div id="export-modal" class="modal-overlay" style="display: none;" onclick="closeExportModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>üì¶ Exportar CAE</h3>
                            <button onclick="closeExportModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" id="export-modal-body">
                            <div class="form-group">
                                <label class="form-label">Company Key</label>
                                <input 
                                    type="text" 
                                    id="export-company-key" 
                                    class="form-input" 
                                    placeholder="COMPANY123"
                                    required
                                >
                            </div>
                            <div class="form-group">
                                <label class="form-label">Periodo</label>
                                <select id="export-period" class="form-input" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="2025">2025 (A√±o completo)</option>
                                    <option value="2025-01">2025-01 (Enero)</option>
                                    <option value="2025-02">2025-02 (Febrero)</option>
                                    <option value="2025-03">2025-03 (Marzo)</option>
                                    <option value="2025-04">2025-04 (Abril)</option>
                                    <option value="2025-05">2025-05 (Mayo)</option>
                                    <option value="2025-06">2025-06 (Junio)</option>
                                    <option value="2025-07">2025-07 (Julio)</option>
                                    <option value="2025-08">2025-08 (Agosto)</option>
                                    <option value="2025-09">2025-09 (Septiembre)</option>
                                    <option value="2025-10">2025-10 (Octubre)</option>
                                    <option value="2025-11">2025-11 (Noviembre)</option>
                                    <option value="2025-12">2025-12 (Diciembre)</option>
                                </select>
                                <p class="form-help">Selecciona el periodo a exportar (YYYY o YYYY-MM)</p>
                            </div>
                            <div id="export-status" style="margin-top: 16px;"></div>
                            <div style="display: flex; gap: 8px; margin-top: 24px;">
                                <button class="btn btn-primary" onclick="handleExportCAE()" data-testid="export-submit">
                                    Exportar
                                </button>
                                <button class="btn btn-secondary" onclick="closeExportModal()">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // SPRINT C2.20B: M√©tricas Panel
        async function openMetricsPanel() {
            const panel = document.getElementById('metrics-panel');
            const content = document.getElementById('metrics-content');
            
            if (!panel || !content) return;
            
            panel.style.display = 'block';
            content.innerHTML = '<div class="loading">Cargando m√©tricas...</div>';
            
            if (!planReviewState.planId) {
                content.innerHTML = '<div class="alert alert-warning">No hay plan cargado</div>';
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/runs/${planReviewState.planId}/metrics`);
                if (!response.ok) {
                    if (response.status === 404) {
                        content.innerHTML = '<div class="alert alert-info">No hay m√©tricas disponibles para este plan a√∫n.</div>';
                        return;
                    }
                    throw new Error(`Error: ${response.statusText}`);
                }
                
                const metrics = await response.json();
                renderMetrics(metrics, content);
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        function renderMetrics(metrics, container) {
            const totalItems = metrics.total_items || 0;
            const decisionsCount = metrics.decisions_count || {};
            const sourceBreakdown = metrics.source_breakdown || {};
            
            const autoUpload = decisionsCount.AUTO_UPLOAD || 0;
            const reviewRequired = decisionsCount.REVIEW_REQUIRED || 0;
            const noMatch = decisionsCount.NO_MATCH || 0;
            const skip = decisionsCount.SKIP || 0;
            
            const autoMatching = sourceBreakdown.auto_matching || 0;
            const learningResolved = sourceBreakdown.learning_hint_resolved || 0;
            const presetApplied = sourceBreakdown.preset_applied || 0;
            const manualSingle = sourceBreakdown.manual_single || 0;
            const manualBatch = sourceBreakdown.manual_batch || 0;
            
            // Calcular porcentajes
            const totalDecisions = autoUpload + reviewRequired + noMatch + skip;
            const autoPercent = totalDecisions > 0 ? ((autoUpload / totalDecisions) * 100).toFixed(1) : 0;
            const manualPercent = totalDecisions > 0 ? (((manualSingle + manualBatch) / totalDecisions) * 100).toFixed(1) : 0;
            const learningPercent = totalDecisions > 0 ? ((learningResolved / totalDecisions) * 100).toFixed(1) : 0;
            const presetPercent = totalDecisions > 0 ? ((presetApplied / totalDecisions) * 100).toFixed(1) : 0;
            
            // Calcular esfuerzo humano evitado
            const humanEffortAvoided = totalDecisions > 0 ? ((autoUpload / totalDecisions) * 100).toFixed(1) : 0;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div class="card" style="padding: 16px;">
                        <h5 style="margin-bottom: 12px;">Distribuci√≥n de Decisiones</h5>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>AUTO_UPLOAD:</span>
                                <strong>${autoUpload}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>REVIEW_REQUIRED:</span>
                                <strong>${reviewRequired}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>NO_MATCH:</span>
                                <strong>${noMatch}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>SKIP:</span>
                                <strong>${skip}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="padding: 16px;">
                        <h5 style="margin-bottom: 12px;">Origen de Decisiones</h5>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Auto Matching:</span>
                                <strong>${autoMatching}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Learning Hints:</span>
                                <strong>${learningResolved}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Presets:</span>
                                <strong>${presetApplied}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Manual (Single):</span>
                                <strong>${manualSingle}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Manual (Batch):</span>
                                <strong>${manualBatch}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 16px; padding: 16px; background: #1e3a8a; border: 1px solid #3b82f6;">
                    <h5 style="margin-bottom: 12px; color: #60a5fa;">üí° Valor Generado</h5>
                    <div style="font-size: 1.1rem; line-height: 1.6;">
                        <p style="margin-bottom: 8px;">
                            <strong>Total items:</strong> ${totalItems}
                        </p>
                        <p style="margin-bottom: 8px;">
                            <strong>Esfuerzo humano evitado:</strong> ${humanEffortAvoided}% (${autoUpload} de ${totalDecisions} items resueltos autom√°ticamente)
                        </p>
                        ${learningResolved > 0 ? `
                            <p style="margin-bottom: 8px;">
                                <span class="badge badge-info">Learning</span> Resueltos por hints: ${learningResolved} (${learningPercent}%)
                            </p>
                        ` : ''}
                        ${presetApplied > 0 ? `
                            <p style="margin-bottom: 8px;">
                                <span class="badge badge-info">Presets</span> Aplicados: ${presetApplied} (${presetPercent}%)
                            </p>
                        ` : ''}
                        <p style="margin-top: 12px; font-size: 0.95rem; color: #93c5fd;">
                            ${humanEffortAvoided >= 50 ? 
                                `‚úÖ Este plan ha evitado revisi√≥n manual en ${humanEffortAvoided}% de los items.` :
                                humanEffortAvoided > 0 ?
                                `‚ö†Ô∏è Este plan requiere revisi√≥n manual en ${(100 - humanEffortAvoided).toFixed(1)}% de los items.` :
                                '‚ö†Ô∏è Todos los items requieren revisi√≥n manual.'
                            }
                        </p>
                    </div>
                </div>
            `;
        }
        
        // SPRINT C2.21: Export CAE
        function openExportModal() {
            const modal = document.getElementById('export-modal');
            if (!modal) return;
            
            modal.style.display = 'flex';
            
            // Prefill company_key desde plan si est√° disponible
            const companyKeyInput = document.getElementById('export-company-key');
            if (planReviewState.planData && planReviewState.planData.items && planReviewState.planData.items.length > 0) {
                const firstItem = planReviewState.planData.items[0];
                if (firstItem.empresa) {
                    companyKeyInput.value = firstItem.empresa;
                }
            }
            
            // Limpiar status
            document.getElementById('export-status').innerHTML = '';
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').style.display = 'none';
        }
        
        async function handleExportCAE() {
            const companyKey = document.getElementById('export-company-key').value.trim();
            const period = document.getElementById('export-period').value.trim();
            const statusDiv = document.getElementById('export-status');
            
            if (!companyKey || !period) {
                statusDiv.innerHTML = '<div class="alert alert-error">Por favor completa todos los campos</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading">Generando export...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/export/cae`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_key: companyKey,
                        period: period,
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Export generado exitosamente</strong>
                        <p>Export ID: ${result.export_id}</p>
                        <p style="margin-top: 8px;">
                            <a href="${BACKEND_URL}${result.download_url}" class="btn btn-primary" download="${result.filename}" data-testid="export-download">
                                üì• Descargar ZIP
                            </a>
                        </p>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        function renderPlanItemsTable() {
            if (!planReviewState.planData || !planReviewState.planData.items) {
                return '<tr><td colspan="10" style="text-align: center; color: #94a3b8;">No hay items</td></tr>';
            }
            
            // Cargar presets si no est√°n en cache
            if (!planReviewState.presetsCache) {
                loadPresetsCache();
            }
            
            return planReviewState.planData.items.map(item => {
                const decision = planReviewState.draftDecisions[item.item_id];
                const hasDecision = decision !== undefined;
                const decisionBadge = hasDecision ? `<span class="badge badge-info">${decision.action}</span>` : '';
                
                // Obtener hints aplicados si est√°n en el estado
                const debugData = planReviewState.debugCache && planReviewState.debugCache[item.item_id];
                const appliedHints = debugData?.outcome?.applied_hints || [];
                const hintsCount = appliedHints.length;
                const hintsDisplay = hintsCount > 0 
                    ? `<span class="badge badge-info" title="${appliedHints.map(h => `${h.effect} (${h.strength})`).join(', ')}">${hintsCount} hint(s)</span>`
                    : '<span style="color: #94a3b8; font-size: 0.75rem;" title="Abrir debug para ver hints">‚Äî</span>';
                
                // Verificar si hay preset aplicable
                const applicablePreset = findApplicablePreset(item);
                const presetDisplay = applicablePreset
                    ? `<span class="badge badge-info" title="Preset disponible: ${applicablePreset.name}">Preset</span>`
                    : '<span style="color: #94a3b8; font-size: 0.75rem;">‚Äî</span>';
                
                const isSelected = planReviewState.selectedItems.has(item.item_id);
                
                return `
                    <tr data-testid="plan-item-row-${item.item_id}">
                        <td>
                            <input 
                                type="checkbox" 
                                class="batch-item-checkbox"
                                data-item-id="${item.item_id}"
                                ${isSelected ? 'checked' : ''}
                                onchange="toggleItemSelection('${item.item_id}')"
                            >
                        </td>
                        <td><code>${item.item_id || 'N/A'}</code></td>
                        <td>${item.tipo_doc || 'N/A'}</td>
                        <td>${item.empresa || ''} / ${item.elemento || ''}</td>
                        <td>${item.periodo || 'N/A'}</td>
                        <td>
                            ${getDecisionBadge(item.decision)}
                            ${decisionBadge}
                        </td>
                        <td>
                            ${item.reason_code ? `<span class="badge badge-falta">${item.reason_code}</span>` : ''}
                            ${item.reason ? `<div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">${item.reason}</div>` : ''}
                        </td>
                        <td>${hintsDisplay}</td>
                        <td>${presetDisplay}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="handleViewDebug('${item.item_id}')" data-testid="plan-item-debug-${item.item_id}">
                                Ver debug
                            </button>
                            <button class="btn btn-primary" onclick="handleDecide('${item.item_id}')" data-testid="plan-item-decide-${item.item_id}">
                                ${hasDecision ? 'Editar' : 'Decidir'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // SPRINT C2.20A: Batch selection functions
        function toggleItemSelection(itemId) {
            if (planReviewState.selectedItems.has(itemId)) {
                planReviewState.selectedItems.delete(itemId);
            } else {
                planReviewState.selectedItems.add(itemId);
            }
            updateBatchActionsBar();
        }
        
        function toggleSelectAll() {
            const checkbox = document.getElementById('batch-select-all');
            const checkboxes = document.querySelectorAll('.batch-item-checkbox');
            
            checkboxes.forEach(cb => {
                const itemId = cb.getAttribute('data-item-id');
                if (checkbox.checked) {
                    planReviewState.selectedItems.add(itemId);
                    cb.checked = true;
                } else {
                    planReviewState.selectedItems.delete(itemId);
                    cb.checked = false;
                }
            });
            
            updateBatchActionsBar();
        }
        
        function clearBatchSelection() {
            planReviewState.selectedItems.clear();
            document.querySelectorAll('.batch-item-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('batch-select-all').checked = false;
            updateBatchActionsBar();
        }
        
        function updateBatchActionsBar() {
            const count = planReviewState.selectedItems.size;
            const bar = document.getElementById('batch-actions-bar');
            const countEl = document.querySelector('[data-testid="batch-selected-count"]');
            
            if (countEl) {
                countEl.textContent = count;
            }
            
            if (bar) {
                bar.style.display = count > 0 ? 'block' : 'none';
            }
        }
        
        // SPRINT C2.20A: Presets functions
        async function loadPresetsCache() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/presets/decision_presets?include_disabled=false`);
                if (response.ok) {
                    const data = await response.json();
                    planReviewState.presetsCache = data.presets || [];
                }
            } catch (e) {
                console.warn('[repo] Error loading presets cache:', e);
                planReviewState.presetsCache = [];
            }
        }
        
        function findApplicablePreset(item) {
            if (!planReviewState.presetsCache) return null;
            
            for (const preset of planReviewState.presetsCache) {
                if (!preset.is_enabled) continue;
                
                // Verificar scope
                if (preset.scope.type_id !== item.type_id) continue;
                if (preset.scope.subject_key && preset.scope.subject_key !== item.empresa) continue;
                if (preset.scope.period_key && preset.scope.period_key !== item.periodo) continue;
                
                return preset;
            }
            
            return null;
        }
        
        function getDecisionBadge(decision) {
            const badges = {
                'AUTO_UPLOAD': '<span class="badge badge-ok">AUTO_UPLOAD</span>',
                'REVIEW_REQUIRED': '<span class="badge badge-falta">REVIEW_REQUIRED</span>',
                'NO_MATCH': '<span class="badge badge-tarde">NO_MATCH</span>',
                'SKIPPED': '<span class="badge badge-info">SKIPPED</span>',
            };
            return badges[decision] || `<span class="badge">${decision || 'UNKNOWN'}</span>`;
        }
        
        async function handleLoadPlan() {
            const input = document.getElementById('plan-id-input');
            const planId = input.value.trim();
            if (!planId) {
                alert('Por favor ingresa un plan_id');
                return;
            }
            
            await loadPlanData(planId);
        }
        
        async function loadPlanData(planId) {
            const content = document.getElementById('page-content');
            content.innerHTML = '<div class="loading">Cargando plan...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/plans/${planId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Plan ${planId} no encontrado`);
                    }
                    throw new Error(`Error al cargar plan: ${response.statusText}`);
                }
                
                const data = await response.json();
                planReviewState.planId = planId;
                planReviewState.planData = data;
                
                // Cargar draft desde localStorage
                const savedDraft = localStorage.getItem(`plan_review_draft_${planId}`);
                if (savedDraft) {
                    try {
                        planReviewState.draftDecisions = JSON.parse(savedDraft);
                    } catch (e) {
                        console.warn('[repo] Error loading draft:', e);
                    }
                }
                
                // Guardar plan_id en localStorage
                localStorage.setItem('plan_review_last_plan_id', planId);
                
                renderPlanReview();
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                    <button class="btn btn-secondary" onclick="renderPlanReview()">Volver</button>
                `;
            }
        }
        
        async function handleViewDebug(itemId) {
            const modal = document.getElementById('debug-modal');
            const modalBody = document.getElementById('debug-modal-body');
            modal.style.display = 'flex';
            modalBody.innerHTML = '<div class="loading">Cargando debug...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/runs/${planReviewState.planId}/matching_debug/${itemId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        modalBody.innerHTML = '<div class="alert alert-warning">No hay debug generado para este item.</div>';
                        return;
                    }
                    throw new Error(`Error: ${response.statusText}`);
                }
                
                const debug = await response.json();
                // Guardar en cache para mostrar hints en tabla
                if (!planReviewState.debugCache) {
                    planReviewState.debugCache = {};
                }
                planReviewState.debugCache[itemId] = debug;
                modalBody.innerHTML = renderDebugContent(debug);
            } catch (error) {
                modalBody.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        function renderDebugContent(debug) {
            const outcome = debug.outcome || {};
            const pipeline = debug.pipeline || [];
            const candidates = debug.candidates_top || [];
            
            return `
                <div>
                    <h4>Outcome</h4>
                    <div class="alert ${outcome.primary_reason_code === 'REPO_EMPTY' ? 'alert-error' : 'alert-info'}">
                        <strong>Decision:</strong> ${outcome.decision || 'N/A'}<br>
                        <strong>Reason Code:</strong> ${outcome.primary_reason_code || 'N/A'}<br>
                        <strong>Hint:</strong> ${outcome.human_hint || 'N/A'}
                    </div>
                    
                    <h4 style="margin-top: 24px;">Pipeline Steps</h4>
                    <table style="margin-top: 12px;">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Input</th>
                                <th>Output</th>
                                <th>Rule</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pipeline.map(step => `
                                <tr>
                                    <td>${step.step_name}</td>
                                    <td>${step.input_count}</td>
                                    <td>${step.output_count}</td>
                                    <td><code style="font-size: 0.75rem;">${step.rule || 'N/A'}</code></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    ${candidates.length > 0 ? `
                        <h4 style="margin-top: 24px;">Top Candidates</h4>
                        <table style="margin-top: 12px;">
                            <thead>
                                <tr>
                                    <th>Doc ID</th>
                                    <th>Type</th>
                                    <th>Score</th>
                                    <th>Reject Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${candidates.map(c => `
                                    <tr>
                                        <td><code>${c.doc_id}</code></td>
                                        <td>${c.type_id}</td>
                                        <td>${c.score_breakdown ? JSON.stringify(c.score_breakdown) : 'N/A'}</td>
                                        <td>${c.reject_reason || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    ${outcome.applied_hints && outcome.applied_hints.length > 0 ? `
                        <div data-testid="debug-hints-section" style="margin-top: 24px;">
                            <h4>Learning Hints Aplicados</h4>
                            <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 12px;">
                                ${outcome.applied_hints.length} hint(s) aplicado(s) durante el matching
                            </p>
                            <table style="margin-top: 12px;">
                                <thead>
                                    <tr>
                                        <th>Hint ID</th>
                                        <th>Strength</th>
                                        <th>Effect</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${outcome.applied_hints.map((hint, idx) => {
                                        const effectBadge = hint.effect === 'resolved' 
                                            ? '<span class="badge badge-ok">resolved</span>'
                                            : hint.effect === 'boosted'
                                            ? '<span class="badge badge-info">boosted</span>'
                                            : '<span class="badge badge-tarde">ignored</span>';
                                        const strengthBadge = hint.strength === 'EXACT'
                                            ? '<span class="badge badge-ok">EXACT</span>'
                                            : '<span class="badge badge-info">SOFT</span>';
                                        return `
                                            <tr data-testid="debug-hint-row-${hint.hint_id}">
                                                <td>
                                                    <code style="font-size: 0.75rem; cursor: pointer; color: #3b82f6;" 
                                                          onclick="openLearningPanel('${hint.hint_id}')" 
                                                          title="Ver detalles del hint">
                                                        ${hint.hint_id}
                                                    </code>
                                                </td>
                                                <td>${strengthBadge}</td>
                                                <td>${effectBadge}</td>
                                                <td style="font-size: 0.875rem; color: #94a3b8;">${hint.reason || 'N/A'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function closeDebugModal() {
            document.getElementById('debug-modal').style.display = 'none';
        }
        
        async function handleDecide(itemId) {
            const modal = document.getElementById('decide-modal');
            const modalBody = document.getElementById('decide-modal-body');
            modal.style.display = 'flex';
            
            // Cargar debug para obtener candidates si existe
            let debugData = null;
            try {
                const response = await fetch(`${BACKEND_URL}/api/runs/${planReviewState.planId}/matching_debug/${itemId}`);
                if (response.ok) {
                    debugData = await response.json();
                }
            } catch (e) {
                console.warn('[repo] Error loading debug for decide:', e);
            }
            
            const existingDecision = planReviewState.draftDecisions[itemId];
            
            modalBody.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Acci√≥n</label>
                    <select id="decision-action-select" class="form-input" data-testid="decision-action-select" onchange="updateDecideForm()">
                        <option value="">Selecciona...</option>
                        <option value="MARK_AS_MATCH" ${existingDecision?.action === 'MARK_AS_MATCH' ? 'selected' : ''}>MARK_AS_MATCH</option>
                        <option value="FORCE_UPLOAD" ${existingDecision?.action === 'FORCE_UPLOAD' ? 'selected' : ''}>FORCE_UPLOAD</option>
                        <option value="SKIP" ${existingDecision?.action === 'SKIP' ? 'selected' : ''}>SKIP</option>
                    </select>
                </div>
                
                <div id="decide-form-content">
                    <!-- Se llena din√°micamente seg√∫n acci√≥n -->
                </div>
                
                <div class="form-group">
                    <label class="form-label">Raz√≥n / Notas</label>
                    <textarea 
                        id="decision-reason-input" 
                        class="form-input" 
                        rows="3" 
                        data-testid="decision-reason-input"
                        placeholder="Explica la raz√≥n de esta decisi√≥n..."
                    >${existingDecision?.reason || ''}</textarea>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="saveItemDecision('${itemId}')" data-testid="decision-save-item">
                        Guardar Decisi√≥n
                    </button>
                    <button class="btn btn-secondary" onclick="closeDecideModal()">
                        Cancelar
                    </button>
                </div>
            `;
            
            // Inicializar formulario
            updateDecideForm(debugData, existingDecision);
        }
        
        function updateDecideForm(debugData = null, existingDecision = null) {
            const actionSelect = document.getElementById('decision-action-select');
            const contentDiv = document.getElementById('decide-form-content');
            const action = actionSelect.value;
            
            if (!action) {
                contentDiv.innerHTML = '';
                return;
            }
            
            if (action === 'MARK_AS_MATCH') {
                const candidates = debugData?.candidates_top || [];
                const candidatesHtml = candidates.length > 0 
                    ? candidates.map(c => `
                        <label style="display: flex; align-items: center; padding: 8px; background: #1e293b; border-radius: 4px; margin-bottom: 8px; cursor: pointer;">
                            <input 
                                type="radio" 
                                name="chosen-doc-id" 
                                value="${c.doc_id}" 
                                style="margin-right: 8px;"
                                ${existingDecision?.chosen_local_doc_id === c.doc_id ? 'checked' : ''}
                            >
                            <div>
                                <strong>${c.doc_id}</strong> - ${c.type_id}<br>
                                <small style="color: #94a3b8;">${c.file_path || 'N/A'}</small>
                            </div>
                        </label>
                    `).join('')
                    : '<p style="color: #94a3b8; font-size: 0.875rem;">No hay candidates disponibles en el debug.</p>';
                
                contentDiv.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Documento Local</label>
                        ${candidatesHtml}
                        <div style="margin-top: 12px;">
                            <label class="form-label">O pegar doc_id manualmente:</label>
                            <input 
                                type="text" 
                                id="decision-docid-input" 
                                class="form-input" 
                                data-testid="decision-docid-input"
                                placeholder="doc_abc123..."
                                value="${existingDecision?.chosen_local_doc_id || ''}"
                            >
                        </div>
                    </div>
                `;
            } else if (action === 'FORCE_UPLOAD') {
                contentDiv.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Ruta del Archivo</label>
                        <input 
                            type="text" 
                            id="decision-filepath-input" 
                            class="form-input" 
                            data-testid="decision-filepath-input"
                            placeholder="Dentro de repository_root_dir/data_dir"
                            value="${existingDecision?.chosen_file_path || ''}"
                        >
                        <p class="form-help">Debe estar dentro del repositorio; el servidor valida.</p>
                    </div>
                `;
            } else if (action === 'SKIP') {
                contentDiv.innerHTML = `
                    <div class="alert alert-warning">
                        Esta acci√≥n marcar√° el item como DO_NOT_UPLOAD.
                    </div>
                `;
            }
        }
        
        function saveItemDecision(itemId) {
            const actionSelect = document.getElementById('decision-action-select');
            const reasonInput = document.getElementById('decision-reason-input');
            const action = actionSelect.value;
            const reason = reasonInput.value.trim();
            
            if (!action) {
                alert('Por favor selecciona una acci√≥n');
                return;
            }
            
            if (!reason) {
                alert('Por favor ingresa una raz√≥n');
                return;
            }
            
            const decision = {
                item_id: itemId,
                action: action,
                reason: reason,
            };
            
            if (action === 'MARK_AS_MATCH') {
                const docIdRadio = document.querySelector('input[name="chosen-doc-id"]:checked');
                const docIdInput = document.getElementById('decision-docid-input');
                const chosenDocId = docIdRadio ? docIdRadio.value : (docIdInput ? docIdInput.value.trim() : '');
                
                if (!chosenDocId) {
                    alert('Por favor selecciona o ingresa un doc_id');
                    return;
                }
                
                decision.chosen_local_doc_id = chosenDocId;
            } else if (action === 'FORCE_UPLOAD') {
                const filePathInput = document.getElementById('decision-filepath-input');
                const chosenFilePath = filePathInput ? filePathInput.value.trim() : '';
                
                if (!chosenFilePath) {
                    alert('Por favor ingresa una ruta de archivo');
                    return;
                }
                
                decision.chosen_file_path = chosenFilePath;
            }
            
            planReviewState.draftDecisions[itemId] = decision;
            
            // Guardar en localStorage
            localStorage.setItem(`plan_review_draft_${planReviewState.planId}`, JSON.stringify(planReviewState.draftDecisions));
            
            closeDecideModal();
            renderPlanReview();
        }
        
        function closeDecideModal() {
            document.getElementById('decide-modal').style.display = 'none';
        }
        
        // SPRINT C2.19A.1: Learning Panel
        async function openLearningPanel(hintIdToFocus = null) {
            const modal = document.getElementById('learning-modal');
            const modalBody = document.getElementById('learning-modal-body');
            modal.style.display = 'flex';
            
            // Cargar filtros guardados
            const savedFilters = localStorage.getItem('learning_last_filters');
            const filters = savedFilters ? JSON.parse(savedFilters) : { type_id: '', subject_key: '', period_key: '' };
            
            modalBody.innerHTML = renderLearningPanel(filters, hintIdToFocus);
            
            // Si hay hintIdToFocus, buscar y resaltar
            if (hintIdToFocus) {
                await loadLearningHints(filters, hintIdToFocus);
            } else {
                await loadLearningHints(filters);
            }
        }
        
        function renderLearningPanel(filters, hintIdToFocus = null) {
            return `
                <div>
                    <div class="card" style="margin-bottom: 16px;">
                        <h4>Filtros</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                            <div class="form-group">
                                <label class="form-label">Type ID</label>
                                <input 
                                    type="text" 
                                    id="learning-filter-type" 
                                    class="form-input" 
                                    data-testid="learning-filter-type"
                                    placeholder="T104_AUTONOMOS_RECEIPT"
                                    value="${filters.type_id || ''}"
                                >
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subject Key</label>
                                <input 
                                    type="text" 
                                    id="learning-filter-subject" 
                                    class="form-input" 
                                    data-testid="learning-filter-subject"
                                    placeholder="COMPANY123"
                                    value="${filters.subject_key || ''}"
                                >
                            </div>
                            <div class="form-group">
                                <label class="form-label">Period Key</label>
                                <input 
                                    type="text" 
                                    id="learning-filter-period" 
                                    class="form-input" 
                                    data-testid="learning-filter-period"
                                    placeholder="2025-01"
                                    value="${filters.period_key || ''}"
                                >
                            </div>
                        </div>
                        <button 
                            class="btn btn-primary" 
                            onclick="loadLearningHints()" 
                            data-testid="learning-search"
                        >
                            Buscar
                        </button>
                    </div>
                    
                    <div id="learning-results" data-testid="learning-table">
                        <div class="loading">Cargando hints...</div>
                    </div>
                </div>
            `;
        }
        
        async function loadLearningHints(filters = null, hintIdToFocus = null) {
            const resultsDiv = document.getElementById('learning-results');
            if (!resultsDiv) return;
            
            // Obtener filtros del formulario si no se proporcionan
            if (!filters) {
                filters = {
                    type_id: document.getElementById('learning-filter-type')?.value || '',
                    subject_key: document.getElementById('learning-filter-subject')?.value || '',
                    period_key: document.getElementById('learning-filter-period')?.value || '',
                };
            }
            
            // Guardar filtros
            localStorage.setItem('learning_last_filters', JSON.stringify(filters));
            
            resultsDiv.innerHTML = '<div class="loading">Buscando hints...</div>';
            
            try {
                const params = new URLSearchParams();
                if (filters.type_id) params.append('type_id', filters.type_id);
                if (filters.subject_key) params.append('subject_key', filters.subject_key);
                if (filters.period_key) params.append('period_key', filters.period_key);
                params.append('include_disabled', 'true');
                params.append('limit', '200');
                
                const response = await fetch(`${BACKEND_URL}/api/learning/hints?${params}`);
                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }
                
                const data = await response.json();
                const hints = data.hints || [];
                
                if (hints.length === 0) {
                    resultsDiv.innerHTML = '<div class="alert alert-info">No se encontraron hints con estos filtros.</div>';
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <div class="card">
                        <h4>Resultados (${data.total} total, ${data.returned} mostrados)</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Hint ID</th>
                                        <th>Strength</th>
                                        <th>Type ID</th>
                                        <th>Subject</th>
                                        <th>Period</th>
                                        <th>Local Doc ID</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${hints.map(hint => {
                                        const isDisabled = hint.disabled || false;
                                        const isFocused = hintIdToFocus && hint.hint_id === hintIdToFocus;
                                        const rowStyle = isFocused ? 'background: #1e3a8a;' : '';
                                        const strengthBadge = hint.strength === 'EXACT'
                                            ? '<span class="badge badge-ok">EXACT</span>'
                                            : '<span class="badge badge-info">SOFT</span>';
                                        const disabledBadge = isDisabled
                                            ? '<span class="badge badge-tarde">Disabled</span>'
                                            : '<span class="badge badge-ok">Active</span>';
                                        
                                        return `
                                            <tr style="${rowStyle}" data-hint-id="${hint.hint_id}">
                                                <td>
                                                    <code style="font-size: 0.75rem;">${hint.hint_id}</code>
                                                    <button 
                                                        onclick="copyToClipboard('${hint.hint_id}')" 
                                                        style="margin-left: 4px; padding: 2px 6px; font-size: 0.7rem;"
                                                        title="Copiar hint_id"
                                                    >
                                                        üìã
                                                    </button>
                                                </td>
                                                <td>${strengthBadge}</td>
                                                <td><code>${hint.learned_mapping?.type_id_expected || 'N/A'}</code></td>
                                                <td>${hint.conditions?.subject_key || 'N/A'}</td>
                                                <td>${hint.conditions?.period_key || 'N/A'}</td>
                                                <td><code>${hint.learned_mapping?.local_doc_id || 'N/A'}</code></td>
                                                <td>${disabledBadge}</td>
                                                <td>
                                                    ${!isDisabled ? `
                                                        <button 
                                                            class="btn btn-secondary" 
                                                            onclick="handleDisableHint('${hint.hint_id}')"
                                                            data-testid="learning-disable-${hint.hint_id}"
                                                        >
                                                            Disable
                                                        </button>
                                                    ` : '<span style="color: #94a3b8;">Ya desactivado</span>'}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Scroll a hint si est√° enfocado
                if (hintIdToFocus) {
                    const focusedRow = document.querySelector(`tr[data-hint-id="${hintIdToFocus}"]`);
                    if (focusedRow) {
                        focusedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        async function handleDisableHint(hintId) {
            const reason = prompt('Raz√≥n para desactivar (opcional):');
            if (reason === null) return; // Usuario cancel√≥
            
            if (!confirm(`¬øDesactivar hint ${hintId}?`)) {
                return;
            }
            
            try {
                const body = reason ? { reason } : {};
                const response = await fetch(`${BACKEND_URL}/api/learning/hints/${hintId}/disable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error: ${response.statusText}`);
                }
                
                // Recargar lista
                await loadLearningHints();
                alert('Hint desactivado correctamente');
            } catch (error) {
                alert(`Error al desactivar hint: ${error.message}`);
            }
        }
        
        function closeLearningModal() {
            document.getElementById('learning-modal').style.display = 'none';
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`Copiado: ${text}`);
            }).catch(err => {
                console.error('Error copying:', err);
            });
        }
        
        // SPRINT C2.20A: Batch Actions
        function handleBatchAction(action) {
            const selectedCount = planReviewState.selectedItems.size;
            if (selectedCount === 0) {
                alert('No hay items seleccionados');
                return;
            }
            
            const modal = document.getElementById('batch-action-modal');
            const modalBody = document.getElementById('batch-action-modal-body');
            const modalTitle = document.getElementById('batch-action-modal-title');
            
            modal.style.display = 'flex';
            modalTitle.textContent = `Aplicar ${action} a ${selectedCount} item(s)`;
            
            let formHtml = '';
            
            if (action === 'SKIP') {
                formHtml = `
                    <div class="form-group">
                        <label class="form-label">Raz√≥n (requerido)</label>
                        <textarea 
                            id="batch-reason-input" 
                            class="form-input" 
                            rows="3" 
                            placeholder="Raz√≥n para saltar estos items..."
                            required
                        ></textarea>
                    </div>
                `;
            } else if (action === 'FORCE_UPLOAD') {
                formHtml = `
                    <div class="form-group">
                        <label class="form-label">Ruta del Archivo (requerido)</label>
                        <input 
                            type="text" 
                            id="batch-filepath-input" 
                            class="form-input" 
                            placeholder="Ruta relativa o absoluta del archivo..."
                            required
                        >
                        <p class="form-help">Debe estar dentro del repositorio; el servidor valida.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Raz√≥n (opcional)</label>
                        <textarea 
                            id="batch-reason-input" 
                            class="form-input" 
                            rows="2" 
                            placeholder="Raz√≥n opcional..."
                        ></textarea>
                    </div>
                `;
            } else if (action === 'MARK_AS_MATCH') {
                formHtml = `
                    <div class="form-group">
                        <label class="form-label">Local Doc ID (requerido)</label>
                        <input 
                            type="text" 
                            id="batch-docid-input" 
                            class="form-input" 
                            placeholder="doc_abc123..."
                            required
                        >
                        <p class="form-help">ID del documento local a vincular. Debe ser el mismo para todos los items seleccionados.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Raz√≥n (opcional)</label>
                        <textarea 
                            id="batch-reason-input" 
                            class="form-input" 
                            rows="2" 
                            placeholder="Raz√≥n opcional..."
                        ></textarea>
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                ${formHtml}
                <div style="display: flex; gap: 8px; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="applyBatchAction('${action}')">
                        Aplicar a ${selectedCount} item(s)
                    </button>
                    <button class="btn btn-secondary" onclick="closeBatchActionModal()">
                        Cancelar
                    </button>
                </div>
            `;
        }
        
        function applyBatchAction(action) {
            const selectedItems = Array.from(planReviewState.selectedItems);
            if (selectedItems.length === 0) {
                alert('No hay items seleccionados');
                return;
            }
            
            let reason = '';
            let filePath = '';
            let docId = '';
            
            const reasonInput = document.getElementById('batch-reason-input');
            if (reasonInput) {
                reason = reasonInput.value.trim();
            }
            
            if (action === 'SKIP') {
                if (!reason) {
                    alert('La raz√≥n es requerida para SKIP');
                    return;
                }
            } else if (action === 'FORCE_UPLOAD') {
                const filePathInput = document.getElementById('batch-filepath-input');
                if (!filePathInput || !filePathInput.value.trim()) {
                    alert('La ruta del archivo es requerida para FORCE_UPLOAD');
                    return;
                }
                filePath = filePathInput.value.trim();
            } else if (action === 'MARK_AS_MATCH') {
                const docIdInput = document.getElementById('batch-docid-input');
                if (!docIdInput || !docIdInput.value.trim()) {
                    alert('El Local Doc ID es requerido para MARK_AS_MATCH');
                    return;
                }
                docId = docIdInput.value.trim();
            }
            
            // Aplicar a todos los items seleccionados
            selectedItems.forEach(itemId => {
                const decision = {
                    action: action,
                    reason: reason || `Batch ${action} applied`,
                    decided_by: 'human',
                };
                
                if (action === 'FORCE_UPLOAD') {
                    decision.chosen_file_path = filePath;
                } else if (action === 'MARK_AS_MATCH') {
                    decision.chosen_local_doc_id = docId;
                }
                
                planReviewState.draftDecisions[itemId] = decision;
            });
            
            // SPRINT C2.20B: Registrar batch action (se registrar√° cuando se guarde el decision pack)
            
            // Guardar en localStorage
            localStorage.setItem(`plan_review_draft_${planReviewState.planId}`, JSON.stringify(planReviewState.draftDecisions));
            
            // Limpiar selecci√≥n
            clearBatchSelection();
            
            // Cerrar modal y refrescar
            closeBatchActionModal();
            renderPlanReview();
            
            alert(`Aplicado ${action} a ${selectedItems.length} item(s)`);
        }
        
        function closeBatchActionModal() {
            document.getElementById('batch-action-modal').style.display = 'none';
        }
        
        async function handleBatchApplyPreset() {
            const selectedCount = planReviewState.selectedItems.size;
            if (selectedCount === 0) {
                alert('No hay items seleccionados');
                return;
            }
            
            // Cargar presets si no est√°n en cache
            if (!planReviewState.presetsCache) {
                await loadPresetsCache();
            }
            
            if (!planReviewState.presetsCache || planReviewState.presetsCache.length === 0) {
                alert('No hay presets disponibles. Crea uno primero desde el panel Presets.');
                return;
            }
            
            // Mostrar selector de preset
            const presetOptions = planReviewState.presetsCache
                .filter(p => p.is_enabled)
                .map(p => `<option value="${p.preset_id}">${p.name} (${p.action})</option>`)
                .join('');
            
            const presetId = prompt(`Selecciona un preset:\n\n${planReviewState.presetsCache.filter(p => p.is_enabled).map((p, i) => `${i + 1}. ${p.name} (${p.action})`).join('\n')}\n\nIngresa el n√∫mero o el preset_id:`, '');
            
            if (!presetId) return;
            
            // Buscar preset por n√∫mero o ID
            let preset = null;
            const presetIndex = parseInt(presetId) - 1;
            const enabledPresets = planReviewState.presetsCache.filter(p => p.is_enabled);
            
            if (!isNaN(presetIndex) && presetIndex >= 0 && presetIndex < enabledPresets.length) {
                preset = enabledPresets[presetIndex];
            } else {
                preset = planReviewState.presetsCache.find(p => p.preset_id === presetId && p.is_enabled);
            }
            
            if (!preset) {
                alert('Preset no encontrado');
                return;
            }
            
            // Aplicar preset a items seleccionados
            const selectedItems = Array.from(planReviewState.selectedItems);
            let appliedCount = 0;
            
            selectedItems.forEach(itemId => {
                const item = planReviewState.planData.items.find(i => i.item_id === itemId);
                if (!item) return;
                
                // Verificar si el preset aplica a este item
                if (preset.scope.type_id !== item.type_id) return;
                if (preset.scope.subject_key && preset.scope.subject_key !== item.empresa) return;
                if (preset.scope.period_key && preset.scope.period_key !== item.periodo) return;
                
                const decision = {
                    action: preset.action,
                    reason: `Applied preset: ${preset.name}${preset.defaults.reason ? ` - ${preset.defaults.reason}` : ''}`,
                    decided_by: 'human',
                };
                
                if (preset.action === 'FORCE_UPLOAD' && preset.defaults.file_path) {
                    decision.chosen_file_path = preset.defaults.file_path;
                } else if (preset.action === 'MARK_AS_MATCH' && preset.defaults.local_doc_id) {
                    decision.chosen_local_doc_id = preset.defaults.local_doc_id;
                }
                
                planReviewState.draftDecisions[itemId] = decision;
                appliedCount++;
            });
            
            // SPRINT C2.20B: Registrar aplicaci√≥n de preset
            if (appliedCount > 0 && planReviewState.planId) {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/runs/${planReviewState.planId}/metrics`);
                    if (response.ok) {
                        // M√©tricas existen, registrar preset aplicado
                        // Nota: Esto requiere un endpoint adicional o actualizar directamente
                        // Por ahora, se registrar√° cuando se guarde el decision pack
                    }
                } catch (e) {
                    console.warn('[repo] Error recording preset applied:', e);
                }
            }
            
            if (appliedCount === 0) {
                alert('El preset no aplica a ninguno de los items seleccionados');
                return;
            }
            
            // Guardar en localStorage
            localStorage.setItem(`plan_review_draft_${planReviewState.planId}`, JSON.stringify(planReviewState.draftDecisions));
            
            // Limpiar selecci√≥n
            clearBatchSelection();
            
            // Refrescar
            renderPlanReview();
            
            alert(`Aplicado preset "${preset.name}" a ${appliedCount} item(s)`);
        }
        
        // SPRINT C2.20A: Presets Manager
        async function openPresetsPanel() {
            const modal = document.getElementById('presets-modal');
            const modalBody = document.getElementById('presets-modal-body');
            modal.style.display = 'flex';
            
            await loadPresetsList();
        }
        
        async function loadPresetsList() {
            const modalBody = document.getElementById('presets-modal-body');
            modalBody.innerHTML = '<div class="loading">Cargando presets...</div>';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/presets/decision_presets?include_disabled=true`);
                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }
                
                const data = await response.json();
                const presets = data.presets || [];
                
                // Actualizar cache
                planReviewState.presetsCache = presets.filter(p => p.is_enabled);
                
                modalBody.innerHTML = `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Presets Existentes</h4>
                            <button class="btn btn-primary" onclick="showCreatePresetForm()" data-testid="presets-save">
                                Crear Nuevo Preset
                            </button>
                        </div>
                        
                        ${presets.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Action</th>
                                            <th>Scope</th>
                                            <th>Defaults</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${presets.map(p => {
                                            const scopeStr = `${p.scope.type_id}${p.scope.subject_key ? ` / ${p.scope.subject_key}` : ''}${p.scope.period_key ? ` / ${p.scope.period_key}` : ''}`;
                                            const defaultsStr = p.defaults.reason || p.defaults.file_path || p.defaults.local_doc_id || 'N/A';
                                            const statusBadge = p.is_enabled 
                                                ? '<span class="badge badge-ok">Enabled</span>'
                                                : '<span class="badge badge-tarde">Disabled</span>';
                                            
                                            return `
                                                <tr>
                                                    <td><strong>${p.name}</strong></td>
                                                    <td><span class="badge badge-info">${p.action}</span></td>
                                                    <td><code style="font-size: 0.75rem;">${scopeStr}</code></td>
                                                    <td><code style="font-size: 0.75rem;">${defaultsStr}</code></td>
                                                    <td>${statusBadge}</td>
                                                    <td>
                                                        ${p.is_enabled ? `
                                                            <button 
                                                                class="btn btn-secondary" 
                                                                onclick="handleDisablePreset('${p.preset_id}')"
                                                                data-testid="presets-disable-${p.preset_id}"
                                                            >
                                                                Disable
                                                            </button>
                                                        ` : '<span style="color: #94a3b8;">Ya desactivado</span>'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #94a3b8;">No hay presets creados a√∫n.</p>'}
                        
                        <div id="create-preset-form" style="display: none; margin-top: 24px;">
                            <h4>Crear Nuevo Preset</h4>
                            <div class="form-group">
                                <label class="form-label">Nombre</label>
                                <input type="text" id="preset-name-input" class="form-input" placeholder="Skip T104">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type ID (requerido)</label>
                                <input type="text" id="preset-type-id-input" class="form-input" placeholder="T104_AUTONOMOS_RECEIPT" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subject Key (opcional)</label>
                                <input type="text" id="preset-subject-key-input" class="form-input" placeholder="COMPANY123">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Period Key (opcional)</label>
                                <input type="text" id="preset-period-key-input" class="form-input" placeholder="2025-01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Action</label>
                                <select id="preset-action-select" class="form-input">
                                    <option value="SKIP">SKIP</option>
                                    <option value="FORCE_UPLOAD">FORCE_UPLOAD</option>
                                    <option value="MARK_AS_MATCH">MARK_AS_MATCH</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Reason (para SKIP)</label>
                                <textarea id="preset-reason-input" class="form-input" rows="2" placeholder="No disponible"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default File Path (para FORCE_UPLOAD)</label>
                                <input type="text" id="preset-filepath-input" class="form-input" placeholder="path/to/file.pdf">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Local Doc ID (para MARK_AS_MATCH)</label>
                                <input type="text" id="preset-docid-input" class="form-input" placeholder="doc_abc123">
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button class="btn btn-primary" onclick="handleCreatePreset()">
                                    Guardar Preset
                                </button>
                                <button class="btn btn-secondary" onclick="hideCreatePresetForm()">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                modalBody.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        function showCreatePresetForm() {
            document.getElementById('create-preset-form').style.display = 'block';
        }
        
        function hideCreatePresetForm() {
            document.getElementById('create-preset-form').style.display = 'none';
        }
        
        async function handleCreatePreset() {
            const name = document.getElementById('preset-name-input').value.trim();
            const typeId = document.getElementById('preset-type-id-input').value.trim();
            const subjectKey = document.getElementById('preset-subject-key-input').value.trim() || null;
            const periodKey = document.getElementById('preset-period-key-input').value.trim() || null;
            const action = document.getElementById('preset-action-select').value;
            const reason = document.getElementById('preset-reason-input').value.trim() || null;
            const filePath = document.getElementById('preset-filepath-input').value.trim() || null;
            const docId = document.getElementById('preset-docid-input').value.trim() || null;
            
            if (!name || !typeId) {
                alert('Nombre y Type ID son requeridos');
                return;
            }
            
            try {
                const requestBody = {
                    name: name,
                    scope: {
                        platform: 'egestiona',
                        type_id: typeId,
                        subject_key: subjectKey,
                        period_key: periodKey,
                    },
                    action: action,
                    defaults: {},
                };
                
                if (reason) requestBody.defaults.reason = reason;
                if (filePath) requestBody.defaults.file_path = filePath;
                if (docId) requestBody.defaults.local_doc_id = docId;
                
                const response = await fetch(`${BACKEND_URL}/api/presets/decision_presets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error: ${response.statusText}`);
                }
                
                // Recargar lista
                await loadPresetsList();
                hideCreatePresetForm();
                alert('Preset creado correctamente');
            } catch (error) {
                alert(`Error al crear preset: ${error.message}`);
            }
        }
        
        async function handleDisablePreset(presetId) {
            if (!confirm(`¬øDesactivar preset ${presetId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/presets/decision_presets/${presetId}/disable`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error: ${response.statusText}`);
                }
                
                // Recargar lista
                await loadPresetsList();
                alert('Preset desactivado correctamente');
            } catch (error) {
                alert(`Error al desactivar preset: ${error.message}`);
            }
        }
        
        function closePresetsModal() {
            document.getElementById('presets-modal').style.display = 'none';
        }
        
        async function handleSaveDecisionPack() {
            const decisions = Object.values(planReviewState.draftDecisions);
            if (decisions.length === 0) {
                alert('No hay decisiones para guardar');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/plans/${planReviewState.planId}/decision_packs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decisions: decisions }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error: ${response.statusText}`);
                }
                
                const pack = await response.json();
                planReviewState.savedPackId = pack.decision_pack_id;
                
                // SPRINT C2.20B: Refrescar m√©tricas si el panel est√° abierto
                const metricsPanel = document.getElementById('metrics-panel');
                if (metricsPanel && metricsPanel.style.display !== 'none') {
                    await openMetricsPanel();
                }
                
                renderPlanReview();
                alert(`Decision Pack guardado: ${pack.decision_pack_id}`);
                
                // Auto-abrir panel de m√©tricas si est√° disponible
                setTimeout(() => {
                    if (metricsPanel) {
                        openMetricsPanel();
                    }
                }, 500);
            } catch (error) {
                alert(`Error al guardar pack: ${error.message}`);
            }
        }
        
        async function handleExecutePlan() {
            if (!planReviewState.savedPackId) {
                alert('Primero debes guardar el Decision Pack');
                return;
            }
            
            if (!confirm(`¬øEjecutar plan ${planReviewState.planId} con pack ${planReviewState.savedPackId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/runs/auto_upload/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_id: planReviewState.planId,
                        decision_pack_id: planReviewState.savedPackId,
                        max_uploads: 5,
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Error: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Mostrar resultado
                const content = document.getElementById('page-content');
                const resultHtml = `
                    <div class="alert alert-info">
                        <h4>Ejecuci√≥n completada</h4>
                        <p><strong>Status:</strong> ${result.status || 'N/A'}</p>
                        ${result.run_id ? `<p><strong>Run ID:</strong> <code>${result.run_id}</code></p>` : ''}
                        ${result.summary ? `
                            <p><strong>Resumen:</strong></p>
                            <ul>
                                <li>Total: ${result.summary.total || 0}</li>
                                <li>Success: ${result.summary.success || 0}</li>
                                <li>Failed: ${result.summary.failed || 0}</li>
                                <li>Skipped: ${result.summary.skipped || 0}</li>
                            </ul>
                        ` : ''}
                        ${result.run_id ? `
                            <a href="${BACKEND_URL}/api/runs/summary?run_id=${result.run_id}" target="_blank" style="color: #93c5fd;">
                                Ver resumen del run
                            </a>
                        ` : ''}
                    </div>
                `;
                
                content.insertAdjacentHTML('afterbegin', resultHtml);
                
                // Scroll al resultado
                content.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                alert(`Error al ejecutar: ${error.message}`);
            }
        }
    </script>
</body>
</html>

