diff --git a/frontend/repository_v3.html b/frontend/repository_v3.html
index 753f8fd..65deb9e 100644
--- a/frontend/repository_v3.html
+++ b/frontend/repository_v3.html
@@ -627,7 +627,7 @@
         }
     </style>
 </head>
-<body>
+<body data-testid="app-ready">
     <!-- Version stamp -->
     <div class="version-stamp">UI build: upload-autocomplete-v1 <span id="build-timestamp"></span></div>
     
@@ -670,6 +670,10 @@
                 <span class="nav-item-icon">­ƒô£</span>
                 Actividad
             </a>
+            <a class="nav-item" data-page="coordinacion">
+                <span class="nav-item-icon">­ƒöù</span>
+                Coordinaci├│n CAE
+            </a>
         </nav>
     </div>
     
@@ -684,10 +688,59 @@
         </div>
     </div>
     
+    <!-- SPRINT C2.9.5: Contenedor global para markers de estado de vistas (invariante) -->
+    <div id="view-state-root" style="display: none;" aria-hidden="true"></div>
+    
     <script>
+        // SPRINT C1.R0: Establecer app-ready INMEDIATAMENTE al inicio del script
+        // Esto debe ejecutarse ANTES de cualquier otra cosa para que Playwright pueda encontrarlo
+        (function() {
+            try {
+                if (document.body) {
+                    document.body.setAttribute('data-testid', 'app-ready');
+                } else if (document.documentElement) {
+                    const readyDiv = document.createElement('div');
+                    readyDiv.id = 'app-ready-marker';
+                    readyDiv.setAttribute('data-testid', 'app-ready');
+                    readyDiv.style.display = 'none';
+                    document.documentElement.appendChild(readyDiv);
+                } else {
+                    window.__app_ready__ = true;
+                }
+            } catch (e) {
+                try {
+                    window.__app_ready__ = true;
+                } catch (e2) {
+                    // Ignorar si no se puede establecer
+                }
+            }
+        })();
+        
         const BACKEND_URL = 'http://127.0.0.1:8000';
         let currentPage = 'inicio';
         
+        // INSTRUMENTACI├ôN DIAGN├ôSTICA: Logs top-level al cargar script
+        console.log('[BOOT] repository_v3 script loaded');
+        console.log('[BOOT] typeof window.ensureCalendarioLoaded:', typeof window.ensureCalendarioLoaded);
+        
+        // INSTRUMENTACI├ôN DIAGN├ôSTICA: Listeners globales de eventos
+        window.addEventListener('load', () => {
+            console.log('[EVENT] window load');
+        });
+        window.addEventListener('DOMContentLoaded', () => {
+            console.log('[EVENT] DOMContentLoaded');
+        });
+        window.addEventListener('hashchange', () => {
+            console.log('[EVENT] hashchange -> ' + location.hash);
+        });
+        window.addEventListener('beforeunload', () => {
+            console.log('[EVENT] beforeunload');
+        });
+        
+        // SPRINT C2.3.2: Cache para detectar modo E2E
+        let e2eSeedEnabled = false;
+        let healthChecked = false;
+        
         // Spanish month names
         const MONTHS_ES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
@@ -757,6 +810,14 @@
             }
         }
         
+        /**
+         * SPRINT B3.2: Logger determinista para debug de vistas
+         * Debe estar definido ANTES de initHashRouting() para evitar ReferenceError
+         */
+        function viewDbg(msg) {
+            console.log("[VIEWDBG]", Date.now(), msg);
+        }
+        
         let debugOverlay = null;
         function updateDebugOverlay(route, applied, reason) {
             if (!isDebugMode()) return;
@@ -783,8 +844,10 @@
             
             const promises = [];
             
-            if (needsTypes && calendarTypes.length === 0 && uploadTypes.length === 0 && catalogTypes.length === 0) {
-                dbg('Loading types...');
+            // Si se solicita expl├¡citamente recargar tipos (neededData.forceTypes), forzar recarga
+            const forceTypes = neededData.forceTypes === true;
+            if (needsTypes && (forceTypes || (calendarTypes.length === 0 && uploadTypes.length === 0 && catalogTypes.length === 0))) {
+                dbg('Loading types...', { forceTypes });
                 promises.push(
                     fetch(`${BACKEND_URL}/api/repository/types`)
                         .then(r => r.json())
@@ -873,59 +936,225 @@
         }
         
         // Handle hash routing
-        window.addEventListener('hashchange', async () => {
-            const { route, params } = parseHashRoute();
-            dbg('hashchange event', { route, params });
-            
-                if (route && ['inicio', 'calendario', 'subir', 'buscar', 'plataformas', 'catalogo', 'configuracion', 'actividad'].includes(route)) {
-                    // Update current page and nav without changing hash (to avoid loop)
-                    currentPage = route;
-                document.querySelectorAll('.nav-item').forEach(item => {
+        // SPRINT C1.R0: Funci├│n opcional para actualizar navbar (no bloquea routing)
+        function updateNavActive(route) {
+            try {
+                currentPage = route;
+                const navItems = document.querySelectorAll('.nav-item');
+                navItems.forEach(item => {
                     item.classList.toggle('active', item.dataset.page === route);
                 });
-                await loadPage(route, params);
+                viewDbg(`updateNavActive: updated nav for route=${route}`);
+            } catch (e) {
+                // SPRINT C1.R0.1: No bloquear si el navbar no est├í disponible
+                // Esto es opcional y no debe causar errores fatales
+                console.warn('[repo] Could not update nav active:', e);
+                // No re-lanzar el error
             }
-        });
+        }
         
-        // Check initial hash - wait for DOM to be ready
-        async function initHashRouting() {
+        // SPRINT C1.R0: Funci├│n determinista que procesa el hash actual y carga la p├ígina
+        // Hacerla global para que pueda ser llamada desde Playwright
+        // Definirla ANTES de bootstrap para que est├® disponible inmediatamente
+        async function runRoutingNow() {
             const { route, params } = parseHashRoute();
-            dbg('initHashRouting: start', { route, params });
-            
-            if (route && ['inicio', 'calendario', 'subir', 'buscar', 'plataformas', 'catalogo', 'actividad'].includes(route)) {
-                // Don't update hash if it's already correct to avoid triggering hashchange
-                const expectedHash = buildHashRoute(route, params);
-                if (window.location.hash !== expectedHash) {
-                    dbg('Updating hash from', window.location.hash, 'to', expectedHash);
-                    window.location.hash = expectedHash;
-                } else {
-                    dbg('Hash already correct, skipping update');
+            viewDbg(`runRoutingNow: hash=${window.location.hash}, route=${route}`);
+            
+            // Normalizar ruta: si no hay hash o ruta inv├ílida, usar 'inicio'
+            const validRoutes = ['inicio', 'calendario', 'subir', 'buscar', 'plataformas', 'catalogo', 'configuracion', 'actividad', 'coordinacion'];
+            const normalizedRoute = (route && validRoutes.includes(route)) ? route : 'inicio';
+            
+            // Si la ruta cambi├│, actualizar hash (sin disparar hashchange si ya es correcto)
+            const expectedHash = buildHashRoute(normalizedRoute, params);
+            if (window.location.hash !== expectedHash && normalizedRoute !== route) {
+                // Solo actualizar si realmente cambi├│
+                viewDbg(`runRoutingNow: normalizing hash from ${window.location.hash} to ${expectedHash}`);
+                window.location.hash = expectedHash;
+                // El hashchange disparar├í runRoutingNow de nuevo, as├¡ que retornar
+                return;
+            }
+            
+            // Actualizar navbar (opcional, no bloquea)
+            updateNavActive(normalizedRoute);
+            
+            // Cargar la p├ígina directamente (sin depender de .nav-item)
+            viewDbg(`runRoutingNow: calling loadPage(${normalizedRoute})`);
+            try {
+                await loadPage(normalizedRoute, params);
+                viewDbg(`runRoutingNow: loadPage(${normalizedRoute}) completed`);
+            } catch (err) {
+                console.error('[repo] Error in runRoutingNow:', err);
+                viewDbg(`runRoutingNow: loadPage failed: ${err.message}`);
+                throw err;
+            }
+        }
+        
+        // Hacer runRoutingNow global para acceso desde Playwright
+        window.runRoutingNow = runRoutingNow;
+        
+        // SPRINT C1.R0: Registrar listener de hashchange (solo registro, no ejecuta routing inicial)
+        function initHashRouting() {
+            viewDbg('initHashRouting: registering hashchange listener');
+            window.addEventListener('hashchange', async () => {
+                viewDbg('hashchange event fired');
+                try {
+                    await runRoutingNow();
+                } catch (err) {
+                    console.error('[repo] Error in hashchange handler:', err);
+                    viewDbg(`hashchange handler error: ${err.message}`);
+                }
+            });
+        }
+        
+        // SPRINT C2.3.2: Funci├│n para detectar modo E2E desde /api/health
+        async function checkE2EMode() {
+            if (healthChecked) {
+                return e2eSeedEnabled;
+            }
+            
+            try {
+                const response = await fetch(`${BACKEND_URL}/api/health`);
+                if (response.ok) {
+                    const health = await response.json();
+                    e2eSeedEnabled = health.e2e_seed_enabled === true;
+                    healthChecked = true;
+                    viewDbg(`bootstrap: E2E mode detected: ${e2eSeedEnabled}`);
+                }
+            } catch (e) {
+                console.warn('[repo] Could not check E2E mode from /api/health:', e);
+                // En caso de error, asumir modo producci├│n (no E2E)
+                e2eSeedEnabled = false;
+                healthChecked = true;
+            }
+            
+            return e2eSeedEnabled;
+        }
+        
+        // SPRINT C1.R0: Bootstrap determinista
+        async function bootstrap() {
+            try {
+                viewDbg('bootstrap: start');
+                
+                // Establecer app-ready INMEDIATAMENTE (antes de cualquier async)
+                // Usar try/catch para asegurar que siempre se establece
+                try {
+                    document.body.setAttribute('data-testid', 'app-ready');
+                    viewDbg('bootstrap: app-ready set');
+                } catch (e) {
+                    // Si body no existe a├║n, crear un div
+                    console.warn('[repo] Could not set app-ready on body:', e);
+                    const readyDiv = document.createElement('div');
+                    readyDiv.id = 'app-ready-marker';
+                    readyDiv.setAttribute('data-testid', 'app-ready');
+                    readyDiv.style.display = 'none';
+                    document.documentElement.appendChild(readyDiv);
+                    viewDbg('bootstrap: app-ready set on div');
                 }
                 
-                // Wait for DOM to be ready using deterministic barrier
-                const navItems = await waitForElement('.nav-item', 2000);
-                if (navItems) {
-                    dbg('DOM ready, loading page');
-                    currentPage = route;
-                    document.querySelectorAll('.nav-item').forEach(item => {
-                        item.classList.toggle('active', item.dataset.page === route);
-                    });
-                    await loadPage(route, params);
+                // SPRINT C2.3.2: Detectar modo E2E al bootstrap (en paralelo, no bloquea)
+                checkE2EMode().catch(() => {
+                    // Si falla, continuar sin bloquear
+                });
+                
+                // Registrar listener de hashchange
+                initHashRouting();
+                
+                // SPRINT C2.2: Event delegation para botones Editar
+                initEditDocumentDelegation();
+                
+                // Procesar hash inicial (puede venir ya con #subir)
+                viewDbg('bootstrap: calling runRoutingNow for initial hash');
+                await runRoutingNow();
+                viewDbg('bootstrap: completed');
+                
+                // INSTRUMENTACI├ôN DIAGN├ôSTICA: Flag de bootstrap completado
+                window.__REPO_BOOTSTRAP_DONE__ = true;
+                console.log('[BOOT] __REPO_BOOTSTRAP_DONE__ set to true');
+            } catch (err) {
+                // SPRINT C1.R0.1: Capturar error fatal de bootstrap
+                console.error('[BOOTSTRAP_FATAL]', err);
+                console.error('[BOOTSTRAP_FATAL] Stack:', err.stack);
+                viewDbg(`[BOOTSTRAP_FATAL] ${err.message || String(err)}`);
+                
+                // Asegurar que app-ready est├í establecido incluso si hay error
+                try {
+                    if (!document.body.hasAttribute('data-testid') || document.body.getAttribute('data-testid') !== 'app-ready') {
+                        document.body.setAttribute('data-testid', 'app-ready');
+                    }
+                } catch (e) {
+                    // Fallback: crear div
+                    if (!document.getElementById('app-ready-marker')) {
+                        const readyDiv = document.createElement('div');
+                        readyDiv.id = 'app-ready-marker';
+                        readyDiv.setAttribute('data-testid', 'app-ready');
+                        readyDiv.style.display = 'none';
+                        document.documentElement.appendChild(readyDiv);
+                    }
+                }
+                
+                // Establecer estado de error en la vista
+                try {
+                    setViewState('inicio', 'error', 'BOOTSTRAP_FATAL: ' + (err.message || String(err)));
+                } catch (e) {
+                    console.error('[BOOTSTRAP_FATAL] Could not set error state:', e);
+                }
+                
+                // No re-lanzar el error para evitar que la p├ígina se cierre
+                // El error ya est├í registrado en consola
+            }
+        }
+        
+        // SPRINT C1.R0: Funci├│n para establecer app-ready de forma robusta
+        function ensureAppReady() {
+            try {
+                if (document.body) {
+                    document.body.setAttribute('data-testid', 'app-ready');
+                    return true;
                 } else {
-                    dbg('DOM not ready after timeout, retrying...');
-                    setTimeout(initHashRouting, 50);
+                    const readyDiv = document.createElement('div');
+                    readyDiv.id = 'app-ready-marker';
+                    readyDiv.setAttribute('data-testid', 'app-ready');
+                    readyDiv.style.display = 'none';
+                    if (document.documentElement) {
+                        document.documentElement.appendChild(readyDiv);
+                        return true;
+                    }
+                }
+            } catch (e) {
+                console.error('[repo] Could not set app-ready:', e);
+                try {
+                    window.__app_ready__ = true;
+                    return true;
+                } catch (e2) {
+                    console.error('[repo] Could not set app-ready even on window:', e2);
+                    return false;
                 }
-            } else {
-                dbg('No valid route in hash');
             }
         }
         
-        // Initialize hash routing when DOM is ready
-        if (document.readyState === 'loading') {
-            document.addEventListener('DOMContentLoaded', initHashRouting);
+        // SPRINT C1.R0: Inicializar bootstrap cuando DOM est├í listo
+        // Asegurar que siempre se ejecuta, incluso si hay errores previos
+        function startBootstrap() {
+            // Establecer app-ready ANTES de llamar a bootstrap
+            ensureAppReady();
+            
+            bootstrap().catch(err => {
+                console.error('[repo] Fatal error in bootstrap:', err);
+                // Asegurar app-ready incluso en caso de error fatal
+                ensureAppReady();
+            });
+        }
+        
+        // Establecer app-ready inmediatamente si el DOM ya est├í listo
+        if (document.readyState !== 'loading') {
+            ensureAppReady();
+            startBootstrap();
         } else {
-            // DOM already loaded
-            setTimeout(initHashRouting, 0);
+            // Esperar a DOMContentLoaded
+            document.addEventListener('DOMContentLoaded', () => {
+                ensureAppReady();
+                startBootstrap();
+            }, { once: true });
         }
         
         // Helper para escapar HTML (si no existe)
@@ -955,13 +1184,14 @@
         }
         
         async function loadPage(page, params = {}) {
-            dbg('loadPage: start', { page, params });
+            viewDbg(`loadPage: start page=${page}`);
             const content = document.getElementById('page-content');
             if (!content) {
-                dbg('loadPage: page-content not found!');
+                viewDbg('loadPage: page-content not found!');
                 return;
             }
             content.innerHTML = '<div class="loading">Cargando...</div>';
+            viewDbg(`loadPage: content.innerHTML set to loading`);
             
             const titles = {
                 inicio: 'Inicio',
@@ -994,35 +1224,261 @@
             try {
             switch(page) {
                 case 'inicio':
+                    setViewState('inicio', 'loaded');
+                    try {
                         await loadInicio(params);
+                        setViewState('inicio', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadInicio:', error);
+                        setViewState('inicio', 'error', error.message || String(error));
+                        throw error; // Re-throw para que el catch externo lo maneje
+                    }
                     break;
                 case 'calendario':
-                    await loadCalendario(params);
+                    await ensureCalendarioLoaded();
                     break;
                 case 'subir':
-                    await loadSubir(params);
+                    // Establecer 'loaded' INMEDIATAMENTE antes de cualquier async
+                    setViewState('subir', 'loaded');
+                    viewDbg('subir: setViewState loaded called');
+                    try {
+                        viewDbg('subir: calling loadSubir');
+                        await loadSubir(params);
+                        viewDbg('subir: loadSubir completed, setting ready');
+                        setViewState('subir', 'ready');
+                        viewDbg('subir: setViewState ready called');
+                    } catch (error) {
+                        viewDbg(`subir: error in loadSubir: ${error.message || String(error)}`);
+                        console.error('[repo] Error in loadSubir:', error);
+                        setViewState('subir', 'error', error.message || String(error));
+                        throw error; // Re-throw para que el catch externo lo maneje
+                    }
                     break;
                 case 'buscar':
-                    await loadBuscar(params);
+                    setViewState('buscar', 'loaded');
+                    try {
+                        await loadBuscar(params);
+                        setViewState('buscar', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadBuscar:', error);
+                        setViewState('buscar', 'error', error.message || String(error));
+                        throw error; // Re-throw para que el catch externo lo maneje
+                    }
                     break;
                 case 'plataformas':
-                    await loadPlataformas(params);
+                    setViewState('plataformas', 'loaded');
+                    try {
+                        await loadPlataformas(params);
+                        setViewState('plataformas', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadPlataformas:', error);
+                        setViewState('plataformas', 'error', error.message || String(error));
+                        throw error;
+                    }
                     break;
                 case 'catalogo':
-                    await loadCatalogo(params);
+                    setViewState('catalogo', 'loaded');
+                    try {
+                        await loadCatalogo(params);
+                        setViewState('catalogo', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadCatalogo:', error);
+                        setViewState('catalogo', 'error', error.message || String(error));
+                        throw error;
+                    }
                     break;
                 case 'configuracion':
-                    loadConfiguracion();
+                case 'settings':
+                    setViewState('settings', 'loaded');
+                    try {
+                        await loadConfiguracion();
+                        setViewState('settings', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadConfiguracion:', error);
+                        setViewState('settings', 'error', error.message || String(error));
+                        throw error;
+                    }
                     break;
                 case 'actividad':
-                    await loadActividad(params);
+                    setViewState('actividad', 'loaded');
+                    try {
+                        await loadActividad(params);
+                        setViewState('actividad', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadActividad:', error);
+                        setViewState('actividad', 'error', error.message || String(error));
+                        throw error;
+                    }
+                    break;
+                case 'coordinacion':
+                    setViewState('coordinacion', 'loaded');
+                    try {
+                        await loadCoordinacion(params);
+                        setViewState('coordinacion', 'ready');
+                    } catch (error) {
+                        console.error('[repo] Error in loadCoordinacion:', error);
+                        setViewState('coordinacion', 'error', error.message || String(error));
+                        throw error; // Re-throw para que el catch externo lo maneje
+                    }
                     break;
                 }
                 clearTimeout(timeoutId);
+                // Agregar se├▒al DOM cuando la p├ígina est├í lista (legacy, mantener por compatibilidad)
+                const pageContent = document.getElementById('page-content');
+                if (pageContent) {
+                    pageContent.setAttribute('data-testid', 'page-ready');
+                    pageContent.setAttribute('data-page', page);
+                }
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error('[repo] Error loading page:', error);
                 showErrorBanner(`Error al cargar la p├ígina "${page}": ${error.message}`, error);
+                // El estado de error ya se estableci├│ en el switch, no hacer nada m├ís aqu├¡
+            }
+        }
+        
+        /**
+         * SPRINT B3.2: Logger determinista para debug de vistas
+         */
+        function dbg(msg) {
+            console.log("[VIEWDBG]", Date.now(), msg);
+        }
+        
+        /**
+         * SPRINT B3.1: Helper para establecer estado de vista de forma determinista.
+         * Cada vista emite se├▒ales: loaded (siempre), ready (├®xito), error (fallo).
+         * 
+         * @param {string} viewName - Nombre de la vista ('calendario', 'subir', 'buscar', etc.)
+         * @param {string} state - Estado: 'loaded', 'ready', 'error'
+         * @param {string} [errorMsg] - Mensaje de error si state === 'error'
+         */
+        // SPRINT C2.9.5: Obtener o crear contenedor global para markers de estado de vistas
+        function getViewStateRoot() {
+            let root = document.getElementById('view-state-root');
+            if (!root) {
+                // Si no existe, crearlo y a├▒adirlo al body
+                root = document.createElement('div');
+                root.id = 'view-state-root';
+                root.style.display = 'none';
+                root.setAttribute('aria-hidden', 'true');
+                document.body.appendChild(root);
+                console.log('[repo] view-state-root created');
+            }
+            return root;
+        }
+        
+        // SPRINT C2.9.13: Helper para crear/actualizar markers de debug
+        function setDebugMarker(testId, attrs = {}) {
+            const root = getViewStateRoot();
+            if (!root) {
+                console.warn(`[repo] Cannot set debug marker ${testId}: view-state-root not available`);
+                return;
+            }
+            let el = root.querySelector(`[data-testid="${testId}"]`);
+            if (!el) {
+                el = document.createElement('div');
+                el.setAttribute('data-testid', testId);
+                el.style.display = 'none';
+                root.appendChild(el);
+            }
+            Object.entries(attrs).forEach(([k, v]) => {
+                if (v !== null && v !== undefined) {
+                    el.setAttribute(k, String(v));
+                }
+            });
+        }
+            return root;
+        }
+        
+        function setViewState(viewName, state, errorMsg = null) {
+            // Log inmediato para debug
+            console.log('[SETVIEWSTATE]', viewName, state, 'readyState=', document.readyState, 'body exists=', !!document.body);
+            
+            // SPRINT C2.9.5: Usar contenedor global invariante para markers
+            const viewStateRoot = getViewStateRoot();
+            
+            if (!viewStateRoot) {
+                console.warn(`[repo] setViewState: view-state-root not available for view ${viewName}, state ${state}`);
+                viewDbg(`setViewState: view-state-root not available for ${viewName} ${state}`);
+                return;
+            }
+            
+            viewDbg(`setViewState: ${viewName} -> ${state} on view-state-root`);
+            
+            // SPRINT C2.9.5: Eliminar TODOS los markers previos de este viewName (loaded/ready/error)
+            const existingMarkers = viewStateRoot.querySelectorAll(`[data-view="${viewName}"]`);
+            existingMarkers.forEach(marker => {
+                marker.remove();
+            });
+            
+            // SPRINT C2.9.5: Crear EXACTAMENTE UN marker para el estado actual
+            const marker = document.createElement('div');
+            const testId = `view-${viewName}-${state}`;
+            marker.setAttribute('data-testid', testId);
+            marker.setAttribute('data-view', viewName);
+            marker.style.display = 'none';
+            marker.setAttribute('aria-hidden', 'true');
+            
+            if (state === 'error' && errorMsg) {
+                marker.setAttribute('data-error', errorMsg.substring(0, 200));
+            }
+            
+            viewStateRoot.appendChild(marker);
+            viewDbg(`setViewState: ${viewName} -> ${state} applied, testId=${testId}`);
+            
+            // SPRINT C2.9.5: A├▒adir alias para configuracion->settings (y viceversa)
+            if (viewName === 'settings') {
+                const aliasMarker = document.createElement('div');
+                const aliasTestId = `view-configuracion-${state}`;
+                aliasMarker.setAttribute('data-testid', aliasTestId);
+                aliasMarker.setAttribute('data-view', 'configuracion');
+                aliasMarker.style.display = 'none';
+                aliasMarker.setAttribute('aria-hidden', 'true');
+                if (state === 'error' && errorMsg) {
+                    aliasMarker.setAttribute('data-error', errorMsg.substring(0, 200));
+                }
+                viewStateRoot.appendChild(aliasMarker);
+                viewDbg(`setViewState: alias added: ${aliasTestId}`);
+            } else if (viewName === 'configuracion') {
+                const aliasMarker = document.createElement('div');
+                const aliasTestId = `view-settings-${state}`;
+                aliasMarker.setAttribute('data-testid', aliasTestId);
+                aliasMarker.setAttribute('data-view', 'settings');
+                aliasMarker.style.display = 'none';
+                aliasMarker.setAttribute('aria-hidden', 'true');
+                if (state === 'error' && errorMsg) {
+                    aliasMarker.setAttribute('data-error', errorMsg.substring(0, 200));
+                }
+                viewStateRoot.appendChild(aliasMarker);
+                viewDbg(`setViewState: alias added: ${aliasTestId}`);
+            }
+            
+            // SPRINT C2.9.5: Mantener compatibilidad con error container visible (si es error)
+            if (state === 'error' && errorMsg) {
+                // Buscar o crear contenedor de error visible
+                let errorDiv = document.getElementById('view-error-container');
+                const content = document.getElementById('page-content');
+                if (!errorDiv) {
+                    errorDiv = document.createElement('div');
+                    errorDiv.id = 'view-error-container';
+                    errorDiv.setAttribute('data-testid', 'view-error-msg');
+                    errorDiv.style.cssText = 'padding: 16px; margin: 16px 0; background: #7f1d1d; border: 1px solid #dc2626; border-radius: 8px; color: #fecaca;';
+                    if (content) {
+                        content.insertBefore(errorDiv, content.firstChild);
+                    } else {
+                        document.body.appendChild(errorDiv);
+                    }
+                }
+                if (errorDiv) {
+                    errorDiv.innerHTML = `<strong>Error al cargar ${viewName}:</strong> ${escapeHtml(errorMsg)}`;
+                    errorDiv.style.display = 'block';
+                }
+            } else {
+                // Ocultar mensaje de error si existe
+                const errorDiv = document.getElementById('view-error-container');
+                if (errorDiv) {
+                    errorDiv.style.display = 'none';
+                }
             }
         }
         
@@ -1220,139 +1676,1025 @@
         let selectedMonths = 24;
         let calendarPeriods = [];
         let selectedPeriod = null;
+        let calendarFilters = {
+            query: '',
+            type_id: null,
+            scope: 'all',  // 'all' | 'company' | 'worker'
+            subject_key: null
+        };
+        let calendarSubjects = { companies: [], workers_by_company: {} };
+        let calendarMaxMonthsBack = 24;  // M├íximo de meses hacia atr├ís para per├¡odos faltantes
+        
+        // Funci├│n auxiliar para formatear fechas
+        function formatDate(dateStr) {
+            if (!dateStr) return '-';
+            try {
+                const date = new Date(dateStr);
+                return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
+            } catch (e) {
+                return dateStr;
+            }
+        }
+        
+        /**
+         * SPRINT C2.6: Helper para fetch JSON con timeout usando AbortController
+         * @param {string} url - URL a fetch
+         * @param {object} opts - Opciones de fetch (default: {})
+         * @param {number} ms - Timeout en milisegundos (default: 8000)
+         * @returns {Promise<Response>} Response del fetch (sin parsear JSON, para mantener compatibilidad)
+         */
+        async function fetchJsonWithTimeout(url, opts = {}, ms = 8000) {
+            const controller = new AbortController();
+            const timeoutId = setTimeout(() => controller.abort(), ms);
+            try {
+                const response = await fetch(url, { ...opts, signal: controller.signal });
+                clearTimeout(timeoutId);
+                if (!response.ok) {
+                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
+                }
+                return response;
+            } catch (error) {
+                clearTimeout(timeoutId);
+                if (error.name === 'AbortError') {
+                    throw new Error(`Timeout after ${ms}ms: ${url}`);
+                }
+                throw error;
+            }
+        }
         
+        // SPRINT C2.9.18: Declarar funciones antes de definirlas para poder asignarlas a window
         async function loadCalendario(params = {}) {
-            dbg('loadCalendario: start', params);
+            // SPRINT C2.6: Logs clave al inicio
+            console.log('[CAL] start');
+            viewDbg('loadCalendario: start');
+            
+            // SPRINT C2.9.13: Marker de debug - inicio de loadCalendario (usando helper)
+            setDebugMarker('dbg-calendario-load-start', { 'data-ts': Date.now() });
+            
             const content = document.getElementById('page-content');
             
             // Ensure data is loaded
             await ensureRepoDataLoaded({ types: true, people: true });
             
             try {
-                // Load data if not already loaded
+                // SPRINT C2.6: Load data if not already loaded con timeout
                 if (calendarTypes.length === 0) {
-                    calendarTypes = await fetch(`${BACKEND_URL}/api/repository/types`).then(r => r.json());
+                    const typesUrl = `${BACKEND_URL}/api/repository/types`;
+                    // SPRINT C2.9.16: Instrumentar fetch de types
+                    const fetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
+                    setDebugMarker(fetchEventId, { 'data-kind': 'start', 'data-url': typesUrl, 'data-ts': Date.now() });
+                    try {
+                        const typesResponse = await fetchJsonWithTimeout(typesUrl, {}, 10000);
+                        const typesData = await typesResponse.json();
+                        // SPRINT C2.9.16: Marker de ├®xito
+                        setDebugMarker(fetchEventId, { 'data-kind': 'success', 'data-url': typesUrl, 'data-ts': Date.now() });
+                        // SPRINT C2.6: Normalizar a array si es inesperado
+                        calendarTypes = Array.isArray(typesData) ? typesData : [];
+                    } catch (error) {
+                        // SPRINT C2.9.16: Marker de fallo
+                        setDebugMarker(fetchEventId, { 'data-kind': 'fail', 'data-url': typesUrl, 'data-ts': Date.now(), 'data-error': error?.message || String(error) });
+                        throw error;
+                    }
                 }
                 if (calendarPeople.length === 0) {
-                    const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
-                    calendarPeople = peopleData.people || [];
+                    const peopleUrl = `${BACKEND_URL}/api/config/people`;
+                    // SPRINT C2.9.16: Instrumentar fetch de people
+                    const fetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
+                    setDebugMarker(fetchEventId, { 'data-kind': 'start', 'data-url': peopleUrl, 'data-ts': Date.now() });
+                    try {
+                        const peopleResponse = await fetchJsonWithTimeout(peopleUrl, {}, 10000);
+                        const peopleData = await peopleResponse.json();
+                        // SPRINT C2.9.16: Marker de ├®xito
+                        setDebugMarker(fetchEventId, { 'data-kind': 'success', 'data-url': peopleUrl, 'data-ts': Date.now() });
+                        // SPRINT C2.6: Normalizar a array si es inesperado
+                        calendarPeople = Array.isArray(peopleData?.people) ? peopleData.people : (Array.isArray(peopleData) ? peopleData : []);
+                    } catch (error) {
+                        // SPRINT C2.9.16: Marker de fallo
+                        setDebugMarker(fetchEventId, { 'data-kind': 'fail', 'data-url': peopleUrl, 'data-ts': Date.now(), 'data-error': error?.message || String(error) });
+                        console.warn('[CAL] Error loading people, using empty array:', error);
+                        calendarPeople = [];
+                    }
                 }
                 
-                const periodicTypes = calendarTypes.filter(t => {
-                    const mode = t.validity_policy?.mode;
-                    return mode === 'monthly' || mode === 'annual' || mode === 'quarter';
+                // Cargar documentos pendientes desde el nuevo endpoint
+                // SPRINT C2.3.2: Limitar max_months_back a 12 solo en modo E2E
+                // Asegurar que healthChecked est├® actualizado antes de usar
+                if (!healthChecked) {
+                    await checkE2EMode();
+                }
+                const effectiveMaxMonthsBack = e2eSeedEnabled ? Math.min(calendarMaxMonthsBack, 12) : calendarMaxMonthsBack;
+                viewDbg(`loadCalendario: max_months_back=${effectiveMaxMonthsBack} (E2E=${e2eSeedEnabled}, original=${calendarMaxMonthsBack})`);
+                viewDbg('loadCalendario: before fetch pendings');
+                
+                // SPRINT C2.9.13: Marker de debug - antes del fetch pending (usando helper)
+                setDebugMarker('dbg-calendario-before-pending-fetch', { 'data-ts': Date.now() });
+                
+                // SPRINT C2.9.6: Usar fetchJsonWithTimeout con timeout de 10s para evitar cuelgues
+                // (10s deja margen de 5s antes del timeout del helper de 15s)
+                const pendingUrl = `${BACKEND_URL}/api/repository/docs/pending?months_ahead=3&max_months_back=${effectiveMaxMonthsBack}`;
+                // SPRINT C2.9.16: Instrumentar fetch de pending
+                const pendingFetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
+                setDebugMarker(pendingFetchEventId, { 'data-kind': 'start', 'data-url': pendingUrl, 'data-ts': Date.now() });
+                let pendingResponse;
+                let pendingData;
+                try {
+                    pendingResponse = await fetchJsonWithTimeout(pendingUrl, {}, 10000);
+                    pendingData = await pendingResponse.json();
+                    // SPRINT C2.9.16: Marker de ├®xito
+                    setDebugMarker(pendingFetchEventId, { 'data-kind': 'success', 'data-url': pendingUrl, 'data-ts': Date.now() });
+                    viewDbg('loadCalendario: after fetch pendings');
+                    
+                    // SPRINT C2.6: Normalizar respuestas inesperadas
+                    const expiredRaw = Array.isArray(pendingData?.expired) ? pendingData.expired : (pendingData?.expired ? [pendingData.expired] : []);
+                    const expiringSoonRaw = Array.isArray(pendingData?.expiring_soon) ? pendingData.expiring_soon : (pendingData?.expiring_soon ? [pendingData.expiring_soon] : []);
+                    const missingRaw = Array.isArray(pendingData?.missing) ? pendingData.missing : (pendingData?.missing ? [pendingData.missing] : []);
+                
+                // SPRINT C2.6: Log clave despu├®s de fetch pendings
+                console.log('[CAL] after fetch pending', { 
+                    expired: expiredRaw.length, 
+                    expiringSoon: expiringSoonRaw.length, 
+                    missing: missingRaw.length 
                 });
+
+                if (isCalendarDebugEnabled()) {
+                    const rawPeriods = (missingRaw || []).map(x => x?.period_key).filter(Boolean);
+                    console.log('[CAL] raw pending periods count', rawPeriods.length);
+                }
+                
+                } catch (pendingError) {
+                    // SPRINT C2.9.16: Marker de fallo para pending
+                    setDebugMarker(pendingFetchEventId, { 'data-kind': 'fail', 'data-url': pendingUrl, 'data-ts': Date.now(), 'data-error': pendingError?.message || String(pendingError) });
+                    // SPRINT C2.9.16: Si falla fetch esencial, renderizar error y retornar
+                    const content = document.getElementById('page-content');
+                    if (content) {
+                        content.innerHTML = `
+                            <div class="alert alert-error" data-testid="calendar-load-error">
+                                Error cargando calendario: ${escapeHtml(pendingError?.message || String(pendingError))}
+                            </div>
+                        `;
+                    }
+                    setViewState('calendario', 'error', pendingError?.message || String(pendingError));
+                    throw pendingError;
+                }
+                
+                // Cargar subjects para obtener nombres de empresas y personas
+                let subjectsCache = { companies: {}, people: {} };
+                const subjectsUrl = `${BACKEND_URL}/api/repository/subjects`;
+                // SPRINT C2.9.16: Instrumentar fetch de subjects
+                const subjectsFetchEventId = `dbg-cal-fetch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
+                setDebugMarker(subjectsFetchEventId, { 'data-kind': 'start', 'data-url': subjectsUrl, 'data-ts': Date.now() });
+                try {
+                    // SPRINT C2.6: Usar fetchJsonWithTimeout para subjects
+                    const subjectsResponse = await fetchJsonWithTimeout(subjectsUrl, {}, 10000);
+                    const subjectsData = await subjectsResponse.json();
+                    // SPRINT C2.9.16: Marker de ├®xito
+                    setDebugMarker(subjectsFetchEventId, { 'data-kind': 'success', 'data-url': subjectsUrl, 'data-ts': Date.now() });
+                    // SPRINT C2.6: Normalizar respuestas inesperadas
+                    calendarSubjects = {
+                        companies: Array.isArray(subjectsData?.companies) ? subjectsData.companies : [],
+                        workers_by_company: typeof subjectsData?.workers_by_company === 'object' && subjectsData.workers_by_company !== null ? subjectsData.workers_by_company : {}
+                    };
+                    if (calendarSubjects.companies) {
+                        calendarSubjects.companies.forEach(c => {
+                            if (c && c.id && c.name) {
+                                subjectsCache.companies[c.id] = c.name;
+                            }
+                        });
+                    }
+                    if (calendarSubjects.workers_by_company) {
+                        Object.keys(calendarSubjects.workers_by_company).forEach(companyId => {
+                            const workers = calendarSubjects.workers_by_company[companyId];
+                            if (Array.isArray(workers)) {
+                                workers.forEach(w => {
+                                    if (w && w.id && w.name) {
+                                        subjectsCache.people[w.id] = w.name;
+                                    }
+                                });
+                            }
+                        });
+                    }
+                } catch (error) {
+                    // SPRINT C2.9.16: Marker de fallo para subjects (non-fatal, pero registramos)
+                    setDebugMarker(subjectsFetchEventId, { 'data-kind': 'fail', 'data-url': subjectsUrl, 'data-ts': Date.now(), 'data-error': error?.message || String(error) });
+                    console.warn('[CAL] Error loading subjects (non-fatal):', error);
+                    // Continuar sin subjects, usar valores por defecto
+                }
+                
+                // Aplicar filtros iniciales (pueden estar vac├¡os)
+                const filtered = applyCalendarFilters(
+                    { expired: expiredRaw, expiring_soon: expiringSoonRaw, missing: missingRaw },
+                    calendarFilters,
+                    calendarMaxMonthsBack
+                );
                 
                 content.innerHTML = `
                     <div class="card">
-                        <h3>Calendario de documentos</h3>
-                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
+                        <h2>Documentos pendientes y pr├│ximos vencimientos</h2>
+                        <p style="color: #94a3b8; margin-bottom: 24px;">
+                            Documentos expirados, pr├│ximos a expirar y per├¡odos faltantes que requieren atenci├│n.
+                        </p>
+                        
+                        <!-- Bloque de filtros (paridad con #buscar) -->
+                        <div class="catalog-filters" style="margin-bottom: 24px; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                             <div class="form-group">
-                                <label class="form-label">┬┐Qu├® documento?</label>
-                                <div class="autocomplete-container">
-                                    <input type="text" class="form-input" 
-                                           id="calendar-type-input"
-                                           placeholder="Buscar documento..."
-                                           oninput="searchCalendarType(this.value)"
-                                           onfocus="searchCalendarType(this.value)">
-                                    <div class="autocomplete-dropdown hidden" id="calendar-type-dropdown"></div>
-                                </div>
+                                <label class="form-label">Buscar</label>
+                                <input type="text" class="form-input" 
+                                       id="calendar-filter-text"
+                                       data-testid="calendar-search-input"
+                                       placeholder="Buscar por tipo, sujeto o archivoÔÇª"
+                                       value="${escapeHtml(calendarFilters.query || '')}"
+                                       oninput="debounceCalendarFilter('query', this.value)">
                             </div>
-                            <div class="form-group" id="calendar-subject-group" style="display: none;">
-                                <label class="form-label" id="calendar-subject-label">┬┐De qui├®n / qu├® empresa?</label>
-                                <div class="autocomplete-container">
-                                    <input type="text" class="form-input" 
-                                           id="calendar-subject-input"
-                                           placeholder="Buscar..."
-                                           oninput="searchCalendarSubject(this.value)"
-                                           onfocus="searchCalendarSubject(this.value)">
-                                    <div class="autocomplete-dropdown hidden" id="calendar-subject-dropdown"></div>
-                                </div>
+                            <div class="form-group">
+                                <label class="form-label">Tipo de documento</label>
+                                <select class="form-input" 
+                                        id="calendar-filter-type"
+                                        data-testid="calendar-type-select"
+                                        onchange="setCalendarFilter('type_id', this.value || null)">
+                                    <option value="">Todos los tipos</option>
+                                    ${calendarTypes.sort((a, b) => a.name.localeCompare(b.name)).map(type => `
+                                        <option value="${type.type_id}" ${calendarFilters.type_id === type.type_id ? 'selected' : ''}>${escapeHtml(type.name)}</option>
+                                    `).join('')}
+                                </select>
+                            </div>
+                            <div class="form-group">
+                                <label class="form-label">Aplica a</label>
+                                <select class="form-input" 
+                                        id="calendar-scope-select"
+                                        data-testid="calendar-scope-select"
+                                        onchange="setCalendarFilter('scope', this.value)">
+                                    <option value="all" ${calendarFilters.scope === 'all' || calendarFilters.scope === null ? 'selected' : ''}>Todos</option>
+                                    <option value="company" ${calendarFilters.scope === 'company' ? 'selected' : ''}>Empresa</option>
+                                    <option value="worker" ${calendarFilters.scope === 'worker' ? 'selected' : ''}>Trabajador</option>
+                                </select>
                             </div>
                             <div class="form-group">
-                                <label class="form-label">Rango</label>
-                                <select class="form-input" id="calendar-months" onchange="updateCalendarMonths()">
-                                    <option value="12">├Ültimos 12 meses</option>
-                                    <option value="24" selected>├Ültimos 24 meses</option>
-                                    <option value="36">├Ültimos 36 meses</option>
+                                <label class="form-label">Sujeto</label>
+                                <select class="form-input" 
+                                        id="calendar-filter-subject"
+                                        data-testid="calendar-subject-select"
+                                        onchange="setCalendarFilter('subject_key', this.value || null)">
+                                    <option value="">Todos</option>
+                                    ${(() => {
+                                        let options = [];
+                                        // Si scope es 'all' o 'company', mostrar empresas
+                                        if (calendarFilters.scope === 'all' || calendarFilters.scope === null || calendarFilters.scope === 'company') {
+                                            calendarSubjects.companies?.forEach(company => {
+                                                options.push(`<option value="${company.id}" ${calendarFilters.subject_key === company.id ? 'selected' : ''}>${escapeHtml(company.name)}</option>`);
+                                            });
+                                        }
+                                        // Si scope es 'all' o 'worker', mostrar trabajadores
+                                        if (calendarFilters.scope === 'all' || calendarFilters.scope === null || calendarFilters.scope === 'worker') {
+                                            Object.keys(calendarSubjects.workers_by_company || {}).forEach(companyId => {
+                                                const workers = calendarSubjects.workers_by_company[companyId];
+                                                workers.forEach(worker => {
+                                                    options.push(`<option value="${worker.id}" ${calendarFilters.subject_key === worker.id ? 'selected' : ''}>${escapeHtml(worker.name)}</option>`);
+                                                });
+                                            });
+                                        }
+                                        return options.join('');
+                                    })()}
                                 </select>
                             </div>
+                            <div class="form-group">
+                                <label class="form-label">M├íx. meses atr├ís</label>
+                                <input type="number" 
+                                       class="form-input" 
+                                       id="calendar-max-months-back"
+                                       data-testid="calendar-max-months-back"
+                                       min="1" 
+                                       max="120" 
+                                       value="${calendarMaxMonthsBack}"
+                                       onchange="setCalendarMaxMonthsBack(parseInt(this.value) || 24)"
+                                       oninput="setCalendarMaxMonthsBack(parseInt(this.value) || 24)"
+                                       style="max-width: 120px;">
+                                <small style="color: #94a3b8; display: block; margin-top: 4px;">L├¡mite de meses hacia atr├ís para per├¡odos faltantes</small>
+                            </div>
                         </div>
-                        <div id="calendar-grid-container"></div>
-                    </div>
-                    
-                    <!-- Side panel for selected month -->
-                    <div id="calendar-side-panel" class="card hidden" style="position: fixed; right: 24px; top: 120px; width: 350px; max-height: 80vh; overflow-y: auto; z-index: 100;">
-                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
-                            <h3 id="side-panel-title">Detalle del mes</h3>
-                            <button class="btn btn-secondary" onclick="closeCalendarSidePanel()" style="padding: 4px 12px;">Ô£ò</button>
+                        <div style="margin-bottom: 16px;">
+                            <button class="btn btn-secondary" 
+                                    onclick="clearCalendarFilters()"
+                                    data-testid="calendar-filter-clear">Limpiar filtros</button>
+                        </div>
+                        
+                        <!-- Tabs o secciones -->
+                        <div style="margin-bottom: 24px;">
+                            <div style="display: flex; gap: 8px; border-bottom: 1px solid #334155;">
+                                <button class="btn btn-secondary" onclick="showPendingSection('expired')" id="pending-tab-expired" data-testid="calendar-tab-expired" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid #3b82f6;">
+                                    Expirados <span class="badge badge-error" id="pending-count-expired">${filtered.expired.length}</span>
+                                </button>
+                                <button class="btn btn-secondary" onclick="showPendingSection('expiring_soon')" id="pending-tab-expiring_soon" data-testid="calendar-tab-expiring" style="border-radius: 4px 4px 0 0;">
+                                    Expiran pronto <span class="badge badge-warning" id="pending-count-expiring_soon">${filtered.expiringSoon.length}</span>
+                                </button>
+                                <button class="btn btn-secondary" onclick="showPendingSection('missing')" id="pending-tab-missing" data-testid="calendar-tab-pending" style="border-radius: 4px 4px 0 0;">
+                                    Pendientes de subir <span class="badge badge-info" id="pending-count-missing">${filtered.missing.length}</span>
+                                </button>
+                            </div>
+                        </div>
+                        
+                        <!-- Contenedor de resultados -->
+                        <div id="pending-documents-container" data-testid="calendar-pending-container">
+                            ${renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, 'expired')}
                         </div>
-                        <div id="side-panel-content"></div>
                     </div>
                 `;
                 
-                // Apply prefill from params using deterministic barriers
-                if (params.type_id) {
-                    dbg('Applying prefill for type_id:', params.type_id);
-                    
-                    // Wait for DOM element
-                    const typeInput = await waitForElement('#calendar-type-input');
-                    if (!typeInput) {
-                        const reason = 'calendar-type-input element not found';
-                        dbg('Prefill failed:', reason);
-                        updateDebugOverlay('calendario', false, reason);
-                        return;
-                    }
-                    
-                    // Find type
-                    const type = calendarTypes.find(t => t.type_id === params.type_id);
-                    if (!type) {
-                        const reason = `Type ${params.type_id} not found`;
-                        dbg('Prefill failed:', reason);
-                        updateDebugOverlay('calendario', false, reason);
-                        const alertDiv = document.createElement('div');
-                        alertDiv.className = 'alert alert-warning';
-                        alertDiv.innerHTML = `Tipo de documento "${params.type_id}" no encontrado. El calendario se ha cargado sin prefill.`;
-                        const contentEl = document.getElementById('page-content');
-                        if (contentEl) {
-                            contentEl.insertBefore(alertDiv, contentEl.firstChild);
-                        }
-                        return;
-                    }
-                    
-                    // Apply type selection
-                    dbg('Selecting type:', type.type_id, type.name);
-                    selectCalendarType(params.type_id);
-                    
-                    // If subject is provided, wait for subject input and select it
-                    if (params.person_key || params.company_key) {
-                        const subjectInput = await waitForElement('#calendar-subject-input');
-                        if (subjectInput) {
-                            const subjectKey = params.person_key || params.company_key;
-                            let subjectName = subjectKey;
-                            
-                            if (params.person_key && type.scope === 'worker') {
-                                const person = calendarPeople.find(p => p.worker_id === params.person_key);
-                                if (person) {
-                                    subjectName = person.full_name;
-                                }
-                            }
-                            
-                            dbg('Selecting subject:', subjectKey, subjectName);
-                            selectCalendarSubject(subjectKey, subjectName);
-                        } else {
-                            dbg('Subject input not found, skipping subject prefill');
-                        }
+                // Guardar datos globalmente para actualizaci├│n (datos RAW, sin filtrar)
+                window.pendingDocumentsDataRaw = { expired: expiredRaw, expiring_soon: expiringSoonRaw, missing: missingRaw };
+                window.pendingDocumentsData = filtered; // Datos filtrados actuales
+                window.subjectsCache = subjectsCache;
+                
+                // SPRINT B3.1: Las se├▒ales DOM ahora se establecen en loadPage() usando setViewState()
+                // Mantener calendar-ready para compatibilidad con otros tests
+                viewDbg('loadCalendario: after render table');
+                const pendingContainer = document.getElementById('pending-documents-container');
+                if (pendingContainer) {
+                    pendingContainer.setAttribute('data-testid', 'calendar-ready');
+                    // SPRINT C2.8: Asegurar que calendar-pending-container est├í presente (puede haberse perdido en el innerHTML)
+                    if (!pendingContainer.hasAttribute('data-testid') || pendingContainer.getAttribute('data-testid') !== 'calendar-pending-container') {
+                        pendingContainer.setAttribute('data-testid', 'calendar-pending-container');
                     }
-                    
-                    dbg('Prefill applied successfully');
-                    updateDebugOverlay('calendario', true, 'OK');
-                } else {
-                    updateDebugOverlay('calendario', false, 'No type_id in params');
                 }
-            } catch (error) {
-                content.innerHTML = `<div class="alert alert-error">Error al cargar calendario: ${error.message}</div>`;
-            }
+                
+                // SPRINT C2.3: Se├▒al de filtros listos (siempre se renderizan, incluso sin datos)
+                const filtersContainer = content.querySelector('.catalog-filters');
+                if (filtersContainer) {
+                    filtersContainer.setAttribute('data-testid', 'calendar-filters-ready');
+                }
+                // Tambi├®n verificar que el bot├│n clear existe
+                const clearButton = content.querySelector('[data-testid="calendar-filter-clear"]');
+                if (!clearButton) {
+                    console.warn('[CAL] calendar-filter-clear button not found after render');
+                }
+                
+                // SPRINT C2.6: Log clave despu├®s de render
+                console.log('[CAL] after render');
+                viewDbg('loadCalendario: end');
+                // SPRINT C2.6: Log clave al final
+                console.log('[CAL] end');
+                
+                // SPRINT C2.9.13: Marker de debug - ├®xito final (usando helper)
+                setDebugMarker('dbg-calendario-load-success', { 'data-ts': Date.now() });
+                
+                // SPRINT C2.9.7: Duplicar se├▒al expl├¡citamente aqu├¡
+                setViewState('calendario', 'ready');
+                
+                // SPRINT B3.1: No establecer view-calendar-ready aqu├¡, se hace en loadPage()
+            } catch (error) {
+                // SPRINT C2.9.6: Log de error y renderizar bloque de error visible
+                console.error('[CAL] Error in loadCalendario:', error);
+                viewDbg('loadCalendario: caught error ' + (error.message || String(error)));
+                
+                // SPRINT C2.9.13: Marker de debug - catch de pending (usando helper)
+                setDebugMarker('dbg-calendario-pending-catch', { 
+                    'data-ts': Date.now(),
+                    'data-error': error?.message || String(error)
+                });
+                
+                // SPRINT C2.9.7: Duplicar se├▒al expl├¡citamente aqu├¡
+                setViewState('calendario', 'error', error?.message || String(error));
+                
+                // SPRINT C2.9.6: Renderizar bloque de error visible en la vista
+                const content = document.getElementById('page-content');
+                if (content) {
+                    const errorMessage = error?.message || String(error) || 'Error desconocido';
+                    const errorHtml = `
+                        <div class="card">
+                            <div class="card-header">
+                                <h3>Calendario de Documentos</h3>
+                            </div>
+                            <div class="card-body">
+                                <div class="alert alert-error" data-testid="calendar-pending-error" style="padding: 16px; margin: 16px 0; background: #7f1d1d; border: 1px solid #dc2626; border-radius: 8px; color: #fecaca;">
+                                    <strong>Error cargando pendientes:</strong> ${escapeHtml(errorMessage)}
+                                </div>
+                            </div>
+                        </div>
+                    `;
+                    content.innerHTML = errorHtml;
+                }
+                
+                // SPRINT C2.9.6: Re-lanzar error para que loadPage() lo maneje con setViewState('calendario', 'error')
+                throw error;
+            }
+        }
+        
+        async function ensureCalendarioLoaded() {
+            setViewState('calendario', 'loaded');
+            await loadCalendario();
+        }
+        
+        // SPRINT C2.9.18: Asignar a window SIEMPRE al cargar el script (no dentro de funciones)
+        window.loadCalendario = loadCalendario;
+        window.ensureCalendarioLoaded = ensureCalendarioLoaded;
+        
+        // SPRINT C2.9.19: Barrera determinista de API del frontend
+        window.__REPO_API_READY__ = true;
+        console.log('[BOOT] __REPO_API_READY__ set to true');
+        
+        // INSTRUMENTACI├ôN DIAGN├ôSTICA: Logs despu├®s de definir ensureCalendarioLoaded
+        console.log('[BOOT] ensureCalendarioLoaded defined');
+        console.log('[BOOT] window.ensureCalendarioLoaded === undefined ?', window.ensureCalendarioLoaded === undefined ? 'UNDEFINED' : 'DEFINED');
+        
+        function renderPendingDocuments(expired, expiringSoon, missing, activeSection = 'expired') {
+            const subjectsCache = window.subjectsCache || { companies: {}, people: {} };
+            
+            // Agrupar por sujeto
+            function groupBySubject(items, getSubjectKey) {
+                const groups = {};
+                items.forEach(item => {
+                    const key = getSubjectKey(item);
+                    if (!groups[key]) groups[key] = [];
+                    groups[key].push(item);
+                });
+                return groups;
+            }
+            
+            function getSubjectName(item) {
+                if (item.person_key) {
+                    // Buscar en cache de subjects primero
+                    if (subjectsCache.people[item.person_key]) {
+                        return subjectsCache.people[item.person_key];
+                    }
+                    // Fallback a calendarPeople
+                    const person = (calendarPeople.people || calendarPeople || []).find(p => p.worker_id === item.person_key);
+                    return person ? person.full_name : item.person_key || '(sin nombre)';
+                } else if (item.company_key) {
+                    // Buscar en cache de subjects primero
+                    if (subjectsCache.companies[item.company_key]) {
+                        return subjectsCache.companies[item.company_key];
+                    }
+                    return item.company_key || '(sin nombre)';
+                }
+                return '(sin nombre)';
+            }
+            
+            function getSubjectScope(item) {
+                return item.scope === 'worker' ? 'Trabajador' : item.scope === 'company' ? 'Empresa' : '-';
+            }
+            
+            let html = '';
+            
+            // Secci├│n: Expirados
+            if (activeSection === 'expired') {
+                if (expired.length === 0) {
+                    // Verificar si hay filtros activos
+                    const hasFilters = calendarFilters.query || calendarFilters.type_id || (calendarFilters.scope && calendarFilters.scope !== 'all') || calendarFilters.subject_key;
+                    if (hasFilters) {
+                        html += '<div class="alert alert-info">No hay documentos expirados con estos filtros.</div>';
+                    } else {
+                        html += '<div class="alert alert-info">No hay documentos expirados.</div>';
+                    }
+                } else {
+                    const grouped = groupBySubject(expired, d => `${d.scope || 'unknown'}_${d.company_key || ''}_${d.person_key || ''}`);
+                    
+                    Object.keys(grouped).forEach(subjectKey => {
+                        const items = grouped[subjectKey];
+                        const firstItem = items[0];
+                        const subjectName = getSubjectName(firstItem);
+                        const subjectScope = getSubjectScope(firstItem);
+                        
+                        html += `
+                            <div class="card" style="margin-bottom: 16px;">
+                                <h3 style="margin-bottom: 8px;">${escapeHtml(subjectName)}</h3>
+                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 16px;">${subjectScope}</p>
+                                <div class="table-container">
+                                    <table class="catalog-table">
+                                        <thead>
+                                            <tr>
+                                                <th>Tipo</th>
+                                                <th>Archivo</th>
+                                                <th>Estado</th>
+                                                <th>Fecha de caducidad</th>
+                                                <th>Acciones</th>
+                                            </tr>
+                                        </thead>
+                                        <tbody>
+                                            ${items.map(item => {
+                                                const type = calendarTypes.find(t => t.type_id === item.type_id);
+                                                const typeName = type ? type.name : item.type_id;
+                                                const typeCode = item.type_id;
+                                                const validityEndDate = item.validity_end_date;
+                                                const daysUntilExpiry = item.days_until_expiry || 0;
+                                                const docId = item.doc_id || '';
+                                                
+                                                return `
+                                                    <tr>
+                                                        <td>
+                                                            <strong>${escapeHtml(typeName)}</strong>
+                                                            <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${escapeHtml(typeCode)}</div>
+                                                        </td>
+                                                        <td>${escapeHtml(item.file_name_original || docId.substring(0, 8) || 'N/A')}</td>
+                                                        <td><span class="badge badge-error">Expirado (hace ${Math.abs(daysUntilExpiry)} d├¡as)</span></td>
+                                                        <td>${validityEndDate ? formatDate(validityEndDate) : '-'}</td>
+                                                        <td>
+                                                            <button class="btn btn-primary btn-sm" onclick="navigateToUploadForDocument('${docId}', '${item.type_id}', '${item.scope}', '${item.person_key || ''}', '${item.company_key || ''}')" data-testid="calendar-action-resubir">
+                                                                Resubir
+                                                            </button>
+                                                        </td>
+                                                    </tr>
+                                                `;
+                                            }).join('')}
+                                        </tbody>
+                                    </table>
+                                </div>
+                            </div>
+                        `;
+                    });
+                }
+            }
+            
+            // Secci├│n: Expiran pronto
+            if (activeSection === 'expiring_soon') {
+                if (expiringSoon.length === 0) {
+                    const hasFilters = calendarFilters.query || calendarFilters.type_id || (calendarFilters.scope && calendarFilters.scope !== 'all') || calendarFilters.subject_key;
+                    if (hasFilters) {
+                        html += '<div class="alert alert-info">No hay documentos pr├│ximos a expirar con estos filtros.</div>';
+                    } else {
+                        html += '<div class="alert alert-info">No hay documentos pr├│ximos a expirar.</div>';
+                    }
+                } else {
+                    const grouped = groupBySubject(expiringSoon, d => `${d.scope || 'unknown'}_${d.company_key || ''}_${d.person_key || ''}`);
+                    
+                    Object.keys(grouped).forEach(subjectKey => {
+                        const items = grouped[subjectKey];
+                        const firstItem = items[0];
+                        const subjectName = getSubjectName(firstItem);
+                        const subjectScope = getSubjectScope(firstItem);
+                        
+                        html += `
+                            <div class="card" style="margin-bottom: 16px;">
+                                <h3 style="margin-bottom: 8px;">${escapeHtml(subjectName)}</h3>
+                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 16px;">${subjectScope}</p>
+                                <div class="table-container">
+                                    <table class="catalog-table">
+                                        <thead>
+                                            <tr>
+                                                <th>Tipo</th>
+                                                <th>Archivo</th>
+                                                <th>Estado</th>
+                                                <th>Fecha de caducidad</th>
+                                                <th>Acciones</th>
+                                            </tr>
+                                        </thead>
+                                        <tbody>
+                                            ${items.map(item => {
+                                                const type = calendarTypes.find(t => t.type_id === item.type_id);
+                                                const typeName = type ? type.name : item.type_id;
+                                                const typeCode = item.type_id;
+                                                const validityEndDate = item.validity_end_date;
+                                                const daysUntilExpiry = item.days_until_expiry || 0;
+                                                const docId = item.doc_id || '';
+                                                
+                                                return `
+                                                    <tr>
+                                                        <td>
+                                                            <strong>${escapeHtml(typeName)}</strong>
+                                                            <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${escapeHtml(typeCode)}</div>
+                                                        </td>
+                                                        <td>${escapeHtml(item.file_name_original || docId.substring(0, 8) || 'N/A')}</td>
+                                                        <td><span class="badge badge-warning">Expira pronto (${daysUntilExpiry} d├¡as)</span></td>
+                                                        <td>${validityEndDate ? formatDate(validityEndDate) : '-'}</td>
+                                                        <td>
+                                                            <button class="btn btn-primary btn-sm" onclick="navigateToUploadForDocument('${docId}', '${item.type_id}', '${item.scope}', '${item.person_key || ''}', '${item.company_key || ''}')" data-testid="calendar-action-resubir">
+                                                                Resubir
+                                                            </button>
+                                                        </td>
+                                                    </tr>
+                                                `;
+                                            }).join('')}
+                                        </tbody>
+                                    </table>
+                                </div>
+                            </div>
+                        `;
+                    });
+                }
+            }
+            
+            // Secci├│n: Pendientes de subir
+            if (activeSection === 'missing') {
+                // Botones para preparar env├¡o CAE
+                html += `
+                    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
+                        <button class="btn btn-primary" onclick="openCAEPlanModal()" data-testid="cae-plan-button">
+                            Preparar env├¡o CAE (filtrado)
+                        </button>
+                        <button class="btn btn-secondary" onclick="openCAESelectionModal()" data-testid="cae-selection-button">
+                            Preparar env├¡o CAE (selecci├│n)
+                        </button>
+                    </div>
+                `;
+                
+                if (missing.length === 0) {
+                    const hasFilters = calendarFilters.query || calendarFilters.type_id || (calendarFilters.scope && calendarFilters.scope !== 'all') || calendarFilters.subject_key;
+                    if (hasFilters) {
+                        html += '<div class="alert alert-info">No hay per├¡odos pendientes de subir con estos filtros.</div>';
+                    } else {
+                        html += '<div class="alert alert-info">No hay per├¡odos pendientes de subir.</div>';
+                    }
+                } else {
+                    const grouped = groupBySubject(missing, d => `${d.scope || 'unknown'}_${d.company_key || ''}_${d.person_key || ''}`);
+                    
+                    Object.keys(grouped).forEach(subjectKey => {
+                        const items = grouped[subjectKey];
+                        const firstItem = items[0];
+                        const subjectName = getSubjectName(firstItem);
+                        const subjectScope = getSubjectScope(firstItem);
+                        
+                        html += `
+                            <div class="card" style="margin-bottom: 16px;">
+                                <h3 style="margin-bottom: 8px;">${escapeHtml(subjectName)}</h3>
+                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 16px;">${subjectScope}</p>
+                                <div class="table-container">
+                                    <table class="catalog-table">
+                                        <thead>
+                                            <tr>
+                                                <th style="width: 40px;"><input type="checkbox" id="select-all-pending" onchange="toggleAllPendingRows(this.checked)"></th>
+                                                <th>Tipo de documento</th>
+                                                <th>Per├¡odo</th>
+                                                <th>Estado</th>
+                                                <th>Acciones</th>
+                                            </tr>
+                                        </thead>
+                                        <tbody>
+                                            ${items.map((item, idx) => {
+                                                const typeName = item.type_name || item.type_id;
+                                                const typeCode = item.type_id;
+                                                const periodKey = item.period_key;
+                                                const itemId = `pending-${subjectKey}-${idx}`;
+                                                const itemData = JSON.stringify({
+                                                    type_id: item.type_id,
+                                                    scope: item.scope,
+                                                    company_key: item.company_key,
+                                                    person_key: item.person_key,
+                                                    period_key: periodKey
+                                                }).replace(/"/g, '&quot;');
+                                                
+                                                return `
+                                                    <tr data-testid="calendar-pending-row" 
+                                                        data-pending-item='${itemData}'
+                                                        data-pending-type-id="${escapeHtml(item.type_id)}"
+                                                        data-pending-period-key="${escapeHtml(periodKey)}"
+                                                        data-pending-company-key="${escapeHtml(item.company_key || '')}"
+                                                        data-pending-person-key="${escapeHtml(item.person_key || '')}">
+                                                        <td>
+                                                            <input type="checkbox" class="pending-row-checkbox" data-item-id="${itemId}" onchange="updateCAESelectionCount()">
+                                                        </td>
+                                                        <td>
+                                                            <strong>${escapeHtml(typeName)}</strong>
+                                                            <div style="font-size: 0.75rem; color: #94a3b8; font-family: monospace; margin-top: 4px;">${escapeHtml(typeCode)}</div>
+                                                        </td>
+                                                        <td>
+                                                            <span data-testid="calendar-period">${escapeHtml(periodKey)}</span>
+                                                        </td>
+                                                        <td><span class="badge badge-info">Pendiente de subir</span></td>
+                                                        <td>
+                                                            <button class="btn btn-primary btn-sm" onclick="navigateToUploadForPeriod('${item.type_id}', '${item.scope}', '${item.person_key || ''}', '${item.company_key || ''}', '${periodKey}')" data-testid="calendar-action-subir">
+                                                                Subir documento
+                                                            </button>
+                                                        </td>
+                                                    </tr>
+                                                `;
+                                            }).join('')}
+                                        </tbody>
+                                    </table>
+                                </div>
+                            </div>
+                        `;
+                    });
+                }
+            }
+            
+            return html;
+        }
+        
+        // Funci├│n para normalizar strings (reutilizar de #buscar si existe, sino crear)
+        function normalizeString(str) {
+            if (!str) return '';
+            return str.toString()
+                .toLowerCase()
+                .normalize('NFD')
+                .replace(/[\u0300-\u036f]/g, '') // Quitar tildes
+                .trim();
+        }
+        
+        function isCalendarDebugEnabled() {
+            try {
+                // Opt-in expl├¡cito:
+                //  - window.__DEBUG_CALENDAR__ = true
+                //  - /repository?debug_calendar=1#calendario
+                if (window.__DEBUG_CALENDAR__ === true) return true;
+                const sp = new URLSearchParams(window.location.search || '');
+                return sp.get('debug_calendar') === '1';
+            } catch (_) {
+                return false;
+            }
+        }
+
+        function getMonthsDiffFromPeriod(period) {
+            try {
+                if (typeof period !== 'string' || period.length < 7) return NaN;
+                if (period[4] !== '-') return NaN;
+                const y = parseInt(period.slice(0, 4), 10);
+                const m = parseInt(period.slice(5, 7), 10);
+                if (!Number.isFinite(y) || !Number.isFinite(m) || m < 1 || m > 12) return NaN;
+                // C├ílculo robusto (YYYY-MM)
+                const today = new Date();
+                const monthsDiff = (today.getFullYear() - y) * 12 + (today.getMonth() - (m - 1));
+                return monthsDiff;
+            } catch (_) {
+                return NaN;
+            }
+        }
+        
+        // Funci├│n ├║nica para aplicar filtros a datos de calendario
+        function applyCalendarFilters(pendingData, filters, maxMonthsBack = 24) {
+            const subjectsCache = window.subjectsCache || { companies: {}, people: {} };
+            const debug = isCalendarDebugEnabled();
+
+            if (debug) {
+                const rawMissing = pendingData.missing || [];
+                // 10 muestras con include/exclude seg├║n maxMonthsBack
+                rawMissing.slice(0, 10).forEach(item => {
+                    const period = item?.period_key;
+                    const monthsDiff = getMonthsDiffFromPeriod(period);
+                    const include = Number.isFinite(monthsDiff) && monthsDiff >= 0 && monthsDiff <= maxMonthsBack;
+                    console.log('[CAL] sample', period, monthsDiff, include);
+                });
+            }
+            
+            function filterItems(items, isMissing = false) {
+                const beforeCount = items.length;
+                const filtered = items.filter(item => {
+                    // Filtro por query (texto)
+                    if (filters.query) {
+                        const queryNorm = normalizeString(filters.query);
+                        const fileName = normalizeString(item.file_name_original || item.doc_file_name || '');
+                        const typeName = normalizeString(item.type_name || '');
+                        const typeId = normalizeString(item.type_id || '');
+                        
+                        // Obtener nombre del sujeto
+                        let subjectName = '';
+                        if (item.person_key) {
+                            subjectName = subjectsCache.people[item.person_key] || item.person_key || '';
+                        } else if (item.company_key) {
+                            subjectName = subjectsCache.companies[item.company_key] || item.company_key || '';
+                        }
+                        const subjectNameNorm = normalizeString(subjectName);
+                        
+                        const matchesQuery = fileName.includes(queryNorm) ||
+                                           typeName.includes(queryNorm) ||
+                                           typeId.includes(queryNorm) ||
+                                           subjectNameNorm.includes(queryNorm);
+                        
+                        if (!matchesQuery) return false;
+                    }
+                    
+                    // Filtro por type_id
+                    if (filters.type_id && item.type_id !== filters.type_id) {
+                        return false;
+                    }
+                    
+                    // Filtro por scope (all | company | worker)
+                    if (filters.scope && filters.scope !== 'all') {
+                        if (item.scope !== filters.scope) {
+                            return false;
+                        }
+                    }
+                    
+                    // Filtro por subject_key
+                    if (filters.subject_key) {
+                        const matchesSubject = (item.person_key === filters.subject_key) ||
+                                             (item.company_key === filters.subject_key);
+                        if (!matchesSubject) return false;
+                    }
+                    
+                    // Filtro por maxMonthsBack (solo para per├¡odos faltantes)
+                    if (isMissing && item.period_key) {
+                        const monthsDiff = getMonthsDiffFromPeriod(item.period_key);
+                        if (!Number.isFinite(monthsDiff)) {
+                            console.warn('[CAL] invalid period', item.period_key);
+                            return false;
+                        }
+                        // Solo incluir si 0 <= monthsDiff <= maxMonthsBack
+                        if (monthsDiff < 0 || monthsDiff > maxMonthsBack) {
+                            return false;
+                        }
+                    }
+                    
+                    return true;
+                });
+                
+                if (debug && isMissing) {
+                    console.log('[CAL] filtered pending periods count', filtered.length, 'max=', maxMonthsBack);
+                }
+                
+                return filtered;
+            }
+            
+            return {
+                expired: filterItems(pendingData.expired || [], false),
+                expiringSoon: filterItems(pendingData.expiring_soon || [], false),
+                missing: filterItems(pendingData.missing || [], true)
+            };
+        }
+        
+        function setCalendarMaxMonthsBack(value) {
+            const parsed = parseInt(value, 10);
+            const next = Number.isFinite(parsed) && parsed > 0 ? parsed : 24;
+            calendarMaxMonthsBack = next;
+            const input = document.getElementById('calendar-max-months-back');
+            if (input && input.value !== String(next)) input.value = String(next);
+            applyCalendarFiltersAndUpdate();
+        }
+
+        // Funci├│n para aplicar filtros y actualizar UI
+        function applyCalendarFiltersAndUpdate() {
+            const rawData = window.pendingDocumentsDataRaw || { expired: [], expiring_soon: [], missing: [] };
+            
+            const filtered = applyCalendarFilters(rawData, calendarFilters, calendarMaxMonthsBack);
+            
+            // Actualizar datos globales
+            window.pendingDocumentsData = filtered;
+            
+            // Actualizar contadores de tabs
+            const expiredCount = document.getElementById('pending-count-expired');
+            const expiringSoonCount = document.getElementById('pending-count-expiring_soon');
+            const missingCount = document.getElementById('pending-count-missing');
+            
+            if (expiredCount) expiredCount.textContent = filtered.expired.length;
+            if (expiringSoonCount) expiringSoonCount.textContent = filtered.expiringSoon.length;
+            if (missingCount) missingCount.textContent = filtered.missing.length;
+            
+            // Re-renderizar secci├│n activa
+            const activeTab = document.querySelector('#pending-tab-expired[style*="border-bottom: 2px solid"]') ? 'expired' :
+                              document.querySelector('#pending-tab-expiring_soon[style*="border-bottom: 2px solid"]') ? 'expiring_soon' :
+                              document.querySelector('#pending-tab-missing[style*="border-bottom: 2px solid"]') ? 'missing' : 'expired';
+            
+            const container = document.getElementById('pending-documents-container');
+            if (container) {
+                container.innerHTML = renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, activeTab);
+            }
+        }
+        
+        // Debounce para b├║squeda de texto
+        let calendarFilterTimeout;
+        function debounceCalendarFilter(key, value) {
+            clearTimeout(calendarFilterTimeout);
+            calendarFilterTimeout = setTimeout(() => {
+                calendarFilters[key] = value;
+                applyCalendarFiltersAndUpdate();
+            }, 300);
+        }
+        
+        // Funci├│n para establecer filtro
+        function setCalendarFilter(key, value) {
+            calendarFilters[key] = value;
+            
+            // Si cambia scope, reconstruir opciones del select de sujeto
+            if (key === 'scope') {
+                // Normalizar: null -> 'all'
+                if (value === null) {
+                    calendarFilters.scope = 'all';
+                    value = 'all';
+                }
+                
+                // Reconstruir opciones del select de sujeto seg├║n scope
+                const subjectSelect = document.getElementById('calendar-filter-subject');
+                if (subjectSelect) {
+                    // Reconstruir opciones seg├║n scope
+                    subjectSelect.innerHTML = '<option value="">Todos</option>';
+                    if (value === 'all' || value === 'company') {
+                        calendarSubjects.companies?.forEach(company => {
+                            const option = document.createElement('option');
+                            option.value = company.id;
+                            option.textContent = company.name;
+                            subjectSelect.appendChild(option);
+                        });
+                    }
+                    if (value === 'all' || value === 'worker') {
+                        Object.keys(calendarSubjects.workers_by_company || {}).forEach(companyId => {
+                            const workers = calendarSubjects.workers_by_company[companyId];
+                            workers.forEach(worker => {
+                                const option = document.createElement('option');
+                                option.value = worker.id;
+                                option.textContent = worker.name;
+                                subjectSelect.appendChild(option);
+                            });
+                        });
+                    }
+                    // Resetear selecci├│n si el valor actual no es compatible
+                    if (calendarFilters.subject_key) {
+                        const currentValue = calendarFilters.subject_key;
+                        const hasOption = Array.from(subjectSelect.options).some(opt => opt.value === currentValue);
+                        if (!hasOption) {
+                            calendarFilters.subject_key = null;
+                            subjectSelect.value = '';
+                        }
+                    }
+                }
+            }
+            
+            applyCalendarFiltersAndUpdate();
+        }
+        
+        // Funci├│n para limpiar filtros
+        function clearCalendarFilters() {
+            calendarFilters = {
+                query: '',
+                type_id: null,
+                scope: 'all',
+                subject_key: null
+            };
+            calendarMaxMonthsBack = 24;  // Resetear a default
+            
+            // Resetear inputs
+            const queryInput = document.getElementById('calendar-filter-text');
+            const typeSelect = document.getElementById('calendar-filter-type');
+            const subjectSelect = document.getElementById('calendar-filter-subject');
+            const scopeSelect = document.getElementById('calendar-scope-select');
+            const maxMonthsBackInput = document.getElementById('calendar-max-months-back');
+            
+            if (queryInput) queryInput.value = '';
+            if (typeSelect) typeSelect.value = '';
+            if (scopeSelect) scopeSelect.value = 'all';
+            if (maxMonthsBackInput) maxMonthsBackInput.value = '24';
+            if (subjectSelect) {
+                // Reconstruir opciones completas
+                subjectSelect.innerHTML = '<option value="">Todos</option>';
+                calendarSubjects.companies?.forEach(company => {
+                    const option = document.createElement('option');
+                    option.value = company.id;
+                    option.textContent = company.name;
+                    subjectSelect.appendChild(option);
+                });
+                Object.keys(calendarSubjects.workers_by_company || {}).forEach(companyId => {
+                    const workers = calendarSubjects.workers_by_company[companyId];
+                    workers.forEach(worker => {
+                        const option = document.createElement('option');
+                        option.value = worker.id;
+                        option.textContent = worker.name;
+                        subjectSelect.appendChild(option);
+                    });
+                });
+                subjectSelect.value = '';
+            }
+            
+            // Aplicar filtros reseteados (no recargar, solo filtrar client-side)
+            applyCalendarFiltersAndUpdate();
+        }
+        
+        function showPendingSection(section) {
+            // Actualizar tabs activos
+            ['expired', 'expiring_soon', 'missing'].forEach(s => {
+                const tab = document.getElementById(`pending-tab-${s}`);
+                if (tab) {
+                    if (s === section) {
+                        tab.style.borderBottom = '2px solid #3b82f6';
+                    } else {
+                        tab.style.borderBottom = 'none';
+                    }
+                }
+            });
+            
+            // IMPORTANTE: Re-aplicar filtros antes de renderizar para asegurar datos actualizados
+            // Esto garantiza que si cambi├│ maxMonthsBack, se refleje en el render
+            const rawData = window.pendingDocumentsDataRaw || { expired: [], expiring_soon: [], missing: [] };
+            const filtered = applyCalendarFilters(rawData, calendarFilters, calendarMaxMonthsBack);
+            
+            // Actualizar datos globales
+            window.pendingDocumentsData = filtered;
+            
+            // Re-renderizar con secci├│n activa (usar datos filtrados actualizados)
+            const container = document.getElementById('pending-documents-container');
+            if (container) {
+                container.innerHTML = renderPendingDocuments(filtered.expired, filtered.expiringSoon, filtered.missing, section);
+            }
+        }
+        
+        // Funci├│n eliminada: updatePendingDocuments() ya no es necesaria
+        // El filtro "Rango de b├║squeda" fue eliminado, ahora se usa "M├íx. meses atr├ís"
+        
+        function navigateToUploadForDocument(docId, typeId, scope, personKey, companyKey) {
+            const params = {
+                type_id: typeId,
+                scope: scope
+            };
+            if (personKey) params.person_key = personKey;
+            if (companyKey) params.company_key = companyKey;
+            if (docId) params.replace_doc_id = docId;
+            navigateTo('subir', params);
+        }
+        
+        function navigateToUploadForPeriod(typeId, scope, personKey, companyKey, periodKey) {
+            const params = {
+                type_id: typeId,
+                scope: scope
+            };
+            if (personKey) params.person_key = personKey;
+            if (companyKey) params.company_key = companyKey;
+            if (periodKey) params.period_key = periodKey;
+            navigateTo('subir', params);
         }
         
         function searchCalendarType(query) {
@@ -1670,7 +3012,7 @@
                                     <div style="font-size: 3rem; margin-bottom: 16px;">­ƒôñ</div>
                                     <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu├¡</p>
                                     <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
-                                    <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-file-input">
+                                    <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-input">
                                 </div>
                                 <div id="upload-files-list"></div>
                                 <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
@@ -1722,6 +3064,27 @@
                             </div>
                         `;
                         setupUploadZone();
+                        // SPRINT B3.4.1: Asegurar que el dropzone tiene data-testid correcto
+                        // El dropzone ya est├í en el HTML con data-testid="upload-dropzone"
+                        const uploadZone = document.getElementById('upload-zone');
+                        const fileInput = document.getElementById('file-input');
+                        if (uploadZone && fileInput) {
+                            // Garantizar que data-testid="upload-dropzone" est├í presente
+                            if (!uploadZone.hasAttribute('data-testid')) {
+                                uploadZone.setAttribute('data-testid', 'upload-dropzone');
+                            }
+                            // A├▒adir se├▒al de estado usando atributo separado
+                            uploadZone.setAttribute('data-upload-ready', 'true');
+                            // Asegurar que el input tiene el data-testid correcto
+                            if (!fileInput.hasAttribute('data-testid')) {
+                                fileInput.setAttribute('data-testid', 'upload-input');
+                            }
+                            // Se├▒al espec├¡fica de vista
+                            const content = document.getElementById('page-content');
+                            if (content) {
+                                content.setAttribute('data-testid', 'view-subir-ready');
+                            }
+                        }
                         return;
                     }
                 }
@@ -1734,7 +3097,7 @@
                             <div style="font-size: 3rem; margin-bottom: 16px;">­ƒôñ</div>
                             <p style="font-size: 1.1rem; margin-bottom: 8px;">Arrastra archivos PDF aqu├¡</p>
                             <p style="color: #94a3b8; font-size: 0.875rem;">o haz clic para seleccionar</p>
-                            <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-file-input">
+                                    <input type="file" id="file-input" multiple accept=".pdf" style="display: none;" data-testid="upload-input">
                         </div>
                         <!-- Valores por defecto (opcional) -->
                         <div id="upload-defaults-container" style="margin-top: 24px; display: none;">
@@ -1913,6 +3276,37 @@
                 
                 renderUploadFiles();
                 console.log('[repo-upload] initUploadWizard end');
+                
+                // SPRINT B3.4.1: Asegurar que el dropzone siempre existe y tiene data-testid correcto
+                // El dropzone ya est├í en el HTML est├ítico con data-testid="upload-dropzone"
+                // Solo verificamos que existe y a├▒adimos se├▒al de estado sin modificar data-testid
+                const uploadZone = document.getElementById('upload-zone');
+                const fileInput = document.getElementById('file-input');
+                if (uploadZone && fileInput) {
+                    // Garantizar que data-testid="upload-dropzone" est├í presente (ya deber├¡a estar en HTML)
+                    if (!uploadZone.hasAttribute('data-testid')) {
+                        uploadZone.setAttribute('data-testid', 'upload-dropzone');
+                    } else {
+                        // Si ya existe, asegurar que contiene 'upload-dropzone' (no sobrescribir)
+                        const currentTestId = uploadZone.getAttribute('data-testid');
+                        if (!currentTestId.includes('upload-dropzone')) {
+                            uploadZone.setAttribute('data-testid', 'upload-dropzone');
+                        }
+                    }
+                    // A├▒adir se├▒al de estado usando atributo separado (no modificar data-testid)
+                    uploadZone.setAttribute('data-upload-ready', 'true');
+                    // Asegurar que el input tiene el data-testid correcto
+                    if (!fileInput.hasAttribute('data-testid')) {
+                        fileInput.setAttribute('data-testid', 'upload-input');
+                    }
+                    // Se├▒al espec├¡fica de vista en page-content
+                    const content = document.getElementById('page-content');
+                    if (content) {
+                        content.setAttribute('data-testid', 'view-subir-ready');
+                    }
+                } else {
+                    console.error('[repo-upload] CRITICAL: upload-zone or file-input not found after loadSubir');
+                }
             } catch (error) {
                 console.error('[repo-upload] Error:', error);
                 content.innerHTML = `<div class="alert alert-error">Error al cargar subir: ${error.message}</div>`;
@@ -2215,20 +3609,27 @@
                 // Derivar period_kind desde periodMode (igual que backend)
                 // MONTH, QUARTER, YEAR requieren periodo manual; NONE y n_months no
                 let periodKind = 'none';
-                if (periodMode === 'monthly') {
+                // Si tiene n_months configurado, no requiere periodo manual (periodKind = 'none')
+                const hasNMonths = type?.validity_policy?.n_months?.n;
+                if (hasNMonths) {
+                    periodKind = 'none';
+                } else if (periodMode === 'monthly') {
                     periodKind = 'month';
                 } else if (periodMode === 'annual') {
                     periodKind = 'year';
                 } else if (periodMode === 'quarter') {
                     periodKind = 'quarter';
                 } else {
-                    // n_months, none, o cualquier otro => NONE (no requiere periodo manual)
+                    // none, o cualquier otro => NONE (no requiere periodo manual)
                     periodKind = 'none';
                 }
                 
+                // SPRINT B3.4: Se├▒al expl├¡cita de preview cuando se renderiza
+                // Se a├▒adir├í despu├®s del map
+                
                 // BUG 3: No pedir a├▒o si es N meses desde expedici├│n (issue_date)
                 // Si tiene n_months configurado y se calcula desde issue_date, no necesita period_key
-                const hasNMonths = type?.validity_policy?.n_months?.n;
+                // Reutilizar hasNMonths ya declarado arriba
                 const calculatesFromIssueDate = type?.validity_policy?.basis === 'issue_date' || 
                                                (hasNMonths && type?.validity_policy?.monthly?.month_source === 'issue_date');
                 const shouldHidePeriodForNMonths = hasNMonths && calculatesFromIssueDate && file.issue_date;
@@ -2488,7 +3889,8 @@
                             <label class="form-label">4. Fecha de emisi├│n${file.requires_issue_date ? ' <span class="form-required">*</span>' : ' (Opcional)'}</label>
                             <input type="date" class="form-input" 
                                    id="upload-issue-date-${file.id}"
-                                   value="${file.issue_date || ''}" 
+                                   data-testid="issue-date-input"
+                                   value="${file.issue_date || ''}"
                                    onchange="updateUploadIssueDate('${file.id}', this.value)"
                                    ${file.requires_issue_date ? 'required' : ''}>
                             ${file.issue_date ? `<div class="form-help" style="font-size: 0.85rem; color: #64748b; margin-top: 4px;">Fecha detectada desde nombre</div>` : ''}
@@ -3691,6 +5093,7 @@
             subject_key: null,
             scope: null,
             status: null,
+            validity_status: null,  // VALID, EXPIRING_SOON, EXPIRED
             sort: 'date_desc',
             page: 1,
             page_size: 20
@@ -3700,26 +5103,51 @@
             dbg('loadBuscar: start', params);
             const content = document.getElementById('page-content');
             
+            if (!content) {
+                throw new Error('page-content element not found');
+            }
+            
             // Ensure data is loaded
             await ensureRepoDataLoaded({ types: true, people: true });
             
+            // Load data if not already loaded
             try {
-                // Load data if not already loaded
                 if (searchTypes.length === 0) {
-                    searchTypes = await fetch(`${BACKEND_URL}/api/repository/types?active=true`).then(r => r.json());
+                    const typesResponse = await fetch(`${BACKEND_URL}/api/repository/types?active=true`);
+                    if (!typesResponse.ok) {
+                        throw new Error(`Failed to load types: ${typesResponse.status}`);
+                    }
+                    searchTypes = await typesResponse.json();
                 }
+            } catch (error) {
+                console.error('[repo-search] Failed to load types:', error);
+                // Continuar con tipos vac├¡os en lugar de fallar completamente
+                searchTypes = searchTypes || [];
+            }
+            
+            try {
                 const peopleData = await fetch(`${BACKEND_URL}/api/config/people`).then(r => r.json()).catch(() => ({people: []}));
                 searchPeople = peopleData.people || [];
-                
-                // Load subjects (companies + workers)
-                try {
-                    const subjectsResponse = await fetch(`${BACKEND_URL}/api/repository/subjects`);
-                    if (subjectsResponse.ok) {
-                        searchSubjects = await subjectsResponse.json();
-                    }
-                } catch (error) {
-                    console.warn('[repo-search] Failed to load subjects:', error);
+            } catch (error) {
+                console.warn('[repo-search] Failed to load people:', error);
+                searchPeople = [];
+            }
+            
+            // Load subjects (companies + workers)
+            try {
+                const subjectsResponse = await fetch(`${BACKEND_URL}/api/repository/subjects`);
+                if (subjectsResponse.ok) {
+                    searchSubjects = await subjectsResponse.json();
+                } else {
+                    console.warn('[repo-search] Failed to load subjects:', subjectsResponse.status);
+                    searchSubjects = { companies: [], workers_by_company: {} };
                 }
+            } catch (error) {
+                console.warn('[repo-search] Failed to load subjects:', error);
+                searchSubjects = { companies: [], workers_by_company: {} };
+            }
+            
+            try {
                 
                 // Reset filters if not in params
                 if (!params.type_id && !params.subject_key) {
@@ -3750,19 +5178,20 @@
                         </div>
                     </div>
                     
-                    <div class="card">
+                    <div class="card" data-testid="buscar-view">
                         <div class="catalog-filters">
                             <div class="form-group">
                                 <label class="form-label">Buscar</label>
                                 <input type="text" class="form-input" 
                                        id="search-docs-query"
+                                       data-testid="buscar-text"
                                        placeholder="Buscar por nombre de archivo, tipo, o palabras..."
                                        value="${searchFilters.query}"
                                        oninput="debounceSearchDocs(this.value)">
                             </div>
                             <div class="form-group">
                                 <label class="form-label">Tipo de documento</label>
-                                <select class="form-input" id="search-docs-type-select" onchange="setSearchDocsFilter('type_id', this.value || null)">
+                                <select class="form-input" id="search-docs-type-select" data-testid="buscar-type" onchange="setSearchDocsFilter('type_id', this.value || null)">
                                     <option value="">Todos los tipos</option>
                                     ${searchTypes.sort((a, b) => a.name.localeCompare(b.name)).map(type => `
                                         <option value="${type.type_id}" ${searchFilters.type_id === type.type_id ? 'selected' : ''}>${type.name}</option>
@@ -3782,7 +5211,7 @@
                             </div>
                             <div class="form-group">
                                 <label class="form-label">Sujeto</label>
-                                <select class="form-input" id="search-docs-subject-select" onchange="setSearchDocsFilter('subject_key', this.value || null)">
+                                <select class="form-input" id="search-docs-subject-select" data-testid="buscar-subject" onchange="setSearchDocsFilter('subject_key', this.value || null)">
                                     <option value="">Todos</option>
                                     ${(() => {
                                         let options = [];
@@ -3825,7 +5254,7 @@
                             </div>
                         </div>
                         <div style="margin-bottom: 16px;">
-                            <button class="btn btn-secondary" onclick="clearSearchDocsFilters()">Limpiar filtros</button>
+                            <button class="btn btn-secondary" data-testid="buscar-apply" onclick="clearSearchDocsFilters()">Limpiar filtros</button>
                         </div>
                         
                         <div id="search-results-container">
@@ -3834,10 +5263,53 @@
                     </div>
                 `;
                 
-                // Load initial results
-                await performSearch();
+                // SPRINT C2.1: Agregar se├▒ales DOM cuando buscar est├í completamente cargado
+                if (content) {
+                    content.setAttribute('data-testid', 'view-search-ready');
+                }
+                
+                // SPRINT C2.8: Asegurar que buscar-view est├í presente despu├®s del render
+                const buscarViewCard = content.querySelector('.card');
+                if (buscarViewCard) {
+                    buscarViewCard.setAttribute('data-testid', 'buscar-view');
+                }
+                
+                // Load initial results (no bloquear si falla)
+                try {
+                    // SPRINT C2.9: Asegurar que el contenedor existe antes de llamar a performSearch
+                    const searchContainer = document.getElementById('search-results-container');
+                    if (!searchContainer) {
+                        console.warn('[repo-search] search-results-container not found, cannot perform initial search');
+                    } else {
+                        await performSearch();
+                        // SPRINT C2.1: Asegurar que search-ui-ready se establece despu├®s de que los resultados se rendericen
+                        if (searchContainer) {
+                            searchContainer.setAttribute('data-testid', 'search-ui-ready');
+                        }
+                    }
+                } catch (error) {
+                    console.warn('[repo-search] Error performing initial search:', error);
+                    // SPRINT C2.9: En caso de error, establecer buscar-results-error
+                    const searchContainer = document.getElementById('search-results-container');
+                    if (searchContainer) {
+                        searchContainer.setAttribute('data-testid', 'buscar-results-error');
+                    }
+                }
             } catch (error) {
-                content.innerHTML = `<div class="alert alert-error">Error al cargar b├║squeda: ${error.message}</div>`;
+                console.error('[repo-search] Error in loadBuscar:', error);
+                // Mostrar mensaje de error pero no romper el render b├ísico
+                if (content) {
+                    content.innerHTML = `
+                        <div class="card" data-testid="buscar-view">
+                            <h2>Buscar documentos</h2>
+                            <div class="alert alert-error" data-testid="buscar-error">
+                                Error al cargar la b├║squeda: ${error.message || String(error)}
+                            </div>
+                        </div>
+                    `;
+                }
+                // Re-lanzar el error para que el catch externo lo maneje
+                throw error;
             }
         }
         
@@ -4034,12 +5506,52 @@
             clearSearchDocsFilters();
         }
         
-        async function performSearch() {
-            const container = document.getElementById('search-results-container');
-            if (!container) return;
+        // SPRINT C2.9.2: Funci├│n finalizadora que establece marcador como invariante
+        function finalizeSearchResults({ ok, count }) {
+            // Buscar contenedor principal de la vista Buscar (m├ís estable que search-results-container)
+            // Usar page-content como contenedor ra├¡z, ya que no se sobrescribe con innerHTML
+            const pageContent = document.getElementById('page-content');
+            
+            if (!pageContent) {
+                console.warn('[repo-search] page-content no encontrado, no se puede establecer marcador');
+                return;
+            }
+            
+            // Eliminar markers anteriores si existen (buscar en todo el page-content)
+            const existingReady = pageContent.querySelector('[data-testid="buscar-results-ready"]');
+            const existingError = pageContent.querySelector('[data-testid="buscar-results-error"]');
+            if (existingReady) existingReady.remove();
+            if (existingError) existingError.remove();
+            
+            // Crear marker nuevo SIEMPRE
+            const marker = document.createElement('div');
+            if (ok) {
+                marker.setAttribute('data-testid', 'buscar-results-ready');
+                marker.setAttribute('data-count', String(count || 0));
+                marker.setAttribute('data-empty', count === 0 ? 'true' : 'false');
+            } else {
+                marker.setAttribute('data-testid', 'buscar-results-error');
+            }
+            marker.style.display = 'none';
+            
+            // Insertar como hijo directo del page-content (NO dentro de innerHTML que pueda sobrescribirse)
+            pageContent.appendChild(marker);
+        }
+        
+        async function performSearch() {
+            const container = document.getElementById('search-results-container');
+            if (!container) {
+                // SPRINT C2.9.2: Si no hay contenedor, marcar error pero continuar
+                finalizeSearchResults({ ok: false, count: 0 });
+                return;
+            }
             
             container.innerHTML = '<div class="loading">Buscando...</div>';
             
+            let searchSucceeded = false;
+            let searchFailed = false;
+            let resultCount = 0;
+            
             try {
                 // Build query params
                 const params = new URLSearchParams();
@@ -4050,7 +5562,7 @@
                     params.append('scope', searchFilters.scope);
                 }
                 
-                // Fetch all documents (backend doesn't support query filter yet, so we filter client-side)
+                // Fetch all documents (backend now supports validity_status filter)
                 const response = await fetch(`${BACKEND_URL}/api/repository/docs?${params}`);
                 let docs = await response.json();
                 if (!Array.isArray(docs)) docs = [];
@@ -4111,10 +5623,20 @@
                 });
                 
                 searchDocs = docs;
+                resultCount = docs.length;
                 renderSearchResults();
                 updateSearchResultsInfo();
+                searchSucceeded = true;
             } catch (error) {
-                container.innerHTML = `<div class="alert alert-error">Error al buscar: ${error.message}</div>`;
+                container.innerHTML = `<div class="alert alert-error" data-testid="buscar-error">Error al buscar: ${error.message}</div>`;
+                searchFailed = true;
+                resultCount = 0;
+            } finally {
+                // SPRINT C2.9.2: SIEMPRE establecer marcador como invariante
+                finalizeSearchResults({ 
+                    ok: searchSucceeded, 
+                    count: resultCount 
+                });
             }
         }
         
@@ -4130,7 +5652,7 @@
             
             container.innerHTML = `
                 <div class="table-container" style="max-height: calc(100vh - 500px); overflow-y: auto;">
-                    <table class="catalog-table">
+                    <table class="catalog-table" data-testid="buscar-results">
                         <thead>
                             <tr>
                                 <th>Fecha</th>
@@ -4154,6 +5676,9 @@
                                 const typeName = type ? type.name : doc.type_id;
                                 
                                 let subjectName = doc.person_key || doc.company_key || '-';
+                                const subjectKey = doc.person_key || doc.company_key || '';
+                                const subjectType = doc.person_key ? 'trabajador' : (doc.company_key ? 'empresa' : '');
+                                
                                 if (doc.person_key) {
                                     // Buscar en workers_by_company
                                     let found = false;
@@ -4174,13 +5699,39 @@
                                     if (company) subjectName = company.name;
                                 }
                                 
-                                const status = doc.computed_validity?.status || 'UNKNOWN';
-                                const statusBadge = status === 'VALID' ? 'badge-ok' : 
-                                                   status === 'EXPIRED' ? 'badge-error' : 
-                                                   status === 'EXPIRING_SOON' ? 'badge-warning' : 'badge-info';
-                                const statusText = status === 'VALID' ? 'V├ílido' : 
-                                                  status === 'EXPIRED' ? 'Expirado' : 
-                                                  status === 'EXPIRING_SOON' ? 'Expira pronto' : 'Desconocido';
+                                // Estado de validez calculado desde backend
+                                const validityStatus = doc.validity_status || 'UNKNOWN';
+                                const validityEndDate = doc.validity_end_date || null;
+                                const daysUntilExpiry = doc.days_until_expiry !== undefined ? doc.days_until_expiry : null;
+                                
+                                // Badge de estado
+                                let statusBadge = 'badge-secondary';
+                                let statusText = 'Desconocido';
+                                
+                                if (validityStatus === 'VALID') {
+                                    statusBadge = 'badge-ok';
+                                    statusText = 'V├ílido';
+                                    if (daysUntilExpiry !== null) {
+                                        statusText += ` (${daysUntilExpiry} d├¡as)`;
+                                    }
+                                } else if (validityStatus === 'EXPIRING_SOON') {
+                                    statusBadge = 'badge-warning';
+                                    statusText = 'Expira pronto';
+                                    if (daysUntilExpiry !== null) {
+                                        statusText += ` (${daysUntilExpiry} d├¡as)`;
+                                    }
+                                } else if (validityStatus === 'EXPIRED') {
+                                    statusBadge = 'badge-error';
+                                    statusText = 'Expirado';
+                                    if (daysUntilExpiry !== null) {
+                                        statusText += ` (hace ${Math.abs(daysUntilExpiry)} d├¡as)`;
+                                    }
+                                } else if (validityStatus === 'UNKNOWN') {
+                                    statusBadge = 'badge-secondary';
+                                    statusText = 'Desconocido';
+                                }
+                                
+                                const status = validityStatus;
                                 
                                 const createdDate = doc.created_at ? new Date(doc.created_at).toLocaleDateString('es-ES') : '-';
                                 // FIX: Usar file_name_original del modelo DocumentInstanceV1
@@ -4189,7 +5740,10 @@
                                 const escapedFileName = fileName.replace(/'/g, "\\'");
                                 
                                 return `
-                                    <tr>
+                                    <tr data-testid="buscar-row" 
+                                        data-doc-id="${escapedDocId}" 
+                                        data-type-id="${doc.type_id || ''}" 
+                                        data-subject="${subjectType}">
                                         <td>${createdDate}</td>
                                         <td>
                                             <strong>${typeName}</strong>
@@ -4197,10 +5751,14 @@
                                         </td>
                                         <td>${subjectName}</td>
                                         <td>${fileName}</td>
-                                        <td><span class="badge ${statusBadge}">${statusText}</span></td>
+                                        <td>
+                                            <span class="badge ${statusBadge}">${statusText}</span>
+                                            ${validityEndDate ? `<div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">Caduca: ${formatDate(validityEndDate)}</div>` : ''}
+                                        </td>
                                         <td>
                                             <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                 <button class="btn btn-secondary btn-sm" 
+                                                        data-testid="buscar-action-file"
                                                         onclick="viewDocumentFromSearch('${escapedDocId}')"
                                                         title="Ver/Descargar PDF">
                                                     Ver PDF
@@ -4217,7 +5775,10 @@
                                                     Resubir
                                                 </button>
                                                 <button class="btn btn-secondary btn-sm" 
-                                                        onclick="editDocumentFromSearch('${escapedDocId}')">
+                                                        data-testid="buscar-action-edit"
+                                                        data-edit-doc-button="true"
+                                                        data-doc-id="${escapedDocId}"
+                                                        onclick="openEditDocModal('${escapedDocId}'); return false;">
                                                     Editar
                                                 </button>
                                                 <button class="btn btn-secondary btn-sm" 
@@ -4248,6 +5809,39 @@
         // Variables para edici├│n de documentos
         let editingDocument = null;
         
+        // SPRINT C2.2: Event delegation para botones Editar
+        function initEditDocumentDelegation() {
+            // Usar capture phase para asegurar que se ejecute antes de otros listeners
+            document.addEventListener('click', (e) => {
+                const btn = e.target.closest('[data-testid="buscar-action-edit"], [data-edit-doc-button="true"]');
+                if (!btn) return;
+                
+                // SPRINT C2.2.1: Log diagn├│stico
+                console.log('[EDITMODAL] click captured', { target: e.target.tagName, docId: btn.getAttribute('data-doc-id') });
+                
+                const docId = btn.getAttribute('data-doc-id');
+                if (!docId) {
+                    console.warn('[edit-doc] Button clicked but no data-doc-id found');
+                    return;
+                }
+                
+                e.preventDefault();
+                e.stopPropagation();
+                openEditDocModal(docId);
+            }, true); // Use capture phase
+        }
+        
+        // SPRINT C2.2.1: Funci├│n wrapper para diagn├│stico
+        async function openEditDocModal(docId) {
+            console.log('[EDITMODAL] openEditDocModal start', { docId });
+            try {
+                await editDocumentFromSearch(docId);
+            } catch (err) {
+                console.error('[EDITMODAL] open failed', err);
+                throw err;
+            }
+        }
+        
         async function editDocumentFromSearch(docId) {
             try {
                 console.log('[editDocumentFromSearch] docId:', docId);
@@ -4317,8 +5911,12 @@
                 }
                 
                 // Crear y mostrar modal de edici├│n
-                console.log('[editDocumentFromSearch] Showing modal...');
+                console.log('[editDocumentFromSearch] Showing modal for doc:', editingDocument.doc_id, 'type:', type.type_id);
                 showEditDocumentModal(editingDocument, type);
+                console.log('[editDocumentFromSearch] Modal should be visible now');
+                // Verificar que el modal se insert├│ correctamente
+                const checkModal = document.querySelector('[data-testid="edit-doc-modal-open"]');
+                console.log('[editDocumentFromSearch] Modal check after showEditDocumentModal:', !!checkModal);
             } catch (error) {
                 console.error('[editDocumentFromSearch] Error:', error);
                 alert(`Error al cargar documento: ${error.message}`);
@@ -4326,16 +5924,69 @@
         }
         
         function showEditDocumentModal(doc, type) {
+            // SPRINT C2.2: Cerrar cualquier modal existente antes de abrir uno nuevo
+            const existingOverlay = document.getElementById('edit-doc-modal-overlay');
+            if (existingOverlay) {
+                existingOverlay.remove();
+            }
             // Escapar valores para HTML
             const typeName = escapeHtml(type.name || '');
             const typeId = escapeHtml(doc.type_id || '');
-            // FIX: Usar file_name_original del modelo DocumentInstanceV1
             const fileName = escapeHtml(doc.file_name_original || doc.doc_file_name || doc.doc_id || '');
             
+            // Obtener valores de fechas
+            const issueDate = doc.issued_at || doc.extracted?.issue_date || '';
+            const validityStartDate = doc.extracted?.validity_start_date || '';
+            const periodKey = doc.period_key || '';
+            
+            // Estado de validez (readonly)
+            const validityStatus = doc.validity_status || 'UNKNOWN';
+            const validityEndDate = doc.validity_end_date || '';
+            const daysUntilExpiry = doc.days_until_expiry !== undefined ? doc.days_until_expiry : null;
+            
+            // Determinar qu├® campos mostrar seg├║n el tipo
+            const showIssueDate = type.issue_date_required || issueDate;
+            const showValidityStartDate = type.validity_start_mode === 'manual' || validityStartDate;
+            const showPeriodKey = doc.period_kind && doc.period_kind !== 'NONE' && doc.period_kind !== 'none';
+            
+            // Helper para formatear fecha
+            function formatDateForInput(dateStr) {
+                if (!dateStr) return '';
+                if (typeof dateStr === 'string' && dateStr.includes('T')) {
+                    return dateStr.split('T')[0];
+                }
+                return dateStr;
+            }
+            
+            // Helper para badge de estado de validez
+            function getValidityStatusBadge(status) {
+                const statusText = {
+                    'VALID': 'V├ílido',
+                    'EXPIRING_SOON': 'Expira pronto',
+                    'EXPIRED': 'Expirado',
+                    'UNKNOWN': 'Desconocido'
+                };
+                const badgeClass = {
+                    'VALID': 'badge-ok',
+                    'EXPIRING_SOON': 'badge-warning',
+                    'EXPIRED': 'badge-error',
+                    'UNKNOWN': 'badge-secondary'
+                };
+                return `<span class="badge ${badgeClass[status] || 'badge-secondary'}">${statusText[status] || status}</span>`;
+            }
+            
             // Crear modal HTML
+            // SPRINT C2.2: A├▒adir se├▒ales DOM para tests deterministas
             const modalHTML = `
-                <div class="modal-overlay" id="edit-doc-modal-overlay" onclick="closeEditDocumentModal()">
-                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
+                <div class="modal-overlay" 
+                     id="edit-doc-modal-overlay" 
+                     data-testid="edit-doc-modal-overlay"
+                     data-modal-state="open"
+                     onclick="closeEditDocumentModal()">
+                    <div class="modal" 
+                         data-testid="edit-doc-modal-open"
+                         onclick="event.stopPropagation()" 
+                         style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                         <div class="modal-header">
                             <h3>Editar documento</h3>
                             <button class="btn btn-secondary" onclick="closeEditDocumentModal()" style="padding: 4px 12px; position: absolute; top: 24px; right: 24px;">Ô£ò</button>
@@ -4350,6 +6001,18 @@
                                 <label class="form-label">Archivo</label>
                                 <input type="text" class="form-input" value="${fileName}" disabled>
                             </div>
+                            
+                            <!-- Estado de validez (readonly) -->
+                            <div class="form-group" style="background: #1e293b; padding: 12px; border-radius: 6px; border: 1px solid #334155;">
+                                <label class="form-label" style="color: #cbd5e1;">Estado de validez (calculado)</label>
+                                <div style="margin-top: 8px;">
+                                    ${getValidityStatusBadge(validityStatus)}
+                                    ${validityEndDate ? `<div style="margin-top: 8px; font-size: 0.875rem; color: #94a3b8;">Caduca: ${formatDate(validityEndDate)}</div>` : ''}
+                                    ${daysUntilExpiry !== null ? `<div style="margin-top: 4px; font-size: 0.875rem; color: #94a3b8;">${daysUntilExpiry >= 0 ? `${daysUntilExpiry} d├¡as restantes` : `Expirado hace ${Math.abs(daysUntilExpiry)} d├¡as`}</div>` : ''}
+                                </div>
+                                <div class="form-help" style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">Este estado se calcula autom├íticamente seg├║n las fechas del documento. No es editable.</div>
+                            </div>
+                            
                             ${type.scope === 'company' ? `
                                 <div class="form-group">
                                     <label class="form-label">Empresa <span class="form-required">*</span></label>
@@ -4388,28 +6051,78 @@
                                     </select>
                                 </div>
                             ` : ''}
+                            
+                            ${showPeriodKey ? `
+                                <div class="form-group">
+                                    <label class="form-label">Mes/A├▒o ${type.validity_policy?.mode === 'monthly' ? '<span class="form-required">*</span>' : ''}</label>
+                                    <input type="text" class="form-input" id="edit-doc-period-key" 
+                                           value="${periodKey}" 
+                                           placeholder="YYYY-MM (ej: 2025-01)"
+                                           pattern="[0-9]{4}-[0-9]{2}">
+                                    <div class="form-help" style="font-size: 0.75rem; color: #94a3b8;">Formato: YYYY-MM (ej: 2025-01)</div>
+                                </div>
+                            ` : ''}
+                            
+                            ${showIssueDate ? `
+                                <div class="form-group">
+                                    <label class="form-label">Fecha de emisi├│n ${type.issue_date_required ? '<span class="form-required">*</span>' : ''}</label>
+                                    <input type="date" class="form-input" id="edit-doc-issue-date" 
+                                           value="${formatDateForInput(issueDate)}">
+                                    <div class="form-help" style="font-size: 0.75rem; color: #94a3b8;">Fecha en que se emiti├│ el documento</div>
+                                </div>
+                            ` : ''}
+                            
+                            ${showValidityStartDate ? `
+                                <div class="form-group">
+                                    <label class="form-label">Fecha inicio de vigencia ${type.validity_start_mode === 'manual' ? '<span class="form-required">*</span>' : ''}</label>
+                                    <input type="date" class="form-input" id="edit-doc-validity-start-date" 
+                                           data-testid="edit-doc-validity-start-date"
+                                           value="${formatDateForInput(validityStartDate)}">
+                                    <div class="form-help" style="font-size: 0.75rem; color: #94a3b8;">Fecha desde la cual el documento es v├ílido</div>
+                                </div>
+                            ` : ''}
+                            
                             <div class="form-group">
-                                <label class="form-label">Estado</label>
-                                <select class="form-input" id="edit-doc-status">
+                                <label class="form-label">Estado de tramitaci├│n</label>
+                                <select class="form-input" id="edit-doc-status" data-testid="edit-doc-status">
                                     <option value="draft" ${doc.status === 'draft' ? 'selected' : ''}>Borrador</option>
                                     <option value="reviewed" ${doc.status === 'reviewed' ? 'selected' : ''}>Revisado</option>
                                     <option value="ready_to_submit" ${doc.status === 'ready_to_submit' ? 'selected' : ''}>Listo para enviar</option>
                                     <option value="submitted" ${doc.status === 'submitted' ? 'selected' : ''}>Enviado</option>
                                 </select>
+                                <div class="form-help" style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px;">
+                                    <strong>Borrador:</strong> Datos en preparaci├│n<br>
+                                    <strong>Revisado:</strong> Verificado internamente<br>
+                                    <strong>Listo para enviar:</strong> Preparado para plataforma CAE<br>
+                                    <strong>Enviado:</strong> Ya subido/enviado a plataforma<br>
+                                    <em style="color: #64748b;">Nota: Este estado no afecta a la caducidad. La caducidad depende de las fechas.</em>
+                                </div>
                             </div>
                         </div>
                         <div class="modal-actions">
                             <button class="btn btn-secondary" onclick="closeEditDocumentModal()">Cancelar</button>
-                            <button class="btn btn-primary" onclick="saveDocumentEdit()">Guardar</button>
+                            <button class="btn btn-primary" onclick="saveDocumentEdit()" data-testid="edit-doc-save">Guardar</button>
                         </div>
                     </div>
                 </div>
             `;
             
-            // A├▒adir modal al body
-            const modalDiv = document.createElement('div');
-            modalDiv.innerHTML = modalHTML;
-            document.body.appendChild(modalDiv);
+            // SPRINT C2.2.1: Log antes de insertar overlay
+            console.log('[EDITMODAL] inserting overlay');
+            
+            // SPRINT C2.2: Insertar el HTML del modal directamente en el body usando insertAdjacentHTML
+            // Esto asegura que el modal est├® directamente en el body y los testids sean accesibles
+            document.body.insertAdjacentHTML('beforeend', modalHTML);
+            
+            // SPRINT C2.2.1: Log despu├®s de insertar
+            const overlay = document.getElementById('edit-doc-modal-overlay');
+            const modalOpen = document.querySelector('[data-testid="edit-doc-modal-open"]');
+            console.log('[EDITMODAL] overlay inserted', !!overlay);
+            console.log('[EDITMODAL] overlay inserted check', !!document.querySelector('[data-testid="edit-doc-modal-overlay"]'));
+            
+            if (!overlay || !modalOpen) {
+                console.error('[showEditDocumentModal] ERROR: Modal elements not found after insertion!');
+            }
             
             // Actualizar lista de trabajadores si es necesario
             if (type.scope === 'worker') {
@@ -4438,39 +6151,61 @@
         function closeEditDocumentModal() {
             const overlay = document.getElementById('edit-doc-modal-overlay');
             if (overlay) {
+                // SPRINT C2.2: Establecer se├▒al de cierre antes de eliminar
+                overlay.setAttribute('data-modal-state', 'closed');
+                overlay.setAttribute('data-testid', 'edit-doc-modal-closed');
                 overlay.remove();
             }
             editingDocument = null;
         }
         
         async function saveDocumentEdit() {
-            if (!editingDocument) return;
+            console.log('[EDITMODAL] saveDocumentEdit called');
+            if (!editingDocument) {
+                console.warn('[EDITMODAL] saveDocumentEdit: no editingDocument');
+                return;
+            }
             
             const type = searchTypes.find(t => t.type_id === editingDocument.type_id);
             if (!type) {
+                console.error('[EDITMODAL] saveDocumentEdit: tipo no encontrado', editingDocument.type_id);
                 alert('Tipo de documento no encontrado');
                 return;
             }
             
+            console.log('[EDITMODAL] saveDocumentEdit: type scope', type.scope);
+            
             // Recopilar datos del formulario
             const updateData = {};
             
             if (type.scope === 'company') {
                 const companySelect = document.getElementById('edit-doc-company');
+                console.log('[EDITMODAL] saveDocumentEdit: companySelect', companySelect, 'value', companySelect?.value);
+                // SPRINT C2.2.3: Si no hay empresa seleccionada pero el documento ya tiene company_key, usarla
                 if (!companySelect || !companySelect.value) {
-                    alert('La empresa es obligatoria');
-                    return;
+                    if (editingDocument.company_key) {
+                        console.log('[EDITMODAL] saveDocumentEdit: usando company_key existente', editingDocument.company_key);
+                        updateData.company_key = editingDocument.company_key;
+                        updateData.person_key = null;
+                    } else {
+                        console.warn('[EDITMODAL] saveDocumentEdit: empresa obligatoria no encontrada');
+                        alert('La empresa es obligatoria');
+                        return;
+                    }
+                } else {
+                    updateData.company_key = companySelect.value;
+                    updateData.person_key = null;
                 }
-                updateData.company_key = companySelect.value;
-                updateData.person_key = null;
             } else if (type.scope === 'worker') {
                 const companySelect = document.getElementById('edit-doc-company');
                 const workerSelect = document.getElementById('edit-doc-worker');
                 if (!companySelect || !companySelect.value) {
+                    console.warn('[EDITMODAL] saveDocumentEdit: empresa obligatoria no encontrada');
                     alert('La empresa es obligatoria');
                     return;
                 }
                 if (!workerSelect || !workerSelect.value) {
+                    console.warn('[EDITMODAL] saveDocumentEdit: trabajador obligatorio no encontrado');
                     alert('El trabajador es obligatorio');
                     return;
                 }
@@ -4483,6 +6218,29 @@
                 updateData.status = statusSelect.value;
             }
             
+            // Recopilar campos de fechas y per├¡odo
+            const periodKeyInput = document.getElementById('edit-doc-period-key');
+            if (periodKeyInput && periodKeyInput.value) {
+                updateData.period_key = periodKeyInput.value.trim();
+            }
+            
+            const issueDateInput = document.getElementById('edit-doc-issue-date');
+            if (issueDateInput && issueDateInput.value) {
+                updateData.issue_date = issueDateInput.value;
+            }
+            
+            const validityStartDateInput = document.getElementById('edit-doc-validity-start-date');
+            if (validityStartDateInput && validityStartDateInput.value) {
+                updateData.validity_start_date = validityStartDateInput.value;
+            }
+            
+            // SPRINT C2.2: Mostrar mensaje de error en el modal si falla
+            const errorDiv = document.getElementById('edit-doc-error');
+            if (errorDiv) {
+                errorDiv.remove();
+            }
+            
+            console.log('[EDITMODAL] saveDocumentEdit: sending PUT', editingDocument.doc_id, updateData);
             try {
                 const response = await fetch(`${BACKEND_URL}/api/repository/docs/${editingDocument.doc_id}`, {
                     method: 'PUT',
@@ -4495,11 +6253,30 @@
                     throw new Error(error);
                 }
                 
-                // Recargar resultados
-                await performSearch();
+                // SPRINT C2.2.3: Cerrar modal inmediatamente despu├®s de PUT exitoso
+                console.log('[EDITMODAL] save ok -> closing modal');
                 closeEditDocumentModal();
+                
+                // SPRINT C2.2.3: Refrescar resultados en segundo plano (no bloquea el cierre)
+                try {
+                    await performSearch();
+                } catch (e) {
+                    console.warn('[EDITMODAL] performSearch failed after save', e);
+                }
             } catch (error) {
-                alert(`Error al guardar: ${error.message}`);
+                // SPRINT C2.2: Mostrar error en el modal en lugar de alert
+                const modalBody = document.querySelector('#edit-doc-modal-overlay .modal-body');
+                if (modalBody) {
+                    const errorDiv = document.createElement('div');
+                    errorDiv.id = 'edit-doc-error';
+                    errorDiv.setAttribute('data-testid', 'edit-doc-error');
+                    errorDiv.className = 'alert alert-error';
+                    errorDiv.style.marginTop = '16px';
+                    errorDiv.textContent = `Error al guardar: ${error.message}`;
+                    modalBody.appendChild(errorDiv);
+                } else {
+                    alert(`Error al guardar: ${error.message}`);
+                }
             }
         }
         
@@ -5626,28 +7403,49 @@
         async function loadConfiguracion() {
             const content = document.getElementById('page-content');
             
+            if (!content) {
+                throw new Error('page-content element not found');
+            }
+            
+            // SPRINT C2.1: Cargar configuraci├│n con manejo de errores robusto
+            // No bloquear el render si falla el fetch, pero mostrar mensaje
             try {
-                // Cargar configuraci├│n actual
                 const response = await fetch(`${BACKEND_URL}/api/repository/settings`);
                 if (response.ok) {
                     repositorySettings = await response.json();
                 } else {
-                    repositorySettings = { repository_root_dir: '' };
+                    // Si es 404, usar valores por defecto (no es cr├¡tico)
+                    if (response.status === 404) {
+                        console.warn('[config] Settings endpoint not found (404), using defaults');
+                        repositorySettings = { repository_root_dir: '' };
+                    } else {
+                        // Otros errores pueden ser cr├¡ticos, pero a├║n as├¡ continuar
+                        console.warn('[config] Failed to load settings:', response.status);
+                        repositorySettings = { repository_root_dir: '' };
+                    }
                 }
             } catch (error) {
+                // Error de red o fetch fallido - no cr├¡tico, continuar con valores por defecto
                 console.error('[config] Error loading settings:', error);
                 repositorySettings = { repository_root_dir: '' };
+                // No re-lanzar el error - permitir que el formulario se renderice con valores por defecto
+                // Pero mostrar mensaje de advertencia si es un error cr├¡tico
+                if (error.message && !error.message.includes('404')) {
+                    // Solo mostrar error si no es 404 (que es esperado si el endpoint no existe a├║n)
+                    console.warn('[config] Non-404 error loading settings, will render with defaults');
+                }
             }
             
+            // Renderizar siempre, incluso si fall├│ el fetch
             content.innerHTML = `
-                <div class="card">
+                <div class="card" data-testid="configuracion-view">
                     <h3>Configuraci├│n del Repositorio</h3>
                     <p style="color: #94a3b8; margin-bottom: 24px;">
                         Configura la ruta en el servidor donde se guardan los documentos subidos.
                         <strong>Nota:</strong> Esta ruta es del servidor donde corre CometLocal (tu PC).
                     </p>
                     
-                    <div class="form-group">
+                    <div class="form-group" data-testid="configuracion-settings">
                         <label class="form-label">Ruta del repositorio</label>
                         <input type="text" 
                                class="form-input" 
@@ -5666,7 +7464,7 @@
                         <button class="btn btn-secondary" onclick="testRepositoryPath()">
                             Probar ruta
                         </button>
-                        <button class="btn btn-primary" onclick="saveRepositorySettings()">
+                        <button class="btn btn-primary" data-testid="configuracion-save" onclick="saveRepositorySettings()">
                             Guardar
                         </button>
                     </div>
@@ -5674,6 +7472,20 @@
                     <div id="config-message" style="margin-top: 16px;"></div>
                 </div>
             `;
+            
+            // SPRINT C2.1: A├▒adir se├▒al cuando el formulario est├í renderizado
+            const formInput = document.getElementById('config-repository-root');
+            if (formInput) {
+                formInput.setAttribute('data-testid', 'settings-ui-ready');
+                // Tambi├®n en el contenedor principal para compatibilidad
+                const card = content.querySelector('.card');
+                if (card) {
+                    // SPRINT C2.8: Asegurar que configuracion-view est├í presente (el innerHTML ya lo incluye, pero lo verificamos)
+                    card.setAttribute('data-testid', 'configuracion-view');
+                    // Mantener tambi├®n settings-ui-ready para compatibilidad
+                    card.setAttribute('data-settings-ui-ready', 'true');
+                }
+            }
         }
         
         async function testRepositoryPath() {
@@ -5730,7 +7542,7 @@
             const path = input.value.trim();
             
             if (!path) {
-                messageDiv.innerHTML = '<div class="alert alert-error">Por favor, introduce una ruta.</div>';
+                messageDiv.innerHTML = '<div class="alert alert-error" data-testid="configuracion-error">Por favor, introduce una ruta.</div>';
                 return;
             }
             
@@ -5758,20 +7570,24 @@
                             <br><strong>Nota:</strong> Los nuevos documentos se guardar├ín en esta ruta.
                         </div>
                     `;
+                    // Asegurar que la vista vuelve a ready despu├®s de guardar exitosamente
+                    setViewState('settings', 'ready');
                 } else {
                     const error = await response.json();
                     messageDiv.innerHTML = `
-                        <div class="alert alert-error">
+                        <div class="alert alert-error" data-testid="configuracion-error">
                             Ô£ù Error al guardar: ${error.detail || 'Error desconocido'}
                         </div>
                     `;
+                    setViewState('settings', 'error', error.detail || 'Error desconocido');
                 }
             } catch (error) {
                 messageDiv.innerHTML = `
-                    <div class="alert alert-error">
+                    <div class="alert alert-error" data-testid="configuracion-error">
                         Ô£ù Error de conexi├│n: ${error.message}
                     </div>
                 `;
+                setViewState('settings', 'error', error.message);
             }
         }
         
@@ -5932,6 +7748,1797 @@
                 showErrorBanner(`Promesa rechazada sin manejar: ${error.message}`, error);
             }
         });
+        
+        // ========== CAE Plan Modal ==========
+        
+        let caePlanModalOpen = false;
+        let caePlanPlatforms = [];
+        
+        async function openCAEPlanModal() {
+            caePlanModalOpen = true;
+            
+            // Cargar plataformas
+            try {
+                const platformsRes = await fetch(`${BACKEND_URL}/api/config/platforms`).catch(() => null);
+                if (platformsRes && platformsRes.ok) {
+                    const platformsData = await platformsRes.json();
+                    caePlanPlatforms = platformsData.platforms || [];
+                } else {
+                    // Fallback: hardcode m├¡nimo con egestiona
+                    caePlanPlatforms = [{ key: 'egestiona', label: 'eGestiona' }];
+                }
+            } catch (e) {
+                caePlanPlatforms = [{ key: 'egestiona', label: 'eGestiona' }];
+            }
+            
+            // Obtener tipos visibles en el calendario
+            const visibleTypes = calendarTypes || [];
+            
+            // Obtener per├¡odos visibles
+            const pendingData = window.pendingDocumentsData || { missing: [] };
+            const visiblePeriods = [...new Set(pendingData.missing.map(p => p.period_key).filter(Boolean))].sort().reverse();
+            
+            // Crear modal
+            const modal = document.createElement('div');
+            modal.id = 'cae-plan-modal';
+            modal.setAttribute('data-testid', 'cae-plan-modal');
+            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
+            modal.innerHTML = `
+                <div style="background: #1e293b; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #334155;">
+                    <h2 style="margin-bottom: 24px;">Preparar env├¡o CAE (filtrado)</h2>
+                    
+                    <div class="form-group" style="margin-bottom: 16px;">
+                        <label class="form-label">Plataforma</label>
+                        <select id="cae-plan-platform" class="form-input" data-testid="cae-plan-platform">
+                            ${caePlanPlatforms.map(p => `
+                                <option value="${escapeHtml(p.key)}">${escapeHtml(p.label || p.key)}</option>
+                            `).join('')}
+                        </select>
+                    </div>
+                    
+                    <div class="form-group" style="margin-bottom: 16px;">
+                        <label class="form-label">Tipo</label>
+                        <select id="cae-plan-type-mode" class="form-input" onchange="updateCAEPlanTypeOptions()" data-testid="cae-plan-type-mode">
+                            <option value="all">Todos los tipos visibles</option>
+                            <option value="filtered">Solo tipo seleccionado en filtro</option>
+                            <option value="multi">Multi-select de tipos visibles</option>
+                        </select>
+                    </div>
+                    
+                    <div id="cae-plan-type-multi-container" style="display: none; margin-bottom: 16px;">
+                        <label class="form-label">Seleccionar tipos</label>
+                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #334155; padding: 8px; border-radius: 4px;">
+                            ${visibleTypes.map(type => `
+                                <label style="display: block; margin-bottom: 8px;">
+                                    <input type="checkbox" class="cae-plan-type-checkbox" value="${escapeHtml(type.type_id)}" data-testid="cae-plan-type-${escapeHtml(type.type_id)}">
+                                    ${escapeHtml(type.name)} (${escapeHtml(type.type_id)})
+                                </label>
+                            `).join('')}
+                        </div>
+                    </div>
+                    
+                    <div class="form-group" style="margin-bottom: 16px;">
+                        <label class="form-label">Sujeto</label>
+                        <select id="cae-plan-subject-mode" class="form-input" onchange="updateCAEPlanSubjectOptions()" data-testid="cae-plan-subject-mode">
+                            <option value="all">Todos los sujetos visibles</option>
+                            <option value="filtered">Solo sujeto seleccionado en filtro</option>
+                            <option value="specific">Especificar empresa/trabajador</option>
+                        </select>
+                    </div>
+                    
+                    <div id="cae-plan-subject-specific-container" style="display: none; margin-bottom: 16px;">
+                        <div class="form-group" style="margin-bottom: 8px;">
+                            <label class="form-label">Empresa</label>
+                            <input type="text" id="cae-plan-company-key" class="form-input" placeholder="Clave de empresa" data-testid="cae-plan-company-key">
+                        </div>
+                        <div class="form-group" style="margin-bottom: 8px;">
+                            <label class="form-label">Trabajador</label>
+                            <input type="text" id="cae-plan-person-key" class="form-input" placeholder="Clave de trabajador (opcional)" data-testid="cae-plan-person-key">
+                        </div>
+                    </div>
+                    
+                    <div class="form-group" style="margin-bottom: 16px;">
+                        <label class="form-label">Per├¡odo</label>
+                        <select id="cae-plan-period-mode" class="form-input" onchange="updateCAEPlanPeriodOptions()" data-testid="cae-plan-period-mode">
+                            <option value="all">Todos los per├¡odos visibles</option>
+                            <option value="specific">Especificar per├¡odos</option>
+                        </select>
+                    </div>
+                    
+                    <div id="cae-plan-period-specific-container" style="display: none; margin-bottom: 16px;">
+                        <label class="form-label">Per├¡odos (separados por comas, ej: 2025-12, 2026-01)</label>
+                        <input type="text" id="cae-plan-period-keys" class="form-input" placeholder="2025-12, 2026-01" data-testid="cae-plan-period-keys">
+                        <small style="color: #94a3b8; display: block; margin-top: 4px;">Per├¡odos visibles: ${visiblePeriods.slice(0, 10).join(', ')}${visiblePeriods.length > 10 ? '...' : ''}</small>
+                    </div>
+                    
+                    <div class="form-group" style="margin-bottom: 16px;">
+                        <label class="form-label">Modo</label>
+                        <select id="cae-plan-mode" class="form-input" data-testid="cae-plan-mode">
+                            <option value="READ_ONLY">READ_ONLY</option>
+                            <option value="PREPARE_WRITE">PREPARE_WRITE</option>
+                        </select>
+                    </div>
+                    
+                    <div id="cae-plan-result" data-testid="cae-plan-result" style="display: none; margin-bottom: 16px; padding: 16px; background: #0f172a; border-radius: 4px; border: 1px solid #334155;"></div>
+                    
+                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
+                        <button class="btn btn-secondary" onclick="closeCAEPlanModal()" data-testid="cae-plan-cancel">Cancelar</button>
+                        <button class="btn btn-primary" onclick="generateCAEPlan()" data-testid="cae-plan-generate">Generar plan</button>
+                    </div>
+                </div>
+            `;
+            
+            document.body.appendChild(modal);
+            
+            // Cerrar al hacer click fuera
+            modal.addEventListener('click', (e) => {
+                if (e.target === modal) {
+                    closeCAEPlanModal();
+                }
+            });
+        }
+        
+        function closeCAEPlanModal() {
+            const modal = document.getElementById('cae-plan-modal');
+            if (modal) {
+                modal.remove();
+            }
+            caePlanModalOpen = false;
+        }
+        
+        function updateCAEPlanTypeOptions() {
+            const mode = document.getElementById('cae-plan-type-mode').value;
+            const multiContainer = document.getElementById('cae-plan-type-multi-container');
+            if (mode === 'multi') {
+                multiContainer.style.display = 'block';
+            } else {
+                multiContainer.style.display = 'none';
+            }
+        }
+        
+        function updateCAEPlanSubjectOptions() {
+            const mode = document.getElementById('cae-plan-subject-mode').value;
+            const specificContainer = document.getElementById('cae-plan-subject-specific-container');
+            if (mode === 'specific') {
+                specificContainer.style.display = 'block';
+            } else {
+                specificContainer.style.display = 'none';
+            }
+        }
+        
+        function updateCAEPlanPeriodOptions() {
+            const mode = document.getElementById('cae-plan-period-mode').value;
+            const specificContainer = document.getElementById('cae-plan-period-specific-container');
+            if (mode === 'specific') {
+                specificContainer.style.display = 'block';
+            } else {
+                specificContainer.style.display = 'none';
+            }
+        }
+        
+        async function generateCAEPlan() {
+            const resultDiv = document.getElementById('cae-plan-result');
+            const modal = document.getElementById('cae-plan-modal');
+            
+            // SPRINT C2.9.11: Marker invariante de estado de generaci├│n
+            // Crear/actualizar marker en el modal (estable, no se pisa con innerHTML)
+            let stateMarker = modal ? modal.querySelector('[data-testid="cae-plan-generation-state"]') : null;
+            if (!stateMarker && modal) {
+                stateMarker = document.createElement('div');
+                stateMarker.setAttribute('data-testid', 'cae-plan-generation-state');
+                stateMarker.style.display = 'none';
+                modal.appendChild(stateMarker);
+            }
+            if (stateMarker) {
+                stateMarker.setAttribute('data-state', 'running');
+                stateMarker.removeAttribute('data-outcome');
+                stateMarker.removeAttribute('data-decision');
+                stateMarker.removeAttribute('data-error');
+            }
+            
+            resultDiv.style.display = 'block';
+            resultDiv.innerHTML = '<div style="color: #94a3b8;">Generando plan...</div>';
+            
+            try {
+                // Recopilar scope
+                const platformKey = document.getElementById('cae-plan-platform').value;
+                const typeMode = document.getElementById('cae-plan-type-mode').value;
+                const subjectMode = document.getElementById('cae-plan-subject-mode').value;
+                const periodMode = document.getElementById('cae-plan-period-mode').value;
+                const mode = document.getElementById('cae-plan-mode').value;
+                
+                // Resolver type_ids
+                let typeIds = [];
+                if (typeMode === 'all') {
+                    // Todos los tipos visibles
+                    typeIds = (calendarTypes || []).map(t => t.type_id);
+                } else if (typeMode === 'filtered') {
+                    // Solo tipo del filtro
+                    if (calendarFilters.type_id) {
+                        typeIds = [calendarFilters.type_id];
+                    }
+                } else if (typeMode === 'multi') {
+                    // Multi-select
+                    const checkboxes = document.querySelectorAll('.cae-plan-type-checkbox:checked');
+                    typeIds = Array.from(checkboxes).map(cb => cb.value);
+                }
+                
+                // Resolver company_key y person_key
+                let companyKey = null;
+                let personKey = null;
+                if (subjectMode === 'filtered') {
+                    // Usar filtros actuales
+                    if (calendarFilters.subject_key) {
+                        // Determinar si es empresa o trabajador
+                        const subjectsCache = window.subjectsCache || { companies: {}, people: {} };
+                        if (subjectsCache.companies[calendarFilters.subject_key]) {
+                            companyKey = calendarFilters.subject_key;
+                        } else if (subjectsCache.people[calendarFilters.subject_key]) {
+                            personKey = calendarFilters.subject_key;
+                            // Necesitamos company_key tambi├®n para trabajadores
+                            const pendingData = window.pendingDocumentsData || { missing: [] };
+                            const item = pendingData.missing.find(m => m.person_key === calendarFilters.subject_key);
+                            if (item) {
+                                companyKey = item.company_key;
+                            }
+                        }
+                    }
+                } else if (subjectMode === 'specific') {
+                    companyKey = document.getElementById('cae-plan-company-key').value.trim() || null;
+                    personKey = document.getElementById('cae-plan-person-key').value.trim() || null;
+                }
+                
+                // Resolver period_keys
+                let periodKeys = null;
+                if (periodMode === 'specific') {
+                    const periodKeysInput = document.getElementById('cae-plan-period-keys').value.trim();
+                    if (periodKeysInput) {
+                        periodKeys = periodKeysInput.split(',').map(p => p.trim()).filter(Boolean);
+                    }
+                }
+                
+                // Construir scope
+                const scope = {
+                    platform_key: platformKey,
+                    type_ids: typeIds,
+                    company_key: companyKey,
+                    person_key: personKey,
+                    period_keys: periodKeys,
+                    mode: mode,
+                };
+                
+                // Llamar al endpoint
+                const response = await fetch(`${BACKEND_URL}/api/cae/plan`, {
+                    method: 'POST',
+                    headers: {
+                        'Content-Type': 'application/json',
+                    },
+                    body: JSON.stringify({ scope }),
+                });
+                
+                if (!response.ok) {
+                    throw new Error(`Error ${response.status}: ${await response.text()}`);
+                }
+                
+                const plan = await response.json();
+                
+                // Mostrar resultado
+                const decisionBadge = plan.decision === 'READY' ? 'badge-success' : 
+                                     plan.decision === 'NEEDS_CONFIRMATION' ? 'badge-warning' : 
+                                     'badge-error';
+                
+                // SPRINT C2.7: A├▒adir testid y data-decision para determinismo
+                resultDiv.innerHTML = `
+                    <h3 style="margin-bottom: 8px;">Plan generado: ${escapeHtml(plan.plan_id)}</h3>
+                    <div style="margin-bottom: 8px;" data-testid="cae-plan-decision" data-decision="${escapeHtml(plan.decision)}">
+                        <span class="badge ${decisionBadge}">${escapeHtml(plan.decision)}</span>
+                    </div>
+                    <div style="margin-bottom: 8px;">
+                        <strong>Resumen:</strong>
+                        <ul style="margin: 8px 0; padding-left: 20px;">
+                            <li>Items pendientes: ${plan.summary.pending_items || 0}</li>
+                            <li>Candidatos de documentos: ${plan.summary.docs_candidates || 0}</li>
+                            <li>Total items: ${plan.summary.total_items || 0}</li>
+                        </ul>
+                    </div>
+                    ${plan.reasons && plan.reasons.length > 0 ? `
+                        <div style="margin-bottom: 8px;">
+                            <strong>Razones:</strong>
+                            <ul style="margin: 8px 0; padding-left: 20px;">
+                                ${plan.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
+                            </ul>
+                        </div>
+                    ` : ''}
+                    ${plan.decision === 'READY' ? `
+                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
+                            <button class="btn btn-primary" onclick="startCAEExecution('${escapeHtml(plan.plan_id)}')" data-testid="cae-execute-button">
+                                Ejecutar en eGestiona
+                            </button>
+                        </div>
+                    ` : ''}
+                `;
+                
+                // Guardar plan_id en el modal para uso posterior
+                resultDiv.setAttribute('data-plan-id', plan.plan_id);
+                
+                // SPRINT C2.9.11: Actualizar marker a success
+                if (stateMarker) {
+                    stateMarker.setAttribute('data-state', 'done');
+                    stateMarker.setAttribute('data-outcome', 'success');
+                    stateMarker.setAttribute('data-decision', plan.decision || '');
+                }
+            } catch (error) {
+                // SPRINT C2.7: A├▒adir testid para errores
+                resultDiv.innerHTML = `
+                    <div class="alert alert-error" data-testid="cae-plan-error">
+                        Error al generar plan: ${escapeHtml(error.message)}
+                    </div>
+                `;
+                
+                // SPRINT C2.9.11: Actualizar marker a error
+                if (stateMarker) {
+                    stateMarker.setAttribute('data-state', 'done');
+                    stateMarker.setAttribute('data-outcome', 'error');
+                    stateMarker.setAttribute('data-error', error.message || 'Unknown error');
+                }
+            } finally {
+                // SPRINT C2.9.11: Garantizar que el marker nunca se quede en "running"
+                if (stateMarker && stateMarker.getAttribute('data-state') === 'running') {
+                    stateMarker.setAttribute('data-state', 'done');
+                    if (!stateMarker.hasAttribute('data-outcome')) {
+                        stateMarker.setAttribute('data-outcome', 'error');
+                        stateMarker.setAttribute('data-error', 'Generation was interrupted');
+                    }
+                }
+            }
+        }
+        
+        async function startCAEExecution(planId) {
+            // Buscar en ambos modales (plan filtrado y selecci├│n)
+            let resultDiv = document.getElementById('cae-plan-result');
+            let executeButton = resultDiv ? resultDiv.querySelector('[data-testid="cae-execute-button"]') : null;
+            
+            if (!resultDiv || !executeButton) {
+                // Intentar en el modal de selecci├│n
+                resultDiv = document.getElementById('cae-selection-result');
+                executeButton = resultDiv ? resultDiv.querySelector('[data-testid="cae-execute-button"]') : null;
+            }
+            
+            if (!resultDiv) {
+                console.error('[repo] No se encontr├│ el div de resultado para ejecutar el plan');
+                return;
+            }
+            
+            if (executeButton) {
+                executeButton.disabled = true;
+                executeButton.textContent = 'Obteniendo challenge...';
+            }
+            
+            try {
+                // 1. Obtener challenge
+                const challengeResponse = await fetch(`${BACKEND_URL}/api/cae/execute/${planId}/challenge`, {
+                    method: 'POST',
+                    headers: {
+                        'Content-Type': 'application/json',
+                    },
+                    body: JSON.stringify({}),
+                });
+                
+                if (!challengeResponse.ok) {
+                    throw new Error(`Error ${challengeResponse.status}: ${await challengeResponse.text()}`);
+                }
+                
+                const challenge = await challengeResponse.json();
+                
+                // 2. Mostrar challenge y pedir confirmaci├│n
+                const challengeDiv = document.createElement('div');
+                challengeDiv.style.marginTop = '16px';
+                challengeDiv.style.padding = '16px';
+                challengeDiv.style.background = '#1e293b';
+                challengeDiv.style.borderRadius = '4px';
+                challengeDiv.style.border = '1px solid #334155';
+                challengeDiv.innerHTML = `
+                    <h4 style="margin-bottom: 8px;">Confirmar ejecuci├│n</h4>
+                    <p style="margin-bottom: 8px; color: #94a3b8;">${escapeHtml(challenge.prompt)}</p>
+                    <div style="margin-bottom: 8px;">
+                        <label for="cae-challenge-response" style="display: block; margin-bottom: 4px;">Escribe la respuesta exacta:</label>
+                        <input type="text" id="cae-challenge-response" class="form-input" placeholder="${escapeHtml(challenge.prompt)}" style="width: 100%;">
+                    </div>
+                    <div style="margin-bottom: 8px;">
+                        <label style="display: flex; align-items: center; gap: 8px;">
+                            <input type="checkbox" id="cae-dry-run" checked>
+                            <span>Dry run (simulaci├│n, no ejecuta realmente)</span>
+                        </label>
+                    </div>
+                    <div style="display: flex; gap: 8px;">
+                        <button class="btn btn-primary" onclick="confirmCAEExecution('${escapeHtml(planId)}', '${escapeHtml(challenge.challenge_token)}')" data-testid="cae-confirm-execute-button">
+                            Confirmar y Ejecutar
+                        </button>
+                        <button class="btn btn-secondary" onclick="cancelCAEExecution()">
+                            Cancelar
+                        </button>
+                    </div>
+                `;
+                
+                resultDiv.appendChild(challengeDiv);
+                
+            } catch (error) {
+                if (executeButton) {
+                    executeButton.disabled = false;
+                    executeButton.textContent = 'Ejecutar en eGestiona';
+                }
+                alert(`Error al obtener challenge: ${error.message}`);
+            }
+        }
+        
+        // v1.8: Usar enqueue en lugar de execute directo
+        async function confirmCAEExecution(planId, challengeToken) {
+            // Buscar en ambos modales (plan filtrado y selecci├│n)
+            let resultDiv = document.getElementById('cae-plan-result');
+            if (!resultDiv) {
+                resultDiv = document.getElementById('cae-selection-result');
+            }
+            
+            // Si a├║n no se encuentra, buscar en el modal de selecci├│n
+            if (!resultDiv) {
+                const selectionModal = document.getElementById('cae-selection-modal');
+                if (selectionModal) {
+                    resultDiv = selectionModal.querySelector('#cae-selection-result');
+                }
+            }
+            
+            const challengeResponseInput = document.getElementById('cae-challenge-response');
+            const dryRunCheckbox = document.getElementById('cae-dry-run');
+            const confirmButton = resultDiv ? resultDiv.querySelector('[data-testid="cae-confirm-execute-button"]') : null;
+            
+            console.log('[repo] confirmCAEExecution called, resultDiv:', resultDiv ? resultDiv.id : 'NOT FOUND');
+            
+            if (!challengeResponseInput || !challengeResponseInput.value.trim()) {
+                alert('Por favor, escribe la respuesta del challenge');
+                return;
+            }
+            
+            if (confirmButton) {
+                confirmButton.disabled = true;
+                confirmButton.textContent = 'Encolando...';
+            }
+            
+            // Verificar que resultDiv existe antes de continuar
+            if (!resultDiv) {
+                throw new Error('resultDiv no encontrado. No se puede mostrar el progreso.');
+            }
+            
+            try {
+                // v1.8: Encolar job en lugar de ejecutar directamente
+                const enqueueResponse = await fetch(`${BACKEND_URL}/api/cae/execute/${planId}/enqueue`, {
+                    method: 'POST',
+                    headers: {
+                        'Content-Type': 'application/json',
+                    },
+                    body: JSON.stringify({
+                        challenge_token: challengeToken,
+                        challenge_response: challengeResponseInput.value.trim(),
+                        dry_run: dryRunCheckbox ? dryRunCheckbox.checked : false,
+                    }),
+                });
+                
+                if (!enqueueResponse.ok) {
+                    const errorText = await enqueueResponse.text();
+                    throw new Error(`Error ${enqueueResponse.status}: ${errorText}`);
+                }
+                
+                const job = await enqueueResponse.json();
+                console.log('[repo] Job enqueued:', job.job_id);
+                
+                // Remover el div de challenge
+                const challengeDiv = resultDiv.querySelector('div[style*="background: #1e293b"]');
+                if (challengeDiv) {
+                    challengeDiv.remove();
+                }
+                
+                // Mostrar progreso y empezar polling
+                const progressDiv = document.createElement('div');
+                progressDiv.id = 'cae-job-progress';
+                progressDiv.style.marginTop = '16px';
+                progressDiv.style.padding = '16px';
+                progressDiv.style.background = '#1e293b';
+                progressDiv.style.borderRadius = '4px';
+                progressDiv.style.border = '1px solid #334155';
+                
+                // v1.8.2: Establecer atributos iniciales inmediatamente para E2E determinista
+                progressDiv.setAttribute('data-job-status', 'QUEUED');
+                progressDiv.setAttribute('data-job-progress', '0');
+                progressDiv.setAttribute('data-job-id', job.job_id);
+                
+                console.log('[repo] Appending progress div to resultDiv:', resultDiv.id);
+                resultDiv.appendChild(progressDiv);
+                console.log('[repo] Progress div appended, starting polling');
+                
+                // Iniciar polling
+                pollJobStatus(job.job_id, progressDiv);
+                
+            } catch (error) {
+                console.error('[repo] Error en confirmCAEExecution:', error);
+                if (confirmButton) {
+                    confirmButton.disabled = false;
+                    confirmButton.textContent = 'Confirmar y Ejecutar';
+                }
+                // Mostrar error en el div de resultado en lugar de alert
+                if (!resultDiv) {
+                    // Si no hay resultDiv, intentar encontrarlo de nuevo
+                    resultDiv = document.getElementById('cae-plan-result') || document.getElementById('cae-selection-result');
+                }
+                if (resultDiv) {
+                    const errorDiv = document.createElement('div');
+                    errorDiv.id = 'cae-job-progress';
+                    errorDiv.style.background = '#7f1d1d';
+                    errorDiv.style.color = '#fca5a5';
+                    errorDiv.style.padding = '16px';
+                    errorDiv.style.borderRadius = '8px';
+                    errorDiv.style.marginTop = '16px';
+                    errorDiv.setAttribute('data-job-status', 'FAILED');
+                    errorDiv.setAttribute('data-job-progress', '0');
+                    const errorMsg = error.message || error.toString() || 'Error desconocido';
+                    console.error('[repo] Error message:', errorMsg);
+                    errorDiv.innerHTML = `<strong>Error:</strong> ${escapeHtml(errorMsg)}`;
+                    resultDiv.appendChild(errorDiv);
+                } else {
+                    alert(`Error al encolar ejecuci├│n: ${error.message}`);
+                }
+            }
+        }
+        
+        // v1.8: Polling del estado del job
+        async function pollJobStatus(jobId, progressDiv) {
+            const pollInterval = 800; // 800ms entre polls
+            const maxPolls = 300; // M├íximo 4 minutos (300 * 800ms)
+            let pollCount = 0;
+            
+            const poll = async () => {
+                try {
+                    const response = await fetch(`${BACKEND_URL}/api/cae/jobs/${jobId}`);
+                    if (!response.ok) {
+                        throw new Error(`Error ${response.status}: ${await response.text()}`);
+                    }
+                    
+                    const job = await response.json();
+                    
+                    // Actualizar UI con progreso
+                    const statusBadge = job.status === 'SUCCESS' ? 'badge-success' :
+                                       job.status === 'PARTIAL_SUCCESS' ? 'badge-warning' :
+                                       job.status === 'BLOCKED' ? 'badge-warning' :
+                                       job.status === 'FAILED' ? 'badge-error' :
+                                       job.status === 'CANCELED' ? 'badge' :
+                                       job.status === 'RUNNING' ? 'badge-info' :
+                                       'badge';
+                    
+                    const progress = job.progress || {};
+                    const percent = progress.percent || 0;
+                    const message = progress.message || 'Procesando...';
+                    
+                    // v1.8.2: A├▒adir atributos data-testid expl├¡citos para E2E determinista
+                    progressDiv.setAttribute('data-job-status', job.status);
+                    progressDiv.setAttribute('data-job-progress', percent.toString());
+                    progressDiv.setAttribute('data-job-id', jobId);
+                    
+                    // v1.9: A├▒adir botones de control seg├║n estado
+                    let controlButtons = '';
+                    
+                    // Bot├│n Cancelar (solo si est├í QUEUED o RUNNING)
+                    if (job.status === 'QUEUED' || job.status === 'RUNNING') {
+                        controlButtons += `
+                            <button class="btn btn-secondary btn-sm" onclick="cancelCAEJob('${jobId}')" 
+                                    data-testid="job-cancel-button" style="margin-right: 8px;">
+                                Cancelar
+                            </button>
+                        `;
+                    }
+                    
+                    // Bot├│n Reintentar (solo si est├í FAILED o PARTIAL_SUCCESS)
+                    if (job.status === 'FAILED' || job.status === 'PARTIAL_SUCCESS') {
+                        controlButtons += `
+                            <button class="btn btn-warning btn-sm" onclick="retryCAEJob('${jobId}')" 
+                                    data-testid="job-retry-button" style="margin-right: 8px;">
+                                Reintentar
+                            </button>
+                        `;
+                    }
+                    
+                    // Bot├│n Descargar informe (si est├í terminal)
+                    if (job.status === 'SUCCESS' || job.status === 'PARTIAL_SUCCESS' || 
+                        job.status === 'FAILED' || job.status === 'BLOCKED' || job.status === 'CANCELED') {
+                        controlButtons += `
+                            <button class="btn btn-primary btn-sm" onclick="downloadCAEJobReport('${jobId}')" 
+                                    data-testid="job-report-button">
+                                Descargar informe
+                            </button>
+                        `;
+                    }
+                    
+                    progressDiv.innerHTML = `
+                        <h4 style="margin-bottom: 8px;">Ejecuci├│n en progreso</h4>
+                        <div style="margin-bottom: 8px;">
+                            <span class="badge ${statusBadge}" data-testid="job-status-badge">${escapeHtml(job.status)}</span>
+                        </div>
+                        <div style="margin-bottom: 12px;">
+                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
+                                <span data-testid="job-message">${escapeHtml(message)}</span>
+                                <span data-testid="job-percent">${percent}%</span>
+                            </div>
+                            <div style="width: 100%; height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden;">
+                                <div style="width: ${percent}%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
+                            </div>
+                        </div>
+                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; font-size: 0.875rem;">
+                            <div>
+                                <strong>Total:</strong> ${progress.total_items || 0}
+                            </div>
+                            <div style="color: #10b981;">
+                                <strong>├ëxito:</strong> ${progress.items_success || 0}
+                            </div>
+                            <div style="color: #ef4444;">
+                                <strong>Fallos:</strong> ${progress.items_failed || 0}
+                            </div>
+                        </div>
+                        ${job.error ? `
+                            <div style="margin-bottom: 8px; color: #ef4444;">
+                                <strong>Error:</strong> ${escapeHtml(job.error)}
+                            </div>
+                        ` : ''}
+                        ${controlButtons ? `
+                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #334155;">
+                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
+                                    ${controlButtons}
+                                </div>
+                            </div>
+                        ` : ''}
+                    `;
+                    
+                    // Si termin├│, mostrar resultado final
+                    if (job.status === 'SUCCESS' || job.status === 'PARTIAL_SUCCESS' || 
+                        job.status === 'FAILED' || job.status === 'BLOCKED' || job.status === 'CANCELED') {
+                        progressDiv.innerHTML += `
+                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;" data-testid="job-completed-message">
+                                <div style="margin-bottom: 8px;" data-testid="job-run-id">
+                                    <strong>Run ID:</strong> ${escapeHtml(job.run_id || 'N/A')}
+                                </div>
+                                ${job.evidence_path ? `
+                                    <div style="margin-bottom: 8px;" data-testid="job-evidence-path">
+                                        <strong>Evidencia:</strong> ${escapeHtml(job.evidence_path)}
+                                    </div>
+                                ` : ''}
+                                <div style="margin-top: 8px; color: ${job.status === 'SUCCESS' ? '#10b981' : job.status === 'FAILED' ? '#ef4444' : job.status === 'CANCELED' ? '#6b7280' : '#f59e0b'}; font-weight: 500;">
+                                    ${job.status === 'SUCCESS' ? 'Ô£ô Completado exitosamente' : 
+                                      job.status === 'PARTIAL_SUCCESS' ? 'ÔÜá Completado parcialmente' :
+                                      job.status === 'FAILED' ? 'Ô£ù Fall├│' :
+                                      job.status === 'CANCELED' ? 'Ôèÿ Cancelado' :
+                                      'ÔÜá Bloqueado'}
+                                </div>
+                            </div>
+                        `;
+                        // v1.8.2: Asegurar que el atributo data-job-status est├í actualizado
+                        progressDiv.setAttribute('data-job-status', job.status);
+                        progressDiv.setAttribute('data-job-progress', '100');
+                        return; // Detener polling
+                    }
+                    
+                    // Continuar polling si no termin├│
+                    pollCount++;
+                    if (pollCount < maxPolls) {
+                        setTimeout(poll, pollInterval);
+                    } else {
+                        progressDiv.innerHTML += `
+                            <div style="margin-top: 16px; color: #f59e0b;">
+                                <strong>Timeout:</strong> La ejecuci├│n est├í tardando m├ís de lo esperado. Verifica el estado manualmente.
+                            </div>
+                        `;
+                    }
+                    
+                } catch (error) {
+                    progressDiv.innerHTML += `
+                        <div style="margin-top: 16px; color: #ef4444;">
+                            <strong>Error al consultar estado:</strong> ${escapeHtml(error.message)}
+                        </div>
+                    `;
+                }
+            };
+            
+            // Iniciar polling
+            poll();
+        }
+        
+        // v1.9: Funciones de control de jobs
+        async function cancelCAEJob(jobId) {
+            if (!confirm('┬┐Est├ís seguro de que quieres cancelar este job?')) {
+                return;
+            }
+            
+            try {
+                const response = await fetch(`${BACKEND_URL}/api/cae/jobs/${jobId}/cancel`, {
+                    method: 'POST',
+                    headers: {
+                        'Content-Type': 'application/json',
+                    },
+                });
+                
+                if (!response.ok) {
+                    const errorText = await response.text();
+                    throw new Error(`Error ${response.status}: ${errorText}`);
+                }
+                
+                // Refrescar estado del job
+                const job = await response.json();
+                const progressDiv = document.querySelector(`[data-job-id="${jobId}"]`);
+                if (progressDiv) {
+                    // Forzar actualizaci├│n del polling
+                    await pollJobStatus(jobId, progressDiv);
+                }
+            } catch (error) {
+                console.error('[repo] Error al cancelar job:', error);
+                alert(`Error al cancelar job: ${error.message}`);
+            }
+        }
+        
+        async function retryCAEJob(jobId) {
+            // Buscar el div de progreso del job original
+            const progressDiv = document.querySelector(`[data-job-id="${jobId}"]`);
+            if (!progressDiv) {
+                alert('No se encontr├│ el job para reintentar');
+                return;
+            }
+            
+            // Confirmar con el usuario
+            if (!confirm('┬┐Crear un nuevo job como reintento de este?')) {
+                return;
+            }
+            
+            try {
+                const response = await fetch(`${BACKEND_URL}/api/cae/jobs/${jobId}/retry`, {
+                    method: 'POST',
+                    headers: {
+                        'Content-Type': 'application/json',
+                    },
+                });
+                
+                if (!response.ok) {
+                    const errorText = await response.text();
+                    throw new Error(`Error ${response.status}: ${errorText}`);
+                }
+                
+                const newJob = await response.json();
+                console.log('[repo] New retry job created:', newJob.job_id);
+                
+                // v1.9.1: Crear nuevo div de progreso para el nuevo job
+                // Buscar el contenedor padre (resultDiv)
+                let resultDiv = progressDiv.closest('#cae-plan-result') || progressDiv.closest('#cae-selection-result');
+                if (!resultDiv) {
+                    // Si no hay resultDiv, usar el padre del progressDiv
+                    resultDiv = progressDiv.parentElement;
+                }
+                
+                if (resultDiv) {
+                    // Crear nuevo div de progreso para el nuevo job
+                    const newProgressDiv = document.createElement('div');
+                    newProgressDiv.id = 'cae-job-progress';
+                    newProgressDiv.style.marginTop = '16px';
+                    newProgressDiv.style.padding = '16px';
+                    newProgressDiv.style.background = '#1e293b';
+                    newProgressDiv.style.borderRadius = '4px';
+                    newProgressDiv.style.border = '1px solid #334155';
+                    newProgressDiv.setAttribute('data-job-status', 'QUEUED');
+                    newProgressDiv.setAttribute('data-job-progress', '0');
+                    newProgressDiv.setAttribute('data-job-id', newJob.job_id);
+                    
+                    // A├▒adir mensaje indicando que es un retry
+                    newProgressDiv.innerHTML = `
+                        <h4 style="margin-bottom: 8px;">Reintento de job ${escapeHtml(jobId)}</h4>
+                        <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 8px;">
+                            Nuevo job ID: <strong>${escapeHtml(newJob.job_id)}</strong>
+                        </p>
+                    `;
+                    
+                    // v1.9.1: Insertar despu├®s del div de progreso original
+                    // Asegurar que se inserta correctamente en el DOM
+                    const parentNode = progressDiv.parentNode;
+                    if (parentNode) {
+                        parentNode.insertBefore(newProgressDiv, progressDiv.nextSibling);
+                        console.log('[repo] New progress div inserted for retry job:', newJob.job_id);
+                    } else {
+                        // Fallback: a├▒adir al resultDiv
+                        resultDiv.appendChild(newProgressDiv);
+                        console.log('[repo] New progress div appended to resultDiv for retry job:', newJob.job_id);
+                    }
+                    
+                    // Iniciar polling del nuevo job
+                    pollJobStatus(newJob.job_id, newProgressDiv);
+                } else {
+                    alert(`Nuevo job creado: ${newJob.job_id}`);
+                }
+            } catch (error) {
+                console.error('[repo] Error al reintentar job:', error);
+                alert(`Error al reintentar job: ${error.message}`);
+            }
+        }
+        
+        function downloadCAEJobReport(jobId) {
+            // Abrir informe en nueva pesta├▒a
+            window.open(`${BACKEND_URL}/api/cae/jobs/${jobId}/report`, '_blank');
+        }
+        
+        function cancelCAEExecution() {
+            // Buscar en ambos modales (plan filtrado y selecci├│n)
+            let resultDiv = document.getElementById('cae-plan-result');
+            if (!resultDiv) {
+                resultDiv = document.getElementById('cae-selection-result');
+            }
+            if (!resultDiv) return;
+            
+            const challengeDiv = resultDiv.querySelector('div[style*="background: #1e293b"]');
+            if (challengeDiv) {
+                challengeDiv.remove();
+            }
+            const executeButton = resultDiv.querySelector('[data-testid="cae-execute-button"]');
+            if (executeButton) {
+                executeButton.disabled = false;
+                executeButton.textContent = 'Ejecutar en eGestiona';
+            }
+        }
+        
+        // ========== v1.5: CAE Selection Modal ==========
+        
+        let selectedPendingItems = [];
+        let docCandidatesCache = {};
+        
+        function toggleAllPendingRows(checked) {
+            const checkboxes = document.querySelectorAll('.pending-row-checkbox');
+            checkboxes.forEach(cb => {
+                cb.checked = checked;
+            });
+            updateCAESelectionCount();
+        }
+        
+        function updateCAESelectionCount() {
+            const checkboxes = document.querySelectorAll('.pending-row-checkbox:checked');
+            const count = checkboxes.length;
+            const button = document.querySelector('[data-testid="cae-selection-button"]');
+            if (button) {
+                if (count > 0) {
+                    button.textContent = `Preparar env├¡o CAE (selecci├│n) (${count})`;
+                } else {
+                    button.textContent = 'Preparar env├¡o CAE (selecci├│n)';
+                }
+            }
+        }
+        
+        async function openCAESelectionModal() {
+            // Obtener items seleccionados
+            selectedPendingItems = [];
+            const checkboxes = document.querySelectorAll('.pending-row-checkbox:checked');
+            checkboxes.forEach(cb => {
+                const row = cb.closest('tr[data-pending-item]');
+                if (row) {
+                    const itemData = JSON.parse(row.getAttribute('data-pending-item'));
+                    selectedPendingItems.push({
+                        ...itemData,
+                        itemId: cb.getAttribute('data-item-id')
+                    });
+                }
+            });
+            
+            if (selectedPendingItems.length === 0) {
+                alert('Por favor, selecciona al menos un pendiente de subir.');
+                return;
+            }
+            
+            // Crear modal
+            const modal = document.createElement('div');
+            modal.id = 'cae-selection-modal';
+            modal.className = 'modal';
+            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
+            
+            let modalContent = `
+                <div class="modal-content" style="background: #1e293b; border-radius: 8px; padding: 24px; max-width: 900px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; width: 90%;">
+                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
+                        <h2>Preparar env├¡o CAE (selecci├│n)</h2>
+                        <button class="close-button" onclick="closeCAESelectionModal()" style="background: none; border: none; color: #e2e8f0; font-size: 24px; cursor: pointer;">&times;</button>
+                    </div>
+                    
+                    <div style="margin-bottom: 16px;">
+                        <p>Seleccionados: <strong>${selectedPendingItems.length}</strong> items</p>
+                    </div>
+                    
+                    <div id="cae-selection-items" style="margin-bottom: 24px;">
+                        ${selectedPendingItems.map((item, idx) => `
+                            <div class="card" style="margin-bottom: 16px; padding: 16px; background: #0f172a; border: 1px solid #334155; border-radius: 8px;" data-item-idx="${idx}">
+                                <h3 style="margin-bottom: 8px;">${escapeHtml(item.type_id)}</h3>
+                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 12px;">
+                                    ${item.scope === 'worker' ? `Trabajador: ${item.person_key}` : `Empresa: ${item.company_key}`} | Per├¡odo: ${item.period_key || 'N/A'}
+                                </p>
+                                <div style="margin-bottom: 12px;">
+                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Documento del repositorio:</label>
+                                    <div style="display: flex; gap: 8px; align-items: center;">
+                                        <select id="doc-select-${idx}" class="form-input" style="flex: 1;" onchange="updateViewPDFButton(${idx})">
+                                            <option value="">-- Cargando candidatos...</option>
+                                        </select>
+                                        <input type="text" id="doc-filter-${idx}" class="form-input" placeholder="Filtrar..." style="width: 200px;" oninput="filterDocCandidates(${idx})">
+                                        <button class="btn btn-secondary btn-sm" onclick="viewDocPDF(${idx})" id="view-pdf-btn-${idx}" disabled>Ver PDF</button>
+                                    </div>
+                                    <div id="doc-candidates-${idx}" style="margin-top: 8px; font-size: 0.875rem; color: #94a3b8;"></div>
+                                </div>
+                            </div>
+                        `).join('')}
+                    </div>
+                    
+                    <div id="cae-selection-result"></div>
+                    
+                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px;">
+                        <button class="btn btn-secondary" onclick="closeCAESelectionModal()">Cancelar</button>
+                        <button class="btn btn-primary" onclick="generateCAEPlanFromSelection()" data-testid="cae-selection-generate">Generar plan</button>
+                    </div>
+                </div>
+            `;
+            
+            modal.innerHTML = modalContent;
+            document.body.appendChild(modal);
+            
+            // Cerrar al hacer click fuera
+            modal.addEventListener('click', (e) => {
+                if (e.target === modal) {
+                    closeCAESelectionModal();
+                }
+            });
+            
+            // Cargar candidatos para cada item (en paralelo para ser m├ís r├ípido)
+            Promise.all(
+                selectedPendingItems.map((_, idx) => 
+                    loadDocCandidates(idx).catch(err => {
+                        console.error(`[repo] Error loading candidates for item ${idx}:`, err);
+                    })
+                )
+            ).catch(err => {
+                console.error('[repo] Error loading candidates:', err);
+            });
+        }
+        
+        async function loadDocCandidates(itemIdx) {
+            const item = selectedPendingItems[itemIdx];
+            const select = document.getElementById(`doc-select-${itemIdx}`);
+            const candidatesDiv = document.getElementById(`doc-candidates-${itemIdx}`);
+            
+            if (!select || !item) return;
+            
+            // Obtener el contenedor del item (card) para a├▒adir la se├▒al despu├®s
+            const itemCard = select.closest('[data-item-idx]') || select.closest('.card');
+            
+            try {
+                select.innerHTML = '<option value="">-- Cargando...</option>';
+                select.disabled = true;
+                
+                const params = new URLSearchParams({
+                    type_id: item.type_id,
+                    scope: item.scope,
+                    company_key: item.company_key || '',
+                    include_best: 'true',  // v1.7: Solicitar mejor candidato
+                });
+                if (item.person_key) params.append('person_key', item.person_key);
+                if (item.period_key) {
+                    params.append('period_key', item.period_key);
+                    // Para periodos missing, permitir fallback a documentos de otros periodos
+                    params.append('allow_period_fallback', 'true');
+                }
+                
+                const response = await fetch(`${BACKEND_URL}/api/cae/doc_candidates?${params}`);
+                if (!response.ok) {
+                    const errorText = await response.text();
+                    console.error(`[repo] Error loading doc_candidates for item ${itemIdx}:`, {
+                        status: response.status,
+                        statusText: response.statusText,
+                        errorText: errorText,
+                        url: `${BACKEND_URL}/api/cae/doc_candidates?${params}`,
+                        params: Object.fromEntries(params)
+                    });
+                    throw new Error(`Error ${response.status}: ${errorText}`);
+                }
+                
+                const data = await response.json();
+                const candidates = data.candidates || [];
+                const fallback_applied = data.fallback_applied || false;
+                const best_doc_id = data.best_doc_id || null;
+                const best_reason = data.best_reason || null;
+                
+                // Guardar en cache
+                docCandidatesCache[itemIdx] = candidates;
+                
+                // Llenar select
+                select.innerHTML = '<option value="">-- Seleccionar documento --</option>';
+                candidates.forEach(cand => {
+                    const option = document.createElement('option');
+                    option.value = cand.doc_id;
+                    option.textContent = `${cand.file_name_original || cand.doc_id} (${cand.validity_status || 'N/A'})`;
+                    option.setAttribute('data-candidate', JSON.stringify(cand));
+                    select.appendChild(option);
+                });
+                
+                select.disabled = false;
+                
+                // v1.7: Preseleccionar best_doc_id si existe
+                if (best_doc_id) {
+                    select.value = best_doc_id;
+                    // Disparar evento change para actualizar bot├│n "Ver PDF"
+                    select.dispatchEvent(new Event('change'));
+                }
+                
+                // Mostrar mensaje con badge si se aplic├│ fallback y sugerencia autom├ítica
+                if (candidates.length === 0) {
+                    candidatesDiv.innerHTML = '<span style="color: #fca5a5;">No hay documentos candidatos disponibles</span>';
+                } else {
+                    let message = `<span style="color: #94a3b8;">${candidates.length} documento(s) encontrado(s)</span>`;
+                    if (fallback_applied) {
+                        message += ' <span class="badge badge-warning" style="margin-left: 8px; font-size: 0.75rem;">candidatos de otros periodos</span>';
+                    }
+                    // v1.7: Mostrar sugerencia autom├ítica
+                    if (best_doc_id && best_reason) {
+                        message += `<div style="margin-top: 8px; font-size: 0.875rem; color: #60a5fa;" data-testid="auto-suggestion-${itemIdx}" data-item-idx="${itemIdx}">`;
+                        message += `<span style="font-weight: 500;">­ƒÆí Sugerido autom├íticamente:</span> ${escapeHtml(best_reason)}`;
+                        message += `</div>`;
+                    }
+                    candidatesDiv.innerHTML = message;
+                }
+                
+                // v1.7: Se├▒al de que la auto-sugerencia est├í lista (para E2E)
+                // Buscar el contenedor del item (card) que tiene data-item-idx
+                const cardWithIdx = document.querySelector(`[data-item-idx="${itemIdx}"]`);
+                if (cardWithIdx) {
+                    cardWithIdx.setAttribute('data-autosuggestion-ready', 'true');
+                } else {
+                    // Fallback: buscar el card m├ís cercano al select
+                    const fallbackCard = select.closest('.card');
+                    if (fallbackCard) {
+                        fallbackCard.setAttribute('data-autosuggestion-ready', 'true');
+                        fallbackCard.setAttribute('data-item-idx', itemIdx.toString());
+                    } else {
+                        // ├Ültimo fallback: poner en el select mismo
+                        select.setAttribute('data-autosuggestion-ready', 'true');
+                        select.setAttribute('data-item-idx', itemIdx.toString());
+                    }
+                }
+            } catch (error) {
+                console.error(`Error al cargar candidatos para item ${itemIdx}:`, error);
+                select.innerHTML = '<option value="">-- Error al cargar --</option>';
+                const errorMsg = error.message || String(error);
+                candidatesDiv.innerHTML = `<span style="color: #fca5a5;" data-testid="doc-candidates-error-${itemIdx}">Error: ${errorMsg}</span>`;
+                console.error(`[repo] Full error for item ${itemIdx}:`, {
+                    error: error,
+                    message: errorMsg,
+                    stack: error.stack
+                });
+                
+                // A├▒adir se├▒al incluso en caso de error (para que el test no se quede esperando)
+                const cardWithIdx = document.querySelector(`[data-item-idx="${itemIdx}"]`);
+                if (cardWithIdx) {
+                    cardWithIdx.setAttribute('data-autosuggestion-ready', 'true');
+                } else {
+                    const fallbackCard = select.closest('.card');
+                    if (fallbackCard) {
+                        fallbackCard.setAttribute('data-autosuggestion-ready', 'true');
+                        fallbackCard.setAttribute('data-item-idx', itemIdx.toString());
+                    } else {
+                        select.setAttribute('data-autosuggestion-ready', 'true');
+                        select.setAttribute('data-item-idx', itemIdx.toString());
+                    }
+                }
+            }
+        }
+        
+        function filterDocCandidates(itemIdx) {
+            const filterInput = document.getElementById(`doc-filter-${itemIdx}`);
+            const select = document.getElementById(`doc-select-${itemIdx}`);
+            if (!filterInput || !select) return;
+            
+            const filter = filterInput.value.toLowerCase();
+            const candidates = docCandidatesCache[itemIdx] || [];
+            
+            select.innerHTML = '<option value="">-- Seleccionar documento --</option>';
+            candidates.forEach(cand => {
+                const fileName = (cand.file_name_original || cand.doc_id || '').toLowerCase();
+                const docId = (cand.doc_id || '').toLowerCase();
+                if (filter === '' || fileName.includes(filter) || docId.includes(filter)) {
+                    const option = document.createElement('option');
+                    option.value = cand.doc_id;
+                    option.textContent = `${cand.file_name_original || cand.doc_id} (${cand.validity_status || 'N/A'})`;
+                    option.setAttribute('data-candidate', JSON.stringify(cand));
+                    select.appendChild(option);
+                }
+            });
+        }
+        
+        function updateViewPDFButton(itemIdx) {
+            const select = document.getElementById(`doc-select-${itemIdx}`);
+            const viewBtn = document.getElementById(`view-pdf-btn-${itemIdx}`);
+            if (viewBtn && select) {
+                viewBtn.disabled = !select.value;
+            }
+        }
+        
+        function viewDocPDF(itemIdx) {
+            const select = document.getElementById(`doc-select-${itemIdx}`);
+            if (!select || !select.value) return;
+            
+            const docId = select.value;
+            window.open(`${BACKEND_URL}/api/repository/docs/${docId}/pdf`, '_blank');
+        }
+        
+        async function generateCAEPlanFromSelection() {
+            const resultDiv = document.getElementById('cae-selection-result');
+            if (!resultDiv) return;
+            
+            try {
+                resultDiv.innerHTML = '<div style="padding: 16px; text-align: center;">Generando plan...</div>';
+                
+                // Recopilar selected_items con suggested_doc_id
+                const selectedItems = [];
+                for (let idx = 0; idx < selectedPendingItems.length; idx++) {
+                    const select = document.getElementById(`doc-select-${idx}`);
+                    const item = selectedPendingItems[idx];
+                    
+                    selectedItems.push({
+                        type_id: item.type_id,
+                        scope: item.scope,
+                        company_key: item.company_key,
+                        person_key: item.person_key,
+                        period_key: item.period_key,
+                        suggested_doc_id: select ? select.value : null,
+                    });
+                }
+                
+                // Determinar scope base (usar el primer item como referencia)
+                const firstItem = selectedPendingItems[0];
+                const scope = {
+                    platform_key: 'egestiona',
+                    type_ids: [],
+                    company_key: firstItem.company_key,
+                    person_key: firstItem.person_key,
+                    mode: 'PREPARE_WRITE',
+                };
+                
+                const response = await fetch(`${BACKEND_URL}/api/cae/plan_from_selection`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({
+                        scope: scope,
+                        selected_items: selectedItems,
+                    }),
+                });
+                
+                if (!response.ok) {
+                    const errorText = await response.text();
+                    throw new Error(`Error ${response.status}: ${errorText}`);
+                }
+                
+                const plan = await response.json();
+                
+                // Renderizar resultado (similar a generateCAEPlan)
+                // SPRINT C2.7: A├▒adir testid y data-decision para determinismo
+                let resultHtml = `
+                    <div style="background: #1e293b; padding: 16px; border-radius: 8px; margin-top: 16px;">
+                        <h3 style="margin-bottom: 12px;">Resultado del Plan</h3>
+                        <div style="margin-bottom: 8px;" data-testid="cae-plan-decision" data-decision="${escapeHtml(plan.decision)}">
+                            <strong>Decisi├│n:</strong> 
+                            <span class="badge ${plan.decision === 'READY' ? 'badge-ok' : plan.decision === 'NEEDS_CONFIRMATION' ? 'badge-warning' : 'badge-error'}">
+                                ${plan.decision}
+                            </span>
+                        </div>
+                        ${plan.reasons && plan.reasons.length > 0 ? `
+                            <div style="margin-bottom: 8px;">
+                                <strong>Razones:</strong>
+                                <ul style="margin-left: 20px; margin-top: 4px;">
+                                    ${plan.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
+                                </ul>
+                            </div>
+                        ` : ''}
+                        <div style="margin-bottom: 8px;">
+                            <strong>Items:</strong> ${plan.items.length}
+                        </div>
+                        <div style="margin-bottom: 8px;">
+                            <strong>Resumen:</strong> <pre style="background: #0f172a; padding: 8px; border-radius: 4px; font-size: 0.875rem; overflow-x: auto;">${JSON.stringify(plan.summary, null, 2)}</pre>
+                        </div>
+                    </div>
+                `;
+                
+                if (plan.decision === 'READY') {
+                    resultHtml += `
+                        <div style="margin-top: 16px;">
+                            <button class="btn btn-primary" onclick="startCAEExecution('${plan.plan_id}')" data-testid="cae-execute-button">
+                                Ejecutar en eGestiona
+                            </button>
+                        </div>
+                    `;
+                }
+                
+                resultDiv.innerHTML = resultHtml;
+            } catch (error) {
+                console.error('Error al generar plan desde selecci├│n:', error);
+                // SPRINT C2.7: A├▒adir testid para errores
+                resultDiv.innerHTML = `<div style="background: #7f1d1d; color: #fca5a5; padding: 16px; border-radius: 8px; margin-top: 16px;" data-testid="cae-plan-error">
+                    <strong>Error:</strong> ${escapeHtml(error.message || 'Error desconocido')}
+                </div>`;
+            }
+        }
+        
+        function closeCAESelectionModal() {
+            const modal = document.getElementById('cae-selection-modal');
+            if (modal) {
+                modal.remove();
+            }
+            selectedPendingItems = [];
+            docCandidatesCache = {};
+        }
+        
+        // ========== v1.6: Coordinaci├│n CAE ==========
+        
+        let currentSnapshot = null;
+        let selectedSnapshotItems = [];
+        
+        async function loadCoordinacion(params = {}) {
+            const content = document.getElementById('page-content');
+            if (!content) {
+                console.error('[repo] loadCoordinacion: page-content not found');
+                return;
+            }
+            
+            try {
+                // Cargar plataformas para obtener coordinaciones
+                let coordinations = [];
+                try {
+                    const platformsResponse = await fetch(`${BACKEND_URL}/api/config/platforms`);
+                    if (platformsResponse.ok) {
+                        const platformsData = await platformsResponse.json();
+                        const egestiona = platformsData.platforms?.find(p => p.key === 'egestiona');
+                        coordinations = egestiona?.coordinations || [];
+                    }
+                } catch (error) {
+                    console.warn('[repo] Error loading platforms, continuing with empty coordinations:', error);
+                    // No mostrar error aqu├¡, solo continuar con lista vac├¡a
+                }
+                
+                content.innerHTML = `
+                    <div class="page-header" data-testid="coordination-root">
+                        <h1>Coordinaci├│n CAE</h1>
+                        <p>Consulta pendientes de plataforma y genera planes de env├¡o</p>
+                    </div>
+                    
+                    <div class="card" style="margin-bottom: 24px;">
+                        <h2 data-testid="coordination-config-title">Configuraci├│n de consulta</h2>
+                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
+                            <div>
+                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Plataforma:</label>
+                                <select id="coord-platform" class="form-input">
+                                    <option value="egestiona">eGestiona</option>
+                                </select>
+                            </div>
+                            <div>
+                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Coordinaci├│n:</label>
+                                <select id="coord-coordination" class="form-input">
+                                    <option value="">-- Seleccionar --</option>
+                                    ${coordinations.map(c => `<option value="${escapeHtml(c.label)}">${escapeHtml(c.label)}</option>`).join('')}
+                                </select>
+                            </div>
+                            <div>
+                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Empresa:</label>
+                                <input type="text" id="coord-company" class="form-input" placeholder="Opcional">
+                            </div>
+                            <div>
+                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Trabajador:</label>
+                                <input type="text" id="coord-person" class="form-input" placeholder="Opcional">
+                            </div>
+                        </div>
+                        <button class="btn btn-primary" onclick="createCoordinationSnapshot()" id="coord-query-btn">
+                            Consultar pendientes (READ)
+                        </button>
+                    </div>
+                    
+                    <div id="coord-snapshot-result" style="display: none;"></div>
+                    <div id="coord-snapshot-items" style="display: none;"></div>
+                `;
+                
+                // SPRINT B: Agregar se├▒al DOM cuando coordinacion est├í completamente cargado
+                const coordRoot = document.querySelector('[data-testid="coordination-root"]');
+                if (coordRoot) {
+                    content.setAttribute('data-testid', 'view-coordinacion-ready');
+                }
+            } catch (error) {
+                console.error('[repo] Error loading coordinacion:', error);
+                const errorMsg = error.message || 'Error desconocido al cargar coordinaci├│n';
+                content.innerHTML = `
+                    <div class="error-banner" data-testid="coordination-error">
+                        <strong>Error:</strong> ${escapeHtml(errorMsg)}
+                        <br><small>Revisa la consola del navegador para m├ís detalles.</small>
+                    </div>
+                `;
+            }
+        }
+        
+        async function createCoordinationSnapshot() {
+            const platformSelect = document.getElementById('coord-platform');
+            const coordinationSelect = document.getElementById('coord-coordination');
+            const companyInput = document.getElementById('coord-company');
+            const personInput = document.getElementById('coord-person');
+            const queryBtn = document.getElementById('coord-query-btn');
+            const resultDiv = document.getElementById('coord-snapshot-result');
+            const itemsDiv = document.getElementById('coord-snapshot-items');
+            
+            if (!platformSelect || !coordinationSelect || !queryBtn || !resultDiv || !itemsDiv) return;
+            
+            const coordinationLabel = coordinationSelect.value;
+            // En modo FAKE, permitir crear snapshot sin coordinaci├│n seleccionada
+            // (el backend usar├í un valor por defecto)
+            
+            queryBtn.disabled = true;
+            queryBtn.textContent = 'Consultando...';
+            resultDiv.style.display = 'none';
+            itemsDiv.style.display = 'none';
+            
+            try {
+                const scope = {
+                    platform_key: platformSelect.value,
+                    coordination_label: coordinationLabel || null, // Permitir null en modo FAKE
+                    company_key: companyInput.value.trim() || null,
+                    person_key: personInput.value.trim() || null,
+                    type_ids: null,
+                    period_keys: null,
+                };
+                
+                const response = await fetch(`${BACKEND_URL}/api/cae/coordination/snapshot`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify(scope),
+                });
+                
+                if (!response.ok) {
+                    throw new Error(`Error ${response.status}: ${await response.text()}`);
+                }
+                
+                const snapshot = await response.json();
+                currentSnapshot = snapshot;
+                selectedSnapshotItems = [];
+                
+                // Mostrar resultado
+                resultDiv.style.display = 'block';
+                resultDiv.innerHTML = `
+                    <div class="card">
+                        <h2>Snapshot creado</h2>
+                        <p><strong>ID:</strong> ${escapeHtml(snapshot.snapshot_id)}</p>
+                        <p><strong>Fecha:</strong> ${new Date(snapshot.created_at).toLocaleString()}</p>
+                        <p><strong>Pendientes encontrados:</strong> ${snapshot.pending_items.length}</p>
+                    </div>
+                `;
+                
+                // Mostrar items con checkboxes
+                if (snapshot.pending_items.length > 0) {
+                    itemsDiv.style.display = 'block';
+                    itemsDiv.innerHTML = `
+                        <div class="card">
+                            <h2>Pendientes encontrados</h2>
+                            <table class="table">
+                                <thead>
+                                    <tr>
+                                        <th style="width: 40px;"><input type="checkbox" id="coord-select-all" onchange="toggleAllSnapshotItems(this.checked)"></th>
+                                        <th>Tipo</th>
+                                        <th>Sujeto</th>
+                                        <th>Per├¡odo</th>
+                                        <th>Estado</th>
+                                    </tr>
+                                </thead>
+                                <tbody>
+                                    ${snapshot.pending_items.map((item, idx) => `
+                                        <tr>
+                                            <td><input type="checkbox" class="snapshot-item-checkbox" data-index="${idx}" onchange="toggleSnapshotItem(${idx})"></td>
+                                            <td>${escapeHtml(item.platform_type_label || item.type_id || 'N/A')}</td>
+                                            <td>${item.person_key ? `Trabajador: ${escapeHtml(item.person_key)}` : `Empresa: ${escapeHtml(item.company_key || 'N/A')}`}</td>
+                                            <td>${escapeHtml(item.period_key || 'N/A')}</td>
+                                            <td><span class="badge badge-info">${escapeHtml(item.status)}</span></td>
+                                        </tr>
+                                    `).join('')}
+                                </tbody>
+                            </table>
+                            <div style="margin-top: 16px;">
+                                <button class="btn btn-primary" onclick="openSnapshotSelectionModal()" id="coord-assign-btn" disabled>
+                                    Asignar documentos y preparar plan
+                                </button>
+                            </div>
+                        </div>
+                    `;
+                } else {
+                    itemsDiv.style.display = 'block';
+                    itemsDiv.innerHTML = `
+                        <div class="card">
+                            <p>No se encontraron pendientes para el ├ímbito seleccionado.</p>
+                        </div>
+                    `;
+                }
+            } catch (error) {
+                console.error('Error al crear snapshot:', error);
+                resultDiv.style.display = 'block';
+                resultDiv.innerHTML = `
+                    <div class="card" style="background: #7f1d1d; color: #fca5a5;">
+                        <strong>Error:</strong> ${escapeHtml(error.message || 'Error desconocido')}
+                    </div>
+                `;
+            } finally {
+                queryBtn.disabled = false;
+                queryBtn.textContent = 'Consultar pendientes (READ)';
+            }
+        }
+        
+        function toggleAllSnapshotItems(checked) {
+            const checkboxes = document.querySelectorAll('.snapshot-item-checkbox');
+            checkboxes.forEach(cb => {
+                cb.checked = checked;
+                const idx = parseInt(cb.getAttribute('data-index'));
+                if (checked && !selectedSnapshotItems.includes(idx)) {
+                    selectedSnapshotItems.push(idx);
+                } else if (!checked) {
+                    selectedSnapshotItems = selectedSnapshotItems.filter(i => i !== idx);
+                }
+            });
+            updateSnapshotAssignButton();
+        }
+        
+        function toggleSnapshotItem(index) {
+            const checkbox = document.querySelector(`.snapshot-item-checkbox[data-index="${index}"]`);
+            if (!checkbox) return;
+            
+            if (checkbox.checked) {
+                if (!selectedSnapshotItems.includes(index)) {
+                    selectedSnapshotItems.push(index);
+                }
+            } else {
+                selectedSnapshotItems = selectedSnapshotItems.filter(i => i !== index);
+            }
+            updateSnapshotAssignButton();
+        }
+        
+        function updateSnapshotAssignButton() {
+            const btn = document.getElementById('coord-assign-btn');
+            if (btn) {
+                btn.disabled = selectedSnapshotItems.length === 0;
+                if (selectedSnapshotItems.length > 0) {
+                    btn.textContent = `Asignar documentos y preparar plan (${selectedSnapshotItems.length})`;
+                } else {
+                    btn.textContent = 'Asignar documentos y preparar plan';
+                }
+            }
+        }
+        
+        async function openSnapshotSelectionModal() {
+            if (!currentSnapshot || selectedSnapshotItems.length === 0) {
+                alert('Por favor, selecciona al menos un pendiente');
+                return;
+            }
+            
+            // Reutilizar modal de selecci├│n v1.5 pero alimentado por snapshot
+            const modal = document.createElement('div');
+            modal.id = 'cae-snapshot-selection-modal';
+            modal.className = 'modal';
+            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
+            
+            // Construir items desde snapshot
+            const snapshotItems = selectedSnapshotItems.map(idx => {
+                const item = currentSnapshot.pending_items[idx];
+                return {
+                    type_id: item.type_id || (item.type_alias_candidates && item.type_alias_candidates[0]) || 'UNKNOWN',
+                    scope: item.person_key ? 'worker' : 'company',
+                    company_key: item.company_key,
+                    person_key: item.person_key,
+                    period_key: item.period_key,
+                    snapshot_index: idx,
+                    platform_type_label: item.platform_type_label,
+                };
+            });
+            
+            let modalContent = `
+                <div class="modal-content" style="background: #1e293b; border-radius: 8px; padding: 24px; max-width: 900px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; width: 90%;">
+                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
+                        <h2>Asignar documentos desde snapshot</h2>
+                        <button class="close-button" onclick="closeSnapshotSelectionModal()" style="background: none; border: none; color: #e2e8f0; font-size: 24px; cursor: pointer;">&times;</button>
+                    </div>
+                    
+                    <div style="margin-bottom: 16px;">
+                        <p>Snapshot: <strong>${escapeHtml(currentSnapshot.snapshot_id)}</strong></p>
+                        <p>Seleccionados: <strong>${snapshotItems.length}</strong> items</p>
+                    </div>
+                    
+                    <div id="snapshot-selection-items" style="margin-bottom: 24px;">
+                        ${snapshotItems.map((item, idx) => `
+                            <div class="card" style="margin-bottom: 16px; padding: 16px; background: #0f172a; border: 1px solid #334155; border-radius: 8px;" data-item-idx="${idx}">
+                                <h3 style="margin-bottom: 8px;">${escapeHtml(item.platform_type_label || item.type_id)}</h3>
+                                <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 12px;">
+                                    ${item.scope === 'worker' ? `Trabajador: ${escapeHtml(item.person_key || 'N/A')}` : `Empresa: ${escapeHtml(item.company_key || 'N/A')}`} | Per├¡odo: ${escapeHtml(item.period_key || 'N/A')}
+                                </p>
+                                <div style="margin-bottom: 12px;">
+                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Documento del repositorio:</label>
+                                    <div style="display: flex; gap: 8px; align-items: center;">
+                                        <select id="snapshot-doc-select-${idx}" class="form-input" style="flex: 1;" onchange="updateSnapshotViewPDFButton(${idx})">
+                                            <option value="">-- Cargando candidatos...</option>
+                                        </select>
+                                        <input type="text" id="snapshot-doc-filter-${idx}" class="form-input" placeholder="Filtrar..." style="width: 200px;" oninput="filterSnapshotDocCandidates(${idx})">
+                                        <button class="btn btn-secondary btn-sm" onclick="viewSnapshotDocPDF(${idx})" id="snapshot-view-pdf-btn-${idx}" disabled>Ver PDF</button>
+                                    </div>
+                                    <div id="snapshot-doc-candidates-${idx}" style="margin-top: 8px; font-size: 0.875rem; color: #94a3b8;"></div>
+                                </div>
+                            </div>
+                        `).join('')}
+                    </div>
+                    
+                    <div id="snapshot-selection-result"></div>
+                    
+                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px;">
+                        <button class="btn btn-secondary" onclick="closeSnapshotSelectionModal()">Cancelar</button>
+                        <button class="btn btn-primary" onclick="generateCAEPlanFromSnapshot()" data-testid="snapshot-generate-plan">Generar plan</button>
+                    </div>
+                </div>
+            `;
+            
+            modal.innerHTML = modalContent;
+            document.body.appendChild(modal);
+            
+            // Cerrar al hacer click fuera del modal
+            modal.addEventListener('click', (e) => {
+                if (e.target === modal) {
+                    closeSnapshotSelectionModal();
+                }
+            });
+            
+            // Cargar candidatos para cada item (sin await para no bloquear)
+            // Cargar en paralelo para ser m├ís r├ípido
+            Promise.all(
+                snapshotItems.map((_, idx) => 
+                    loadSnapshotDocCandidates(currentSnapshot.snapshot_id, idx).catch(err => {
+                        console.error(`[repo] Error loading candidates for item ${idx}:`, err);
+                    })
+                )
+            ).catch(err => {
+                console.error('[repo] Error loading candidates:', err);
+            });
+        }
+        
+        async function loadSnapshotDocCandidates(snapshotId, itemIdx) {
+            if (!currentSnapshot || !selectedSnapshotItems || itemIdx >= selectedSnapshotItems.length) {
+                console.error(`[repo] loadSnapshotDocCandidates: invalid params`, { snapshotId, itemIdx, hasSnapshot: !!currentSnapshot, selectedCount: selectedSnapshotItems?.length });
+                return;
+            }
+            
+            const pendingIndex = selectedSnapshotItems[itemIdx];
+            if (pendingIndex === undefined || pendingIndex >= currentSnapshot.pending_items.length) {
+                console.error(`[repo] loadSnapshotDocCandidates: invalid pendingIndex`, { pendingIndex, itemsCount: currentSnapshot.pending_items.length });
+                return;
+            }
+            
+            const item = currentSnapshot.pending_items[pendingIndex];
+            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
+            const candidatesDiv = document.getElementById(`snapshot-doc-candidates-${itemIdx}`);
+            
+            if (!select) {
+                console.error(`[repo] loadSnapshotDocCandidates: select not found for itemIdx ${itemIdx}`);
+                return;
+            }
+            
+            if (!item) {
+                console.error(`[repo] loadSnapshotDocCandidates: item not found for pendingIndex ${pendingIndex}`);
+                return;
+            }
+            
+            try {
+                select.innerHTML = '<option value="">-- Cargando...</option>';
+                select.disabled = true;
+                
+                const params = new URLSearchParams({
+                    pending_index: pendingIndex.toString(),
+                    allow_period_fallback: 'true',
+                    include_best: 'true',  // v1.7: Solicitar mejor candidato
+                });
+                
+                const response = await fetch(`${BACKEND_URL}/api/cae/coordination/snapshot/${snapshotId}/doc_candidates?${params}`);
+                if (!response.ok) {
+                    throw new Error(`Error ${response.status}: ${await response.text()}`);
+                }
+                
+                const data = await response.json();
+                const candidates = data.candidates || [];
+                const fallback_applied = data.fallback_applied || false;
+                const best_doc_id = data.best_doc_id || null;
+                const best_reason = data.best_reason || null;
+                
+                // Llenar select
+                select.innerHTML = '<option value="">-- Seleccionar documento --</option>';
+                candidates.forEach(cand => {
+                    const option = document.createElement('option');
+                    option.value = cand.doc_id;
+                    option.textContent = `${cand.file_name_original || cand.doc_id} (${cand.validity_status || 'N/A'})`;
+                    option.setAttribute('data-candidate', JSON.stringify(cand));
+                    select.appendChild(option);
+                });
+                
+                select.disabled = false;
+                
+                // v1.7: Preseleccionar best_doc_id si existe
+                if (best_doc_id) {
+                    select.value = best_doc_id;
+                    // Disparar evento change para actualizar bot├│n "Ver PDF"
+                    select.dispatchEvent(new Event('change'));
+                }
+                
+                // Mostrar mensaje con badge si se aplic├│ fallback y sugerencia autom├ítica
+                if (candidates.length === 0) {
+                    candidatesDiv.innerHTML = '<span style="color: #fca5a5;">No hay documentos candidatos disponibles</span>';
+                } else {
+                    let message = `<span style="color: #94a3b8;">${candidates.length} documento(s) encontrado(s)</span>`;
+                    if (fallback_applied) {
+                        message += ' <span class="badge badge-warning" style="margin-left: 8px; font-size: 0.75rem;">candidatos de otros periodos</span>';
+                    }
+                    // v1.7: Mostrar sugerencia autom├ítica
+                    if (best_doc_id && best_reason) {
+                        message += `<div style="margin-top: 8px; font-size: 0.875rem; color: #60a5fa;" data-testid="snapshot-auto-suggestion-${itemIdx}">`;
+                        message += `<span style="font-weight: 500;">­ƒÆí Sugerido autom├íticamente:</span> ${escapeHtml(best_reason)}`;
+                        message += `</div>`;
+                    }
+                    candidatesDiv.innerHTML = message;
+                }
+            } catch (error) {
+                console.error(`Error al cargar candidatos para snapshot item ${itemIdx}:`, error);
+                select.innerHTML = '<option value="">-- Error al cargar --</option>';
+                if (candidatesDiv) {
+                    candidatesDiv.innerHTML = `<span style="color: #fca5a5;">Error: ${error.message}</span>`;
+                }
+            }
+        }
+        
+        async function generateCAEPlanFromSnapshot() {
+            if (!currentSnapshot) return;
+            
+            const resultDiv = document.getElementById('snapshot-selection-result');
+            const generateBtn = document.querySelector('[data-testid="snapshot-generate-plan"]');
+            
+            if (!resultDiv) return;
+            
+            if (generateBtn) {
+                generateBtn.disabled = true;
+                generateBtn.textContent = 'Generando...';
+            }
+            
+            try {
+                // Recopilar selecciones
+                const selected = [];
+                for (let idx = 0; idx < selectedSnapshotItems.length; idx++) {
+                    const select = document.getElementById(`snapshot-doc-select-${idx}`);
+                    if (select && select.value) {
+                        selected.push({
+                            pending_index: selectedSnapshotItems[idx],
+                            suggested_doc_id: select.value,
+                        });
+                    }
+                }
+                
+                if (selected.length === 0) {
+                    throw new Error('Por favor, asigna al menos un documento');
+                }
+                
+                // Construir scope
+                const scope = {
+                    platform_key: 'egestiona',
+                    type_ids: [],
+                    company_key: currentSnapshot.scope.company_key,
+                    person_key: currentSnapshot.scope.person_key,
+                    period_keys: null,
+                    mode: 'PREPARE_WRITE',
+                };
+                
+                const response = await fetch(`${BACKEND_URL}/api/cae/coordination/plan_from_snapshot_selection`, {
+                    method: 'POST',
+                    headers: { 'Content-Type': 'application/json' },
+                    body: JSON.stringify({
+                        snapshot_id: currentSnapshot.snapshot_id,
+                        selected: selected,
+                        scope: scope,
+                    }),
+                });
+                
+                if (!response.ok) {
+                    throw new Error(`Error ${response.status}: ${await response.text()}`);
+                }
+                
+                const plan = await response.json();
+                
+                // Mostrar resultado (similar a v1.5)
+                // SPRINT C2.7: A├▒adir testid y data-decision para determinismo
+                const decisionBadge = plan.decision === 'READY' ? 'badge-success' : 
+                                     plan.decision === 'NEEDS_CONFIRMATION' ? 'badge-warning' : 
+                                     'badge-error';
+                
+                let resultHtml = `
+                    <div style="margin-top: 16px; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
+                        <h4 style="margin-bottom: 8px;">Resultado del plan</h4>
+                        <div style="margin-bottom: 8px;" data-testid="cae-plan-decision" data-decision="${escapeHtml(plan.decision)}">
+                            <span class="badge ${decisionBadge}">${escapeHtml(plan.decision)}</span>
+                        </div>
+                        ${plan.reasons && plan.reasons.length > 0 ? `
+                            <div style="margin-bottom: 8px;">
+                                <strong>Razones:</strong>
+                                <ul style="margin-left: 20px; margin-top: 8px;">
+                                    ${plan.reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
+                                </ul>
+                            </div>
+                        ` : ''}
+                        <div style="margin-bottom: 8px;">
+                            <strong>Items:</strong> ${plan.items.length}
+                        </div>
+                    </div>
+                `;
+                
+                if (plan.decision === 'READY') {
+                    resultHtml += `
+                        <div style="margin-top: 16px;">
+                            <button class="btn btn-primary" onclick="startCAEExecution('${plan.plan_id}')" data-testid="snapshot-execute-button">
+                                Ejecutar en eGestiona
+                            </button>
+                        </div>
+                    `;
+                }
+                
+                resultDiv.innerHTML = resultHtml;
+            } catch (error) {
+                console.error('Error al generar plan desde snapshot:', error);
+                // SPRINT C2.7: A├▒adir testid para errores
+                resultDiv.innerHTML = `<div style="background: #7f1d1d; color: #fca5a5; padding: 16px; border-radius: 8px; margin-top: 16px;" data-testid="cae-plan-error">
+                    <strong>Error:</strong> ${escapeHtml(error.message || 'Error desconocido')}
+                </div>`;
+            } finally {
+                if (generateBtn) {
+                    generateBtn.disabled = false;
+                    generateBtn.textContent = 'Generar plan';
+                }
+            }
+        }
+        
+        function closeSnapshotSelectionModal() {
+            const modal = document.getElementById('cae-snapshot-selection-modal');
+            if (modal) {
+                modal.remove();
+            }
+        }
+        
+        function updateSnapshotViewPDFButton(itemIdx) {
+            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
+            const viewBtn = document.getElementById(`snapshot-view-pdf-btn-${itemIdx}`);
+            if (viewBtn && select) {
+                viewBtn.disabled = !select.value;
+            }
+        }
+        
+        function viewSnapshotDocPDF(itemIdx) {
+            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
+            if (select && select.value) {
+                window.open(`${BACKEND_URL}/api/repository/docs/${select.value}/pdf`, '_blank');
+            }
+        }
+        
+        function filterSnapshotDocCandidates(itemIdx) {
+            const filterInput = document.getElementById(`snapshot-doc-filter-${itemIdx}`);
+            const select = document.getElementById(`snapshot-doc-select-${itemIdx}`);
+            if (!filterInput || !select) return;
+            
+            const filter = filterInput.value.toLowerCase();
+            const options = Array.from(select.options);
+            
+            options.forEach(option => {
+                if (option.value === '') {
+                    option.style.display = '';
+                    return;
+                }
+                const text = option.textContent.toLowerCase();
+                option.style.display = (filter === '' || text.includes(filter)) ? '' : 'none';
+            });
+        }
     </script>
 </body>
 </html>
